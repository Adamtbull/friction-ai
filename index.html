<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Friction AI - Slow down your AI, on purpose</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #d4e8e6 0%, #e8ecef 100%);
      color: #1f2937;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    button, input, textarea, select {
      font: inherit;
      color: inherit;
      letter-spacing: inherit;
    }

    button,
    input[type="text"],
    textarea,
    select {
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      background: none;
    }

    button, a, input, textarea, select {
      -webkit-tap-highlight-color: transparent;
    }

    body.scroll-locked {
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    :root {
      --teal-light: #d4e8e6;
      --teal-lighter: #e8f4f3;
      --teal: #5a9a94;
      --teal-dark: #4a8a84;
      --grey-light: #e8ecef;
      --grey: #6b7280;
      --grey-dark: #374151;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --white: #ffffff;
      --border: #d1d5db;
      --shadow: rgba(0, 0, 0, 0.05);

      --app-height: 100vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --kb: 0px;
    }

    @supports (height: 100dvh) {
      :root { --app-height: 100dvh; }
    }

    /* =================== */
    /* HOMEPAGE STYLES     */
    /* =================== */
    .homepage {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 24px;
      max-width: 600px;
      margin: 0 auto;
    }

    .homepage.hidden {
      display: none;
    }

    .brand {
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 24px;
    }

    .headline {
      font-size: 2rem;
      font-weight: 600;
      text-align: center;
      color: var(--text-primary);
      margin-bottom: 16px;
      line-height: 1.3;
    }

    .subheadline {
      font-size: 1rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 40px;
      max-width: 400px;
    }

    .section {
      width: 100%;
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .section-subtitle {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .section-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .section-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .section-list li {
      font-size: 0.95rem;
      color: var(--text-secondary);
      padding-left: 20px;
      position: relative;
      margin-bottom: 8px;
    }

    .section-list li::before {
      content: "â€¢";
      color: var(--teal);
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .philosophy-line {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    .cta-section {
      width: 100%;
      text-align: center;
      margin-top: 16px;
    }

    .cta-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .auth-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn-oauth {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-oauth:hover {
      border-color: var(--teal);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .btn-oauth svg {
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
    }

    .btn-primary {
      width: 100%;
      max-width: 320px;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      background: var(--teal);
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--teal-dark);
    }

    .footer-note {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 16px;
    }

    /* =================== */
    /* CHAT APP STYLES     */
    /* =================== */
    .chat-app {
      display: none;
      flex-direction: column;
      height: var(--app-height);
      background: linear-gradient(180deg, var(--teal-light) 0%, var(--grey-light) 100%);
    }

    .chat-app.active {
      display: flex;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(16px + var(--safe-top)) 20px 16px;
      background: rgba(255, 255, 255, 0.6);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .chat-header-left {
      width: 36px;
    }

    .chat-header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .chat-header-right {
      min-width: 70px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .model-select {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      outline: none;
      text-align: center;
    }

    .model-select:focus {
      background: rgba(0,0,0,0.05);
    }

    .header-timer {
      font-size: 0.65rem;
      color: var(--teal);
      background: var(--teal-light);
      padding: 4px 8px;
      border-radius: 12px;
      display: none;
      white-space: nowrap;
    }

    .header-timer.active {
      display: block;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 50%;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-icon:hover {
      border-color: var(--teal);
    }

    .btn-icon svg {
      width: 18px;
      height: 18px;
      stroke: var(--grey);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + 50px + 24px + var(--safe-bottom) + var(--kb));
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 0;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      min-width: 0;
    }

    .message-user {
      align-self: flex-end;
      background: var(--teal);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .message-ai {
      align-self: flex-start;
      background: var(--white);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-error {
      align-self: center;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      font-size: 0.85rem;
    }

    .welcome-message {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      width: 100%;
      max-width: 400px;
      pointer-events: none;
    }

    .welcome-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
    }

    .welcome-message h2 {
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .welcome-message p {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-secondary);
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 16px 20px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator.active {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--teal);
      border-radius: 50%;
      opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.4; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-4px); }
    }

    .chat-input-area {
      padding: 16px 20px calc(24px + var(--safe-bottom));
      background: rgba(255, 255, 255, 0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      transform: translateY(calc(-1 * var(--kb)));
      will-change: transform;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      max-width: 800px;
      margin: 0 auto;
      min-width: 0;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 8px 8px 8px 18px;
    }

    .chat-input {
      flex: 1;
      min-width: 0;
      padding: 8px 0;
      border: none;
      background: transparent;
      font-size: 16px;
      color: var(--text-primary);
      resize: none;
      min-height: 24px;
      max-height: 120px;
      outline: none;
      line-height: 1.5;
      overflow: hidden;
    }

    .chat-input::placeholder {
      color: var(--grey);
    }

    .btn-send {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-send:hover {
      background: var(--teal-dark);
    }

    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-send svg {
      width: 18px;
      height: 18px;
      stroke: var(--white);
      margin-left: 2px;
    }

    /* =================== */
    /* SIDE MENU           */
    /* =================== */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 998;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 300px;
      max-width: 85vw;
      background: var(--white);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }

    .side-menu.active {
      transform: translateX(0);
    }

    .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .menu-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--grey-light);
    }

    .profile-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .profile-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-email {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      color: var(--teal);
    }

    .btn-close-menu {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn-close-menu:hover {
      background: var(--grey-light);
    }

    .btn-close-menu svg {
      width: 20px;
      height: 20px;
      stroke: var(--grey);
    }

    .menu-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .menu-btn-new {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }

    .menu-btn-new:hover {
      border-color: var(--teal);
      color: var(--teal);
      background: var(--teal-lighter);
    }

    .menu-btn-new svg {
      width: 18px;
      height: 18px;
    }

    .menu-section {
      margin-bottom: 16px;
    }

    .menu-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--grey);
      text-transform: uppercase;
      padding: 8px 12px;
    }

    .menu-category {
      margin-bottom: 4px;
    }

    .menu-category-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-category-header:hover {
      background: var(--grey-light);
    }

    .menu-category-header .chevron {
      width: 16px;
      height: 16px;
      stroke: var(--grey);
      transition: transform 0.2s ease;
    }

    .menu-category.expanded .chevron {
      transform: rotate(180deg);
    }

    .menu-category-items {
      display: none;
      padding-left: 12px;
    }

    .menu-category.expanded .menu-category-items {
      display: block;
    }

    .menu-empty {
      font-size: 0.8rem;
      color: var(--grey);
      padding: 8px 12px;
      font-style: italic;
    }

    .menu-chat-item {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.2s ease;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-chat-item:hover {
      background: var(--grey-light);
      color: var(--text-primary);
    }

    .menu-divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 0.9rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .menu-item:hover {
      background: var(--grey-light);
      color: var(--text-primary);
    }

    .menu-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .menu-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      padding-bottom: calc(16px + var(--safe-bottom));
    }

    .menu-item-logout:hover {
      background: #fef2f2;
      color: #dc2626;
    }

    .menu-item-logout:hover svg {
      stroke: #dc2626;
    }

    /* =================== */
    /* FRICTION OVERLAY    */
    /* =================== */
    .friction-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      overscroll-behavior: contain;
    }

    .friction-overlay.active {
      display: flex;
    }

    .friction-box {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .friction-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .friction-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 24px;
    }

    .friction-row {
      margin-bottom: 24px;
    }

    .friction-row:last-of-type {
      margin-bottom: 12px;
    }

    .friction-label {
      display: none;
    }

    .friction-pair-container {
      display: flex;
      justify-content: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .friction-pair {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .friction-char {
      width: 32px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--grey-light);
      border-radius: 6px;
      font-family: 'SF Mono', 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', Monaco, 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      user-select: none;
      -webkit-user-select: none;
    }

    .friction-char-input {
      width: 32px;
      height: 38px;
      padding: 0;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: 'SF Mono', 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', Monaco, 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
      background: var(--white);
    }

    .friction-char-input:focus {
      border-color: var(--teal);
    }

    .friction-char-input.success {
      border-color: #22c55e;
      background: #f0fdf4;
    }

    .friction-char-input.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .friction-code {
      display: none;
    }

    .friction-input-row {
      display: none;
    }

    .friction-input {
      display: none;
    }

    @media (max-width: 400px) {
      .friction-pair {
        gap: 3px;
      }
      .friction-char,
      .friction-char-input {
        width: 28px;
        height: 34px;
        font-size: 0.9rem;
      }
      .friction-pair-container {
        gap: 3px;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .friction-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .friction-buttons button {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-cancel {
      background: var(--grey-light);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-unlock {
      background: var(--teal);
      border: none;
      color: var(--white);
      opacity: 0.5;
    }

    .btn-unlock:disabled {
      cursor: not-allowed;
    }

    .btn-unlock.ready {
      opacity: 1;
    }

    .friction-error {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 8px;
      min-height: 20px;
    }

    .friction-timer {
      color: var(--teal);
      font-size: 0.85rem;
      margin-top: 16px;
      min-height: 20px;
    }

    /* =================== */
    /* MOBILE RESPONSIVE   */
    /* =================== */
    @media (max-width: 600px) {
      .homepage { padding: 40px 20px; }
      .headline { font-size: 1.7rem; }

      .auth-buttons {
        flex-direction: column;
        align-items: center;
      }

      .btn-oauth {
        width: 100%;
        max-width: 280px;
        justify-content: center;
      }

      .friction-code { font-size: 1rem; }
      .message { max-width: 90%; }
    }
  </style>

</head>

<body>
  <!-- HOMEPAGE -->
  <div class="homepage" id="homepage">
    <div class="brand">FRICTION AI</div>

```
<h1 class="headline">Slow down your AI â€” on purpose.</h1>

<p class="subheadline">Friction AI adds intentional pauses before messages are sent, helping reduce impulsive use and increase presence.</p>

<div class="section">
  <h2 class="section-title">How it works</h2>
  <ul class="section-list">
    <li>You may be asked to type a short code before sending</li>
    <li>Continued use gradually increases the effort across 15 levels</li>
    <li>It caps at two rows of 16 characters and resets after 2 hours</li>
  </ul>
</div>

<div class="section">
  <h2 class="section-title">Why</h2>
  <p class="section-subtitle">Tough love, not punishment.</p>
  <p class="section-text">We slow things down because we care about attention, presence, and real-world goals.</p>
</div>

<div class="section">
  <h2 class="section-title">Our philosophy</h2>
  <p class="philosophy-line">Ease creates dependency.</p>
  <p class="philosophy-line">Thoughtful friction creates awareness.</p>
  <p class="philosophy-line">We optimise for presence, not engagement.</p>
</div>

<div class="divider"></div>

<div class="cta-section">
  <h2 class="section-title">Try it</h2>
  <p class="cta-text">By continuing, you're choosing a slower AI experience.</p>

  <div class="auth-buttons">
    <button class="btn-oauth" id="btnApple" type="button">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
      </svg>
      Continue with Apple
    </button>

    <button class="btn-oauth" id="btnGoogle" type="button">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>
  </div>

  <button class="btn-primary" id="btnEmail" type="button">Sign in with email</button>

  <!-- Hidden Google Sign-In button -->
  <div id="googleButtonHidden" style="position: absolute; opacity: 0; pointer-events: none; height: 0; overflow: hidden;"></div>

  <p class="footer-note">Works best in your browser. Home-screen optional.</p>
</div>
```

  </div>

  <!-- CHAT APPLICATION -->

  <div class="chat-app" id="chatApp">
    <header class="chat-header">
      <div class="chat-header-left">
        <button class="btn-icon" id="btnMenu" title="Menu" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="chat-header-center">
        <select class="model-select" id="modelSelect">
          <option value="claude">Claude Sonnet 4.5</option>
          <option value="gpt">GPT-4o</option>
          <option value="gemini">Google Gemini 2.5</option>
          <option value="grok">Grok 3</option>
          <option value="perplexity">Perplexity Sonar</option>
        </select>
      </div>
      <div class="chat-header-right">
        <div class="header-timer" id="headerTimer"></div>
      </div>
    </header>

```
<div class="chat-messages" id="chatMessages">
  <div class="welcome-message">
    <div class="welcome-icon">âœ¦</div>
    <h2>How can I help you today?</h2>
    <p>Remember: slow is intentional.</p>
  </div>
</div>

<div class="typing-indicator" id="typingIndicator">
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
</div>

<div class="chat-input-area">
  <div class="chat-input-wrapper">
    <textarea class="chat-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
    <button class="btn-send" id="btnSend" type="button" aria-label="Send message">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>
```

  </div>

  <!-- SIDE MENU -->

  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <div class="menu-profile" id="menuProfile">
        <img class="profile-pic" id="profilePic" src="" alt="Profile" />
        <div class="profile-info">
          <span class="profile-name" id="profileName"></span>
          <span class="profile-email" id="profileEmail"></span>
        </div>
      </div>
      <button class="btn-close-menu" id="btnCloseMenu" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

```
<div class="menu-content">
  <button class="menu-btn-new" id="btnNewChat" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/>
      <line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    New Chat
  </button>

  <div class="menu-section">
    <div class="menu-section-title">Chat History</div>
    
    <div class="menu-category" data-model="claude">
      <button class="menu-category-header" type="button">
        <span>Claude</span>
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="menu-category-items">
        <div class="menu-empty">No chats yet</div>
      </div>
    </div>

    <div class="menu-category" data-model="gpt">
      <button class="menu-category-header" type="button">
        <span>GPT-4o</span>
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="menu-category-items">
        <div class="menu-empty">No chats yet</div>
      </div>
    </div>

    <div class="menu-category" data-model="gemini">
      <button class="menu-category-header" type="button">
        <span>Google Gemini</span>
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="menu-category-items">
        <div class="menu-empty">No chats yet</div>
      </div>
    </div>

    <div class="menu-category" data-model="grok">
      <button class="menu-category-header" type="button">
        <span>Grok</span>
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="menu-category-items">
        <div class="menu-empty">No chats yet</div>
      </div>
    </div>

    <div class="menu-category" data-model="perplexity">
      <button class="menu-category-header" type="button">
        <span>Perplexity</span>
        <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>
      <div class="menu-category-items">
        <div class="menu-empty">No chats yet</div>
      </div>
    </div>
  </div>

  <div class="menu-divider"></div>

  <!-- Placeholder for future menu items -->
  <div class="menu-section">
    <div class="menu-section-title">More</div>
    <button class="menu-item" id="btnSettings" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
      </svg>
      <span>Settings</span>
    </button>
    <button class="menu-item" id="btnAbout" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
      <span>About</span>
    </button>
  </div>
</div>

<div class="menu-footer">
  <button class="menu-item menu-item-logout" id="btnSignOut" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
      <polyline points="16 17 21 12 16 7"/>
      <line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
    <span>Sign Out</span>
  </button>
</div>
```

  </div>

  <!-- FRICTION OVERLAY -->

  <div class="friction-overlay" id="frictionOverlay">
    <div class="friction-box">
      <h2 class="friction-title">Pause & reflect</h2>
      <p class="friction-subtitle">Type the code to send.</p>

```
  <div class="friction-row" id="frictionRow1">
    <div class="friction-pair-container" id="frictionPairs1"></div>
  </div>

  <div class="friction-row" id="frictionRow2">
    <div class="friction-pair-container" id="frictionPairs2"></div>
  </div>

  <div class="friction-buttons">
    <button class="btn-cancel" id="frictionCancel" type="button">Cancel</button>
    <button class="btn-unlock" id="frictionUnlock" type="button" disabled>Send message</button>
  </div>

  <p class="friction-timer" id="frictionTimer"></p>
  <p class="friction-error" id="frictionError"></p>
</div>
```

  </div>

  <script>
    // STATE
    let state = {
      messages: [],
      pendingMessage: null,
      isProcessing: false
    };

    // AUTH STATE
    const GOOGLE_CLIENT_ID = '37442638167-t8m3fql61v05h01qmvall1bki9k88tim.apps.googleusercontent.com';
    const ADMIN_EMAIL = 'fatboydimsim@gmail.com';
    
    let currentUser = null;
    let isAdmin = false;

    // Free models available to everyone, paid models only for admin
    const FREE_MODELS = ['gemini'];
    const PAID_MODELS = ['claude', 'gpt', 'grok', 'perplexity'];

    function loadUserFromStorage() {
      const saved = localStorage.getItem('friction_user');
      if (saved) {
        currentUser = JSON.parse(saved);
        isAdmin = currentUser.email === ADMIN_EMAIL;
        return true;
      }
      return false;
    }

    function saveUserToStorage() {
      if (currentUser) {
        localStorage.setItem('friction_user', JSON.stringify(currentUser));
      } else {
        localStorage.removeItem('friction_user');
      }
    }

    function handleGoogleSignIn(response) {
      // Decode the JWT token
      const base64Url = response.credential.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const padded = base64 + '==='.slice((base64.length + 3) % 4);
      const payload = JSON.parse(atob(padded));
      
      currentUser = {
        email: payload.email,
        name: payload.name,
        picture: payload.picture
      };
      
      isAdmin = currentUser.email === ADMIN_EMAIL;
      saveUserToStorage();
      updateModelAccess();
      updateProfileDisplay();
      showChat();
    }

    function signOut() {
      currentUser = null;
      isAdmin = false;
      localStorage.removeItem('friction_user');
      google.accounts.id.disableAutoSelect();
      updateModelAccess();
      showHomepage();
    }

    function updateModelAccess() {
      const options = modelSelect.querySelectorAll('option');
      options.forEach(function(option) {
        const model = option.value;
        if (PAID_MODELS.includes(model) && !isAdmin) {
          option.disabled = true;
          option.textContent = option.textContent.replace(' ðŸ”’', '') + ' ðŸ”’';
        } else {
          option.disabled = false;
          option.textContent = option.textContent.replace(' ðŸ”’', '');
        }
      });

      // If current selection is a paid model and user is not admin, switch to Gemini
      if (PAID_MODELS.includes(modelSelect.value) && !isAdmin) {
        modelSelect.value = 'gemini';
      }
    }

    function initGoogleSignIn() {
      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleGoogleSignIn,
          auto_select: false
        });

        // Render a hidden Google button that we'll click programmatically
        google.accounts.id.renderButton(
          document.getElementById('googleButtonHidden'),
          { theme: 'outline', size: 'large', width: 280 }
        );

        // Check if user already signed in - auto go to chat
        if (loadUserFromStorage()) {
          updateModelAccess();
          updateProfileDisplay();
          showChat(); // Auto-navigate to chat if already signed in
        }
      } else {
        // Retry if Google script not loaded yet
        setTimeout(initGoogleSignIn, 100);
      }
    }

    initGoogleSignIn();

    // DOM ELEMENTS
    const homepage = document.getElementById('homepage');
    const chatApp = document.getElementById('chatApp');
    const btnApple = document.getElementById('btnApple');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnEmail = document.getElementById('btnEmail');

    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const btnSend = document.getElementById('btnSend');
    const modelSelect = document.getElementById('modelSelect');
    const btnMenu = document.getElementById('btnMenu');
    const typingIndicator = document.getElementById('typingIndicator');

    // Side menu elements
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const btnCloseMenu = document.getElementById('btnCloseMenu');
    const btnNewChat = document.getElementById('btnNewChat');
    const btnSignOut = document.getElementById('btnSignOut');
    const btnSettings = document.getElementById('btnSettings');
    const btnAbout = document.getElementById('btnAbout');
    
    // Profile elements
    const profilePic = document.getElementById('profilePic');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');

    function updateProfileDisplay() {
      if (currentUser) {
        profilePic.src = currentUser.picture || '';
        profilePic.style.display = currentUser.picture ? 'block' : 'none';
        profileName.textContent = currentUser.name || 'User';
        profileEmail.textContent = currentUser.email || '';
      }
    }

    const frictionOverlay = document.getElementById('frictionOverlay');
    const frictionPairs1 = document.getElementById('frictionPairs1');
    const frictionPairs2 = document.getElementById('frictionPairs2');
    const frictionCancel = document.getElementById('frictionCancel');
    const frictionUnlock = document.getElementById('frictionUnlock');
    const frictionError = document.getElementById('frictionError');

    // SCROLL LOCK
    let _scrollYBeforeLock = 0;

    function lockBodyScroll() {
      if (document.body.classList.contains('scroll-locked')) return;
      _scrollYBeforeLock = window.scrollY || 0;
      document.body.classList.add('scroll-locked');
      document.body.style.top = '-' + _scrollYBeforeLock + 'px';
    }

    function unlockBodyScroll() {
      if (!document.body.classList.contains('scroll-locked')) return;
      document.body.classList.remove('scroll-locked');
      document.body.style.top = '';
      window.scrollTo(0, _scrollYBeforeLock || 0);
    }

    function preventTouchMove(e) {
      const box = document.querySelector('.friction-box');
      if (box && box.contains(e.target)) return;
      e.preventDefault();
    }

    // CODE GENERATION
    function generateChallenge(length) {
      const lower = 'abcdefghjkmnpqrstuvwxyz';
      const upper = 'ABCDEFGHJKMNPQRSTUVWXYZ';
      const numbers = '23456789';
      const symbols = '!@#$%&*^~+-=<>?';

      let result = '';
      for (let i = 0; i < length; i++) {
        const pattern = i % 4;
        let charSet;
        if (pattern === 0) charSet = lower;
        else if (pattern === 1) charSet = symbols;
        else if (pattern === 2) charSet = upper;
        else charSet = numbers;
        result += charSet.charAt(Math.floor(Math.random() * charSet.length));
      }
      return result;
    }

    // NAVIGATION
    function showChat() {
      homepage.classList.add('hidden');
      chatApp.classList.add('active');
      if (lastMessageTime && frictionLevel > 0) startHeaderTimer();
      updateKeyboardOffset();
      scrollChatToBottom();
    }

    function showHomepage() {
      chatApp.classList.remove('active');
      homepage.classList.remove('hidden');
      state.messages = [];
      chatMessages.innerHTML = '<div class="welcome-message"><div class="welcome-icon">âœ¦</div><h2>How can I help you today?</h2><p>Remember: slow is intentional.</p></div>';
      document.documentElement.style.setProperty('--kb', '0px');
    }

    btnApple.addEventListener('click', function() {
      // TODO: Apple Sign-In
      alert('Apple Sign-In coming soon!');
    });
    
    btnGoogle.addEventListener('click', function() {
      if (!window.google || !google.accounts || !google.accounts.id) {
        initGoogleSignIn();
        return;
      }
      // Click the hidden Google button to trigger sign-in
      const hiddenBtn = document.querySelector('#googleButtonHidden div[role="button"]');
      if (hiddenBtn) {
        hiddenBtn.click();
      } else {
        // Fallback: try One Tap
        google.accounts.id.prompt();
      }
    });
    
    btnEmail.addEventListener('click', function() {
      // TODO: Email Sign-In
      alert('Email Sign-In coming soon!');
    });
    
    // SIDE MENU FUNCTIONS
    function openMenu() {
      sideMenu.classList.add('active');
      menuOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      sideMenu.classList.remove('active');
      menuOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    btnMenu.addEventListener('click', openMenu);
    btnCloseMenu.addEventListener('click', closeMenu);
    menuOverlay.addEventListener('click', closeMenu);

    btnNewChat.addEventListener('click', function() {
      // Clear current chat and start fresh
      state.messages = [];
      chatMessages.innerHTML = '<div class="welcome-message"><div class="welcome-icon">âœ¦</div><h2>How can I help you today?</h2><p>Remember: slow is intentional.</p></div>';
      closeMenu();
    });

    btnSignOut.addEventListener('click', function() {
      closeMenu();
      signOut();
    });

    btnSettings.addEventListener('click', function() {
      // TODO: Open settings
      closeMenu();
    });

    btnAbout.addEventListener('click', function() {
      // TODO: Show about page
      closeMenu();
    });

    // Category expand/collapse
    document.querySelectorAll('.menu-category-header').forEach(function(header) {
      header.addEventListener('click', function() {
        const category = this.closest('.menu-category');
        category.classList.toggle('expanded');
      });
    });

    // FRICTION SYSTEM
    let challenge1 = '';
    let challenge2 = '';
    let frictionLevel = 0;
    let lastMessageTime = null;
    let timerInterval = null;
    const RESET_TIME = 2 * 60 * 60 * 1000;

    function loadFrictionState() {
      const saved = localStorage.getItem('friction_state');
      if (saved) {
        const s = JSON.parse(saved);
        lastMessageTime = s.lastMessageTime;
        frictionLevel = s.frictionLevel || 0;
        if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
          frictionLevel = 0;
          lastMessageTime = null;
          saveFrictionState();
        }
      }
    }

    function saveFrictionState() {
      localStorage.setItem('friction_state', JSON.stringify({ frictionLevel, lastMessageTime }));
    }

    function formatTimeRemaining(ms) {
      if (ms <= 0) return '0:00:00';
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      return hours + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
    }

    function updateTimer() {
      const timerEl = document.getElementById('frictionTimer');
      const headerTimerEl = document.getElementById('headerTimer');

      if (!lastMessageTime || frictionLevel === 0) {
        timerEl.textContent = '';
        headerTimerEl.classList.remove('active');
        headerTimerEl.textContent = '';
        return;
      }

      const elapsed = Date.now() - lastMessageTime;
      const remaining = RESET_TIME - elapsed;

      if (remaining <= 0) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
        timerEl.textContent = 'ðŸŽ‰ Reset! Back to Level 1.';
        headerTimerEl.textContent = 'ðŸŽ‰ Level 1';
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        setTimeout(function() { headerTimerEl.classList.remove('active'); }, 5000);
      } else {
        const timeStr = formatTimeRemaining(remaining);
        timerEl.textContent = 'â± Resets in ' + timeStr;
        headerTimerEl.textContent = 'L' + Math.min(frictionLevel + 1, 15) + ' Â· ' + timeStr;
        headerTimerEl.classList.add('active');
      }
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    let headerTimerInterval = null;
    function startHeaderTimer() {
      if (headerTimerInterval) clearInterval(headerTimerInterval);
      updateTimer();
      headerTimerInterval = setInterval(updateTimer, 1000);
    }

    function getFrictionConfig() {
      const configs = [
        { rows: 1, length: 4 },   // Level 1
        { rows: 1, length: 6 },   // Level 2
        { rows: 1, length: 8 },   // Level 3
        { rows: 1, length: 10 },  // Level 4
        { rows: 1, length: 12 },  // Level 5
        { rows: 1, length: 14 },  // Level 6
        { rows: 1, length: 16 },  // Level 7
        { rows: 1, length: 18 },  // Level 8
        { rows: 1, length: 20 },  // Level 9
        { rows: 2, length: 12 },  // Level 10
        { rows: 2, length: 14 },  // Level 11
        { rows: 2, length: 16 },  // Level 12
        { rows: 2, length: 18 },  // Level 13
        { rows: 2, length: 20 },  // Level 14
        { rows: 2, length: 16 },  // Level 15
      ];
      return configs[Math.min(frictionLevel, 14)];
    }

    function handlePaste(e) {
      e.preventDefault();
      frictionError.textContent = 'No pasting â€” type it out!';
    }

    function createCharPairs(code, container) {
      container.innerHTML = '';
      
      for (let i = 0; i < code.length; i++) {
        // Create pair container (code on top, input below)
        const pair = document.createElement('div');
        pair.className = 'friction-pair';
        
        // Create display character block
        const charBlock = document.createElement('div');
        charBlock.className = 'friction-char';
        charBlock.textContent = code[i];
        pair.appendChild(charBlock);
        
        // Create input block
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'friction-char-input';
        input.maxLength = 1;
        input.autocomplete = 'off';
        input.autocorrect = 'off';
        input.autocapitalize = 'off';
        input.spellcheck = false;
        input.dataset.index = i;
        input.dataset.expected = code[i];
        
        input.addEventListener('input', handleCharInput);
        input.addEventListener('keydown', handleCharKeydown);
        input.addEventListener('paste', handlePaste);
        input.addEventListener('drop', function(e) { e.preventDefault(); });
        
        pair.appendChild(input);
        container.appendChild(pair);
      }
    }

    function handleCharInput(e) {
      const input = e.target;
      const value = input.value;
      const expected = input.dataset.expected;
      
      if (value) {
        if (value === expected) {
          input.classList.add('success');
          input.classList.remove('error');
          // Move to next input
          const pair = input.closest('.friction-pair');
          const nextPair = pair.nextElementSibling;
          if (nextPair) {
            const nextInput = nextPair.querySelector('.friction-char-input');
            if (nextInput) nextInput.focus();
          }
        } else {
          input.classList.add('error');
          input.classList.remove('success');
        }
      } else {
        input.classList.remove('success', 'error');
      }
      
      checkAllInputs();
    }

    function handleCharKeydown(e) {
      const input = e.target;
      const pair = input.closest('.friction-pair');
      
      if (e.key === 'Backspace' && !input.value) {
        const prevPair = pair.previousElementSibling;
        if (prevPair) {
          const prevInput = prevPair.querySelector('.friction-char-input');
          if (prevInput) {
            prevInput.focus();
            prevInput.select();
          }
        }
      } else if (e.key === 'ArrowLeft') {
        const prevPair = pair.previousElementSibling;
        if (prevPair) {
          const prevInput = prevPair.querySelector('.friction-char-input');
          if (prevInput) prevInput.focus();
        }
      } else if (e.key === 'ArrowRight') {
        const nextPair = pair.nextElementSibling;
        if (nextPair) {
          const nextInput = nextPair.querySelector('.friction-char-input');
          if (nextInput) nextInput.focus();
        }
      }
    }

    function checkAllInputs() {
      const config = getFrictionConfig();
      
      // Check row 1
      const inputs1 = frictionPairs1.querySelectorAll('.friction-char-input');
      let match1 = true;
      inputs1.forEach(function(input) {
        if (input.value !== input.dataset.expected) match1 = false;
      });
      
      // Check row 2 if needed
      let match2 = true;
      if (config.rows === 2) {
        const inputs2 = frictionPairs2.querySelectorAll('.friction-char-input');
        inputs2.forEach(function(input) {
          if (input.value !== input.dataset.expected) match2 = false;
        });
      }
      
      if (match1 && match2) {
        frictionUnlock.disabled = false;
        frictionUnlock.classList.add('ready');
      } else {
        frictionUnlock.disabled = true;
        frictionUnlock.classList.remove('ready');
      }
      
      frictionError.textContent = '';
    }

    function showFriction(message) {
      if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
      }

      state.pendingMessage = message;
      const config = getFrictionConfig();

      challenge1 = generateChallenge(config.length);
      createCharPairs(challenge1, frictionPairs1);

      const row2 = document.getElementById('frictionRow2');
      if (config.rows === 2) {
        challenge2 = generateChallenge(config.length);
        createCharPairs(challenge2, frictionPairs2);
        row2.style.display = 'block';
      } else {
        challenge2 = '';
        row2.style.display = 'none';
      }

      frictionUnlock.disabled = true;
      frictionUnlock.classList.remove('ready');
      frictionError.textContent = '';

      const subtitle = document.querySelector('.friction-subtitle');
      if (frictionLevel < 14) {
        subtitle.textContent = 'Level ' + (frictionLevel + 1) + ' of 15 â€” Type the code to send.';
      } else {
        subtitle.textContent = 'Level 15 of 15 â€” Maximum friction. Take a 2-hour break to reset.';
      }

      startTimer();
      frictionOverlay.classList.add('active');
      lockBodyScroll();
      document.addEventListener('touchmove', preventTouchMove, { passive: false });
      document.documentElement.style.setProperty('--kb', '0px');
      
      // Focus first input
      setTimeout(function() {
        const firstInput = frictionPairs1.querySelector('.friction-char-input');
        if (firstInput) firstInput.focus();
      }, 10);
    }

    function hideFriction() {
      frictionOverlay.classList.remove('active');
      state.pendingMessage = null;
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      document.removeEventListener('touchmove', preventTouchMove);
      unlockBodyScroll();
      startHeaderTimer();
      setTimeout(updateKeyboardOffset, 80);
      setTimeout(scrollChatToBottom, 100);
    }

    frictionCancel.addEventListener('click', hideFriction);

    frictionUnlock.addEventListener('click', function() {
      const wasMaxLevel = frictionLevel >= 14;
      if (frictionLevel < 14) frictionLevel++;
      lastMessageTime = Date.now();
      saveFrictionState();

      const timerEl = document.getElementById('frictionTimer');

      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }

      // Save the message BEFORE hiding (hideFriction clears pendingMessage)
      const messageToSend = state.pendingMessage;
      
      if (wasMaxLevel) {
        timerEl.textContent = 'ðŸ”„ Level 5 remains. Timer resets to 2 hours with each message.';
        setTimeout(function() {
          hideFriction();
          sendMessage(messageToSend);
        }, 2000);
      } else {
        hideFriction();
        sendMessage(messageToSend);
      }
    });

    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().catch(function() {});
    }

    loadFrictionState();

    // CHAT FUNCTIONS
    function addMessage(content, type) {
      const div = document.createElement('div');
      div.className = 'message message-' + type;
      div.textContent = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage(content) {
      // Prevent duplicate sends
      if (state.isProcessing) return;
      
      const model = modelSelect.value;
      const welcome = chatMessages.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      addMessage(content, 'user');
      state.messages.push({ role: 'user', content: content });

      state.isProcessing = true;
      btnSend.disabled = true;

      typingIndicator.classList.add('active');
      chatMessages.appendChild(typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const response = await callBackend(model);
        state.messages.push({ role: 'assistant', content: response });
        addMessage(response, 'ai');
      } catch (error) {
        addMessage('Error: ' + error.message, 'error');
      } finally {
        state.isProcessing = false;
        btnSend.disabled = false;
        typingIndicator.classList.remove('active');
        requestAnimationFrame(scrollChatToBottom);
      }
    }

    async function callBackend(model) {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: model, messages: state.messages })
      });

      if (!res.ok) {
        let errorMsg = 'Backend API error';
        try { const error = await res.json(); errorMsg = error.error || errorMsg; } catch (e) {}
        throw new Error(errorMsg);
      }

      const data = await res.json();
      return data.response;
    }

    // INPUT HANDLING
    messageInput.addEventListener('input', function() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      requestAnimationFrame(scrollChatToBottom);
    });

    function handleSend() {
      const content = messageInput.value.trim();
      if (!content || state.isProcessing) return;
      messageInput.value = '';
      messageInput.style.height = 'auto';
      showFriction(content);
    }

    btnSend.addEventListener('click', handleSend);

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // iOS KEYBOARD
    function scrollChatToBottom() {
      if (!chatApp.classList.contains('active')) return;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateKeyboardOffset() {
      if (!window.visualViewport) return;
      const vv = window.visualViewport;
      const keyboardHeight = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
      const overlayOpen = frictionOverlay.classList.contains('active');
      document.documentElement.style.setProperty('--kb', overlayOpen ? '0px' : (keyboardHeight + 'px'));

      if (!overlayOpen && keyboardHeight > 0 && document.activeElement === messageInput) {
        requestAnimationFrame(function() {
          scrollChatToBottom();
          messageInput.scrollIntoView({ block: 'end', behavior: 'auto' });
        });
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateKeyboardOffset);
      window.visualViewport.addEventListener('scroll', updateKeyboardOffset);
    }

    document.addEventListener('focusin', function(e) {
      if (e.target === messageInput) {
        setTimeout(updateKeyboardOffset, 50);
        setTimeout(scrollChatToBottom, 80);
      }
    });

    document.addEventListener('focusout', function(e) {
      if (e.target === messageInput) {
        setTimeout(function() {
          document.documentElement.style.setProperty('--kb', '0px');
          scrollChatToBottom();
        }, 80);
      }
    });

    updateKeyboardOffset();
  </script>

</body>
</html>