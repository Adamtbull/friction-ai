<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Friction AI - Slow down your AI, on purpose</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* Prevent flash of wrong content on load */
    body {
      opacity: 0;
      transition: opacity 0.15s ease-in;
    }

    body.ready {
      opacity: 1;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #d4e8e6 0%, #e8ecef 100%);
      color: #1f2937;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    button, input, textarea, select {
      font: inherit;
      color: inherit;
      letter-spacing: inherit;
    }

    button,
    input[type="text"],
    textarea,
    select {
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      background: none;
    }

    button, a, input, textarea, select {
      -webkit-tap-highlight-color: transparent;
    }

    body.scroll-locked {
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    :root {
      --teal-light: #d4e8e6;
      --teal-lighter: #e8f4f3;
      --teal: #5a9a94;
      --teal-dark: #4a8a84;
      --grey-light: #e8ecef;
      --grey: #6b7280;
      --grey-dark: #374151;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --white: #ffffff;
      --border: #d1d5db;
      --shadow: rgba(0, 0, 0, 0.05);

      --app-height: 100vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --kb: 0px;
    }

    @supports (height: 100dvh) {
      :root { --app-height: 100dvh; }
    }

    /* =================== */
    /* HOMEPAGE STYLES     */
    /* =================== */
    .homepage {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 24px;
      max-width: 600px;
      margin: 0 auto;
    }

    .homepage.hidden {
      display: none;
    }

    .brand {
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 24px;
    }

    .headline {
      font-size: 2rem;
      font-weight: 600;
      text-align: center;
      color: var(--text-primary);
      margin-bottom: 16px;
      line-height: 1.3;
    }

    .subheadline {
      font-size: 1rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 40px;
      max-width: 400px;
    }

    .section {
      width: 100%;
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .section-subtitle {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .section-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .section-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .section-list li {
      font-size: 0.95rem;
      color: var(--text-secondary);
      padding-left: 20px;
      position: relative;
      margin-bottom: 8px;
    }

    .section-list li::before {
      content: "â€¢";
      color: var(--teal);
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .philosophy-line {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    .cta-section {
      width: 100%;
      text-align: center;
      margin-top: 16px;
    }

    .cta-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .auth-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn-oauth {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-oauth:hover {
      border-color: var(--teal);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .btn-oauth svg {
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
    }

    .btn-primary {
      width: 100%;
      max-width: 320px;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      background: var(--teal);
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--teal-dark);
    }

    .footer-note {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 16px;
    }

    /* =================== */
    /* CHAT APP STYLES     */
    /* =================== */
    .chat-app {
      display: none;
      flex-direction: column;
      height: var(--app-height);
      background: linear-gradient(180deg, var(--teal-light) 0%, var(--grey-light) 100%);
    }

    .chat-app.active {
      display: flex;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(16px + var(--safe-top)) 20px 16px;
      background: rgba(255, 255, 255, 0.6);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .chat-header-left {
      width: 36px;
    }

    .chat-header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .chat-header-right {
      min-width: 70px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .model-select {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      outline: none;
      text-align: center;
    }

    .model-select:focus {
      background: rgba(0,0,0,0.05);
    }

    .header-timer {
      font-size: 0.65rem;
      color: var(--teal);
      background: var(--teal-light);
      padding: 4px 8px;
      border-radius: 12px;
      display: none;
      white-space: nowrap;
    }

    .header-timer.active {
      display: block;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 50%;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-icon:hover {
      border-color: var(--teal);
    }

    .btn-icon svg {
      width: 18px;
      height: 18px;
      stroke: var(--grey);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + 50px + 24px + var(--safe-bottom) + var(--kb));
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 0;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      min-width: 0;
    }

    .message-user {
      align-self: flex-end;
      background: var(--teal);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .message-ai {
      align-self: flex-start;
      background: var(--white);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-ai a {
      color: var(--teal);
      text-decoration: none;
      word-break: break-all;
    }

    .message-ai a:hover {
      text-decoration: underline;
    }

    .message-ai strong {
      font-weight: 600;
    }

    .message-error {
      align-self: center;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      font-size: 0.85rem;
    }

    /* CODE BLOCKS */
    .code-block-container {
      position: relative;
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      background: #0d2831;
    }

    .code-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #0a1f26;
      border-bottom: 1px solid #1a4a5c;
    }

    .code-block-lang {
      font-size: 0.75rem;
      color: #6bb8cc;
      text-transform: lowercase;
    }

    .code-copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: transparent;
      border: 1px solid #1a4a5c;
      border-radius: 4px;
      color: #6bb8cc;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .code-copy-btn:hover {
      background: #1a4a5c;
      color: #fff;
    }

    .code-copy-btn.copied {
      background: var(--teal);
      border-color: var(--teal);
      color: #fff;
    }

    .code-copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .code-block-content {
      padding: 16px;
      overflow-x: auto;
    }

    .code-block-content pre {
      margin: 0;
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      line-height: 1.5;
      color: #b8e6f0;
      white-space: pre;
    }

    .code-block-content code {
      font-family: inherit;
    }

    /* Inline code */
    .inline-code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      color: #e11d48;
    }

    /* ATTACHMENT PREVIEW */
    .attachment-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 12px;
      background: var(--grey-light);
      border-top: 1px solid var(--border);
    }

    .attachment-item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-width: 200px;
    }

    .attachment-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }

    .attachment-item .file-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--grey-light);
      border-radius: 4px;
    }

    .attachment-item .file-icon svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
    }

    .attachment-info {
      flex: 1;
      min-width: 0;
    }

    .attachment-name {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .attachment-size {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .attachment-remove {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* MESSAGE IMAGE */
    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }

    .message-file {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--grey-light);
      border-radius: 8px;
      margin-top: 8px;
    }

    .message-file svg {
      width: 20px;
      height: 20px;
      stroke: var(--teal);
    }

    .message-file span {
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    .welcome-message {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      width: 100%;
      max-width: 400px;
      pointer-events: none;
    }

    .welcome-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
    }

    .welcome-message h2 {
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .welcome-message p {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-secondary);
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 16px 20px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator.active {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--teal);
      border-radius: 50%;
      opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.4; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-4px); }
    }

    .chat-input-area {
      padding: 16px 20px calc(24px + var(--safe-bottom));
      background: rgba(255, 255, 255, 0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      transform: translateY(calc(-1 * var(--kb)));
      will-change: transform;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      max-width: 800px;
      margin: 0 auto;
      min-width: 0;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 8px 8px 8px 18px;
    }

    .chat-input {
      flex: 1;
      min-width: 0;
      padding: 8px 0;
      border: none;
      background: transparent;
      font-size: 16px;
      color: var(--text-primary);
      resize: none;
      min-height: 24px;
      max-height: 120px;
      outline: none;
      line-height: 1.5;
      overflow: hidden;
    }

    .chat-input::placeholder {
      color: var(--grey);
    }

    .btn-send {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-send:hover {
      background: var(--teal-dark);
    }

    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-send svg {
      width: 18px;
      height: 18px;
      stroke: var(--white);
      margin-left: 2px;
    }

    .btn-attach {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-attach:hover {
      background: var(--grey-light);
    }

    .btn-attach svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
    }

    /* =================== */
    /* SIDE MENU           */
    /* =================== */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 998;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 300px;
      max-width: 85vw;
      background: var(--white);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }

    .side-menu.active {
      transform: translateX(0);
    }

    .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .menu-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--grey-light);
    }

    .profile-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .profile-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-email {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      color: var(--teal);
    }

    .btn-close-menu {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn-close-menu:hover {
      background: var(--grey-light);
    }

    .btn-close-menu svg {
      width: 20px;
      height: 20px;
      stroke: var(--grey);
    }

    .menu-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .menu-btn-new {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }

    .menu-btn-new:hover {
      border-color: var(--teal);
      color: var(--teal);
      background: var(--teal-lighter);
    }

    .menu-btn-new svg {
      width: 18px;
      height: 18px;
    }

    .menu-section {
      margin-bottom: 16px;
    }

    .menu-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--grey);
      text-transform: uppercase;
      padding: 8px 12px;
    }

    .menu-category {
      margin-bottom: 4px;
    }

    .menu-category-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-category-header:hover {
      background: var(--grey-light);
    }

    .menu-category-header .chevron {
      width: 16px;
      height: 16px;
      stroke: var(--grey);
      transition: transform 0.2s ease;
    }

    .menu-category.expanded .chevron {
      transform: rotate(180deg);
    }

    .menu-category-items {
      display: none;
      padding-left: 12px;
    }

    .menu-category.expanded .menu-category-items {
      display: block;
    }

    .menu-empty {
      font-size: 0.8rem;
      color: var(--grey);
      padding: 8px 12px;
      font-style: italic;
    }

    .menu-history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px;
      border-radius: 6px;
      margin-bottom: 2px;
    }

    .menu-history-item:hover {
      background: var(--grey-light);
    }

    .menu-history-item.active {
      background: var(--teal-lighter);
    }

    .menu-history-title {
      flex: 1;
      padding: 8px;
      border: none;
      background: transparent;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-history-item:hover .menu-history-title,
    .menu-history-item.active .menu-history-title {
      color: var(--text-primary);
    }

    .menu-history-delete {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease;
      border-radius: 4px;
    }

    .menu-history-item:hover .menu-history-delete {
      opacity: 0.5;
    }

    .menu-history-delete:hover {
      opacity: 1 !important;
      background: #fef2f2;
    }

    .menu-history-delete svg {
      width: 14px;
      height: 14px;
      stroke: #dc2626;
    }

    .menu-chat-item {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.2s ease;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-chat-item:hover {
      background: var(--grey-light);
      color: var(--text-primary);
    }

    .menu-divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 0.9rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .menu-item:hover {
      background: var(--grey-light);
      color: var(--text-primary);
    }

    .menu-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .menu-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      padding-bottom: calc(16px + var(--safe-bottom));
    }

    .menu-item-logout:hover {
      background: #fef2f2;
      color: #dc2626;
    }

    .menu-item-logout:hover svg {
      stroke: #dc2626;
    }

    /* =================== */
    /* FRICTION OVERLAY    */
    /* =================== */
    .friction-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      overscroll-behavior: contain;
    }

    .friction-overlay.active {
      display: flex;
    }

    .friction-box {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .friction-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .friction-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 24px;
    }

    .friction-row {
      margin-bottom: 24px;
    }

    .friction-row:last-of-type {
      margin-bottom: 12px;
    }

    .friction-label {
      display: none;
    }

    .friction-pair-container {
      display: flex;
      justify-content: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .friction-pair {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .friction-char {
      width: 32px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--grey-light);
      border-radius: 6px;
      font-family: 'SF Mono', 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', Monaco, 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      user-select: none;
      -webkit-user-select: none;
    }

    .friction-char-input {
      width: 32px;
      height: 38px;
      padding: 0;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: 'SF Mono', 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', Monaco, 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
      background: var(--white);
    }

    .friction-char-input:focus {
      border-color: var(--teal);
    }

    .friction-char-input.success {
      border-color: #22c55e;
      background: #f0fdf4;
    }

    .friction-char-input.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .friction-code {
      display: none;
    }

    .friction-input-row {
      display: none;
    }

    .friction-input {
      display: none;
    }

    @media (max-width: 400px) {
      .friction-pair {
        gap: 3px;
      }
      .friction-char,
      .friction-char-input {
        width: 28px;
        height: 34px;
        font-size: 0.9rem;
      }
      .friction-pair-container {
        gap: 3px;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .friction-goal-reminder {
      background: var(--teal-lighter);
      border-left: 3px solid var(--teal);
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 0 8px 8px 0;
      text-align: left;
    }

    .friction-goal-reminder:empty {
      display: none;
    }

    .friction-goal-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--grey);
      margin-bottom: 4px;
    }

    .friction-goal-text {
      font-size: 0.95rem;
      color: var(--text-primary);
      font-style: italic;
    }

    /* ONBOARDING OVERLAY */
    .onboarding-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .onboarding-overlay.active {
      display: flex;
    }

    .onboarding-box {
      background: var(--white);
      border-radius: 16px;
      padding: 32px 28px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 8px 32px var(--shadow);
      max-height: 90vh;
      overflow-y: auto;
    }

    .onboarding-step {
      display: none;
    }

    .onboarding-step.active {
      display: block;
    }

    .onboarding-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .onboarding-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 16px;
    }

    .onboarding-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0 0 20px;
    }

    .onboarding-textarea {
      width: 100%;
      min-height: 100px;
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      margin-bottom: 20px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .onboarding-textarea:focus {
      border-color: var(--teal);
    }

    .onboarding-textarea::placeholder {
      color: var(--grey);
    }

    .shortterm-goals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .shortterm-goal-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .shortterm-goal-input:focus {
      border-color: var(--teal);
    }

    .onboarding-btn-add {
      background: transparent;
      border: none;
      color: var(--teal);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      padding: 8px;
      margin-bottom: 20px;
    }

    .onboarding-btn-add:hover {
      text-decoration: underline;
    }

    .onboarding-nav {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .onboarding-btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .onboarding-btn.primary {
      background: var(--teal);
      color: var(--white);
    }

    .onboarding-btn.primary:hover {
      background: var(--teal-dark);
    }

    .onboarding-btn.secondary {
      background: var(--grey-light);
      color: var(--text-secondary);
    }

    .onboarding-btn.secondary:hover {
      background: var(--border);
    }

    .onboarding-summary {
      background: var(--grey-light);
      border-radius: 10px;
      padding: 16px;
      text-align: left;
      margin-bottom: 20px;
    }

    .onboarding-summary-item {
      margin-bottom: 12px;
    }

    .onboarding-summary-item:last-child {
      margin-bottom: 0;
    }

    .onboarding-summary-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--grey);
      margin-bottom: 4px;
    }

    .onboarding-summary-text {
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    /* GOAL CHECK-IN */
    .checkin-goals-list {
      text-align: left;
      margin-bottom: 20px;
    }

    .checkin-goal-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--grey-light);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .checkin-goal-checkbox {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: var(--teal);
    }

    .checkin-goal-text {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .checkin-goal-text.completed {
      text-decoration: line-through;
      color: var(--grey);
    }

    /* CHAT BACKGROUND GOAL */
    .chat-background-goal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.3rem;
      color: var(--text-primary);
      opacity: 0;
      pointer-events: none;
      text-align: center;
      padding: 40px;
      max-width: 80%;
      font-style: italic;
      transition: opacity 0.5s ease;
      z-index: 1;
    }

    /* SETTINGS OVERLAY */
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: flex-start;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }

    .settings-overlay.active {
      display: flex;
    }

    .settings-box {
      background: var(--white);
      border-radius: 16px;
      max-width: 480px;
      width: 100%;
      margin: 20px 0;
      box-shadow: 0 8px 32px var(--shadow);
      overflow: hidden;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .settings-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .settings-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--grey-light);
      border-radius: 50%;
      cursor: pointer;
    }

    .settings-close svg {
      width: 18px;
      height: 18px;
      stroke: var(--text-secondary);
    }

    .settings-close:hover {
      background: var(--border);
    }

    .settings-lock-banner {
      background: #fef3c7;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #fcd34d;
    }

    .lock-icon {
      font-size: 1.1rem;
    }

    .lock-text {
      font-size: 0.9rem;
      color: #92400e;
      font-weight: 500;
    }

    .settings-content {
      padding: 8px 0;
    }

    .settings-content.locked {
      opacity: 0.5;
      pointer-events: none;
    }

    .settings-section {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px;
    }

    .settings-section-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0 0 16px;
      line-height: 1.4;
    }

    .settings-radio {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 0;
      cursor: pointer;
    }

    .settings-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--teal);
      cursor: pointer;
    }

    .radio-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .radio-label strong {
      font-size: 0.95rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .radio-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .settings-radio.strict-mode .radio-label strong {
      color: #dc2626;
    }

    .settings-radio.strict-mode .radio-desc {
      color: #dc2626;
      font-weight: 500;
    }

    .strict-warning {
      background: #fef2f2;
      border-left: 3px solid #dc2626;
      padding: 10px 12px;
      margin: 8px 0 0 32px;
      border-radius: 0 6px 6px 0;
      font-size: 0.8rem;
      color: #991b1b;
      line-height: 1.4;
    }

    .settings-checkbox {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      cursor: pointer;
    }

    .settings-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--teal);
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .settings-lock-section {
      background: var(--grey-light);
    }

    .settings-lock-controls {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .settings-select {
      flex: 1;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--white);
      cursor: pointer;
      outline: none;
    }

    .settings-select:focus {
      border-color: var(--teal);
    }

    .settings-lock-btn {
      padding: 12px 20px;
      background: #dc2626;
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .settings-lock-btn:hover {
      background: #b91c1c;
    }

    .settings-section-note {
      font-size: 0.85rem;
      color: #f59e0b;
      background: #fef3c7;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    #delayOptions.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .lock-time-picker {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .lock-time-row {
      flex: 1;
      text-align: center;
    }

    .lock-time-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .lock-time-input {
      width: 100%;
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      background: var(--white);
      outline: none;
    }

    .lock-time-input:focus {
      border-color: var(--teal);
    }

    .lock-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .lock-preset-btn {
      padding: 8px 14px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .lock-preset-btn:hover {
      background: var(--teal);
      color: var(--white);
      border-color: var(--teal);
    }

    .settings-lock-btn {
      width: 100%;
      padding: 14px 20px;
      background: #dc2626;
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    /* MESSAGE DELAY OVERLAY */
    .delay-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
    }

    .delay-overlay.active {
      display: flex;
    }

    .delay-box {
      background: var(--white);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }

    .delay-countdown {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
    }

    .delay-ring {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .delay-ring-bg {
      fill: none;
      stroke: var(--grey-light);
      stroke-width: 8;
    }

    .delay-ring-progress {
      fill: none;
      stroke: var(--teal);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear;
    }

    .delay-time {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .delay-text {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .delay-hint {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 24px;
      font-style: italic;
    }

    .delay-cancel {
      padding: 12px 32px;
      background: var(--grey-light);
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .delay-cancel:hover {
      background: var(--border);
    }

    .delay-cancel.hidden {
      display: none;
    }

    .friction-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .friction-buttons button {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-cancel {
      background: var(--grey-light);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-unlock {
      background: var(--teal);
      border: none;
      color: var(--white);
      opacity: 0.5;
    }

    .btn-unlock:disabled {
      cursor: not-allowed;
    }

    .btn-unlock.ready {
      opacity: 1;
    }

    .friction-error {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 8px;
      min-height: 20px;
    }

    .friction-timer {
      color: var(--teal);
      font-size: 0.85rem;
      margin-top: 16px;
      min-height: 20px;
    }

    /* =================== */
    /* GOALS VIEW          */
    /* =================== */
    #goals-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #goals-view.active {
      display: block;
    }

    #goals-view .goals-header {
      margin-bottom: 20px;
    }

    #goals-view .goals-section {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 6px 16px var(--shadow);
    }

    #goals-view .goals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    #goals-view .goals-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #goals-view .goals-textarea {
      width: 100%;
      min-height: 90px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
      resize: vertical;
    }

    #goals-view .goals-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
    }

    #goals-view .goals-btn-secondary {
      border-color: var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #goals-view .goals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    #goals-view .goals-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--white);
    }

    #goals-view .goals-item.completed {
      background: rgba(90, 154, 148, 0.08);
    }

    #goals-view .goals-item-input {
      flex: 1;
      min-width: 180px;
      border: none;
      background: transparent;
      font-size: 0.95rem;
      color: var(--text-primary);
      padding: 0;
    }

    #goals-view .goals-item-input:read-only {
      outline: none;
    }

    #goals-view .goals-item.completed .goals-item-input {
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    #goals-view .goals-item-actions {
      display: flex;
      gap: 8px;
    }

    #goals-view .goals-item-content {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #goals-view .goals-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #goals-view .goals-filter {
      margin-top: 12px;
    }

    #goals-view .goals-area-select {
      min-width: 180px;
    }

    #goals-view .goals-area-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--teal-lighter);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #goals-view .goals-banner {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    #goals-view .unstuck-panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #goals-view .unstuck-panel.active {
      display: flex;
    }

    #goals-view .unstuck-steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #goals-view .unstuck-step-row {
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 8px;
      align-items: center;
    }

    #goals-view .unstuck-step-row input {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #goals-view .unstuck-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* =================== */
    /* LIFE VIEW           */
    /* =================== */
    #life-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #life-view.active {
      display: block;
    }

    #life-view .life-header {
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    #life-view .life-header-copy {
      max-width: 600px;
    }

    #life-view .life-primary-cta {
      align-self: center;
      min-width: 140px;
    }

    #life-view .life-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    #life-view .life-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #life-view .life-tab {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      cursor: pointer;
      font-size: 0.85rem;
      min-height: 44px;
    }

    #life-view .life-tab.active {
      border-color: var(--teal);
      background: var(--teal-lighter);
      color: var(--text-primary);
    }

    #life-view .life-section {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 6px 16px var(--shadow);
    }

    #life-view .life-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    #life-view .life-input,
    #life-view .life-select,
    #life-view .life-textarea {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
      font: inherit;
    }

    #life-view .life-input {
      flex: 1;
      min-width: 200px;
    }

    #life-view .life-textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    #life-view .life-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      min-height: 44px;
    }

    #life-view .life-btn.secondary {
      border-color: var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #life-view .life-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #life-view .life-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: var(--white);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #life-view .life-item.completed {
      background: rgba(90, 154, 148, 0.08);
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    #life-view .life-item-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #life-view .life-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .life-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--teal-lighter);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #life-view .life-people-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #life-view .life-people-form {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      background: var(--white);
      box-shadow: 0 8px 18px var(--shadow);
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-people-form.active {
      display: flex;
    }

    #life-view .life-people-form-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #life-view .life-avatar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    #life-view .life-avatar-preview {
      width: 72px;
      height: 72px;
      border-radius: 18px;
      border: 1px solid var(--border);
      overflow: hidden;
      display: grid;
      place-items: center;
      background: rgba(90, 154, 148, 0.08);
    }

    #life-view .life-avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #life-view .life-avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #life-view .life-people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    #life-view .life-person-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: var(--white);
      box-shadow: 0 10px 20px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #life-view.person-view-active .life-header,
    #life-view.person-view-active .life-controls,
    #life-view.person-view-active [data-tab-panel] {
      display: none;
    }

    #life-view .life-person-view {
      display: none;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 24px var(--shadow);
    }

    #life-view.person-view-active .life-person-view {
      display: block;
    }

    #life-view .life-person-header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    #life-view .life-person-identity {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #life-view .life-person-avatar {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(90, 154, 148, 0.12);
    }

    #life-view .life-person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #life-view .life-person-role-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(90, 154, 148, 0.12);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #life-view .life-person-org {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #life-view .life-agenda-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: var(--white);
      box-shadow: 0 12px 24px var(--shadow);
    }

    #life-view .life-agenda-controls {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    #life-view .life-agenda-segmented {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(90, 154, 148, 0.12);
      border: 1px solid rgba(90, 154, 148, 0.2);
    }

    #life-view .life-agenda-segment {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      min-height: 36px;
    }

    #life-view .life-agenda-segment.active {
      background: var(--white);
      color: var(--text-primary);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    #life-view .life-agenda-list {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    #life-view .life-agenda-day {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-agenda-day-header {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 10px;
    }

    #life-view .life-agenda-item {
      display: grid;
      grid-template-columns: 4px 1fr auto;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      align-items: center;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    #life-view .life-agenda-item:hover {
      box-shadow: 0 10px 20px var(--shadow);
      transform: translateY(-1px);
    }

    #life-view .life-agenda-accent {
      width: 4px;
      height: 100%;
      border-radius: 999px;
      background: var(--teal);
    }

    #life-view .life-agenda-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    #life-view .life-agenda-location {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    #life-view .life-agenda-actions {
      margin-top: 6px;
    }

    #life-view .life-agenda-direction {
      border: none;
      background: none;
      padding: 0;
      font-size: 0.8rem;
      color: var(--teal-dark);
      cursor: pointer;
    }

    #life-view .life-agenda-time {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
      white-space: nowrap;
    }

    #life-view .life-agenda-empty {
      font-size: 0.9rem;
      color: var(--text-secondary);
      padding: 10px 0;
    }

    #life-view .life-person-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 24px var(--shadow);
    }

    #life-view .life-person-top {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    #life-view .life-person-name {
      font-size: 1rem;
      font-weight: 600;
    }

    #life-view .life-person-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #life-view .life-person-role {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(90, 154, 148, 0.12);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #life-view .life-person-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #life-view .life-people-empty {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 18px;
      text-align: center;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    #life-view.people-active .life-controls {
      align-items: flex-start;
    }

    #life-view .life-area-hidden {
      display: none;
    }

    @media (max-width: 720px) {
      #life-view .life-people-grid {
        grid-template-columns: 1fr;
      }

      #life-view .life-person-card {
        width: 100%;
      }
    }

    #life-view .unstuck-panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .unstuck-panel.active {
      display: flex;
    }

    #life-view .unstuck-steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #life-view .unstuck-step-row {
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 8px;
      align-items: center;
    }

    #life-view .unstuck-step-row input {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #life-view .life-appointments-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-appointments-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 600;
      padding: 8px 4px;
      cursor: pointer;
    }

    #life-view .life-chevron {
      transition: transform 0.2s ease;
      font-size: 1.1rem;
    }

    #life-view .life-appointments-toggle[aria-expanded="false"] .life-chevron {
      transform: rotate(-90deg);
    }

    #life-view .life-appointments-body.is-collapsed {
      display: none;
    }

    #life-view .life-appointments-actions {
      display: flex;
      justify-content: flex-start;
    }

    #life-view .life-appointments-list,
    #life-view .life-appointments-past,
    #appointments-view .appointments-feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-appointments-past-toggle,
    #appointments-view .appointments-past-toggle {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      text-align: left;
      padding: 4px 0;
      min-height: 44px;
    }

    #life-view .appointment-card,
    #appointments-view .appointment-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 0;
      background: var(--white);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #life-view .appointment-header,
    #appointments-view .appointment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      width: 100%;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: left;
      min-height: 56px;
    }

    #life-view .appointment-chevron,
    #appointments-view .appointment-chevron {
      transition: transform 0.2s ease;
      color: var(--text-secondary);
    }

    #life-view .appointment-card.expanded .appointment-chevron,
    #appointments-view .appointment-card.expanded .appointment-chevron {
      transform: rotate(180deg);
    }

    #life-view .appointment-header-content,
    #appointments-view .appointment-header-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #life-view .appointment-title,
    #appointments-view .appointment-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    #life-view .appointment-meta,
    #appointments-view .appointment-meta {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    #life-view .appointment-body,
    #appointments-view .appointment-body {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.2s ease, opacity 0.2s ease;
      padding: 0 16px;
    }

    #life-view .appointment-card.expanded .appointment-body,
    #appointments-view .appointment-card.expanded .appointment-body {
      max-height: 500px;
      opacity: 1;
      padding-bottom: 16px;
    }

    #life-view .appointment-detail,
    #appointments-view .appointment-detail {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    #life-view .appointment-detail span,
    #appointments-view .appointment-detail span {
      color: var(--text-secondary);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    #life-view .appointment-actions,
    #appointments-view .appointment-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    #life-view .appointment-action,
    #appointments-view .appointment-action {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #life-view .appointment-action.primary,
    #appointments-view .appointment-action.primary {
      background: var(--teal);
      color: var(--white);
      border-color: transparent;
    }

    #life-view .appointment-empty,
    #appointments-view .appointment-empty {
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 8px 0;
    }

    #life-view .appointment-modal,
    #appointments-view .appointment-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 24px;
    }

    #life-view .appointment-modal.active,
    #appointments-view .appointment-modal.active {
      display: flex;
    }

    #life-view .appointment-modal-backdrop,
    #appointments-view .appointment-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
    }

    #life-view .appointment-modal-card,
    #appointments-view .appointment-modal-card {
      position: relative;
      background: var(--white);
      border-radius: 18px;
      padding: 20px;
      width: min(92vw, 520px);
      max-height: min(86vh, 720px);
      overflow-y: auto;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #life-view .appointment-modal-header,
    #appointments-view .appointment-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #life-view .appointment-form,
    #appointments-view .appointment-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .appointment-row,
    #appointments-view .appointment-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    #life-view .appointment-field,
    #appointments-view .appointment-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #life-view .appointment-field label,
    #appointments-view .appointment-field label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .appointment-modal-actions,
    #appointments-view .appointment-modal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #appointments-view .appointments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    #appointments-view .appointments-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    #appointments-view .appointments-chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      background: var(--white);
      min-height: 44px;
    }

    #appointments-view .appointments-chip.active {
      background: var(--teal);
      color: var(--white);
      border-color: transparent;
    }

    #appointments-view .appointments-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: var(--teal);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
    }

    #appointments-view .appointments-btn.secondary {
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      font-weight: 500;
    }

    #appointments-view .appointments-input,
    #appointments-view .appointments-select,
    #appointments-view .appointments-textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.95rem;
      background: var(--white);
      color: var(--text-primary);
    }

    #appointments-view .appointments-textarea {
      min-height: 90px;
      resize: vertical;
    }

    #appointments-view .appointments-scan,
    #appointments-view .appointments-parse {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--white);
    }

    #appointments-view .appointments-scan-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    #appointments-view .appointments-scan-actions,
    #appointments-view .appointments-parse-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #appointments-view .appointments-scan-preview {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #appointments-view .appointments-scan-image {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      object-fit: cover;
      max-height: 220px;
    }

    #appointments-view .appointments-scan-note {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #appointments-view .appointments-text-details {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #appointments-view .appointments-text-preview {
      white-space: pre-wrap;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      color: var(--text-primary);
      background: rgba(248, 250, 252, 0.6);
    }

    #appointments-view .appointments-btn.is-loading .appointments-ai-label {
      opacity: 0.6;
    }

    #appointments-view .appointments-ai-dots {
      display: none;
      gap: 4px;
      align-items: center;
      margin-left: 8px;
    }

    #appointments-view .appointments-ai-dots span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
      opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out;
    }

    #appointments-view .appointments-ai-dots span:nth-child(2) { animation-delay: 0.2s; }
    #appointments-view .appointments-ai-dots span:nth-child(3) { animation-delay: 0.4s; }

    #appointments-view .appointments-btn.is-loading .appointments-ai-dots {
      display: inline-flex;
    }

    #calendar-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #calendar-view.active {
      display: block;
    }

    #calendar-view .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    #calendar-view .calendar-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
      box-shadow: 0 8px 18px var(--shadow);
      margin-bottom: 18px;
    }

    #calendar-view .calendar-month-label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      letter-spacing: 0.01em;
    }

    #calendar-view .calendar-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      padding: 10px 16px;
      font-size: 0.95rem;
      min-height: 44px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    #calendar-view .calendar-btn.primary {
      background: var(--teal);
      color: var(--white);
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(69, 152, 145, 0.2);
    }

    #calendar-view .calendar-btn.secondary {
      background: rgba(255, 255, 255, 0.7);
    }

    #calendar-view .calendar-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #calendar-view .calendar-toggle input {
      accent-color: var(--teal);
    }

    #calendar-view .calendar-modal.person-locked .calendar-person-row {
      display: none;
    }

    #calendar-view .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }

    #calendar-view .calendar-weekday {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    #calendar-view .calendar-day {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #calendar-view .calendar-day:hover {
      border-color: rgba(69, 152, 145, 0.5);
      box-shadow: 0 6px 14px var(--shadow);
    }

    #calendar-view .calendar-day.outside {
      opacity: 0.4;
    }

    #calendar-view .calendar-day-number {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    #calendar-view .calendar-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.72rem;
      color: var(--text-primary);
      background: rgba(69, 152, 145, 0.12);
      border: 1px solid rgba(69, 152, 145, 0.2);
      max-width: 100%;
    }

    #calendar-view .calendar-chip img {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    #calendar-view .calendar-chip span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #calendar-view .calendar-chip-more {
      background: rgba(0, 0, 0, 0.05);
      border-color: rgba(0, 0, 0, 0.1);
      color: var(--text-secondary);
      justify-content: center;
    }

    #calendar-view .calendar-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 40;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #calendar-view .calendar-modal.active {
      display: flex;
    }

    #calendar-view .calendar-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(8, 12, 18, 0.45);
      backdrop-filter: blur(4px);
    }

    #calendar-view .calendar-modal-card {
      position: relative;
      width: min(560px, 100%);
      max-height: min(80vh, 720px);
      overflow-y: auto;
      background: var(--white);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 1;
    }

    #calendar-view .calendar-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #calendar-view .calendar-day-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #calendar-view .calendar-event-card {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #calendar-view .calendar-event-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    #calendar-view .calendar-event-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    #calendar-view .calendar-event-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #calendar-view .calendar-event-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    #calendar-view .calendar-event-meta {
      font-size: 0.82rem;
      color: var(--text-secondary);
    }

    #calendar-view .calendar-event-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #calendar-view .calendar-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #calendar-view .calendar-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    #calendar-view .calendar-form-row.single {
      grid-template-columns: 1fr;
    }

    #calendar-view .calendar-input,
    #calendar-view .calendar-select,
    #calendar-view .calendar-textarea {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 0.95rem;
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.9);
      min-height: 44px;
    }

    #calendar-view .calendar-textarea {
      min-height: 90px;
      resize: vertical;
    }

    #calendar-view .calendar-person-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #calendar-view .calendar-person-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    #calendar-view .calendar-person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #calendar-view .calendar-repeat-options {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    #calendar-view .calendar-repeat-day {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 0;
      text-align: center;
      font-size: 0.8rem;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.8);
    }

    #calendar-view .calendar-repeat-day input {
      display: none;
    }

    #calendar-view .calendar-repeat-day.active {
      background: rgba(69, 152, 145, 0.15);
      border-color: rgba(69, 152, 145, 0.4);
      color: var(--text-primary);
      font-weight: 600;
    }

    #calendar-view .calendar-empty {
      border-radius: 16px;
      border: 1px dashed var(--border);
      padding: 16px;
      text-align: center;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.7);
    }

    @media (max-width: 900px) {
      #calendar-view .calendar-form-row {
        grid-template-columns: 1fr;
      }

      #calendar-view .calendar-repeat-options {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* =================== */
    /* CALENDAR IMPORT     */
    /* =================== */
    #calendar-import-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 24px calc(48px + var(--safe-bottom));
    }

    #calendar-import-view.active {
      display: block;
    }

    #calendar-import-view .calendar-import-card {
      background: var(--white);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 20px 40px -30px rgba(31, 41, 55, 0.35);
      border: 1px solid rgba(209, 213, 219, 0.6);
    }

    #calendar-import-view .calendar-import-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 20px;
    }

    #calendar-import-view .calendar-import-meta {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin: 0;
    }

    #calendar-import-view .calendar-import-form {
      display: grid;
      gap: 16px;
    }

    #calendar-import-view .calendar-import-row {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    #calendar-import-view .calendar-import-input,
    #calendar-import-view .calendar-import-select,
    #calendar-import-view .calendar-import-textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fafc;
    }

    #calendar-import-view .calendar-import-textarea {
      min-height: 120px;
      resize: vertical;
    }

    #calendar-import-view .calendar-import-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    #calendar-import-view .calendar-import-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    #calendar-import-view .calendar-import-btn {
      border-radius: 999px;
      padding: 10px 18px;
      border: 1px solid transparent;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--teal);
      color: var(--white);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    #calendar-import-view .calendar-import-btn.secondary {
      background: var(--white);
      color: var(--text-primary);
      border-color: var(--border);
    }

    #calendar-import-view .calendar-import-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px -18px rgba(31, 41, 55, 0.3);
    }

    #calendar-import-view .calendar-import-preview {
      background: #f3f4f6;
      border-radius: 14px;
      padding: 14px;
      font-size: 0.95rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    #calendar-import-view .calendar-import-notes summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    #calendar-import-view .calendar-import-success {
      display: none;
      text-align: center;
      padding: 40px 24px;
    }

    #calendar-import-view .calendar-import-success.active {
      display: block;
    }

    #calendar-import-view .calendar-import-success h3 {
      margin: 0 0 8px;
      font-size: 1.4rem;
    }

    #calendar-import-view .calendar-import-success p {
      margin: 0 0 20px;
      color: var(--text-secondary);
    }

    @media (max-width: 640px) {
      #calendar-import-view {
        padding: 32px 18px calc(32px + var(--safe-bottom));
      }

      #calendar-import-view .calendar-import-card {
        padding: 20px;
      }
    }
    /* =================== */
    /* FRICTION SOCIAL     */
    /* =================== */
    #friction-social-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #friction-social-view.active {
      display: block;
    }

    #friction-social-view .fs-header {
      margin-bottom: 20px;
    }

    #friction-social-view .fs-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }

    #friction-social-view .fs-friction-controls {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 6px 16px var(--shadow);
    }

    #friction-social-view .fs-friction-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    #friction-social-view .fs-friction-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    #friction-social-view .fs-friction-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      min-width: 130px;
    }

    #friction-social-view .fs-friction-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    #friction-social-view .fs-friction-options label,
    #friction-social-view .fs-friction-toggle {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    #friction-social-view .fs-search {
      flex: 1;
      min-width: 220px;
    }

    #friction-social-view .fs-search input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #friction-social-view .fs-add-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #friction-social-view .fs-add-btn:hover {
      background: var(--teal-dark);
    }

    #friction-social-view .fs-secondary-btn {
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #friction-social-view .fs-secondary-btn:hover {
      background: var(--grey-light);
    }

    #friction-social-view .fs-shelf {
      margin-bottom: 24px;
    }

    #friction-social-view .fs-shelf-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    #friction-social-view .fs-shelf-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #friction-social-view .fs-refresh-btn {
      padding: 6px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    #friction-social-view .fs-shelf-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #friction-social-view .fs-shelf-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-row {
      display: flex;
      gap: 14px;
      overflow-y: hidden;
      overflow-x: auto;
      padding: 4px 8px 10px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scroll-padding: 0 8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }

    #friction-social-view .fs-row::-webkit-scrollbar {
      height: 6px;
    }

    #friction-social-view .fs-row::-webkit-scrollbar-track {
      background: transparent;
    }

    #friction-social-view .fs-row::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 999px;
    }

    #friction-social-view .fs-card {
      flex: 0 0 auto;
      width: clamp(160px, 42vw, 220px);
      position: relative;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      text-align: left;
      cursor: pointer;
      box-shadow: 0 6px 16px var(--shadow);
      scroll-snap-align: start;
    }

    #friction-social-view .fs-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      background: var(--grey-light);
    }

    #friction-social-view .fs-card-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.8);
      color: var(--white);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    #friction-social-view .fs-card-badge--latest {
      background: var(--teal);
    }

    #friction-social-view .fs-card-badge--seen {
      top: auto;
      bottom: 8px;
      background: rgba(30, 41, 59, 0.75);
      text-transform: none;
    }

    #friction-social-view .fs-card-body {
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #friction-social-view .fs-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    #friction-social-view .fs-card-channel {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-empty {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-align: center;
      padding: 32px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.6);
    }

    #friction-social-view .fs-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #friction-social-view .fs-modal.active {
      display: flex;
    }

    #friction-social-view .fs-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
    }

    #friction-social-view .fs-modal-card {
      position: relative;
      width: min(90vw, 860px);
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      z-index: 1;
      display: flex;
      flex-direction: column;
    }

    #friction-social-view .fs-modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #friction-social-view .fs-modal-player {
      width: 100%;
      background: #000;
      aspect-ratio: 16 / 9;
    }

    #friction-social-view .fs-modal-player iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }

    #friction-social-view .fs-modal-meta {
      padding: 16px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #friction-social-view .fs-modal-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #friction-social-view .fs-modal-channel {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-modal-link {
      font-size: 0.85rem;
      color: var(--teal-dark);
      text-decoration: none;
      font-weight: 500;
    }

    #friction-social-view.modal-open {
      overflow: hidden;
    }

    #friction-social-view .fs-intent-overlay,
    #friction-social-view .fs-pause-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3100;
      padding: 24px;
    }

    #friction-social-view .fs-intent-overlay.active,
    #friction-social-view .fs-pause-overlay.active {
      display: flex;
    }

    #friction-social-view .fs-intent-backdrop,
    #friction-social-view .fs-pause-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
    }

    #friction-social-view .fs-intent-card,
    #friction-social-view .fs-pause-card {
      position: relative;
      z-index: 1;
      width: min(92vw, 520px);
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    #friction-social-view .fs-intent-title,
    #friction-social-view .fs-pause-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }

    #friction-social-view .fs-intent-text,
    #friction-social-view .fs-pause-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0;
    }

    #friction-social-view .fs-intent-actions,
    #friction-social-view .fs-pause-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #friction-social-view .fs-intent-btn,
    #friction-social-view .fs-pause-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-weight: 500;
      cursor: pointer;
    }

    #friction-social-view .fs-intent-btn.secondary,
    #friction-social-view .fs-pause-btn.secondary {
      border-color: var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #friction-social-view .fs-intent-checkbox {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-pause-timer {
      font-size: 0.9rem;
      color: var(--text-secondary);
      min-height: 20px;
    }

    #friction-social-view .fs-pause-upnext {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--grey-light);
    }

    #friction-social-view .fs-pause-upnext.active {
      display: flex;
    }

    #friction-social-view .fs-pause-goal {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-pause-goal-text {
      font-weight: 600;
      color: var(--text-primary);
    }

    #friction-social-view .fs-pause-goal-action {
      border: none;
      background: transparent;
      color: var(--teal-dark);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
    }

    #friction-social-view .fs-pause-goal-action:disabled {
      color: var(--text-secondary);
      cursor: default;
    }

    /* =================== */
    /* MOBILE RESPONSIVE   */
    /* =================== */
    @media (max-width: 600px) {
      .homepage { padding: 40px 20px; }
      .headline { font-size: 1.7rem; }

      .auth-buttons {
        flex-direction: column;
        align-items: center;
      }

      .btn-oauth {
        width: 100%;
        max-width: 280px;
        justify-content: center;
      }

      .friction-code { font-size: 1rem; }
      .message { max-width: 90%; }
    }

    /* CODE CANVAS */
    .code-canvas-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 2000; }
    .code-canvas-overlay.active { display: block; }
    .code-canvas { position: fixed; top: 0; right: 0; bottom: 0; width: 50%; min-width: 400px; max-width: 800px; background: var(--white); transform: translateX(100%); transition: transform 0.3s ease; z-index: 2001; display: flex; flex-direction: column; box-shadow: -4px 0 24px rgba(0,0,0,0.15); }
    .code-canvas.active { transform: translateX(0); }
    .code-canvas-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--teal-lighter); border-bottom: 1px solid var(--border); }
    .code-canvas-title { display: flex; align-items: center; gap: 10px; }
    .code-canvas-title span { color: var(--text-primary); font-size: 0.9rem; font-weight: 500; }
    .code-canvas-title svg { stroke: var(--teal); }
    .code-canvas-lang { background: var(--teal); color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; text-transform: lowercase; }
    .code-canvas-actions { display: flex; gap: 8px; }
    .btn-canvas-action { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--white); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
    .btn-canvas-action:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-lighter); }
    .btn-canvas-action.primary { background: var(--teal); border-color: var(--teal); color: var(--white); }
    .btn-canvas-action.primary:hover { background: var(--teal-dark); }
    .btn-canvas-action svg { width: 16px; height: 16px; }
    .btn-canvas-close { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--white); border: 1px solid var(--border); border-radius: 6px; color: var(--grey); cursor: pointer; transition: all 0.2s ease; }
    .btn-canvas-close:hover { border-color: var(--teal); color: var(--teal); }
    .btn-canvas-close svg { width: 18px; height: 18px; }
    .code-canvas-body { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: var(--grey-light); }
    .code-canvas-editor { flex: 1; width: 100%; padding: 20px; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; font-size: 0.9rem; line-height: 1.7; border: none; outline: none; resize: none; background: var(--white); color: var(--text-primary); tab-size: 2; margin: 16px; border-radius: 8px; width: calc(100% - 32px); }
    .code-canvas-editor::placeholder { color: var(--text-secondary); }
    .code-canvas-footer { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: var(--teal-lighter); border-top: 1px solid var(--border); }
    .code-canvas-info { font-size: 0.75rem; color: var(--text-secondary); }
    .btn-open-canvas { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: transparent; border: 1px solid #1a4a5c; border-radius: 4px; color: #6bb8cc; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; margin-left: 8px; }
    .btn-open-canvas:hover { background: #1a4a5c; color: #fff; }
    .btn-open-canvas svg { width: 12px; height: 12px; }
    @media (max-width: 768px) {
      .code-canvas { width: 100%; min-width: 100%; max-width: 100%; }
    }
</style>

</head>

<body>
  <!-- HOMEPAGE -->
  <div class="homepage" id="homepage">
    <div class="brand">FRICTION AI</div>

<h1 class="headline">Slow down your AI â€” on purpose.</h1>

<p class="subheadline">Friction AI adds intentional pauses before messages are sent, helping reduce impulsive use and increase presence.</p>

<div class="section">
  <h2 class="section-title">How it works</h2>
  <ul class="section-list">
    <li>You may be asked to type a short code before sending</li>
    <li>Continued use gradually increases the effort across 7 levels</li>
    <li>It caps at 10 characters and resets after 2 hours</li>
  </ul>
</div>

<div class="section">
  <h2 class="section-title">Why</h2>
  <p class="section-subtitle">Tough love, not punishment.</p>
  <p class="section-text">We slow things down because we care about attention, presence, and real-world goals.</p>
</div>

<div class="section">
  <h2 class="section-title">Our philosophy</h2>
  <p class="philosophy-line">Ease creates dependency.</p>
  <p class="philosophy-line">Thoughtful friction creates awareness.</p>
  <p class="philosophy-line">We optimise for presence, not engagement.</p>
</div>

<div class="divider"></div>

<div class="cta-section">
  <h2 class="section-title">Try it</h2>
  <p class="cta-text">By continuing, you're choosing a slower AI experience.</p>

  <div class="auth-buttons">
    <button class="btn-oauth" id="btnApple" type="button">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
      </svg>
      Continue with Apple
    </button>

    <button class="btn-oauth" id="btnGoogle" type="button">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>
  </div>

  <button class="btn-primary" id="btnEmail" type="button">Sign in with email</button>

  <!-- Hidden Google Sign-In button -->
  <div id="googleButtonHidden" style="position: absolute; opacity: 0; pointer-events: none; height: 0; overflow: hidden;"></div>

  <p class="footer-note">Works best in your browser. Home-screen optional.</p>
</div>

  </div>

  <!-- CHAT APPLICATION -->

  <div class="chat-app" id="chatApp">
    <header class="chat-header">
      <div class="chat-header-left">
        <button class="btn-icon" id="btnMenu" title="Menu" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="chat-header-center">
        <select class="model-select" id="modelSelect">
          <option value="claude">Claude Sonnet 4.5</option>
          <option value="gpt">GPT-4o</option>
          <option value="gemini">Google Gemini 2.5</option>
          <option value="grok">Grok 3</option>
          <option value="perplexity">Perplexity Sonar</option>
        </select>
      </div>
      <div class="chat-header-right">
        <div class="header-timer" id="headerTimer"></div>
      </div>
    </header>

<div class="chat-messages" id="chatMessages">
  <div class="chat-background-goal" id="chatBackgroundGoal"></div>
  <div class="welcome-message">
    <div class="welcome-icon">âœ¦</div>
    <h2>How can I help you today?</h2>
    <p>Remember: slow is intentional.</p>
  </div>
</div>

<div class="typing-indicator" id="typingIndicator">
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
</div>

<section id="friction-social-view" class="view" aria-hidden="true">
  <div class="fs-header">
    <h2 class="section-title">Friction Social</h2>
    <p class="section-text">Curate YouTube moments that reinforce slow, intentional habits.</p>
  </div>
  <div class="fs-friction-controls" id="fsFrictionControls">
    <div class="fs-friction-title">Friction controls</div>
    <div class="fs-friction-row">
      <label class="fs-friction-toggle">
        <input type="checkbox" id="fsFrictionEnabled" />
        <span>Friction reminders</span>
      </label>
    </div>
    <div class="fs-friction-row">
      <div class="fs-friction-label">Reminder frequency</div>
      <div class="fs-friction-options">
        <label><input type="radio" name="fsFrictionFrequency" value="1" />After every video</label>
        <label><input type="radio" name="fsFrictionFrequency" value="2" />Every 2 videos</label>
      </div>
    </div>
    <div class="fs-friction-row">
      <div class="fs-friction-label">Pause timer</div>
      <div class="fs-friction-options">
        <label><input type="radio" name="fsPauseSeconds" value="30" />30 seconds</label>
        <label><input type="radio" name="fsPauseSeconds" value="60" />60 seconds</label>
        <label><input type="radio" name="fsPauseSeconds" value="120" />120 seconds</label>
      </div>
    </div>
  </div>
  <div class="fs-controls">
    <label class="fs-search" for="fsSearchInput">
      <input type="text" id="fsSearchInput" placeholder="Search videos, channels, or IDs" />
    </label>
    <button class="fs-add-btn" id="fsAddVideo" type="button">Add video link</button>
    <button class="fs-add-btn" id="fsAddChannel" type="button">Add channel</button>
    <button class="fs-add-btn fs-secondary-btn" id="fsRefreshChannels" type="button">Refresh</button>
  </div>
  <div class="fs-shelves" id="fsShelves"></div>
  <div class="fs-empty" id="fsEmpty" style="display: none;"></div>

  <div class="fs-modal" id="fsModal" aria-hidden="true">
    <div class="fs-modal-backdrop" data-close></div>
    <div class="fs-modal-card" role="dialog" aria-modal="true" aria-label="YouTube player">
      <button class="fs-modal-close" id="fsModalClose" type="button" aria-label="Close video">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      <div class="fs-modal-player">
        <iframe id="fsModalFrame" title="YouTube video player" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      <div class="fs-modal-meta">
        <div class="fs-modal-title" id="fsModalTitle"></div>
        <div class="fs-modal-channel" id="fsModalChannel"></div>
        <a class="fs-modal-link" id="fsModalLink" href="#" target="_blank" rel="noopener">Watch on YouTube</a>
      </div>
    </div>
  </div>

  <div class="fs-intent-overlay" id="fsIntroOverlay" aria-hidden="true">
    <div class="fs-intent-backdrop"></div>
    <div class="fs-intent-card" role="dialog" aria-modal="true" aria-labelledby="fsIntroTitle">
      <h3 class="fs-intent-title" id="fsIntroTitle">Friction Social</h3>
      <p class="fs-intent-text">
        This isnâ€™t a feed. Itâ€™s a calm shelf of videos you choose.
        Tiny pauses help you stay intentional â€” no guilt, no judgement.
      </p>
      <label class="fs-intent-checkbox">
        <input type="checkbox" id="fsIntroDismiss" />
        <span>Donâ€™t show again</span>
      </label>
      <div class="fs-intent-actions">
        <button class="fs-intent-btn" id="fsIntroContinue" type="button">Continue</button>
      </div>
    </div>
  </div>

  <div class="fs-pause-overlay" id="fsPauseOverlay" aria-hidden="true">
    <div class="fs-pause-backdrop"></div>
    <div class="fs-pause-card" role="dialog" aria-modal="true" aria-labelledby="fsPauseTitle">
      <h3 class="fs-pause-title" id="fsPauseTitle">Tiny pause?</h3>
      <p class="fs-pause-text" id="fsPausePrompt"></p>
      <div class="fs-pause-timer" id="fsPauseTimer"></div>
      <div class="fs-pause-upnext" id="fsPauseUpNextPanel">
        <div class="fs-pause-goal">
          <span class="fs-pause-goal-text" id="fsPauseGoalText"></span>
          <button class="fs-pause-goal-action" id="fsPauseGoalDone" type="button">Mark done</button>
        </div>
        <button class="fs-pause-btn" id="fsPauseContinue" type="button" disabled>Continue to Up Next</button>
      </div>
      <div class="fs-pause-actions">
        <button class="fs-pause-btn secondary" id="fsPauseWatch" type="button">Watch another</button>
        <button class="fs-pause-btn" id="fsPauseTake" type="button">Take 60 seconds</button>
        <button class="fs-pause-btn secondary" id="fsPauseUpNext" type="button">Up Next (30s)</button>
        <button class="fs-pause-btn secondary" id="fsPauseSkip" type="button" style="display: none;">Skip</button>
        <button class="fs-pause-btn secondary" id="fsPauseDone" type="button">Done for now</button>
      </div>
    </div>
  </div>
</section>

<section id="goals-view" class="view" aria-hidden="true">
  <div class="goals-header">
    <h2 class="section-title">Goals</h2>
    <p class="section-text">Keep your intentions visible and easy to revisit.</p>
    <div class="goals-row goals-filter">
      <span class="goals-meta">Area</span>
      <select class="goals-input goals-area-select" id="goalsAreaFilter"></select>
    </div>
  </div>

  <div class="goals-section">
    <h3 class="section-subtitle">Short-term goals</h3>
    <div class="goals-row">
      <input class="goals-input" id="shortGoalInput" type="text" placeholder="Add a short-term goal" maxlength="80" />
      <select class="goals-input goals-area-select" id="shortGoalArea"></select>
      <button class="goals-btn" id="shortGoalAdd" type="button">Add</button>
    </div>
    <div class="goals-list" id="shortGoalList"></div>
    <button class="goals-btn goals-btn-secondary" id="shortGoalClear" type="button">Clear completed</button>
  </div>

  <div class="goals-section">
    <h3 class="section-subtitle">Long-term goals</h3>
    <div class="goals-banner" id="goalsNudge" style="display: none;">
      <div class="goals-meta">Youâ€™ve had goals sitting for a while. Want help breaking one into steps?</div>
      <button class="goals-btn goals-btn-secondary" id="goalsNudgeBtn" type="button">Break into steps</button>
    </div>
    <form id="longGoalForm">
      <div class="goals-row">
        <input class="goals-input" id="longGoalTitle" type="text" placeholder="Goal title" required maxlength="120" />
        <input class="goals-input" id="longGoalDate" type="date" />
        <select class="goals-input goals-area-select" id="longGoalArea"></select>
      </div>
      <div class="goals-row">
        <textarea class="goals-textarea" id="longGoalNote" placeholder="Add a note (optional)" maxlength="300"></textarea>
      </div>
      <div class="goals-row">
        <button class="goals-btn" id="longGoalAdd" type="submit">Add</button>
        <button class="goals-btn goals-btn-secondary" id="longGoalCancel" type="button" style="display: none;">Cancel edit</button>
      </div>
    </form>
    <div class="goals-list" id="longGoalList"></div>
    <div class="unstuck-panel" id="goalsUnstuckPanel" aria-live="polite"></div>
  </div>
</section>

<section id="life-view" class="view" aria-hidden="true">
  <div class="life-header">
    <div class="life-header-copy">
      <h2 class="section-title">Life</h2>
      <p class="section-text">Choose a person to manage appointments.</p>
    </div>
    <button class="life-btn life-primary-cta" id="lifeAddPersonPrimary" type="button">Add person</button>
  </div>

  <div class="life-section" data-tab-panel="people">
    <div class="life-people-layout">
      <div class="life-people-form" id="lifePeopleForm">
        <div class="life-people-form-header">
          <h3 class="section-subtitle" id="lifePeopleFormTitle">Add person</h3>
          <button class="life-btn secondary" id="lifePeopleFormCancel" type="button">Cancel</button>
        </div>
        <div class="life-avatar-row">
          <div class="life-avatar-preview">
            <img id="lifeAvatarPreview" alt="Avatar preview" />
          </div>
          <div class="life-avatar-actions">
            <label class="life-btn secondary" for="lifeAvatarUpload">Add photo</label>
            <input type="file" id="lifeAvatarUpload" accept="image/*" hidden>
            <button class="life-btn secondary" id="lifeAvatarRandom" type="button">Random avatar</button>
            <span class="life-meta" id="lifeAvatarHint">Photo uploads are stored only on this device.</span>
          </div>
        </div>
        <div class="life-row">
          <input class="life-input" id="lifePersonName" type="text" placeholder="Full name" maxlength="60" />
          <select class="life-select" id="lifePersonRole">
            <option value="" disabled selected>Select role</option>
            <option value="Wife">Wife</option>
            <option value="Husband">Husband</option>
            <option value="Partner">Partner</option>
            <option value="Son">Son</option>
            <option value="Daughter">Daughter</option>
            <option value="Child">Child</option>
            <option value="Mother">Mother</option>
            <option value="Father">Father</option>
            <option value="Sister">Sister</option>
            <option value="Brother">Brother</option>
            <option value="Grandmother">Grandmother</option>
            <option value="Grandfather">Grandfather</option>
            <option value="Other">Other</option>
          </select>
          <input class="life-input" id="lifePersonCustomRole" type="text" placeholder="Custom role" maxlength="40" style="display: none;" />
        </div>
        <div class="life-row">
          <input class="life-input" id="lifePersonOrg" type="text" placeholder="Job / School (optional)" maxlength="80" />
          <input class="life-input" id="lifePersonDob" type="date" />
        </div>
        <div class="life-row">
          <textarea class="life-textarea" id="lifePersonNotes" placeholder="Notes (optional)" maxlength="200"></textarea>
        </div>
        <div class="life-row">
          <button class="life-btn" id="lifePeopleSave" type="button">Save person</button>
        </div>
      </div>
      <div class="life-people-grid" id="lifePeopleList"></div>
    </div>
  </div>

  <div class="life-person-view" id="lifePersonView" aria-hidden="true">
    <div class="life-person-header">
      <button class="life-btn secondary" id="lifePersonBack" type="button">â† Life</button>
      <div class="life-person-identity">
        <div class="life-person-avatar">
          <img id="lifePersonAvatar" alt="Person avatar" />
        </div>
        <div>
          <div class="life-person-name" id="lifePersonNameDisplay"></div>
          <div class="life-person-role-pill" id="lifePersonRoleDisplay"></div>
          <div class="life-person-org" id="lifePersonOrgDisplay"></div>
        </div>
      </div>
    </div>

    <div class="life-appointments-card">
      <button class="life-appointments-toggle" id="lifeAppointmentsToggle" type="button" aria-expanded="true">
        <span>Appointments</span>
        <span class="life-chevron">â–¾</span>
      </button>
      <div class="life-appointments-body" id="lifeAppointmentsBody">
        <div class="life-appointments-actions">
          <button class="life-btn" id="lifeAppointmentsAdd" type="button">Add appointment</button>
        </div>
        <div class="life-appointments-list" id="lifeAppointmentsList"></div>
        <button class="life-appointments-past-toggle" id="lifeAppointmentsPastToggle" type="button" aria-expanded="false">Show past</button>
        <div class="life-appointments-past" id="lifeAppointmentsPast" style="display: none;"></div>
      </div>
    </div>
  </div>

  <div class="life-section" data-tab-panel="today" style="display: none;">
    <h3 class="section-subtitle">Today</h3>
    <div class="life-list" id="lifeTodayList"></div>
  </div>

  <div class="life-section" data-tab-panel="goals" style="display: none;">
    <h3 class="section-subtitle">Goals</h3>
    <div class="life-list" id="lifeGoalsList"></div>
  </div>

  <div class="life-section" data-tab-panel="tasks" style="display: none;">
    <h3 class="section-subtitle">Tasks</h3>
    <div class="life-row">
      <input class="life-input" id="lifeTaskText" type="text" placeholder="Add a task" maxlength="120" />
      <select class="life-select" id="lifeTaskArea"></select>
    </div>
    <div class="life-row">
      <input class="life-input" id="lifeTaskTags" type="text" placeholder="Tags (comma separated)" maxlength="120" />
      <input class="life-input" id="lifeTaskDue" type="date" />
    </div>
    <div class="life-row">
      <label><input type="checkbox" id="lifeTaskNeedsPeople" /> Needs other people</label>
      <label><input type="checkbox" id="lifeTaskNeedsAppt" /> Needs appointment</label>
      <select class="life-select" id="lifeTaskEnergy">
        <option value="">Energy type</option>
        <option value="admin">Admin</option>
        <option value="physical">Physical</option>
        <option value="thinking">Thinking</option>
        <option value="social">Social</option>
      </select>
    </div>
    <div class="life-row">
      <button class="life-btn" id="lifeTaskAdd" type="button">Add task</button>
      <button class="life-btn secondary" id="lifeTaskCancel" type="button" style="display: none;">Cancel edit</button>
    </div>
    <div class="life-list" id="lifeTaskList"></div>
    <div class="unstuck-panel" id="lifeUnstuckPanel" aria-live="polite"></div>
  </div>

  <div class="life-section" data-tab-panel="calendar" style="display: none;">
    <h3 class="section-subtitle">Calendar</h3>
    <p class="section-text">Use the Calendar tab in the sidebar to review all appointments.</p>
  </div>

  <div class="life-section" data-tab-panel="settings" style="display: none;">
    <h3 class="section-subtitle">Settings</h3>
    <div class="life-row">
      <label><input type="checkbox" id="lifeFrictionEnabled" /> Friction reminders</label>
    </div>
    <div class="life-row">
      <span class="life-meta">Reminder frequency</span>
      <label><input type="radio" name="lifeFrictionFrequency" value="1" /> After every video</label>
      <label><input type="radio" name="lifeFrictionFrequency" value="2" /> Every 2 videos</label>
    </div>
    <div class="life-row">
      <span class="life-meta">Pause timer</span>
      <label><input type="radio" name="lifePauseSeconds" value="30" /> 30 seconds</label>
      <label><input type="radio" name="lifePauseSeconds" value="60" /> 60 seconds</label>
      <label><input type="radio" name="lifePauseSeconds" value="120" /> 120 seconds</label>
    </div>
    <div class="life-row">
      <input class="life-input" id="lifeChildName" type="text" placeholder="Add child name" maxlength="40" />
      <button class="life-btn secondary" id="lifeAddChild" type="button">Add child</button>
    </div>
    <div class="life-list" id="lifeAreasList"></div>
  </div>

  <div class="appointment-modal" id="lifeAppointmentModal" aria-hidden="true">
    <div class="appointment-modal-backdrop" data-close></div>
    <div class="appointment-modal-card" role="dialog" aria-modal="true" aria-labelledby="lifeAppointmentModalTitle">
      <div class="appointment-modal-header">
        <h3 class="section-subtitle" id="lifeAppointmentModalTitle">Add appointment</h3>
        <button class="life-btn secondary" id="lifeAppointmentClose" type="button">Close</button>
      </div>
      <form class="appointment-form" id="lifeAppointmentForm">
        <div class="appointment-field" id="lifeAppointmentPersonRow">
          <label for="lifeAppointmentPerson">Person</label>
          <select class="life-select" id="lifeAppointmentPerson" required></select>
        </div>
        <div class="appointment-field">
          <label for="lifeAppointmentTitleInput">Title</label>
          <input class="life-input" id="lifeAppointmentTitleInput" type="text" placeholder="Appointment title" maxlength="120" required />
        </div>
        <div class="appointment-row">
          <div class="appointment-field">
            <label for="lifeAppointmentDate">Date</label>
            <input class="life-input" id="lifeAppointmentDate" type="date" required />
          </div>
          <div class="appointment-field">
            <label for="lifeAppointmentTime">Time</label>
            <input class="life-input" id="lifeAppointmentTime" type="time" required />
          </div>
        </div>
        <div class="appointment-row">
          <div class="appointment-field">
            <label for="lifeAppointmentClinic">Clinic name</label>
            <input class="life-input" id="lifeAppointmentClinic" type="text" placeholder="Clinic or facility" maxlength="120" />
          </div>
          <div class="appointment-field">
            <label for="lifeAppointmentDoctor">Doctor name</label>
            <input class="life-input" id="lifeAppointmentDoctor" type="text" placeholder="Doctor or provider" maxlength="120" />
          </div>
        </div>
        <div class="appointment-field">
          <label for="lifeAppointmentAddress">Address</label>
          <input class="life-input" id="lifeAppointmentAddress" type="text" placeholder="Street address, Suburb NSW 2000" maxlength="160" />
        </div>
        <div class="appointment-field">
          <label for="lifeAppointmentPhone">Phone number</label>
          <input class="life-input" id="lifeAppointmentPhone" type="tel" placeholder="04xx xxx xxx or 02 xxxx xxxx" maxlength="40" />
        </div>
        <div class="appointment-field">
          <label for="lifeAppointmentNotes">Notes</label>
          <textarea class="life-textarea" id="lifeAppointmentNotes" placeholder="Notes (optional)" maxlength="300"></textarea>
        </div>
        <div class="appointment-modal-actions">
          <button class="life-btn" id="lifeAppointmentSave" type="submit">Save appointment</button>
          <button class="life-btn secondary" id="lifeAppointmentDelete" type="button" style="display: none;">Delete</button>
        </div>
      </form>
    </div>
  </div>
</section>

<section id="calendar-view" class="view" aria-hidden="true">
  <div id="appointments-view">
    <div class="appointments-header">
      <div>
        <h2 class="section-title">Appointments</h2>
        <p class="section-text">Upcoming appointments across everyone in one calm feed.</p>
      </div>
      <button class="appointments-btn" id="appointmentsAddGlobal" type="button">Add appointment</button>
    </div>
    <div class="appointments-filters" id="appointmentsFilters"></div>
    <div class="appointments-feed" id="appointmentsFeed"></div>
    <button class="appointments-past-toggle" id="appointmentsPastToggle" type="button" aria-expanded="false">Show past</button>
    <div class="appointments-feed" id="appointmentsPastFeed" style="display: none;"></div>

    <div class="appointment-modal" id="appointmentsModal" aria-hidden="true">
      <div class="appointment-modal-backdrop" data-close></div>
      <div class="appointment-modal-card" role="dialog" aria-modal="true" aria-labelledby="appointmentsModalTitle">
        <div class="appointment-modal-header">
          <h3 class="section-subtitle" id="appointmentsModalTitle">Add appointment</h3>
          <button class="appointments-btn secondary" id="appointmentsModalClose" type="button">Close</button>
        </div>
        <form class="appointment-form" id="appointmentsModalForm">
          <div class="appointments-scan">
            <div class="appointments-scan-title">Scan appointment</div>
            <div class="appointments-scan-actions">
              <button class="appointments-btn secondary" id="appointmentsScanTake" type="button">Take photo</button>
              <button class="appointments-btn secondary" id="appointmentsScanUpload" type="button">Upload screenshot</button>
              <input type="file" id="appointmentsScanTakeInput" accept="image/*" capture="environment" style="display: none;" />
              <input type="file" id="appointmentsScanUploadInput" accept="image/*" style="display: none;" />
            </div>
            <div class="appointments-scan-preview" id="appointmentsScanPreview" style="display: none;">
              <img class="appointments-scan-image" id="appointmentsScanImage" alt="Appointment image preview" />
              <p class="appointments-scan-note">This image stays in the app and isnâ€™t saved unless you choose to save it.</p>
            </div>
          </div>
          <div class="appointments-parse">
            <label for="appointmentsTextInput">Paste appointment text</label>
            <textarea class="appointments-textarea" id="appointmentsTextInput" placeholder="Paste SMS or email text here" maxlength="600"></textarea>
            <div class="appointments-parse-actions">
              <button class="appointments-btn secondary" id="appointmentsParseBtn" type="button">Parse</button>
              <button class="appointments-btn" id="appointmentsAiBtn" type="button">
                <span class="appointments-ai-label">Use AI to fill</span>
                <span class="appointments-ai-dots" aria-hidden="true">
                  <span></span>
                  <span></span>
                  <span></span>
                </span>
              </button>
            </div>
            <details class="appointments-text-details" id="appointmentsOriginalDetails" style="display: none;">
              <summary>Original text</summary>
              <div class="appointments-text-preview" id="appointmentsOriginalText"></div>
            </details>
          </div>
          <div class="appointment-field">
            <label for="appointmentsModalPerson">Person</label>
            <select class="appointments-select" id="appointmentsModalPerson" required></select>
          </div>
          <div class="appointment-field">
            <label for="appointmentsModalTitleInput">Title</label>
            <input class="appointments-input" id="appointmentsModalTitleInput" type="text" placeholder="Appointment title" maxlength="120" required />
          </div>
          <div class="appointment-row">
            <div class="appointment-field">
              <label for="appointmentsModalDate">Date</label>
              <input class="appointments-input" id="appointmentsModalDate" type="date" required />
            </div>
            <div class="appointment-field">
              <label for="appointmentsModalTime">Time</label>
              <input class="appointments-input" id="appointmentsModalTime" type="time" required />
            </div>
          </div>
          <div class="appointment-row">
            <div class="appointment-field">
              <label for="appointmentsModalClinic">Clinic name</label>
              <input class="appointments-input" id="appointmentsModalClinic" type="text" placeholder="Clinic or facility" maxlength="120" />
            </div>
            <div class="appointment-field">
              <label for="appointmentsModalDoctor">Doctor name</label>
              <input class="appointments-input" id="appointmentsModalDoctor" type="text" placeholder="Doctor or provider" maxlength="120" />
            </div>
          </div>
          <div class="appointment-field">
            <label for="appointmentsModalAddress">Address</label>
            <input class="appointments-input" id="appointmentsModalAddress" type="text" placeholder="Street address, Suburb NSW 2000" maxlength="160" />
          </div>
          <div class="appointment-field">
            <label for="appointmentsModalPhone">Phone number</label>
            <input class="appointments-input" id="appointmentsModalPhone" type="tel" placeholder="04xx xxx xxx or 02 xxxx xxxx" maxlength="40" />
          </div>
          <div class="appointment-field">
            <label for="appointmentsModalNotes">Notes</label>
            <textarea class="appointments-textarea" id="appointmentsModalNotes" placeholder="Notes (optional)" maxlength="300"></textarea>
          </div>
          <div class="appointment-modal-actions">
            <button class="appointments-btn" id="appointmentsModalSave" type="submit">Save appointment</button>
            <button class="appointments-btn secondary" id="appointmentsModalDelete" type="button" style="display: none;">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<section id="calendar-import-view" class="view" aria-hidden="true">
  <div class="calendar-import-card">
    <div class="calendar-import-header">
      <h2 class="section-title">Review &amp; Save</h2>
      <p class="calendar-import-meta">Check the details from your message before adding to the family calendar.</p>
    </div>

    <div class="calendar-import-success" id="calendarImportSuccess" aria-live="polite">
      <h3>Added</h3>
      <p>Your appointment is saved.</p>
      <div class="calendar-import-actions">
        <button class="calendar-import-btn" id="calendarImportBack" type="button">Back to Calendar</button>
        <button class="calendar-import-btn secondary" id="calendarImportBackPerson" type="button" style="display: none;">Back to Person</button>
        <button class="calendar-import-btn secondary" id="calendarImportAddAnother" type="button">Add another</button>
      </div>
    </div>

    <form class="calendar-import-form" id="calendarImportForm">
      <div class="calendar-import-row">
        <select class="calendar-import-select" id="calendarImportPerson" required></select>
        <input class="calendar-import-input" id="calendarImportTitle" type="text" placeholder="Title" maxlength="120" required />
      </div>
      <div class="calendar-import-row">
        <input class="calendar-import-input" id="calendarImportDate" type="date" required />
        <label class="calendar-import-toggle">
          <input type="checkbox" id="calendarImportAllDay" />
          <span>All-day</span>
        </label>
      </div>
      <div class="calendar-import-row" id="calendarImportTimeRow">
        <input class="calendar-import-input" id="calendarImportStart" type="time" required />
        <input class="calendar-import-input" id="calendarImportEnd" type="time" placeholder="End time (optional)" />
      </div>
      <div class="calendar-import-row">
        <input class="calendar-import-input" id="calendarImportLocation" type="text" placeholder="Location (optional)" maxlength="120" />
        <button class="calendar-import-btn secondary" id="calendarImportDirections" type="button" style="display: none;">Directions</button>
      </div>
      <details class="calendar-import-notes" id="calendarImportNotesDetails">
        <summary>Notes (optional)</summary>
        <textarea class="calendar-import-textarea" id="calendarImportNotes" maxlength="400"></textarea>
      </details>
      <details class="calendar-import-notes" id="calendarImportOriginalDetails">
        <summary>Original message</summary>
        <div class="calendar-import-preview" id="calendarImportOriginal"></div>
      </details>
      <div class="calendar-import-actions">
        <button class="calendar-import-btn" id="calendarImportSave" type="submit">Save event</button>
        <button class="calendar-import-btn secondary" id="calendarImportCancel" type="button">Cancel</button>
      </div>
    </form>
  </div>
</section>

<div class="chat-input-area">
  <div class="attachment-preview" id="attachmentPreview" style="display: none;"></div>
  <div class="chat-input-wrapper">
    <input type="file" id="fileUpload" multiple accept="image/*,.txt,.js,.py,.html,.css,.json,.md,.csv,.xml" style="display: none;">
    <button class="btn-attach" id="btnAttach" type="button" aria-label="Attach file">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
      </svg>
    </button>
    <textarea class="chat-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
    <button class="btn-send" id="btnSend" type="button" aria-label="Send message">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>

  </div>

  <!-- SIDE MENU -->

  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <div class="menu-profile" id="menuProfile">
        <img class="profile-pic" id="profilePic" src="" alt="Profile" />
        <div class="profile-info">
          <span class="profile-name" id="profileName"></span>
          <span class="profile-email" id="profileEmail"></span>
        </div>
      </div>
      <button class="btn-close-menu" id="btnCloseMenu" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

<div class="menu-content">
  <button class="menu-btn-new" id="btnNewChat" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/>
      <line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    New Chat
  </button>

  <div class="menu-section">
    <div class="menu-section-title">History</div>
    <div id="chatHistoryList">
      <div class="menu-empty">No chats yet</div>
    </div>
  </div>

  <div class="menu-divider"></div>

  <div class="menu-section">
    <button class="menu-item" id="btnSettings" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
      </svg>
      <span>Settings</span>
    </button>
    <button class="menu-item" id="btnAbout" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
      <span>About</span>
    </button>
    <button class="menu-item" id="btnGoals" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 11l3 3L22 4"/>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
      </svg>
      <span>Goals</span>
    </button>
    <button class="menu-item" id="btnLife" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/>
      </svg>
      <span>Life</span>
    </button>
    <button class="menu-item" id="btnCalendar" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/>
        <line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      <span>Calendar</span>
    </button>
    <button class="menu-item" id="btnFrictionSocial" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="5" width="18" height="14" rx="2" ry="2"/>
        <polygon points="10 9 16 12 10 15 10 9"/>
      </svg>
      <span>Friction Social</span>
    </button>
    <button class="menu-item" id="btnAdmin" type="button" style="display: none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <span>Admin Dashboard</span>
    </button>
  </div>
</div>

<div class="menu-footer">
  <button class="menu-item menu-item-logout" id="btnSignOut" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
      <polyline points="16 17 21 12 16 7"/>
      <line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
    <span>Sign Out</span>
  </button>
</div>

  </div>

  <!-- FRICTION OVERLAY -->

  <div class="friction-overlay" id="frictionOverlay">
    <div class="friction-box">
      <h2 class="friction-title">Pause & reflect</h2>
      <p class="friction-subtitle">Type the code to send.</p>

  <div class="friction-goal-reminder" id="frictionGoalReminder"></div>

  <div class="friction-row" id="frictionRow1">
    <div class="friction-pair-container" id="frictionPairs1"></div>
  </div>

  <div class="friction-row" id="frictionRow2">
    <div class="friction-pair-container" id="frictionPairs2"></div>
  </div>

  <div class="friction-buttons">
    <button class="btn-cancel" id="frictionCancel" type="button">Cancel</button>
    <button class="btn-unlock" id="frictionUnlock" type="button" disabled>Send message</button>
  </div>

  <p class="friction-timer" id="frictionTimer"></p>
  <p class="friction-error" id="frictionError"></p>
</div>

  </div>

  <!-- ONBOARDING OVERLAY -->

  <div class="onboarding-overlay" id="onboardingOverlay">
    <div class="onboarding-box">

  <!-- Step 1: Welcome -->
  <div class="onboarding-step active" id="onboardingStep1">
    <div class="onboarding-icon">âœ¦</div>
    <h2 class="onboarding-title">Welcome to Friction AI</h2>
    <p class="onboarding-text">
      This app adds small moments of pause to help you use AI more intentionally.
    </p>
    <p class="onboarding-text">
      Before we start, let's set some goals. These will gently remind you of what matters most.
    </p>
    <button class="onboarding-btn primary" id="onboardingNext1" type="button">Get Started</button>
  </div>

  <!-- Step 2: Long-term Goal -->
  <div class="onboarding-step" id="onboardingStep2">
    <h2 class="onboarding-title">Your long-term goal</h2>
    <p class="onboarding-text">
      What do you want more of in your life? This will appear softly in the background as you chat.
    </p>
    <textarea 
      class="onboarding-textarea" 
      id="inputLongtermGoal" 
      placeholder="e.g., Be more present with my family, Focus on my mental health, Grow in my career..."
      maxlength="100"
    ></textarea>
    <div class="onboarding-nav">
      <button class="onboarding-btn secondary" id="onboardingBack2" type="button">Back</button>
      <button class="onboarding-btn primary" id="onboardingNext2" type="button">Next</button>
    </div>
  </div>

  <!-- Step 3: Short-term Goals -->
  <div class="onboarding-step" id="onboardingStep3">
    <h2 class="onboarding-title">Your short-term goals</h2>
    <p class="onboarding-text">
      What would you like to focus on today or this week? These will appear when you send messages.
    </p>
    <div class="shortterm-goals-list" id="shorttermGoalsList">
      <input type="text" class="shortterm-goal-input" placeholder="e.g., Study for exam" maxlength="60" />
    </div>
    <button class="onboarding-btn-add" id="addShorttermGoal" type="button">+ Add another goal</button>
    <div class="onboarding-nav">
      <button class="onboarding-btn secondary" id="onboardingBack3" type="button">Back</button>
      <button class="onboarding-btn primary" id="onboardingNext3" type="button">Finish</button>
    </div>
  </div>

  <!-- Step 4: All Set -->
  <div class="onboarding-step" id="onboardingStep4">
    <div class="onboarding-icon">ðŸŽ¯</div>
    <h2 class="onboarding-title">You're all set!</h2>
    <p class="onboarding-text">
      Your goals are saved. You can update them anytime from the menu.
    </p>
    <div class="onboarding-summary" id="onboardingSummary"></div>
    <button class="onboarding-btn primary" id="onboardingFinish" type="button">Start Chatting</button>
  </div>

</div>

  </div>

  <!-- GOAL CHECK-IN OVERLAY -->

  <div class="onboarding-overlay" id="goalCheckinOverlay">
    <div class="onboarding-box">
      <div class="onboarding-icon">ðŸ‘‹</div>
      <h2 class="onboarding-title">Quick check-in</h2>
      <p class="onboarding-text">
        It's been a little while. Have you made progress on your goals?
      </p>
      <div class="checkin-goals-list" id="checkinGoalsList"></div>
      <div class="onboarding-nav">
        <button class="onboarding-btn secondary" id="checkinSkip" type="button">Skip for now</button>
        <button class="onboarding-btn primary" id="checkinSave" type="button">Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS OVERLAY -->

  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-box">
      <div class="settings-header">
        <h2 class="settings-title">Settings</h2>
        <button class="settings-close" id="settingsClose" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

  <div class="settings-lock-banner" id="settingsLockBanner" style="display: none;">
    <span class="lock-icon">ðŸ”’</span>
    <span class="lock-text">Settings locked for <span id="lockTimeRemaining">--:--:--</span></span>
  </div>

  <div class="settings-content" id="settingsContent">
    
    <!-- Friction Mode -->
    <div class="settings-section">
      <h3 class="settings-section-title">Friction Mode</h3>
      <p class="settings-section-desc">Choose how much friction to add before sending messages</p>
      
      <label class="settings-radio">
        <input type="radio" name="frictionMode" value="off" />
        <span class="radio-label">
          <strong>Off</strong>
          <span class="radio-desc">No verification needed</span>
        </span>
      </label>
      
      <label class="settings-radio">
        <input type="radio" name="frictionMode" value="light" />
        <span class="radio-label">
          <strong>Light</strong>
          <span class="radio-desc">Goal reminder only, no typing</span>
        </span>
      </label>
      
      <label class="settings-radio">
        <input type="radio" name="frictionMode" value="full" checked />
        <span class="radio-label">
          <strong>Full</strong>
          <span class="radio-desc">Goal reminder + typing code (4-10 chars)</span>
        </span>
      </label>

      <label class="settings-radio strict-mode">
        <input type="radio" name="frictionMode" value="strict" />
        <span class="radio-label">
          <strong>âš ï¸ Strict Mode</strong>
          <span class="radio-desc">No mercy. 15 levels, up to 2 rows of 20 characters. Take no prisoners.</span>
        </span>
      </label>
      <div class="strict-warning">
        <strong>âš ï¸ For Serious Friction Only:</strong> This mode is designed for people who need maximum friction and accountability. Not recommended for casual use.
      </div>
    </div>

    <!-- Message Delay -->
    <div class="settings-section" id="messageDelaySection">
      <h3 class="settings-section-title">Message Delay</h3>
      <p class="settings-section-desc">Add a waiting period before messages send</p>
      <p class="settings-section-note" id="delayDisabledNote" style="display: none;">
        âš ï¸ Disabled when using Full or Strict friction mode
      </p>
      
      <div id="delayOptions">
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="0" checked />
          <span class="radio-label"><strong>Off</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="5" />
          <span class="radio-label"><strong>5 seconds</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="15" />
          <span class="radio-label"><strong>15 seconds</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="30" />
          <span class="radio-label"><strong>30 seconds</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="45" />
          <span class="radio-label"><strong>45 seconds</strong></span>
        </label>

        <label class="settings-checkbox">
          <input type="checkbox" id="allowCancelDelay" checked />
          <span class="checkbox-label">Allow cancel during countdown</span>
        </label>
      </div>
    </div>

    <!-- Goal Reminders -->
    <div class="settings-section">
      <h3 class="settings-section-title">Goal Reminders</h3>
      
      <label class="settings-checkbox">
        <input type="checkbox" id="showShortTermGoal" checked />
        <span class="checkbox-label">Show short-term goal in friction overlay</span>
      </label>
      
      <label class="settings-checkbox">
        <input type="checkbox" id="showLongTermGoal" checked />
        <span class="checkbox-label">Show long-term goal in chat background</span>
      </label>
    </div>

    <!-- Lock Settings -->
    <div class="settings-section settings-lock-section">
      <h3 class="settings-section-title">ðŸ”’ Lock Settings</h3>
      <p class="settings-section-desc">Prevent changes for a set period. Once locked, you cannot change settings until the timer expires.</p>
      
      <div class="lock-time-picker">
        <div class="lock-time-row">
          <label class="lock-time-label">Days</label>
          <input type="number" class="lock-time-input" id="lockDays" min="0" max="30" value="0" />
        </div>
        <div class="lock-time-row">
          <label class="lock-time-label">Hours</label>
          <input type="number" class="lock-time-input" id="lockHours" min="0" max="23" value="1" />
        </div>
        <div class="lock-time-row">
          <label class="lock-time-label">Minutes</label>
          <input type="number" class="lock-time-input" id="lockMinutes" min="0" max="59" value="0" />
        </div>
      </div>
      
      <div class="lock-presets">
        <button type="button" class="lock-preset-btn" data-hours="1">1hr</button>
        <button type="button" class="lock-preset-btn" data-hours="4">4hr</button>
        <button type="button" class="lock-preset-btn" data-hours="24">24hr</button>
        <button type="button" class="lock-preset-btn" data-days="3">3 days</button>
        <button type="button" class="lock-preset-btn" data-days="7">1 week</button>
      </div>

      <button class="settings-lock-btn" id="btnLockSettings" type="button">Lock Settings</button>
    </div>

  </div>
</div>

  </div>

  <!-- MESSAGE DELAY OVERLAY -->

  <div class="delay-overlay" id="delayOverlay">
    <div class="delay-box">
      <div class="delay-countdown" id="delayCountdown">
        <svg class="delay-ring" viewBox="0 0 100 100">
          <circle class="delay-ring-bg" cx="50" cy="50" r="45" />
          <circle class="delay-ring-progress" id="delayRingProgress" cx="50" cy="50" r="45" />
        </svg>
        <span class="delay-time" id="delayTime">5</span>
      </div>
      <p class="delay-text">Sending...</p>
      <p class="delay-hint" id="delayHint">While you wait, you could start on your goal</p>
      <button class="delay-cancel" id="delayCancelBtn" type="button">Cancel</button>
    </div>
  </div>

  <script>
    // STATE
    let state = {
      messages: [],
      pendingMessage: null,
      isProcessing: false,
      currentModel: 'claude',
      currentChatId: null
    };

    // CHAT PERSISTENCE
    function saveChatState() {
      const chatState = {
        messages: state.messages,
        currentModel: state.currentModel,
        currentChatId: state.currentChatId
      };
      localStorage.setItem('friction_chat', JSON.stringify(chatState));
      localStorage.setItem('friction_last_activity', Date.now().toString());

      // Also save to history
      saveCurrentChatToHistory();

      // Sync to server (debounced)
      saveUserDataToServer();
    }

    function loadChatState() {
      const saved = localStorage.getItem('friction_chat');
      if (saved) {
        try {
          const chatState = JSON.parse(saved);
          state.messages = chatState.messages || [];
          state.currentModel = chatState.currentModel || 'claude';
          state.currentChatId = chatState.currentChatId || null;
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function clearChatState() {
      state.messages = [];
      state.currentChatId = null;
      localStorage.removeItem('friction_chat');
    }

    // GOALS MANAGEMENT
    let goals = {
      longterm: '',
      shortterm: [],
      onboardingComplete: false,
      lastGoalCheck: null,
      lastGoalTick: null
    };

    function loadGoals() {
      var saved = localStorage.getItem('friction_goals');
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          goals = Object.assign(goals, parsed);
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function saveGoals() {
      localStorage.setItem('friction_goals', JSON.stringify(goals));
      // Sync to server (debounced)
      saveUserDataToServer();
    }

    function getActiveShortTermGoal() {
      var active = goals.shortterm.filter(function(g) { return !g.completed; });
      return active.length > 0 ? active[0] : null;
    }

    function shouldShowOnboarding() {
      return !goals.onboardingComplete;
    }

    function shouldShowGoalCheckin() {
      if (!goals.onboardingComplete) return false;
      if (goals.shortterm.length === 0) return false;
      
      // Check if all goals completed
      var allComplete = goals.shortterm.every(function(g) { return g.completed; });
      if (allComplete) return true;
      
      // Check if 72 hours since last tick
      if (goals.lastGoalTick) {
        var hoursSinceTick = (Date.now() - goals.lastGoalTick) / (1000 * 60 * 60);
        if (hoursSinceTick >= 72) return true;
      }
      
      return false;
    }

    function showOnboarding() {
      document.getElementById('onboardingOverlay').classList.add('active');
      document.getElementById('onboardingStep1').classList.add('active');
    }

    function hideOnboarding() {
      document.getElementById('onboardingOverlay').classList.remove('active');
    }

    function showGoalCheckin() {
      var overlay = document.getElementById('goalCheckinOverlay');
      var list = document.getElementById('checkinGoalsList');
      list.innerHTML = '';
      
      goals.shortterm.forEach(function(goal, index) {
        var item = document.createElement('div');
        item.className = 'checkin-goal-item';
        
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkin-goal-checkbox';
        checkbox.checked = goal.completed;
        checkbox.dataset.index = index;
        checkbox.addEventListener('change', function() {
          goals.shortterm[index].completed = this.checked;
          text.classList.toggle('completed', this.checked);
        });
        
        var text = document.createElement('span');
        text.className = 'checkin-goal-text';
        if (goal.completed) text.classList.add('completed');
        text.textContent = goal.text;
        
        item.appendChild(checkbox);
        item.appendChild(text);
        list.appendChild(item);
      });
      
      overlay.classList.add('active');
    }

    function hideGoalCheckin() {
      document.getElementById('goalCheckinOverlay').classList.remove('active');
    }

    function updateBackgroundGoal() {
      var bgGoal = document.getElementById('chatBackgroundGoal');
      if (!bgGoal) return;
      
      if (!goals.longterm || !settings.showLongTermGoal) {
        bgGoal.style.opacity = '0';
        return;
      }
      
      bgGoal.textContent = '"' + goals.longterm + '"';
      
      // Calculate opacity based on message count (caps at 0.15)
      var messageCount = state.messages.filter(function(m) { return m.role === 'user'; }).length;
      var opacity = Math.min(messageCount * 0.03, 0.15);
      bgGoal.style.opacity = opacity.toString();
    }

    // LIFE AREAS
    var LIFE_AREAS_KEY = 'friction_life_areas_v1';
    var lifeAreas = [];

    function generateLifeAreaId() {
      return 'area_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function buildDefaultLifeAreas() {
      var now = Date.now();
      return [
        { id: generateLifeAreaId(), name: 'Me', type: 'me', createdAt: now },
        { id: generateLifeAreaId(), name: 'Work', type: 'work', createdAt: now },
        { id: generateLifeAreaId(), name: 'Family', type: 'family', createdAt: now }
      ];
    }

    function normalizeLifeAreas(items) {
      if (!Array.isArray(items)) return [];
      return items.map(function(area) {
        if (!area || typeof area !== 'object') return null;
        return {
          id: area.id || generateLifeAreaId(),
          name: area.name || 'Me',
          type: area.type || 'me',
          createdAt: area.createdAt || Date.now()
        };
      }).filter(Boolean);
    }

    function ensureDefaultLifeAreas(items) {
      var areas = normalizeLifeAreas(items);
      var hasMe = areas.some(function(area) { return area.type === 'me'; });
      var hasWork = areas.some(function(area) { return area.type === 'work'; });
      var hasFamily = areas.some(function(area) { return area.type === 'family'; });
      if (!hasMe || !hasWork || !hasFamily) {
        var defaults = buildDefaultLifeAreas();
        if (!hasMe) areas.push(defaults[0]);
        if (!hasWork) areas.push(defaults[1]);
        if (!hasFamily) areas.push(defaults[2]);
      }
      return areas;
    }

    function loadLifeAreas() {
      var saved = localStorage.getItem(LIFE_AREAS_KEY);
      if (saved) {
        try {
          lifeAreas = ensureDefaultLifeAreas(JSON.parse(saved));
          return;
        } catch (e) {
          lifeAreas = buildDefaultLifeAreas();
        }
      } else {
        lifeAreas = buildDefaultLifeAreas();
      }
      saveLifeAreas();
    }

    function saveLifeAreas() {
      localStorage.setItem(LIFE_AREAS_KEY, JSON.stringify(lifeAreas));
    }

    function getDefaultAreaId() {
      if (!lifeAreas.length) return '';
      var me = lifeAreas.find(function(area) { return area.type === 'me'; });
      return me ? me.id : lifeAreas[0].id;
    }

    function getAreaById(areaId) {
      return lifeAreas.find(function(area) { return area.id === areaId; }) || null;
    }

    function getAreaLabel(areaId) {
      var area = getAreaById(areaId);
      return area ? area.name : 'Me';
    }

    function getAreaOwnerName(areaId) {
      var area = getAreaById(areaId);
      if (!area) return '';
      if (area.type === 'child') {
        return area.name.replace(/^Child:\s*/i, '').trim();
      }
      return '';
    }

    function buildAreaOptions(includeAll) {
      var options = [];
      if (includeAll) {
        options.push({ id: 'all', name: 'All' });
      }
      lifeAreas.forEach(function(area) {
        options.push({ id: area.id, name: area.name });
      });
      return options;
    }

    function renderAreaSelect(selectEl, includeAll, selectedId) {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      var options = buildAreaOptions(includeAll);
      options.forEach(function(option) {
        var opt = document.createElement('option');
        opt.value = option.id;
        opt.textContent = option.name;
        selectEl.appendChild(opt);
      });
      if (selectedId) {
        selectEl.value = selectedId;
      }
    }

    // PEOPLE OVERVIEW
    var PEOPLE_KEY = 'friction_people_v1';
    var PEOPLE_ROLE_OPTIONS = ['Wife', 'Husband', 'Partner', 'Son', 'Daughter', 'Child', 'Mother', 'Father', 'Sister', 'Brother', 'Grandmother', 'Grandfather', 'Other'];
    var people = [];
    var editingPersonId = null;
    var pendingAvatarType = 'generated';
    var pendingAvatarDataUrl = '';
    var pendingAvatarSeed = '';
    var activePersonId = null;

    function normalizeName(value) {
      return String(value || '').trim().toLowerCase().replace(/\s+/g, ' ');
    }

    function getAccountHolderKey() {
      if (currentUser && currentUser.name) {
        return normalizeName(currentUser.name);
      }
      if (profileName && profileName.textContent) {
        return normalizeName(profileName.textContent);
      }
      return '';
    }

    function isPersonAccountHolder(person) {
      if (!person) return false;
      if (person.type === 'me') return true;
      if (person.isAccountHolder) return true;
      var holderKey = getAccountHolderKey();
      if (!holderKey) return false;
      return normalizeName(person.name) === holderKey;
    }

    function reconcileAccountHolderFlags() {
      var holderKey = getAccountHolderKey();
      if (!holderKey) return;
      var updated = false;
      if (people.some(function(person) { return person.isAccountHolder || person.type === 'me'; })) {
        return;
      }
      people.forEach(function(person) {
        var matches = normalizeName(person.name) === holderKey;
        if (matches && !person.isAccountHolder) {
          person.isAccountHolder = true;
          updated = true;
        }
      });
      if (updated) savePeople();
    }

    function generatePersonId() {
      return 'person_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function hashString(value) {
      var hash = 0;
      if (!value) return hash;
      for (var i = 0; i < value.length; i++) {
        hash = (hash << 5) - hash + value.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function getInitials(name) {
      if (!name) return 'P';
      var parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return 'P';
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
    }

    function buildAvatarSvg(seed, name) {
      var palette = [
        ['#5A9A94', '#DDF1EE'],
        ['#3E6B99', '#D9E7F5'],
        ['#7C5C8A', '#EFE2F3'],
        ['#C77D4A', '#F7E6D8'],
        ['#4C7C5B', '#E1F2E6']
      ];
      var hash = hashString(seed || name || 'seed');
      var colors = palette[hash % palette.length];
      var initials = getInitials(name);
      var svg = ''
        + '<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160">'
        + '<defs>'
        + '<linearGradient id="g" x1="0" y1="0" x2="1" y2="1">'
        + '<stop offset="0%" stop-color="' + colors[0] + '"/>'
        + '<stop offset="100%" stop-color="' + colors[1] + '"/>'
        + '</linearGradient>'
        + '</defs>'
        + '<rect width="160" height="160" rx="32" fill="url(#g)"/>'
        + '<text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="56" font-family="Arial, sans-serif" fill="#fff" font-weight="600">'
        + initials
        + '</text>'
        + '</svg>';
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function getAvatarDataUrl(person) {
      if (person.avatarType === 'photo' && person.avatarDataUrl) {
        return person.avatarDataUrl;
      }
      var seed = person.avatarSeed || person.name || person.id || 'seed';
      return buildAvatarSvg(seed, person.name);
    }

    function normalizePersonRole(role, customRole) {
      if (!role) {
        return { role: 'Other', customRole: customRole || '' };
      }
      var match = PEOPLE_ROLE_OPTIONS.find(function(option) {
        return option.toLowerCase() === String(role).toLowerCase();
      });
      if (match && match !== 'Other') {
        return { role: match, customRole: '' };
      }
      if (match === 'Other') {
        return { role: 'Other', customRole: customRole || '' };
      }
      return { role: 'Other', customRole: String(role) };
    }

    function getPersonRoleLabel(person) {
      if (!person) return '';
      if (person.role === 'Other') {
        return person.customRole || 'Other';
      }
      return person.role || '';
    }

    function normalizePerson(person) {
      if (!person || typeof person !== 'object') return null;
      var id = person.id || generatePersonId();
      var seed = person.avatarSeed || person.name || id;
      var normalizedRole = normalizePersonRole(person.role, person.customRole);
      return {
        id: id,
        name: person.name || 'Unnamed',
        role: normalizedRole.role,
        customRole: normalizedRole.customRole,
        org: person.org || '',
        dob: person.dob || '',
        notes: person.notes || '',
        isAccountHolder: Boolean(person.isAccountHolder),
        type: person.type || '',
        avatarType: person.avatarType === 'photo' ? 'photo' : 'generated',
        avatarDataUrl: person.avatarDataUrl || '',
        avatarSeed: seed,
        createdAt: person.createdAt || Date.now(),
        updatedAt: person.updatedAt || person.createdAt || Date.now()
      };
    }

    function ensureAccountHolderPerson() {
      var hasHolder = people.some(function(person) {
        return person && (person.isAccountHolder || person.type === 'me');
      });
      if (hasHolder) {
        var updated = false;
        people.forEach(function(person) {
          if (person && person.type === 'me' && !person.isAccountHolder) {
            person.isAccountHolder = true;
            updated = true;
          }
        });
        if (updated) savePeople();
        return;
      }
      var now = Date.now();
      var mePerson = normalizePerson({
        id: 'me',
        name: 'Me',
        role: 'Other',
        customRole: 'Me',
        avatarType: 'generated',
        avatarSeed: 'account-holder',
        isAccountHolder: true,
        type: 'me',
        createdAt: now,
        updatedAt: now
      });
      people.unshift(mePerson);
      savePeople();
    }

    function loadPeople() {
      var saved = localStorage.getItem(PEOPLE_KEY);
      if (!saved) {
        people = [];
        ensureAccountHolderPerson();
        return;
      }
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) {
          people = [];
          ensureAccountHolderPerson();
          return;
        }
        people = parsed.map(normalizePerson).filter(Boolean);
        reconcileAccountHolderFlags();
        ensureAccountHolderPerson();
      } catch (e) {
        people = [];
        ensureAccountHolderPerson();
      }
    }

    function savePeople() {
      localStorage.setItem(PEOPLE_KEY, JSON.stringify(people));
    }

    function formatDob(dob) {
      if (!dob) return '';
      var date = new Date(dob);
      if (Number.isNaN(date.getTime())) return dob;
      return date.toLocaleDateString();
    }

    function setPeopleFormVisible(isVisible) {
      if (!lifePeopleForm) return;
      lifePeopleForm.classList.toggle('active', isVisible);
    }

    function resetPeopleForm() {
      editingPersonId = null;
      pendingAvatarType = 'generated';
      pendingAvatarDataUrl = '';
      pendingAvatarSeed = generatePersonId();
      if (lifePeopleFormTitle) lifePeopleFormTitle.textContent = 'Add person';
      if (lifePersonName) lifePersonName.value = '';
      if (lifePersonRole) lifePersonRole.value = '';
      if (lifePersonCustomRole) {
        lifePersonCustomRole.value = '';
        lifePersonCustomRole.style.display = 'none';
      }
      if (lifePersonOrg) lifePersonOrg.value = '';
      if (lifePersonDob) lifePersonDob.value = '';
      if (lifePersonNotes) lifePersonNotes.value = '';
      if (lifeAvatarUpload) lifeAvatarUpload.value = '';
      if (lifeAvatarHint) lifeAvatarHint.textContent = 'Photo uploads are stored only on this device.';
      updateAvatarPreview();
    }

    function updateAvatarPreview() {
      if (!lifeAvatarPreview) return;
      var name = lifePersonName ? lifePersonName.value.trim() : '';
      var dataUrl = pendingAvatarType === 'photo' && pendingAvatarDataUrl
        ? pendingAvatarDataUrl
        : buildAvatarSvg(pendingAvatarSeed || name || 'seed', name);
      lifeAvatarPreview.src = dataUrl;
    }

    function updateCustomRoleVisibility() {
      if (!lifePersonRole || !lifePersonCustomRole) return;
      if (lifePersonRole.value === 'Other') {
        lifePersonCustomRole.style.display = '';
      } else {
        lifePersonCustomRole.style.display = 'none';
        lifePersonCustomRole.value = '';
      }
    }

    function openPeopleForm(person) {
      setPeopleFormVisible(true);
      if (!person) {
        resetPeopleForm();
        if (lifePersonName) lifePersonName.focus();
        return;
      }
      editingPersonId = person.id;
      pendingAvatarType = person.avatarType || 'generated';
      pendingAvatarDataUrl = person.avatarDataUrl || '';
      pendingAvatarSeed = person.avatarSeed || person.name || person.id;
      if (lifePeopleFormTitle) lifePeopleFormTitle.textContent = 'Edit person';
      if (lifePersonName) lifePersonName.value = person.name || '';
      if (lifePersonRole) lifePersonRole.value = person.role || '';
      if (lifePersonCustomRole) {
        lifePersonCustomRole.value = person.customRole || '';
        lifePersonCustomRole.style.display = person.role === 'Other' ? '' : 'none';
      }
      if (lifePersonOrg) lifePersonOrg.value = person.org || '';
      if (lifePersonDob) lifePersonDob.value = person.dob || '';
      if (lifePersonNotes) lifePersonNotes.value = person.notes || '';
      updateAvatarPreview();
      if (lifePersonName) lifePersonName.focus();
    }

    function getFamilyPeople() {
      var updated = false;
      var family = people.slice();
      family.forEach(function(person) {
        var isHolder = person && (person.type === 'me' || isPersonAccountHolder(person));
        if (isHolder && !person.isAccountHolder) {
          person.isAccountHolder = true;
          person.type = person.type || 'me';
          updated = true;
        }
      });
      family.sort(function(a, b) {
        var aHolder = a && (a.type === 'me' || a.isAccountHolder);
        var bHolder = b && (b.type === 'me' || b.isAccountHolder);
        if (aHolder && !bHolder) return -1;
        if (!aHolder && bHolder) return 1;
        return String(a.name || '').localeCompare(String(b.name || ''));
      });
      if (updated) {
        savePeople();
      }
      return family;
    }

    function renderPeopleOverview() {
      if (!lifePeopleList) return;
      lifePeopleList.innerHTML = '';
      var familyPeople = getFamilyPeople();
      if (!familyPeople.length) {
        var empty = document.createElement('div');
        empty.className = 'life-people-empty';
        empty.innerHTML = '<strong>No people added yet.</strong><span>Start with the people who matter most.</span>';
        var cta = document.createElement('button');
        cta.type = 'button';
        cta.className = 'life-btn';
        cta.textContent = 'Add your first person';
        cta.addEventListener('click', function() {
          openPeopleForm();
        });
        empty.appendChild(cta);
        lifePeopleList.appendChild(empty);
        if (typeof renderCalendarPeopleOptions === 'function') {
          renderCalendarPeopleOptions();
        }
        return;
      }
      familyPeople.forEach(function(person) {
        var card = document.createElement('div');
        card.className = 'life-person-card';
        card.tabIndex = 0;
        card.setAttribute('role', 'button');
        var isMe = person.type === 'me' || person.isAccountHolder;

        var top = document.createElement('div');
        top.className = 'life-person-top';

        var avatarWrap = document.createElement('div');
        avatarWrap.className = 'life-avatar-preview';
        var avatarImg = document.createElement('img');
        avatarImg.alt = person.name || 'Person';
        avatarImg.src = getAvatarDataUrl(person);
        avatarWrap.appendChild(avatarImg);

        var meta = document.createElement('div');
        meta.className = 'life-person-meta';
        var name = document.createElement('div');
        name.className = 'life-person-name';
        name.textContent = person.name || 'Unnamed';
        var role = document.createElement('span');
        role.className = 'life-person-role';
        role.textContent = getPersonRoleLabel(person) || 'Other';
        meta.appendChild(name);
        meta.appendChild(role);

        top.appendChild(avatarWrap);
        top.appendChild(meta);

        var org = document.createElement('div');
        org.className = 'life-meta';
        org.textContent = person.org ? person.org : '';

        var dob = document.createElement('div');
        dob.className = 'life-meta';
        dob.textContent = person.dob ? 'DOB: ' + formatDob(person.dob) : '';

        var actions = document.createElement('div');
        actions.className = 'life-person-actions';

        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'life-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          openPeopleForm(person);
        });

        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'life-btn secondary';
        removeBtn.textContent = 'Remove';
        removeBtn.disabled = isMe;
        removeBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          if (isMe) return;
          var confirmRemove = window.confirm('Remove ' + (person.name || 'this person') + '?');
          if (!confirmRemove) return;
          people = people.filter(function(item) { return item.id !== person.id; });
          savePeople();
          renderPeopleOverview();
        });

        actions.appendChild(editBtn);
        actions.appendChild(removeBtn);

        card.appendChild(top);
        if (person.org) card.appendChild(org);
        if (person.dob) card.appendChild(dob);
        card.appendChild(actions);

        card.addEventListener('click', function(event) {
          if (event.target.closest('button')) return;
          openPersonView(person);
        });

        card.addEventListener('keydown', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            openPersonView(person);
          }
        });

        lifePeopleList.appendChild(card);
      });

      if (typeof renderCalendarPeopleOptions === 'function') {
        renderCalendarPeopleOptions();
      }
      renderAppointmentsFilters();
      renderAppointmentsView();
    }

    function setPersonViewActive(isActive) {
      if (lifeView) {
        lifeView.classList.toggle('person-view-active', isActive);
      }
      if (lifePersonView) {
        lifePersonView.setAttribute('aria-hidden', isActive ? 'false' : 'true');
      }
      if (!isActive) {
        activePersonId = null;
      }
    }

    function renderPersonRightNow(personId) {
      if (!lifePersonNowList) return;
      lifePersonNowList.innerHTML = '';
      var items = [];
      goalsShort.forEach(function(goal) {
        if (goal.personId === personId && !goal.done) {
          items.push({ type: 'goal', text: goal.text, meta: 'Short-term goal', createdAt: goal.createdAt || 0 });
        }
      });
      tasks.forEach(function(task) {
        if (task.personId === personId && !task.done) {
          items.push({ type: 'task', text: task.text, meta: formatTaskMeta(task), createdAt: task.createdAt || 0 });
        }
      });
      items.sort(function(a, b) { return b.createdAt - a.createdAt; });
      var topItems = items.slice(0, 5);
      if (!topItems.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No active goals or tasks yet.';
        lifePersonNowList.appendChild(empty);
        return;
      }
      topItems.forEach(function(item) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = item.text || 'Untitled';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = item.meta || (item.type === 'goal' ? 'Short-term goal' : 'Task');
        row.appendChild(title);
        row.appendChild(meta);
        lifePersonNowList.appendChild(row);
      });
    }

    function renderPersonComingUp(personId) {
      if (!lifePersonComingList) return;
      lifePersonComingList.innerHTML = '';
      var now = Date.now();
      var upcoming = [];
      appointments.forEach(function(appt) {
        if (appt.personId !== personId || !appt.dateTimeStart) return;
        var time = new Date(appt.dateTimeStart).getTime();
        if (!Number.isNaN(time) && time < now) return;
        upcoming.push({
          type: 'appointment',
          title: appt.title || 'Untitled appointment',
          dateTime: new Date(appt.dateTimeStart),
          location: appt.location || ''
        });
      });
      calendarEvents.forEach(function(event) {
        if (event.personId !== personId || !event.date) return;
        var timeValue = event.startTime || '00:00';
        var dateTime = new Date(event.date + 'T' + timeValue);
        if (Number.isNaN(dateTime.getTime())) return;
        if (dateTime.getTime() < now) return;
        upcoming.push({
          type: 'calendar',
          title: event.title || 'Untitled event',
          dateTime: dateTime,
          location: event.location || '',
          allDay: !!event.allDay
        });
      });
      upcoming.sort(function(a, b) {
        return a.dateTime - b.dateTime;
      });
      if (!upcoming.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No upcoming appointments yet.';
        lifePersonComingList.appendChild(empty);
        return;
      }
      upcoming.slice(0, 5).forEach(function(appt) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = appt.title || 'Untitled appointment';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var timeLabel = appt.dateTime ? appt.dateTime.toLocaleString() : '';
        if (appt.allDay) {
          timeLabel = appt.dateTime ? appt.dateTime.toLocaleDateString() + ' (All day)' : 'All day';
        }
        meta.textContent = [timeLabel, appt.location].filter(Boolean).join(' Â· ');
        row.appendChild(title);
        if (meta.textContent) row.appendChild(meta);
        lifePersonComingList.appendChild(row);
      });
    }

    function renderPersonParked(personId) {
      if (!lifePersonParkedList) return;
      lifePersonParkedList.innerHTML = '';
      var parkedGoals = goalsLong.filter(function(goal) {
        return goal.personId === personId;
      });
      if (!parkedGoals.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No parked long-term goals yet.';
        lifePersonParkedList.appendChild(empty);
        return;
      }
      parkedGoals.forEach(function(goal) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = goal.title || 'Untitled goal';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = goal.targetDate ? 'Target ' + goal.targetDate : 'Long-term goal';
        row.appendChild(title);
        row.appendChild(meta);
        if (goal.note) {
          var note = document.createElement('div');
          note.className = 'life-meta';
          note.textContent = goal.note;
          row.appendChild(note);
        }
        lifePersonParkedList.appendChild(row);
      });
    }

    var lifeAgendaRangeDays = 7;

    function formatAgendaDayHeader(date) {
      var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var label = weekdays[date.getDay()] + ' ' + padNumber(date.getDate()) + ' ' + months[date.getMonth()];
      return label.toUpperCase();
    }

    function formatAgendaTimeLabel(value) {
      if (!value) return '';
      var parts = value.split(':');
      if (parts.length < 2) return value;
      var hour = parseInt(parts[0], 10);
      var minute = parts[1];
      if (Number.isNaN(hour)) return value;
      var meridiem = hour >= 12 ? 'PM' : 'AM';
      var hour12 = hour % 12;
      if (hour12 === 0) hour12 = 12;
      return hour12 + ':' + minute + meridiem;
    }

    function buildAgendaTimeRange(event) {
      if (!event) return '';
      if (event.allDay) return 'all-day';
      if (!event.startTime) return '';
      var startLabel = formatAgendaTimeLabel(event.startTime);
      if (event.endTime) {
        return startLabel + 'â€“' + formatAgendaTimeLabel(event.endTime);
      }
      return startLabel;
    }

    function buildAgendaOccurrences(personId, startDate, days) {
      var occurrences = {};
      for (var i = 0; i < days; i++) {
        var date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        occurrences[toYmd(date)] = [];
      }
      calendarEvents.forEach(function(event) {
        if (!event || event.personId !== personId || !event.date) return;
        var eventStart = parseYmd(event.date);
        if (!eventStart) return;
        var recurrence = event.recurrence || { type: 'none' };
        if (recurrence.type === 'none') {
          var ymd = toYmd(eventStart);
          if (occurrences[ymd]) {
            occurrences[ymd].push(event);
          }
          return;
        }
        for (var i = 0; i < days; i++) {
          var date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          if (date.getTime() < eventStart.getTime()) continue;
          if (!isWithinUntil(date, recurrence.until)) continue;
          var diffDays = Math.floor((date.getTime() - eventStart.getTime()) / 86400000);
          var ymdKey = toYmd(date);
          if (!occurrences[ymdKey]) continue;
          if (recurrence.type === 'weekly' && diffDays % 7 === 0) {
            occurrences[ymdKey].push(event);
          }
          if (recurrence.type === 'fortnightly' && diffDays % 14 === 0) {
            occurrences[ymdKey].push(event);
          }
          if (recurrence.type === 'custom_weekdays') {
            var weekdays = Array.isArray(recurrence.weekdays) ? recurrence.weekdays : [];
            if (weekdays.includes(date.getDay())) {
              occurrences[ymdKey].push(event);
            }
          }
        }
      });
      Object.keys(occurrences).forEach(function(key) {
        occurrences[key].sort(function(a, b) {
          if (!!a.allDay !== !!b.allDay) {
            return a.allDay ? -1 : 1;
          }
          return String(a.startTime || '').localeCompare(String(b.startTime || ''));
        });
      });
      return occurrences;
    }

    function setAgendaRange(days) {
      lifeAgendaRangeDays = days;
      if (lifeAgendaRange) {
        lifeAgendaRange.querySelectorAll('.life-agenda-segment').forEach(function(button) {
          button.classList.toggle('active', parseInt(button.dataset.range, 10) === days || (days === 1 && button.dataset.range === 'today'));
        });
      }
      if (activePersonId) {
        renderPersonAgenda(activePersonId);
      }
    }

    function renderPersonAgenda(personId) {
      if (!lifeAgendaList) return;
      lifeAgendaList.innerHTML = '';
      if (!personId) return;
      var startDate = new Date();
      startDate.setHours(0, 0, 0, 0);
      var rangeDays = lifeAgendaRangeDays;
      var occurrences = buildAgendaOccurrences(personId, startDate, rangeDays);
      var todayKey = toYmd(startDate);
      var todayEvents = occurrences[todayKey] || [];

      function appendDay(date, events, isToday) {
        var dayWrapper = document.createElement('div');
        dayWrapper.className = 'life-agenda-day';
        var header = document.createElement('div');
        header.className = 'life-agenda-day-header';
        header.textContent = formatAgendaDayHeader(date);
        dayWrapper.appendChild(header);
        if (!events.length && isToday) {
          var empty = document.createElement('div');
          empty.className = 'life-agenda-empty';
          empty.textContent = 'No Events Today';
          dayWrapper.appendChild(empty);
        } else {
          events.forEach(function(event) {
            var row = document.createElement('div');
            row.className = 'life-agenda-item';
            var accent = document.createElement('div');
            accent.className = 'life-agenda-accent';
            var details = document.createElement('div');
            var title = document.createElement('div');
            title.className = 'life-agenda-title';
            title.textContent = event.title || 'Untitled event';
            details.appendChild(title);
            if (event.location) {
              var location = document.createElement('div');
              location.className = 'life-agenda-location';
              location.textContent = event.location;
              details.appendChild(location);
              var actions = document.createElement('div');
              actions.className = 'life-agenda-actions';
              var directionsBtn = document.createElement('button');
              directionsBtn.type = 'button';
              directionsBtn.className = 'life-agenda-direction';
              directionsBtn.textContent = 'Directions';
              directionsBtn.addEventListener('click', function(ev) {
                ev.stopPropagation();
                window.open(buildDirectionsUrl(event.location), '_blank');
              });
              actions.appendChild(directionsBtn);
              details.appendChild(actions);
            }
            var time = document.createElement('div');
            time.className = 'life-agenda-time';
            time.textContent = buildAgendaTimeRange(event);
            row.appendChild(accent);
            row.appendChild(details);
            row.appendChild(time);
            row.addEventListener('click', function() {
              openEventModal(event, toYmd(date), { lockPersonId: personId });
            });
            dayWrapper.appendChild(row);
          });
        }
        lifeAgendaList.appendChild(dayWrapper);
      }

      if (!todayEvents.length) {
        appendDay(new Date(startDate), [], true);
      }

      for (var i = 0; i < rangeDays; i++) {
        var date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        var key = toYmd(date);
        var events = occurrences[key] || [];
        if (!events.length) {
          continue;
        }
        appendDay(date, events, key === todayKey);
      }
    }

    function openPersonView(person) {
      if (!person) return;
      activePersonId = person.id;
      if (lifePersonNameDisplay) lifePersonNameDisplay.textContent = person.name || 'Unnamed';
      if (lifePersonRoleDisplay) lifePersonRoleDisplay.textContent = getPersonRoleLabel(person) || 'Other';
      if (lifePersonOrgDisplay) {
        lifePersonOrgDisplay.textContent = person.org || '';
        lifePersonOrgDisplay.style.display = person.org ? '' : 'none';
      }
      if (lifePersonAvatar) {
        lifePersonAvatar.src = getAvatarDataUrl(person);
        lifePersonAvatar.alt = person.name || 'Person';
      }
      setPersonViewActive(true);
      lifeAppointmentsPastExpanded = false;
      if (lifeAppointmentsBody) {
        lifeAppointmentsBody.classList.remove('is-collapsed');
      }
      if (lifeAppointmentsToggle) {
        lifeAppointmentsToggle.setAttribute('aria-expanded', 'true');
      }
      renderPersonAppointments(person.id);
    }

    function createImageThumbnail(file) {
      return new Promise(function(resolve, reject) {
        if (!file) {
          reject(new Error('No file'));
          return;
        }
        if (file.size > 4 * 1024 * 1024) {
          reject(new Error('File too large'));
          return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
          var img = new Image();
          img.onload = function() {
            var maxSize = 256;
            var width = img.width;
            var height = img.height;
            if (width > height && width > maxSize) {
              height = Math.round(height * (maxSize / width));
              width = maxSize;
            } else if (height > maxSize) {
              width = Math.round(width * (maxSize / height));
              height = maxSize;
            }
            var canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            resolve(dataUrl);
          };
          img.onerror = function() {
            reject(new Error('Image load failed'));
          };
          img.src = e.target.result;
        };
        reader.onerror = function() {
          reject(new Error('File read failed'));
        };
        reader.readAsDataURL(file);
      });
    }

    // FAMILY CALENDAR (PHASE 1)
    var CALENDAR_EVENTS_KEY = 'friction_calendar_events_v1';
    var calendarEvents = [];
    var calendarCursor = new Date();
    var calendarSelectedDate = null;
    var calendarEditingEventId = null;
    var calendarOccurrences = {};
    var calendarReturnToDay = false;
    var calendarLockedPersonId = null;

    function padNumber(value) {
      return value < 10 ? '0' + value : String(value);
    }

    function toYmd(date) {
      if (!(date instanceof Date)) return '';
      return [date.getFullYear(), padNumber(date.getMonth() + 1), padNumber(date.getDate())].join('-');
    }

    function parseYmd(value) {
      if (!value) return null;
      var parts = value.split('-').map(function(part) { return parseInt(part, 10); });
      if (parts.length !== 3 || parts.some(function(part) { return Number.isNaN(part); })) return null;
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function getMonthLabel(date) {
      if (!date) return '';
      return date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
    }

    function formatTimeRange(event) {
      if (!event) return '';
      if (event.allDay) return 'All day';
      if (!event.startTime) return '';
      if (event.endTime) {
        return event.startTime + 'â€“' + event.endTime;
      }
      return event.startTime;
    }

    function buildDirectionsUrl(location) {
      if (!location) return '';
      var encoded = encodeURIComponent(location);
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      return isIOS
        ? 'https://maps.apple.com/?q=' + encoded
        : 'https://www.google.com/maps/search/?api=1&query=' + encoded;
    }

    function normalizeCalendarEvent(event) {
      if (!event || typeof event !== 'object') return null;
      var recurrence = event.recurrence || {};
      var type = recurrence.type || 'none';
      if (!['none', 'weekly', 'fortnightly', 'custom_weekdays'].includes(type)) {
        type = 'none';
      }
      var normalized = {
        id: event.id || 'event_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36),
        personId: event.personId || '',
        title: event.title || '',
        date: event.date || '',
        startTime: event.startTime || '',
        endTime: event.endTime || '',
        location: event.location || '',
        notes: event.notes || '',
        allDay: !!event.allDay,
        recurrence: {
          type: type,
          weekdays: Array.isArray(recurrence.weekdays) ? recurrence.weekdays.slice() : [],
          until: recurrence.until || ''
        },
        createdAt: event.createdAt || Date.now(),
        updatedAt: event.updatedAt || event.createdAt || Date.now()
      };
      if (type !== 'custom_weekdays') {
        delete normalized.recurrence.weekdays;
        delete normalized.recurrence.until;
      }
      return normalized;
    }

    function loadCalendarEvents() {
      var saved = localStorage.getItem(CALENDAR_EVENTS_KEY);
      if (!saved) {
        calendarEvents = [];
        return;
      }
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) {
          calendarEvents = [];
          return;
        }
        calendarEvents = parsed.map(normalizeCalendarEvent).filter(Boolean);
      } catch (e) {
        calendarEvents = [];
      }
    }

    function saveCalendarEvents() {
      localStorage.setItem(CALENDAR_EVENTS_KEY, JSON.stringify(calendarEvents));
    }

    function getMonthDays(year, month) {
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var days = [];
      for (var day = 1; day <= daysInMonth; day++) {
        var date = new Date(year, month, day);
        days.push({
          date: date,
          ymd: toYmd(date),
          weekday: date.getDay()
        });
      }
      return days;
    }

    function isWithinUntil(date, until) {
      if (!until) return true;
      var untilDate = parseYmd(until);
      if (!untilDate) return true;
      return date.getTime() <= untilDate.getTime();
    }

    function buildOccurrencesForMonth(year, month) {
      var days = getMonthDays(year, month);
      var occurrences = {};
      days.forEach(function(day) {
        occurrences[day.ymd] = [];
      });
      calendarEvents.forEach(function(event) {
        if (!event.date || !event.startTime) return;
        var startDate = parseYmd(event.date);
        if (!startDate) return;
        var recurrence = event.recurrence || { type: 'none' };
        if (recurrence.type === 'none') {
          if (startDate.getFullYear() === year && startDate.getMonth() === month) {
            occurrences[event.date].push(event);
          }
          return;
        }
        days.forEach(function(day) {
          if (day.date.getTime() < startDate.getTime()) return;
          if (!isWithinUntil(day.date, recurrence.until)) return;
          var diffDays = Math.floor((day.date.getTime() - startDate.getTime()) / 86400000);
          if (recurrence.type === 'weekly' && diffDays % 7 === 0) {
            occurrences[day.ymd].push(event);
          }
          if (recurrence.type === 'fortnightly' && diffDays % 14 === 0) {
            occurrences[day.ymd].push(event);
          }
          if (recurrence.type === 'custom_weekdays') {
            var weekdays = Array.isArray(recurrence.weekdays) ? recurrence.weekdays : [];
            if (weekdays.includes(day.weekday)) {
              occurrences[day.ymd].push(event);
            }
          }
        });
      });
      Object.keys(occurrences).forEach(function(key) {
        occurrences[key].sort(function(a, b) {
          return String(a.startTime || '').localeCompare(String(b.startTime || ''));
        });
        if (!occurrences[key].length) {
          delete occurrences[key];
        }
      });
      return occurrences;
    }

    function getOccurrencesForDate(ymd) {
      var date = parseYmd(ymd);
      if (!date) return [];
      if (date.getFullYear() === calendarCursor.getFullYear() && date.getMonth() === calendarCursor.getMonth()) {
        return calendarOccurrences[ymd] || [];
      }
      var temp = buildOccurrencesForMonth(date.getFullYear(), date.getMonth());
      return temp[ymd] || [];
    }

    function getPersonById(personId) {
      if (!personId) return null;
      return people.find(function(person) { return person.id === personId; }) || null;
    }

    function showCalendarModal(modal) {
      if (!modal) return;
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function hideCalendarModal(modal) {
      if (!modal) return;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
    }

    function renderCalendarMonth() {
      if (!calendarGrid || !calendarMonthLabel) return;
      var year = calendarCursor.getFullYear();
      var month = calendarCursor.getMonth();
      calendarMonthLabel.textContent = getMonthLabel(calendarCursor);
      calendarOccurrences = buildOccurrencesForMonth(year, month);
      calendarGrid.innerHTML = '';
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(function(label) {
        var header = document.createElement('div');
        header.className = 'calendar-weekday';
        header.textContent = label;
        calendarGrid.appendChild(header);
      });
      var firstDay = new Date(year, month, 1);
      var startOffset = firstDay.getDay();
      for (var i = 0; i < 42; i++) {
        var cellDate = new Date(year, month, 1 - startOffset + i);
        var ymd = toYmd(cellDate);
        var dayButton = document.createElement('button');
        dayButton.type = 'button';
        dayButton.className = 'calendar-day';
        if (cellDate.getMonth() !== month) {
          dayButton.classList.add('outside');
        }
        dayButton.dataset.date = ymd;
        var dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = cellDate.getDate();
        dayButton.appendChild(dayNumber);
        var dayEvents = calendarOccurrences[ymd] || [];
        dayEvents.slice(0, 3).forEach(function(event) {
          var chip = document.createElement('div');
          chip.className = 'calendar-chip';
          var person = getPersonById(event.personId);
          var avatar = document.createElement('img');
          avatar.alt = person && person.name ? person.name : 'Family';
          avatar.src = person ? getAvatarDataUrl(person) : buildAvatarSvg(event.id, event.title);
          var title = document.createElement('span');
          title.textContent = event.title || 'Event';
          chip.appendChild(avatar);
          chip.appendChild(title);
          dayButton.appendChild(chip);
        });
        if (dayEvents.length > 3) {
          var more = document.createElement('div');
          more.className = 'calendar-chip calendar-chip-more';
          more.textContent = '+' + (dayEvents.length - 3) + ' more';
          dayButton.appendChild(more);
        }
        dayButton.addEventListener('click', function(e) {
          var dateValue = e.currentTarget.dataset.date;
          openDayModal(dateValue);
        });
        calendarGrid.appendChild(dayButton);
      }
    }

    function renderCalendarPeopleOptions() {
      if (!calendarEventPerson) return;
      var familyPeople = getFamilyPeople();
      var currentValue = calendarEventPerson.value;
      calendarEventPerson.innerHTML = '';
      if (!familyPeople.length) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Add a family member in Life first';
        option.disabled = true;
        option.selected = true;
        calendarEventPerson.appendChild(option);
        calendarEventPerson.disabled = true;
        updateCalendarPersonPreview();
        return;
      }
      calendarEventPerson.disabled = false;
      familyPeople.forEach(function(person) {
        var option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name + (person.role ? ' Â· ' + getPersonRoleLabel(person) : '');
        calendarEventPerson.appendChild(option);
      });
      if (currentValue && familyPeople.some(function(person) { return person.id === currentValue; })) {
        calendarEventPerson.value = currentValue;
      }
      updateCalendarPersonPreview();
    }

    function updateCalendarPersonPreview() {
      if (!calendarEventPersonAvatar || !calendarEventPerson) return;
      var person = getPersonById(calendarEventPerson.value);
      if (!person) {
        calendarEventPersonAvatar.src = buildAvatarSvg('family', 'Family');
        calendarEventPersonAvatar.alt = 'Family avatar';
        return;
      }
      calendarEventPersonAvatar.src = getAvatarDataUrl(person);
      calendarEventPersonAvatar.alt = person.name || 'Person';
    }

    function updateCalendarDirectionsButton() {
      if (!calendarEventDirections || !calendarEventLocation) return;
      var location = calendarEventLocation.value.trim();
      if (!location) {
        calendarEventDirections.style.display = 'none';
        return;
      }
      calendarEventDirections.style.display = 'inline-flex';
    }

    function updateCalendarEventTimeVisibility() {
      if (!calendarEventAllDay || !calendarEventTimeRow || !calendarEventStart) return;
      var isAllDay = calendarEventAllDay.checked;
      calendarEventTimeRow.style.display = isAllDay ? 'none' : '';
      calendarEventStart.required = !isAllDay;
    }

    function updateCustomRepeatVisibility() {
      if (!calendarEventRepeat || !calendarCustomWeekdays || !calendarCustomUntil) return;
      var isCustom = calendarEventRepeat.value === 'custom_weekdays';
      calendarCustomWeekdays.style.display = isCustom ? 'grid' : 'none';
      calendarCustomUntil.style.display = isCustom ? 'block' : 'none';
      if (isCustom) {
        updateRepeatDayButtons();
      }
    }

    function updateRepeatDayButtons() {
      if (!calendarCustomWeekdays) return;
      var labels = calendarCustomWeekdays.querySelectorAll('.calendar-repeat-day');
      labels.forEach(function(label) {
        var input = label.querySelector('input');
        label.classList.toggle('active', input && input.checked);
      });
    }

    function openDayModal(ymd) {
      calendarSelectedDate = ymd;
      renderDayModal();
      showCalendarModal(calendarDayModal);
    }

    function renderDayModal() {
      if (!calendarDayList || !calendarDayTitle || !calendarDaySubtitle) return;
      var date = parseYmd(calendarSelectedDate);
      calendarDayTitle.textContent = 'Day details';
      calendarDaySubtitle.textContent = date ? date.toLocaleDateString() : '';
      calendarDayList.innerHTML = '';
      var eventsForDay = getOccurrencesForDate(calendarSelectedDate);
      if (!eventsForDay.length) {
        var empty = document.createElement('div');
        empty.className = 'calendar-empty';
        empty.textContent = 'No events yet.';
        calendarDayList.appendChild(empty);
        return;
      }
      eventsForDay.forEach(function(event) {
        var card = document.createElement('div');
        card.className = 'calendar-event-card';
        var header = document.createElement('div');
        header.className = 'calendar-event-header';
        var avatarWrap = document.createElement('div');
        avatarWrap.className = 'calendar-event-avatar';
        var person = getPersonById(event.personId);
        var avatarImg = document.createElement('img');
        avatarImg.alt = person && person.name ? person.name : 'Family';
        avatarImg.src = person ? getAvatarDataUrl(person) : buildAvatarSvg(event.id, event.title);
        avatarWrap.appendChild(avatarImg);
        var headerText = document.createElement('div');
        var title = document.createElement('div');
        title.className = 'calendar-event-title';
        title.textContent = event.title || 'Event';
        var meta = document.createElement('div');
        meta.className = 'calendar-event-meta';
        meta.textContent = [person ? person.name : 'Family', formatTimeRange(event)].filter(Boolean).join(' Â· ');
        headerText.appendChild(title);
        headerText.appendChild(meta);
        header.appendChild(avatarWrap);
        header.appendChild(headerText);
        card.appendChild(header);
        if (event.location) {
          var location = document.createElement('div');
          location.className = 'calendar-event-meta';
          location.textContent = 'Location: ' + event.location;
          card.appendChild(location);
        }
        if (event.notes) {
          var notes = document.createElement('div');
          notes.className = 'calendar-event-meta';
          notes.textContent = event.notes;
          card.appendChild(notes);
        }
        var actions = document.createElement('div');
        actions.className = 'calendar-event-actions';
        if (event.location) {
          var directionsBtn = document.createElement('button');
          directionsBtn.type = 'button';
          directionsBtn.className = 'calendar-btn secondary';
          directionsBtn.textContent = 'Directions';
          directionsBtn.addEventListener('click', function() {
            window.open(buildDirectionsUrl(event.location), '_blank');
          });
          actions.appendChild(directionsBtn);
        }
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'calendar-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          openEventModal(event);
        });
        actions.appendChild(editBtn);
        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'calendar-btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          var confirmRemove = window.confirm('Delete this event?');
          if (!confirmRemove) return;
          calendarEvents = calendarEvents.filter(function(item) { return item.id !== event.id; });
          saveCalendarEvents();
          renderCalendarMonth();
          renderDayModal();
          if (activePersonId === event.personId) {
            renderPersonAgenda(event.personId);
          }
        });
        actions.appendChild(deleteBtn);
        card.appendChild(actions);
        calendarDayList.appendChild(card);
      });
    }

    function openEventModal(event, targetDate, options) {
      if (!calendarEventModal) return;
      options = options || {};
      calendarLockedPersonId = options.lockPersonId || null;
      calendarEventModal.classList.toggle('person-locked', Boolean(calendarLockedPersonId));
      calendarReturnToDay = calendarDayModal && calendarDayModal.classList.contains('active');
      if (calendarReturnToDay) {
        hideCalendarModal(calendarDayModal);
      }
      calendarEditingEventId = event ? event.id : null;
      if (calendarEventTitle) {
        calendarEventTitle.textContent = event ? 'Edit event' : 'Add event';
      }
      if (calendarEventDelete) {
        calendarEventDelete.style.display = event ? 'inline-flex' : 'none';
      }
      renderCalendarPeopleOptions();
      if (calendarEventPerson) {
        if (calendarLockedPersonId) {
          calendarEventPerson.value = calendarLockedPersonId;
        } else if (event) {
          calendarEventPerson.value = event.personId || calendarEventPerson.value || '';
        } else if (!calendarEventPerson.value && calendarEventPerson.options.length) {
          calendarEventPerson.value = calendarEventPerson.options[0].value;
        }
        calendarEventPerson.disabled = Boolean(calendarLockedPersonId);
      }
      if (calendarEventTitleInput) calendarEventTitleInput.value = event ? event.title : '';
      if (calendarEventDate) {
        calendarEventDate.value = event ? event.date : (targetDate || toYmd(new Date()));
      }
      if (calendarEventAllDay) {
        calendarEventAllDay.checked = event ? !!event.allDay : false;
      }
      if (calendarEventStart) calendarEventStart.value = event ? event.startTime : '09:00';
      if (calendarEventEnd) calendarEventEnd.value = event ? (event.endTime || '') : '';
      if (calendarEventLocation) calendarEventLocation.value = event ? (event.location || '') : '';
      if (calendarEventNotes) calendarEventNotes.value = event ? (event.notes || '') : '';
      if (calendarEventRepeat) {
        calendarEventRepeat.value = event && event.recurrence ? event.recurrence.type : 'none';
      }
      updateCalendarEventTimeVisibility();
      updateCustomRepeatVisibility();
      if (calendarCustomWeekdays) {
        var checkboxes = calendarCustomWeekdays.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(input) {
          input.checked = false;
          if (event && event.recurrence && event.recurrence.type === 'custom_weekdays') {
            if (event.recurrence.weekdays && event.recurrence.weekdays.includes(parseInt(input.value, 10))) {
              input.checked = true;
            }
          }
        });
        updateRepeatDayButtons();
      }
      if (calendarCustomUntil) {
        calendarCustomUntil.value = event && event.recurrence ? (event.recurrence.until || '') : '';
      }
      updateCalendarPersonPreview();
      updateCalendarDirectionsButton();
      showCalendarModal(calendarEventModal);
    }

    function closeEventModal() {
      calendarEditingEventId = null;
      calendarLockedPersonId = null;
      if (calendarEventModal) {
        calendarEventModal.classList.remove('person-locked');
      }
      if (calendarEventPerson) {
        calendarEventPerson.disabled = false;
      }
      hideCalendarModal(calendarEventModal);
      if (calendarReturnToDay && calendarSelectedDate) {
        calendarReturnToDay = false;
        renderDayModal();
        showCalendarModal(calendarDayModal);
      }
    }

    function closeDayModal() {
      calendarSelectedDate = null;
      hideCalendarModal(calendarDayModal);
    }

    function closeCalendarModals() {
      calendarReturnToDay = false;
      closeEventModal();
      closeDayModal();
    }

    function handleCalendarSave(event) {
      event.preventDefault();
      if (!calendarEventPerson || !calendarEventTitleInput || !calendarEventDate || !calendarEventStart) return;
      var personId = calendarEventPerson.value;
      if (!personId) {
        alert('Please select a person.');
        return;
      }
      var title = calendarEventTitleInput.value.trim();
      if (!title) {
        alert('Please enter a title.');
        calendarEventTitleInput.focus();
        return;
      }
      var date = calendarEventDate.value;
      if (!date) {
        alert('Please select a date.');
        calendarEventDate.focus();
        return;
      }
      var isAllDay = calendarEventAllDay && calendarEventAllDay.checked;
      var startTime = isAllDay ? '00:00' : calendarEventStart.value;
      if (!isAllDay && !startTime) {
        alert('Please select a start time.');
        calendarEventStart.focus();
        return;
      }
      var recurrence = { type: calendarEventRepeat ? calendarEventRepeat.value : 'none' };
      if (recurrence.type === 'custom_weekdays') {
        var selected = [];
        if (calendarCustomWeekdays) {
          calendarCustomWeekdays.querySelectorAll('input[type="checkbox"]').forEach(function(input) {
            if (input.checked) {
              selected.push(parseInt(input.value, 10));
            }
          });
        }
        if (!selected.length) {
          var fallbackDate = parseYmd(date);
          if (fallbackDate) {
            selected.push(fallbackDate.getDay());
          }
        }
        recurrence.weekdays = selected;
        if (calendarCustomUntil && calendarCustomUntil.value) {
          recurrence.until = calendarCustomUntil.value;
        }
      }
      var payload = {
        id: calendarEditingEventId || null,
        personId: personId,
        title: title,
        date: date,
        startTime: startTime,
        endTime: isAllDay ? '' : (calendarEventEnd ? calendarEventEnd.value : ''),
        location: calendarEventLocation ? calendarEventLocation.value.trim() : '',
        notes: calendarEventNotes ? calendarEventNotes.value.trim() : '',
        allDay: isAllDay,
        recurrence: recurrence,
        updatedAt: Date.now()
      };
      if (calendarEditingEventId) {
        calendarEvents = calendarEvents.map(function(item) {
          if (item.id !== calendarEditingEventId) return item;
          return normalizeCalendarEvent(Object.assign({}, item, payload));
        });
      } else {
        payload.createdAt = Date.now();
        calendarEvents.unshift(normalizeCalendarEvent(payload));
      }
      saveCalendarEvents();
      renderCalendarMonth();
      if (calendarSelectedDate) {
        renderDayModal();
      }
      if (activePersonId === personId) {
        renderPersonAgenda(personId);
      }
      closeEventModal();
    }

    function isCalendarImportRoute() {
      return window.location.pathname === '/calendar/import';
    }

    function buildValidYmd(year, month, day) {
      var date = new Date(year, month - 1, day);
      if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
        return '';
      }
      return [year, padNumber(month), padNumber(day)].join('-');
    }

    function parseDateFromText(text) {
      if (!text) return '';
      var match = text.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (match) {
        var ymd = buildValidYmd(parseInt(match[1], 10), parseInt(match[2], 10), parseInt(match[3], 10));
        if (ymd) return ymd;
      }
      match = text.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
      if (match) {
        var month = parseInt(match[1], 10);
        var day = parseInt(match[2], 10);
        var year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
        if (year < 100) {
          year = 2000 + year;
        }
        var mdYmd = buildValidYmd(year, month, day);
        if (mdYmd) return mdYmd;
      }
      match = text.match(/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:,?\s*(\d{4}))?/i);
      if (match) {
        var months = {
          jan: 1, january: 1, feb: 2, february: 2, mar: 3, march: 3, apr: 4, april: 4, may: 5,
          jun: 6, june: 6, jul: 7, july: 7, aug: 8, august: 8, sep: 9, sept: 9, september: 9,
          oct: 10, october: 10, nov: 11, november: 11, dec: 12, december: 12
        };
        var key = match[1].toLowerCase();
        var monthValue = months[key];
        var dayValue = parseInt(match[2], 10);
        var yearValue = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
        var monthYmd = buildValidYmd(yearValue, monthValue, dayValue);
        if (monthYmd) return monthYmd;
      }
      return '';
    }

    function normalizeTimeValue(hour, minute, meridiem) {
      var h = parseInt(hour, 10);
      var m = minute ? parseInt(minute, 10) : 0;
      if (Number.isNaN(h) || Number.isNaN(m)) return '';
      if (meridiem) {
        var lower = meridiem.toLowerCase();
        if (lower === 'pm' && h < 12) h += 12;
        if (lower === 'am' && h === 12) h = 0;
      }
      if (h < 0 || h > 23 || m < 0 || m > 59) return '';
      return padNumber(h) + ':' + padNumber(m);
    }

    function parseTimesFromText(text) {
      if (!text) return [];
      var matches = [];
      var regex12 = /(\d{1,2})(?::(\d{2}))?\s*(am|pm)\b/gi;
      var match12;
      while ((match12 = regex12.exec(text)) !== null) {
        var time12 = normalizeTimeValue(match12[1], match12[2], match12[3]);
        if (time12) {
          matches.push({ index: match12.index, time: time12 });
        }
      }
      var regex24 = /\b([01]?\d|2[0-3]):([0-5]\d)\b/g;
      var match24;
      while ((match24 = regex24.exec(text)) !== null) {
        var time24 = normalizeTimeValue(match24[1], match24[2], null);
        if (time24) {
          matches.push({ index: match24.index, time: time24 });
        }
      }
      matches.sort(function(a, b) { return a.index - b.index; });
      var times = [];
      matches.forEach(function(item) {
        if (!times.includes(item.time)) {
          times.push(item.time);
        }
      });
      return times;
    }

    function parseLocationFromText(text) {
      if (!text) return '';
      var match = text.match(/\b(?:location|loc|address)\s*[:\-]\s*([^\n,]+)\b/i);
      if (match && match[1]) return match[1].trim();
      match = text.match(/\b(?:at|@)\s+([^,\n]+)\b/i);
      if (match && match[1]) return match[1].trim();
      return '';
    }

    function parseTitleFromText(text) {
      if (!text) return '';
      var cleaned = text.replace(/\s+/g, ' ').trim();
      var split = cleaned.split(/\b(?:at|@|on)\b/i);
      var candidate = split[0] ? split[0].trim() : '';
      candidate = candidate.replace(/\b(\d{1,2})(?::(\d{2}))?\s*(am|pm)\b/gi, '').trim();
      candidate = candidate.replace(/\b([01]?\d|2[0-3]):([0-5]\d)\b/g, '').trim();
      candidate = candidate.replace(/\b\d{4}-\d{2}-\d{2}\b/g, '').trim();
      if (candidate.length >= 3 && candidate.length <= 80) return candidate;
      return '';
    }

    function parseCalendarImportText(text) {
      var date = parseDateFromText(text);
      var times = parseTimesFromText(text);
      var location = parseLocationFromText(text);
      var title = parseTitleFromText(text);
      var hasStructured = Boolean(date || times.length || location || title);
      var startTime = times[0] || '';
      var endTime = times[1] || '';
      var allDay = !startTime;
      if (!hasStructured) {
        return {
          title: '',
          date: '',
          startTime: '',
          endTime: '',
          location: '',
          allDay: false
        };
      }
      return {
        title: title,
        date: date,
        startTime: startTime,
        endTime: endTime,
        location: location,
        allDay: allDay
      };
    }

    function renderCalendarImportPeopleOptions(selectedId) {
      if (!calendarImportPerson) return;
      var familyPeople = getFamilyPeople();
      calendarImportPerson.innerHTML = '';
      if (!familyPeople.length) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Add a family member in Life first';
        option.disabled = true;
        option.selected = true;
        calendarImportPerson.appendChild(option);
        calendarImportPerson.disabled = true;
        return;
      }
      calendarImportPerson.disabled = false;
      familyPeople.forEach(function(person) {
        var option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name + (person.role ? ' Â· ' + getPersonRoleLabel(person) : '');
        calendarImportPerson.appendChild(option);
      });
      if (selectedId && familyPeople.some(function(person) { return person.id === selectedId; })) {
        calendarImportPerson.value = selectedId;
      } else {
        calendarImportPerson.value = familyPeople[0].id;
      }
    }

    function updateCalendarImportDirections() {
      if (!calendarImportDirections || !calendarImportLocation) return;
      var location = calendarImportLocation.value.trim();
      if (!location) {
        calendarImportDirections.style.display = 'none';
        return;
      }
      calendarImportDirections.style.display = 'inline-flex';
    }

    function updateCalendarImportTimeVisibility() {
      if (!calendarImportAllDay || !calendarImportTimeRow || !calendarImportStart) return;
      var isAllDay = calendarImportAllDay.checked;
      calendarImportTimeRow.style.display = isAllDay ? 'none' : '';
      calendarImportStart.required = !isAllDay;
    }

    function resetCalendarImportForm() {
      if (!calendarImportForm) return;
      calendarImportForm.reset();
      if (calendarImportNotesDetails) {
        calendarImportNotesDetails.open = false;
      }
      if (calendarImportOriginalDetails) {
        calendarImportOriginalDetails.open = false;
      }
      updateCalendarImportTimeVisibility();
      updateCalendarImportDirections();
    }

    function populateCalendarImportForm() {
      if (!calendarImportOriginal) return;
      var params = new URLSearchParams(window.location.search);
      var rawText = params.get('text') || '';
      var personId = params.get('personId') || '';
      var decodedText = rawText.replace(/\+/g, ' ').trim();
      var parsed = parseCalendarImportText(decodedText);
      renderCalendarImportPeopleOptions(personId);
      if (calendarImportBackPerson) {
        calendarImportBackPerson.style.display = calendarImportPerson ? 'inline-flex' : 'none';
      }
      calendarImportOriginal.textContent = decodedText || 'No message text received.';
      if (calendarImportNotes) calendarImportNotes.value = decodedText;
      if (calendarImportTitle) calendarImportTitle.value = parsed.title || '';
      if (calendarImportDate) calendarImportDate.value = parsed.date || '';
      if (calendarImportStart) calendarImportStart.value = parsed.startTime || '';
      if (calendarImportEnd) calendarImportEnd.value = parsed.endTime || '';
      if (calendarImportLocation) calendarImportLocation.value = parsed.location || '';
      if (calendarImportAllDay) calendarImportAllDay.checked = parsed.allDay;
      updateCalendarImportTimeVisibility();
      updateCalendarImportDirections();
    }

    function showCalendarImportSuccess() {
      if (!calendarImportSuccess || !calendarImportForm) return;
      calendarImportForm.style.display = 'none';
      calendarImportSuccess.classList.add('active');
    }

    function showCalendarImportForm() {
      if (!calendarImportSuccess || !calendarImportForm) return;
      calendarImportSuccess.classList.remove('active');
      calendarImportForm.style.display = 'grid';
    }

    function handleCalendarImportSave(event) {
      event.preventDefault();
      if (!calendarImportPerson || !calendarImportTitle || !calendarImportDate) return;
      var personId = calendarImportPerson.value;
      if (!personId) {
        alert('Please select a person.');
        return;
      }
      var title = calendarImportTitle.value.trim();
      if (!title) {
        alert('Please enter a title.');
        calendarImportTitle.focus();
        return;
      }
      var date = calendarImportDate.value;
      if (!date) {
        alert('Please select a date.');
        calendarImportDate.focus();
        return;
      }
      var isAllDay = calendarImportAllDay && calendarImportAllDay.checked;
      var startTime = isAllDay ? '00:00' : (calendarImportStart ? calendarImportStart.value : '');
      if (!isAllDay && !startTime) {
        alert('Please select a start time.');
        calendarImportStart.focus();
        return;
      }
      var payload = {
        personId: personId,
        title: title,
        date: date,
        startTime: startTime,
        endTime: isAllDay ? '' : (calendarImportEnd ? calendarImportEnd.value : ''),
        location: calendarImportLocation ? calendarImportLocation.value.trim() : '',
        notes: calendarImportNotes ? calendarImportNotes.value.trim() : '',
        allDay: isAllDay,
        recurrence: { type: 'none' },
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      calendarEvents.unshift(normalizeCalendarEvent(payload));
      saveCalendarEvents();
      renderCalendarMonth();
      if (activePersonId === personId) {
        renderPersonAgenda(personId);
      }
      showCalendarImportSuccess();
    }

    // GOALS VIEW DATA
    var GOALS_SHORT_KEY = 'friction_goals_short_v1';
    var GOALS_LONG_KEY = 'friction_goals_long_v1';
    var goalsShort = [];
    var goalsLong = [];
    var editingLongGoalId = null;
    var goalsAreaFilterValue = 'all';

    function loadGoalsViewShort() {
      var saved = localStorage.getItem(GOALS_SHORT_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        var updated = parsed.map(function(goal) {
          if (!goal || typeof goal !== 'object') return null;
          var areaId = goal.areaId || getDefaultAreaId();
          return {
            id: goal.id || generateGoalId('short'),
            text: goal.text || '',
            done: typeof goal.done === 'boolean' ? goal.done : !!goal.completed,
            areaId: areaId,
            ownerName: goal.ownerName || getAreaOwnerName(areaId) || null,
            personId: goal.personId || null,
            createdAt: goal.createdAt || Date.now(),
            completedAt: goal.completedAt || null
          };
        }).filter(Boolean);
        return updated;
      } catch (e) {
        return [];
      }
    }

    function loadGoalsViewLong() {
      var saved = localStorage.getItem(GOALS_LONG_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(function(goal) {
          if (!goal || typeof goal !== 'object') return null;
          var areaId = goal.areaId || getDefaultAreaId();
          return {
            id: goal.id || generateGoalId('long'),
            title: goal.title || '',
            note: goal.note || '',
            targetDate: goal.targetDate || null,
            areaId: areaId,
            ownerName: goal.ownerName || getAreaOwnerName(areaId) || null,
            personId: goal.personId || null,
            createdAt: goal.createdAt || Date.now(),
            updatedAt: goal.updatedAt || goal.createdAt || Date.now()
          };
        }).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    function saveGoalsViewShort() {
      localStorage.setItem(GOALS_SHORT_KEY, JSON.stringify(goalsShort));
    }

    function saveGoalsViewLong() {
      localStorage.setItem(GOALS_LONG_KEY, JSON.stringify(goalsLong));
    }

    function generateGoalId(prefix) {
      return prefix + '_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function shouldIncludeGoalForArea(areaId, filterValue) {
      if (!filterValue || filterValue === 'all') return true;
      return areaId === filterValue;
    }

    function renderShortGoals() {
      if (!shortGoalList) return;
      shortGoalList.innerHTML = '';
      var filtered = goalsShort.filter(function(goal) {
        return shouldIncludeGoalForArea(goal.areaId, goalsAreaFilterValue);
      });
      if (filtered.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'goals-meta';
        empty.textContent = goalsShort.length === 0
          ? 'No short-term goals yet.'
          : 'No short-term goals in this area.';
        shortGoalList.appendChild(empty);
        return;
      }
      filtered.forEach(function(goal) {
        var item = document.createElement('div');
        item.className = 'goals-item' + (goal.done ? ' completed' : '');

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!goal.done;
        checkbox.addEventListener('change', function() {
          goal.done = this.checked;
          goal.completedAt = this.checked ? Date.now() : null;
          item.classList.toggle('completed', this.checked);
          saveGoalsViewShort();
          renderLifeToday();
        });

        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'goals-item-input';
        input.value = goal.text || '';
        input.readOnly = true;
        input.addEventListener('keydown', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            editBtn.click();
          }
        });

        var actions = document.createElement('div');
        actions.className = 'goals-item-actions';

        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'goals-btn goals-btn-secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          if (input.readOnly) {
            input.readOnly = false;
            input.focus();
            editBtn.textContent = 'Save';
            return;
          }
          var nextText = input.value.trim();
          if (!nextText) {
            input.value = goal.text || '';
          } else {
            goal.text = nextText;
            saveGoalsViewShort();
          }
          input.readOnly = true;
          editBtn.textContent = 'Edit';
        });

        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'goals-btn goals-btn-secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          goalsShort = goalsShort.filter(function(item) { return item.id !== goal.id; });
          saveGoalsViewShort();
          renderShortGoals();
          renderLifeToday();
        });

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        var meta = document.createElement('div');
        meta.className = 'goals-meta';
        var areaPill = document.createElement('span');
        areaPill.className = 'goals-area-pill';
        areaPill.textContent = getAreaLabel(goal.areaId);
        meta.appendChild(areaPill);

        item.appendChild(checkbox);
        item.appendChild(input);
        item.appendChild(meta);
        item.appendChild(actions);
        shortGoalList.appendChild(item);
      });
    }

    function renderLongGoals() {
      if (!longGoalList) return;
      longGoalList.innerHTML = '';
      var filtered = goalsLong.filter(function(goal) {
        return shouldIncludeGoalForArea(goal.areaId, goalsAreaFilterValue);
      });
      if (filtered.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'goals-meta';
        empty.textContent = goalsLong.length === 0
          ? 'No long-term goals yet.'
          : 'No long-term goals in this area.';
        longGoalList.appendChild(empty);
        return;
      }
      filtered.forEach(function(goal) {
        var item = document.createElement('div');
        item.className = 'goals-item';

        var content = document.createElement('div');
        content.className = 'goals-item-content';

        var title = document.createElement('div');
        title.textContent = goal.title || 'Untitled goal';

        var note = document.createElement('div');
        note.className = 'goals-meta';
        note.textContent = goal.note ? goal.note : '';

        var areaMeta = document.createElement('div');
        areaMeta.className = 'goals-meta';
        var areaPill = document.createElement('span');
        areaPill.className = 'goals-area-pill';
        areaPill.textContent = getAreaLabel(goal.areaId);
        areaMeta.appendChild(areaPill);

        var meta = document.createElement('div');
        meta.className = 'goals-meta';
        meta.textContent = goal.targetDate ? 'Target date: ' + goal.targetDate : '';

        content.appendChild(title);
        if (goal.note) content.appendChild(note);
        content.appendChild(areaMeta);
        if (goal.targetDate) content.appendChild(meta);

        var actions = document.createElement('div');
        actions.className = 'goals-item-actions';

        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'goals-btn goals-btn-secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          editingLongGoalId = goal.id;
          longGoalTitle.value = goal.title || '';
          longGoalNote.value = goal.note || '';
          longGoalDate.value = goal.targetDate || '';
          if (longGoalArea) {
            longGoalArea.value = goal.areaId || getDefaultAreaId();
          }
          longGoalAdd.textContent = 'Save';
          longGoalCancel.style.display = 'inline-flex';
          if (activeView !== 'goals') {
            setActiveView('goals', true);
          }
          longGoalTitle.focus();
        });

        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'goals-btn goals-btn-secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          goalsLong = goalsLong.filter(function(item) { return item.id !== goal.id; });
          saveGoalsViewLong();
          renderLongGoals();
          renderGoalsNudge();
          renderLifeGoals();
        });

        var breakBtn = document.createElement('button');
        breakBtn.type = 'button';
        breakBtn.className = 'goals-btn goals-btn-secondary';
        breakBtn.textContent = 'Break into steps';
        breakBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'goal',
            mode: 'break',
            item: goal
          });
        });

        var helpBtn = document.createElement('button');
        helpBtn.type = 'button';
        helpBtn.className = 'goals-btn goals-btn-secondary';
        helpBtn.textContent = 'Help me start';
        helpBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'goal',
            mode: 'start',
            item: goal
          });
        });

        actions.appendChild(editBtn);
        actions.appendChild(breakBtn);
        actions.appendChild(helpBtn);
        actions.appendChild(deleteBtn);

        item.appendChild(content);
        item.appendChild(actions);
        longGoalList.appendChild(item);
      });
      renderGoalsNudge();
    }

    function resetLongGoalForm() {
      editingLongGoalId = null;
      longGoalTitle.value = '';
      longGoalNote.value = '';
      longGoalDate.value = '';
      if (longGoalArea) {
        longGoalArea.value = getDefaultAreaId();
      }
      longGoalAdd.textContent = 'Add';
      longGoalCancel.style.display = 'none';
    }

    // LIFE TASKS + APPOINTMENTS
    var TASKS_KEY = 'friction_tasks_v1';
    var APPOINTMENTS_KEY = 'friction_appointments_v1';
    var tasks = [];
    var appointments = [];
    var appointmentModalContexts = {};
    var editingTaskId = null;
    var appointmentEditingId = null;
    var editingApptId = null;
    var appointmentModalLockPersonId = null;
    var appointmentModalSource = 'life';
    var appointmentsFilterPersonId = 'all';
    var lifeAppointmentsPastExpanded = false;
    var appointmentsPastExpanded = false;
    var lifeAreaFilterValue = 'all';
    var lifeActiveTab = 'people';

    function loadTasks() {
      var saved = localStorage.getItem(TASKS_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(function(task) {
          if (!task || typeof task !== 'object') return null;
          var areaId = task.areaId || getDefaultAreaId();
          return {
            id: task.id || generateGoalId('task'),
            text: task.text || '',
            areaId: areaId,
            ownerName: task.ownerName || getAreaOwnerName(areaId) || null,
            personId: task.personId || null,
            tags: Array.isArray(task.tags) ? task.tags : (task.tags ? String(task.tags).split(',').map(function(t) { return t.trim(); }).filter(Boolean) : []),
            needsOtherPeople: !!task.needsOtherPeople,
            needsAppointment: !!task.needsAppointment,
            energyType: task.energyType || '',
            done: !!task.done,
            createdAt: task.createdAt || Date.now(),
            dueDate: task.dueDate || null
          };
        }).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    function generateAppointmentId() {
      return 'appt_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function formatTimeValue(date) {
      if (!(date instanceof Date)) return '';
      return padNumber(date.getHours()) + ':' + padNumber(date.getMinutes());
    }

    function normalizeAppointment(appt) {
      if (!appt || typeof appt !== 'object') return null;
      var date = appt.date || '';
      var time = appt.time || '';
      var legacyStart = appt.dateTimeStart || '';
      if ((!date || !time) && legacyStart) {
        var legacyDate = new Date(legacyStart);
        if (!Number.isNaN(legacyDate.getTime())) {
          date = date || toYmd(legacyDate);
          time = time || formatTimeValue(legacyDate);
        }
      }
      if ((!date || !time) && appt.date && appt.startTime) {
        date = date || appt.date;
        time = time || appt.startTime;
      }
      return {
        id: appt.id || generateAppointmentId(),
        personId: appt.personId || 'me',
        title: appt.title || 'Untitled appointment',
        date: date || '',
        time: time || '',
        clinicName: appt.clinicName || appt.clinic || '',
        doctorName: appt.doctorName || appt.doctor || '',
        address: appt.address || appt.location || '',
        phone: appt.phone || '',
        notes: appt.notes || '',
        createdAt: appt.createdAt || Date.now(),
        updatedAt: appt.updatedAt || appt.createdAt || Date.now()
      };
    }

    function loadAppointments() {
      var saved = localStorage.getItem(APPOINTMENTS_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(normalizeAppointment).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    function saveTasks() {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
    }

    function saveAppointments() {
      localStorage.setItem(APPOINTMENTS_KEY, JSON.stringify(appointments));
    }

    function getDefaultPersonId() {
      var mePerson = people.find(function(person) { return person && (person.id === 'me' || person.type === 'me'); });
      if (mePerson) return mePerson.id;
      return people.length ? people[0].id : 'me';
    }

    function getAppointmentDateTime(appt) {
      if (!appt || !appt.date || !appt.time) return null;
      var dateTime = new Date(appt.date + 'T' + appt.time);
      if (Number.isNaN(dateTime.getTime())) return null;
      return dateTime;
    }

    function getAppointmentTimestamp(appt) {
      var dateTime = getAppointmentDateTime(appt);
      return dateTime ? dateTime.getTime() : null;
    }

    function formatAppointmentDateTime(appt) {
      var dateTime = getAppointmentDateTime(appt);
      if (!dateTime) return '';
      return dateTime.toLocaleString(undefined, { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function buildAppleMapsUrl(address) {
      if (!address) return '';
      return 'https://maps.apple.com/?q=' + encodeURIComponent(address);
    }

    function splitAppointmentsByTime(list) {
      var now = Date.now();
      var upcoming = [];
      var past = [];
      list.forEach(function(appt) {
        var timestamp = getAppointmentTimestamp(appt);
        if (timestamp === null) return;
        if (timestamp >= now) {
          upcoming.push(appt);
        } else {
          past.push(appt);
        }
      });
      upcoming.sort(function(a, b) {
        return getAppointmentTimestamp(a) - getAppointmentTimestamp(b);
      });
      past.sort(function(a, b) {
        return getAppointmentTimestamp(b) - getAppointmentTimestamp(a);
      });
      return { upcoming: upcoming, past: past };
    }

    function getPersonDisplayName(personId) {
      var person = getPersonById(personId);
      if (person) return person.name || 'Unknown';
      if (personId === 'me') return 'Me';
      return 'Unknown';
    }

    function renderAppointmentCard(appt, options) {
      var card = document.createElement('div');
      card.className = 'appointment-card';
      var headerBtn = document.createElement('button');
      headerBtn.type = 'button';
      headerBtn.className = 'appointment-header';
      headerBtn.setAttribute('aria-expanded', 'false');
      var headerContent = document.createElement('div');
      headerContent.className = 'appointment-header-content';
      var title = document.createElement('div');
      title.className = 'appointment-title';
      title.textContent = appt.title || 'Untitled appointment';
      var meta = document.createElement('div');
      meta.className = 'appointment-meta';
      var metaParts = [formatAppointmentDateTime(appt)];
      if (appt.clinicName) metaParts.push(appt.clinicName);
      if (options && options.showPerson) {
        metaParts.push(getPersonDisplayName(appt.personId));
      }
      meta.textContent = metaParts.filter(Boolean).join(' Â· ');
      headerContent.appendChild(title);
      if (meta.textContent) headerContent.appendChild(meta);
      var chevron = document.createElement('span');
      chevron.className = 'appointment-chevron';
      chevron.textContent = 'â–¾';
      headerBtn.appendChild(headerContent);
      headerBtn.appendChild(chevron);
      card.appendChild(headerBtn);

      var body = document.createElement('div');
      body.className = 'appointment-body';
      var detailFields = [
        { label: 'Doctor', value: appt.doctorName },
        { label: 'Address', value: appt.address },
        { label: 'Phone', value: appt.phone },
        { label: 'Notes', value: appt.notes }
      ];
      detailFields.forEach(function(field) {
        if (!field.value) return;
        var detail = document.createElement('div');
        detail.className = 'appointment-detail';
        var label = document.createElement('span');
        label.textContent = field.label;
        var value = document.createElement('div');
        value.textContent = field.value;
        detail.appendChild(label);
        detail.appendChild(value);
        body.appendChild(detail);
      });

      var actions = document.createElement('div');
      actions.className = 'appointment-actions';
      if (appt.address) {
        var directions = document.createElement('a');
        directions.className = 'appointment-action';
        directions.href = buildAppleMapsUrl(appt.address);
        directions.target = '_blank';
        directions.rel = 'noopener';
        directions.textContent = 'Directions';
        actions.appendChild(directions);
      }
      if (appt.phone) {
        var call = document.createElement('a');
        call.className = 'appointment-action';
        call.href = 'tel:' + appt.phone;
        call.textContent = 'Call';
        actions.appendChild(call);
      }
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'appointment-action';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', function(event) {
        event.stopPropagation();
        if (options && typeof options.onEdit === 'function') {
          options.onEdit(appt);
        }
      });
      actions.appendChild(editBtn);

      var deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'appointment-action';
      deleteBtn.textContent = 'Delete';
      deleteBtn.addEventListener('click', function(event) {
        event.stopPropagation();
        if (options && typeof options.onDelete === 'function') {
          options.onDelete(appt);
        }
      });
      actions.appendChild(deleteBtn);

      if (actions.children.length) {
        body.appendChild(actions);
      }
      card.appendChild(body);

      headerBtn.addEventListener('click', function() {
        var isExpanded = card.classList.contains('expanded');
        card.classList.toggle('expanded', !isExpanded);
        headerBtn.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
      });

      return card;
    }

    function renderGoalsNudge() {
      if (!goalsNudge) return;
      var cutoff = Date.now() - (14 * 24 * 60 * 60 * 1000);
      var stale = goalsLong.filter(function(goal) {
        return !goal.completedAt && goal.createdAt && goal.createdAt <= cutoff;
      });
      if (stale.length > 0) {
        goalsNudge.style.display = 'flex';
        goalsNudge.dataset.goalId = stale[0].id;
      } else {
        goalsNudge.style.display = 'none';
        goalsNudge.dataset.goalId = '';
      }
    }

    function formatTaskMeta(task) {
      var parts = [];
      if (task.dueDate) parts.push('Due ' + task.dueDate);
      if (task.tags && task.tags.length) parts.push('Tags: ' + task.tags.join(', '));
      if (task.energyType) parts.push('Energy: ' + task.energyType);
      if (task.needsOtherPeople) parts.push('Needs people');
      if (task.needsAppointment) parts.push('Needs appt');
      return parts.join(' â€¢ ');
    }

    function getLifeFiltered(items) {
      return (items || []).filter(function(item) {
        return shouldIncludeGoalForArea(item.areaId, lifeAreaFilterValue);
      });
    }

    function renderLifeToday() {
      if (!lifeTodayList) return;
      lifeTodayList.innerHTML = '';
      var actionableGoals = getLifeFiltered(goalsShort).filter(function(goal) { return !goal.done; });
      var actionableTasks = getLifeFiltered(tasks).filter(function(task) { return !task.done; });
      var combined = actionableGoals.map(function(goal) {
        return { type: 'goal', text: goal.text, areaId: goal.areaId };
      }).concat(actionableTasks.map(function(task) {
        return { type: 'task', text: task.text, areaId: task.areaId };
      }));
      var topFive = combined.slice(0, 5);
      if (topFive.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No actionable items yet.';
        lifeTodayList.appendChild(empty);
        return;
      }
      topFive.forEach(function(item) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = item.text;
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(item.areaId);
        meta.appendChild(pill);
        meta.appendChild(document.createTextNode(' Â· ' + (item.type === 'goal' ? 'Short-term goal' : 'Task')));
        row.appendChild(title);
        row.appendChild(meta);
        lifeTodayList.appendChild(row);
      });
    }

    function renderLifeGoals() {
      if (!lifeGoalsList) return;
      lifeGoalsList.innerHTML = '';
      var filteredLong = getLifeFiltered(goalsLong);
      if (filteredLong.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No long-term goals in this area.';
        lifeGoalsList.appendChild(empty);
        return;
      }
      filteredLong.forEach(function(goal) {
        var card = document.createElement('div');
        card.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = goal.title || 'Untitled goal';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(goal.areaId);
        meta.appendChild(pill);
        if (goal.targetDate) {
          meta.appendChild(document.createTextNode(' Â· Target ' + goal.targetDate));
        }
        card.appendChild(title);
        card.appendChild(meta);
        if (goal.note) {
          var note = document.createElement('div');
          note.className = 'life-meta';
          note.textContent = goal.note;
          card.appendChild(note);
        }
        var linked = goalsShort.filter(function(shortGoal) {
          return shortGoal.areaId === goal.areaId;
        });
        if (linked.length) {
          var linkedWrap = document.createElement('div');
          linkedWrap.className = 'life-meta';
          linkedWrap.textContent = 'Linked short-term: ' + linked.map(function(item) { return item.text; }).join(', ');
          card.appendChild(linkedWrap);
        }
        lifeGoalsList.appendChild(card);
      });
    }

    function renderLifeTasks() {
      if (!lifeTaskList) return;
      lifeTaskList.innerHTML = '';
      var filteredTasks = getLifeFiltered(tasks);
      if (filteredTasks.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = tasks.length === 0 ? 'No tasks yet.' : 'No tasks in this area.';
        lifeTaskList.appendChild(empty);
        return;
      }
      filteredTasks.forEach(function(task) {
        var item = document.createElement('div');
        item.className = 'life-item' + (task.done ? ' completed' : '');

        var header = document.createElement('div');
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!task.done;
        checkbox.addEventListener('change', function() {
          task.done = this.checked;
          saveTasks();
          renderLifeTasks();
          renderLifeToday();
        });
        var text = document.createElement('span');
        text.textContent = task.text || '';
        header.appendChild(checkbox);
        header.appendChild(text);

        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = formatTaskMeta(task);
        var areaMeta = document.createElement('div');
        areaMeta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(task.areaId);
        areaMeta.appendChild(pill);

        var actions = document.createElement('div');
        actions.className = 'life-item-actions';
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'life-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          editingTaskId = task.id;
          lifeTaskText.value = task.text || '';
          lifeTaskArea.value = task.areaId || getDefaultAreaId();
          lifeTaskTags.value = (task.tags || []).join(', ');
          lifeTaskDue.value = task.dueDate || '';
          lifeTaskNeedsPeople.checked = !!task.needsOtherPeople;
          lifeTaskNeedsAppt.checked = !!task.needsAppointment;
          lifeTaskEnergy.value = task.energyType || '';
          lifeTaskAdd.textContent = 'Save task';
          lifeTaskCancel.style.display = 'inline-flex';
          if (activeView !== 'life') {
            setActiveView('life', true);
          }
          lifeTaskText.focus();
        });

        var breakBtn = document.createElement('button');
        breakBtn.type = 'button';
        breakBtn.className = 'life-btn secondary';
        breakBtn.textContent = 'Break into steps';
        breakBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'task',
            mode: 'break',
            item: task
          });
        });

        var helpBtn = document.createElement('button');
        helpBtn.type = 'button';
        helpBtn.className = 'life-btn secondary';
        helpBtn.textContent = 'Help me start';
        helpBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'task',
            mode: 'start',
            item: task
          });
        });

        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'life-btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          tasks = tasks.filter(function(item) { return item.id !== task.id; });
          saveTasks();
          renderLifeTasks();
          renderLifeToday();
          renderLinkedTaskOptions();
        });

        actions.appendChild(editBtn);
        actions.appendChild(breakBtn);
        actions.appendChild(helpBtn);
        actions.appendChild(deleteBtn);

        item.appendChild(header);
        if (meta.textContent) item.appendChild(meta);
        item.appendChild(areaMeta);
        item.appendChild(actions);
        lifeTaskList.appendChild(item);
      });
    }

    function renderLinkedTaskOptions() {
      if (!lifeApptLinkedTasks) return;
      lifeApptLinkedTasks.innerHTML = '';
      tasks.forEach(function(task) {
        var opt = document.createElement('option');
        opt.value = task.id;
        opt.textContent = task.text || 'Untitled task';
        lifeApptLinkedTasks.appendChild(opt);
      });
    }

    function renderLifeCalendar() {
      if (!lifeCalendarList) return;
      lifeCalendarList.innerHTML = '';
      var filtered = getLifeFiltered(appointments).filter(function(appt) {
        return appt.dateTimeStart;
      });
      filtered.sort(function(a, b) {
        return new Date(a.dateTimeStart) - new Date(b.dateTimeStart);
      });
      if (filtered.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = appointments.length === 0 ? 'No appointments yet.' : 'No appointments in this area.';
        lifeCalendarList.appendChild(empty);
        return;
      }
      var lastDate = '';
      filtered.forEach(function(appt) {
        var start = new Date(appt.dateTimeStart);
        var dateLabel = isNaN(start.getTime()) ? 'Upcoming' : start.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        if (dateLabel !== lastDate) {
          var dateHeader = document.createElement('div');
          dateHeader.className = 'life-meta';
          dateHeader.textContent = dateLabel;
          lifeCalendarList.appendChild(dateHeader);
          lastDate = dateLabel;
        }
        var card = document.createElement('div');
        card.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = appt.title || 'Untitled appointment';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var timeLabel = appt.dateTimeStart ? new Date(appt.dateTimeStart).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) : '';
        if (appt.dateTimeEnd) {
          var endLabel = new Date(appt.dateTimeEnd).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
          timeLabel = timeLabel + ' - ' + endLabel;
        }
        meta.textContent = [timeLabel, appt.location].filter(Boolean).join(' Â· ');
        var linked = appt.linkedTaskIds && appt.linkedTaskIds.length
          ? appt.linkedTaskIds.map(function(id) {
            var task = tasks.find(function(t) { return t.id === id; });
            return task ? task.text : '';
          }).filter(Boolean).join(', ')
          : '';
        if (linked) {
          var linkedMeta = document.createElement('div');
          linkedMeta.className = 'life-meta';
          linkedMeta.textContent = 'Linked tasks: ' + linked;
          card.appendChild(linkedMeta);
        }
        var areaMeta = document.createElement('div');
        areaMeta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(appt.areaId);
        areaMeta.appendChild(pill);

        var actions = document.createElement('div');
        actions.className = 'life-item-actions';
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'life-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          editingApptId = appt.id;
          lifeApptTitle.value = appt.title || '';
          lifeApptArea.value = appt.areaId || getDefaultAreaId();
          lifeApptStart.value = appt.dateTimeStart || '';
          lifeApptEnd.value = appt.dateTimeEnd || '';
          lifeApptLocation.value = appt.location || '';
          lifeApptNotes.value = appt.notes || '';
          Array.from(lifeApptLinkedTasks.options).forEach(function(option) {
            option.selected = appt.linkedTaskIds.indexOf(option.value) >= 0;
          });
          lifeApptAdd.textContent = 'Save appointment';
          lifeApptCancel.style.display = 'inline-flex';
          if (activeView !== 'life') {
            setActiveView('life', true);
          }
          lifeApptTitle.focus();
        });
        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'life-btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          appointments = appointments.filter(function(item) { return item.id !== appt.id; });
          saveAppointments();
          renderLifeCalendar();
        });
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(title);
        if (meta.textContent) card.appendChild(meta);
        card.appendChild(areaMeta);
        card.appendChild(actions);
        lifeCalendarList.appendChild(card);
      });
    }

    function renderAppointmentList(container, list, options) {
      if (!container) return;
      container.innerHTML = '';
      if (!list.length) {
        var empty = document.createElement('div');
        empty.className = 'appointment-empty';
        empty.textContent = options && options.emptyMessage ? options.emptyMessage : 'No appointments found.';
        container.appendChild(empty);
        return;
      }
      list.forEach(function(appt) {
        var card = renderAppointmentCard(appt, {
          showPerson: options && options.showPerson,
          onEdit: function(item) {
            var context = getAppointmentModalContext(options && options.source ? options.source : 'life');
            openAppointmentModal(context, item, { lockPersonId: options && options.lockPersonId ? options.lockPersonId : null });
          },
          onDelete: function(item) {
            deleteAppointment(item);
          }
        });
        container.appendChild(card);
      });
    }

    function getAppointmentModalContext(source) {
      return appointmentModalContexts[source] || null;
    }

    function updatePastToggle(toggleEl, expanded, count, label) {
      if (!toggleEl) return;
      if (!count) {
        toggleEl.style.display = 'none';
        return;
      }
      toggleEl.style.display = '';
      toggleEl.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      toggleEl.textContent = (expanded ? 'Hide' : 'Show') + ' ' + label + ' (' + count + ')';
    }

    function renderPersonAppointments(personId) {
      if (!lifeAppointmentsList || !lifeAppointmentsPast) return;
      if (!personId) return;
      var personAppointments = appointments.filter(function(appt) {
        return appt.personId === personId;
      });
      var split = splitAppointmentsByTime(personAppointments);
      renderAppointmentList(lifeAppointmentsList, split.upcoming, {
        showPerson: false,
        source: 'life',
        lockPersonId: personId,
        emptyMessage: 'No upcoming appointments yet.'
      });
      renderAppointmentList(lifeAppointmentsPast, split.past, {
        showPerson: false,
        source: 'life',
        lockPersonId: personId,
        emptyMessage: 'No past appointments yet.'
      });
      updatePastToggle(lifeAppointmentsPastToggle, lifeAppointmentsPastExpanded, split.past.length, 'past');
      if (lifeAppointmentsPast) {
        lifeAppointmentsPast.style.display = lifeAppointmentsPastExpanded ? '' : 'none';
      }
    }

    function renderAppointmentsFilters() {
      if (!appointmentsFilters) return;
      appointmentsFilters.innerHTML = '';
      var family = getFamilyPeople();
      if (appointmentsFilterPersonId !== 'all' && !family.some(function(person) { return person.id === appointmentsFilterPersonId; })) {
        appointmentsFilterPersonId = 'all';
      }
      var filterOptions = [{ id: 'all', label: 'All' }].concat(family.map(function(person) {
        return { id: person.id, label: person.name || 'Person' };
      }));
      filterOptions.forEach(function(option) {
        var chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'appointments-chip' + (appointmentsFilterPersonId === option.id ? ' active' : '');
        chip.textContent = option.label;
        chip.addEventListener('click', function() {
          appointmentsFilterPersonId = option.id;
          renderAppointmentsView();
        });
        appointmentsFilters.appendChild(chip);
      });
    }

    function renderAppointmentsView() {
      if (!appointmentsFeed || !appointmentsPastFeed) return;
      renderAppointmentsFilters();
      var list = appointments.slice();
      if (appointmentsFilterPersonId !== 'all') {
        list = list.filter(function(appt) { return appt.personId === appointmentsFilterPersonId; });
      }
      var split = splitAppointmentsByTime(list);
      renderAppointmentList(appointmentsFeed, split.upcoming, {
        showPerson: appointmentsFilterPersonId === 'all',
        source: 'calendar',
        emptyMessage: 'No upcoming appointments scheduled.'
      });
      renderAppointmentList(appointmentsPastFeed, split.past, {
        showPerson: appointmentsFilterPersonId === 'all',
        source: 'calendar',
        emptyMessage: 'No past appointments yet.'
      });
      updatePastToggle(appointmentsPastToggle, appointmentsPastExpanded, split.past.length, 'past');
      appointmentsPastFeed.style.display = appointmentsPastExpanded ? '' : 'none';
    }

    function deleteAppointment(appt) {
      if (!appt) return;
      var confirmRemove = window.confirm('Delete "' + (appt.title || 'this appointment') + '"?');
      if (!confirmRemove) return;
      appointments = appointments.filter(function(item) { return item.id !== appt.id; });
      saveAppointments();
      if (activePersonId) {
        renderPersonAppointments(activePersonId);
      }
      renderAppointmentsView();
    }

    function renderAppointmentPersonOptions(selectEl, selectedId) {
      if (!selectEl) return;
      var family = getFamilyPeople();
      selectEl.innerHTML = '';
      if (!family.length) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Add a person in Life first';
        option.disabled = true;
        option.selected = true;
        selectEl.appendChild(option);
        selectEl.disabled = true;
        return;
      }
      selectEl.disabled = false;
      family.forEach(function(person) {
        var opt = document.createElement('option');
        opt.value = person.id;
        opt.textContent = person.name || 'Person';
        selectEl.appendChild(opt);
      });
      if (selectedId) {
        selectEl.value = selectedId;
      }
    }

    function normalizeAuPhone(value) {
      if (!value) return '';
      var raw = String(value).trim();
      if (!raw) return '';
      var hasPlus = raw.startsWith('+');
      var digits = raw.replace(/[^\d+]/g, '');
      if (hasPlus) {
        digits = '+' + digits.replace(/[^\d]/g, '');
      }
      var cleaned = digits.replace(/\D/g, '');
      if (cleaned.startsWith('61')) {
        cleaned = '0' + cleaned.slice(2);
      }
      if (cleaned.length === 10 && cleaned.startsWith('04')) {
        return cleaned.replace(/(\d{4})(\d{3})(\d{3})/, '$1 $2 $3');
      }
      if (cleaned.length === 10 && /^0[2378]/.test(cleaned)) {
        return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1 $2 $3');
      }
      return value.trim();
    }

    function parseDateFromText(text) {
      if (!text) return '';
      var normalized = text.replace(/[\n,]/g, ' ');
      var isoMatch = normalized.match(/\b(\d{4})-(\d{1,2})-(\d{1,2})\b/);
      if (isoMatch) {
        var isoDate = new Date(isoMatch[1], isoMatch[2] - 1, isoMatch[3]);
        return Number.isNaN(isoDate.getTime()) ? '' : toYmd(isoDate);
      }
      var numericMatch = normalized.match(/\b(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?\b/);
      if (numericMatch) {
        var year = numericMatch[3] ? Number(numericMatch[3]) : new Date().getFullYear();
        if (year < 100) year += 2000;
        var numericDate = new Date(year, Number(numericMatch[2]) - 1, Number(numericMatch[1]));
        return Number.isNaN(numericDate.getTime()) ? '' : toYmd(numericDate);
      }
      var monthNames = {
        jan: 0, january: 0,
        feb: 1, february: 1,
        mar: 2, march: 2,
        apr: 3, april: 3,
        may: 4,
        jun: 5, june: 5,
        jul: 6, july: 6,
        aug: 7, august: 7,
        sep: 8, sept: 8, september: 8,
        oct: 9, october: 9,
        nov: 10, november: 10,
        dec: 11, december: 11
      };
      var nameMatch = normalized.match(/\b(\d{1,2})\s*(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\.?,?\s*(\d{2,4})?\b/i);
      if (nameMatch) {
        var monthKey = nameMatch[2].toLowerCase();
        var monthIndex = monthNames[monthKey] !== undefined ? monthNames[monthKey] : monthNames[monthKey.slice(0, 3)];
        var yearValue = nameMatch[3] ? Number(nameMatch[3]) : new Date().getFullYear();
        if (yearValue < 100) yearValue += 2000;
        var namedDate = new Date(yearValue, monthIndex, Number(nameMatch[1]));
        return Number.isNaN(namedDate.getTime()) ? '' : toYmd(namedDate);
      }
      var reverseMatch = normalized.match(/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\.?\s*(\d{1,2})(?:\D+(\d{2,4}))?\b/i);
      if (reverseMatch) {
        var monthKeyAlt = reverseMatch[1].toLowerCase();
        var monthIndexAlt = monthNames[monthKeyAlt] !== undefined ? monthNames[monthKeyAlt] : monthNames[monthKeyAlt.slice(0, 3)];
        var yearAlt = reverseMatch[3] ? Number(reverseMatch[3]) : new Date().getFullYear();
        if (yearAlt < 100) yearAlt += 2000;
        var altDate = new Date(yearAlt, monthIndexAlt, Number(reverseMatch[2]));
        return Number.isNaN(altDate.getTime()) ? '' : toYmd(altDate);
      }
      return '';
    }

    function parseTimeFromText(text) {
      if (!text) return '';
      var match = text.match(/\b(\d{1,2}):(\d{2})\s*(am|pm)?\b/i);
      var hour = match ? Number(match[1]) : null;
      var minutes = match ? Number(match[2]) : null;
      var meridiem = match && match[3] ? match[3].toLowerCase() : '';
      if (!match) {
        var shortMatch = text.match(/\b(\d{1,2})\s*(am|pm)\b/i);
        if (!shortMatch) return '';
        hour = Number(shortMatch[1]);
        minutes = 0;
        meridiem = shortMatch[2].toLowerCase();
      }
      if (meridiem) {
        if (meridiem === 'pm' && hour < 12) hour += 12;
        if (meridiem === 'am' && hour === 12) hour = 0;
      }
      if (hour > 23 || minutes > 59) return '';
      return padNumber(hour) + ':' + padNumber(minutes);
    }

    function parsePhoneFromText(text) {
      if (!text) return '';
      var match = text.match(/(\+?61\s?\d{1}\s?\d{4}\s?\d{4})|(0[2378]\s?\d{4}\s?\d{4})|(04\d{2}\s?\d{3}\s?\d{3})/);
      return match ? normalizeAuPhone(match[0]) : '';
    }

    function parseAppointmentText(text) {
      var cleanText = (text || '').trim();
      if (!cleanText) return {};
      var title = '';
      var lines = cleanText.split(/\n/).map(function(line) { return line.trim(); }).filter(Boolean);
      if (lines.length) {
        title = lines[0];
      }
      var venueMatch = cleanText.match(/\b(?:at|location|clinic|venue|practice)\s*[:\-]?\s*([^\n,;]+)\b/i);
      var doctorMatch = cleanText.match(/\b(?:dr\.?|doctor|with)\s+([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)*)/);
      var addressMatch = cleanText.match(/\b(\d{1,5}\s+[^\n,]+(?:\s+(?:NSW|VIC|QLD|SA|WA|TAS|ACT|NT)\s*\d{4})?)\b/i);
      return {
        title: title,
        date: parseDateFromText(cleanText),
        time: parseTimeFromText(cleanText),
        venueName: venueMatch ? venueMatch[1].trim() : '',
        address: addressMatch ? addressMatch[1].trim() : '',
        contactName: doctorMatch ? doctorMatch[1].trim() : '',
        phone: parsePhoneFromText(cleanText),
        notes: cleanText
      };
    }

    function applyAppointmentFields(context, fields) {
      if (!context || !fields) return;
      if (fields.title) context.titleInput.value = fields.title;
      if (fields.date) context.dateInput.value = fields.date;
      if (fields.time) context.timeInput.value = fields.time;
      if (fields.venueName) context.clinicInput.value = fields.venueName;
      if (fields.contactName) context.doctorInput.value = fields.contactName;
      if (fields.address) context.addressInput.value = fields.address;
      if (fields.phone) context.phoneInput.value = normalizeAuPhone(fields.phone);
      if (fields.notes) context.notesInput.value = fields.notes;
    }

    function setAppointmentOriginalText(context, text) {
      if (!context || !context.originalDetails || !context.originalText) return;
      if (!text) {
        context.originalDetails.style.display = 'none';
        context.originalText.textContent = '';
        return;
      }
      context.originalText.textContent = text;
      context.originalDetails.style.display = '';
      context.originalDetails.open = false;
    }

    function updateAppointmentScanPreview(context, file) {
      if (!context || !context.scanPreview || !context.scanImage) return;
      if (!file) return;
      if (context.captureUrl) {
        URL.revokeObjectURL(context.captureUrl);
      }
      context.captureUrl = URL.createObjectURL(file);
      context.scanImage.src = context.captureUrl;
      context.scanPreview.style.display = '';
    }

    function resetAppointmentCapture(context) {
      if (!context) return;
      if (context.scanTakeInput) context.scanTakeInput.value = '';
      if (context.scanUploadInput) context.scanUploadInput.value = '';
      if (context.scanPreview) context.scanPreview.style.display = 'none';
      if (context.scanImage) context.scanImage.removeAttribute('src');
      if (context.captureUrl) {
        URL.revokeObjectURL(context.captureUrl);
        context.captureUrl = null;
      }
      if (context.textInput) context.textInput.value = '';
      setAppointmentOriginalText(context, '');
      if (context.aiBtn) {
        context.aiBtn.classList.remove('is-loading');
        context.aiBtn.disabled = false;
      }
    }

    async function callAppointmentStructure(text) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      var res = await fetch('/api/appointments/structure', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({ text: text })
      });
      if (!res.ok) {
        var errorMsg = 'Backend API error';
        try {
          var error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (e) {}
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        throw new Error(errorMsg);
      }
      var data = await res.json();
      return (data && data.fields) ? data.fields : {};
    }

    function openAppointmentModal(context, appt, options) {
      if (!context || !context.modal) return;
      appointmentEditingId = appt ? appt.id : null;
      appointmentModalSource = context.source || 'life';
      appointmentModalLockPersonId = options && options.lockPersonId ? options.lockPersonId : null;
      context.title.textContent = appt ? 'Edit appointment' : 'Add appointment';
      var personId = appt ? appt.personId : (appointmentModalLockPersonId || getDefaultPersonId());
      renderAppointmentPersonOptions(context.personSelect, personId);
      if (context.personRow) {
        var isLocked = !!appointmentModalLockPersonId;
        context.personRow.style.display = isLocked ? 'none' : '';
        context.personSelect.disabled = isLocked;
      }
      if (appointmentModalLockPersonId) {
        context.personSelect.value = appointmentModalLockPersonId;
      }
      context.titleInput.value = appt ? appt.title || '' : '';
      context.dateInput.value = appt ? appt.date || '' : '';
      context.timeInput.value = appt ? appt.time || '' : '';
      context.clinicInput.value = appt ? appt.clinicName || '' : '';
      context.doctorInput.value = appt ? appt.doctorName || '' : '';
      context.addressInput.value = appt ? appt.address || '' : '';
      context.phoneInput.value = appt ? appt.phone || '' : '';
      context.notesInput.value = appt ? appt.notes || '' : '';
      context.deleteBtn.style.display = appt ? 'inline-flex' : 'none';
      resetAppointmentCapture(context);
      context.modal.classList.add('active');
      context.modal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function closeAppointmentModal(context) {
      if (!context || !context.modal) return;
      context.modal.classList.remove('active');
      context.modal.setAttribute('aria-hidden', 'true');
      appointmentEditingId = null;
      appointmentModalLockPersonId = null;
      resetAppointmentCapture(context);
      unlockBodyScroll();
    }

    function handleAppointmentSubmit(event, context) {
      event.preventDefault();
      if (!context) return;
      var personId = context.personSelect ? context.personSelect.value : '';
      if (appointmentModalLockPersonId) {
        personId = appointmentModalLockPersonId;
      }
      if (!personId) {
        alert('Please select a person.');
        return;
      }
      var title = context.titleInput.value.trim();
      if (!title) {
        alert('Please enter a title.');
        context.titleInput.focus();
        return;
      }
      var date = context.dateInput.value;
      var time = context.timeInput.value;
      if (!date || !time) {
        alert('Please select a date and time.');
        return;
      }
      var dateTime = new Date(date + 'T' + time);
      if (!Number.isNaN(dateTime.getTime()) && dateTime.getTime() < Date.now()) {
        var proceed = window.confirm('This appointment is in the past. Save anyway?');
        if (!proceed) {
          return;
        }
      }
      var existing = appointmentEditingId
        ? appointments.find(function(item) { return item.id === appointmentEditingId; })
        : null;
      var record = {
        id: appointmentEditingId || generateAppointmentId(),
        personId: personId,
        title: title,
        date: date,
        time: time,
        clinicName: context.clinicInput.value.trim(),
        doctorName: context.doctorInput.value.trim(),
        address: context.addressInput.value.trim(),
        phone: context.phoneInput.value.trim(),
        notes: context.notesInput.value.trim(),
        createdAt: existing && existing.createdAt ? existing.createdAt : Date.now(),
        updatedAt: Date.now()
      };
      if (existing) {
        appointments = appointments.map(function(item) {
          return item.id === appointmentEditingId ? record : item;
        });
      } else {
        appointments.unshift(record);
      }
      saveAppointments();
      if (activePersonId) {
        renderPersonAppointments(activePersonId);
      }
      renderAppointmentsView();
      closeAppointmentModal(context);
    }

    function setupAppointmentModal(context) {
      if (!context || !context.modal) return;
      context.modal.addEventListener('click', function(event) {
        if (event.target.dataset.close !== undefined) {
          closeAppointmentModal(context);
        }
      });
      if (context.closeBtn) {
        context.closeBtn.addEventListener('click', function() {
          closeAppointmentModal(context);
        });
      }
      context.form.addEventListener('submit', function(event) {
        handleAppointmentSubmit(event, context);
      });
      if (context.phoneInput) {
        context.phoneInput.addEventListener('blur', function() {
          this.value = normalizeAuPhone(this.value);
        });
      }
      if (context.deleteBtn) {
        context.deleteBtn.addEventListener('click', function() {
          if (!appointmentEditingId) return;
          var appt = appointments.find(function(item) { return item.id === appointmentEditingId; });
          deleteAppointment(appt);
          closeAppointmentModal(context);
        });
      }
      if (context.scanTakeBtn && context.scanTakeInput) {
        context.scanTakeBtn.addEventListener('click', function() {
          context.scanTakeInput.click();
        });
        context.scanTakeInput.addEventListener('change', function(event) {
          var file = event.target.files && event.target.files[0];
          if (file) updateAppointmentScanPreview(context, file);
        });
      }
      if (context.scanUploadBtn && context.scanUploadInput) {
        context.scanUploadBtn.addEventListener('click', function() {
          context.scanUploadInput.click();
        });
        context.scanUploadInput.addEventListener('change', function(event) {
          var file = event.target.files && event.target.files[0];
          if (file) updateAppointmentScanPreview(context, file);
        });
      }
      if (context.parseBtn && context.textInput) {
        context.parseBtn.addEventListener('click', function() {
          var text = context.textInput.value.trim();
          if (!text) {
            alert('Paste appointment text to parse.');
            context.textInput.focus();
            return;
          }
          var parsed = parseAppointmentText(text);
          applyAppointmentFields(context, parsed);
          setAppointmentOriginalText(context, '');
        });
      }
      if (context.aiBtn && context.textInput) {
        context.aiBtn.addEventListener('click', async function() {
          var text = context.textInput.value.trim();
          if (!text) {
            alert('Paste appointment text to use AI.');
            context.textInput.focus();
            return;
          }
          context.aiBtn.classList.add('is-loading');
          context.aiBtn.disabled = true;
          try {
            var fields = await callAppointmentStructure(text);
            applyAppointmentFields(context, fields);
            setAppointmentOriginalText(context, text);
          } catch (err) {
            alert(err && err.message ? err.message : 'Unable to structure the appointment text.');
          } finally {
            context.aiBtn.classList.remove('is-loading');
            context.aiBtn.disabled = false;
          }
        });
      }
    }

    function renderLifeAreasList() {
      if (!lifeAreasList) return;
      lifeAreasList.innerHTML = '';
      lifeAreas.forEach(function(area) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = area.name;
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = 'Type: ' + area.type;
        row.appendChild(title);
        row.appendChild(meta);
        if (area.type === 'child') {
          var actions = document.createElement('div');
          actions.className = 'life-item-actions';
          var removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'life-btn secondary';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', function() {
            lifeAreas = lifeAreas.filter(function(item) { return item.id !== area.id; });
            saveLifeAreas();
            renderAreaSelects();
            renderLifeAreasList();
          });
          actions.appendChild(removeBtn);
          row.appendChild(actions);
        }
        lifeAreasList.appendChild(row);
      });
    }

    function renderAreaSelects() {
      if (goalsAreaFilterValue !== 'all' && !lifeAreas.some(function(area) { return area.id === goalsAreaFilterValue; })) {
        goalsAreaFilterValue = 'all';
      }
      if (lifeAreaFilterValue !== 'all' && !lifeAreas.some(function(area) { return area.id === lifeAreaFilterValue; })) {
        lifeAreaFilterValue = 'all';
      }
      renderAreaSelect(goalsAreaFilter, true, goalsAreaFilterValue);
      renderAreaSelect(shortGoalArea, false, goalsAreaFilterValue !== 'all' ? goalsAreaFilterValue : getDefaultAreaId());
      renderAreaSelect(longGoalArea, false, goalsAreaFilterValue !== 'all' ? goalsAreaFilterValue : getDefaultAreaId());
      renderAreaSelect(lifeAreaFilter, true, lifeAreaFilterValue);
      renderAreaSelect(lifeTaskArea, false, lifeAreaFilterValue !== 'all' ? lifeAreaFilterValue : getDefaultAreaId());
      renderAreaSelect(lifeApptArea, false, lifeAreaFilterValue !== 'all' ? lifeAreaFilterValue : getDefaultAreaId());
    }

    function setLifeTab(nextTab) {
      lifeActiveTab = nextTab;
      if (lifeView && lifeView.classList.contains('person-view-active')) {
        setPersonViewActive(false);
      }
      var tabs = document.querySelectorAll('#lifeTabs .life-tab');
      tabs.forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.tab === nextTab);
      });
      var panels = document.querySelectorAll('#life-view [data-tab-panel]');
      panels.forEach(function(panel) {
        panel.style.display = panel.dataset.tabPanel === nextTab ? '' : 'none';
      });
      if (lifeView) {
        lifeView.classList.toggle('people-active', nextTab === 'people');
      }
      if (lifeAreaFilter) {
        lifeAreaFilter.classList.toggle('life-area-hidden', nextTab === 'people');
      }
    }

    async function callUnstuckAssistant(prompt) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      var res = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({
          model: modelSelect.value,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      if (!res.ok) {
        var errorMsg = 'Backend API error';
        try {
          var error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (e) {}
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        throw new Error(errorMsg);
      }
      var data = await res.json();
      return data.response;
    }

    function stripJsonFences(text) {
      if (!text) return '';
      var trimmed = text.trim();
      if (trimmed.startsWith('```')) {
        trimmed = trimmed.replace(/^```[a-zA-Z]*\n?/, '').replace(/```$/, '').trim();
      }
      return trimmed;
    }

    function openUnstuckPanel(config) {
      var panel = config.source === 'goal' ? goalsUnstuckPanel : lifeUnstuckPanel;
      if (!panel) return;
      panel.innerHTML = '';
      panel.classList.add('active');

      var title = document.createElement('div');
      title.className = config.source === 'goal' ? 'goals-meta' : 'life-meta';
      title.textContent = (config.mode === 'break' ? 'Break into steps' : 'Help me start') + ' Â· ' + getAreaLabel(config.item.areaId);

      var doneInput = document.createElement('input');
      doneInput.type = 'text';
      doneInput.placeholder = 'Done definition (optional)';
      doneInput.className = config.source === 'goal' ? 'goals-input' : 'life-input';

      var roadblockSelect = document.createElement('select');
      roadblockSelect.className = config.source === 'goal' ? 'goals-input' : 'life-select';
      ['No roadblock', 'Overwhelmed', 'Too many steps', 'Low energy', 'Waiting on others', 'No time', 'Other'].forEach(function(label) {
        var opt = document.createElement('option');
        opt.value = label;
        opt.textContent = label;
        roadblockSelect.appendChild(opt);
      });

      var roadblockInput = document.createElement('input');
      roadblockInput.type = 'text';
      roadblockInput.placeholder = 'Roadblock details (optional)';
      roadblockInput.className = config.source === 'goal' ? 'goals-input' : 'life-input';

      var sizeSelect = document.createElement('select');
      sizeSelect.className = config.source === 'goal' ? 'goals-input' : 'life-select';
      ['Tiny', 'Small', 'Medium'].forEach(function(label) {
        var opt = document.createElement('option');
        opt.value = label;
        opt.textContent = 'First-step size: ' + label;
        sizeSelect.appendChild(opt);
      });

      var actionRow = document.createElement('div');
      actionRow.className = config.source === 'goal' ? 'goals-row' : 'life-row';
      var submitBtn = document.createElement('button');
      submitBtn.type = 'button';
      submitBtn.className = config.source === 'goal' ? 'goals-btn' : 'life-btn';
      submitBtn.textContent = 'Run AI';
      var closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = config.source === 'goal' ? 'goals-btn goals-btn-secondary' : 'life-btn secondary';
      closeBtn.textContent = 'Close';
      closeBtn.addEventListener('click', function() {
        panel.classList.remove('active');
        panel.innerHTML = '';
      });
      actionRow.appendChild(submitBtn);
      actionRow.appendChild(closeBtn);

      var status = document.createElement('div');
      status.className = config.source === 'goal' ? 'goals-meta' : 'life-meta';

      var results = document.createElement('div');
      results.className = config.source === 'goal' ? 'unstuck-steps' : 'unstuck-steps';

      panel.appendChild(title);
      panel.appendChild(doneInput);
      panel.appendChild(roadblockSelect);
      panel.appendChild(roadblockInput);
      panel.appendChild(sizeSelect);
      panel.appendChild(actionRow);
      panel.appendChild(status);
      panel.appendChild(results);

      submitBtn.addEventListener('click', async function() {
        status.textContent = 'Thinking...';
        results.innerHTML = '';
        var maxSteps = config.mode === 'break' ? 5 : 3;
        var prompt = [
          'Return JSON only with schema:',
          '{"stuck_reason":"string (optional, max 120 chars)","steps":[{"text":"string","minutes":number,"done_when":"string"}],"if_stuck_try":["string"]}',
          'Rules: max ' + maxSteps + ' steps, step 1 must be <= 5 minutes, no extra prose.',
          'Context:',
          'Area: ' + getAreaLabel(config.item.areaId),
          'Item: ' + (config.item.title || config.item.text || 'Untitled'),
          'Notes: ' + (config.item.note || config.item.notes || ''),
          'Target/Due: ' + (config.item.targetDate || config.item.dueDate || ''),
          'Tags: ' + ((config.item.tags || []).join(', ')),
          'Done definition: ' + doneInput.value.trim(),
          'Roadblock: ' + roadblockSelect.value + (roadblockInput.value.trim() ? ' - ' + roadblockInput.value.trim() : ''),
          'First-step size: ' + sizeSelect.value
        ].join('\n');
        try {
          var response = await callUnstuckAssistant(prompt);
          var parsed = JSON.parse(stripJsonFences(response));
          renderUnstuckResults(panel, parsed, config.item.areaId);
          status.textContent = '';
        } catch (err) {
          status.textContent = err && err.message ? err.message : 'Unable to get AI steps.';
        }
      });
    }

    function renderUnstuckResults(panel, data, areaId) {
      var results = panel.querySelector('.unstuck-steps');
      if (!results) return;
      results.innerHTML = '';
      var steps = Array.isArray(data.steps) ? data.steps : [];
      var tips = Array.isArray(data.if_stuck_try) ? data.if_stuck_try : [];
      if (data.stuck_reason) {
        var reason = document.createElement('div');
        reason.className = panel.closest('#goals-view') ? 'goals-meta' : 'life-meta';
        reason.textContent = 'Stuck reason: ' + data.stuck_reason;
        results.appendChild(reason);
      }

      var stepsLabel = document.createElement('div');
      stepsLabel.className = panel.closest('#goals-view') ? 'goals-meta' : 'life-meta';
      stepsLabel.textContent = 'Review steps';
      results.appendChild(stepsLabel);

      steps.forEach(function(step) {
        var row = document.createElement('div');
        row.className = 'unstuck-step-row';
        var textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.value = step.text || '';
        var minutesInput = document.createElement('input');
        minutesInput.type = 'number';
        minutesInput.min = '1';
        minutesInput.max = '180';
        minutesInput.value = step.minutes || 5;
        row.appendChild(textInput);
        row.appendChild(minutesInput);
        results.appendChild(row);

        var doneWhen = document.createElement('input');
        doneWhen.type = 'text';
        doneWhen.value = step.done_when || '';
        doneWhen.placeholder = 'Done when...';
        doneWhen.className = panel.closest('#goals-view') ? 'goals-input' : 'life-input';
        results.appendChild(doneWhen);
      });

      if (tips.length) {
        var tipsLabel = document.createElement('div');
        tipsLabel.className = panel.closest('#goals-view') ? 'goals-meta' : 'life-meta';
        tipsLabel.textContent = 'If stuck, try';
        results.appendChild(tipsLabel);
        tips.forEach(function(tip) {
          var tipInput = document.createElement('input');
          tipInput.type = 'text';
          tipInput.value = tip || '';
          tipInput.className = panel.closest('#goals-view') ? 'goals-input' : 'life-input';
          results.appendChild(tipInput);
        });
      }

      var addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = panel.closest('#goals-view') ? 'goals-btn' : 'life-btn';
      addBtn.textContent = 'Add to short-term checklist';
      addBtn.addEventListener('click', function() {
        var stepRows = results.querySelectorAll('.unstuck-step-row');
        var newGoals = [];
        stepRows.forEach(function(row) {
          var textInput = row.querySelector('input[type="text"]');
          if (!textInput || !textInput.value.trim()) return;
          newGoals.push({
            id: generateGoalId('short'),
            text: textInput.value.trim(),
            done: false,
            areaId: areaId || getDefaultAreaId(),
            ownerName: getAreaOwnerName(areaId),
            personId: activePersonId || null,
            createdAt: Date.now(),
            completedAt: null
          });
        });
        if (!newGoals.length) return;
        goalsShort = newGoals.concat(goalsShort);
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
      });
      results.appendChild(addBtn);
    }

    // SETTINGS MANAGEMENT
    let settings = {
      frictionMode: 'full', // 'off', 'light', 'full'
      messageDelay: 0, // 0, 5, 15, 30, 45 seconds
      allowCancelDelay: true,
      showShortTermGoal: true,
      showLongTermGoal: true,
      lockUntil: null
    };

    function loadSettings() {
      var saved = localStorage.getItem('friction_settings');
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          settings = Object.assign(settings, parsed);
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function saveSettings() {
      localStorage.setItem('friction_settings', JSON.stringify(settings));
      // Sync to server (debounced)
      saveUserDataToServer();
    }

    function isSettingsLocked() {
      if (!settings.lockUntil) return false;
      return Date.now() < settings.lockUntil;
    }

    function getRemainingLockTime() {
      if (!settings.lockUntil) return 0;
      return Math.max(0, settings.lockUntil - Date.now());
    }

    function formatLockTime(ms) {
      var totalSeconds = Math.floor(ms / 1000);
      var hours = Math.floor(totalSeconds / 3600);
      var minutes = Math.floor((totalSeconds % 3600) / 60);
      var seconds = totalSeconds % 60;
      return String(hours).padStart(2, '0') + ':' + 
             String(minutes).padStart(2, '0') + ':' + 
             String(seconds).padStart(2, '0');
    }

    function showSettings() {
      loadSettings();
      
      var overlay = document.getElementById('settingsOverlay');
      var content = document.getElementById('settingsContent');
      var lockBanner = document.getElementById('settingsLockBanner');
      
      // Set current values in form
      document.querySelector('input[name="frictionMode"][value="' + settings.frictionMode + '"]').checked = true;
      document.querySelector('input[name="messageDelay"][value="' + settings.messageDelay + '"]').checked = true;
      document.getElementById('allowCancelDelay').checked = settings.allowCancelDelay;
      document.getElementById('showShortTermGoal').checked = settings.showShortTermGoal;
      document.getElementById('showLongTermGoal').checked = settings.showLongTermGoal;
      
      // Update delay section based on friction mode
      updateDelayAvailability();
      
      // Check if locked
      if (isSettingsLocked()) {
        content.classList.add('locked');
        lockBanner.style.display = 'flex';
        updateLockTimer();
      } else {
        content.classList.remove('locked');
        lockBanner.style.display = 'none';
      }
      
      overlay.classList.add('active');
    }

    function updateDelayAvailability() {
      var frictionMode = document.querySelector('input[name="frictionMode"]:checked').value;
      var delayOptions = document.getElementById('delayOptions');
      var delayNote = document.getElementById('delayDisabledNote');
      
      if (frictionMode === 'full' || frictionMode === 'strict') {
        delayOptions.classList.add('disabled');
        delayNote.style.display = 'block';
        // Reset delay to off when using code friction
        settings.messageDelay = 0;
        document.querySelector('input[name="messageDelay"][value="0"]').checked = true;
        saveSettings();
      } else {
        delayOptions.classList.remove('disabled');
        delayNote.style.display = 'none';
      }
    }

    function hideSettings() {
      document.getElementById('settingsOverlay').classList.remove('active');
    }

    var lockTimerInterval = null;

    function updateLockTimer() {
      var remaining = getRemainingLockTime();
      var timeEl = document.getElementById('lockTimeRemaining');
      
      if (remaining <= 0) {
        settings.lockUntil = null;
        saveSettings();
        document.getElementById('settingsContent').classList.remove('locked');
        document.getElementById('settingsLockBanner').style.display = 'none';
        if (lockTimerInterval) {
          clearInterval(lockTimerInterval);
          lockTimerInterval = null;
        }
        return;
      }
      
      timeEl.textContent = formatLockTime(remaining);
      
      if (!lockTimerInterval) {
        lockTimerInterval = setInterval(updateLockTimer, 1000);
      }
    }

    function lockSettings() {
      var days = parseInt(document.getElementById('lockDays').value, 10) || 0;
      var hours = parseInt(document.getElementById('lockHours').value, 10) || 0;
      var minutes = parseInt(document.getElementById('lockMinutes').value, 10) || 0;
      
      var duration = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
      
      if (duration < 60000) {
        alert('Please set a lock duration of at least 1 minute.');
        return;
      }
      
      settings.lockUntil = Date.now() + duration;
      saveSettings();
      
      document.getElementById('settingsContent').classList.add('locked');
      document.getElementById('settingsLockBanner').style.display = 'flex';
      updateLockTimer();
    }

    // MESSAGE DELAY OVERLAY
    var delayInterval = null;
    var delayMessage = null;

    function showDelayOverlay(message) {
      delayMessage = message;
      var overlay = document.getElementById('delayOverlay');
      var timeEl = document.getElementById('delayTime');
      var progressEl = document.getElementById('delayRingProgress');
      var hintEl = document.getElementById('delayHint');
      var cancelBtn = document.getElementById('delayCancelBtn');
      
      var totalSeconds = settings.messageDelay;
      var remaining = totalSeconds;
      
      // Set hint based on goal
      var activeGoal = getActiveShortTermGoal();
      if (activeGoal) {
        hintEl.textContent = 'While you wait... "' + activeGoal.text + '"';
      } else {
        hintEl.textContent = 'Take a breath. Is this message necessary?';
      }
      
      // Show/hide cancel button
      if (settings.allowCancelDelay) {
        cancelBtn.classList.remove('hidden');
      } else {
        cancelBtn.classList.add('hidden');
      }
      
      // Set initial state
      timeEl.textContent = remaining;
      progressEl.style.strokeDashoffset = '0';
      
      overlay.classList.add('active');
      
      delayInterval = setInterval(function() {
        remaining--;
        timeEl.textContent = remaining;
        
        // Update progress ring (283 is circumference of circle with r=45)
        var progress = ((totalSeconds - remaining) / totalSeconds) * 283;
        progressEl.style.strokeDashoffset = progress;
        
        if (remaining <= 0) {
          clearInterval(delayInterval);
          delayInterval = null;
          hideDelayOverlay();
          sendMessage(delayMessage);
          delayMessage = null;
        }
      }, 1000);
    }

    function hideDelayOverlay() {
      document.getElementById('delayOverlay').classList.remove('active');
      if (delayInterval) {
        clearInterval(delayInterval);
        delayInterval = null;
      }
    }

    function cancelDelay() {
      hideDelayOverlay();
      delayMessage = null;
    }

    // AUTH STATE
    const GOOGLE_CLIENT_ID = '37442638167-t8m3fql61v05h01qmvall1bki9k88tim.apps.googleusercontent.com';
    const ADMIN_EMAIL = 'fatboydimsim@gmail.com';
    
    let currentUser = null;
    let isAdmin = false;

    // Free models available to everyone, paid models only for admin
    const FREE_MODELS = ['gemini'];
    const PAID_MODELS = ['claude', 'gpt', 'grok', 'perplexity'];

    function loadUserFromStorage() {
      const saved = localStorage.getItem('friction_user');
      if (saved) {
        currentUser = JSON.parse(saved);
        isAdmin = currentUser.email === ADMIN_EMAIL;
        return true;
      }
      return false;
    }

    function saveUserToStorage() {
      if (currentUser) {
        localStorage.setItem('friction_user', JSON.stringify(currentUser));
      } else {
        localStorage.removeItem('friction_user');
      }
    }

    async function handleGoogleSignIn(response) {
      // Decode the JWT token
      const base64Url = response.credential.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const padded = base64 + '==='.slice((base64.length + 3) % 4);
      const payload = JSON.parse(atob(padded));

      currentUser = {
        email: payload.email,
        name: payload.name,
        picture: payload.picture
      };

      // Store the ID token for API authentication
      localStorage.setItem('google_id_token', response.credential);

      isAdmin = currentUser.email === ADMIN_EMAIL;
      saveUserToStorage();

      // Register user with backend (for analytics)
      registerUser(response.credential);

      // Load user data from server (restores chat history, settings, etc.)
      await loadUserDataFromServer();

      // Now update UI with restored data
      updateModelAccess();
      updateProfileDisplay();
      updateMenuForAdmin();

      showChat();
    }

    function registerUser(idToken) {
      fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        }
      }).catch(function(err) {
        console.log('User registration skipped:', err);
      });
    }

    // SERVER DATA SYNC
    async function loadUserDataFromServer() {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) return false;

      try {
        var response = await fetch('/api/user/data', {
          method: 'GET',
          headers: {
            'Authorization': 'Bearer ' + idToken
          }
        });

        if (!response.ok) return false;

        var result = await response.json();
        if (result.data) {
          // Restore chat history
          if (result.data.chat) {
            localStorage.setItem('friction_chat', JSON.stringify(result.data.chat));
          }
          // Restore goals
          if (result.data.goals) {
            localStorage.setItem('friction_goals', JSON.stringify(result.data.goals));
          }
          // Restore settings
          if (result.data.settings) {
            localStorage.setItem('friction_settings', JSON.stringify(result.data.settings));
          }
          // Restore chat history list
          if (result.data.history) {
            localStorage.setItem('friction_history', JSON.stringify(result.data.history));
          }
          // Restore friction state
          if (result.data.frictionState) {
            localStorage.setItem('friction_state', JSON.stringify(result.data.frictionState));
          }
          console.log('User data loaded from server');
          return true;
        }
        return false;
      } catch (err) {
        console.log('Failed to load user data from server:', err);
        return false;
      }
    }

    function saveUserDataToServer() {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) return;

      // Debounce saves to avoid too many requests
      if (window.saveDataTimeout) {
        clearTimeout(window.saveDataTimeout);
      }

      window.saveDataTimeout = setTimeout(function() {
        var data = {};

        // Collect all data from localStorage
        var chat = localStorage.getItem('friction_chat');
        if (chat) data.chat = JSON.parse(chat);

        var goals = localStorage.getItem('friction_goals');
        if (goals) data.goals = JSON.parse(goals);

        var settings = localStorage.getItem('friction_settings');
        if (settings) data.settings = JSON.parse(settings);

        var history = localStorage.getItem('friction_history');
        if (history) data.history = JSON.parse(history);

        var frictionState = localStorage.getItem('friction_state');
        if (frictionState) data.frictionState = JSON.parse(frictionState);

        fetch('/api/user/data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + idToken
          },
          body: JSON.stringify(data)
        }).then(function() {
          console.log('User data saved to server');
        }).catch(function(err) {
          console.log('Failed to save user data to server:', err);
        });
      }, 2000); // Wait 2 seconds before saving to debounce
    }

    function signOut() {
      currentUser = null;
      isAdmin = false;
      localStorage.removeItem('friction_user');
      localStorage.removeItem('google_id_token');
      google.accounts.id.disableAutoSelect();
      updateModelAccess();
      showHomepage();
    }

    function updateMenuForAdmin() {
      var adminBtn = document.getElementById('btnAdmin');
      if (adminBtn) {
        adminBtn.style.display = isAdmin ? 'flex' : 'none';
      }
    }

    function updateModelAccess() {
      const options = modelSelect.querySelectorAll('option');
      options.forEach(function(option) {
        const model = option.value;
        if (PAID_MODELS.includes(model) && !isAdmin) {
          option.disabled = true;
          option.textContent = option.textContent.replace(' ðŸ”’', '') + ' ðŸ”’';
        } else {
          option.disabled = false;
          option.textContent = option.textContent.replace(' ðŸ”’', '');
        }
      });

      // If current selection is a paid model and user is not admin, switch to Gemini
      if (PAID_MODELS.includes(modelSelect.value) && !isAdmin) {
        modelSelect.value = 'gemini';
      }
    }

    function initGoogleSignIn() {
      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleGoogleSignIn,
          auto_select: false
        });

        // Render a hidden Google button that we'll click programmatically
        google.accounts.id.renderButton(
          document.getElementById('googleButtonHidden'),
          { theme: 'outline', size: 'large', width: 280 }
        );

        // Check if user already signed in - auto go to chat
        if (loadUserFromStorage()) {
          updateModelAccess();
          updateProfileDisplay();
          showChat();
        } else if (isCalendarImportRoute()) {
          showChat();
        }
        
        // Reveal UI after state is known
        document.body.classList.add('ready');
      } else {
        // Retry if Google script not loaded yet
        setTimeout(initGoogleSignIn, 100);
      }
    }

    // Fallback: reveal UI after timeout in case Google script fails
    setTimeout(function() {
      document.body.classList.add('ready');
      if (isCalendarImportRoute() && chatApp && !chatApp.classList.contains('active')) {
        showChat();
      }
    }, 1000);

    initGoogleSignIn();

    // DOM ELEMENTS
    const homepage = document.getElementById('homepage');
    const chatApp = document.getElementById('chatApp');
    const btnApple = document.getElementById('btnApple');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnEmail = document.getElementById('btnEmail');

    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const btnSend = document.getElementById('btnSend');
    const modelSelect = document.getElementById('modelSelect');
    const btnMenu = document.getElementById('btnMenu');
    const typingIndicator = document.getElementById('typingIndicator');

    // Side menu elements
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const btnCloseMenu = document.getElementById('btnCloseMenu');
    const btnNewChat = document.getElementById('btnNewChat');
    const btnSignOut = document.getElementById('btnSignOut');
    const btnSettings = document.getElementById('btnSettings');
    const btnAbout = document.getElementById('btnAbout');
    const btnGoals = document.getElementById('btnGoals');
    const btnLife = document.getElementById('btnLife');
    const btnCalendar = document.getElementById('btnCalendar');
    const btnFrictionSocial = document.getElementById('btnFrictionSocial');
    const chatInputArea = document.querySelector('.chat-input-area');

    // Friction Social elements
    const frictionSocialView = document.getElementById('friction-social-view');
    const frictionSocialShelves = document.getElementById('fsShelves');
    const frictionSocialSearch = document.getElementById('fsSearchInput');
    const frictionSocialAdd = document.getElementById('fsAddVideo');
    const frictionSocialAddChannel = document.getElementById('fsAddChannel');
    const frictionSocialRefresh = document.getElementById('fsRefreshChannels');
    const frictionSocialEmpty = document.getElementById('fsEmpty');
    const frictionSocialModal = document.getElementById('fsModal');
    const frictionSocialModalClose = document.getElementById('fsModalClose');
    const frictionSocialModalTitle = document.getElementById('fsModalTitle');
    const frictionSocialModalChannel = document.getElementById('fsModalChannel');
    const frictionSocialModalLink = document.getElementById('fsModalLink');
    const frictionSocialModalFrame = document.getElementById('fsModalFrame');
    const frictionSocialIntroOverlay = document.getElementById('fsIntroOverlay');
    const frictionSocialIntroDismiss = document.getElementById('fsIntroDismiss');
    const frictionSocialIntroContinue = document.getElementById('fsIntroContinue');
    const frictionSocialPauseOverlay = document.getElementById('fsPauseOverlay');
    const frictionSocialPauseTitle = document.getElementById('fsPauseTitle');
    const frictionSocialPausePrompt = document.getElementById('fsPausePrompt');
    const frictionSocialPauseTimer = document.getElementById('fsPauseTimer');
    const frictionSocialPauseWatch = document.getElementById('fsPauseWatch');
    const frictionSocialPauseTake = document.getElementById('fsPauseTake');
    const frictionSocialPauseUpNext = document.getElementById('fsPauseUpNext');
    const frictionSocialPauseSkip = document.getElementById('fsPauseSkip');
    const frictionSocialPauseDone = document.getElementById('fsPauseDone');
    const frictionSocialPauseUpNextPanel = document.getElementById('fsPauseUpNextPanel');
    const frictionSocialPauseGoalText = document.getElementById('fsPauseGoalText');
    const frictionSocialPauseGoalDone = document.getElementById('fsPauseGoalDone');
    const frictionSocialPauseContinue = document.getElementById('fsPauseContinue');
    const frictionSocialFrictionEnabled = document.getElementById('fsFrictionEnabled');
    const frictionSocialFrequencyInputs = document.querySelectorAll('input[name="fsFrictionFrequency"]');
    const frictionSocialPauseInputs = document.querySelectorAll('input[name="fsPauseSeconds"]');
    const goalsView = document.getElementById('goals-view');
    const lifeView = document.getElementById('life-view');
    const calendarView = document.getElementById('calendar-view');
    const calendarImportView = document.getElementById('calendar-import-view');
    const goalsAreaFilter = document.getElementById('goalsAreaFilter');
    const shortGoalInput = document.getElementById('shortGoalInput');
    const shortGoalAdd = document.getElementById('shortGoalAdd');
    const shortGoalList = document.getElementById('shortGoalList');
    const shortGoalClear = document.getElementById('shortGoalClear');
    const shortGoalArea = document.getElementById('shortGoalArea');
    const longGoalForm = document.getElementById('longGoalForm');
    const longGoalTitle = document.getElementById('longGoalTitle');
    const longGoalDate = document.getElementById('longGoalDate');
    const longGoalNote = document.getElementById('longGoalNote');
    const longGoalAdd = document.getElementById('longGoalAdd');
    const longGoalCancel = document.getElementById('longGoalCancel');
    const longGoalList = document.getElementById('longGoalList');
    const longGoalArea = document.getElementById('longGoalArea');
    const goalsUnstuckPanel = document.getElementById('goalsUnstuckPanel');
    const goalsNudge = document.getElementById('goalsNudge');
    const goalsNudgeBtn = document.getElementById('goalsNudgeBtn');

    const lifeAreaFilter = document.getElementById('lifeAreaFilter');
    const lifeTabs = document.getElementById('lifeTabs');
    const lifeAddPersonPrimary = document.getElementById('lifeAddPersonPrimary');
    const lifePeopleForm = document.getElementById('lifePeopleForm');
    const lifePeopleFormTitle = document.getElementById('lifePeopleFormTitle');
    const lifePeopleFormCancel = document.getElementById('lifePeopleFormCancel');
    const lifePeopleSave = document.getElementById('lifePeopleSave');
    const lifePeopleList = document.getElementById('lifePeopleList');
    const lifePersonName = document.getElementById('lifePersonName');
    const lifePersonRole = document.getElementById('lifePersonRole');
    const lifePersonCustomRole = document.getElementById('lifePersonCustomRole');
    const lifePersonOrg = document.getElementById('lifePersonOrg');
    const lifePersonDob = document.getElementById('lifePersonDob');
    const lifePersonNotes = document.getElementById('lifePersonNotes');
    const lifeAvatarUpload = document.getElementById('lifeAvatarUpload');
    const lifeAvatarRandom = document.getElementById('lifeAvatarRandom');
    const lifeAvatarPreview = document.getElementById('lifeAvatarPreview');
    const lifeAvatarHint = document.getElementById('lifeAvatarHint');
    const lifePersonView = document.getElementById('lifePersonView');
    const lifePersonBack = document.getElementById('lifePersonBack');
    const lifePersonAvatar = document.getElementById('lifePersonAvatar');
    const lifePersonNameDisplay = document.getElementById('lifePersonNameDisplay');
    const lifePersonRoleDisplay = document.getElementById('lifePersonRoleDisplay');
    const lifePersonOrgDisplay = document.getElementById('lifePersonOrgDisplay');
    const lifeAppointmentsToggle = document.getElementById('lifeAppointmentsToggle');
    const lifeAppointmentsBody = document.getElementById('lifeAppointmentsBody');
    const lifeAppointmentsAdd = document.getElementById('lifeAppointmentsAdd');
    const lifeAppointmentsList = document.getElementById('lifeAppointmentsList');
    const lifeAppointmentsPastToggle = document.getElementById('lifeAppointmentsPastToggle');
    const lifeAppointmentsPast = document.getElementById('lifeAppointmentsPast');
    const lifeAppointmentModal = document.getElementById('lifeAppointmentModal');
    const lifeAppointmentForm = document.getElementById('lifeAppointmentForm');
    const lifeAppointmentPersonRow = document.getElementById('lifeAppointmentPersonRow');
    const lifeAppointmentPerson = document.getElementById('lifeAppointmentPerson');
    const lifeAppointmentTitle = document.getElementById('lifeAppointmentModalTitle');
    const lifeAppointmentTitleInput = document.getElementById('lifeAppointmentTitleInput');
    const lifeAppointmentDate = document.getElementById('lifeAppointmentDate');
    const lifeAppointmentTime = document.getElementById('lifeAppointmentTime');
    const lifeAppointmentClinic = document.getElementById('lifeAppointmentClinic');
    const lifeAppointmentDoctor = document.getElementById('lifeAppointmentDoctor');
    const lifeAppointmentAddress = document.getElementById('lifeAppointmentAddress');
    const lifeAppointmentPhone = document.getElementById('lifeAppointmentPhone');
    const lifeAppointmentNotes = document.getElementById('lifeAppointmentNotes');
    const lifeAppointmentSave = document.getElementById('lifeAppointmentSave');
    const lifeAppointmentDelete = document.getElementById('lifeAppointmentDelete');
    const lifeAppointmentClose = document.getElementById('lifeAppointmentClose');
    const lifeAgendaRange = document.getElementById('lifeAgendaRange');
    const lifeAgendaList = document.getElementById('lifeAgendaList');
    const lifePersonNowList = document.getElementById('lifePersonNowList');
    const lifePersonComingList = document.getElementById('lifePersonComingList');
    const lifePersonParkedList = document.getElementById('lifePersonParkedList');
    const lifePersonParkedToggle = document.getElementById('lifePersonParkedToggle');
    const lifePersonTaskText = document.getElementById('lifePersonTaskText');
    const lifePersonTaskAdd = document.getElementById('lifePersonTaskAdd');
    const lifePersonApptTitle = document.getElementById('lifePersonApptTitle');
    const lifePersonApptStart = document.getElementById('lifePersonApptStart');
    const lifePersonApptAdd = document.getElementById('lifePersonApptAdd');
    const lifePersonGoalText = document.getElementById('lifePersonGoalText');
    const lifePersonGoalAdd = document.getElementById('lifePersonGoalAdd');
    const lifeTodayList = document.getElementById('lifeTodayList');
    const lifeGoalsList = document.getElementById('lifeGoalsList');
    const lifeTaskText = document.getElementById('lifeTaskText');
    const lifeTaskArea = document.getElementById('lifeTaskArea');
    const lifeTaskTags = document.getElementById('lifeTaskTags');
    const lifeTaskDue = document.getElementById('lifeTaskDue');
    const lifeTaskNeedsPeople = document.getElementById('lifeTaskNeedsPeople');
    const lifeTaskNeedsAppt = document.getElementById('lifeTaskNeedsAppt');
    const lifeTaskEnergy = document.getElementById('lifeTaskEnergy');
    const lifeTaskAdd = document.getElementById('lifeTaskAdd');
    const lifeTaskCancel = document.getElementById('lifeTaskCancel');
    const lifeTaskList = document.getElementById('lifeTaskList');
    const lifeUnstuckPanel = document.getElementById('lifeUnstuckPanel');
    const lifeApptTitle = document.getElementById('lifeApptTitle');
    const lifeApptArea = document.getElementById('lifeApptArea');
    const lifeApptStart = document.getElementById('lifeApptStart');
    const lifeApptEnd = document.getElementById('lifeApptEnd');
    const lifeApptLocation = document.getElementById('lifeApptLocation');
    const lifeApptNotes = document.getElementById('lifeApptNotes');
    const lifeApptLinkedTasks = document.getElementById('lifeApptLinkedTasks');
    const lifeApptAdd = document.getElementById('lifeApptAdd');
    const lifeApptCancel = document.getElementById('lifeApptCancel');
    const lifeCalendarList = document.getElementById('lifeCalendarList');
    const lifeFrictionEnabled = document.getElementById('lifeFrictionEnabled');
    const lifeChildName = document.getElementById('lifeChildName');
    const lifeAddChild = document.getElementById('lifeAddChild');
    const lifeAreasList = document.getElementById('lifeAreasList');
    const lifeFrictionFrequencyInputs = document.querySelectorAll('input[name="lifeFrictionFrequency"]');
    const lifePauseInputs = document.querySelectorAll('input[name="lifePauseSeconds"]');

    const appointmentsView = document.getElementById('appointments-view');
    const appointmentsAddGlobal = document.getElementById('appointmentsAddGlobal');
    const appointmentsFilters = document.getElementById('appointmentsFilters');
    const appointmentsFeed = document.getElementById('appointmentsFeed');
    const appointmentsPastToggle = document.getElementById('appointmentsPastToggle');
    const appointmentsPastFeed = document.getElementById('appointmentsPastFeed');
    const appointmentsModal = document.getElementById('appointmentsModal');
    const appointmentsModalTitle = document.getElementById('appointmentsModalTitle');
    const appointmentsModalForm = document.getElementById('appointmentsModalForm');
    const appointmentsModalPerson = document.getElementById('appointmentsModalPerson');
    const appointmentsModalTitleInput = document.getElementById('appointmentsModalTitleInput');
    const appointmentsModalDate = document.getElementById('appointmentsModalDate');
    const appointmentsModalTime = document.getElementById('appointmentsModalTime');
    const appointmentsModalClinic = document.getElementById('appointmentsModalClinic');
    const appointmentsModalDoctor = document.getElementById('appointmentsModalDoctor');
    const appointmentsModalAddress = document.getElementById('appointmentsModalAddress');
    const appointmentsModalPhone = document.getElementById('appointmentsModalPhone');
    const appointmentsModalNotes = document.getElementById('appointmentsModalNotes');
    const appointmentsModalSave = document.getElementById('appointmentsModalSave');
    const appointmentsModalDelete = document.getElementById('appointmentsModalDelete');
    const appointmentsModalClose = document.getElementById('appointmentsModalClose');
    const appointmentsScanTake = document.getElementById('appointmentsScanTake');
    const appointmentsScanUpload = document.getElementById('appointmentsScanUpload');
    const appointmentsScanTakeInput = document.getElementById('appointmentsScanTakeInput');
    const appointmentsScanUploadInput = document.getElementById('appointmentsScanUploadInput');
    const appointmentsScanPreview = document.getElementById('appointmentsScanPreview');
    const appointmentsScanImage = document.getElementById('appointmentsScanImage');
    const appointmentsTextInput = document.getElementById('appointmentsTextInput');
    const appointmentsParseBtn = document.getElementById('appointmentsParseBtn');
    const appointmentsAiBtn = document.getElementById('appointmentsAiBtn');
    const appointmentsOriginalDetails = document.getElementById('appointmentsOriginalDetails');
    const appointmentsOriginalText = document.getElementById('appointmentsOriginalText');

    if (lifeAppointmentModal) {
      appointmentModalContexts.life = {
        source: 'life',
        modal: lifeAppointmentModal,
        form: lifeAppointmentForm,
        personRow: lifeAppointmentPersonRow,
        personSelect: lifeAppointmentPerson,
        title: lifeAppointmentTitle,
        titleInput: lifeAppointmentTitleInput,
        dateInput: lifeAppointmentDate,
        timeInput: lifeAppointmentTime,
        clinicInput: lifeAppointmentClinic,
        doctorInput: lifeAppointmentDoctor,
        addressInput: lifeAppointmentAddress,
        phoneInput: lifeAppointmentPhone,
        notesInput: lifeAppointmentNotes,
        saveBtn: lifeAppointmentSave,
        deleteBtn: lifeAppointmentDelete,
        closeBtn: lifeAppointmentClose
      };
    }

    if (appointmentsModal) {
      appointmentModalContexts.calendar = {
        source: 'calendar',
        modal: appointmentsModal,
        form: appointmentsModalForm,
        personRow: null,
        personSelect: appointmentsModalPerson,
        title: appointmentsModalTitle,
        titleInput: appointmentsModalTitleInput,
        dateInput: appointmentsModalDate,
        timeInput: appointmentsModalTime,
        clinicInput: appointmentsModalClinic,
        doctorInput: appointmentsModalDoctor,
        addressInput: appointmentsModalAddress,
        phoneInput: appointmentsModalPhone,
        notesInput: appointmentsModalNotes,
        saveBtn: appointmentsModalSave,
        deleteBtn: appointmentsModalDelete,
        closeBtn: appointmentsModalClose,
        scanTakeBtn: appointmentsScanTake,
        scanUploadBtn: appointmentsScanUpload,
        scanTakeInput: appointmentsScanTakeInput,
        scanUploadInput: appointmentsScanUploadInput,
        scanPreview: appointmentsScanPreview,
        scanImage: appointmentsScanImage,
        textInput: appointmentsTextInput,
        parseBtn: appointmentsParseBtn,
        aiBtn: appointmentsAiBtn,
        originalDetails: appointmentsOriginalDetails,
        originalText: appointmentsOriginalText
      };
    }

    const calendarMonthLabel = document.getElementById('calendarMonthLabel');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarPrevMonth = document.getElementById('calendarPrevMonth');
    const calendarNextMonth = document.getElementById('calendarNextMonth');
    const calendarAddEvent = document.getElementById('calendarAddEvent');
    const calendarDayModal = document.getElementById('calendarDayModal');
    const calendarDayTitle = document.getElementById('calendarDayTitle');
    const calendarDaySubtitle = document.getElementById('calendarDaySubtitle');
    const calendarDayList = document.getElementById('calendarDayList');
    const calendarDayAdd = document.getElementById('calendarDayAdd');
    const calendarDayClose = document.getElementById('calendarDayClose');
    const calendarEventModal = document.getElementById('calendarEventModal');
    const calendarEventTitle = document.getElementById('calendarEventTitle');
    const calendarEventForm = document.getElementById('calendarEventForm');
    const calendarEventPerson = document.getElementById('calendarEventPerson');
    const calendarEventPersonAvatar = document.getElementById('calendarEventPersonAvatar');
    const calendarEventTitleInput = document.getElementById('calendarEventTitleInput');
    const calendarEventDate = document.getElementById('calendarEventDate');
    const calendarEventAllDay = document.getElementById('calendarEventAllDay');
    const calendarEventTimeRow = document.getElementById('calendarEventTimeRow');
    const calendarEventStart = document.getElementById('calendarEventStart');
    const calendarEventEnd = document.getElementById('calendarEventEnd');
    const calendarEventLocation = document.getElementById('calendarEventLocation');
    const calendarEventNotes = document.getElementById('calendarEventNotes');
    const calendarEventRepeat = document.getElementById('calendarEventRepeat');
    const calendarCustomWeekdays = document.getElementById('calendarCustomWeekdays');
    const calendarCustomUntil = document.getElementById('calendarCustomUntil');
    const calendarEventSave = document.getElementById('calendarEventSave');
    const calendarEventDelete = document.getElementById('calendarEventDelete');
    const calendarEventClose = document.getElementById('calendarEventClose');
    const calendarEventDirections = document.getElementById('calendarEventDirections');
    const calendarImportForm = document.getElementById('calendarImportForm');
    const calendarImportPerson = document.getElementById('calendarImportPerson');
    const calendarImportTitle = document.getElementById('calendarImportTitle');
    const calendarImportDate = document.getElementById('calendarImportDate');
    const calendarImportAllDay = document.getElementById('calendarImportAllDay');
    const calendarImportTimeRow = document.getElementById('calendarImportTimeRow');
    const calendarImportStart = document.getElementById('calendarImportStart');
    const calendarImportEnd = document.getElementById('calendarImportEnd');
    const calendarImportLocation = document.getElementById('calendarImportLocation');
    const calendarImportDirections = document.getElementById('calendarImportDirections');
    const calendarImportNotes = document.getElementById('calendarImportNotes');
    const calendarImportNotesDetails = document.getElementById('calendarImportNotesDetails');
    const calendarImportOriginalDetails = document.getElementById('calendarImportOriginalDetails');
    const calendarImportOriginal = document.getElementById('calendarImportOriginal');
    const calendarImportSave = document.getElementById('calendarImportSave');
    const calendarImportCancel = document.getElementById('calendarImportCancel');
    const calendarImportSuccess = document.getElementById('calendarImportSuccess');
    const calendarImportBack = document.getElementById('calendarImportBack');
    const calendarImportBackPerson = document.getElementById('calendarImportBackPerson');
    const calendarImportAddAnother = document.getElementById('calendarImportAddAnother');
    
    // Profile elements
    const profilePic = document.getElementById('profilePic');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');

    // Onboarding elements
    const onboardingOverlay = document.getElementById('onboardingOverlay');
    const goalCheckinOverlay = document.getElementById('goalCheckinOverlay');

    // ONBOARDING EVENT LISTENERS
    document.getElementById('onboardingNext1').addEventListener('click', function() {
      document.getElementById('onboardingStep1').classList.remove('active');
      document.getElementById('onboardingStep2').classList.add('active');
    });

    document.getElementById('onboardingBack2').addEventListener('click', function() {
      document.getElementById('onboardingStep2').classList.remove('active');
      document.getElementById('onboardingStep1').classList.add('active');
    });

    document.getElementById('onboardingNext2').addEventListener('click', function() {
      goals.longterm = document.getElementById('inputLongtermGoal').value.trim();
      document.getElementById('onboardingStep2').classList.remove('active');
      document.getElementById('onboardingStep3').classList.add('active');
    });

    document.getElementById('onboardingBack3').addEventListener('click', function() {
      document.getElementById('onboardingStep3').classList.remove('active');
      document.getElementById('onboardingStep2').classList.add('active');
    });

    document.getElementById('addShorttermGoal').addEventListener('click', function() {
      var list = document.getElementById('shorttermGoalsList');
      var input = document.createElement('input');
      input.type = 'text';
      input.className = 'shortterm-goal-input';
      input.placeholder = 'Another goal...';
      input.maxLength = 60;
      list.appendChild(input);
      input.focus();
    });

    document.getElementById('onboardingNext3').addEventListener('click', function() {
      var inputs = document.querySelectorAll('#shorttermGoalsList .shortterm-goal-input');
      goals.shortterm = [];
      inputs.forEach(function(input) {
        var text = input.value.trim();
        if (text) {
          goals.shortterm.push({ text: text, completed: false, createdAt: Date.now() });
        }
      });
      
      // Show summary
      var summary = document.getElementById('onboardingSummary');
      var html = '';
      if (goals.longterm) {
        html += '<div class="onboarding-summary-item">';
        html += '<div class="onboarding-summary-label">Long-term goal</div>';
        html += '<div class="onboarding-summary-text">"' + goals.longterm + '"</div>';
        html += '</div>';
      }
      if (goals.shortterm.length > 0) {
        html += '<div class="onboarding-summary-item">';
        html += '<div class="onboarding-summary-label">Short-term goals</div>';
        goals.shortterm.forEach(function(g) {
          html += '<div class="onboarding-summary-text">â€¢ ' + g.text + '</div>';
        });
        html += '</div>';
      }
      summary.innerHTML = html || '<p>No goals set - you can add them later from the menu.</p>';
      
      document.getElementById('onboardingStep3').classList.remove('active');
      document.getElementById('onboardingStep4').classList.add('active');
    });

    document.getElementById('onboardingFinish').addEventListener('click', function() {
      goals.onboardingComplete = true;
      goals.lastGoalCheck = Date.now();
      goals.lastGoalTick = Date.now();
      saveGoals();
      hideOnboarding();
      updateBackgroundGoal();
    });

    // Goal check-in listeners
    document.getElementById('checkinSkip').addEventListener('click', function() {
      goals.lastGoalCheck = Date.now();
      saveGoals();
      hideGoalCheckin();
    });

    document.getElementById('checkinSave').addEventListener('click', function() {
      // Remove completed goals and prompt for new ones if all done
      var hasIncomplete = goals.shortterm.some(function(g) { return !g.completed; });
      
      goals.lastGoalCheck = Date.now();
      goals.lastGoalTick = Date.now();
      saveGoals();
      hideGoalCheckin();
      
      if (!hasIncomplete) {
        // All goals completed - could prompt for new ones
        // For now just clear completed and let them add via menu
        goals.shortterm = goals.shortterm.filter(function(g) { return !g.completed; });
        saveGoals();
      }
    });

    function updateProfileDisplay() {
      if (currentUser) {
        profilePic.src = currentUser.picture || '';
        profilePic.style.display = currentUser.picture ? 'block' : 'none';
        profileName.textContent = currentUser.name || 'User';
        profileEmail.textContent = currentUser.email || '';
        reconcileAccountHolderFlags();
        renderPeopleOverview();
        if (typeof renderCalendarPeopleOptions === 'function') {
          renderCalendarPeopleOptions();
        }
      }
    }

    const frictionOverlay = document.getElementById('frictionOverlay');
    const frictionPairs1 = document.getElementById('frictionPairs1');
    const frictionPairs2 = document.getElementById('frictionPairs2');
    const frictionCancel = document.getElementById('frictionCancel');
    const frictionUnlock = document.getElementById('frictionUnlock');
    const frictionError = document.getElementById('frictionError');

    // SCROLL LOCK
    let _scrollYBeforeLock = 0;

    function lockBodyScroll() {
      if (document.body.classList.contains('scroll-locked')) return;
      _scrollYBeforeLock = window.scrollY || 0;
      document.body.classList.add('scroll-locked');
      document.body.style.top = '-' + _scrollYBeforeLock + 'px';
    }

    function unlockBodyScroll() {
      if (!document.body.classList.contains('scroll-locked')) return;
      document.body.classList.remove('scroll-locked');
      document.body.style.top = '';
      window.scrollTo(0, _scrollYBeforeLock || 0);
    }

    function preventTouchMove(e) {
      const box = document.querySelector('.friction-box');
      if (box && box.contains(e.target)) return;
      e.preventDefault();
    }

    // CODE GENERATION
    function generateChallenge(length) {
      const lower = 'abcdefghjkmnpqrstuvwxyz';
      const upper = 'ABCDEFGHJKMNPQRSTUVWXYZ';
      const numbers = '23456789';
      const symbols = '!@#$%&*^~+-=<>?';

      let result = '';
      for (let i = 0; i < length; i++) {
        const pattern = i % 4;
        let charSet;
        if (pattern === 0) charSet = lower;
        else if (pattern === 1) charSet = symbols;
        else if (pattern === 2) charSet = upper;
        else charSet = numbers;
        result += charSet.charAt(Math.floor(Math.random() * charSet.length));
      }
      return result;
    }

    // NAVIGATION
    function restoreChatUI() {
      if (state.messages.length > 0) {
        // Remove welcome message
        const welcome = chatMessages.querySelector('.welcome-message');
        if (welcome) welcome.remove();
        
        // Clear existing messages (except typing indicator)
        const existingMessages = chatMessages.querySelectorAll('.message');
        existingMessages.forEach(function(msg) { msg.remove(); });
        
        // Render all saved messages
        state.messages.forEach(function(msg) {
          const type = msg.role === 'assistant' ? 'ai' : 'user';
          addMessage(msg.content, type);
        });
      }
      
      // Restore model selection
      if (state.currentModel && modelSelect) {
        modelSelect.value = state.currentModel;
      }
    }

    function showChat() {
      // Load saved chat before showing
      loadChatState();
      loadGoals();
      loadSettings();
      
      // Check if session has expired (2 hours = same as friction reset)
      const SESSION_TIMEOUT = 2 * 60 * 60 * 1000; // 2 hours
      const lastActivity = localStorage.getItem('friction_last_activity');
      
      if (lastActivity) {
        const elapsed = Date.now() - parseInt(lastActivity, 10);
        if (elapsed > SESSION_TIMEOUT && state.messages.length > 0) {
          // Save current chat to history before clearing
          saveCurrentChatToHistory();
          // Start fresh
          state.messages = [];
          state.currentChatId = generateChatId();
          localStorage.removeItem('friction_chat');
        }
      }
      
      // Update last activity
      localStorage.setItem('friction_last_activity', Date.now().toString());
      
      homepage.classList.add('hidden');
      chatApp.classList.add('active');

      setActiveView(getViewFromLocation(), false);
      
      // Restore chat messages (or show welcome if empty)
      if (state.messages.length > 0) {
        restoreChatUI();
      }
      
      // Check if onboarding needed
      if (shouldShowOnboarding()) {
        showOnboarding();
      } else if (shouldShowGoalCheckin()) {
        showGoalCheckin();
      }
      
      // Update background goal
      updateBackgroundGoal();
      
      if (lastMessageTime && frictionLevel > 0) startHeaderTimer();
      updateKeyboardOffset();
      scrollChatToBottom();
    }

    function showHomepage() {
      chatApp.classList.remove('active');
      homepage.classList.remove('hidden');
      clearChatState();
      chatMessages.innerHTML = '<div class="chat-background-goal" id="chatBackgroundGoal"></div><div class="welcome-message"><div class="welcome-icon">âœ¦</div><h2>How can I help you today?</h2><p>Remember: slow is intentional.</p></div>';
      document.documentElement.style.setProperty('--kb', '0px');
    }

    // VIEW NAVIGATION
    var activeView = 'chat';

    function getViewFromLocation() {
      if (isCalendarImportRoute()) return 'calendar-import';
      if (window.location.hash === '#friction-social') return 'social';
      if (window.location.hash === '#goals') return 'goals';
      if (window.location.hash === '#life') return 'life';
      if (window.location.hash === '#calendar') return 'calendar';
      return 'chat';
    }

    function updateMenuActive(view) {
      if (!btnFrictionSocial) return;
      if (view === 'social') {
        btnFrictionSocial.style.background = 'var(--teal-lighter)';
        btnFrictionSocial.style.color = 'var(--text-primary)';
      } else {
        btnFrictionSocial.style.background = '';
        btnFrictionSocial.style.color = '';
      }
      if (btnGoals) {
        if (view === 'goals') {
          btnGoals.style.background = 'var(--teal-lighter)';
          btnGoals.style.color = 'var(--text-primary)';
        } else {
          btnGoals.style.background = '';
          btnGoals.style.color = '';
        }
      }
      if (btnLife) {
        if (view === 'life') {
          btnLife.style.background = 'var(--teal-lighter)';
          btnLife.style.color = 'var(--text-primary)';
        } else {
          btnLife.style.background = '';
          btnLife.style.color = '';
        }
      }
      if (btnCalendar) {
        if (view === 'calendar') {
          btnCalendar.style.background = 'var(--teal-lighter)';
          btnCalendar.style.color = 'var(--text-primary)';
        } else {
          btnCalendar.style.background = '';
          btnCalendar.style.color = '';
        }
      }
    }

    function openPendingPersonFromStorage() {
      var pendingId = localStorage.getItem('life_focus_person_id');
      if (!pendingId) return;
      var person = getPersonById(pendingId);
      if (person) {
        openPersonView(person);
      }
      localStorage.removeItem('life_focus_person_id');
    }

    function setActiveView(view, pushState) {
      activeView = view;
      var showSocial = view === 'social';
      var showGoals = view === 'goals';
      var showLife = view === 'life';
      var showCalendar = view === 'calendar';
      var showCalendarImport = view === 'calendar-import';
      frictionSocialView.classList.toggle('active', showSocial);
      frictionSocialView.setAttribute('aria-hidden', showSocial ? 'false' : 'true');
      goalsView.classList.toggle('active', showGoals);
      goalsView.setAttribute('aria-hidden', showGoals ? 'false' : 'true');
      if (lifeView) {
        lifeView.classList.toggle('active', showLife);
        lifeView.setAttribute('aria-hidden', showLife ? 'false' : 'true');
      }
      if (calendarView) {
        calendarView.classList.toggle('active', showCalendar);
        calendarView.setAttribute('aria-hidden', showCalendar ? 'false' : 'true');
      }
      if (calendarImportView) {
        calendarImportView.classList.toggle('active', showCalendarImport);
        calendarImportView.setAttribute('aria-hidden', showCalendarImport ? 'false' : 'true');
      }
      var showChat = view === 'chat';
      chatMessages.style.display = showChat ? '' : 'none';
      typingIndicator.style.display = showChat ? '' : 'none';
      chatInputArea.style.display = showChat ? '' : 'none';
      updateMenuActive(view);
      if (pushState) {
        var nextHash = '#chat';
        if (view === 'social') nextHash = '#friction-social';
        if (view === 'goals') nextHash = '#goals';
        if (view === 'life') nextHash = '#life';
        if (view === 'calendar') nextHash = '#calendar';
        history.pushState({ view: view }, '', nextHash);
      }
      if (showSocial) {
        showFrictionSocialIntroIfNeeded();
      } else {
        hideFrictionSocialIntro();
        hideFrictionSocialPauseOverlay();
        if (showCalendar) {
          renderAppointmentsView();
        }
        if (showCalendarImport) {
          populateCalendarImportForm();
        }
        if (showLife) {
          openPendingPersonFromStorage();
        }
      }
    }

    window.addEventListener('popstate', function() {
      setActiveView(getViewFromLocation(), false);
    });

    btnApple.addEventListener('click', function() {
      // TODO: Apple Sign-In
      alert('Apple Sign-In coming soon!');
    });
    
    btnGoogle.addEventListener('click', function() {
      if (!window.google || !google.accounts || !google.accounts.id) {
        initGoogleSignIn();
        return;
      }
      // Click the hidden Google button to trigger sign-in
      const hiddenBtn = document.querySelector('#googleButtonHidden div[role="button"]');
      if (hiddenBtn) {
        hiddenBtn.click();
      } else {
        // Fallback: try One Tap
        google.accounts.id.prompt();
      }
    });
    
    btnEmail.addEventListener('click', function() {
      // TODO: Email Sign-In
      alert('Email Sign-In coming soon!');
    });
    
    // SIDE MENU FUNCTIONS
    function openMenu() {
      renderChatHistoryList();
      sideMenu.classList.add('active');
      menuOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      sideMenu.classList.remove('active');
      menuOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    btnMenu.addEventListener('click', openMenu);
    btnCloseMenu.addEventListener('click', closeMenu);
    menuOverlay.addEventListener('click', closeMenu);

    btnNewChat.addEventListener('click', function() {
      // Save current chat first if it has messages
      if (state.messages.length > 0) {
        saveCurrentChatToHistory();
      }
      
      // Clear current chat and start fresh
      clearChatState();
      state.currentChatId = generateChatId();
      chatMessages.innerHTML = '<div class="welcome-message"><div class="welcome-icon">âœ¦</div><h2>How can I help you today?</h2><p>Remember: slow is intentional.</p></div>';
      setActiveView('chat', true);
      closeMenu();
    });

    btnSignOut.addEventListener('click', function() {
      closeMenu();
      signOut();
    });

    btnSettings.addEventListener('click', function() {
      closeMenu();
      showSettings();
    });

    btnAbout.addEventListener('click', function() {
      // TODO: Show about page
      closeMenu();
    });

    if (btnGoals) {
      btnGoals.addEventListener('click', function() {
        closeMenu();
        setActiveView('goals', true);
      });
    }

    if (btnLife) {
      btnLife.addEventListener('click', function() {
        closeMenu();
        setActiveView('life', true);
        setLifeTab('people');
        setPersonViewActive(false);
      });
    }

    if (btnCalendar) {
      btnCalendar.addEventListener('click', function() {
        closeMenu();
        setActiveView('calendar', true);
      });
    }

    if (btnFrictionSocial) {
      btnFrictionSocial.addEventListener('click', function() {
        closeMenu();
        setActiveView('social', true);
      });
    }

    // Admin button
    var btnAdmin = document.getElementById('btnAdmin');
    if (btnAdmin) {
      btnAdmin.addEventListener('click', function() {
        closeMenu();
        window.location.href = '/admin.html';
      });
    }

    // FRICTION SOCIAL
    var FRICTION_SOCIAL_CHANNELS_KEY = 'friction_social_channels_v1';
    var FRICTION_SOCIAL_SEEN_KEY = 'friction_social_seen_v1';
    var FRICTION_SOCIAL_INTRO_KEY = 'friction_social_intro_dismissed_v1';
    var FRICTION_SOCIAL_FRICTION_ENABLED_KEY = 'friction_social_friction_enabled_v1';
    var FRICTION_SOCIAL_FRICTION_FREQUENCY_KEY = 'friction_social_friction_frequency_v1';
    var FRICTION_SOCIAL_PAUSE_SECONDS_KEY = 'friction_social_pause_seconds_v1';
    var FRICTION_SOCIAL_SESSION_WATCHED_KEY = 'friction_social_session_watched_count_v1';
    var FRICTION_SOCIAL_MIX_INDEX_KEY = 'friction_social_mix_index_v1';
    var FRICTION_SOCIAL_CHANNEL_LIMIT = 12;
    var FRICTION_SOCIAL_POOL_LIMIT = 50;
    var frictionSocialState = {
      shelves: [],
      query: ''
    };
    var frictionSocialPrefs = {
      frictionEnabled: true,
      frictionFrequency: '1',
      pauseSeconds: '60'
    };
    var frictionSocialScrollTop = 0;
    var frictionSocialMetadataCache = {};
    var frictionSocialChannels = [];
    var frictionSocialSeenMap = {};
    var frictionSocialSessionWatchedCount = 0;
    var frictionSocialActiveVideoId = null;
    var frictionSocialActiveMixIndex = null;
    var frictionSocialMixIndex = -1;
    var frictionSocialPauseTimerId = null;
    var frictionSocialPauseRemaining = 0;
    var frictionSocialUpNextTimerId = null;
    var frictionSocialUpNextRemaining = 0;
    var frictionSocialUpNextGoalIndex = null;
    var frictionSocialUpNextReady = false;
    var frictionSocialPauseTitleDefault = frictionSocialPauseTitle ? frictionSocialPauseTitle.textContent : 'Tiny pause?';
    var frictionSocialPausePrompts = [
      'What do you want from the next video?',
      'If you stop after one more, whatâ€™s next?',
      'Short-term you: what do you need right now?',
      'Long-term you: what would future-you thank you for?'
    ];

    function getFrictionSocialDefaults() {
      return [
        {
          title: 'Focus',
          videos: [
            { id: 'jfKfPfyJRdk', title: 'lofi hip hop radio - beats to relax/study to', channel: 'Lofi Girl' },
            { id: '5qap5aO4i9A', title: 'lofi hip hop radio - beats to sleep/chill to', channel: 'ChilledCow' }
          ]
        },
        {
          title: 'Perspective',
          videos: [
            { id: 'dQw4w9WgXcQ', title: 'Never Gonna Give You Up', channel: 'Rick Astley' },
            { id: 'kxopViU98Xo', title: 'Keyboard Cat', channel: 'Keyboard Cat' }
          ]
        }
      ];
    }

    function normalizeFrictionSocialChannel(channel) {
      if (!channel || !channel.channelId) return null;
      var latestVideo = channel.latestVideo || null;
      var rotationVideos = Array.isArray(channel.rotationVideos) ? channel.rotationVideos : [];
      if (!latestVideo && Array.isArray(channel.videos)) {
        latestVideo = channel.videos[0] || null;
        rotationVideos = channel.videos.slice(1);
      }
      return {
        channelId: channel.channelId,
        channelTitle: channel.channelTitle || 'Unknown channel',
        channelUrl: channel.channelUrl || '',
        addedAt: channel.addedAt || Date.now(),
        latestVideo: latestVideo,
        rotationVideos: rotationVideos,
        lastRotationAt: channel.lastRotationAt || null
      };
    }

    function loadFrictionSocialShelves() {
      var saved = localStorage.getItem('friction_social_shelves');
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            return parsed;
          }
        } catch (e) {
          return getFrictionSocialDefaults();
        }
      }
      return getFrictionSocialDefaults();
    }

    function loadFrictionSocialChannels() {
      var saved = localStorage.getItem(FRICTION_SOCIAL_CHANNELS_KEY);
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            return parsed.map(function(channel) {
              return normalizeFrictionSocialChannel(channel);
            }).filter(Boolean);
          }
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    function loadFrictionSocialSeenMap() {
      var saved = localStorage.getItem(FRICTION_SOCIAL_SEEN_KEY);
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        } catch (e) {
          return {};
        }
      }
      return {};
    }

    function loadFrictionSocialPrefs() {
      var enabled = localStorage.getItem(FRICTION_SOCIAL_FRICTION_ENABLED_KEY);
      var frequency = localStorage.getItem(FRICTION_SOCIAL_FRICTION_FREQUENCY_KEY);
      var pauseSeconds = localStorage.getItem(FRICTION_SOCIAL_PAUSE_SECONDS_KEY);
      frictionSocialPrefs.frictionEnabled = enabled !== 'false';
      frictionSocialPrefs.frictionFrequency = frequency === '2' ? '2' : '1';
      frictionSocialPrefs.pauseSeconds = pauseSeconds === '30' || pauseSeconds === '120' ? pauseSeconds : '60';
    }

    function saveFrictionSocialPrefs() {
      localStorage.setItem(FRICTION_SOCIAL_FRICTION_ENABLED_KEY, frictionSocialPrefs.frictionEnabled ? 'true' : 'false');
      localStorage.setItem(FRICTION_SOCIAL_FRICTION_FREQUENCY_KEY, frictionSocialPrefs.frictionFrequency);
      localStorage.setItem(FRICTION_SOCIAL_PAUSE_SECONDS_KEY, frictionSocialPrefs.pauseSeconds);
    }

    function applyFrictionSocialPrefsToUI() {
      if (frictionSocialFrictionEnabled) {
        frictionSocialFrictionEnabled.checked = frictionSocialPrefs.frictionEnabled;
      }
      frictionSocialFrequencyInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.frictionFrequency;
      });
      frictionSocialPauseInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.pauseSeconds;
      });
      if (lifeFrictionEnabled) {
        lifeFrictionEnabled.checked = frictionSocialPrefs.frictionEnabled;
      }
      lifeFrictionFrequencyInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.frictionFrequency;
      });
      lifePauseInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.pauseSeconds;
      });
    }

    function showFrictionSocialIntroIfNeeded() {
      if (!frictionSocialIntroOverlay) return;
      var dismissed = localStorage.getItem(FRICTION_SOCIAL_INTRO_KEY) === 'true';
      if (dismissed || frictionSocialIntroOverlay.classList.contains('active')) return;
      frictionSocialIntroOverlay.classList.add('active');
      frictionSocialIntroOverlay.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function hideFrictionSocialIntro() {
      if (!frictionSocialIntroOverlay) return;
      frictionSocialIntroOverlay.classList.remove('active');
      frictionSocialIntroOverlay.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
    }

    function getFrictionSocialPauseSeconds() {
      return parseInt(frictionSocialPrefs.pauseSeconds, 10) || 60;
    }

    function getFrictionSocialFrequency() {
      return parseInt(frictionSocialPrefs.frictionFrequency, 10) || 1;
    }

    function loadFrictionSocialMixIndex() {
      var saved = localStorage.getItem(FRICTION_SOCIAL_MIX_INDEX_KEY);
      var parsed = parseInt(saved, 10);
      return isNaN(parsed) ? -1 : parsed;
    }

    function saveFrictionSocialMixIndex(index) {
      if (typeof index !== 'number' || index < 0) return;
      frictionSocialMixIndex = index;
      localStorage.setItem(FRICTION_SOCIAL_MIX_INDEX_KEY, String(index));
    }

    function getFrictionSocialMixQueue() {
      if (!frictionSocialShelves) return [];
      var shelves = frictionSocialShelves.querySelectorAll('.fs-shelf');
      var mixShelf = null;
      shelves.forEach(function(shelf) {
        var titleEl = shelf.querySelector('.fs-shelf-title');
        var title = titleEl ? titleEl.textContent : '';
        if (title && /mix|up next/i.test(title)) {
          mixShelf = shelf;
        }
      });
      if (!mixShelf) return [];
      var cards = mixShelf.querySelectorAll('.fs-row .fs-card');
      var queue = [];
      cards.forEach(function(card) {
        var id = card.dataset.videoId;
        if (!id) return;
        queue.push({
          id: id,
          title: card.dataset.videoTitle || 'Untitled video',
          channel: card.dataset.videoChannel || '',
          publishedAt: card.dataset.videoPublishedAt || ''
        });
      });
      return queue;
    }

    function findFrictionSocialMixIndex(videoId) {
      if (!videoId) return null;
      var queue = getFrictionSocialMixQueue();
      for (var i = 0; i < queue.length; i += 1) {
        if (queue[i].id === videoId) return i;
      }
      return null;
    }

    function setFrictionSocialActiveMixIndex(videoId, preferredIndex) {
      if (typeof preferredIndex === 'number') {
        frictionSocialActiveMixIndex = preferredIndex;
        return;
      }
      var index = findFrictionSocialMixIndex(videoId);
      frictionSocialActiveMixIndex = index !== null ? index : null;
    }

    function clearFrictionSocialUpNextTimer() {
      if (frictionSocialUpNextTimerId) {
        clearInterval(frictionSocialUpNextTimerId);
        frictionSocialUpNextTimerId = null;
      }
    }

    function setFrictionSocialPauseMode(mode) {
      var isUpNext = mode === 'upnext';
      if (frictionSocialPauseUpNextPanel) {
        frictionSocialPauseUpNextPanel.classList.toggle('active', isUpNext);
      }
      if (frictionSocialPausePrompt) {
        frictionSocialPausePrompt.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseWatch) {
        frictionSocialPauseWatch.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseTake) {
        frictionSocialPauseTake.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseSkip) {
        frictionSocialPauseSkip.style.display = 'none';
      }
    }

    function getFrictionSocialUpNextGoal() {
      var goals = loadGoalsViewShort();
      var index = goals.findIndex(function(goal) {
        return goal && !goal.done;
      });
      if (index < 0) {
        return { goal: null, index: null, goals: goals };
      }
      return { goal: goals[index], index: index, goals: goals };
    }

    function renderFrictionSocialUpNextGoal() {
      if (!frictionSocialPauseGoalText) return;
      var result = getFrictionSocialUpNextGoal();
      frictionSocialUpNextGoalIndex = result.index;
      if (!result.goal) {
        frictionSocialPauseGoalText.textContent = 'No short-term goals set â€” add one anytime in Goals.';
        if (frictionSocialPauseGoalDone) {
          frictionSocialPauseGoalDone.style.display = 'none';
        }
        return;
      }
      frictionSocialPauseGoalText.textContent = 'Short-term goal: ' + result.goal.text;
      if (frictionSocialPauseGoalDone) {
        frictionSocialPauseGoalDone.style.display = 'inline-flex';
        frictionSocialPauseGoalDone.disabled = false;
      }
    }

    function markFrictionSocialUpNextGoalDone() {
      if (frictionSocialUpNextGoalIndex === null) return;
      var goals = loadGoalsViewShort();
      var goal = goals[frictionSocialUpNextGoalIndex];
      if (!goal) return;
      goal.done = true;
      goal.completedAt = Date.now();
      localStorage.setItem(GOALS_SHORT_KEY, JSON.stringify(goals));
      goalsShort = goals;
      renderShortGoals();
      renderFrictionSocialUpNextGoal();
    }

    function resetFrictionSocialUpNextState() {
      clearFrictionSocialUpNextTimer();
      frictionSocialUpNextRemaining = 0;
      frictionSocialUpNextReady = false;
      if (frictionSocialPauseContinue) {
        frictionSocialPauseContinue.disabled = true;
      }
      if (frictionSocialPauseTimer) {
        frictionSocialPauseTimer.textContent = '';
      }
      setFrictionSocialPauseMode('default');
      if (frictionSocialPauseTitle) {
        frictionSocialPauseTitle.textContent = frictionSocialPauseTitleDefault;
      }
    }

    function startFrictionSocialUpNextCountdown() {
      frictionSocialUpNextRemaining = 30;
      frictionSocialUpNextReady = false;
      if (frictionSocialPauseContinue) {
        frictionSocialPauseContinue.disabled = true;
      }
      if (frictionSocialPauseTimer) {
        frictionSocialPauseTimer.textContent = 'Up Next in ' + frictionSocialUpNextRemaining + ' seconds';
      }
      clearFrictionSocialUpNextTimer();
      frictionSocialUpNextTimerId = setInterval(function() {
        frictionSocialUpNextRemaining -= 1;
        if (frictionSocialPauseTimer) {
          frictionSocialPauseTimer.textContent = 'Up Next in ' + frictionSocialUpNextRemaining + ' seconds';
        }
        if (frictionSocialUpNextRemaining <= 0) {
          clearFrictionSocialUpNextTimer();
          frictionSocialUpNextReady = true;
          if (frictionSocialPauseTimer) {
            frictionSocialPauseTimer.textContent = 'Ready when you are.';
          }
          if (frictionSocialPauseContinue) {
            frictionSocialPauseContinue.disabled = false;
          }
        }
      }, 1000);
    }

    function startFrictionSocialUpNextFlow() {
      clearFrictionSocialPauseTimer();
      setFrictionSocialPauseMode('upnext');
      if (frictionSocialPauseTitle) {
        frictionSocialPauseTitle.textContent = 'Up Next';
      }
      renderFrictionSocialUpNextGoal();
      startFrictionSocialUpNextCountdown();
    }

    function openNextFrictionSocialMixVideo() {
      if (!frictionSocialUpNextReady) return;
      var queue = getFrictionSocialMixQueue();
      if (!queue.length) return;
      var nextIndex = (typeof frictionSocialMixIndex === 'number' ? frictionSocialMixIndex : -1) + 1;
      if (nextIndex < 0 || nextIndex >= queue.length) return;
      var nextVideo = queue[nextIndex];
      setFrictionSocialActiveMixIndex(nextVideo.id, nextIndex);
      hideFrictionSocialPauseOverlay();
      openFrictionSocialModal({
        id: nextVideo.id,
        title: nextVideo.title,
        channel: nextVideo.channel,
        publishedAt: nextVideo.publishedAt
      });
    }

    function clearFrictionSocialPauseTimer() {
      if (frictionSocialPauseTimerId) {
        clearInterval(frictionSocialPauseTimerId);
        frictionSocialPauseTimerId = null;
      }
    }

    function hideFrictionSocialPauseOverlay() {
      if (!frictionSocialPauseOverlay) return;
      frictionSocialPauseOverlay.classList.remove('active');
      frictionSocialPauseOverlay.setAttribute('aria-hidden', 'true');
      resetFrictionSocialUpNextState();
      frictionSocialPauseTake.disabled = false;
      frictionSocialPauseWatch.disabled = false;
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.disabled = false;
      }
      clearFrictionSocialPauseTimer();
      unlockBodyScroll();
    }

    function startFrictionSocialPauseCountdown() {
      frictionSocialPauseRemaining = getFrictionSocialPauseSeconds();
      frictionSocialPauseSkip.style.display = 'inline-flex';
      frictionSocialPauseTake.disabled = true;
      frictionSocialPauseWatch.disabled = true;
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.disabled = true;
      }
      frictionSocialPauseTimer.textContent = 'Remaining: ' + frictionSocialPauseRemaining + ' seconds';
      clearFrictionSocialPauseTimer();
      frictionSocialPauseTimerId = setInterval(function() {
        frictionSocialPauseRemaining -= 1;
        frictionSocialPauseTimer.textContent = 'Remaining: ' + frictionSocialPauseRemaining + ' seconds';
        if (frictionSocialPauseRemaining <= 0) {
          hideFrictionSocialPauseOverlay();
        }
      }, 1000);
    }

    function showFrictionSocialPauseOverlay() {
      if (!frictionSocialPauseOverlay || frictionSocialPauseOverlay.classList.contains('active')) return;
      resetFrictionSocialUpNextState();
      var prompt = frictionSocialPausePrompts[Math.floor(Math.random() * frictionSocialPausePrompts.length)];
      frictionSocialPausePrompt.textContent = prompt;
      frictionSocialPauseTake.textContent = 'Take ' + getFrictionSocialPauseSeconds() + ' seconds';
      frictionSocialPauseTimer.textContent = '';
      frictionSocialPauseSkip.style.display = 'none';
      frictionSocialPauseTake.disabled = false;
      frictionSocialPauseWatch.disabled = false;
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.disabled = false;
      }
      frictionSocialPauseOverlay.classList.add('active');
      frictionSocialPauseOverlay.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function recordFrictionSocialWatch() {
      frictionSocialSessionWatchedCount += 1;
      localStorage.setItem(FRICTION_SOCIAL_SESSION_WATCHED_KEY, String(frictionSocialSessionWatchedCount));
      if (!frictionSocialPrefs.frictionEnabled) return;
      var frequency = getFrictionSocialFrequency();
      if (frictionSocialSessionWatchedCount % frequency !== 0) return;
      if (frictionSocialIntroOverlay && frictionSocialIntroOverlay.classList.contains('active')) return;
      showFrictionSocialPauseOverlay();
    }

    function saveFrictionSocialShelves() {
      localStorage.setItem('friction_social_shelves', JSON.stringify(frictionSocialState.shelves));
    }

    function saveFrictionSocialChannels() {
      localStorage.setItem(FRICTION_SOCIAL_CHANNELS_KEY, JSON.stringify(frictionSocialChannels));
    }

    function saveFrictionSocialSeenMap() {
      localStorage.setItem(FRICTION_SOCIAL_SEEN_KEY, JSON.stringify(frictionSocialSeenMap));
    }

    function removeFrictionSocialChannel(channelId, channelTitle) {
      if (!channelId) return;
      var label = channelTitle ? '"' + channelTitle + '"' : 'this channel';
      if (!confirm('Remove ' + label + ' from Friction Social?')) return;
      frictionSocialChannels = frictionSocialChannels.filter(function(channel) {
        return channel.channelId !== channelId;
      });
      saveFrictionSocialChannels();
      renderFrictionSocialShelves();
    }

    function extractYouTubeId(value) {
      if (!value) return '';
      var trimmed = value.trim();
      var urlMatch = trimmed.match(/(?:v=|\/embed\/|\/shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (urlMatch && urlMatch[1]) {
        return urlMatch[1];
      }
      if (/^[a-zA-Z0-9_-]{11}$/.test(trimmed)) {
        return trimmed;
      }
      return '';
    }

    function markFrictionSocialSeen(videoId) {
      if (!videoId) return;
      if (!frictionSocialSeenMap[videoId]) {
        frictionSocialSeenMap[videoId] = Date.now();
        saveFrictionSocialSeenMap();
      }
    }

    function isFrictionSocialSeen(videoId) {
      return !!(videoId && frictionSocialSeenMap[videoId]);
    }

    function addFrictionSocialSeenBadge(card) {
      if (!card || card.querySelector('.fs-card-badge--seen')) return;
      var seenBadge = document.createElement('span');
      seenBadge.className = 'fs-card-badge fs-card-badge--seen';
      seenBadge.textContent = 'Seen';
      card.appendChild(seenBadge);
    }

    function shuffleFrictionSocialList(items) {
      var array = items.slice();
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
      }
      return array;
    }

    function buildFrictionSocialRotation(poolVideos, latestVideoId, count) {
      var candidates = (poolVideos || []).filter(function(video) {
        return video && video.videoId && video.videoId !== latestVideoId;
      });
      var unseen = candidates.filter(function(video) {
        return !isFrictionSocialSeen(video.videoId);
      });
      var seen = candidates.filter(function(video) {
        return isFrictionSocialSeen(video.videoId);
      });
      var selection = shuffleFrictionSocialList(unseen).slice(0, count);
      if (selection.length < count) {
        var remaining = count - selection.length;
        selection = selection.concat(shuffleFrictionSocialList(seen).slice(0, remaining));
      }
      return selection;
    }

    function getOrCreateShelf(title) {
      var shelf = frictionSocialState.shelves.find(function(item) {
        return item.title === title;
      });
      if (!shelf) {
        shelf = { title: title, videos: [] };
        frictionSocialState.shelves.unshift(shelf);
      }
      return shelf;
    }

    function addFrictionSocialVideo() {
      var input = prompt('Paste a YouTube link or video ID:');
      if (!input) return;
      var videoId = extractYouTubeId(input);
      if (!videoId) {
        alert('Please provide a valid YouTube link or 11-character video ID.');
        return;
      }
      var exists = frictionSocialState.shelves.some(function(shelf) {
        return (shelf.videos || []).some(function(video) {
          return video.id === videoId;
        });
      });
      if (exists) {
        alert('That video is already saved.');
        return;
      }

      var title = prompt('Video title (optional):') || 'Untitled video';
      var channel = prompt('Channel name (optional):') || 'Unknown channel';
      var shelf = getOrCreateShelf('Saved');
      shelf.videos.unshift({
        id: videoId,
        title: title.trim() || 'Untitled video',
        channel: channel.trim() || 'Unknown channel'
      });
      saveFrictionSocialShelves();
      renderFrictionSocialShelves();
      refreshFrictionSocialMetadata([videoId]);
    }

    function upsertFrictionSocialChannel(channelData) {
      var existingIndex = frictionSocialChannels.findIndex(function(channel) {
        return channel.channelId === channelData.channelId;
      });
      if (existingIndex >= 0) {
        var existing = frictionSocialChannels[existingIndex];
        frictionSocialChannels[existingIndex] = {
          channelId: channelData.channelId,
          channelTitle: channelData.channelTitle || existing.channelTitle,
          channelUrl: channelData.channelUrl || existing.channelUrl,
          addedAt: existing.addedAt,
          latestVideo: channelData.latestVideo || existing.latestVideo || null,
          rotationVideos: channelData.rotationVideos || existing.rotationVideos || [],
          lastRotationAt: channelData.lastRotationAt || existing.lastRotationAt || null
        };
      } else {
        frictionSocialChannels.unshift({
          channelId: channelData.channelId,
          channelTitle: channelData.channelTitle || 'Unknown channel',
          channelUrl: channelData.channelUrl || '',
          addedAt: Date.now(),
          latestVideo: channelData.latestVideo || null,
          rotationVideos: channelData.rotationVideos || [],
          lastRotationAt: channelData.lastRotationAt || null
        });
      }
      saveFrictionSocialChannels();
    }

    async function fetchFrictionSocialChannelLatest(channelId, limit) {
      var response = await fetch('/api/youtube/channel-latest?channelId=' + encodeURIComponent(channelId) + '&limit=' + limit);
      if (!response.ok) {
        var errorText = await response.text().catch(function() { return ''; });
        throw new Error(errorText || 'Failed to fetch channel videos.');
      }
      return response.json();
    }

    async function fetchFrictionSocialChannelSample(channelId, pool) {
      var response = await fetch('/api/youtube/channel-sample?channelId=' + encodeURIComponent(channelId) + '&pool=' + pool);
      if (!response.ok) {
        var errorText = await response.text().catch(function() { return ''; });
        throw new Error(errorText || 'Failed to fetch channel sample.');
      }
      return response.json();
    }

    async function addFrictionSocialChannel() {
      var input = prompt('Paste a YouTube channel link or @handle:');
      if (!input) return;
      try {
        var resolveResponse = await fetch('/api/youtube/resolve-channel?q=' + encodeURIComponent(input.trim()));
        if (!resolveResponse.ok) {
          var resolveText = await resolveResponse.text().catch(function() { return ''; });
          throw new Error(resolveText || 'Unable to resolve channel.');
        }
        var resolved = await resolveResponse.json();
        if (!resolved || !resolved.channelId) {
          throw new Error('Channel not found.');
        }
        var latest = await fetchFrictionSocialChannelLatest(resolved.channelId, 1);
        var channelInfo = latest.channel || resolved;
        var latestVideo = Array.isArray(latest.videos) ? latest.videos[0] : null;
        var sample = await fetchFrictionSocialChannelSample(resolved.channelId, FRICTION_SOCIAL_POOL_LIMIT);
        var poolVideos = Array.isArray(sample.videos) ? sample.videos : [];
        var rotationVideos = buildFrictionSocialRotation(
          poolVideos,
          latestVideo ? latestVideo.videoId : '',
          Math.max(FRICTION_SOCIAL_CHANNEL_LIMIT - 1, 0)
        );
        upsertFrictionSocialChannel({
          channelId: channelInfo.channelId || resolved.channelId,
          channelTitle: channelInfo.channelTitle || resolved.channelTitle,
          channelUrl: channelInfo.channelUrl || resolved.channelUrl,
          latestVideo: latestVideo,
          rotationVideos: rotationVideos,
          lastRotationAt: Date.now()
        });
        renderFrictionSocialShelves();
      } catch (err) {
        alert(err && err.message ? err.message : 'Unable to add channel.');
      }
    }

    async function refreshFrictionSocialChannelRotation(channelId, buttonEl) {
      var index = frictionSocialChannels.findIndex(function(channel) {
        return channel.channelId === channelId;
      });
      if (index < 0) return;
      var channel = frictionSocialChannels[index];
      var originalLabel = buttonEl ? buttonEl.textContent : '';
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Refreshing...';
      }
      try {
        var sample = await fetchFrictionSocialChannelSample(channelId, FRICTION_SOCIAL_POOL_LIMIT);
        var poolVideos = Array.isArray(sample.videos) ? sample.videos : [];
        var latestId = channel.latestVideo ? channel.latestVideo.videoId : '';
        var rotationVideos = buildFrictionSocialRotation(
          poolVideos,
          latestId,
          Math.max(FRICTION_SOCIAL_CHANNEL_LIMIT - 1, 0)
        );
        frictionSocialChannels[index] = {
          channelId: channel.channelId,
          channelTitle: channel.channelTitle,
          channelUrl: channel.channelUrl,
          addedAt: channel.addedAt,
          latestVideo: channel.latestVideo || null,
          rotationVideos: rotationVideos,
          lastRotationAt: Date.now()
        };
        saveFrictionSocialChannels();
        renderFrictionSocialShelves();
      } catch (err) {
        alert(err && err.message ? err.message : 'Unable to refresh channel rotation.');
      } finally {
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = originalLabel;
        }
      }
    }

    async function refreshFrictionSocialChannels() {
      if (!frictionSocialChannels.length) {
        alert('No channels saved yet.');
        return;
      }
      frictionSocialRefresh.disabled = true;
      var originalLabel = frictionSocialRefresh.textContent;
      frictionSocialRefresh.textContent = 'Refreshing...';
      try {
        for (var i = 0; i < frictionSocialChannels.length; i++) {
          var channel = frictionSocialChannels[i];
          if (!channel || !channel.channelId) continue;
          try {
            var latest = await fetchFrictionSocialChannelLatest(channel.channelId, 1);
            var channelInfo = latest.channel || {};
            var latestVideo = Array.isArray(latest.videos) ? latest.videos[0] : channel.latestVideo;
            var sample = await fetchFrictionSocialChannelSample(channel.channelId, FRICTION_SOCIAL_POOL_LIMIT);
            var poolVideos = Array.isArray(sample.videos) ? sample.videos : [];
            var rotationVideos = buildFrictionSocialRotation(
              poolVideos,
              latestVideo ? latestVideo.videoId : '',
              Math.max(FRICTION_SOCIAL_CHANNEL_LIMIT - 1, 0)
            );
            frictionSocialChannels[i] = {
              channelId: channel.channelId,
              channelTitle: channelInfo.channelTitle || channel.channelTitle,
              channelUrl: channelInfo.channelUrl || channel.channelUrl,
              addedAt: channel.addedAt,
              latestVideo: latestVideo || null,
              rotationVideos: rotationVideos,
              lastRotationAt: Date.now()
            };
          } catch (err) {
            continue;
          }
        }
        saveFrictionSocialChannels();
        renderFrictionSocialShelves();
      } finally {
        frictionSocialRefresh.disabled = false;
        frictionSocialRefresh.textContent = originalLabel;
      }
    }

    function formatPublishedDate(value) {
      if (!value) return '';
      var date = new Date(value);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleDateString(undefined, {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    function getVideoMetaLine(video, fallbackChannel) {
      var channel = video.channel || fallbackChannel || 'Unknown channel';
      var published = formatPublishedDate(video.publishedAt);
      return published ? channel + ' â€¢ ' + published : channel;
    }

    function collectFrictionSocialIds() {
      var ids = [];
      frictionSocialState.shelves.forEach(function(shelf) {
        var videos = Array.isArray(shelf.videos) ? shelf.videos : [];
        videos.forEach(function(video) {
          if (video && video.id) ids.push(video.id);
        });
      });
      return ids;
    }

    function mergeFrictionSocialMetadata(metadata) {
      if (!metadata) return;
      var hasUpdates = false;
      frictionSocialState.shelves.forEach(function(shelf) {
        var videos = Array.isArray(shelf.videos) ? shelf.videos : [];
        videos.forEach(function(video) {
          var info = metadata[video.id];
          if (!info) return;
          frictionSocialMetadataCache[video.id] = info;
          if (info.title) {
            video.title = info.title;
            hasUpdates = true;
          }
          if (info.channelTitle) {
            video.channel = info.channelTitle;
            hasUpdates = true;
          }
          if (info.publishedAt) {
            video.publishedAt = info.publishedAt;
            hasUpdates = true;
          }
          if (info.thumbnail) {
            video.thumbnail = info.thumbnail;
            hasUpdates = true;
          }
        });
      });
      if (hasUpdates) {
        saveFrictionSocialShelves();
        renderFrictionSocialShelves();
      }
    }

    function fetchFrictionSocialMetadata(ids) {
      var idList = (ids || []).filter(Boolean);
      if (idList.length === 0) return Promise.resolve(null);
      return fetch('/api/youtube/metadata?ids=' + encodeURIComponent(idList.join(',')))
        .then(function(res) {
          if (!res.ok) throw new Error('Metadata fetch failed');
          return res.json();
        })
        .catch(function() {
          return null;
        });
    }

    function refreshFrictionSocialMetadata(ids) {
      var allIds = ids && ids.length ? ids : collectFrictionSocialIds();
      var uniqueIds = [];
      var seen = {};
      allIds.forEach(function(id) {
        if (!id || seen[id]) return;
        seen[id] = true;
        if (!frictionSocialMetadataCache[id]) {
          uniqueIds.push(id);
        }
      });
      if (uniqueIds.length === 0) return;
      for (var i = 0; i < uniqueIds.length; i += 50) {
        fetchFrictionSocialMetadata(uniqueIds.slice(i, i + 50)).then(function(metadata) {
          mergeFrictionSocialMetadata(metadata);
        });
      }
    }

    function renderFrictionSocialShelves() {
      var query = (frictionSocialState.query || '').trim().toLowerCase();
      frictionSocialShelves.innerHTML = '';
      var totalMatches = 0;

      frictionSocialChannels.forEach(function(channel) {
        var latestVideo = channel.latestVideo || null;
        var rotationVideos = Array.isArray(channel.rotationVideos) ? channel.rotationVideos : [];
        var latestVideoId = latestVideo ? latestVideo.videoId : '';
        var channelTitle = channel.channelTitle || 'Unknown channel';
        var channelMatch = query && channelTitle.toLowerCase().indexOf(query) >= 0;
        var allVideos = [];
        if (latestVideo) allVideos.push(latestVideo);
        allVideos = allVideos.concat(rotationVideos);
        var filtered = allVideos.filter(function(video) {
          if (!query) return true;
          if (channelMatch) return true;
          var title = (video.title || '').toLowerCase();
          var id = (video.videoId || '').toLowerCase();
          return title.indexOf(query) >= 0 || id.indexOf(query) >= 0;
        });

        if (filtered.length === 0) return;
        totalMatches += filtered.length;

        var shelfEl = document.createElement('div');
        shelfEl.className = 'fs-shelf';

        var header = document.createElement('div');
        header.className = 'fs-shelf-header';

        var titleEl = document.createElement('div');
        titleEl.className = 'fs-shelf-title';
        titleEl.textContent = channelTitle;

        var actions = document.createElement('div');
        actions.className = 'fs-shelf-actions';

        var countEl = document.createElement('div');
        countEl.className = 'fs-shelf-count';
        countEl.textContent = filtered.length + (filtered.length === 1 ? ' video' : ' videos');

        var refreshBtn = document.createElement('button');
        refreshBtn.type = 'button';
        refreshBtn.className = 'fs-add-btn fs-secondary-btn fs-refresh-btn';
        refreshBtn.textContent = 'ðŸŽ² Refresh';
        refreshBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          refreshFrictionSocialChannelRotation(channel.channelId, refreshBtn);
        });

        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'fs-add-btn fs-secondary-btn fs-remove-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          removeFrictionSocialChannel(channel.channelId, channelTitle);
        });

        actions.appendChild(countEl);
        actions.appendChild(refreshBtn);
        actions.appendChild(removeBtn);

        header.appendChild(titleEl);
        header.appendChild(actions);

        var row = document.createElement('div');
        row.className = 'fs-row';

        filtered.forEach(function(video) {
          var card = document.createElement('button');
          card.type = 'button';
          card.className = 'fs-card';
          card.dataset.videoId = video.videoId;
          card.dataset.videoTitle = video.title || 'Untitled video';
          card.dataset.videoChannel = channelTitle;
          card.dataset.videoPublishedAt = video.publishedAt || '';

          if (latestVideoId && video.videoId === latestVideoId) {
            var latestBadge = document.createElement('span');
            latestBadge.className = 'fs-card-badge fs-card-badge--latest';
            latestBadge.textContent = 'Latest';
            card.appendChild(latestBadge);
          }

          if (isFrictionSocialSeen(video.videoId)) {
            var seenBadge = document.createElement('span');
            seenBadge.className = 'fs-card-badge fs-card-badge--seen';
            seenBadge.textContent = 'Seen';
            card.appendChild(seenBadge);
          }

          var img = document.createElement('img');
          img.src = video.thumbnail || ('https://i.ytimg.com/vi/' + video.videoId + '/hqdefault.jpg');
          img.alt = video.title || 'YouTube thumbnail';
          img.loading = 'lazy';

          var body = document.createElement('div');
          body.className = 'fs-card-body';

          var cardTitle = document.createElement('div');
          cardTitle.className = 'fs-card-title';
          cardTitle.textContent = video.title || 'Untitled video';

          var cardChannel = document.createElement('div');
          cardChannel.className = 'fs-card-channel';
          cardChannel.textContent = getVideoMetaLine(video, channelTitle);

          body.appendChild(cardTitle);
          body.appendChild(cardChannel);

          card.appendChild(img);
          card.appendChild(body);
          row.appendChild(card);
        });

        shelfEl.appendChild(header);
        shelfEl.appendChild(row);
        frictionSocialShelves.appendChild(shelfEl);
      });

      frictionSocialState.shelves.forEach(function(shelf) {
        var videos = Array.isArray(shelf.videos) ? shelf.videos : [];
        var filtered = videos.filter(function(video) {
          if (!query) return true;
          var title = (video.title || '').toLowerCase();
          var channel = (video.channel || '').toLowerCase();
          var id = (video.id || '').toLowerCase();
          return title.indexOf(query) >= 0 || channel.indexOf(query) >= 0 || id.indexOf(query) >= 0;
        });

        if (filtered.length === 0) return;
        totalMatches += filtered.length;

        var shelfEl = document.createElement('div');
        shelfEl.className = 'fs-shelf';

        var header = document.createElement('div');
        header.className = 'fs-shelf-header';

        var titleEl = document.createElement('div');
        titleEl.className = 'fs-shelf-title';
        titleEl.textContent = shelf.title || 'Untitled shelf';

        var countEl = document.createElement('div');
        countEl.className = 'fs-shelf-count';
        countEl.textContent = filtered.length + (filtered.length === 1 ? ' video' : ' videos');

        header.appendChild(titleEl);
        header.appendChild(countEl);

        var row = document.createElement('div');
        row.className = 'fs-row';

        filtered.forEach(function(video) {
          var card = document.createElement('button');
          card.type = 'button';
          card.className = 'fs-card';
          card.dataset.videoId = video.id;
          card.dataset.videoTitle = video.title || 'Untitled video';
          card.dataset.videoChannel = video.channel || '';
          card.dataset.videoPublishedAt = video.publishedAt || '';

          if (isFrictionSocialSeen(video.id)) {
            var seenBadge = document.createElement('span');
            seenBadge.className = 'fs-card-badge fs-card-badge--seen';
            seenBadge.textContent = 'Seen';
            card.appendChild(seenBadge);
          }

          var img = document.createElement('img');
          img.src = video.thumbnail || ('https://i.ytimg.com/vi/' + video.id + '/hqdefault.jpg');
          img.alt = video.title || 'YouTube thumbnail';
          img.loading = 'lazy';

          var body = document.createElement('div');
          body.className = 'fs-card-body';

          var cardTitle = document.createElement('div');
          cardTitle.className = 'fs-card-title';
          cardTitle.textContent = video.title || 'Untitled video';

          var cardChannel = document.createElement('div');
          cardChannel.className = 'fs-card-channel';
          cardChannel.textContent = getVideoMetaLine(video);

          body.appendChild(cardTitle);
          body.appendChild(cardChannel);

          card.appendChild(img);
          card.appendChild(body);
          row.appendChild(card);
        });

        shelfEl.appendChild(header);
        shelfEl.appendChild(row);
        frictionSocialShelves.appendChild(shelfEl);
      });

      if (totalMatches === 0) {
        frictionSocialEmpty.style.display = 'block';
        frictionSocialEmpty.textContent = query
          ? 'No videos match your search.'
          : 'No videos saved yet. Add a YouTube link or channel to start your library.';
      } else {
        frictionSocialEmpty.style.display = 'none';
      }
    }

    function openFrictionSocialModal(video) {
      if (!video || !video.id) return;
      markFrictionSocialSeen(video.id);
      frictionSocialActiveVideoId = video.id;
      setFrictionSocialActiveMixIndex(video.id);
      frictionSocialScrollTop = frictionSocialView.scrollTop;
      frictionSocialView.classList.add('modal-open');
      frictionSocialModal.classList.add('active');
      frictionSocialModal.setAttribute('aria-hidden', 'false');
      frictionSocialModalFrame.src = 'https://www.youtube.com/embed/' + video.id + '?autoplay=1&rel=0&modestbranding=1';
      frictionSocialModalTitle.textContent = video.title || 'Untitled video';
      frictionSocialModalChannel.textContent = getVideoMetaLine(video);
      frictionSocialModalLink.href = 'https://www.youtube.com/watch?v=' + video.id;
    }

    function closeFrictionSocialModal() {
      if (!frictionSocialModal.classList.contains('active')) return;
      frictionSocialModal.classList.remove('active');
      frictionSocialModal.setAttribute('aria-hidden', 'true');
      frictionSocialView.classList.remove('modal-open');
      frictionSocialModalFrame.src = '';
      if (frictionSocialActiveVideoId) {
        frictionSocialActiveVideoId = null;
        recordFrictionSocialWatch();
      }
      if (frictionSocialActiveMixIndex !== null) {
        saveFrictionSocialMixIndex(frictionSocialActiveMixIndex);
        frictionSocialActiveMixIndex = null;
      }
      setTimeout(function() {
        frictionSocialView.scrollTop = frictionSocialScrollTop;
      }, 0);
    }

    frictionSocialState.shelves = loadFrictionSocialShelves();
    frictionSocialChannels = loadFrictionSocialChannels();
    frictionSocialSeenMap = loadFrictionSocialSeenMap();
    loadFrictionSocialPrefs();
    applyFrictionSocialPrefsToUI();
    frictionSocialMixIndex = loadFrictionSocialMixIndex();
    frictionSocialSessionWatchedCount = 0;
    localStorage.setItem(FRICTION_SOCIAL_SESSION_WATCHED_KEY, '0');
    renderFrictionSocialShelves();
    refreshFrictionSocialMetadata();

    frictionSocialSearch.addEventListener('input', function() {
      frictionSocialState.query = this.value || '';
      renderFrictionSocialShelves();
    });

    if (frictionSocialFrictionEnabled) {
      frictionSocialFrictionEnabled.addEventListener('change', function() {
        frictionSocialPrefs.frictionEnabled = this.checked;
        saveFrictionSocialPrefs();
      });
    }

    frictionSocialFrequencyInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.frictionFrequency = this.value;
        saveFrictionSocialPrefs();
      });
    });

    frictionSocialPauseInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.pauseSeconds = this.value;
        saveFrictionSocialPrefs();
      });
    });

    if (lifeFrictionEnabled) {
      lifeFrictionEnabled.addEventListener('change', function() {
        frictionSocialPrefs.frictionEnabled = this.checked;
        saveFrictionSocialPrefs();
        applyFrictionSocialPrefsToUI();
      });
    }

    lifeFrictionFrequencyInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.frictionFrequency = this.value;
        saveFrictionSocialPrefs();
        applyFrictionSocialPrefsToUI();
      });
    });

    lifePauseInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.pauseSeconds = this.value;
        saveFrictionSocialPrefs();
        applyFrictionSocialPrefsToUI();
      });
    });

    frictionSocialAdd.addEventListener('click', addFrictionSocialVideo);
    if (frictionSocialAddChannel) {
      frictionSocialAddChannel.addEventListener('click', addFrictionSocialChannel);
    }
    if (frictionSocialRefresh) {
      frictionSocialRefresh.addEventListener('click', refreshFrictionSocialChannels);
    }

    frictionSocialShelves.addEventListener('click', function(event) {
      var card = event.target.closest('.fs-card');
      if (!card) return;
      var videoId = card.dataset.videoId;
      markFrictionSocialSeen(videoId);
      addFrictionSocialSeenBadge(card);
      openFrictionSocialModal({
        id: videoId,
        title: card.dataset.videoTitle,
        channel: card.dataset.videoChannel,
        publishedAt: card.dataset.videoPublishedAt
      });
    });

    frictionSocialModal.addEventListener('click', function(event) {
      if (event.target.dataset.close !== undefined) {
        closeFrictionSocialModal();
      }
    });

    frictionSocialModalClose.addEventListener('click', closeFrictionSocialModal);

    if (frictionSocialIntroContinue) {
      frictionSocialIntroContinue.addEventListener('click', function() {
        if (frictionSocialIntroDismiss && frictionSocialIntroDismiss.checked) {
          localStorage.setItem(FRICTION_SOCIAL_INTRO_KEY, 'true');
        }
        hideFrictionSocialIntro();
      });
    }

    if (frictionSocialPauseWatch) {
      frictionSocialPauseWatch.addEventListener('click', function() {
        hideFrictionSocialPauseOverlay();
      });
    }

    if (frictionSocialPauseTake) {
      frictionSocialPauseTake.addEventListener('click', function() {
        if (frictionSocialPauseTimerId) return;
        startFrictionSocialPauseCountdown();
      });
    }

    if (frictionSocialPauseUpNext) {
      frictionSocialPauseUpNext.addEventListener('click', function() {
        startFrictionSocialUpNextFlow();
      });
    }

    if (frictionSocialPauseGoalDone) {
      frictionSocialPauseGoalDone.addEventListener('click', function() {
        markFrictionSocialUpNextGoalDone();
      });
    }

    if (frictionSocialPauseContinue) {
      frictionSocialPauseContinue.addEventListener('click', function() {
        openNextFrictionSocialMixVideo();
      });
    }

    if (frictionSocialPauseSkip) {
      frictionSocialPauseSkip.addEventListener('click', function() {
        hideFrictionSocialPauseOverlay();
      });
    }

    if (frictionSocialPauseDone) {
      frictionSocialPauseDone.addEventListener('click', function() {
        hideFrictionSocialPauseOverlay();
      });
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeFrictionSocialModal();
        hideFrictionSocialPauseOverlay();
        hideFrictionSocialIntro();
        closeCalendarModals();
        closeAppointmentModal(appointmentModalContexts.life);
        closeAppointmentModal(appointmentModalContexts.calendar);
      }
    });

    loadLifeAreas();
    loadPeople();
    loadCalendarEvents();
    renderAreaSelects();
    resetPeopleForm();

    goalsShort = loadGoalsViewShort();
    goalsLong = loadGoalsViewLong();
    tasks = loadTasks();
    appointments = loadAppointments();
    saveGoalsViewShort();
    saveGoalsViewLong();
    saveTasks();
    saveAppointments();
    renderShortGoals();
    renderLongGoals();
    renderGoalsNudge();
    renderLinkedTaskOptions();
    renderLifeToday();
    renderLifeGoals();
    renderLifeTasks();
    renderLifeCalendar();
    renderLifeAreasList();
    renderPeopleOverview();
    renderAppointmentsView();
    renderCalendarMonth();
    setLifeTab('people');
    setupAppointmentModal(appointmentModalContexts.life);
    setupAppointmentModal(appointmentModalContexts.calendar);
    if (isCalendarImportRoute()) {
      showCalendarImportForm();
      populateCalendarImportForm();
    }

    if (shortGoalAdd) {
      shortGoalAdd.addEventListener('click', function() {
        var text = shortGoalInput.value.trim();
        if (!text) return;
        var areaId = shortGoalArea ? shortGoalArea.value : getDefaultAreaId();
        goalsShort.unshift({
          id: generateGoalId('short'),
          text: text,
          done: false,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          createdAt: Date.now(),
          completedAt: null
        });
        shortGoalInput.value = '';
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
      });
    }

    if (shortGoalInput) {
      shortGoalInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          shortGoalAdd.click();
        }
      });
    }

    if (shortGoalClear) {
      shortGoalClear.addEventListener('click', function() {
        goalsShort = goalsShort.filter(function(goal) { return !goal.done; });
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
      });
    }

    if (longGoalForm) {
      longGoalForm.addEventListener('submit', function(event) {
        event.preventDefault();
        var title = longGoalTitle.value.trim();
        if (!title) return;
        var note = longGoalNote.value.trim();
        var date = longGoalDate.value;
        var areaId = longGoalArea ? longGoalArea.value : getDefaultAreaId();
        if (editingLongGoalId) {
          goalsLong = goalsLong.map(function(goal) {
            if (goal.id !== editingLongGoalId) return goal;
          return {
            id: goal.id,
            title: title,
            note: note,
            targetDate: date || null,
            areaId: areaId,
            ownerName: getAreaOwnerName(areaId),
            personId: goal.personId || null,
            createdAt: goal.createdAt,
            updatedAt: Date.now()
          };
        });
      } else {
        goalsLong.unshift({
          id: generateGoalId('long'),
          title: title,
          note: note,
          targetDate: date || null,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        }
        saveGoalsViewLong();
        renderLongGoals();
        renderGoalsNudge();
        renderLifeGoals();
        resetLongGoalForm();
      });
    }

    if (longGoalCancel) {
      longGoalCancel.addEventListener('click', function() {
        resetLongGoalForm();
      });
    }

    if (goalsAreaFilter) {
      goalsAreaFilter.addEventListener('change', function() {
        goalsAreaFilterValue = this.value;
        renderAreaSelects();
        renderShortGoals();
        renderLongGoals();
      });
    }

    if (lifeAreaFilter) {
      lifeAreaFilter.addEventListener('change', function() {
        lifeAreaFilterValue = this.value;
        renderAreaSelects();
        renderLifeToday();
        renderLifeGoals();
        renderLifeTasks();
        renderLifeCalendar();
      });
    }

    if (lifeTabs) {
      lifeTabs.addEventListener('click', function(event) {
        var button = event.target.closest('.life-tab');
        if (!button) return;
        setLifeTab(button.dataset.tab || 'today');
      });
    }

    if (lifeAddPersonPrimary) {
      lifeAddPersonPrimary.addEventListener('click', function() {
        setLifeTab('people');
        setPersonViewActive(false);
        openPeopleForm();
      });
    }

    if (lifePeopleFormCancel) {
      lifePeopleFormCancel.addEventListener('click', function() {
        setPeopleFormVisible(false);
        resetPeopleForm();
      });
    }

    if (lifePersonBack) {
      lifePersonBack.addEventListener('click', function() {
        setPersonViewActive(false);
        setLifeTab('people');
      });
    }

    if (lifeAppointmentsToggle && lifeAppointmentsBody) {
      lifeAppointmentsToggle.addEventListener('click', function() {
        var isExpanded = lifeAppointmentsToggle.getAttribute('aria-expanded') === 'true';
        lifeAppointmentsToggle.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
        lifeAppointmentsBody.classList.toggle('is-collapsed', isExpanded);
      });
    }

    if (lifeAppointmentsAdd) {
      lifeAppointmentsAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        openAppointmentModal(appointmentModalContexts.life, null, { lockPersonId: activePersonId });
      });
    }

    if (lifeAppointmentsPastToggle) {
      lifeAppointmentsPastToggle.addEventListener('click', function() {
        lifeAppointmentsPastExpanded = !lifeAppointmentsPastExpanded;
        renderPersonAppointments(activePersonId);
      });
    }

    if (lifeAgendaRange) {
      lifeAgendaRange.addEventListener('click', function(event) {
        var button = event.target.closest('.life-agenda-segment');
        if (!button) return;
        if (button.dataset.range === 'today') {
          setAgendaRange(1);
          return;
        }
        var days = parseInt(button.dataset.range, 10);
        if (!Number.isNaN(days)) {
          setAgendaRange(days);
        }
      });
    }

    if (lifePersonParkedToggle) {
      lifePersonParkedToggle.addEventListener('click', function() {
        var isExpanded = lifePersonParkedToggle.getAttribute('aria-expanded') === 'true';
        lifePersonParkedToggle.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
        lifePersonParkedToggle.lastElementChild.textContent = isExpanded ? '+' : 'âˆ’';
        if (lifePersonParkedList) {
          lifePersonParkedList.style.display = isExpanded ? 'none' : 'block';
        }
      });
    }

    if (lifePeopleSave) {
      lifePeopleSave.addEventListener('click', function() {
        var name = lifePersonName ? lifePersonName.value.trim() : '';
        if (!name) {
          alert('Please enter a name.');
          if (lifePersonName) lifePersonName.focus();
          return;
        }
        var role = lifePersonRole ? lifePersonRole.value.trim() : '';
        if (!role) {
          alert('Please select a role.');
          if (lifePersonRole) lifePersonRole.focus();
          return;
        }
        var customRole = lifePersonCustomRole ? lifePersonCustomRole.value.trim() : '';
        if (role === 'Other' && !customRole) {
          alert('Please enter a custom role.');
          if (lifePersonCustomRole) lifePersonCustomRole.focus();
          return;
        }
        var org = lifePersonOrg ? lifePersonOrg.value.trim() : '';
        var dob = lifePersonDob ? lifePersonDob.value : '';
        var notes = lifePersonNotes ? lifePersonNotes.value.trim() : '';
        var avatarType = pendingAvatarType === 'photo' && pendingAvatarDataUrl ? 'photo' : 'generated';
        var avatarSeed = pendingAvatarSeed || name || generatePersonId();
        var existingPerson = editingPersonId
          ? people.find(function(person) { return person.id === editingPersonId; })
          : null;
        var accountHolderKey = getAccountHolderKey();
        var isAccountHolder = existingPerson ? existingPerson.isAccountHolder : false;
        if (!isAccountHolder && accountHolderKey && normalizeName(name) === accountHolderKey) {
          isAccountHolder = true;
        }
        var type = existingPerson ? existingPerson.type : '';
        if (isAccountHolder && !type) {
          type = 'me';
        }
        var personRecord = {
          id: editingPersonId || generatePersonId(),
          name: name,
          role: role,
          customRole: role === 'Other' ? customRole : '',
          org: org,
          dob: dob,
          notes: notes,
          isAccountHolder: Boolean(isAccountHolder),
          type: type,
          avatarType: avatarType,
          avatarDataUrl: avatarType === 'photo' ? pendingAvatarDataUrl : '',
          avatarSeed: avatarSeed,
          createdAt: existingPerson && existingPerson.createdAt ? existingPerson.createdAt : Date.now(),
          updatedAt: Date.now()
        };
        if (editingPersonId) {
          people = people.map(function(person) {
            if (person.id !== editingPersonId) return person;
            return personRecord;
          });
        } else {
          people.unshift(personRecord);
        }
        savePeople();
        renderPeopleOverview();
        setPeopleFormVisible(false);
        resetPeopleForm();
      });
    }

    if (lifePersonName) {
      lifePersonName.addEventListener('input', function() {
        if (pendingAvatarType !== 'photo') {
          updateAvatarPreview();
        }
      });
    }

    if (lifePersonRole) {
      lifePersonRole.addEventListener('change', function() {
        updateCustomRoleVisibility();
      });
    }

    if (lifeAvatarRandom) {
      lifeAvatarRandom.addEventListener('click', function() {
        pendingAvatarType = 'generated';
        pendingAvatarDataUrl = '';
        pendingAvatarSeed = generatePersonId();
        if (lifeAvatarHint) {
          lifeAvatarHint.textContent = 'New generated avatar selected.';
        }
        updateAvatarPreview();
      });
    }

    if (lifeAvatarUpload) {
      lifeAvatarUpload.addEventListener('change', function(event) {
        var file = event.target.files && event.target.files[0];
        if (!file) return;
        if (lifeAvatarHint) {
          lifeAvatarHint.textContent = 'Creating thumbnail...';
        }
        createImageThumbnail(file)
          .then(function(dataUrl) {
            pendingAvatarType = 'photo';
            pendingAvatarDataUrl = dataUrl;
            if (lifeAvatarHint) {
              lifeAvatarHint.textContent = 'Photo ready. Saved on this device.';
            }
            updateAvatarPreview();
          })
          .catch(function() {
            pendingAvatarType = 'generated';
            pendingAvatarDataUrl = '';
            pendingAvatarSeed = generatePersonId();
            if (lifeAvatarHint) {
              lifeAvatarHint.textContent = 'Photo upload failed. Using a generated avatar instead.';
            }
            updateAvatarPreview();
          });
      });
    }

    if (lifePersonTaskAdd) {
      lifePersonTaskAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        var text = lifePersonTaskText ? lifePersonTaskText.value.trim() : '';
        if (!text) return;
        var areaId = getDefaultAreaId();
        tasks.unshift({
          id: generateGoalId('task'),
          text: text,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId,
          tags: [],
          needsOtherPeople: false,
          needsAppointment: false,
          energyType: '',
          done: false,
          createdAt: Date.now(),
          dueDate: null
        });
        saveTasks();
        renderLifeTasks();
        renderLifeToday();
        renderLinkedTaskOptions();
        if (lifePersonTaskText) lifePersonTaskText.value = '';
        renderPersonRightNow(activePersonId);
      });
    }

    if (lifePersonApptAdd) {
      lifePersonApptAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        var title = lifePersonApptTitle ? lifePersonApptTitle.value.trim() : '';
        var start = lifePersonApptStart ? lifePersonApptStart.value : '';
        if (!title || !start) return;
        var areaId = getDefaultAreaId();
        appointments.unshift({
          id: generateGoalId('appt'),
          title: title,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId,
          dateTimeStart: start,
          dateTimeEnd: null,
          location: '',
          notes: '',
          linkedTaskIds: [],
          createdAt: Date.now()
        });
        saveAppointments();
        renderLifeCalendar();
        if (lifePersonApptTitle) lifePersonApptTitle.value = '';
        if (lifePersonApptStart) lifePersonApptStart.value = '';
        renderPersonComingUp(activePersonId);
      });
    }

    if (lifePersonGoalAdd) {
      lifePersonGoalAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        var text = lifePersonGoalText ? lifePersonGoalText.value.trim() : '';
        if (!text) return;
        var areaId = getDefaultAreaId();
        goalsShort.unshift({
          id: generateGoalId('short'),
          text: text,
          done: false,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId,
          createdAt: Date.now(),
          completedAt: null
        });
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
        if (lifePersonGoalText) lifePersonGoalText.value = '';
        renderPersonRightNow(activePersonId);
      });
    }

    if (lifeTaskAdd) {
      lifeTaskAdd.addEventListener('click', function() {
        var text = lifeTaskText.value.trim();
        if (!text) return;
        var areaId = lifeTaskArea ? lifeTaskArea.value : getDefaultAreaId();
        var tags = lifeTaskTags.value.split(',').map(function(t) { return t.trim(); }).filter(Boolean);
        if (editingTaskId) {
          tasks = tasks.map(function(task) {
            if (task.id !== editingTaskId) return task;
          return {
            id: task.id,
            text: text,
            areaId: areaId,
            ownerName: getAreaOwnerName(areaId),
            personId: task.personId || null,
            tags: tags,
            needsOtherPeople: lifeTaskNeedsPeople.checked,
            needsAppointment: lifeTaskNeedsAppt.checked,
            energyType: lifeTaskEnergy.value || '',
            done: task.done,
            createdAt: task.createdAt,
            dueDate: lifeTaskDue.value || null
          };
        });
      } else {
        tasks.unshift({
          id: generateGoalId('task'),
          text: text,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          tags: tags,
          needsOtherPeople: lifeTaskNeedsPeople.checked,
          needsAppointment: lifeTaskNeedsAppt.checked,
          energyType: lifeTaskEnergy.value || '',
          done: false,
          createdAt: Date.now(),
          dueDate: lifeTaskDue.value || null
        });
        }
        saveTasks();
        renderLifeTasks();
        renderLifeToday();
        renderLinkedTaskOptions();
        editingTaskId = null;
        lifeTaskText.value = '';
        lifeTaskTags.value = '';
        lifeTaskDue.value = '';
        lifeTaskNeedsPeople.checked = false;
        lifeTaskNeedsAppt.checked = false;
        lifeTaskEnergy.value = '';
        lifeTaskAdd.textContent = 'Add task';
        lifeTaskCancel.style.display = 'none';
      });
    }

    if (lifeTaskCancel) {
      lifeTaskCancel.addEventListener('click', function() {
        editingTaskId = null;
        lifeTaskText.value = '';
        lifeTaskTags.value = '';
        lifeTaskDue.value = '';
        lifeTaskNeedsPeople.checked = false;
        lifeTaskNeedsAppt.checked = false;
        lifeTaskEnergy.value = '';
        lifeTaskAdd.textContent = 'Add task';
        lifeTaskCancel.style.display = 'none';
      });
    }

    if (lifeApptAdd) {
      lifeApptAdd.addEventListener('click', function() {
        var title = lifeApptTitle.value.trim();
        if (!title) return;
        var areaId = lifeApptArea ? lifeApptArea.value : getDefaultAreaId();
        var selectedTasks = Array.from(lifeApptLinkedTasks.options).filter(function(opt) { return opt.selected; }).map(function(opt) { return opt.value; });
        if (editingApptId) {
          appointments = appointments.map(function(appt) {
            if (appt.id !== editingApptId) return appt;
          return {
            id: appt.id,
            title: title,
            areaId: areaId,
            ownerName: getAreaOwnerName(areaId),
            personId: appt.personId || null,
            dateTimeStart: lifeApptStart.value,
            dateTimeEnd: lifeApptEnd.value || null,
            location: lifeApptLocation.value.trim(),
            notes: lifeApptNotes.value.trim(),
            linkedTaskIds: selectedTasks,
            createdAt: appt.createdAt
          };
        });
      } else {
        appointments.unshift({
          id: generateGoalId('appt'),
          title: title,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          dateTimeStart: lifeApptStart.value,
          dateTimeEnd: lifeApptEnd.value || null,
          location: lifeApptLocation.value.trim(),
          notes: lifeApptNotes.value.trim(),
          linkedTaskIds: selectedTasks,
          createdAt: Date.now()
        });
        }
        saveAppointments();
        renderLifeCalendar();
        editingApptId = null;
        lifeApptTitle.value = '';
        lifeApptStart.value = '';
        lifeApptEnd.value = '';
        lifeApptLocation.value = '';
        lifeApptNotes.value = '';
        Array.from(lifeApptLinkedTasks.options).forEach(function(option) { option.selected = false; });
        lifeApptAdd.textContent = 'Add appointment';
        lifeApptCancel.style.display = 'none';
      });
    }

    if (lifeApptCancel) {
      lifeApptCancel.addEventListener('click', function() {
        editingApptId = null;
        lifeApptTitle.value = '';
        lifeApptStart.value = '';
        lifeApptEnd.value = '';
        lifeApptLocation.value = '';
        lifeApptNotes.value = '';
        Array.from(lifeApptLinkedTasks.options).forEach(function(option) { option.selected = false; });
        lifeApptAdd.textContent = 'Add appointment';
        lifeApptCancel.style.display = 'none';
      });
    }

    if (lifeAddChild) {
      lifeAddChild.addEventListener('click', function() {
        var name = lifeChildName.value.trim();
        if (!name) return;
        var childName = name.startsWith('Child:') ? name : 'Child: ' + name;
        lifeAreas.push({
          id: generateLifeAreaId(),
          name: childName,
          type: 'child',
          createdAt: Date.now()
        });
        lifeChildName.value = '';
        saveLifeAreas();
        renderAreaSelects();
        renderLifeAreasList();
      });
    }

    if (appointmentsAddGlobal) {
      appointmentsAddGlobal.addEventListener('click', function() {
        openAppointmentModal(appointmentModalContexts.calendar, null, { lockPersonId: null });
      });
    }

    if (appointmentsPastToggle) {
      appointmentsPastToggle.addEventListener('click', function() {
        appointmentsPastExpanded = !appointmentsPastExpanded;
        renderAppointmentsView();
      });
    }

    if (calendarPrevMonth) {
      calendarPrevMonth.addEventListener('click', function() {
        calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth() - 1, 1);
        renderCalendarMonth();
      });
    }

    if (calendarNextMonth) {
      calendarNextMonth.addEventListener('click', function() {
        calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth() + 1, 1);
        renderCalendarMonth();
      });
    }

    if (calendarAddEvent) {
      calendarAddEvent.addEventListener('click', function() {
        openEventModal(null, toYmd(new Date()));
      });
    }

    if (calendarDayAdd) {
      calendarDayAdd.addEventListener('click', function() {
        openEventModal(null, calendarSelectedDate || toYmd(new Date()));
      });
    }

    if (calendarDayClose) {
      calendarDayClose.addEventListener('click', function() {
        closeDayModal();
      });
    }

    if (calendarEventClose) {
      calendarEventClose.addEventListener('click', function() {
        closeEventModal();
      });
    }

    if (calendarEventForm) {
      calendarEventForm.addEventListener('submit', handleCalendarSave);
    }

    if (calendarEventDelete) {
      calendarEventDelete.addEventListener('click', function() {
        if (!calendarEditingEventId) return;
        var confirmRemove = window.confirm('Delete this event?');
        if (!confirmRemove) return;
        calendarEvents = calendarEvents.filter(function(item) { return item.id !== calendarEditingEventId; });
        saveCalendarEvents();
        renderCalendarMonth();
        if (calendarSelectedDate) {
          renderDayModal();
        }
        if (activePersonId) {
          renderPersonAgenda(activePersonId);
        }
        closeEventModal();
      });
    }

    if (calendarEventPerson) {
      calendarEventPerson.addEventListener('change', function() {
        updateCalendarPersonPreview();
      });
    }

    if (calendarEventLocation) {
      calendarEventLocation.addEventListener('input', function() {
        updateCalendarDirectionsButton();
      });
    }

    if (calendarEventAllDay) {
      calendarEventAllDay.addEventListener('change', function() {
        updateCalendarEventTimeVisibility();
      });
    }

    if (calendarEventDirections) {
      calendarEventDirections.addEventListener('click', function() {
        if (!calendarEventLocation) return;
        var location = calendarEventLocation.value.trim();
        if (!location) return;
        window.open(buildDirectionsUrl(location), '_blank');
      });
    }

    if (calendarEventRepeat) {
      calendarEventRepeat.addEventListener('change', function() {
        updateCustomRepeatVisibility();
      });
    }

    if (calendarCustomWeekdays) {
      calendarCustomWeekdays.addEventListener('change', function() {
        updateRepeatDayButtons();
      });
    }

    if (calendarDayModal) {
      calendarDayModal.querySelectorAll('[data-close]').forEach(function(el) {
        el.addEventListener('click', function() {
          closeDayModal();
        });
      });
    }

    if (calendarEventModal) {
      calendarEventModal.querySelectorAll('[data-close]').forEach(function(el) {
        el.addEventListener('click', function() {
          closeEventModal();
        });
      });
    }

    if (calendarImportForm) {
      calendarImportForm.addEventListener('submit', handleCalendarImportSave);
    }

    if (calendarImportAllDay) {
      calendarImportAllDay.addEventListener('change', function() {
        updateCalendarImportTimeVisibility();
      });
    }

    if (calendarImportLocation) {
      calendarImportLocation.addEventListener('input', function() {
        updateCalendarImportDirections();
      });
    }

    if (calendarImportDirections) {
      calendarImportDirections.addEventListener('click', function() {
        if (!calendarImportLocation) return;
        var location = calendarImportLocation.value.trim();
        if (!location) return;
        window.open(buildDirectionsUrl(location), '_blank');
      });
    }

    if (calendarImportCancel) {
      calendarImportCancel.addEventListener('click', function() {
        window.location.assign('/#calendar');
      });
    }

    if (calendarImportBack) {
      calendarImportBack.addEventListener('click', function() {
        window.location.assign('/#calendar');
      });
    }

    if (calendarImportBackPerson) {
      calendarImportBackPerson.addEventListener('click', function() {
        var personId = calendarImportPerson ? calendarImportPerson.value : '';
        if (personId) {
          localStorage.setItem('life_focus_person_id', personId);
        }
        window.location.assign('/#life');
      });
    }

    if (calendarImportAddAnother) {
      calendarImportAddAnother.addEventListener('click', function() {
        showCalendarImportForm();
        populateCalendarImportForm();
      });
    }

    if (goalsNudgeBtn) {
      goalsNudgeBtn.addEventListener('click', function() {
        var goalId = goalsNudge.dataset.goalId;
        var target = goalsLong.find(function(goal) { return goal.id === goalId; }) || goalsLong[0];
        if (target) {
          openUnstuckPanel({ source: 'goal', mode: 'break', item: target });
        }
      });
    }

    // Settings event listeners
    document.getElementById('settingsClose').addEventListener('click', hideSettings);

    document.querySelectorAll('input[name="frictionMode"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (isSettingsLocked()) return;
        settings.frictionMode = this.value;
        saveSettings();
        updateDelayAvailability();
      });
    });

    document.querySelectorAll('input[name="messageDelay"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (isSettingsLocked()) return;
        settings.messageDelay = parseInt(this.value, 10);
        saveSettings();
      });
    });

    document.getElementById('allowCancelDelay').addEventListener('change', function() {
      if (isSettingsLocked()) return;
      settings.allowCancelDelay = this.checked;
      saveSettings();
    });

    document.getElementById('showShortTermGoal').addEventListener('change', function() {
      if (isSettingsLocked()) return;
      settings.showShortTermGoal = this.checked;
      saveSettings();
    });

    document.getElementById('showLongTermGoal').addEventListener('change', function() {
      if (isSettingsLocked()) return;
      settings.showLongTermGoal = this.checked;
      saveSettings();
      updateBackgroundGoal();
    });

    document.getElementById('btnLockSettings').addEventListener('click', function() {
      if (isSettingsLocked()) return;
      if (confirm('Are you sure? Once locked, you cannot change settings until the timer expires.')) {
        lockSettings();
      }
    });

    // Delay cancel button
    document.getElementById('delayCancelBtn').addEventListener('click', cancelDelay);

    // Lock preset buttons
    document.querySelectorAll('.lock-preset-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var hours = this.dataset.hours;
        var days = this.dataset.days;
        
        document.getElementById('lockDays').value = days || 0;
        document.getElementById('lockHours').value = hours || 0;
        document.getElementById('lockMinutes').value = 0;
      });
    });

    // CHAT HISTORY MANAGEMENT
    function generateChatId() {
      return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getChatTitle(messages) {
      if (!messages || messages.length === 0) return 'New Chat';
      const firstUserMsg = messages.find(function(m) { return m.role === 'user'; });
      if (firstUserMsg) {
        const title = firstUserMsg.content.substring(0, 40);
        return title.length < firstUserMsg.content.length ? title + '...' : title;
      }
      return 'New Chat';
    }

    function loadChatHistory() {
      const saved = localStorage.getItem('friction_history');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    function saveChatHistory(history) {
      localStorage.setItem('friction_history', JSON.stringify(history));
    }

    function saveCurrentChatToHistory() {
      if (state.messages.length === 0) return;
      
      let history = loadChatHistory();
      const chatData = {
        id: state.currentChatId || generateChatId(),
        messages: state.messages,
        model: state.currentModel,
        updatedAt: Date.now()
      };
      
      // Update existing or add new
      const existingIndex = history.findIndex(function(c) { return c.id === chatData.id; });
      if (existingIndex >= 0) {
        history[existingIndex] = chatData;
      } else {
        history.unshift(chatData);
      }
      
      // Keep only last 50 chats
      history = history.slice(0, 50);
      
      saveChatHistory(history);
      state.currentChatId = chatData.id;
    }

    function loadChatFromHistory(chatId) {
      const history = loadChatHistory();
      const chat = history.find(function(c) { return c.id === chatId; });
      if (chat) {
        state.messages = chat.messages;
        state.currentModel = chat.model;
        state.currentChatId = chat.id;
        modelSelect.value = chat.model;
        saveChatState();
        restoreChatUI();
        closeMenu();
      }
    }

    function deleteChatFromHistory(chatId) {
      let history = loadChatHistory();
      history = history.filter(function(c) { return c.id !== chatId; });
      saveChatHistory(history);
      renderChatHistoryList();
    }

    function renderChatHistoryList() {
      const container = document.getElementById('chatHistoryList');
      const history = loadChatHistory();
      
      if (history.length === 0) {
        container.innerHTML = '<div class="menu-empty">No chats yet</div>';
        return;
      }
      
      container.innerHTML = '';
      history.forEach(function(chat) {
        const item = document.createElement('div');
        item.className = 'menu-history-item';
        if (chat.id === state.currentChatId) {
          item.classList.add('active');
        }
        
        const title = document.createElement('button');
        title.className = 'menu-history-title';
        title.textContent = getChatTitle(chat.messages);
        title.addEventListener('click', function() {
          loadChatFromHistory(chat.id);
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'menu-history-delete';
        deleteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        deleteBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteChatFromHistory(chat.id);
        });
        
        item.appendChild(title);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }

    // FRICTION SYSTEM
    let challenge1 = '';
    let challenge2 = '';
    let frictionLevel = 0;
    let lastMessageTime = null;
    let timerInterval = null;
    const RESET_TIME = 2 * 60 * 60 * 1000;

    function loadFrictionState() {
      const saved = localStorage.getItem('friction_state');
      if (saved) {
        const s = JSON.parse(saved);
        lastMessageTime = s.lastMessageTime;
        frictionLevel = s.frictionLevel || 0;
        if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
          frictionLevel = 0;
          lastMessageTime = null;
          saveFrictionState();
        }
      }
    }

    function saveFrictionState() {
      localStorage.setItem('friction_state', JSON.stringify({ frictionLevel, lastMessageTime }));
    }

    function formatTimeRemaining(ms) {
      if (ms <= 0) return '0:00:00';
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      return hours + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
    }

    function updateTimer() {
      const timerEl = document.getElementById('frictionTimer');
      const headerTimerEl = document.getElementById('headerTimer');

      if (!lastMessageTime || frictionLevel === 0) {
        timerEl.textContent = '';
        headerTimerEl.classList.remove('active');
        headerTimerEl.textContent = '';
        return;
      }

      const elapsed = Date.now() - lastMessageTime;
      const remaining = RESET_TIME - elapsed;

      if (remaining <= 0) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
        timerEl.textContent = 'ðŸŽ‰ Reset! Back to Level 1.';
        headerTimerEl.textContent = 'ðŸŽ‰ Level 1';
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        setTimeout(function() { headerTimerEl.classList.remove('active'); }, 5000);
      } else {
        const timeStr = formatTimeRemaining(remaining);
        timerEl.textContent = 'â± Resets in ' + timeStr;
        var maxLevel = settings.frictionMode === 'strict' ? 15 : 7;
        headerTimerEl.textContent = 'L' + Math.min(frictionLevel + 1, maxLevel) + ' Â· ' + timeStr;
        headerTimerEl.classList.add('active');
      }
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    let headerTimerInterval = null;
    function startHeaderTimer() {
      if (headerTimerInterval) clearInterval(headerTimerInterval);
      updateTimer();
      headerTimerInterval = setInterval(updateTimer, 1000);
    }

    function getFrictionConfig() {
      // Strict mode - original hardcore 15 levels
      if (settings.frictionMode === 'strict') {
        const strictConfigs = [
          { rows: 1, length: 6 },   // Level 1
          { rows: 1, length: 8 },   // Level 2
          { rows: 1, length: 10 },  // Level 3
          { rows: 1, length: 12 },  // Level 4
          { rows: 1, length: 14 },  // Level 5
          { rows: 1, length: 16 },  // Level 6
          { rows: 1, length: 18 },  // Level 7
          { rows: 1, length: 20 },  // Level 8
          { rows: 2, length: 12 },  // Level 9
          { rows: 2, length: 14 },  // Level 10
          { rows: 2, length: 16 },  // Level 11
          { rows: 2, length: 18 },  // Level 12
          { rows: 2, length: 20 },  // Level 13
          { rows: 2, length: 20 },  // Level 14
          { rows: 2, length: 20 },  // Level 15
        ];
        return strictConfigs[Math.min(frictionLevel, 14)];
      }
      
      // Full mode - gentle 7 levels, max 10 chars
      const configs = [
        { rows: 1, length: 4 },   // Level 1
        { rows: 1, length: 5 },   // Level 2
        { rows: 1, length: 6 },   // Level 3
        { rows: 1, length: 7 },   // Level 4
        { rows: 1, length: 8 },   // Level 5
        { rows: 1, length: 9 },   // Level 6
        { rows: 1, length: 10 },  // Level 7+
      ];
      return configs[Math.min(frictionLevel, 6)];
    }

    function handlePaste(e) {
      e.preventDefault();
      frictionError.textContent = 'No pasting â€” type it out!';
    }

    function createCharPairs(code, container) {
      container.innerHTML = '';
      
      for (let i = 0; i < code.length; i++) {
        // Create pair container (code on top, input below)
        const pair = document.createElement('div');
        pair.className = 'friction-pair';
        
        // Create display character block
        const charBlock = document.createElement('div');
        charBlock.className = 'friction-char';
        charBlock.textContent = code[i];
        pair.appendChild(charBlock);
        
        // Create input block
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'friction-char-input';
        input.maxLength = 1;
        input.autocomplete = 'off';
        input.autocorrect = 'off';
        input.autocapitalize = 'off';
        input.spellcheck = false;
        input.dataset.index = i;
        input.dataset.expected = code[i];
        
        input.addEventListener('input', handleCharInput);
        input.addEventListener('keydown', handleCharKeydown);
        input.addEventListener('paste', handlePaste);
        input.addEventListener('drop', function(e) { e.preventDefault(); });
        
        pair.appendChild(input);
        container.appendChild(pair);
      }
    }

    function handleCharInput(e) {
      const input = e.target;
      const value = input.value;
      const expected = input.dataset.expected;
      
      if (value) {
        if (value === expected) {
          input.classList.add('success');
          input.classList.remove('error');
          // Move to next input
          const pair = input.closest('.friction-pair');
          const nextPair = pair.nextElementSibling;
          if (nextPair) {
            const nextInput = nextPair.querySelector('.friction-char-input');
            if (nextInput) nextInput.focus();
          }
        } else {
          input.classList.add('error');
          input.classList.remove('success');
        }
      } else {
        input.classList.remove('success', 'error');
      }
      
      checkAllInputs();
    }

    function handleCharKeydown(e) {
      const input = e.target;
      const pair = input.closest('.friction-pair');
      
      if (e.key === 'Backspace' && !input.value) {
        const prevPair = pair.previousElementSibling;
        if (prevPair) {
          const prevInput = prevPair.querySelector('.friction-char-input');
          if (prevInput) {
            prevInput.focus();
            prevInput.select();
          }
        }
      } else if (e.key === 'ArrowLeft') {
        const prevPair = pair.previousElementSibling;
        if (prevPair) {
          const prevInput = prevPair.querySelector('.friction-char-input');
          if (prevInput) prevInput.focus();
        }
      } else if (e.key === 'ArrowRight') {
        const nextPair = pair.nextElementSibling;
        if (nextPair) {
          const nextInput = nextPair.querySelector('.friction-char-input');
          if (nextInput) nextInput.focus();
        }
      }
    }

    function checkAllInputs() {
      const config = getFrictionConfig();
      
      // Check row 1
      const inputs1 = frictionPairs1.querySelectorAll('.friction-char-input');
      let match1 = true;
      inputs1.forEach(function(input) {
        if (input.value !== input.dataset.expected) match1 = false;
      });
      
      // Check row 2 if needed
      let match2 = true;
      if (config.rows === 2) {
        const inputs2 = frictionPairs2.querySelectorAll('.friction-char-input');
        inputs2.forEach(function(input) {
          if (input.value !== input.dataset.expected) match2 = false;
        });
      }
      
      if (match1 && match2) {
        frictionUnlock.disabled = false;
        frictionUnlock.classList.add('ready');
      } else {
        frictionUnlock.disabled = true;
        frictionUnlock.classList.remove('ready');
      }
      
      frictionError.textContent = '';
    }

    function showFriction(message) {
      if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
      }

      state.pendingMessage = message;
      const config = getFrictionConfig();

      // Show short-term goal reminder
      var goalReminder = document.getElementById('frictionGoalReminder');
      var activeGoal = getActiveShortTermGoal();
      if (activeGoal && settings.showShortTermGoal) {
        goalReminder.innerHTML = '<div class="friction-goal-label">Your focus</div><div class="friction-goal-text">"' + activeGoal.text + '"</div>';
      } else {
        goalReminder.innerHTML = '';
      }

      // Show code input row
      document.getElementById('frictionRow1').style.display = 'block';
      
      challenge1 = generateChallenge(config.length);
      createCharPairs(challenge1, frictionPairs1);

      const row2 = document.getElementById('frictionRow2');
      if (config.rows === 2) {
        challenge2 = generateChallenge(config.length);
        createCharPairs(challenge2, frictionPairs2);
        row2.style.display = 'block';
      } else {
        challenge2 = '';
        row2.style.display = 'none';
      }

      frictionUnlock.disabled = true;
      frictionUnlock.classList.remove('ready');
      frictionError.textContent = '';

      const subtitle = document.querySelector('.friction-subtitle');
      if (settings.frictionMode === 'strict') {
        // Strict mode - 15 levels
        if (frictionLevel < 14) {
          subtitle.textContent = 'â˜ ï¸ STRICT Level ' + (frictionLevel + 1) + ' of 15 â€” No mercy.';
        } else {
          subtitle.textContent = 'â˜ ï¸ STRICT Level 15 â€” Maximum punishment. 2hr reset.';
        }
      } else {
        // Full mode - 7 levels
        if (frictionLevel < 6) {
          subtitle.textContent = 'Level ' + (frictionLevel + 1) + ' of 7 â€” Type the code to send.';
        } else {
          subtitle.textContent = 'Level 7 of 7 â€” Maximum friction. Take a 2-hour break to reset.';
        }
      }

      startTimer();
      frictionOverlay.classList.add('active');
      lockBodyScroll();
      document.addEventListener('touchmove', preventTouchMove, { passive: false });
      document.documentElement.style.setProperty('--kb', '0px');
      
      // Focus first input
      setTimeout(function() {
        const firstInput = frictionPairs1.querySelector('.friction-char-input');
        if (firstInput) firstInput.focus();
      }, 10);
    }

    function hideFriction() {
      frictionOverlay.classList.remove('active');
      state.pendingMessage = null;
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      document.removeEventListener('touchmove', preventTouchMove);
      unlockBodyScroll();
      startHeaderTimer();
      setTimeout(updateKeyboardOffset, 80);
      setTimeout(scrollChatToBottom, 100);
    }

    frictionCancel.addEventListener('click', hideFriction);

    frictionUnlock.addEventListener('click', function() {
      // Only increase level for full or strict friction modes
      if (settings.frictionMode === 'full' || settings.frictionMode === 'strict') {
        var maxLevel = settings.frictionMode === 'strict' ? 14 : 6;
        if (frictionLevel < maxLevel) frictionLevel++;
        lastMessageTime = Date.now();
        saveFrictionState();
      }

      const timerEl = document.getElementById('frictionTimer');

      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }

      // Save the message BEFORE hiding (hideFriction clears pendingMessage)
      const messageToSend = state.pendingMessage;
      
      hideFriction();
      
      // Check if message delay is enabled
      if (settings.messageDelay > 0) {
        showDelayOverlay(messageToSend);
      } else {
        sendMessage(messageToSend);
      }
    });

    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().catch(function() {});
    }

    loadFrictionState();

    // CHAT FUNCTIONS
    function formatMessageContent(content) {
      // Handle code blocks first (before escaping)
      var codeBlockId = 0;
      var codeBlocks = [];

      // Extract fenced code blocks (```lang\ncode```)
      content = content.replace(/```(\w*)\n?([\s\S]*?)```/g, function(match, lang, code) {
        var id = 'code-block-' + (codeBlockId++);
        codeBlocks.push({ id: id, lang: lang || 'text', code: code.trim() });
        return '{{CODE_BLOCK_' + id + '}}';
      });

      // Extract inline code (`code`)
      content = content.replace(/`([^`]+)`/g, function(match, code) {
        return '<span class="inline-code">' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
      });

      // Convert URLs to clickable links
      var urlRegex = /(https?:\/\/[^\s\]]+)/g;
      var escaped = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Restore inline code (it was escaped)
      escaped = escaped.replace(/&lt;span class="inline-code"&gt;/g, '<span class="inline-code">');
      escaped = escaped.replace(/&lt;\/span&gt;/g, '</span>');

      // Replace URLs with anchor tags
      var withLinks = escaped.replace(urlRegex, function(url) {
        var cleanUrl = url.replace(/[.,;:!?)]+$/, '');
        var trailing = url.substring(cleanUrl.length);
        return '<a href="' + cleanUrl + '" target="_blank" rel="noopener noreferrer">' + cleanUrl + '</a>' + trailing;
      });

      // Convert **text** to bold
      withLinks = withLinks.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // Convert line breaks
      withLinks = withLinks.replace(/\n/g, '<br>');

      // Restore code blocks with styled containers
      codeBlocks.forEach(function(block) {
        var codeHtml = '<div class="code-block-container">' +
          '<div class="code-block-header">' +
            '<span class="code-block-lang">' + block.lang + '</span>' +
            '<div style="display:flex;gap:6px;">' +
              '<button class="btn-open-canvas" onclick="openCodeCanvas(this)" data-code="' + encodeURIComponent(block.code) + '" data-lang="' + block.lang + '">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>' +
                'Canvas' +
              '</button>' +
              '<button class="code-copy-btn" onclick="copyCodeBlock(this)" data-code="' + encodeURIComponent(block.code) + '">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
                '<span>Copy</span>' +
              '</button>' +
            '</div>' +
          '</div>' +
          '<div class="code-block-content"><pre><code>' + block.code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre></div>' +
        '</div>';
        withLinks = withLinks.replace('{{CODE_BLOCK_' + block.id + '}}', codeHtml);
      });

      return withLinks;
    }

    function copyCodeBlock(button) {
      var code = decodeURIComponent(button.getAttribute('data-code'));
      navigator.clipboard.writeText(code).then(function() {
        button.classList.add('copied');
        button.querySelector('span').textContent = 'Copied!';
        setTimeout(function() {
          button.classList.remove('copied');
          button.querySelector('span').textContent = 'Copy';
        }, 2000);
      });
    }

    function addMessage(content, type, attachments) {
      const div = document.createElement('div');
      div.className = 'message message-' + type;

      if (type === 'ai') {
        div.innerHTML = formatMessageContent(content);
      } else {
        div.textContent = content;
      }

      // Add attachments if any
      if (attachments && attachments.length > 0) {
        attachments.forEach(function(att) {
          if (att.type && att.type.startsWith('image/')) {
            var img = document.createElement('img');
            img.src = att.data;
            img.alt = att.name;
            img.className = 'message-image';
            img.onclick = function() { window.open(att.data, '_blank'); };
            div.appendChild(img);
          } else {
            var fileDiv = document.createElement('div');
            fileDiv.className = 'message-file';
            fileDiv.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>' + att.name + '</span>';
            div.appendChild(fileDiv);
          }
        });
      }

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage(content, attachments) {
      // Prevent duplicate sends
      if (state.isProcessing) return;

      // Get attachments from state if not provided directly
      attachments = attachments || state.pendingAttachments || [];
      state.pendingAttachments = [];

      const model = modelSelect.value;
      state.currentModel = model;

      const welcome = chatMessages.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      // Build message content with file contents for AI
      var fullContent = content;
      attachments.forEach(function(att) {
        if (att.type && !att.type.startsWith('image/') && att.data) {
          fullContent += '\n\n[File: ' + att.name + ']\n' + att.data;
        } else if (att.type && att.type.startsWith('image/')) {
          fullContent += '\n\n[Image attached: ' + att.name + ']';
        }
      });

      addMessage(content || 'Sent attachment(s)', 'user', attachments);
      state.messages.push({ role: 'user', content: fullContent });
      saveChatState();
      
      // Update background goal opacity
      updateBackgroundGoal();

      state.isProcessing = true;
      btnSend.disabled = true;

      typingIndicator.classList.add('active');
      chatMessages.appendChild(typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const response = await callBackend(model);
        state.messages.push({ role: 'assistant', content: response });
        saveChatState();
        addMessage(response, 'ai');
      } catch (error) {
        addMessage('Error: ' + error.message, 'error');
      } finally {
        state.isProcessing = false;
        btnSend.disabled = false;
        typingIndicator.classList.remove('active');
        requestAnimationFrame(scrollChatToBottom);
      }
    }

    async function callBackend(model) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({ model: model, messages: state.messages })
      });

      if (!res.ok) {
        let errorMsg = 'Backend API error';
        try { const error = await res.json(); errorMsg = error.error || errorMsg; } catch (e) {}
        
        // Handle auth errors
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        
        throw new Error(errorMsg);
      }

      const data = await res.json();
      return data.response;
    }

    // INPUT HANDLING
    messageInput.addEventListener('input', function() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      requestAnimationFrame(scrollChatToBottom);
    });

    function handleSend() {
      const content = messageInput.value.trim();
      const attachments = getAttachmentsForMessage();
      if ((!content && attachments.length === 0) || state.isProcessing) return;
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // Store attachments for later use
      state.pendingAttachments = attachments;

      // Check friction mode
      if (settings.frictionMode === 'off') {
        // No friction - send directly (but check delay)
        if (settings.messageDelay > 0) {
          showDelayOverlay(content);
        } else {
          sendMessage(content, attachments);
        }
      } else if (settings.frictionMode === 'light') {
        // Light mode - show goal only, no typing
        showLightFriction(content);
      } else {
        // Full or Strict mode - show goal + typing code
        showFriction(content);
      }
    }

    function showLightFriction(message) {
      state.pendingMessage = message;
      
      // Show a simplified overlay with just the goal
      var goalReminder = document.getElementById('frictionGoalReminder');
      var activeGoal = getActiveShortTermGoal();
      if (activeGoal && settings.showShortTermGoal) {
        goalReminder.innerHTML = '<div class="friction-goal-label">Your focus</div><div class="friction-goal-text">"' + activeGoal.text + '"</div>';
      } else {
        goalReminder.innerHTML = '<div class="friction-goal-label">Pause & reflect</div><div class="friction-goal-text">Do you really need this right now?</div>';
      }
      
      // Hide code input rows
      document.getElementById('frictionRow1').style.display = 'none';
      document.getElementById('frictionRow2').style.display = 'none';
      
      // Update subtitle
      document.querySelector('.friction-subtitle').textContent = 'Take a moment before sending.';
      
      // Enable send button immediately
      frictionUnlock.disabled = false;
      frictionUnlock.classList.add('ready');
      frictionError.textContent = '';
      
      frictionOverlay.classList.add('active');
      lockBodyScroll();
    }

    btnSend.addEventListener('click', handleSend);

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // FILE UPLOAD HANDLING
    var pendingAttachments = [];
    var fileUploadInput = document.getElementById('fileUpload');
    var btnAttach = document.getElementById('btnAttach');
    var attachmentPreview = document.getElementById('attachmentPreview');

    btnAttach.addEventListener('click', function() {
      fileUploadInput.click();
    });

    fileUploadInput.addEventListener('change', function(e) {
      var files = Array.from(e.target.files);
      files.forEach(function(file) {
        if (file.size > 10 * 1024 * 1024) {
          alert('File too large: ' + file.name + ' (max 10MB)');
          return;
        }

        var reader = new FileReader();
        reader.onload = function(event) {
          var attachment = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            name: file.name,
            size: file.size,
            type: file.type,
            data: event.target.result
          };
          pendingAttachments.push(attachment);
          renderAttachmentPreview();
        };

        if (file.type.startsWith('image/')) {
          reader.readAsDataURL(file);
        } else {
          reader.readAsText(file);
        }
      });
      e.target.value = '';
    });

    function renderAttachmentPreview() {
      if (pendingAttachments.length === 0) {
        attachmentPreview.style.display = 'none';
        attachmentPreview.innerHTML = '';
        return;
      }

      attachmentPreview.style.display = 'flex';
      attachmentPreview.innerHTML = pendingAttachments.map(function(att) {
        var preview = '';
        if (att.type.startsWith('image/')) {
          preview = '<img src="' + att.data + '" alt="' + att.name + '">';
        } else {
          preview = '<div class="file-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>';
        }
        return '<div class="attachment-item">' +
          preview +
          '<div class="attachment-info">' +
            '<div class="attachment-name">' + att.name + '</div>' +
            '<div class="attachment-size">' + formatFileSize(att.size) + '</div>' +
          '</div>' +
          '<button class="attachment-remove" onclick="removeAttachment(\'' + att.id + '\')">&times;</button>' +
        '</div>';
      }).join('');
    }

    function removeAttachment(id) {
      pendingAttachments = pendingAttachments.filter(function(a) { return a.id !== id; });
      renderAttachmentPreview();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getAttachmentsForMessage() {
      var atts = pendingAttachments.slice();
      pendingAttachments = [];
      renderAttachmentPreview();
      return atts;
    }

    // iOS KEYBOARD
    function scrollChatToBottom() {
      if (!chatApp.classList.contains('active')) return;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateKeyboardOffset() {
      if (!window.visualViewport) return;
      const vv = window.visualViewport;
      const keyboardHeight = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
      const overlayOpen = frictionOverlay.classList.contains('active');
      document.documentElement.style.setProperty('--kb', overlayOpen ? '0px' : (keyboardHeight + 'px'));

      if (!overlayOpen && keyboardHeight > 0 && document.activeElement === messageInput) {
        requestAnimationFrame(function() {
          scrollChatToBottom();
          messageInput.scrollIntoView({ block: 'end', behavior: 'auto' });
        });
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateKeyboardOffset);
      window.visualViewport.addEventListener('scroll', updateKeyboardOffset);
    }

    document.addEventListener('focusin', function(e) {
      if (e.target === messageInput) {
        setTimeout(updateKeyboardOffset, 50);
        setTimeout(scrollChatToBottom, 80);
      }
    });

    document.addEventListener('focusout', function(e) {
      if (e.target === messageInput) {
        setTimeout(function() {
          document.documentElement.style.setProperty('--kb', '0px');
          scrollChatToBottom();
        }, 80);
      }
    });

    updateKeyboardOffset();

    // =================== //
    // CODE CANVAS SYSTEM  //
    // =================== //

    var canvasState = {
      currentLang: 'code',
      isOpen: false
    };

    function openCodeCanvas(button) {
      var code = decodeURIComponent(button.getAttribute('data-code'));
      var lang = button.getAttribute('data-lang') || 'code';

      canvasState.currentLang = lang;
      canvasState.isOpen = true;

      document.getElementById('canvasLang').textContent = lang;
      document.getElementById('canvasEditor').value = code;
      document.getElementById('codeCanvas').classList.add('active');
      document.getElementById('codeCanvasOverlay').classList.add('active');
      document.body.classList.add('scroll-locked');

      updateCanvasInfo();
    }

    function closeCodeCanvas() {
      canvasState.isOpen = false;
      document.getElementById('codeCanvas').classList.remove('active');
      document.getElementById('codeCanvasOverlay').classList.remove('active');
      document.body.classList.remove('scroll-locked');
    }

    function updateCanvasInfo() {
      var editor = document.getElementById('canvasEditor');
      var lines = editor.value.split('\n').length;
      var chars = editor.value.length;
      document.getElementById('canvasInfo').textContent = lines + ' line' + (lines !== 1 ? 's' : '') + ' | ' + chars + ' characters';
    }

    function copyCanvasCode() {
      var code = document.getElementById('canvasEditor').value;
      var btn = document.getElementById('btnCanvasCopy');

      navigator.clipboard.writeText(code).then(function() {
        var originalText = btn.innerHTML;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
        btn.classList.add('primary');
        setTimeout(function() {
          btn.innerHTML = originalText;
          btn.classList.remove('primary');
        }, 2000);
      });
    }

    function downloadCanvasCode() {
      var code = document.getElementById('canvasEditor').value;
      var lang = canvasState.currentLang;

      var extensions = {
        javascript: 'js', js: 'js', python: 'py', py: 'py',
        html: 'html', css: 'css', json: 'json', typescript: 'ts',
        ts: 'ts', java: 'java', cpp: 'cpp', c: 'c', go: 'go',
        rust: 'rs', ruby: 'rb', php: 'php', swift: 'swift',
        kotlin: 'kt', sql: 'sql', bash: 'sh', shell: 'sh',
        yaml: 'yaml', yml: 'yml', xml: 'xml', markdown: 'md', md: 'md'
      };

      var ext = extensions[lang.toLowerCase()] || 'txt';
      var filename = 'code.' + ext;

      var blob = new Blob([code], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Canvas event listeners (wait for DOM to be ready)
    window.addEventListener('load', function() {
      document.getElementById('btnCanvasClose').addEventListener('click', closeCodeCanvas);
      document.getElementById('codeCanvasOverlay').addEventListener('click', closeCodeCanvas);
      document.getElementById('btnCanvasCopy').addEventListener('click', copyCanvasCode);
      document.getElementById('btnCanvasDownload').addEventListener('click', downloadCanvasCode);
      document.getElementById('canvasEditor').addEventListener('input', updateCanvasInfo);

      // Handle tab key in canvas editor
      document.getElementById('canvasEditor').addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          e.preventDefault();
          var start = this.selectionStart;
          var end = this.selectionEnd;
          this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
          this.selectionStart = this.selectionEnd = start + 2;
          updateCanvasInfo();
        }
        if (e.key === 'Escape') {
          closeCodeCanvas();
        }
      });
    });

  </script>

  <!-- CODE CANVAS -->
  <div class="code-canvas-overlay" id="codeCanvasOverlay"></div>
  <div class="code-canvas" id="codeCanvas">
    <div class="code-canvas-header">
      <div class="code-canvas-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <span>Code Canvas</span>
        <span class="code-canvas-lang" id="canvasLang">code</span>
      </div>
      <div class="code-canvas-actions">
        <button class="btn-canvas-action" id="btnCanvasCopy" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
        <button class="btn-canvas-action" id="btnCanvasDownload" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download
        </button>
        <button class="btn-canvas-close" id="btnCanvasClose" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="code-canvas-body">
      <textarea class="code-canvas-editor" id="canvasEditor" placeholder="Code will appear here..." spellcheck="false"></textarea>
    </div>
    <div class="code-canvas-footer">
      <span class="code-canvas-info" id="canvasInfo">0 lines</span>
    </div>
  </div>

</body>
</html>
