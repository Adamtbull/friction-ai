<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Friction AI - Slow down your AI, on purpose</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    /* Prevent flash of wrong content on load */
    body {
      opacity: 0;
      transition: opacity 0.15s ease-in;
    }

    body.ready {
      opacity: 1;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #d4e8e6 0%, #e8ecef 100%);
      color: #1f2937;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    button, input, textarea, select {
      font: inherit;
      color: inherit;
      letter-spacing: inherit;
    }

    button,
    input[type="text"],
    textarea,
    select {
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      background: none;
    }

    button, a, input, textarea, select {
      -webkit-tap-highlight-color: transparent;
    }

    body.scroll-locked {
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    :root {
      --teal-light: #d4e8e6;
      --teal-lighter: #e8f4f3;
      --teal: #5a9a94;
      --teal-dark: #4a8a84;
      --grey-light: #e8ecef;
      --grey: #6b7280;
      --grey-dark: #374151;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --white: #ffffff;
      --border: #d1d5db;
      --shadow: rgba(0, 0, 0, 0.05);

      --app-height: 100vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --kb: 0px;
    }

    @supports (height: 100dvh) {
      :root { --app-height: 100dvh; }
    }

    /* =================== */
    /* HOMEPAGE STYLES     */
    /* =================== */
    .homepage {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 24px;
      max-width: 600px;
      margin: 0 auto;
    }

    .homepage.hidden {
      display: none;
    }

    .brand {
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 24px;
    }

    .headline {
      font-size: 2rem;
      font-weight: 600;
      text-align: center;
      color: var(--text-primary);
      margin-bottom: 16px;
      line-height: 1.3;
    }

    .subheadline {
      font-size: 1rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 40px;
      max-width: 400px;
    }

    .section {
      width: 100%;
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .section-subtitle {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .section-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .section-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .section-list li {
      font-size: 0.95rem;
      color: var(--text-secondary);
      padding-left: 20px;
      position: relative;
      margin-bottom: 8px;
    }

    .section-list li::before {
      content: "â€¢";
      color: var(--teal);
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .philosophy-line {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    .cta-section {
      width: 100%;
      text-align: center;
      margin-top: 16px;
    }

    .cta-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .auth-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn-oauth {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-oauth:hover {
      border-color: var(--teal);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .btn-oauth svg {
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
    }

    .btn-primary {
      width: 100%;
      max-width: 320px;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      background: var(--teal);
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--teal-dark);
    }

    .footer-note {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 16px;
    }

    .legal-links {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-top: 12px;
      font-size: 0.8rem;
    }

    .legal-links a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .legal-links a:hover {
      color: var(--teal);
    }

    .legal-links--menu {
      justify-content: flex-start;
      padding: 12px 20px 20px;
      border-top: 1px solid var(--border);
      margin-top: 0;
      gap: 12px;
      flex-wrap: wrap;
    }

    #privacy-view,
    #terms-view,
    #disclaimer-view {
      display: none;
      min-height: 100%;
      max-width: 720px;
      margin: 0 auto;
      padding: 60px 24px;
    }

    #privacy-view.active,
    #terms-view.active,
    #disclaimer-view.active {
      display: block;
    }

    #privacy-view h1,
    #terms-view h1,
    #disclaimer-view h1 {
      font-size: 2rem;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    #privacy-view h2,
    #terms-view h2,
    #disclaimer-view h2 {
      font-size: 1.1rem;
      margin-top: 24px;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    #privacy-view p,
    #terms-view p,
    #disclaimer-view p,
    #privacy-view li,
    #terms-view li,
    #disclaimer-view li {
      font-size: 0.95rem;
      color: var(--text-secondary);
    }

    #privacy-view ul,
    #terms-view ul,
    #disclaimer-view ul {
      padding-left: 20px;
      margin: 0 0 12px;
    }

    #privacy-view .legal-meta,
    #terms-view .legal-meta,
    #disclaimer-view .legal-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    #privacy-view .legal-back,
    #terms-view .legal-back,
    #disclaimer-view .legal-back {
      font-size: 0.85rem;
      margin-bottom: 16px;
    }

    #privacy-view .legal-back a,
    #terms-view .legal-back a,
    #disclaimer-view .legal-back a {
      color: var(--teal);
      text-decoration: none;
    }

    #privacy-view .legal-back a:hover,
    #terms-view .legal-back a:hover,
    #disclaimer-view .legal-back a:hover {
      color: var(--teal-dark);
    }

    /* =================== */
    /* CHAT APP STYLES     */
    /* =================== */
    .chat-app {
      display: none;
      flex-direction: column;
      height: var(--app-height);
      background: linear-gradient(180deg, var(--teal-light) 0%, var(--grey-light) 100%);
    }

    .chat-app.active {
      display: flex;
    }

    .chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(16px + var(--safe-top)) 20px 16px;
      background: rgba(255, 255, 255, 0.6);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .chat-header-left {
      width: 36px;
    }

    .chat-header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .chat-header-right {
      min-width: 70px;
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    .model-select {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      outline: none;
      text-align: center;
    }

    .model-select:focus {
      background: rgba(0,0,0,0.05);
    }

    .header-timer {
      font-size: 0.65rem;
      color: var(--teal);
      background: var(--teal-light);
      padding: 4px 8px;
      border-radius: 12px;
      display: none;
      white-space: nowrap;
    }

    .header-timer.active {
      display: block;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 50%;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-icon:hover {
      border-color: var(--teal);
    }

    .btn-icon svg {
      width: 18px;
      height: 18px;
      stroke: var(--grey);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + 50px + 24px + var(--safe-bottom) + var(--kb));
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 0;
      -webkit-overflow-scrolling: touch;
      position: relative;
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      min-width: 0;
    }

    .message-user {
      align-self: flex-end;
      background: var(--teal);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .message-ai {
      align-self: flex-start;
      background: var(--white);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-ai a {
      color: var(--teal);
      text-decoration: none;
      word-break: break-all;
    }

    .message-ai a:hover {
      text-decoration: underline;
    }

    .message-ai strong {
      font-weight: 600;
    }

    .message-error {
      align-self: center;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      font-size: 0.85rem;
    }

    /* CODE BLOCKS */
    .code-block-container {
      position: relative;
      margin: 12px 0;
      border-radius: 8px;
      overflow: hidden;
      background: #0d2831;
    }

    .code-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #0a1f26;
      border-bottom: 1px solid #1a4a5c;
    }

    .code-block-lang {
      font-size: 0.75rem;
      color: #6bb8cc;
      text-transform: lowercase;
    }

    .code-copy-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: transparent;
      border: 1px solid #1a4a5c;
      border-radius: 4px;
      color: #6bb8cc;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .code-copy-btn:hover {
      background: #1a4a5c;
      color: #fff;
    }

    .code-copy-btn.copied {
      background: var(--teal);
      border-color: var(--teal);
      color: #fff;
    }

    .code-copy-btn svg {
      width: 14px;
      height: 14px;
    }

    .code-block-content {
      padding: 16px;
      overflow-x: auto;
    }

    .code-block-content pre {
      margin: 0;
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      line-height: 1.5;
      color: #b8e6f0;
      white-space: pre;
    }

    .code-block-content code {
      font-family: inherit;
    }

    /* Inline code */
    .inline-code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      color: #e11d48;
    }

    /* ATTACHMENT PREVIEW */
    .attachment-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 8px 12px;
      background: var(--grey-light);
      border-top: 1px solid var(--border);
    }

    .attachment-item {
      position: relative;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-width: 200px;
    }

    .attachment-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }

    .attachment-item .file-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--grey-light);
      border-radius: 4px;
    }

    .attachment-item .file-icon svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
    }

    .attachment-info {
      flex: 1;
      min-width: 0;
    }

    .attachment-name {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .attachment-size {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    .attachment-remove {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* MESSAGE IMAGE */
    .message-image {
      max-width: 100%;
      max-height: 300px;
      border-radius: 8px;
      margin-top: 8px;
      cursor: pointer;
    }

    .message-file {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      background: var(--grey-light);
      border-radius: 8px;
      margin-top: 8px;
    }

    .message-file svg {
      width: 20px;
      height: 20px;
      stroke: var(--teal);
    }

    .message-file span {
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    .welcome-message {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
      width: 100%;
      max-width: 400px;
      pointer-events: none;
    }

    .welcome-icon {
      font-size: 2.5rem;
      margin-bottom: 16px;
    }

    .welcome-message h2 {
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .welcome-message p {
      font-size: 0.9rem;
      margin: 0;
      color: var(--text-secondary);
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 16px 20px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator.active {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--teal);
      border-radius: 50%;
      opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.4; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-4px); }
    }

    .chat-input-area {
      padding: 16px 20px calc(24px + var(--safe-bottom));
      background: rgba(255, 255, 255, 0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);
      transform: translateY(calc(-1 * var(--kb)));
      will-change: transform;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      max-width: 800px;
      margin: 0 auto;
      min-width: 0;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 8px 8px 8px 18px;
    }

    .chat-input {
      flex: 1;
      min-width: 0;
      padding: 8px 0;
      border: none;
      background: transparent;
      font-size: 16px;
      color: var(--text-primary);
      resize: none;
      min-height: 24px;
      max-height: 120px;
      outline: none;
      line-height: 1.5;
      overflow: hidden;
    }

    .chat-input::placeholder {
      color: var(--grey);
    }

    .btn-send {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 50%;
      background: var(--teal);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-send:hover {
      background: var(--teal-dark);
    }

    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-send svg {
      width: 18px;
      height: 18px;
      stroke: var(--white);
      margin-left: 2px;
    }

    .btn-attach {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-attach:hover {
      background: var(--grey-light);
    }

    .btn-attach svg {
      width: 20px;
      height: 20px;
      stroke: var(--text-secondary);
    }

    /* =================== */
    /* SIDE MENU           */
    /* =================== */
    .menu-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
      z-index: 998;
    }

    .menu-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 300px;
      max-width: 85vw;
      background: var(--white);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 999;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }

    .side-menu.active {
      transform: translateX(0);
    }

    .menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .menu-profile {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--grey-light);
    }

    .profile-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .profile-name {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-email {
      font-size: 0.75rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-title {
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      color: var(--teal);
    }

    .btn-close-menu {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 8px;
      background: transparent;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .btn-close-menu:hover {
      background: var(--grey-light);
    }

    .btn-close-menu svg {
      width: 20px;
      height: 20px;
      stroke: var(--grey);
    }

    .menu-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
    }

    .menu-btn-new {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border: 1px dashed var(--border);
      border-radius: 10px;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 20px;
    }

    .menu-btn-new:hover {
      border-color: var(--teal);
      color: var(--teal);
      background: var(--teal-lighter);
    }

    .menu-btn-new svg {
      width: 18px;
      height: 18px;
    }

    .menu-section {
      margin-bottom: 16px;
    }

    .menu-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 1px;
      color: var(--grey);
      text-transform: uppercase;
      padding: 8px 12px;
    }

    .menu-category {
      margin-bottom: 4px;
    }

    .menu-category-header {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .menu-category-header:hover {
      background: var(--grey-light);
    }

    .menu-category-header .chevron {
      width: 16px;
      height: 16px;
      stroke: var(--grey);
      transition: transform 0.2s ease;
    }

    .menu-category.expanded .chevron {
      transform: rotate(180deg);
    }

    .menu-category-items {
      display: none;
      padding-left: 12px;
    }

    .menu-category.expanded .menu-category-items {
      display: block;
    }

    .menu-empty {
      font-size: 0.8rem;
      color: var(--grey);
      padding: 8px 12px;
      font-style: italic;
    }

    .menu-history-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 4px;
      border-radius: 6px;
      margin-bottom: 2px;
    }

    .menu-history-item:hover {
      background: var(--grey-light);
    }

    .menu-history-item.active {
      background: var(--teal-lighter);
    }

    .menu-history-title {
      flex: 1;
      padding: 8px;
      border: none;
      background: transparent;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-history-item:hover .menu-history-title,
    .menu-history-item.active .menu-history-title {
      color: var(--text-primary);
    }

    .menu-history-delete {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s ease;
      border-radius: 4px;
    }

    .menu-history-item:hover .menu-history-delete {
      opacity: 0.5;
    }

    .menu-history-delete:hover {
      opacity: 1 !important;
      background: #fef2f2;
    }

    .menu-history-delete svg {
      width: 14px;
      height: 14px;
      stroke: #dc2626;
    }

    .menu-chat-item {
      width: 100%;
      display: flex;
      align-items: center;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: transparent;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: background 0.2s ease;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menu-chat-item:hover {
      background: var(--grey-light);
      color: var(--text-primary);
    }

    .menu-divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }

    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      font-size: 0.9rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .menu-item:hover {
      background: var(--grey-light);
      color: var(--text-primary);
    }

    .menu-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .menu-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
      padding-bottom: calc(16px + var(--safe-bottom));
    }

    .menu-item-logout:hover {
      background: #fef2f2;
      color: #dc2626;
    }

    .menu-item-logout:hover svg {
      stroke: #dc2626;
    }

    /* =================== */
    /* FRICTION OVERLAY    */
    /* =================== */
    .friction-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      overscroll-behavior: contain;
    }

    .friction-overlay.active {
      display: flex;
    }

    .friction-box {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .friction-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .friction-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 24px;
    }

    .friction-row {
      margin-bottom: 24px;
    }

    .friction-row:last-of-type {
      margin-bottom: 12px;
    }

    .friction-label {
      display: none;
    }

    .friction-pair-container {
      display: flex;
      justify-content: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .friction-pair {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .friction-char {
      width: 32px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--grey-light);
      border-radius: 6px;
      font-family: 'SF Mono', 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', Monaco, 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      user-select: none;
      -webkit-user-select: none;
    }

    .friction-char-input {
      width: 32px;
      height: 38px;
      padding: 0;
      border: 2px solid var(--border);
      border-radius: 6px;
      font-family: 'SF Mono', 'SFMono-Regular', Menlo, Consolas, 'Liberation Mono', Monaco, 'Courier New', monospace;
      font-size: 1rem;
      font-weight: 500;
      text-align: center;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
      background: var(--white);
    }

    .friction-char-input:focus {
      border-color: var(--teal);
    }

    .friction-char-input.success {
      border-color: #22c55e;
      background: #f0fdf4;
    }

    .friction-char-input.error {
      border-color: #ef4444;
      background: #fef2f2;
    }

    .friction-code {
      display: none;
    }

    .friction-input-row {
      display: none;
    }

    .friction-input {
      display: none;
    }

    @media (max-width: 400px) {
      .friction-pair {
        gap: 3px;
      }
      .friction-char,
      .friction-char-input {
        width: 28px;
        height: 34px;
        font-size: 0.9rem;
      }
      .friction-pair-container {
        gap: 3px;
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .friction-goal-reminder {
      background: var(--teal-lighter);
      border-left: 3px solid var(--teal);
      padding: 12px 16px;
      margin-bottom: 20px;
      border-radius: 0 8px 8px 0;
      text-align: left;
    }

    .friction-goal-reminder:empty {
      display: none;
    }

    .friction-goal-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--grey);
      margin-bottom: 4px;
    }

    .friction-goal-text {
      font-size: 0.95rem;
      color: var(--text-primary);
      font-style: italic;
    }

    /* ONBOARDING OVERLAY */
    .onboarding-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
    }

    .onboarding-overlay.active {
      display: flex;
    }

    .onboarding-box {
      background: var(--white);
      border-radius: 16px;
      padding: 32px 28px;
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 8px 32px var(--shadow);
      max-height: 90vh;
      overflow-y: auto;
    }

    .onboarding-step {
      display: none;
    }

    .onboarding-step.active {
      display: block;
    }

    .onboarding-icon {
      font-size: 3rem;
      margin-bottom: 16px;
    }

    .onboarding-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 16px;
    }

    .onboarding-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0 0 20px;
    }

    .onboarding-textarea {
      width: 100%;
      min-height: 100px;
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      margin-bottom: 20px;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .onboarding-textarea:focus {
      border-color: var(--teal);
    }

    .onboarding-textarea::placeholder {
      color: var(--grey);
    }

    .shortterm-goals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    .shortterm-goal-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s ease;
    }

    .shortterm-goal-input:focus {
      border-color: var(--teal);
    }

    .onboarding-btn-add {
      background: transparent;
      border: none;
      color: var(--teal);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      padding: 8px;
      margin-bottom: 20px;
    }

    .onboarding-btn-add:hover {
      text-decoration: underline;
    }

    .onboarding-nav {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .onboarding-btn {
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }

    .onboarding-btn.primary {
      background: var(--teal);
      color: var(--white);
    }

    .onboarding-btn.primary:hover {
      background: var(--teal-dark);
    }

    .onboarding-btn.secondary {
      background: var(--grey-light);
      color: var(--text-secondary);
    }

    .onboarding-btn.secondary:hover {
      background: var(--border);
    }

    .onboarding-summary {
      background: var(--grey-light);
      border-radius: 10px;
      padding: 16px;
      text-align: left;
      margin-bottom: 20px;
    }

    .onboarding-summary-item {
      margin-bottom: 12px;
    }

    .onboarding-summary-item:last-child {
      margin-bottom: 0;
    }

    .onboarding-summary-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--grey);
      margin-bottom: 4px;
    }

    .onboarding-summary-text {
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    /* GOAL CHECK-IN */
    .checkin-goals-list {
      text-align: left;
      margin-bottom: 20px;
    }

    .checkin-goal-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--grey-light);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .checkin-goal-checkbox {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: var(--teal);
    }

    .checkin-goal-text {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .checkin-goal-text.completed {
      text-decoration: line-through;
      color: var(--grey);
    }

    /* CHAT BACKGROUND GOAL */
    .chat-background-goal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.3rem;
      color: var(--text-primary);
      opacity: 0;
      pointer-events: none;
      text-align: center;
      padding: 40px;
      max-width: 80%;
      font-style: italic;
      transition: opacity 0.5s ease;
      z-index: 1;
    }

    /* SETTINGS OVERLAY */
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: flex-start;
      justify-content: center;
      z-index: 2000;
      padding: 20px;
      overflow-y: auto;
    }

    .settings-overlay.active {
      display: flex;
    }

    .settings-box {
      background: var(--white);
      border-radius: 16px;
      max-width: 480px;
      width: 100%;
      margin: 20px 0;
      box-shadow: 0 8px 32px var(--shadow);
      overflow: hidden;
    }

    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .settings-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
    }

    .settings-close {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--grey-light);
      border-radius: 50%;
      cursor: pointer;
    }

    .settings-close svg {
      width: 18px;
      height: 18px;
      stroke: var(--text-secondary);
    }

    .settings-close:hover {
      background: var(--border);
    }

    .settings-lock-banner {
      background: #fef3c7;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #fcd34d;
    }

    .lock-icon {
      font-size: 1.1rem;
    }

    .lock-text {
      font-size: 0.9rem;
      color: #92400e;
      font-weight: 500;
    }

    .settings-content {
      padding: 8px 0;
    }

    .settings-content.locked {
      opacity: 0.5;
      pointer-events: none;
    }

    .settings-section {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
    }

    .settings-section:last-child {
      border-bottom: none;
    }

    .settings-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 4px;
    }

    .settings-section-desc {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0 0 16px;
      line-height: 1.4;
    }

    .settings-radio {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px 0;
      cursor: pointer;
    }

    .settings-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      margin-top: 2px;
      accent-color: var(--teal);
      cursor: pointer;
    }

    .radio-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .radio-label strong {
      font-size: 0.95rem;
      color: var(--text-primary);
      font-weight: 500;
    }

    .radio-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .settings-radio.strict-mode .radio-label strong {
      color: #dc2626;
    }

    .settings-radio.strict-mode .radio-desc {
      color: #dc2626;
      font-weight: 500;
    }

    .strict-warning {
      background: #fef2f2;
      border-left: 3px solid #dc2626;
      padding: 10px 12px;
      margin: 8px 0 0 32px;
      border-radius: 0 6px 6px 0;
      font-size: 0.8rem;
      color: #991b1b;
      line-height: 1.4;
    }

    .settings-checkbox {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      cursor: pointer;
    }

    .settings-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: var(--teal);
      cursor: pointer;
    }

    .checkbox-label {
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    .settings-lock-section {
      background: var(--grey-light);
    }

    .settings-lock-controls {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .settings-select {
      flex: 1;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 0.95rem;
      background: var(--white);
      cursor: pointer;
      outline: none;
    }

    .settings-select:focus {
      border-color: var(--teal);
    }

    .settings-lock-btn {
      padding: 12px 20px;
      background: #dc2626;
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    .settings-lock-btn:hover {
      background: #b91c1c;
    }

    .settings-action-btn {
      padding: 12px 20px;
      background: #0f766e;
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 500;
      cursor: pointer;
    }

    .settings-action-btn:hover {
      background: #0d5f58;
    }

    .settings-section-note {
      font-size: 0.85rem;
      color: #f59e0b;
      background: #fef3c7;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
    }

    #delayOptions.disabled {
      opacity: 0.4;
      pointer-events: none;
    }

    .lock-time-picker {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .lock-time-row {
      flex: 1;
      text-align: center;
    }

    .lock-time-label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .lock-time-input {
      width: 100%;
      padding: 12px 8px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: 600;
      text-align: center;
      background: var(--white);
      outline: none;
    }

    .lock-time-input:focus {
      border-color: var(--teal);
    }

    .lock-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .lock-preset-btn {
      padding: 8px 14px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .lock-preset-btn:hover {
      background: var(--teal);
      color: var(--white);
      border-color: var(--teal);
    }

    .settings-lock-btn {
      width: 100%;
      padding: 14px 20px;
      background: #dc2626;
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
    }

    /* MESSAGE DELAY OVERLAY */
    .delay-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2500;
    }

    .delay-overlay.active {
      display: flex;
    }

    .delay-box {
      background: var(--white);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 320px;
      width: 90%;
    }

    .delay-countdown {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 24px;
    }

    .delay-ring {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .delay-ring-bg {
      fill: none;
      stroke: var(--grey-light);
      stroke-width: 8;
    }

    .delay-ring-progress {
      fill: none;
      stroke: var(--teal);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 1s linear;
    }

    .delay-time {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .delay-text {
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .delay-hint {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 24px;
      font-style: italic;
    }

    .delay-cancel {
      padding: 12px 32px;
      background: var(--grey-light);
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .delay-cancel:hover {
      background: var(--border);
    }

    .delay-cancel.hidden {
      display: none;
    }

    .friction-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .friction-buttons button {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-cancel {
      background: var(--grey-light);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-unlock {
      background: var(--teal);
      border: none;
      color: var(--white);
      opacity: 0.5;
    }

    .btn-unlock:disabled {
      cursor: not-allowed;
    }

    .btn-unlock.ready {
      opacity: 1;
    }

    .friction-error {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 8px;
      min-height: 20px;
    }

    .friction-timer {
      color: var(--teal);
      font-size: 0.85rem;
      margin-top: 16px;
      min-height: 20px;
    }

    /* =================== */
    /* GOALS VIEW          */
    /* =================== */
    #goals-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #goals-view.active {
      display: block;
    }

    #goals-view .goals-header {
      margin-bottom: 20px;
    }

    #goals-view .goals-section {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
      box-shadow: 0 6px 16px var(--shadow);
    }

    #goals-view .goals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    #goals-view .goals-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #goals-view .goals-textarea {
      width: 100%;
      min-height: 90px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
      resize: vertical;
    }

    #goals-view .goals-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
    }

    #goals-view .goals-btn-secondary {
      border-color: var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #goals-view .goals-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 12px;
    }

    #goals-view .goals-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--white);
    }

    #goals-view .goals-item.completed {
      background: rgba(90, 154, 148, 0.08);
    }

    #goals-view .goals-item-input {
      flex: 1;
      min-width: 180px;
      border: none;
      background: transparent;
      font-size: 0.95rem;
      color: var(--text-primary);
      padding: 0;
    }

    #goals-view .goals-item-input:read-only {
      outline: none;
    }

    #goals-view .goals-item.completed .goals-item-input {
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    #goals-view .goals-item-actions {
      display: flex;
      gap: 8px;
    }

    #goals-view .goals-item-content {
      flex: 1;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #goals-view .goals-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #goals-view .goals-filter {
      margin-top: 12px;
    }

    #goals-view .goals-area-select {
      min-width: 180px;
    }

    #goals-view .goals-area-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--teal-lighter);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #goals-view .goals-banner {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    #goals-view .unstuck-panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #goals-view .unstuck-panel.active {
      display: flex;
    }

    #goals-view .unstuck-steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #goals-view .unstuck-step-row {
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 8px;
      align-items: center;
    }

    #goals-view .unstuck-step-row input {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #goals-view .unstuck-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    /* =================== */
    /* LIFE VIEW           */
    /* =================== */
    #life-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #life-view.active {
      display: block;
    }

    #life-view .life-header {
      margin-bottom: 16px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
    }

    #life-view .life-header-copy {
      max-width: 600px;
    }

    #life-view .life-primary-cta {
      align-self: center;
      min-width: 140px;
    }

    #life-view .life-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    #life-view .life-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #life-view .life-tab {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      cursor: pointer;
      font-size: 0.85rem;
      min-height: 44px;
    }

    #life-view .life-tab.active {
      border-color: var(--teal);
      background: var(--teal-lighter);
      color: var(--text-primary);
    }

    #life-view .life-section {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 6px 16px var(--shadow);
    }

    #life-view .life-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    #life-view .life-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    #life-view .life-topbar-copy {
      max-width: 680px;
    }

    #life-view .life-topbar-profile {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      box-shadow: 0 8px 18px var(--shadow);
    }

    #life-view .life-profile-pic {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid rgba(90, 154, 148, 0.3);
      background: rgba(90, 154, 148, 0.1);
    }

    #life-view .life-profile-email {
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    #life-view .life-domain-strip {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    #life-view .life-domain-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 40px;
      transition: all 0.2s ease;
    }

    #life-view .life-domain-btn.active {
      border-color: rgba(90, 154, 148, 0.6);
      background: var(--teal-lighter);
      color: var(--teal-dark);
      box-shadow: 0 8px 18px rgba(69, 152, 145, 0.15);
    }

    #life-view .life-domain-web {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    #life-view .life-node-strip {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 6px 4px 12px;
      scroll-snap-type: x proximity;
    }

    #life-view .life-node-bubble {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 78px;
      scroll-snap-align: start;
    }

    #life-view .life-node-btn {
      width: 66px;
      height: 66px;
      border-radius: 50%;
      border: 2px solid transparent;
      background: var(--white);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--teal-dark);
    }

    #life-view .life-node-btn:active {
      transform: scale(0.97);
    }

    #life-view .life-node-btn img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
    }

    #life-view .life-node-btn.is-active {
      border-color: var(--teal);
      box-shadow: 0 0 0 4px rgba(90, 154, 148, 0.2);
    }

    #life-view .life-node-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-align: center;
      max-width: 90px;
      line-height: 1.2;
      word-break: break-word;
    }

    #life-view .life-node-add {
      border-style: dashed;
      color: var(--teal);
      font-size: 1.4rem;
      font-weight: 600;
    }

    #life-view .life-domain-panel {
      background: var(--white);
      border-radius: 20px;
      border: 1px solid rgba(90, 154, 148, 0.2);
      padding: 18px;
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 140px;
    }

    #life-view .life-panel-empty {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    #life-view .life-domain-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #life-view .life-domain-summary {
      display: grid;
      gap: 6px;
      font-size: 0.95rem;
    }

    #life-view .life-domain-row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #life-view .life-domain-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    #life-view .life-domain-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-domain-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      align-items: center;
    }

    #life-view .life-domain-subitem {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: rgba(248, 250, 252, 0.7);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #life-view .life-domain-subitem-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    #life-view .life-domain-subitem-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .life-domain-task-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: var(--white);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-input,
    #life-view .life-select,
    #life-view .life-textarea {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
      font: inherit;
    }

    #life-view .life-input {
      flex: 1;
      min-width: 200px;
    }

    #life-view .life-textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    #life-view .life-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      min-height: 44px;
    }

    #life-view .life-btn.secondary {
      border-color: var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #life-view .life-btn[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #life-view .life-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: var(--white);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #life-view .life-item.completed {
      background: rgba(90, 154, 148, 0.08);
      text-decoration: line-through;
      color: var(--text-secondary);
    }

    #life-view .life-item-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #life-view .life-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .life-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--teal-lighter);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #life-view .life-people-layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #life-view .life-people-form {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      background: var(--white);
      box-shadow: 0 8px 18px var(--shadow);
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-people-form.active {
      display: flex;
    }

    #life-view .life-people-form-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #life-view .life-avatar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
    }

    #life-view .life-avatar-preview {
      width: 72px;
      height: 72px;
      border-radius: 18px;
      border: 1px solid var(--border);
      overflow: hidden;
      display: grid;
      place-items: center;
      background: rgba(90, 154, 148, 0.08);
    }

    #life-view .life-avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #life-view .life-avatar-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #life-view .life-people-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
    }

    #life-view .life-person-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: var(--white);
      box-shadow: 0 10px 20px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #life-view.person-view-active .life-header,
    #life-view.person-view-active .life-controls,
    #life-view.person-view-active [data-tab-panel] {
      display: none;
    }

    #life-view .life-person-view {
      display: none;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 24px var(--shadow);
    }

    #life-view.person-view-active .life-person-view {
      display: block;
    }

    #life-view .life-person-header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    #life-view .life-person-identity {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #life-view .life-person-avatar {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(90, 154, 148, 0.12);
    }

    #life-view .life-person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    #life-view .life-person-role-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(90, 154, 148, 0.12);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #life-view .life-person-org {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #life-view .life-agenda-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: var(--white);
      box-shadow: 0 12px 24px var(--shadow);
    }

    #life-view .life-agenda-controls {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 16px;
    }

    #life-view .life-agenda-segmented {
      display: inline-flex;
      gap: 6px;
      padding: 4px;
      border-radius: 999px;
      background: rgba(90, 154, 148, 0.12);
      border: 1px solid rgba(90, 154, 148, 0.2);
    }

    #life-view .life-agenda-segment {
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      min-height: 36px;
    }

    #life-view .life-agenda-segment.active {
      background: var(--white);
      color: var(--text-primary);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    #life-view .life-agenda-list {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    #life-view .life-agenda-day {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-agenda-day-header {
      font-size: 0.75rem;
      letter-spacing: 0.12em;
      color: var(--text-secondary);
      font-weight: 600;
      margin-bottom: 10px;
    }

    #life-view .life-agenda-item {
      display: grid;
      grid-template-columns: 4px 1fr auto;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      cursor: pointer;
      align-items: center;
      transition: box-shadow 0.2s ease, transform 0.2s ease;
    }

    #life-view .life-agenda-item:hover {
      box-shadow: 0 10px 20px var(--shadow);
      transform: translateY(-1px);
    }

    #life-view .life-agenda-accent {
      width: 4px;
      height: 100%;
      border-radius: 999px;
      background: var(--teal);
    }

    #life-view .life-agenda-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    #life-view .life-agenda-location {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    #life-view .life-agenda-actions {
      margin-top: 6px;
    }

    #life-view .life-agenda-direction {
      border: none;
      background: none;
      padding: 0;
      font-size: 0.8rem;
      color: var(--teal-dark);
      cursor: pointer;
    }

    #life-view .life-agenda-time {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      text-align: right;
      white-space: nowrap;
    }

    #life-view .life-agenda-empty {
      font-size: 0.9rem;
      color: var(--text-secondary);
      padding: 10px 0;
    }

    #life-view .life-person-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 24px var(--shadow);
    }

    #life-view .life-person-top {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    #life-view .life-person-name {
      font-size: 1rem;
      font-weight: 600;
    }

    #life-view .life-person-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #life-view .life-person-role {
      display: inline-flex;
      align-items: center;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(90, 154, 148, 0.12);
      font-size: 0.75rem;
      color: var(--text-primary);
    }

    #life-view .life-person-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #life-view .life-people-empty {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 18px;
      text-align: center;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.7);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: center;
      justify-content: center;
    }

    #life-view.people-active .life-controls {
      align-items: flex-start;
    }

    #life-view .life-area-hidden {
      display: none;
    }

    @media (max-width: 720px) {
      #life-view .life-people-grid {
        grid-template-columns: 1fr;
      }

      #life-view .life-person-card {
        width: 100%;
      }
    }

    #life-view .unstuck-panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.9);
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .unstuck-panel.active {
      display: flex;
    }

    #life-view .unstuck-steps {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #life-view .unstuck-step-row {
      display: grid;
      grid-template-columns: 1fr 80px;
      gap: 8px;
      align-items: center;
    }

    #life-view .unstuck-step-row input {
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #life-view .life-appointments-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-appointments-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 600;
      padding: 8px 4px;
      cursor: pointer;
    }

    #life-view .life-chevron {
      transition: transform 0.2s ease;
      font-size: 1.1rem;
    }

    #life-view .life-appointments-toggle[aria-expanded="false"] .life-chevron {
      transform: rotate(-90deg);
    }

    #life-view .life-appointments-body.is-collapsed {
      display: none;
    }

    #life-view .life-appointments-actions {
      display: flex;
      justify-content: flex-start;
    }

    #life-view .life-tasks-card {
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    #life-view .life-tasks-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
      border: none;
      background: transparent;
      font-size: 1rem;
      font-weight: 600;
      padding: 8px 4px;
      cursor: pointer;
    }

    #life-view .life-tasks-toggle[aria-expanded="false"] .life-chevron {
      transform: rotate(-90deg);
    }

    #life-view .life-tasks-body.is-collapsed {
      display: none;
    }

    #life-view .life-tasks-actions {
      display: flex;
      justify-content: flex-start;
    }

    #life-view .life-tasks-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-tasks-form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      align-items: center;
    }

    #life-view .life-tasks-list,
    #life-view .life-tasks-completed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-tasks-completed-toggle {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      text-align: left;
      padding: 4px 0;
      min-height: 44px;
    }

    #life-view .life-task-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: var(--white);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-task-header {
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
    }

    #life-view .life-task-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #life-view .life-task-title {
      font-weight: 600;
      font-size: 0.98rem;
      color: var(--text-primary);
      border: none;
      background: transparent;
      text-align: left;
      padding: 4px 0;
      cursor: pointer;
    }

    #life-view .life-task-progress {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .life-task-chip {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 0.75rem;
      background: rgba(90, 154, 148, 0.12);
      color: var(--teal-dark);
      border: 1px solid rgba(90, 154, 148, 0.2);
      text-transform: capitalize;
    }

    #life-view .life-task-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #life-view .life-task-actions .life-btn,
    #life-view .life-task-actions .life-btn.secondary {
      min-height: 44px;
    }

    #life-view .life-task-icon {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 0.85rem;
      background: var(--white);
      cursor: pointer;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #life-view .life-task-chevron {
      transition: transform 0.2s ease;
    }

    #life-view .life-task-card:not(.expanded) .life-task-chevron {
      transform: rotate(-90deg);
    }

    #life-view .life-task-body {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    #life-view .life-task-card.expanded .life-task-body {
      display: flex;
    }

    #life-view .life-task-notes {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    #life-view .life-task-plan {
      display: flex;
      flex-direction: column;
      gap: 6px;
      border: 1px solid rgba(90, 154, 148, 0.2);
      border-radius: 12px;
      padding: 10px;
      background: rgba(90, 154, 148, 0.06);
      font-size: 0.9rem;
    }

    #life-view .life-task-plan-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    #life-view .life-task-plan-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    #life-view .life-task-plan-list li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    #life-view .life-task-plan-list input {
      margin-top: 2px;
    }

    #life-view .life-task-checklist {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    #life-view .life-task-checklist li {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    #life-view .life-task-checklist input {
      margin-top: 2px;
    }

    #life-view .life-task-step.completed span {
      text-decoration: line-through;
      opacity: 0.6;
    }

    #life-view .life-task-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #life-view .life-task-controls .life-btn,
    #life-view .life-task-controls .life-btn.secondary,
    #life-view .life-task-controls .life-task-icon {
      min-height: 32px;
      font-size: 0.8rem;
      padding: 6px 10px;
    }

    #life-view .life-task-clarification {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    #life-view .life-task-plan-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    #life-view .life-task-status {
      color: #b45309;
      font-size: 0.85rem;
    }

    #life-view .life-appointments-list,
    #life-view .life-appointments-past,
    #appointments-view .appointments-feed {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .life-appointments-past-toggle,
    #appointments-view .appointments-past-toggle {
      border: none;
      background: transparent;
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      text-align: left;
      padding: 4px 0;
      min-height: 44px;
    }

    #life-view .appointment-card,
    #appointments-view .appointment-card {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 0;
      background: var(--white);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #life-view .appointment-header,
    #appointments-view .appointment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      width: 100%;
      background: transparent;
      border: none;
      cursor: pointer;
      text-align: left;
      min-height: 56px;
    }

    #life-view .appointment-chevron,
    #appointments-view .appointment-chevron {
      transition: transform 0.2s ease;
      color: var(--text-secondary);
    }

    #life-view .appointment-card.expanded .appointment-chevron,
    #appointments-view .appointment-card.expanded .appointment-chevron {
      transform: rotate(180deg);
    }

    #life-view .appointment-header-content,
    #appointments-view .appointment-header-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #life-view .appointment-title,
    #appointments-view .appointment-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    #life-view .appointment-meta,
    #appointments-view .appointment-meta {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    #life-view .appointment-body,
    #appointments-view .appointment-body {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: max-height 0.2s ease, opacity 0.2s ease;
      padding: 0 16px;
    }

    #life-view .appointment-card.expanded .appointment-body,
    #appointments-view .appointment-card.expanded .appointment-body {
      max-height: 500px;
      opacity: 1;
      padding-bottom: 16px;
    }

    #life-view .appointment-detail,
    #appointments-view .appointment-detail {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    #life-view .appointment-detail span,
    #appointments-view .appointment-detail span {
      color: var(--text-secondary);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    #life-view .appointment-actions,
    #appointments-view .appointment-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }

    #life-view .appointment-action,
    #appointments-view .appointment-action {
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      font-size: 0.85rem;
      cursor: pointer;
      text-decoration: none;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    #life-view .appointment-action.primary,
    #appointments-view .appointment-action.primary {
      background: var(--teal);
      color: var(--white);
      border-color: transparent;
    }

    #life-view .appointment-empty,
    #appointments-view .appointment-empty {
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 8px 0;
    }

    #life-view .appointment-modal,
    #appointments-view .appointment-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
      padding: 24px;
    }

    #life-view .appointment-modal.active,
    #appointments-view .appointment-modal.active {
      display: flex;
    }

    #life-view .appointment-modal-backdrop,
    #appointments-view .appointment-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
    }

    #life-view .appointment-modal-card,
    #appointments-view .appointment-modal-card {
      position: relative;
      background: var(--white);
      border-radius: 18px;
      padding: 20px;
      width: min(92vw, 520px);
      max-height: min(86vh, 720px);
      overflow-y: auto;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.2);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #life-view .appointment-modal-header,
    #appointments-view .appointment-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #life-view .appointment-form,
    #appointments-view .appointment-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .appointment-row,
    #appointments-view .appointment-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }

    #life-view .appointment-field,
    #appointments-view .appointment-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #life-view .appointment-field label,
    #appointments-view .appointment-field label {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .appointment-modal-actions,
    #appointments-view .appointment-modal-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #appointments-view .appointments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    #appointments-view .appointments-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    #appointments-view .appointments-chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      background: var(--white);
      min-height: 44px;
    }

    #appointments-view .appointments-chip.active {
      background: var(--teal);
      color: var(--white);
      border-color: transparent;
    }

    #appointments-view .appointments-btn {
      border-radius: 999px;
      padding: 10px 16px;
      border: none;
      background: var(--teal);
      color: var(--white);
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
    }

    #appointments-view .appointments-btn.secondary {
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      font-weight: 500;
    }

    #life-view .appointments-textarea,
    #appointments-view .appointments-input,
    #appointments-view .appointments-select,
    #appointments-view .appointments-textarea {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.95rem;
      background: var(--white);
      color: var(--text-primary);
    }

    #life-view .appointments-textarea,
    #appointments-view .appointments-textarea {
      min-height: 90px;
      resize: vertical;
    }

    #life-view .appointments-scan,
    #life-view .appointments-parse,
    #appointments-view .appointments-scan,
    #appointments-view .appointments-parse {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--white);
    }

    #life-view .appointments-scan-title,
    #appointments-view .appointments-scan-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    #life-view .appointments-scan-actions,
    #life-view .appointments-parse-actions,
    #appointments-view .appointments-scan-actions,
    #appointments-view .appointments-parse-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #life-view .appointments-scan-preview,
    #appointments-view .appointments-scan-preview {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #life-view .appointments-scan-image,
    #appointments-view .appointments-scan-image {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      object-fit: cover;
      max-height: 220px;
    }

    #life-view .appointments-scan-note,
    #appointments-view .appointments-scan-note {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #life-view .appointments-text-details,
    #appointments-view .appointments-text-details {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #life-view .appointments-text-preview,
    #appointments-view .appointments-text-preview {
      white-space: pre-wrap;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-top: 8px;
      color: var(--text-primary);
      background: rgba(248, 250, 252, 0.6);
    }

    #life-view .appointments-summary,
    #appointments-view .appointments-summary {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background: var(--white);
    }

    #life-view .appointments-summary-card,
    #appointments-view .appointments-summary-card {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #life-view .appointments-summary-header,
    #appointments-view .appointments-summary-header {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    #life-view .appointments-summary-rows,
    #appointments-view .appointments-summary-rows {
      display: grid;
      gap: 10px;
    }

    #life-view .appointments-summary-row,
    #appointments-view .appointments-summary-row {
      display: grid;
      grid-template-columns: minmax(0, 120px) minmax(0, 1fr) auto;
      gap: 12px;
      align-items: center;
      padding: 10px;
      border-radius: 12px;
      background: rgba(248, 250, 252, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    #life-view .appointments-summary-label,
    #appointments-view .appointments-summary-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    #life-view .appointments-summary-value,
    #appointments-view .appointments-summary-value {
      font-size: 0.95rem;
      color: var(--text-primary);
      word-break: break-word;
    }

    #life-view .appointments-summary-value.has-actions,
    #appointments-view .appointments-summary-value.has-actions {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #life-view .appointments-summary-inline-actions,
    #appointments-view .appointments-summary-inline-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    #life-view .appointments-summary-link,
    #appointments-view .appointments-summary-link {
      color: var(--text-primary);
      text-decoration: underline;
    }

    #life-view .appointments-summary-link-btn,
    #appointments-view .appointments-summary-link-btn {
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      text-decoration: none;
    }

    #life-view .appointments-summary-value.is-empty,
    #appointments-view .appointments-summary-value.is-empty {
      color: var(--text-secondary);
    }

    #life-view .appointments-summary-row-actions,
    #appointments-view .appointments-summary-row-actions {
      display: flex;
      gap: 8px;
    }

    #life-view .appointments-icon-btn,
    #appointments-view .appointments-icon-btn {
      border: 1px solid var(--border);
      background: var(--white);
      border-radius: 999px;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    #life-view .appointments-summary-edit,
    #appointments-view .appointments-summary-edit {
      grid-column: 2 / span 2;
    }

    #life-view .appointments-summary-edit input,
    #life-view .appointments-summary-edit textarea,
    #appointments-view .appointments-summary-edit input,
    #appointments-view .appointments-summary-edit textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    #life-view .appointments-summary-edit textarea,
    #appointments-view .appointments-summary-edit textarea {
      min-height: 90px;
      resize: vertical;
    }

    #life-view .appointments-summary-notes details,
    #appointments-view .appointments-summary-notes details {
      color: var(--text-primary);
    }

    #life-view .appointments-summary-notes summary,
    #appointments-view .appointments-summary-notes summary {
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 6px;
    }

    #life-view .appointments-summary-notes .appointments-summary-notes-text,
    #appointments-view .appointments-summary-notes .appointments-summary-notes-text {
      margin-top: 6px;
      white-space: pre-wrap;
      color: var(--text-primary);
    }

    #life-view .appointments-summary-actions,
    #appointments-view .appointments-summary-actions {
      margin-top: 4px;
    }

    #life-view .appointments-form-fields.is-hidden,
    #appointments-view .appointments-form-fields.is-hidden {
      display: none;
    }

    /* =================== */
    /* LIFE BUBBLE HEADS    */
    /* =================== */
    #life-view .life-bubbles-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 16px;
    }

    #life-view .life-bubbles-copy {
      max-width: 640px;
    }

    #life-view .life-group-toggle {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      box-shadow: 0 6px 16px var(--shadow);
    }

    #life-view .life-group-toggle[aria-pressed="true"] {
      background: var(--teal-lighter);
      border-color: rgba(90, 154, 148, 0.6);
      color: var(--teal-dark);
    }

    #life-view .life-group-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--teal);
      opacity: 0.6;
    }

    #life-view .life-bubble-strip {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 6px 4px 12px;
      margin-bottom: 20px;
      scroll-snap-type: x proximity;
    }

    #life-view .life-bubble {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 72px;
      scroll-snap-align: start;
    }

    #life-view .life-bubble-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid transparent;
      background: var(--white);
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      touch-action: none;
      -webkit-touch-callout: none;
    }

    #life-view .life-bubble-btn:active {
      transform: scale(0.97);
    }

    #life-view .life-bubble-btn img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: cover;
    }

    #life-view .life-bubble-btn.is-active {
      border-color: var(--teal);
      box-shadow: 0 0 0 4px rgba(90, 154, 148, 0.2);
    }

    #life-view .life-bubble-check {
      position: absolute;
      right: -2px;
      bottom: -2px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--teal);
      color: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      border: 2px solid var(--white);
      opacity: 0;
      transform: scale(0.8);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }

    #life-view.group-mode-active .life-bubble-btn.is-selected .life-bubble-check {
      opacity: 1;
      transform: scale(1);
    }

    #life-view .life-bubble-name {
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-align: center;
      max-width: 80px;
      line-height: 1.2;
      word-break: break-word;
    }

    #life-view .life-bubble-add {
      border-style: dashed;
      color: var(--teal);
      font-size: 1.4rem;
      font-weight: 600;
    }

    #life-view .life-bubble-menu-overlay {
      position: fixed;
      inset: 0;
      display: none;
      z-index: 1100;
    }

    #life-view .life-bubble-menu-overlay.active {
      display: block;
    }

    #life-view .life-bubble-menu {
      position: absolute;
      min-width: 180px;
      padding: 8px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.18);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #life-view .life-bubble-menu-item {
      border: none;
      background: transparent;
      text-align: left;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
    }

    #life-view .life-bubble-menu-item:hover {
      background: var(--teal-lighter);
    }

    #life-view .life-bubble-menu-item.danger {
      color: #b91c1c;
    }

    #life-view .life-bubble-menu-item.danger:hover {
      background: #fee2e2;
    }

    #life-view .life-active-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #life-view .life-active-card {
      background: var(--white);
      border-radius: 20px;
      border: 1px solid rgba(90, 154, 148, 0.2);
      padding: 18px;
      box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #life-view .life-active-top {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    #life-view .life-active-avatar img {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(90, 154, 148, 0.2);
    }

    #life-view .life-active-details {
      flex: 1;
      min-width: 0;
    }

    #life-view .life-active-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #life-view .life-active-role,
    #life-view .life-active-dob {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #life-view .life-active-notes {
      font-size: 0.9rem;
      color: var(--text-secondary);
      background: var(--teal-lighter);
      border-radius: 12px;
      padding: 12px;
    }

    #life-view .life-active-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #life-view .life-icon-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      padding: 6px 10px;
      cursor: pointer;
    }

    #life-view .life-active-edit {
      border-top: 1px solid rgba(90, 154, 148, 0.2);
      padding-top: 16px;
      display: grid;
      gap: 10px;
    }

    #life-view .life-edit-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #life-view .life-placeholder-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    #life-view .life-placeholder-card {
      background: rgba(255, 255, 255, 0.7);
      border: 1px dashed rgba(107, 114, 128, 0.3);
      border-radius: 16px;
      padding: 16px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    #life-view .life-prefs-list {
      display: grid;
      gap: 10px;
      margin: 6px 0 10px;
    }

    #life-view .life-prefs-option {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    #life-view .life-group-panel {
      display: none;
    }

    #life-view.group-mode-active .life-group-panel {
      display: block;
    }

    #life-view .life-group-card {
      background: var(--white);
      border-radius: 16px;
      border: 1px solid rgba(90, 154, 148, 0.2);
      padding: 16px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.06);
    }

    #life-view .life-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 40;
    }

    #life-view .life-modal.active {
      display: flex;
    }

    #life-view .life-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.4);
    }

    #life-view .life-modal-card {
      position: relative;
      background: var(--white);
      border-radius: 20px;
      padding: 20px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.2);
      display: grid;
      gap: 12px;
      z-index: 1;
    }

    #life-view .life-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #life-view .life-modal-body {
      display: grid;
      gap: 12px;
    }

    #life-view .life-photo-preview {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid rgba(90, 154, 148, 0.2);
    }

    #life-view .life-modal-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    #life-view .life-member-panel .life-modal-card {
      max-width: 360px;
    }

    #life-view .life-member-panel-body {
      display: grid;
      gap: 10px;
    }

    #life-view .life-member-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--teal-lighter);
      border: 1px solid rgba(90, 154, 148, 0.2);
    }

    #life-view .life-member-label {
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-secondary);
      font-weight: 600;
    }

    #life-view .life-member-value {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #appointments-view .appointments-btn.is-loading .appointments-ai-label {
      opacity: 0.6;
    }

    #appointments-view .appointments-ai-dots {
      display: none;
      gap: 4px;
      align-items: center;
      margin-left: 8px;
    }

    #appointments-view .appointments-ai-dots span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: currentColor;
      opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out;
    }

    #appointments-view .appointments-ai-dots span:nth-child(2) { animation-delay: 0.2s; }
    #appointments-view .appointments-ai-dots span:nth-child(3) { animation-delay: 0.4s; }

    #appointments-view .appointments-btn.is-loading .appointments-ai-dots {
      display: inline-flex;
    }

    #calendar-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #calendar-view.active {
      display: block;
    }

    #calendar-view .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }

    #calendar-view .calendar-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
      box-shadow: 0 8px 18px var(--shadow);
      margin-bottom: 18px;
    }

    #calendar-view .calendar-month-label {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
      letter-spacing: 0.01em;
    }

    #calendar-view .calendar-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
      padding: 10px 16px;
      font-size: 0.95rem;
      min-height: 44px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    #calendar-view .calendar-btn.primary {
      background: var(--teal);
      color: var(--white);
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(69, 152, 145, 0.2);
    }

    #calendar-view .calendar-btn.secondary {
      background: rgba(255, 255, 255, 0.7);
    }

    #calendar-view .calendar-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #calendar-view .calendar-toggle input {
      accent-color: var(--teal);
    }

    #calendar-view .calendar-modal.person-locked .calendar-person-row {
      display: none;
    }

    #calendar-view .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
    }

    #calendar-view .calendar-weekday {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    #calendar-view .calendar-day {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      min-height: 110px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #calendar-view .calendar-day:hover {
      border-color: rgba(69, 152, 145, 0.5);
      box-shadow: 0 6px 14px var(--shadow);
    }

    #calendar-view .calendar-day.outside {
      opacity: 0.4;
    }

    #calendar-view .calendar-day-number {
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    #calendar-view .calendar-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.72rem;
      color: var(--text-primary);
      background: rgba(69, 152, 145, 0.12);
      border: 1px solid rgba(69, 152, 145, 0.2);
      max-width: 100%;
    }

    #calendar-view .calendar-chip img {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    #calendar-view .calendar-chip span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #calendar-view .calendar-chip-more {
      background: rgba(0, 0, 0, 0.05);
      border-color: rgba(0, 0, 0, 0.1);
      color: var(--text-secondary);
      justify-content: center;
    }

    #calendar-view .calendar-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 40;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #calendar-view .calendar-modal.active {
      display: flex;
    }

    #calendar-view .calendar-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(8, 12, 18, 0.45);
      backdrop-filter: blur(4px);
    }

    #calendar-view .calendar-modal-card {
      position: relative;
      width: min(560px, 100%);
      max-height: min(80vh, 720px);
      overflow-y: auto;
      background: var(--white);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 1;
    }

    #calendar-view .calendar-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #calendar-view .calendar-day-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #calendar-view .calendar-event-card {
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #calendar-view .calendar-event-header {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    #calendar-view .calendar-event-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      overflow: hidden;
      flex-shrink: 0;
    }

    #calendar-view .calendar-event-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #calendar-view .calendar-event-title {
      font-weight: 600;
      color: var(--text-primary);
    }

    #calendar-view .calendar-event-meta {
      font-size: 0.82rem;
      color: var(--text-secondary);
    }

    #calendar-view .calendar-event-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    #calendar-view .calendar-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #calendar-view .calendar-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    #calendar-view .calendar-form-row.single {
      grid-template-columns: 1fr;
    }

    #calendar-view .calendar-input,
    #calendar-view .calendar-select,
    #calendar-view .calendar-textarea {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 0.95rem;
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.9);
      min-height: 44px;
    }

    #calendar-view .calendar-textarea {
      min-height: 90px;
      resize: vertical;
    }

    #calendar-view .calendar-person-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #calendar-view .calendar-person-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    #calendar-view .calendar-person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #calendar-view .calendar-repeat-options {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    #calendar-view .calendar-repeat-day {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 0;
      text-align: center;
      font-size: 0.8rem;
      cursor: pointer;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.8);
    }

    #calendar-view .calendar-repeat-day input {
      display: none;
    }

    #calendar-view .calendar-repeat-day.active {
      background: rgba(69, 152, 145, 0.15);
      border-color: rgba(69, 152, 145, 0.4);
      color: var(--text-primary);
      font-weight: 600;
    }

    #calendar-view .calendar-empty {
      border-radius: 16px;
      border: 1px dashed var(--border);
      padding: 16px;
      text-align: center;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.7);
    }

    @media (max-width: 900px) {
      #calendar-view .calendar-form-row {
        grid-template-columns: 1fr;
      }

      #calendar-view .calendar-repeat-options {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    /* =================== */
    /* CALENDAR IMPORT     */
    /* =================== */
    #calendar-import-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      max-width: 720px;
      margin: 0 auto;
      padding: 48px 24px calc(48px + var(--safe-bottom));
    }

    #calendar-import-view.active {
      display: block;
    }

    #calendar-import-view .calendar-import-card {
      background: var(--white);
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 20px 40px -30px rgba(31, 41, 55, 0.35);
      border: 1px solid rgba(209, 213, 219, 0.6);
    }

    #calendar-import-view .calendar-import-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 20px;
    }

    #calendar-import-view .calendar-import-meta {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin: 0;
    }

    #calendar-import-view .calendar-import-form {
      display: grid;
      gap: 16px;
    }

    #calendar-import-view .calendar-import-row {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    #calendar-import-view .calendar-import-input,
    #calendar-import-view .calendar-import-select,
    #calendar-import-view .calendar-import-textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fafc;
    }

    #calendar-import-view .calendar-import-textarea {
      min-height: 120px;
      resize: vertical;
    }

    #calendar-import-view .calendar-import-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 0.95rem;
      color: var(--text-primary);
    }

    #calendar-import-view .calendar-import-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    #calendar-import-view .calendar-import-btn {
      border-radius: 999px;
      padding: 10px 18px;
      border: 1px solid transparent;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--teal);
      color: var(--white);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    #calendar-import-view .calendar-import-btn.secondary {
      background: var(--white);
      color: var(--text-primary);
      border-color: var(--border);
    }

    #calendar-import-view .calendar-import-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px -18px rgba(31, 41, 55, 0.3);
    }

    #calendar-import-view .calendar-import-preview {
      background: #f3f4f6;
      border-radius: 14px;
      padding: 14px;
      font-size: 0.95rem;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    #calendar-import-view .calendar-import-notes summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    #calendar-import-view .calendar-import-success {
      display: none;
      text-align: center;
      padding: 40px 24px;
    }

    #calendar-import-view .calendar-import-success.active {
      display: block;
    }

    #calendar-import-view .calendar-import-success h3 {
      margin: 0 0 8px;
      font-size: 1.4rem;
    }

    #calendar-import-view .calendar-import-success p {
      margin: 0 0 20px;
      color: var(--text-secondary);
    }

    @media (max-width: 640px) {
      #calendar-import-view {
        padding: 32px 18px calc(32px + var(--safe-bottom));
      }

      #calendar-import-view .calendar-import-card {
        padding: 20px;
      }
    }
    /* =================== */
    /* FRICTION SOCIAL     */
    /* =================== */
    #friction-social-view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + var(--safe-bottom));
    }

    #friction-social-view.active {
      display: block;
    }

    #friction-social-view .fs-header {
      margin-bottom: 20px;
    }

    #friction-social-view .fs-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
    }

    #friction-social-view .fs-friction-controls {
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-shadow: 0 6px 16px var(--shadow);
    }

    #friction-social-view .fs-friction-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    #friction-social-view .fs-friction-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    #friction-social-view .fs-friction-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      min-width: 130px;
    }

    #friction-social-view .fs-friction-options {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    #friction-social-view .fs-friction-options label,
    #friction-social-view .fs-friction-toggle {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    #friction-social-view .fs-search {
      flex: 1;
      min-width: 220px;
    }

    #friction-social-view .fs-search input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--white);
    }

    #friction-social-view .fs-add-btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #friction-social-view .fs-add-btn:hover {
      background: var(--teal-dark);
    }

    #friction-social-view .fs-secondary-btn {
      border: 1px solid var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #friction-social-view .fs-secondary-btn:hover {
      background: var(--grey-light);
    }

    #friction-social-view .fs-shelf {
      margin-bottom: 24px;
    }

    #friction-social-view .fs-shelf-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    #friction-social-view .fs-shelf-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #friction-social-view .fs-refresh-btn {
      padding: 6px 10px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    #friction-social-view .fs-shelf-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #friction-social-view .fs-shelf-count {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-row {
      display: flex;
      gap: 14px;
      overflow-y: hidden;
      overflow-x: auto;
      padding: 4px 8px 10px;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scroll-padding: 0 8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }

    #friction-social-view .fs-row::-webkit-scrollbar {
      height: 6px;
    }

    #friction-social-view .fs-row::-webkit-scrollbar-track {
      background: transparent;
    }

    #friction-social-view .fs-row::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 999px;
    }

    #friction-social-view .fs-card {
      flex: 0 0 auto;
      width: clamp(160px, 42vw, 220px);
      position: relative;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      text-align: left;
      cursor: pointer;
      box-shadow: 0 6px 16px var(--shadow);
      scroll-snap-align: start;
    }

    #friction-social-view .fs-card img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      background: var(--grey-light);
    }

    #friction-social-view .fs-card-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.65rem;
      font-weight: 600;
      background: rgba(15, 23, 42, 0.8);
      color: var(--white);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    #friction-social-view .fs-card-badge--latest {
      background: var(--teal);
    }

    #friction-social-view .fs-card-badge--seen {
      top: auto;
      bottom: 8px;
      background: rgba(30, 41, 59, 0.75);
      text-transform: none;
    }

    #friction-social-view .fs-card-body {
      padding: 10px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #friction-social-view .fs-card-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    #friction-social-view .fs-card-channel {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-empty {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-align: center;
      padding: 32px 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.6);
    }

    #friction-social-view .fs-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }

    #friction-social-view .fs-modal.active {
      display: flex;
    }

    #friction-social-view .fs-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
    }

    #friction-social-view .fs-modal-card {
      position: relative;
      width: min(90vw, 860px);
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      z-index: 1;
      display: flex;
      flex-direction: column;
    }

    #friction-social-view .fs-modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--white);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    #friction-social-view .fs-modal-player {
      width: 100%;
      background: #000;
      aspect-ratio: 16 / 9;
    }

    #friction-social-view .fs-modal-player iframe {
      width: 100%;
      height: 100%;
      border: 0;
    }

    #friction-social-view .fs-modal-meta {
      padding: 16px 20px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #friction-social-view .fs-modal-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    #friction-social-view .fs-modal-channel {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-modal-link {
      font-size: 0.85rem;
      color: var(--teal-dark);
      text-decoration: none;
      font-weight: 500;
    }

    #friction-social-view.modal-open {
      overflow: hidden;
    }

    #friction-social-view .fs-intent-overlay,
    #friction-social-view .fs-pause-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3100;
      padding: 24px;
    }

    #friction-social-view .fs-intent-overlay.active,
    #friction-social-view .fs-pause-overlay.active {
      display: flex;
    }

    #friction-social-view .fs-intent-backdrop,
    #friction-social-view .fs-pause-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
    }

    #friction-social-view .fs-intent-card,
    #friction-social-view .fs-pause-card {
      position: relative;
      z-index: 1;
      width: min(92vw, 520px);
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    #friction-social-view .fs-intent-title,
    #friction-social-view .fs-pause-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }

    #friction-social-view .fs-intent-text,
    #friction-social-view .fs-pause-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0;
    }

    #friction-social-view .fs-intent-actions,
    #friction-social-view .fs-pause-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #friction-social-view .fs-intent-btn,
    #friction-social-view .fs-pause-btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--teal);
      background: var(--teal);
      color: var(--white);
      font-weight: 500;
      cursor: pointer;
    }

    #friction-social-view .fs-intent-btn.secondary,
    #friction-social-view .fs-pause-btn.secondary {
      border-color: var(--border);
      background: var(--white);
      color: var(--text-primary);
    }

    #friction-social-view .fs-intent-checkbox {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-pause-timer {
      font-size: 0.9rem;
      color: var(--text-secondary);
      min-height: 20px;
    }

    #friction-social-view .fs-pause-upnext {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--grey-light);
    }

    #friction-social-view .fs-pause-upnext.active {
      display: flex;
    }

    #friction-social-view .fs-pause-goal {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    #friction-social-view .fs-pause-goal-text {
      font-weight: 600;
      color: var(--text-primary);
    }

    #friction-social-view .fs-pause-goal-action {
      border: none;
      background: transparent;
      color: var(--teal-dark);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
    }

    #friction-social-view .fs-pause-goal-action:disabled {
      color: var(--text-secondary);
      cursor: default;
    }

    /* =================== */
    /* MOBILE RESPONSIVE   */
    /* =================== */
    @media (max-width: 600px) {
      .homepage { padding: 40px 20px; }
      .headline { font-size: 1.7rem; }

      .auth-buttons {
        flex-direction: column;
        align-items: center;
      }

      .btn-oauth {
        width: 100%;
        max-width: 280px;
        justify-content: center;
      }

      .friction-code { font-size: 1rem; }
      .message { max-width: 90%; }
    }

    /* CODE CANVAS */
    .code-canvas-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); z-index: 2000; }
    .code-canvas-overlay.active { display: block; }
    .code-canvas { position: fixed; top: 0; right: 0; bottom: 0; width: 50%; min-width: 400px; max-width: 800px; background: var(--white); transform: translateX(100%); transition: transform 0.3s ease; z-index: 2001; display: flex; flex-direction: column; box-shadow: -4px 0 24px rgba(0,0,0,0.15); }
    .code-canvas.active { transform: translateX(0); }
    .code-canvas-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: var(--teal-lighter); border-bottom: 1px solid var(--border); }
    .code-canvas-title { display: flex; align-items: center; gap: 10px; }
    .code-canvas-title span { color: var(--text-primary); font-size: 0.9rem; font-weight: 500; }
    .code-canvas-title svg { stroke: var(--teal); }
    .code-canvas-lang { background: var(--teal); color: var(--white); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; text-transform: lowercase; }
    .code-canvas-actions { display: flex; gap: 8px; }
    .btn-canvas-action { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: var(--white); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
    .btn-canvas-action:hover { border-color: var(--teal); color: var(--teal); background: var(--teal-lighter); }
    .btn-canvas-action.primary { background: var(--teal); border-color: var(--teal); color: var(--white); }
    .btn-canvas-action.primary:hover { background: var(--teal-dark); }
    .btn-canvas-action svg { width: 16px; height: 16px; }
    .btn-canvas-close { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--white); border: 1px solid var(--border); border-radius: 6px; color: var(--grey); cursor: pointer; transition: all 0.2s ease; }
    .btn-canvas-close:hover { border-color: var(--teal); color: var(--teal); }
    .btn-canvas-close svg { width: 18px; height: 18px; }
    .code-canvas-body { flex: 1; overflow: hidden; display: flex; flex-direction: column; background: var(--grey-light); }
    .code-canvas-editor { flex: 1; width: 100%; padding: 20px; font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace; font-size: 0.9rem; line-height: 1.7; border: none; outline: none; resize: none; background: var(--white); color: var(--text-primary); tab-size: 2; margin: 16px; border-radius: 8px; width: calc(100% - 32px); }
    .code-canvas-editor::placeholder { color: var(--text-secondary); }
    .code-canvas-footer { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: var(--teal-lighter); border-top: 1px solid var(--border); }
    .code-canvas-info { font-size: 0.75rem; color: var(--text-secondary); }
    .btn-open-canvas { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: transparent; border: 1px solid #1a4a5c; border-radius: 4px; color: #6bb8cc; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; margin-left: 8px; }
    .btn-open-canvas:hover { background: #1a4a5c; color: #fff; }
    .btn-open-canvas svg { width: 12px; height: 12px; }
    @media (max-width: 768px) {
      .code-canvas { width: 100%; min-width: 100%; max-width: 100%; }
    }
</style>

</head>

<body>
  <!-- HOMEPAGE -->
  <div class="homepage" id="homepage">
    <div class="brand">FRICTION AI</div>

<h1 class="headline">Slow down your AI â€” on purpose.</h1>

<p class="subheadline">Friction AI adds intentional pauses before messages are sent, helping reduce impulsive use and increase presence.</p>

<div class="section">
  <h2 class="section-title">How it works</h2>
  <ul class="section-list">
    <li>You may be asked to type a short code before sending</li>
    <li>Continued use gradually increases the effort across 7 levels</li>
    <li>It caps at 10 characters and resets after 2 hours</li>
  </ul>
</div>

<div class="section">
  <h2 class="section-title">Why</h2>
  <p class="section-subtitle">Tough love, not punishment.</p>
  <p class="section-text">We slow things down because we care about attention, presence, and real-world goals.</p>
</div>

<div class="section">
  <h2 class="section-title">Our philosophy</h2>
  <p class="philosophy-line">Ease creates dependency.</p>
  <p class="philosophy-line">Thoughtful friction creates awareness.</p>
  <p class="philosophy-line">We optimise for presence, not engagement.</p>
</div>

<div class="divider"></div>

<div class="cta-section">
  <h2 class="section-title">Try it</h2>
  <p class="cta-text">By continuing, you're choosing a slower AI experience.</p>

  <div class="auth-buttons">
    <button class="btn-oauth" id="btnApple" type="button">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
      </svg>
      Continue with Apple
    </button>

    <button class="btn-oauth" id="btnGoogle" type="button">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>
  </div>

  <button class="btn-primary" id="btnEmail" type="button">Sign in with email</button>

  <!-- Hidden Google Sign-In button -->
  <div id="googleButtonHidden" style="position: absolute; opacity: 0; pointer-events: none; height: 0; overflow: hidden;"></div>

  <p class="footer-note">Works best in your browser. Home-screen optional.</p>
  <div class="legal-links">
    <a href="/privacy">Privacy</a>
    <a href="/terms">Terms</a>
    <a href="/disclaimer">Disclaimer</a>
  </div>
</div>

  </div>

  <div id="privacy-view" aria-hidden="true">
    <div class="legal-back"><a href="/">â† Back to Friction AI</a></div>
    <h1>Privacy Policy â€” Friction AI (Draft)</h1>
    <p class="legal-meta">Last updated: 2026-01-30</p>

    <h2>Overview</h2>
    <p>Friction AI is designed with a privacy-first approach. Our goal is to minimize the amount of personal data collected and avoid storing sensitive user content on our servers wherever possible.</p>
    <p>This Privacy Policy explains what data is collected, how it is used, and your choices.</p>

    <h2>Information We Collect</h2>
    <p><strong>Account Sign-In Information</strong></p>
    <p>If you sign in using Google, we receive:</p>
    <ul>
      <li>Your email address</li>
      <li>Your display name (if provided by Google)</li>
      <li>A Google identity token used for authentication</li>
    </ul>
    <p>We use this only to verify identity, control access to features, and apply security protections. We do not receive your Google password.</p>

    <p><strong>User Content and Saved Data</strong></p>
    <p>Friction AI is designed so that user-saved data is stored locally on your device (browser storage). This includes appointments, tasks, goals, family profiles, settings, and notes.</p>
    <p>We do not store this personal content on our servers unless explicitly stated for a specific feature.</p>
    <p>If you clear your browser data or switch devices, this locally stored data may be lost.</p>

    <p><strong>AI Requests</strong></p>
    <p>When you use AI features, your messages and prompts are sent to the selected third-party AI provider to generate a response. Providers may include OpenAI, Anthropic, Google (Gemini), Perplexity, and xAI (Grok).</p>
    <p>We do not store your message history on our servers unless you explicitly enable a future server-save feature. AI providers may process request content under their own policies.</p>
    <p>Avoid submitting highly sensitive personal, medical, or financial information to AI tools.</p>

    <p><strong>Usage &amp; Security Analytics</strong></p>
    <p>We may collect limited anonymized usage data for security and abuse prevention (e.g., counts of messages, feature usage totals, signup counts, rate limit events). This data does not include message content.</p>

    <h2>What We Do Not Collect</h2>
    <p>We do not intentionally collect or store your private task/goal content server-side, your chat history server-side (unless a future opt-in exists), contacts, precise location, or Google passwords.</p>

    <h2>Data Storage Model</h2>
    <p>Friction AI primarily uses local browser storage for saved content, Cloudflare infrastructure for API processing, and third-party AI providers for response generation.</p>

    <h2>Data Retention</h2>
    <p>Local data stays on your device until you delete it. Anonymized analytics may be retained for a limited time for monitoring and abuse prevention.</p>

    <h2>Your Choices and Controls</h2>
    <p>You can clear your local data via browser settings and stop using the service at any time. Future versions may include export/delete tools.</p>

    <h2>Security</h2>
    <p>We use reasonable technical measures (HTTPS, token auth, rate limiting, environment secret storage). No system can guarantee absolute security.</p>

    <h2>Third-Party Services</h2>
    <p>Authentication and AI processing rely on third parties that operate under their own policies.</p>

    <h2>Childrenâ€™s Privacy</h2>
    <p>Not intended for children under 13.</p>

    <h2>Beta Status Disclaimer</h2>
    <p>Early-stage product. Features may change, break, or be removed. Do not rely on it as your sole system for critical information.</p>

    <h2>Changes to This Policy</h2>
    <p>Updates will be posted with a new â€œLast updatedâ€ date.</p>

    <h2>Contact</h2>
    <p>[insert contact email]</p>
  </div>

  <div id="terms-view" aria-hidden="true">
    <div class="legal-back"><a href="/">â† Back to Friction AI</a></div>
    <h1>Terms of Use â€” Friction AI (Draft)</h1>
    <p class="legal-meta">Last updated: 2026-01-30</p>
    <ul>
      <li>Friction AI is provided â€œas isâ€ without warranties.</li>
      <li>You are responsible for how you use the tool and for verifying important information.</li>
      <li>Friction AI does not provide medical, legal, or professional advice.</li>
      <li>Do not upload or submit content you do not have the rights to use.</li>
      <li>We may limit or block access to prevent abuse, protect the service, or comply with law.</li>
      <li>Features may change or be removed at any time, especially during beta.</li>
      <li>Local-only storage means clearing browser data may remove your saved content.</li>
    </ul>
    <h2>Contact</h2>
    <p>[insert contact email]</p>
  </div>

  <div id="disclaimer-view" aria-hidden="true">
    <div class="legal-back"><a href="/">â† Back to Friction AI</a></div>
    <h1>Disclaimer â€” Friction AI (Draft)</h1>
    <p class="legal-meta">Last updated: 2026-01-30</p>

    <h2>AI Disclaimer</h2>
    <ul>
      <li>AI outputs may be inaccurate or incomplete.</li>
      <li>Always verify important details independently.</li>
    </ul>

    <h2>Not Medical Advice</h2>
    <ul>
      <li>Friction AI is not a medical device and does not provide medical advice.</li>
      <li>For health concerns, consult qualified professionals.</li>
    </ul>

    <h2>Beta Disclaimer</h2>
    <ul>
      <li>This is an early/beta product. Data may be lost, features may break, and behavior may change.</li>
      <li>Do not rely on Friction AI as your only system for critical reminders or recordkeeping.</li>
    </ul>

    <h2>Contact</h2>
    <p>[insert contact email]</p>
  </div>

  <!-- CHAT APPLICATION -->

  <div class="chat-app" id="chatApp">
    <header class="chat-header">
      <div class="chat-header-left">
        <button class="btn-icon" id="btnMenu" title="Menu" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="3" y1="6" x2="21" y2="6"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
            <line x1="3" y1="18" x2="21" y2="18"/>
          </svg>
        </button>
      </div>
      <div class="chat-header-center">
        <select class="model-select" id="modelSelect">
          <option value="claude">Claude Sonnet 4.5</option>
          <option value="gpt">GPT-4o</option>
          <option value="gemini">Google Gemini 2.5</option>
          <option value="grok">Grok 3</option>
          <option value="perplexity">Perplexity Sonar</option>
        </select>
      </div>
      <div class="chat-header-right">
        <div class="header-timer" id="headerTimer"></div>
      </div>
    </header>

<div class="chat-messages" id="chatMessages">
  <div class="chat-background-goal" id="chatBackgroundGoal"></div>
  <div class="welcome-message">
    <div class="welcome-icon">âœ¦</div>
    <h2>How can I help you today?</h2>
    <p>Remember: slow is intentional.</p>
  </div>
</div>

<div class="typing-indicator" id="typingIndicator">
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
  <div class="typing-dot"></div>
</div>

<section id="friction-social-view" class="view" aria-hidden="true">
  <div class="fs-header">
    <h2 class="section-title">Friction Social</h2>
    <p class="section-text">Curate YouTube moments that reinforce slow, intentional habits.</p>
  </div>
  <div class="fs-friction-controls" id="fsFrictionControls">
    <div class="fs-friction-title">Friction controls</div>
    <div class="fs-friction-row">
      <label class="fs-friction-toggle">
        <input type="checkbox" id="fsFrictionEnabled" />
        <span>Friction reminders</span>
      </label>
    </div>
    <div class="fs-friction-row">
      <div class="fs-friction-label">Reminder frequency</div>
      <div class="fs-friction-options">
        <label><input type="radio" name="fsFrictionFrequency" value="1" />After every video</label>
        <label><input type="radio" name="fsFrictionFrequency" value="2" />Every 2 videos</label>
      </div>
    </div>
    <div class="fs-friction-row">
      <div class="fs-friction-label">Pause timer</div>
      <div class="fs-friction-options">
        <label><input type="radio" name="fsPauseSeconds" value="30" />30 seconds</label>
        <label><input type="radio" name="fsPauseSeconds" value="60" />60 seconds</label>
        <label><input type="radio" name="fsPauseSeconds" value="120" />120 seconds</label>
      </div>
    </div>
  </div>
  <div class="fs-controls">
    <label class="fs-search" for="fsSearchInput">
      <input type="text" id="fsSearchInput" placeholder="Search videos, channels, or IDs" />
    </label>
    <button class="fs-add-btn" id="fsAddVideo" type="button">Add video link</button>
    <button class="fs-add-btn" id="fsAddChannel" type="button">Add channel</button>
    <button class="fs-add-btn fs-secondary-btn" id="fsRefreshChannels" type="button">Refresh</button>
  </div>
  <div class="fs-shelves" id="fsShelves"></div>
  <div class="fs-empty" id="fsEmpty" style="display: none;"></div>

  <div class="fs-modal" id="fsModal" aria-hidden="true">
    <div class="fs-modal-backdrop" data-close></div>
    <div class="fs-modal-card" role="dialog" aria-modal="true" aria-label="YouTube player">
      <button class="fs-modal-close" id="fsModalClose" type="button" aria-label="Close video">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
      <div class="fs-modal-player">
        <iframe id="fsModalFrame" title="YouTube video player" allow="autoplay; encrypted-media" allowfullscreen></iframe>
      </div>
      <div class="fs-modal-meta">
        <div class="fs-modal-title" id="fsModalTitle"></div>
        <div class="fs-modal-channel" id="fsModalChannel"></div>
        <a class="fs-modal-link" id="fsModalLink" href="#" target="_blank" rel="noopener">Watch on YouTube</a>
      </div>
    </div>
  </div>

  <div class="fs-intent-overlay" id="fsIntroOverlay" aria-hidden="true">
    <div class="fs-intent-backdrop"></div>
    <div class="fs-intent-card" role="dialog" aria-modal="true" aria-labelledby="fsIntroTitle">
      <h3 class="fs-intent-title" id="fsIntroTitle">Friction Social</h3>
      <p class="fs-intent-text">
        This isnâ€™t a feed. Itâ€™s a calm shelf of videos you choose.
        Tiny pauses help you stay intentional â€” no guilt, no judgement.
      </p>
      <label class="fs-intent-checkbox">
        <input type="checkbox" id="fsIntroDismiss" />
        <span>Donâ€™t show again</span>
      </label>
      <div class="fs-intent-actions">
        <button class="fs-intent-btn" id="fsIntroContinue" type="button">Continue</button>
      </div>
    </div>
  </div>

  <div class="fs-pause-overlay" id="fsPauseOverlay" aria-hidden="true">
    <div class="fs-pause-backdrop"></div>
    <div class="fs-pause-card" role="dialog" aria-modal="true" aria-labelledby="fsPauseTitle">
      <h3 class="fs-pause-title" id="fsPauseTitle">Tiny pause?</h3>
      <p class="fs-pause-text" id="fsPausePrompt"></p>
      <div class="fs-pause-timer" id="fsPauseTimer"></div>
      <div class="fs-pause-upnext" id="fsPauseUpNextPanel">
        <div class="fs-pause-goal">
          <span class="fs-pause-goal-text" id="fsPauseGoalText"></span>
          <button class="fs-pause-goal-action" id="fsPauseGoalDone" type="button">Mark done</button>
        </div>
        <button class="fs-pause-btn" id="fsPauseContinue" type="button" disabled>Continue to Up Next</button>
      </div>
      <div class="fs-pause-actions">
        <button class="fs-pause-btn secondary" id="fsPauseWatch" type="button">Watch another</button>
        <button class="fs-pause-btn" id="fsPauseTake" type="button">Take 60 seconds</button>
        <button class="fs-pause-btn secondary" id="fsPauseUpNext" type="button">Up Next (30s)</button>
        <button class="fs-pause-btn secondary" id="fsPauseSkip" type="button" style="display: none;">Skip</button>
        <button class="fs-pause-btn secondary" id="fsPauseDone" type="button">Done for now</button>
      </div>
    </div>
  </div>
</section>

<section id="goals-view" class="view" aria-hidden="true">
  <div class="goals-header">
    <h2 class="section-title">Goals</h2>
    <p class="section-text">Keep your intentions visible and easy to revisit.</p>
    <div class="goals-row goals-filter">
      <span class="goals-meta">Area</span>
      <select class="goals-input goals-area-select" id="goalsAreaFilter"></select>
    </div>
  </div>

  <div class="goals-section">
    <h3 class="section-subtitle">Short-term goals</h3>
    <div class="goals-row">
      <input class="goals-input" id="shortGoalInput" type="text" placeholder="Add a short-term goal" maxlength="80" />
      <select class="goals-input goals-area-select" id="shortGoalArea"></select>
      <button class="goals-btn" id="shortGoalAdd" type="button">Add</button>
    </div>
    <div class="goals-list" id="shortGoalList"></div>
    <button class="goals-btn goals-btn-secondary" id="shortGoalClear" type="button">Clear completed</button>
  </div>

  <div class="goals-section">
    <h3 class="section-subtitle">Long-term goals</h3>
    <div class="goals-banner" id="goalsNudge" style="display: none;">
      <div class="goals-meta">Youâ€™ve had goals sitting for a while. Want help breaking one into steps?</div>
      <button class="goals-btn goals-btn-secondary" id="goalsNudgeBtn" type="button">Break into steps</button>
    </div>
    <form id="longGoalForm">
      <div class="goals-row">
        <input class="goals-input" id="longGoalTitle" type="text" placeholder="Goal title" required maxlength="120" />
        <input class="goals-input" id="longGoalDate" type="date" />
        <select class="goals-input goals-area-select" id="longGoalArea"></select>
      </div>
      <div class="goals-row">
        <textarea class="goals-textarea" id="longGoalNote" placeholder="Add a note (optional)" maxlength="300"></textarea>
      </div>
      <div class="goals-row">
        <button class="goals-btn" id="longGoalAdd" type="submit">Add</button>
        <button class="goals-btn goals-btn-secondary" id="longGoalCancel" type="button" style="display: none;">Cancel edit</button>
      </div>
    </form>
    <div class="goals-list" id="longGoalList"></div>
    <div class="unstuck-panel" id="goalsUnstuckPanel" aria-live="polite"></div>
  </div>
</section>

<section id="life-view" class="view" aria-hidden="true">
  <div class="life-topbar">
    <div class="life-topbar-copy">
      <h2 class="section-title">Life</h2>
      <p class="section-text">A bubble web of the people, assets, and tasks that shape your week.</p>
    </div>
    <div class="life-topbar-profile">
      <img class="life-profile-pic" id="lifeProfilePic" alt="Profile photo" />
      <span class="life-profile-email" id="lifeProfileEmail"></span>
    </div>
  </div>

  <div class="life-domain-strip" id="lifeDomainStrip" role="list" aria-label="Life domains"></div>

  <div class="life-domain-web">
    <div class="life-node-strip" id="lifeNodeStrip" role="list" aria-label="Life nodes"></div>
    <div class="life-domain-panel" id="lifeDomainPanel" aria-live="polite"></div>
  </div>

  <div class="life-modal" id="lifePersonModal" aria-hidden="true">
    <div class="life-modal-backdrop" data-close></div>
    <div class="life-modal-card" role="dialog" aria-modal="true" aria-labelledby="lifePersonModalTitle">
      <div class="life-modal-header">
        <h3 class="section-subtitle" id="lifePersonModalTitle">Add person</h3>
        <button class="life-btn secondary" id="lifePersonModalClose" type="button">Close</button>
      </div>
      <form class="life-modal-body" id="lifePersonForm">
        <input class="life-input" id="lifePersonNameInput" type="text" placeholder="Full name" maxlength="60" required />
        <select class="life-select" id="lifePersonRoleInput">
          <option value="" disabled selected>Select role</option>
          <option value="wife">Wife</option>
          <option value="son">Son</option>
          <option value="daughter">Daughter</option>
          <option value="mother">Mother</option>
          <option value="father">Father</option>
          <option value="brother">Brother</option>
          <option value="sister">Sister</option>
          <option value="other">Other</option>
        </select>
        <input class="life-input" id="lifePersonRoleCustomInput" type="text" placeholder="Custom role" maxlength="40" style="display: none;" />
        <input class="life-input" id="lifePersonDobInput" type="date" />
        <div class="life-row" style="align-items: center;">
          <img class="life-photo-preview" id="lifePersonPhotoPreview" alt="Photo preview" />
          <div>
            <label class="life-btn secondary" for="lifePersonPhotoInput">Add photo</label>
            <input type="file" id="lifePersonPhotoInput" accept="image/*" hidden>
            <div class="life-meta">Stored only on this device.</div>
          </div>
        </div>
        <textarea class="life-textarea" id="lifePersonNotesInput" placeholder="Notes (optional)" maxlength="200"></textarea>
        <div class="life-meta" id="lifePersonError" role="alert" style="display: none;"></div>
        <div class="life-modal-actions">
          <button class="life-btn" id="lifePersonSave" type="submit">Save person</button>
          <button class="life-btn secondary" id="lifePersonCancel" type="button">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="life-modal" id="lifeRemoveModal" aria-hidden="true">
    <div class="life-modal-backdrop" data-close></div>
    <div class="life-modal-card" role="dialog" aria-modal="true" aria-labelledby="lifeRemoveModalTitle">
      <div class="life-modal-header">
        <h3 class="section-subtitle" id="lifeRemoveModalTitle">Remove person</h3>
        <button class="life-btn secondary" id="lifeRemoveModalClose" type="button">Close</button>
      </div>
      <p class="section-text" id="lifeRemoveModalText">Remove this person?</p>
      <div class="life-modal-actions">
        <button class="life-btn" id="lifeRemoveConfirm" type="button">Remove</button>
        <button class="life-btn secondary" id="lifeRemoveCancel" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <div class="life-modal" id="lifePrefsModal" aria-hidden="true">
    <div class="life-modal-backdrop" data-close></div>
    <div class="life-modal-card" role="dialog" aria-modal="true" aria-labelledby="lifePrefsModalTitle">
      <div class="life-modal-header">
        <h3 class="section-subtitle" id="lifePrefsModalTitle">Customize sections</h3>
        <button class="life-btn secondary" id="lifePrefsModalClose" type="button">Close</button>
      </div>
      <form class="life-modal-body" id="lifePrefsForm">
        <div class="life-prefs-list">
          <label class="life-prefs-option">
            <input type="checkbox" name="lifePrefsSection" value="appointments" />
            <span>Appointments</span>
          </label>
          <label class="life-prefs-option">
            <input type="checkbox" name="lifePrefsSection" value="tasks" />
            <span>Tasks</span>
          </label>
          <label class="life-prefs-option">
            <input type="checkbox" name="lifePrefsSection" value="documents" />
            <span>Documents</span>
          </label>
          <label class="life-prefs-option">
            <input type="checkbox" name="lifePrefsSection" value="milestones" />
            <span>Milestones</span>
          </label>
          <label class="life-prefs-option">
            <input type="checkbox" name="lifePrefsSection" value="assetsBills" />
            <span>Assets &amp; Bills</span>
          </label>
        </div>
        <div class="life-modal-actions">
          <button class="life-btn" id="lifePrefsSave" type="submit">Save</button>
          <button class="life-btn secondary" id="lifePrefsCancel" type="button">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div class="life-modal life-member-panel" id="lifeMemberPanel" aria-hidden="true">
    <div class="life-modal-backdrop" data-close></div>
    <div class="life-modal-card" role="dialog" aria-modal="true" aria-labelledby="lifeMemberPanelTitle">
      <div class="life-modal-header">
        <h3 class="section-subtitle" id="lifeMemberPanelTitle">Member details</h3>
        <button class="life-btn secondary" id="lifeMemberPanelClose" type="button">Close</button>
      </div>
      <div class="life-member-panel-body">
        <div class="life-member-row">
          <span class="life-member-label">Name</span>
          <span class="life-member-value" id="lifeMemberName">â€”</span>
        </div>
        <div class="life-member-row">
          <span class="life-member-label">Role type</span>
          <span class="life-member-value" id="lifeMemberRoleType">â€”</span>
        </div>
      </div>
    </div>
  </div>

  <div class="life-bubble-menu-overlay" id="lifeBubbleMenuOverlay" aria-hidden="true">
    <div class="life-bubble-menu" id="lifeBubbleMenu" role="menu" aria-label="Member actions">
      <button class="life-bubble-menu-item" type="button" data-action="details">View details</button>
      <button class="life-bubble-menu-item danger" type="button" data-action="remove">Remove</button>
    </div>
  </div>
</section>

<div class="chat-input-area">
  <div class="attachment-preview" id="attachmentPreview" style="display: none;"></div>
  <div class="chat-input-wrapper">
    <input type="file" id="fileUpload" multiple accept="image/*,.txt,.js,.py,.html,.css,.json,.md,.csv,.xml" style="display: none;">
    <button class="btn-attach" id="btnAttach" type="button" aria-label="Attach file">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
      </svg>
    </button>
    <textarea class="chat-input" id="messageInput" placeholder="Message..." rows="1"></textarea>
    <button class="btn-send" id="btnSend" type="button" aria-label="Send message">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 12h14M12 5l7 7-7 7"/>
      </svg>
    </button>
  </div>
</div>

  </div>

  <!-- SIDE MENU -->

  <div class="menu-overlay" id="menuOverlay"></div>
  <div class="side-menu" id="sideMenu">
    <div class="menu-header">
      <div class="menu-profile" id="menuProfile">
        <img class="profile-pic" id="profilePic" src="" alt="Profile" />
        <div class="profile-info">
          <span class="profile-name" id="profileName"></span>
          <span class="profile-email" id="profileEmail"></span>
        </div>
      </div>
      <button class="btn-close-menu" id="btnCloseMenu" type="button">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

<div class="menu-content">
  <button class="menu-btn-new" id="btnNewChat" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"/>
      <line x1="5" y1="12" x2="19" y2="12"/>
    </svg>
    New Chat
  </button>

  <div class="menu-section">
    <div class="menu-section-title">History</div>
    <div id="chatHistoryList">
      <div class="menu-empty">No chats yet</div>
    </div>
  </div>

  <div class="menu-divider"></div>

  <div class="menu-section">
    <button class="menu-item" id="btnSettings" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/>
      </svg>
      <span>Settings</span>
    </button>
    <button class="menu-item" id="btnAbout" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12.01" y2="8"/>
      </svg>
      <span>About</span>
    </button>
    <button class="menu-item" id="btnGoals" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 11l3 3L22 4"/>
        <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
      </svg>
      <span>Goals</span>
    </button>
    <button class="menu-item" id="btnLife" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 21s-7-4.35-7-10a4 4 0 0 1 7-2 4 4 0 0 1 7 2c0 5.65-7 10-7 10z"/>
      </svg>
      <span>Life</span>
    </button>
    <button class="menu-item" id="btnFrictionSocial" type="button">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="5" width="18" height="14" rx="2" ry="2"/>
        <polygon points="10 9 16 12 10 15 10 9"/>
      </svg>
      <span>Friction Social</span>
    </button>
    <button class="menu-item" id="btnAdmin" type="button" style="display: none;">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
      <span>Admin Dashboard</span>
    </button>
  </div>
</div>

<div class="menu-footer">
  <button class="menu-item menu-item-logout" id="btnSignOut" type="button">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
      <polyline points="16 17 21 12 16 7"/>
      <line x1="21" y1="12" x2="9" y2="12"/>
    </svg>
    <span>Sign Out</span>
  </button>
</div>
<div class="legal-links legal-links--menu">
  <a href="/privacy">Privacy</a>
  <a href="/terms">Terms</a>
  <a href="/disclaimer">Disclaimer</a>
</div>

  </div>

  <!-- FRICTION OVERLAY -->

  <div class="friction-overlay" id="frictionOverlay">
    <div class="friction-box">
      <h2 class="friction-title">Pause & reflect</h2>
      <p class="friction-subtitle">Type the code to send.</p>

  <div class="friction-goal-reminder" id="frictionGoalReminder"></div>

  <div class="friction-row" id="frictionRow1">
    <div class="friction-pair-container" id="frictionPairs1"></div>
  </div>

  <div class="friction-row" id="frictionRow2">
    <div class="friction-pair-container" id="frictionPairs2"></div>
  </div>

  <div class="friction-buttons">
    <button class="btn-cancel" id="frictionCancel" type="button">Cancel</button>
    <button class="btn-unlock" id="frictionUnlock" type="button" disabled>Send message</button>
  </div>

  <p class="friction-timer" id="frictionTimer"></p>
  <p class="friction-error" id="frictionError"></p>
</div>

  </div>

  <!-- ONBOARDING OVERLAY -->

  <div class="onboarding-overlay" id="onboardingOverlay">
    <div class="onboarding-box">

  <!-- Step 1: Welcome -->
  <div class="onboarding-step active" id="onboardingStep1">
    <div class="onboarding-icon">âœ¦</div>
    <h2 class="onboarding-title">Welcome to Friction AI</h2>
    <p class="onboarding-text">
      This app adds small moments of pause to help you use AI more intentionally.
    </p>
    <p class="onboarding-text">
      Before we start, let's set some goals. These will gently remind you of what matters most.
    </p>
    <button class="onboarding-btn primary" id="onboardingNext1" type="button">Get Started</button>
  </div>

  <!-- Step 2: Long-term Goal -->
  <div class="onboarding-step" id="onboardingStep2">
    <h2 class="onboarding-title">Your long-term goal</h2>
    <p class="onboarding-text">
      What do you want more of in your life? This will appear softly in the background as you chat.
    </p>
    <textarea 
      class="onboarding-textarea" 
      id="inputLongtermGoal" 
      placeholder="e.g., Be more present with my family, Focus on my mental health, Grow in my career..."
      maxlength="100"
    ></textarea>
    <div class="onboarding-nav">
      <button class="onboarding-btn secondary" id="onboardingBack2" type="button">Back</button>
      <button class="onboarding-btn primary" id="onboardingNext2" type="button">Next</button>
    </div>
  </div>

  <!-- Step 3: Short-term Goals -->
  <div class="onboarding-step" id="onboardingStep3">
    <h2 class="onboarding-title">Your short-term goals</h2>
    <p class="onboarding-text">
      What would you like to focus on today or this week? These will appear when you send messages.
    </p>
    <div class="shortterm-goals-list" id="shorttermGoalsList">
      <input type="text" class="shortterm-goal-input" placeholder="e.g., Study for exam" maxlength="60" />
    </div>
    <button class="onboarding-btn-add" id="addShorttermGoal" type="button">+ Add another goal</button>
    <div class="onboarding-nav">
      <button class="onboarding-btn secondary" id="onboardingBack3" type="button">Back</button>
      <button class="onboarding-btn primary" id="onboardingNext3" type="button">Finish</button>
    </div>
  </div>

  <!-- Step 4: All Set -->
  <div class="onboarding-step" id="onboardingStep4">
    <div class="onboarding-icon">ðŸŽ¯</div>
    <h2 class="onboarding-title">You're all set!</h2>
    <p class="onboarding-text">
      Your goals are saved. You can update them anytime from the menu.
    </p>
    <div class="onboarding-summary" id="onboardingSummary"></div>
    <button class="onboarding-btn primary" id="onboardingFinish" type="button">Start Chatting</button>
  </div>

</div>

  </div>

  <!-- GOAL CHECK-IN OVERLAY -->

  <div class="onboarding-overlay" id="goalCheckinOverlay">
    <div class="onboarding-box">
      <div class="onboarding-icon">ðŸ‘‹</div>
      <h2 class="onboarding-title">Quick check-in</h2>
      <p class="onboarding-text">
        It's been a little while. Have you made progress on your goals?
      </p>
      <div class="checkin-goals-list" id="checkinGoalsList"></div>
      <div class="onboarding-nav">
        <button class="onboarding-btn secondary" id="checkinSkip" type="button">Skip for now</button>
        <button class="onboarding-btn primary" id="checkinSave" type="button">Save & Continue</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS OVERLAY -->

  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-box">
      <div class="settings-header">
        <h2 class="settings-title">Settings</h2>
        <button class="settings-close" id="settingsClose" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

  <div class="settings-lock-banner" id="settingsLockBanner" style="display: none;">
    <span class="lock-icon">ðŸ”’</span>
    <span class="lock-text">Settings locked for <span id="lockTimeRemaining">--:--:--</span></span>
  </div>

  <div class="settings-content" id="settingsContent">
    
    <!-- Friction Mode -->
    <div class="settings-section">
      <h3 class="settings-section-title">Friction Mode</h3>
      <p class="settings-section-desc">Choose how much friction to add before sending messages</p>
      
      <label class="settings-radio">
        <input type="radio" name="frictionMode" value="off" />
        <span class="radio-label">
          <strong>Off</strong>
          <span class="radio-desc">No verification needed</span>
        </span>
      </label>
      
      <label class="settings-radio">
        <input type="radio" name="frictionMode" value="light" />
        <span class="radio-label">
          <strong>Light</strong>
          <span class="radio-desc">Goal reminder only, no typing</span>
        </span>
      </label>
      
      <label class="settings-radio">
        <input type="radio" name="frictionMode" value="full" checked />
        <span class="radio-label">
          <strong>Full</strong>
          <span class="radio-desc">Goal reminder + typing code (4-10 chars)</span>
        </span>
      </label>

      <label class="settings-radio strict-mode">
        <input type="radio" name="frictionMode" value="strict" />
        <span class="radio-label">
          <strong>âš ï¸ Strict Mode</strong>
          <span class="radio-desc">No mercy. 15 levels, up to 2 rows of 20 characters. Take no prisoners.</span>
        </span>
      </label>
      <div class="strict-warning">
        <strong>âš ï¸ For Serious Friction Only:</strong> This mode is designed for people who need maximum friction and accountability. Not recommended for casual use.
      </div>
    </div>

    <!-- Message Delay -->
    <div class="settings-section" id="messageDelaySection">
      <h3 class="settings-section-title">Message Delay</h3>
      <p class="settings-section-desc">Add a waiting period before messages send</p>
      <p class="settings-section-note" id="delayDisabledNote" style="display: none;">
        âš ï¸ Disabled when using Full or Strict friction mode
      </p>
      
      <div id="delayOptions">
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="0" checked />
          <span class="radio-label"><strong>Off</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="5" />
          <span class="radio-label"><strong>5 seconds</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="15" />
          <span class="radio-label"><strong>15 seconds</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="30" />
          <span class="radio-label"><strong>30 seconds</strong></span>
        </label>
        
        <label class="settings-radio">
          <input type="radio" name="messageDelay" value="45" />
          <span class="radio-label"><strong>45 seconds</strong></span>
        </label>

        <label class="settings-checkbox">
          <input type="checkbox" id="allowCancelDelay" checked />
          <span class="checkbox-label">Allow cancel during countdown</span>
        </label>
      </div>
    </div>

    <!-- Goal Reminders -->
    <div class="settings-section">
      <h3 class="settings-section-title">Goal Reminders</h3>
      
      <label class="settings-checkbox">
        <input type="checkbox" id="showShortTermGoal" checked />
        <span class="checkbox-label">Show short-term goal in friction overlay</span>
      </label>
      
      <label class="settings-checkbox">
        <input type="checkbox" id="showLongTermGoal" checked />
        <span class="checkbox-label">Show long-term goal in chat background</span>
      </label>
    </div>

    <div class="settings-section">
      <h3 class="settings-section-title">Family Data</h3>
      <p class="settings-section-desc">Clear all saved family profiles on this device.</p>
      <button class="settings-action-btn" id="resetFamilyDataBtn" type="button">Reset Family Data</button>
      <p class="settings-section-note">This wipes family member bubbles immediately and on next reload.</p>
    </div>

    <!-- Lock Settings -->
    <div class="settings-section settings-lock-section">
      <h3 class="settings-section-title">ðŸ”’ Lock Settings</h3>
      <p class="settings-section-desc">Prevent changes for a set period. Once locked, you cannot change settings until the timer expires.</p>
      
      <div class="lock-time-picker">
        <div class="lock-time-row">
          <label class="lock-time-label">Days</label>
          <input type="number" class="lock-time-input" id="lockDays" min="0" max="30" value="0" />
        </div>
        <div class="lock-time-row">
          <label class="lock-time-label">Hours</label>
          <input type="number" class="lock-time-input" id="lockHours" min="0" max="23" value="1" />
        </div>
        <div class="lock-time-row">
          <label class="lock-time-label">Minutes</label>
          <input type="number" class="lock-time-input" id="lockMinutes" min="0" max="59" value="0" />
        </div>
      </div>
      
      <div class="lock-presets">
        <button type="button" class="lock-preset-btn" data-hours="1">1hr</button>
        <button type="button" class="lock-preset-btn" data-hours="4">4hr</button>
        <button type="button" class="lock-preset-btn" data-hours="24">24hr</button>
        <button type="button" class="lock-preset-btn" data-days="3">3 days</button>
        <button type="button" class="lock-preset-btn" data-days="7">1 week</button>
      </div>

      <button class="settings-lock-btn" id="btnLockSettings" type="button">Lock Settings</button>
    </div>

  </div>
</div>

  </div>

  <!-- MESSAGE DELAY OVERLAY -->

  <div class="delay-overlay" id="delayOverlay">
    <div class="delay-box">
      <div class="delay-countdown" id="delayCountdown">
        <svg class="delay-ring" viewBox="0 0 100 100">
          <circle class="delay-ring-bg" cx="50" cy="50" r="45" />
          <circle class="delay-ring-progress" id="delayRingProgress" cx="50" cy="50" r="45" />
        </svg>
        <span class="delay-time" id="delayTime">5</span>
      </div>
      <p class="delay-text">Sending...</p>
      <p class="delay-hint" id="delayHint">While you wait, you could start on your goal</p>
      <button class="delay-cancel" id="delayCancelBtn" type="button">Cancel</button>
    </div>
  </div>

  <script>
    // STATE
    let state = {
      messages: [],
      pendingMessage: null,
      isProcessing: false,
      currentModel: 'claude',
      currentChatId: null
    };

    // CHAT PERSISTENCE
    function saveChatState() {
      const chatState = {
        messages: state.messages,
        currentModel: state.currentModel,
        currentChatId: state.currentChatId
      };
      localStorage.setItem('friction_chat', JSON.stringify(chatState));
      localStorage.setItem('friction_last_activity', Date.now().toString());

      // Also save to history
      saveCurrentChatToHistory();

      // Local-only storage (no server sync)
      saveUserDataToServer();
    }

    function loadChatState() {
      const saved = localStorage.getItem('friction_chat');
      if (saved) {
        try {
          const chatState = JSON.parse(saved);
          state.messages = chatState.messages || [];
          state.currentModel = chatState.currentModel || 'claude';
          state.currentChatId = chatState.currentChatId || null;
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function clearChatState() {
      state.messages = [];
      state.currentChatId = null;
      localStorage.removeItem('friction_chat');
    }

    // GOALS MANAGEMENT
    let goals = {
      longterm: '',
      shortterm: [],
      onboardingComplete: false,
      lastGoalCheck: null,
      lastGoalTick: null
    };

    function loadGoals() {
      var saved = localStorage.getItem('friction_goals');
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          goals = Object.assign(goals, parsed);
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function saveGoals() {
      localStorage.setItem('friction_goals', JSON.stringify(goals));
      // Sync to server (debounced)
      saveUserDataToServer();
    }

    function getActiveShortTermGoal() {
      var active = goals.shortterm.filter(function(g) { return !g.completed; });
      return active.length > 0 ? active[0] : null;
    }

    function shouldShowOnboarding() {
      return !goals.onboardingComplete;
    }

    function shouldShowGoalCheckin() {
      if (!goals.onboardingComplete) return false;
      if (goals.shortterm.length === 0) return false;
      
      // Check if all goals completed
      var allComplete = goals.shortterm.every(function(g) { return g.completed; });
      if (allComplete) return true;
      
      // Check if 72 hours since last tick
      if (goals.lastGoalTick) {
        var hoursSinceTick = (Date.now() - goals.lastGoalTick) / (1000 * 60 * 60);
        if (hoursSinceTick >= 72) return true;
      }
      
      return false;
    }

    function showOnboarding() {
      document.getElementById('onboardingOverlay').classList.add('active');
      document.getElementById('onboardingStep1').classList.add('active');
    }

    function hideOnboarding() {
      document.getElementById('onboardingOverlay').classList.remove('active');
    }

    function showGoalCheckin() {
      var overlay = document.getElementById('goalCheckinOverlay');
      var list = document.getElementById('checkinGoalsList');
      list.innerHTML = '';
      
      goals.shortterm.forEach(function(goal, index) {
        var item = document.createElement('div');
        item.className = 'checkin-goal-item';
        
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkin-goal-checkbox';
        checkbox.checked = goal.completed;
        checkbox.dataset.index = index;
        checkbox.addEventListener('change', function() {
          goals.shortterm[index].completed = this.checked;
          text.classList.toggle('completed', this.checked);
        });
        
        var text = document.createElement('span');
        text.className = 'checkin-goal-text';
        if (goal.completed) text.classList.add('completed');
        text.textContent = goal.text;
        
        item.appendChild(checkbox);
        item.appendChild(text);
        list.appendChild(item);
      });
      
      overlay.classList.add('active');
    }

    function hideGoalCheckin() {
      document.getElementById('goalCheckinOverlay').classList.remove('active');
    }

    function updateBackgroundGoal() {
      var bgGoal = document.getElementById('chatBackgroundGoal');
      if (!bgGoal) return;
      
      if (!goals.longterm || !settings.showLongTermGoal) {
        bgGoal.style.opacity = '0';
        return;
      }
      
      bgGoal.textContent = '"' + goals.longterm + '"';
      
      // Calculate opacity based on message count (caps at 0.15)
      var messageCount = state.messages.filter(function(m) { return m.role === 'user'; }).length;
      var opacity = Math.min(messageCount * 0.03, 0.15);
      bgGoal.style.opacity = opacity.toString();
    }

    // LIFE AREAS
    var LIFE_AREAS_KEY = 'friction_life_areas_v1';
    var lifeAreas = [];

    function generateLifeAreaId() {
      return 'area_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function buildDefaultLifeAreas() {
      var now = Date.now();
      return [
        { id: generateLifeAreaId(), name: 'Me', type: 'me', createdAt: now },
        { id: generateLifeAreaId(), name: 'Work', type: 'work', createdAt: now },
        { id: generateLifeAreaId(), name: 'Family', type: 'family', createdAt: now }
      ];
    }

    function normalizeLifeAreas(items) {
      if (!Array.isArray(items)) return [];
      return items.map(function(area) {
        if (!area || typeof area !== 'object') return null;
        return {
          id: area.id || generateLifeAreaId(),
          name: area.name || 'Me',
          type: area.type || 'me',
          createdAt: area.createdAt || Date.now()
        };
      }).filter(Boolean);
    }

    function ensureDefaultLifeAreas(items) {
      var areas = normalizeLifeAreas(items);
      var hasMe = areas.some(function(area) { return area.type === 'me'; });
      var hasWork = areas.some(function(area) { return area.type === 'work'; });
      var hasFamily = areas.some(function(area) { return area.type === 'family'; });
      if (!hasMe || !hasWork || !hasFamily) {
        var defaults = buildDefaultLifeAreas();
        if (!hasMe) areas.push(defaults[0]);
        if (!hasWork) areas.push(defaults[1]);
        if (!hasFamily) areas.push(defaults[2]);
      }
      return areas;
    }

    function loadLifeAreas() {
      var saved = localStorage.getItem(LIFE_AREAS_KEY);
      if (saved) {
        try {
          lifeAreas = ensureDefaultLifeAreas(JSON.parse(saved));
          return;
        } catch (e) {
          lifeAreas = buildDefaultLifeAreas();
        }
      } else {
        lifeAreas = buildDefaultLifeAreas();
      }
      saveLifeAreas();
    }

    function saveLifeAreas() {
      localStorage.setItem(LIFE_AREAS_KEY, JSON.stringify(lifeAreas));
    }

    function getDefaultAreaId() {
      if (!lifeAreas.length) return '';
      var me = lifeAreas.find(function(area) { return area.type === 'me'; });
      return me ? me.id : lifeAreas[0].id;
    }

    function getAreaById(areaId) {
      return lifeAreas.find(function(area) { return area.id === areaId; }) || null;
    }

    function getAreaLabel(areaId) {
      var area = getAreaById(areaId);
      return area ? area.name : 'Me';
    }

    function getAreaOwnerName(areaId) {
      var area = getAreaById(areaId);
      if (!area) return '';
      if (area.type === 'child') {
        return area.name.replace(/^Child:\s*/i, '').trim();
      }
      return '';
    }

    function buildAreaOptions(includeAll) {
      var options = [];
      if (includeAll) {
        options.push({ id: 'all', name: 'All' });
      }
      lifeAreas.forEach(function(area) {
        options.push({ id: area.id, name: area.name });
      });
      return options;
    }

    function renderAreaSelect(selectEl, includeAll, selectedId) {
      if (!selectEl) return;
      selectEl.innerHTML = '';
      var options = buildAreaOptions(includeAll);
      options.forEach(function(option) {
        var opt = document.createElement('option');
        opt.value = option.id;
        opt.textContent = option.name;
        selectEl.appendChild(opt);
      });
      if (selectedId) {
        selectEl.value = selectedId;
      }
    }

    // PEOPLE OVERVIEW
    var LIFE_DATA_KEY = 'friction_life_data_v2';
    var FAMILY_MEMBERS_KEY = 'family_members_v1';
    var LEGACY_LIFE_PEOPLE_KEY = 'life_people_v1';
    var LIFE_ACTIVE_PERSON_KEY = 'life_active_person_id_v1';
    var LIFE_UI_KEY = 'life_ui_v1';
    var LIFE_PERSON_PREFS_KEY = 'life_person_prefs_v1';
    var DEV_SEED = typeof window !== 'undefined' && window.DEV_SEED === true;
    var familyStorageSourceLogged = false;
    var LIFE_ROLE_OPTIONS = ['wife', 'son', 'daughter', 'mother', 'father', 'brother', 'sister', 'other'];
    var familyMembers = [];
    var people = familyMembers;
    var activePersonId = null;
    var lifeUiPrefs = { groupMode: false, selectedPeopleIds: [] };
    var lifePersonPrefs = {};
    var lifeAssets = [];
    var lifeAppointments = [];
    var lifeTasks = [];
    var lifeData = null;
    var lifeState = {
      activeDomain: 'family',
      activePersonId: null,
      expandedNodeId: null,
      editMode: false
    };
    var LIFE_DOMAINS = [
      { id: 'family', label: 'Family' },
      { id: 'assets', label: 'Assets & Bills' },
      { id: 'appointments', label: 'Appointments' },
      { id: 'tasks', label: 'Tasks' }
    ];
    var pendingAvatarType = 'generated';
    var pendingAvatarDataUrl = '';
    var pendingRemovePersonId = null;
    var isEditingActivePerson = false;
    var lifePeopleLastActiveId = null;

    function generatePersonId() {
      if (window.crypto && typeof window.crypto.randomUUID === 'function') {
        return window.crypto.randomUUID();
      }
      return Date.now().toString(36) + '_' + Math.random().toString(16).slice(2);
    }

    function generateLifeAssetId() {
      return 'asset_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function generateLifeAppointmentId() {
      return 'appt_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function generateLifeTaskId() {
      return 'task_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function normalizeLifeAsset(asset) {
      if (!asset || typeof asset !== 'object') return null;
      return {
        id: asset.id || generateLifeAssetId(),
        label: asset.label || 'Untitled asset',
        ownerPersonId: asset.ownerPersonId || '',
        regoDue: asset.regoDue || '',
        serviceInterval: asset.serviceInterval || '',
        serviceDue: asset.serviceDue || '',
        insuranceRenewal: asset.insuranceRenewal || '',
        createdAt: asset.createdAt || Date.now(),
        updatedAt: asset.updatedAt || asset.createdAt || Date.now()
      };
    }

    function normalizeLifeAppointment(appt) {
      if (!appt || typeof appt !== 'object') return null;
      return {
        id: appt.id || generateLifeAppointmentId(),
        title: appt.title || 'Untitled appointment',
        date: appt.date || '',
        time: appt.time || '',
        location: appt.location || '',
        notes: appt.notes || '',
        personId: appt.personId || '',
        createdAt: appt.createdAt || Date.now(),
        updatedAt: appt.updatedAt || appt.createdAt || Date.now()
      };
    }

    function normalizeLifeTask(task) {
      if (!task || typeof task !== 'object') return null;
      var checklist = Array.isArray(task.checklist) ? task.checklist : [];
      return {
        id: task.id || generateLifeTaskId(),
        title: task.title || 'Untitled task',
        ownerPersonId: task.ownerPersonId || '',
        assetId: task.assetId || '',
        done: !!task.done,
        checklist: checklist.map(function(item) {
          if (!item || typeof item !== 'object') return null;
          return {
            id: item.id || generateLifeTaskId(),
            text: item.text || 'Checklist item',
            done: !!item.done
          };
        }).filter(Boolean),
        createdAt: task.createdAt || Date.now(),
        updatedAt: task.updatedAt || task.createdAt || Date.now()
      };
    }

    function logLifeDebug(eventName, detail) {
      if (typeof console === 'undefined' || !console.log) return;
      console.log('[Life]', eventName, detail || '');
    }

    function logFamilyStorageSource(source) {
      if (familyStorageSourceLogged) return;
      if (typeof console !== 'undefined' && console.log) {
        console.log('[Life] loaded from ' + source);
      }
      familyStorageSourceLogged = true;
    }

    function shouldSeedFamilyData() {
      return DEV_SEED === true;
    }

    function normalizeLifeData(data) {
      var safe = data && typeof data === 'object' ? data : {};
      var normalizedPeople = Array.isArray(safe.people) ? safe.people.map(normalizePerson).filter(Boolean) : [];
      return {
        activeDomain: safe.activeDomain || 'family',
        activePersonId: safe.activePersonId || null,
        people: normalizedPeople,
        assets: Array.isArray(safe.assets) ? safe.assets.map(normalizeLifeAsset).filter(Boolean) : [],
        appointments: Array.isArray(safe.appointments)
          ? safe.appointments.map(normalizeLifeAppointment).filter(Boolean)
          : [],
        tasks: Array.isArray(safe.tasks) ? safe.tasks.map(normalizeLifeTask).filter(Boolean) : [],
        personPrefs: safe.personPrefs && typeof safe.personPrefs === 'object' ? safe.personPrefs : {}
      };
    }

    function persistLifeData() {
      if (!lifeData) return;
      var payload = {
        activeDomain: lifeState.activeDomain,
        activePersonId: lifeState.activePersonId,
        assets: lifeAssets.slice(),
        appointments: lifeAppointments.slice(),
        tasks: lifeTasks.slice(),
        personPrefs: lifePersonPrefs
      };
      lifeData = Object.assign({}, payload, { people: people.slice() });
      localStorage.setItem(LIFE_DATA_KEY, JSON.stringify(payload));
    }

    function createDefaultFamilyPeople() {
      var now = Date.now();
      return [
        createDefaultMe(),
        {
          id: generatePersonId(),
          name: 'Claire',
          role: 'wife',
          roleType: 'adult',
          dob: null,
          avatarType: 'generated',
          avatarDataUrl: null,
          notes: null,
          createdAt: now,
          updatedAt: now
        },
        {
          id: generatePersonId(),
          name: 'Lachlan',
          role: 'son',
          roleType: 'child',
          dob: null,
          avatarType: 'generated',
          avatarDataUrl: null,
          notes: null,
          createdAt: now,
          updatedAt: now
        }
      ];
    }

    function loadLifeData() {
      var saved = localStorage.getItem(LIFE_DATA_KEY);
      if (saved) {
        try {
          lifeData = normalizeLifeData(JSON.parse(saved));
        } catch (e) {
          lifeData = normalizeLifeData(null);
        }
      }

      loadPeople();
      if (!people.length && lifeData && Array.isArray(lifeData.people) && lifeData.people.length) {
        setFamilyMembers(lifeData.people.map(normalizePerson).filter(Boolean));
        if (people.length) {
          savePeople();
        }
      }
      if (!people.length && shouldSeedFamilyData()) {
        setFamilyMembers(createDefaultFamilyPeople());
        savePeople();
      }

      if (!lifeData) {
        loadLifePersonPrefs();
        activePersonId = null;
        lifeAssets = [];
        lifeAppointments = [];
        lifeTasks = [];
        lifeData = normalizeLifeData({
          activeDomain: 'family',
          activePersonId: null,
          people: [],
          assets: lifeAssets,
          appointments: lifeAppointments,
          tasks: lifeTasks,
          personPrefs: lifePersonPrefs
        });
        persistLifeData();
      } else {
        lifeAssets = lifeData.assets;
        lifeAppointments = lifeData.appointments;
        lifeTasks = lifeData.tasks;
        lifePersonPrefs = lifeData.personPrefs || {};
      }

      lifeData.people = people.slice();
      activePersonId = lifeData.activePersonId || null;
      if (activePersonId && !getPersonById(activePersonId)) {
        activePersonId = null;
      }
      lifeState.activePersonId = activePersonId;
      if (lifeData.activePersonId !== activePersonId) {
        lifeData.activePersonId = activePersonId;
        persistLifeData();
      }
      var domainIds = LIFE_DOMAINS.map(function(domain) { return domain.id; });
      lifeState.activeDomain = domainIds.includes(lifeData.activeDomain) ? lifeData.activeDomain : 'family';
      if (lifeData.activeDomain !== lifeState.activeDomain) {
        lifeData.activeDomain = lifeState.activeDomain;
        persistLifeData();
      }
      lifeState.expandedNodeId = null;
      lifeState.editMode = false;
      localStorage.setItem(LIFE_ACTIVE_PERSON_KEY, activePersonId || '');
    }

    function resetFamilyData() {
      if (!confirm('Reset all family profiles? This cannot be undone.')) return;
      setFamilyMembers([]);
      activePersonId = null;
      lifeState.activePersonId = null;
      lifeUiPrefs = { groupMode: false, selectedPeopleIds: [] };
      lifePersonPrefs = {};
      localStorage.removeItem(FAMILY_MEMBERS_KEY);
      localStorage.removeItem(LEGACY_LIFE_PEOPLE_KEY);
      localStorage.removeItem(LIFE_ACTIVE_PERSON_KEY);
      localStorage.removeItem(LIFE_UI_KEY);
      localStorage.removeItem(LIFE_PERSON_PREFS_KEY);
      if (lifeData) {
        lifeData.people = [];
        lifeData.activePersonId = null;
        persistLifeData();
      }
      renderLifeView();
      setTimeout(function() {
        window.location.reload();
      }, 50);
    }

    function hashString(value) {
      var hash = 0;
      if (!value) return hash;
      for (var i = 0; i < value.length; i++) {
        hash = (hash << 5) - hash + value.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    function getInitials(name) {
      if (!name) return 'P';
      var parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return 'P';
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase();
    }

    function buildAvatarSvg(seed, name) {
      var palette = [
        ['#5A9A94', '#DDF1EE'],
        ['#3E6B99', '#D9E7F5'],
        ['#7C5C8A', '#EFE2F3'],
        ['#C77D4A', '#F7E6D8'],
        ['#4C7C5B', '#E1F2E6']
      ];
      var hash = hashString(seed || name || 'seed');
      var colors = palette[hash % palette.length];
      var initials = getInitials(name);
      var svg = ''
        + '<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160">'
        + '<defs>'
        + '<linearGradient id="g" x1="0" y1="0" x2="1" y2="1">'
        + '<stop offset="0%" stop-color="' + colors[0] + '"/>'
        + '<stop offset="100%" stop-color="' + colors[1] + '"/>'
        + '</linearGradient>'
        + '</defs>'
        + '<rect width="160" height="160" rx="80" fill="url(#g)"/>'
        + '<text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle" font-size="56" font-family="Arial, sans-serif" fill="#fff" font-weight="600">'
        + initials
        + '</text>'
        + '</svg>';
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    function getAvatarDataUrl(person) {
      if (!person) return buildAvatarSvg('family', 'Family');
      if (person.avatarType === 'photo' && person.avatarDataUrl) {
        return person.avatarDataUrl;
      }
      return buildAvatarSvg(person.id || person.name, person.name);
    }

    function formatRoleLabel(role) {
      if (!role) return '';
      if (role.toLowerCase() === 'me') return 'Me';
      return role.charAt(0).toUpperCase() + role.slice(1);
    }

    function getPersonRoleLabel(person) {
      if (!person) return '';
      return formatRoleLabel(person.role || '');
    }

    function normalizePerson(person) {
      if (!person || typeof person !== 'object') return null;
      return {
        id: person.id || generatePersonId(),
        name: person.name || 'Unnamed',
        role: person.role || 'other',
        roleType: deriveRoleType(person.role, person.roleType),
        dob: person.dob || null,
        avatarType: person.avatarType === 'photo' ? 'photo' : person.avatarType === 'initials' ? 'initials' : 'generated',
        avatarDataUrl: person.avatarDataUrl || null,
        notes: person.notes || null,
        createdAt: person.createdAt || Date.now(),
        updatedAt: person.updatedAt || person.createdAt || Date.now()
      };
    }

    function createDefaultMe() {
      var now = Date.now();
      return {
        id: 'me',
        name: 'Me',
        role: 'me',
        roleType: 'adult',
        dob: null,
        avatarType: 'generated',
        avatarDataUrl: null,
        notes: null,
        createdAt: now,
        updatedAt: now
      };
    }

    function loadPeople() {
      var saved = localStorage.getItem(FAMILY_MEMBERS_KEY);
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          setFamilyMembers(Array.isArray(parsed) ? parsed.map(normalizePerson).filter(Boolean) : []);
        } catch (e) {
          setFamilyMembers([]);
        }
        logFamilyStorageSource('localStorage');
        return;
      }

      var legacySaved = localStorage.getItem(LEGACY_LIFE_PEOPLE_KEY);
      if (legacySaved) {
        try {
          var legacyParsed = JSON.parse(legacySaved);
          setFamilyMembers(Array.isArray(legacyParsed) ? legacyParsed.map(normalizePerson).filter(Boolean) : []);
        } catch (e) {
          setFamilyMembers([]);
        }
        logFamilyStorageSource('localStorage');
        localStorage.removeItem(LEGACY_LIFE_PEOPLE_KEY);
        if (people.length) {
          savePeople();
        }
        return;
      }

      setFamilyMembers([]);
      logFamilyStorageSource('localStorage');
    }

    function savePeople() {
      try {
        syncFamilyMemberRoleTypes();
        localStorage.setItem(FAMILY_MEMBERS_KEY, JSON.stringify(familyMembers));
        persistLifeData();
        return true;
      } catch (e) {
        return false;
      }
    }

    function deriveRoleType(role, roleType) {
      if (roleType === 'adult' || roleType === 'child') return roleType;
      var value = String(role || '').toLowerCase();
      if (value.includes('son') || value.includes('daughter') || value.includes('child') || value.includes('kid')) {
        return 'child';
      }
      return 'adult';
    }

    function ensureFamilyMemberRoleType(member) {
      if (!member || typeof member !== 'object') return;
      var nextRoleType = deriveRoleType(member.role, member.roleType);
      if (member.roleType !== nextRoleType) {
        member.roleType = nextRoleType;
      }
    }

    function syncFamilyMemberRoleTypes() {
      familyMembers.forEach(function(member) {
        ensureFamilyMemberRoleType(member);
      });
    }

    function setFamilyMembers(nextMembers) {
      familyMembers = Array.isArray(nextMembers) ? nextMembers : [];
      syncFamilyMemberRoleTypes();
      people = familyMembers;
    }

    function loadLifeUiPrefs() {
      var saved = localStorage.getItem(LIFE_UI_KEY);
      if (!saved) {
        lifeUiPrefs = { groupMode: false, selectedPeopleIds: [] };
        return;
      }
      try {
        var parsed = JSON.parse(saved);
        lifeUiPrefs = {
          groupMode: Boolean(parsed && parsed.groupMode),
          selectedPeopleIds: Array.isArray(parsed && parsed.selectedPeopleIds) ? parsed.selectedPeopleIds : []
        };
      } catch (e) {
        lifeUiPrefs = { groupMode: false, selectedPeopleIds: [] };
      }
    }

    function saveLifeUiPrefs() {
      localStorage.setItem(LIFE_UI_KEY, JSON.stringify(lifeUiPrefs));
    }

    function loadLifePersonPrefs() {
      var saved = localStorage.getItem(LIFE_PERSON_PREFS_KEY);
      if (!saved) {
        lifePersonPrefs = {};
        return;
      }
      try {
        var parsed = JSON.parse(saved);
        lifePersonPrefs = parsed && typeof parsed === 'object' ? parsed : {};
      } catch (e) {
        lifePersonPrefs = {};
      }
    }

    function saveLifePersonPrefs() {
      localStorage.setItem(LIFE_PERSON_PREFS_KEY, JSON.stringify(lifePersonPrefs));
      persistLifeData();
    }

    function getAgeInMonths(dob) {
      if (!dob) return null;
      var date = new Date(dob);
      if (Number.isNaN(date.getTime())) return null;
      var now = new Date();
      var months = (now.getFullYear() - date.getFullYear()) * 12 + (now.getMonth() - date.getMonth());
      if (now.getDate() < date.getDate()) {
        months -= 1;
      }
      return months;
    }

    function getDefaultSectionPrefs(person) {
      var role = person && person.role ? String(person.role).toLowerCase() : '';
      var ageMonths = person && person.dob ? getAgeInMonths(person.dob) : null;
      var isChildRole = role.includes('son') || role.includes('daughter') || role.includes('child');
      var isYoungChild = typeof ageMonths === 'number' && ageMonths < 24;
      var assetsBillsEnabled = !(isChildRole || isYoungChild);
      return {
        appointments: true,
        tasks: true,
        documents: true,
        milestones: true,
        assetsBills: assetsBillsEnabled
      };
    }

    function getPersonPrefs(personId) {
      if (!personId) return null;
      var person = getPersonById(personId);
      if (!person) return null;
      var prefs = lifePersonPrefs[personId];
      if (!prefs || !prefs.enabledSections) {
        prefs = { enabledSections: getDefaultSectionPrefs(person) };
        lifePersonPrefs[personId] = prefs;
        saveLifePersonPrefs();
      }
      if (prefs && prefs.enabledSections) {
        if (prefs.enabledSections.assets !== undefined || prefs.enabledSections.bills !== undefined) {
          var assetsEnabled = prefs.enabledSections.assets !== false;
          var billsEnabled = prefs.enabledSections.bills !== false;
          prefs.enabledSections.assetsBills = assetsEnabled && billsEnabled;
          delete prefs.enabledSections.assets;
          delete prefs.enabledSections.bills;
          lifePersonPrefs[personId] = prefs;
          saveLifePersonPrefs();
        }
      }
      return prefs;
    }

    function applyPersonSectionPrefs(personId) {
      if (!lifeView || !personId) return;
      var prefs = getPersonPrefs(personId);
      if (!prefs || !prefs.enabledSections) return;
      var sections = lifeView.querySelectorAll('[data-life-section]');
      sections.forEach(function(section) {
        var key = section.dataset.lifeSection;
        var enabled = prefs.enabledSections[key];
        if (key === 'assets' || key === 'bills') {
          enabled = prefs.enabledSections.assetsBills;
        }
        section.style.display = enabled === false ? 'none' : '';
      });
    }

    function ensureActivePerson() {
      if (!people.length) {
        activePersonId = null;
        lifeState.activePersonId = null;
        localStorage.setItem(LIFE_ACTIVE_PERSON_KEY, '');
        if (lifeData) {
          lifeData.activePersonId = null;
          persistLifeData();
        }
        return;
      }
      var savedActive = localStorage.getItem(LIFE_ACTIVE_PERSON_KEY);
      var active = people.find(function(person) { return person.id === savedActive; });
      if (!active) {
        activePersonId = people[0].id;
        localStorage.setItem(LIFE_ACTIVE_PERSON_KEY, activePersonId);
      } else {
        activePersonId = active.id;
      }
    }

    function setActivePersonId(personId) {
      activePersonId = personId;
      lifeState.activePersonId = personId || null;
      localStorage.setItem(LIFE_ACTIVE_PERSON_KEY, personId || '');
      if (lifeData) {
        lifeData.activePersonId = personId || null;
        persistLifeData();
      }
      isEditingActivePerson = false;
      if (lifeActiveEdit) {
        lifeActiveEdit.hidden = true;
      }
      if (lifePeopleLastActiveId !== personId) {
        logLifeDebug('activePersonId change', personId);
        lifePeopleLastActiveId = personId;
      }
      if (!lifeUiPrefs.groupMode) {
        lifeUiPrefs.selectedPeopleIds = [];
        saveLifeUiPrefs();
      }
    }

    function formatDob(dob) {
      if (!dob) return '';
      var date = new Date(dob);
      if (Number.isNaN(date.getTime())) return dob;
      return date.toLocaleDateString();
    }

    function getFamilyPeople() {
      return people.slice().sort(function(a, b) {
        if (a.id === 'me') return -1;
        if (b.id === 'me') return 1;
        return String(a.name || '').localeCompare(String(b.name || ''));
      });
    }

    function renderPeopleOverview() {
      renderLifeView();
    }

    function setGroupMode(isActive) {
      lifeUiPrefs.groupMode = isActive;
      if (isActive && (!lifeUiPrefs.selectedPeopleIds || !lifeUiPrefs.selectedPeopleIds.length)) {
        lifeUiPrefs.selectedPeopleIds = activePersonId ? [activePersonId] : [];
      }
      if (!isActive) {
        lifeUiPrefs.selectedPeopleIds = [];
      }
      saveLifeUiPrefs();
      if (lifeGroupToggle) {
        lifeGroupToggle.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      }
      if (lifeView) {
        lifeView.classList.toggle('group-mode-active', isActive);
      }
      renderLifeView();
    }

    function setPeopleModalVisible(isVisible) {
      if (!lifePersonModal) return;
      lifePersonModal.classList.toggle('active', isVisible);
      lifePersonModal.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
      if (isVisible) {
        lockBodyScroll();
      } else {
        unlockBodyScroll();
      }
    }

    function setRemoveModalVisible(isVisible) {
      if (!lifeRemoveModal) return;
      lifeRemoveModal.classList.toggle('active', isVisible);
      lifeRemoveModal.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
      if (isVisible) {
        lockBodyScroll();
      } else {
        unlockBodyScroll();
      }
    }

    function setLifePrefsModalVisible(isVisible) {
      if (!lifePrefsModal) return;
      lifePrefsModal.classList.toggle('active', isVisible);
      lifePrefsModal.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
      if (isVisible) {
        lockBodyScroll();
      } else {
        unlockBodyScroll();
      }
    }

    function setMemberPanelVisible(isVisible) {
      if (!lifeMemberPanel) return;
      lifeMemberPanel.classList.toggle('active', isVisible);
      lifeMemberPanel.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
      if (isVisible) {
        lockBodyScroll();
      } else {
        unlockBodyScroll();
      }
    }

    function openMemberPanel(personId) {
      var person = getPersonById(personId);
      if (!person) return;
      if (lifeMemberName) {
        lifeMemberName.textContent = person.name || 'Unnamed';
      }
      if (lifeMemberRoleType) {
        var roleType = person.roleType || deriveRoleType(person.role, 'adult');
        lifeMemberRoleType.textContent = (roleType || 'adult').toLowerCase();
      }
      setMemberPanelVisible(true);
    }

    function closeMemberPanel() {
      if (!lifeMemberPanel || !lifeMemberPanel.classList.contains('active')) return;
      setMemberPanelVisible(false);
    }

    var bubbleMenuState = {
      isOpen: false,
      personId: '',
      anchorEl: null,
      longPressTimer: null,
      longPressTriggered: false,
      startPoint: null
    };

    function getPointerPoint(event) {
      if (event.touches && event.touches[0]) {
        return { x: event.touches[0].clientX, y: event.touches[0].clientY };
      }
      if (event.changedTouches && event.changedTouches[0]) {
        return { x: event.changedTouches[0].clientX, y: event.changedTouches[0].clientY };
      }
      return { x: event.clientX || 0, y: event.clientY || 0 };
    }

    function positionBubbleMenu(anchorEl) {
      if (!lifeBubbleMenu || !anchorEl) return;
      var rect = anchorEl.getBoundingClientRect();
      var menuWidth = lifeBubbleMenu.offsetWidth;
      var menuHeight = lifeBubbleMenu.offsetHeight;
      var top = rect.bottom + 10;
      var left = rect.left + (rect.width / 2) - (menuWidth / 2);
      var padding = 12;
      if (left < padding) left = padding;
      if (left + menuWidth > window.innerWidth - padding) {
        left = window.innerWidth - menuWidth - padding;
      }
      if (top + menuHeight > window.innerHeight - padding) {
        top = rect.top - menuHeight - 10;
      }
      if (top < padding) {
        top = padding;
      }
      lifeBubbleMenu.style.top = top + 'px';
      lifeBubbleMenu.style.left = left + 'px';
    }

    function openBubbleMenu(personId, anchorEl) {
      if (!lifeBubbleMenuOverlay || !lifeBubbleMenu) return;
      if (bubbleMenuState.isOpen) {
        closeBubbleMenu();
      }
      bubbleMenuState.isOpen = true;
      bubbleMenuState.personId = personId;
      bubbleMenuState.anchorEl = anchorEl;
      lifeBubbleMenuOverlay.classList.add('active');
      lifeBubbleMenuOverlay.setAttribute('aria-hidden', 'false');
      requestAnimationFrame(function() {
        positionBubbleMenu(anchorEl);
      });
    }

    function closeBubbleMenu() {
      if (!bubbleMenuState.isOpen) return;
      bubbleMenuState.isOpen = false;
      bubbleMenuState.personId = '';
      bubbleMenuState.anchorEl = null;
      bubbleMenuState.longPressTriggered = false;
      if (lifeBubbleMenuOverlay) {
        lifeBubbleMenuOverlay.classList.remove('active');
        lifeBubbleMenuOverlay.setAttribute('aria-hidden', 'true');
      }
    }

    function startBubbleLongPress(button, event) {
      if (!button || !button.dataset.personId || button.id === 'lifeAddPersonBubble') return;
      bubbleMenuState.longPressTriggered = false;
      bubbleMenuState.startPoint = getPointerPoint(event);
      clearTimeout(bubbleMenuState.longPressTimer);
      bubbleMenuState.longPressTimer = setTimeout(function() {
        bubbleMenuState.longPressTriggered = true;
        openBubbleMenu(button.dataset.personId, button);
      }, 400);
    }

    function cancelBubbleLongPress() {
      clearTimeout(bubbleMenuState.longPressTimer);
      bubbleMenuState.longPressTimer = null;
      bubbleMenuState.startPoint = null;
    }

    function handleBubbleMove(event) {
      if (!bubbleMenuState.longPressTimer || !bubbleMenuState.startPoint) return;
      var point = getPointerPoint(event);
      var dx = point.x - bubbleMenuState.startPoint.x;
      var dy = point.y - bubbleMenuState.startPoint.y;
      if (Math.hypot(dx, dy) > 10) {
        cancelBubbleLongPress();
      }
    }

    function updateRoleCustomVisibility(selectEl, customEl) {
      if (!selectEl || !customEl) return;
      if (selectEl.value === 'other') {
        customEl.style.display = '';
      } else {
        customEl.style.display = 'none';
        customEl.value = '';
      }
    }

    function resetPeopleForm() {
      pendingAvatarType = 'generated';
      pendingAvatarDataUrl = '';
      if (lifePersonNameInput) lifePersonNameInput.value = '';
      if (lifePersonRoleInput) lifePersonRoleInput.value = '';
      if (lifePersonRoleCustomInput) {
        lifePersonRoleCustomInput.value = '';
        lifePersonRoleCustomInput.style.display = 'none';
      }
      if (lifePersonDobInput) lifePersonDobInput.value = '';
      if (lifePersonNotesInput) lifePersonNotesInput.value = '';
      if (lifePersonPhotoInput) lifePersonPhotoInput.value = '';
      if (lifePersonError) {
        lifePersonError.textContent = '';
        lifePersonError.style.display = 'none';
      }
      if (lifePersonPhotoPreview) {
        lifePersonPhotoPreview.src = buildAvatarSvg('new', 'New');
      }
    }

    function openLifePrefsModal() {
      if (!activePersonId || !lifePrefsForm) return;
      var prefs = getPersonPrefs(activePersonId);
      if (!prefs || !prefs.enabledSections) return;
      var inputs = lifePrefsForm.querySelectorAll('input[name="lifePrefsSection"]');
      inputs.forEach(function(input) {
        input.checked = prefs.enabledSections[input.value] !== false;
      });
      setLifePrefsModalVisible(true);
    }

    function saveLifePrefsFromForm() {
      if (!activePersonId || !lifePrefsForm) return;
      var enabledSections = {};
      var inputs = lifePrefsForm.querySelectorAll('input[name="lifePrefsSection"]');
      inputs.forEach(function(input) {
        enabledSections[input.value] = !!input.checked;
      });
      lifePersonPrefs[activePersonId] = { enabledSections: enabledSections };
      saveLifePersonPrefs();
      setLifePrefsModalVisible(false);
      lifeState.editMode = false;
      lifeState.expandedNodeId = null;
      persistLifeData();
      renderLifeView();
    }

    function setLifeActiveDomain(domainId) {
      lifeState.activeDomain = domainId;
      if (lifeData) {
        lifeData.activeDomain = domainId;
      }
      lifeState.expandedNodeId = null;
      lifeState.editMode = false;
      persistLifeData();
      renderLifeView();
    }

    function setLifeExpandedNode(nodeId) {
      if (lifeState.expandedNodeId === nodeId) {
        lifeState.expandedNodeId = null;
        lifeState.editMode = false;
      } else {
        lifeState.expandedNodeId = nodeId;
        lifeState.editMode = false;
      }
      renderLifeView();
    }

    function openLifeEditorFor(nodeId) {
      lifeState.expandedNodeId = nodeId;
      lifeState.editMode = true;
      renderLifeView();
    }

    function getFilteredLifeAssets() {
      if (!lifeState.activePersonId) return lifeAssets.slice();
      return lifeAssets.filter(function(asset) {
        return asset.ownerPersonId === lifeState.activePersonId;
      });
    }

    function getFilteredLifeAppointments() {
      if (!lifeState.activePersonId) return lifeAppointments.slice();
      return lifeAppointments.filter(function(appt) {
        return appt.personId === lifeState.activePersonId;
      });
    }

    function getFilteredLifeTasks() {
      if (!lifeState.activePersonId) return lifeTasks.slice();
      return lifeTasks.filter(function(task) {
        return task.ownerPersonId === lifeState.activePersonId;
      });
    }

    function renderLifeDomainStrip() {
      if (!lifeDomainStrip) return;
      lifeDomainStrip.innerHTML = '';
      LIFE_DOMAINS.forEach(function(domain) {
        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'life-domain-btn';
        button.textContent = domain.label;
        button.dataset.domainId = domain.id;
        button.setAttribute('role', 'listitem');
        if (domain.id === lifeState.activeDomain) {
          button.classList.add('active');
        }
        lifeDomainStrip.appendChild(button);
      });
    }

    function createLifeNodeBubble(options) {
      var bubble = document.createElement('div');
      bubble.className = 'life-node-bubble';
      bubble.setAttribute('role', 'listitem');

      var button = document.createElement('button');
      button.type = 'button';
      button.className = 'life-node-btn';
      if (options.isActive) {
        button.classList.add('is-active');
      }
      if (options.isAdd) {
        button.classList.add('life-node-add');
        button.textContent = '+';
      }
      if (options.nodeId) {
        button.dataset.nodeId = options.nodeId;
      }
      if (options.action) {
        button.dataset.nodeAction = options.action;
      }
      if (options.nodeType) {
        button.dataset.nodeType = options.nodeType;
      }
      button.setAttribute('aria-label', options.label || 'Life node');

      if (options.imageUrl) {
        var img = document.createElement('img');
        img.alt = options.label || 'Life node';
        img.src = options.imageUrl;
        button.appendChild(img);
      } else if (!options.isAdd) {
        button.textContent = options.label ? options.label.charAt(0).toUpperCase() : 'â€¢';
      }

      var label = document.createElement('div');
      label.className = 'life-node-label';
      label.textContent = options.label || '';

      bubble.appendChild(button);
      bubble.appendChild(label);
      return bubble;
    }

    function renderLifeNodeStrip() {
      if (!lifeNodeStrip) return;
      lifeNodeStrip.innerHTML = '';
      if (lifeState.activeDomain === 'family') {
        getFamilyPeople().forEach(function(person) {
          lifeNodeStrip.appendChild(createLifeNodeBubble({
            nodeId: person.id,
            nodeType: 'person',
            label: person.name || 'Unnamed',
            imageUrl: getAvatarDataUrl(person),
            isActive: lifeState.expandedNodeId === person.id
          }));
        });
        lifeNodeStrip.appendChild(createLifeNodeBubble({
          action: 'add-person',
          label: 'Add',
          isAdd: true
        }));
        return;
      }

      if (lifeState.activeDomain === 'assets') {
        var assets = getFilteredLifeAssets();
        assets.forEach(function(asset) {
          lifeNodeStrip.appendChild(createLifeNodeBubble({
            nodeId: asset.id,
            nodeType: 'asset',
            label: asset.label,
            isActive: lifeState.expandedNodeId === asset.id
          }));
        });
        lifeNodeStrip.appendChild(createLifeNodeBubble({
          action: 'add-asset',
          label: '+ Add Asset',
          isAdd: true
        }));
        return;
      }

      if (lifeState.activeDomain === 'appointments') {
        var appts = getFilteredLifeAppointments();
        appts.forEach(function(appt) {
          lifeNodeStrip.appendChild(createLifeNodeBubble({
            nodeId: appt.id,
            nodeType: 'appointment',
            label: appt.title,
            isActive: lifeState.expandedNodeId === appt.id
          }));
        });
        lifeNodeStrip.appendChild(createLifeNodeBubble({
          action: 'add-appointment',
          label: '+ Add Appointment',
          isAdd: true
        }));
        return;
      }

      var tasksList = getFilteredLifeTasks();
      tasksList.forEach(function(task) {
        lifeNodeStrip.appendChild(createLifeNodeBubble({
          nodeId: task.id,
          nodeType: 'task',
          label: task.title,
          isActive: lifeState.expandedNodeId === task.id
        }));
      });
      lifeNodeStrip.appendChild(createLifeNodeBubble({
        action: 'add-task',
        label: '+ Add Task',
        isAdd: true
      }));
    }

    function renderBubbleStrip() {
      if (!lifeBubbleStrip) return;
      lifeBubbleStrip.innerHTML = '';
      syncFamilyMemberRoleTypes();
      familyMembers.forEach(function(person) {
        var bubble = document.createElement('div');
        bubble.className = 'life-bubble';
        bubble.setAttribute('role', 'listitem');

        var button = document.createElement('button');
        button.type = 'button';
        button.className = 'life-bubble-btn';
        button.dataset.personId = person.id;
        button.setAttribute('aria-label', person.name || 'Person');
        if (person.id === activePersonId) {
          button.classList.add('is-active');
        }
        if (lifeUiPrefs.groupMode && lifeUiPrefs.selectedPeopleIds.indexOf(person.id) >= 0) {
          button.classList.add('is-selected');
        }

        var img = document.createElement('img');
        img.alt = person.name || 'Person';
        img.src = getAvatarDataUrl(person);
        button.appendChild(img);

        var check = document.createElement('span');
        check.className = 'life-bubble-check';
        check.textContent = 'âœ“';
        button.appendChild(check);

        var name = document.createElement('div');
        name.className = 'life-bubble-name';
        name.textContent = person.name || 'Unnamed';

        bubble.appendChild(button);
        bubble.appendChild(name);
        lifeBubbleStrip.appendChild(bubble);
      });
    }

    function renderActivePanel() {
      if (!lifeActiveName || !lifeActiveAvatar) return;
      var person = getPersonById(activePersonId);
      if (!person) {
        if (people.length) {
          activePersonId = people[0].id;
          localStorage.setItem(LIFE_ACTIVE_PERSON_KEY, activePersonId);
          person = getPersonById(activePersonId);
        } else {
          return;
        }
      }
      lifeActiveAvatar.src = getAvatarDataUrl(person);
      lifeActiveAvatar.alt = person.name || 'Person';
      lifeActiveName.textContent = person.name || 'Unnamed';
      if (lifeActiveRole) {
        lifeActiveRole.textContent = person.role ? formatRoleLabel(person.role) : '';
      }
      if (lifeActiveDob) {
        lifeActiveDob.textContent = person.dob ? 'DOB: ' + formatDob(person.dob) : 'DOB: â€”';
      }
      if (lifeActiveNotes) {
        lifeActiveNotes.textContent = person.notes ? person.notes : 'Notes: add anything important here.';
      }
      if (lifeRemoveButton) {
        lifeRemoveButton.disabled = person.id === 'me';
      }
      if (!isEditingActivePerson && lifeActiveEdit) {
        lifeActiveEdit.hidden = true;
        syncActiveEditForm(person);
      }
      if (person) {
        applyPersonSectionPrefs(person.id);
      }
    }

    function renderLifeDomainPanel() {
      if (!lifeDomainPanel) return;
      lifeDomainPanel.innerHTML = '';
      if (lifeState.activeDomain === 'family') {
        renderFamilyPanel();
        return;
      }
      if (lifeState.activeDomain === 'assets') {
        renderAssetsPanel();
        return;
      }
      if (lifeState.activeDomain === 'appointments') {
        renderAppointmentsPanel();
        return;
      }
      renderTasksPanel();
    }

    function renderPanelEmpty(message) {
      if (!lifeDomainPanel) return;
      var empty = document.createElement('div');
      empty.className = 'life-panel-empty';
      empty.textContent = message;
      lifeDomainPanel.appendChild(empty);
    }

    function renderFamilyPanel() {
      if (!lifeDomainPanel) return;
      var personId = lifeState.expandedNodeId;
      if (!personId) {
        renderPanelEmpty('Select a person bubble to see their details.');
        return;
      }
      var person = getPersonById(personId);
      if (!person) {
        renderPanelEmpty('Person not found.');
        return;
      }
      if (lifeState.editMode) {
        renderPersonEditForm(person);
        return;
      }

      var summary = document.createElement('div');
      summary.className = 'life-domain-summary';
      var nameRow = document.createElement('div');
      nameRow.className = 'life-domain-row';
      var nameLabel = document.createElement('span');
      nameLabel.className = 'life-domain-label';
      nameLabel.textContent = 'Name';
      var nameValue = document.createElement('span');
      nameValue.textContent = person.name || 'Unnamed';
      nameRow.appendChild(nameLabel);
      nameRow.appendChild(nameValue);

      var roleRow = document.createElement('div');
      roleRow.className = 'life-domain-row';
      var roleLabel = document.createElement('span');
      roleLabel.className = 'life-domain-label';
      roleLabel.textContent = 'Role';
      var roleValue = document.createElement('span');
      roleValue.textContent = getPersonRoleLabel(person) || 'â€”';
      roleRow.appendChild(roleLabel);
      roleRow.appendChild(roleValue);

      var dobRow = document.createElement('div');
      dobRow.className = 'life-domain-row';
      var dobLabel = document.createElement('span');
      dobLabel.className = 'life-domain-label';
      dobLabel.textContent = 'DOB';
      var dobValue = document.createElement('span');
      dobValue.textContent = person.dob ? formatDob(person.dob) : 'â€”';
      dobRow.appendChild(dobLabel);
      dobRow.appendChild(dobValue);

      summary.appendChild(nameRow);
      summary.appendChild(roleRow);
      summary.appendChild(dobRow);
      lifeDomainPanel.appendChild(summary);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'life-btn secondary';
      editBtn.textContent = 'Edit profile';
      editBtn.addEventListener('click', function() {
        lifeState.editMode = true;
        renderLifeView();
      });
      var customizeBtn = document.createElement('button');
      customizeBtn.type = 'button';
      customizeBtn.className = 'life-btn secondary';
      customizeBtn.textContent = 'Customize sections';
      customizeBtn.addEventListener('click', function() {
        setActivePersonId(person.id);
        openLifePrefsModal();
      });
      var removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'life-btn secondary';
      removeBtn.textContent = 'Remove';
      removeBtn.disabled = person.id === 'me';
      removeBtn.addEventListener('click', function() {
        setActivePersonId(person.id);
        openRemoveModal();
      });
      actions.appendChild(editBtn);
      actions.appendChild(customizeBtn);
      actions.appendChild(removeBtn);
      lifeDomainPanel.appendChild(actions);
    }

    function renderPersonEditForm(person) {
      var form = document.createElement('form');
      form.className = 'life-domain-form';
      var row = document.createElement('div');
      row.className = 'life-domain-form-row';
      var nameInput = document.createElement('input');
      nameInput.className = 'life-input';
      nameInput.type = 'text';
      nameInput.placeholder = 'Full name';
      nameInput.value = person.name || '';
      nameInput.required = true;
      var roleSelect = document.createElement('select');
      roleSelect.className = 'life-select';
      var roleOptions = ['wife', 'son', 'daughter', 'mother', 'father', 'brother', 'sister', 'other'];
      var emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'Select role';
      emptyOption.disabled = true;
      roleSelect.appendChild(emptyOption);
      roleOptions.forEach(function(role) {
        var option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        roleSelect.appendChild(option);
      });
      roleSelect.value = LIFE_ROLE_OPTIONS.indexOf(person.role) >= 0 ? person.role : 'other';
      var customRole = document.createElement('input');
      customRole.className = 'life-input';
      customRole.type = 'text';
      customRole.placeholder = 'Custom role';
      customRole.value = LIFE_ROLE_OPTIONS.indexOf(person.role) === -1 ? person.role : '';
      updateRoleCustomVisibility(roleSelect, customRole);
      roleSelect.addEventListener('change', function() {
        updateRoleCustomVisibility(roleSelect, customRole);
      });

      row.appendChild(nameInput);
      row.appendChild(roleSelect);
      row.appendChild(customRole);
      form.appendChild(row);

      var row2 = document.createElement('div');
      row2.className = 'life-domain-form-row';
      var dobInput = document.createElement('input');
      dobInput.className = 'life-input';
      dobInput.type = 'date';
      dobInput.value = person.dob || '';
      var notesInput = document.createElement('textarea');
      notesInput.className = 'life-textarea';
      notesInput.placeholder = 'Notes (optional)';
      notesInput.value = person.notes || '';
      row2.appendChild(dobInput);
      row2.appendChild(notesInput);
      form.appendChild(row2);

      var error = document.createElement('div');
      error.className = 'life-meta';
      error.style.display = 'none';
      form.appendChild(error);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var saveBtn = document.createElement('button');
      saveBtn.type = 'submit';
      saveBtn.className = 'life-btn';
      saveBtn.textContent = 'Save';
      var cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'life-btn secondary';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', function() {
        lifeState.editMode = false;
        renderLifeView();
      });
      actions.appendChild(saveBtn);
      actions.appendChild(cancelBtn);
      form.appendChild(actions);

      form.addEventListener('submit', function(event) {
        event.preventDefault();
        var name = nameInput.value.trim();
        if (!name) {
          error.textContent = 'Name is required.';
          error.style.display = 'block';
          nameInput.focus();
          return;
        }
        var role = getRoleValue(roleSelect, customRole);
        if (!role) {
          error.textContent = 'Role is required.';
          error.style.display = 'block';
          roleSelect.focus();
          return;
        }
        setFamilyMembers(people.map(function(entry) {
          if (entry.id !== person.id) return entry;
          return Object.assign({}, entry, {
            name: name,
            role: role,
            roleType: deriveRoleType(role, entry.roleType),
            dob: dobInput.value || null,
            notes: notesInput.value.trim() || null,
            updatedAt: Date.now()
          });
        }));
        savePeople();
        setActivePersonId(person.id);
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });

      lifeDomainPanel.appendChild(form);
    }

    function renderAssetsPanel() {
      if (!lifeDomainPanel) return;
      if (lifeState.expandedNodeId === 'asset:new') {
        renderAssetForm(null);
        return;
      }
      var asset = lifeAssets.find(function(item) { return item.id === lifeState.expandedNodeId; });
      if (!asset) {
        renderPanelEmpty('Select an asset to see its reminders.');
        return;
      }

      if (lifeState.editMode) {
        renderAssetForm(asset);
        return;
      }

      var summary = document.createElement('div');
      summary.className = 'life-domain-summary';
      var owner = getPersonById(asset.ownerPersonId);
      summary.appendChild(buildDomainRow('Asset', asset.label));
      summary.appendChild(buildDomainRow('Owner', owner ? owner.name : 'Unassigned'));
      lifeDomainPanel.appendChild(summary);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'life-btn secondary';
      editBtn.textContent = 'Edit asset';
      editBtn.addEventListener('click', function() {
        lifeState.editMode = true;
        renderLifeView();
      });
      actions.appendChild(editBtn);
      lifeDomainPanel.appendChild(actions);

      var serviceMetaParts = [];
      if (asset.serviceInterval) serviceMetaParts.push(asset.serviceInterval);
      if (asset.serviceDue) serviceMetaParts.push('Next due ' + asset.serviceDue);
      lifeDomainPanel.appendChild(buildAssetSubItem(asset, 'rego', 'Rego', asset.regoDue));
      lifeDomainPanel.appendChild(buildAssetSubItem(
        asset,
        'service',
        'Service',
        serviceMetaParts.join(' Â· ')
      ));
      lifeDomainPanel.appendChild(buildAssetSubItem(asset, 'insurance', 'Insurance', asset.insuranceRenewal));
    }

    function buildDomainRow(label, value) {
      var row = document.createElement('div');
      row.className = 'life-domain-row';
      var labelEl = document.createElement('span');
      labelEl.className = 'life-domain-label';
      labelEl.textContent = label;
      var valueEl = document.createElement('span');
      valueEl.textContent = value || 'â€”';
      row.appendChild(labelEl);
      row.appendChild(valueEl);
      return row;
    }

    function buildAssetSubItem(asset, type, title, metaValue) {
      var block = document.createElement('div');
      block.className = 'life-domain-subitem';
      var header = document.createElement('div');
      header.className = 'life-domain-subitem-title';
      header.textContent = title;
      var meta = document.createElement('div');
      meta.className = 'life-domain-subitem-meta';
      meta.textContent = metaValue ? metaValue : 'No reminder set yet.';
      var button = document.createElement('button');
      button.type = 'button';
      button.className = 'life-btn secondary';
      button.textContent = 'Add reminder/task';
      button.addEventListener('click', function() {
        createTaskFromAsset(asset, type);
      });
      block.appendChild(header);
      block.appendChild(meta);
      block.appendChild(button);
      return block;
    }

    function renderAssetForm(asset) {
      var isEditing = !!asset;
      var form = document.createElement('form');
      form.className = 'life-domain-form';

      var row = document.createElement('div');
      row.className = 'life-domain-form-row';
      var labelInput = document.createElement('input');
      labelInput.className = 'life-input';
      labelInput.type = 'text';
      labelInput.placeholder = 'Asset label (e.g. Car: Mazda CX-5)';
      labelInput.value = asset ? asset.label : '';
      labelInput.required = true;
      var ownerSelect = buildPersonSelect(asset ? asset.ownerPersonId : lifeState.activePersonId);
      row.appendChild(labelInput);
      row.appendChild(ownerSelect);
      form.appendChild(row);

      var row2 = document.createElement('div');
      row2.className = 'life-domain-form-row';
      var regoInput = document.createElement('input');
      regoInput.className = 'life-input';
      regoInput.type = 'date';
      regoInput.value = asset ? asset.regoDue : '';
      regoInput.placeholder = 'Rego due';
      var serviceInterval = document.createElement('input');
      serviceInterval.className = 'life-input';
      serviceInterval.type = 'text';
      serviceInterval.placeholder = 'Service interval (e.g. 10,000km)';
      serviceInterval.value = asset ? asset.serviceInterval : '';
      row2.appendChild(regoInput);
      row2.appendChild(serviceInterval);
      form.appendChild(row2);

      var row3 = document.createElement('div');
      row3.className = 'life-domain-form-row';
      var serviceDue = document.createElement('input');
      serviceDue.className = 'life-input';
      serviceDue.type = 'text';
      serviceDue.placeholder = 'Service next due';
      serviceDue.value = asset ? asset.serviceDue : '';
      var insuranceInput = document.createElement('input');
      insuranceInput.className = 'life-input';
      insuranceInput.type = 'date';
      insuranceInput.placeholder = 'Insurance renewal';
      insuranceInput.value = asset ? asset.insuranceRenewal : '';
      row3.appendChild(serviceDue);
      row3.appendChild(insuranceInput);
      form.appendChild(row3);

      var error = document.createElement('div');
      error.className = 'life-meta';
      error.style.display = 'none';
      form.appendChild(error);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var saveBtn = document.createElement('button');
      saveBtn.type = 'submit';
      saveBtn.className = 'life-btn';
      saveBtn.textContent = 'Save';
      var cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'life-btn secondary';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', function() {
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });
      actions.appendChild(saveBtn);
      actions.appendChild(cancelBtn);
      form.appendChild(actions);

      form.addEventListener('submit', function(event) {
        event.preventDefault();
        var label = labelInput.value.trim();
        if (!label) {
          error.textContent = 'Asset label is required.';
          error.style.display = 'block';
          labelInput.focus();
          return;
        }
        var ownerId = ownerSelect.value || '';
        if (isEditing) {
          lifeAssets = lifeAssets.map(function(item) {
            if (item.id !== asset.id) return item;
            return Object.assign({}, item, {
              label: label,
              ownerPersonId: ownerId,
              regoDue: regoInput.value || '',
              serviceInterval: serviceInterval.value.trim(),
              serviceDue: serviceDue.value.trim(),
              insuranceRenewal: insuranceInput.value || '',
              updatedAt: Date.now()
            });
          });
        } else {
          lifeAssets.push(normalizeLifeAsset({
            id: generateLifeAssetId(),
            label: label,
            ownerPersonId: ownerId,
            regoDue: regoInput.value || '',
            serviceInterval: serviceInterval.value.trim(),
            serviceDue: serviceDue.value.trim(),
            insuranceRenewal: insuranceInput.value || '',
            createdAt: Date.now(),
            updatedAt: Date.now()
          }));
        }
        persistLifeData();
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });

      lifeDomainPanel.appendChild(form);
    }

    function renderAppointmentsPanel() {
      if (!lifeDomainPanel) return;
      if (lifeState.expandedNodeId === 'appointment:new') {
        renderAppointmentForm(null);
        return;
      }
      var appt = lifeAppointments.find(function(item) { return item.id === lifeState.expandedNodeId; });
      if (!appt) {
        renderPanelEmpty('Select an appointment to view details.');
        return;
      }
      if (lifeState.editMode) {
        renderAppointmentForm(appt);
        return;
      }
      var summary = document.createElement('div');
      summary.className = 'life-domain-summary';
      summary.appendChild(buildDomainRow('Title', appt.title));
      summary.appendChild(buildDomainRow('Date', appt.date || 'â€”'));
      summary.appendChild(buildDomainRow('Time', appt.time || 'â€”'));
      summary.appendChild(buildDomainRow('Location', appt.location || 'â€”'));
      lifeDomainPanel.appendChild(summary);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'life-btn secondary';
      editBtn.textContent = 'Edit appointment';
      editBtn.addEventListener('click', function() {
        lifeState.editMode = true;
        renderLifeView();
      });
      actions.appendChild(editBtn);
      lifeDomainPanel.appendChild(actions);
    }

    function renderAppointmentForm(appt) {
      var isEditing = !!appt;
      var form = document.createElement('form');
      form.className = 'life-domain-form';
      var row = document.createElement('div');
      row.className = 'life-domain-form-row';
      var titleInput = document.createElement('input');
      titleInput.className = 'life-input';
      titleInput.type = 'text';
      titleInput.placeholder = 'Appointment title';
      titleInput.value = appt ? appt.title : '';
      titleInput.required = true;
      var personSelect = buildPersonSelect(appt ? appt.personId : lifeState.activePersonId);
      row.appendChild(titleInput);
      row.appendChild(personSelect);
      form.appendChild(row);

      var row2 = document.createElement('div');
      row2.className = 'life-domain-form-row';
      var dateInput = document.createElement('input');
      dateInput.className = 'life-input';
      dateInput.type = 'date';
      dateInput.value = appt ? appt.date : '';
      var timeInput = document.createElement('input');
      timeInput.className = 'life-input';
      timeInput.type = 'time';
      timeInput.value = appt ? appt.time : '';
      row2.appendChild(dateInput);
      row2.appendChild(timeInput);
      form.appendChild(row2);

      var row3 = document.createElement('div');
      row3.className = 'life-domain-form-row';
      var locationInput = document.createElement('input');
      locationInput.className = 'life-input';
      locationInput.type = 'text';
      locationInput.placeholder = 'Location';
      locationInput.value = appt ? appt.location : '';
      var notesInput = document.createElement('textarea');
      notesInput.className = 'life-textarea';
      notesInput.placeholder = 'Notes (optional)';
      notesInput.value = appt ? appt.notes : '';
      row3.appendChild(locationInput);
      row3.appendChild(notesInput);
      form.appendChild(row3);

      var error = document.createElement('div');
      error.className = 'life-meta';
      error.style.display = 'none';
      form.appendChild(error);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var saveBtn = document.createElement('button');
      saveBtn.type = 'submit';
      saveBtn.className = 'life-btn';
      saveBtn.textContent = 'Save';
      var cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'life-btn secondary';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', function() {
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });
      actions.appendChild(saveBtn);
      actions.appendChild(cancelBtn);
      form.appendChild(actions);

      form.addEventListener('submit', function(event) {
        event.preventDefault();
        var title = titleInput.value.trim();
        if (!title) {
          error.textContent = 'Appointment title is required.';
          error.style.display = 'block';
          titleInput.focus();
          return;
        }
        var personId = personSelect.value || '';
        if (isEditing) {
          lifeAppointments = lifeAppointments.map(function(item) {
            if (item.id !== appt.id) return item;
            return Object.assign({}, item, {
              title: title,
              personId: personId,
              date: dateInput.value || '',
              time: timeInput.value || '',
              location: locationInput.value.trim(),
              notes: notesInput.value.trim(),
              updatedAt: Date.now()
            });
          });
        } else {
          lifeAppointments.push(normalizeLifeAppointment({
            id: generateLifeAppointmentId(),
            title: title,
            personId: personId,
            date: dateInput.value || '',
            time: timeInput.value || '',
            location: locationInput.value.trim(),
            notes: notesInput.value.trim(),
            createdAt: Date.now(),
            updatedAt: Date.now()
          }));
        }
        persistLifeData();
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });

      lifeDomainPanel.appendChild(form);
    }

    function renderTasksPanel() {
      if (!lifeDomainPanel) return;
      if (lifeState.expandedNodeId === 'task:new') {
        renderTaskForm(null);
        return;
      }
      var task = lifeTasks.find(function(item) { return item.id === lifeState.expandedNodeId; });
      if (!task) {
        renderPanelEmpty('Select a task to see its checklist.');
        return;
      }
      if (lifeState.editMode) {
        renderTaskForm(task);
        return;
      }

      var card = document.createElement('div');
      card.className = 'life-task-card expanded';
      var header = document.createElement('div');
      header.className = 'life-task-header';
      var headerTop = document.createElement('div');
      headerTop.className = 'life-task-header-top';
      var titleBtn = document.createElement('button');
      titleBtn.type = 'button';
      titleBtn.className = 'life-task-title';
      titleBtn.textContent = task.title;
      var chevron = document.createElement('span');
      chevron.className = 'life-task-chevron';
      chevron.textContent = 'â–¾';
      headerTop.appendChild(titleBtn);
      headerTop.appendChild(chevron);
      header.appendChild(headerTop);
      card.appendChild(header);

      var body = document.createElement('div');
      body.className = 'life-task-body';
      if (!task.checklist.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No checklist items yet.';
        body.appendChild(empty);
      } else {
        var list = document.createElement('ul');
        list.className = 'life-task-checklist';
        task.checklist.forEach(function(item) {
          var li = document.createElement('li');
          li.className = item.done ? 'life-task-step completed' : 'life-task-step';
          var checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = item.done;
          checkbox.addEventListener('change', function() {
            updateTaskChecklistItem(task.id, item.id, checkbox.checked);
          });
          var text = document.createElement('span');
          text.textContent = item.text;
          li.appendChild(checkbox);
          li.appendChild(text);
          list.appendChild(li);
        });
        body.appendChild(list);
      }
      card.appendChild(body);

      header.addEventListener('click', function() {
        var isExpanded = card.classList.contains('expanded');
        card.classList.toggle('expanded', !isExpanded);
      });

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'life-btn secondary';
      editBtn.textContent = 'Edit task';
      editBtn.addEventListener('click', function() {
        lifeState.editMode = true;
        renderLifeView();
      });
      actions.appendChild(editBtn);

      lifeDomainPanel.appendChild(card);
      lifeDomainPanel.appendChild(actions);
    }

    function renderTaskForm(task) {
      var isEditing = !!task;
      var form = document.createElement('form');
      form.className = 'life-domain-form';
      var row = document.createElement('div');
      row.className = 'life-domain-form-row';
      var titleInput = document.createElement('input');
      titleInput.className = 'life-input';
      titleInput.type = 'text';
      titleInput.placeholder = 'Task title';
      titleInput.value = task ? task.title : '';
      titleInput.required = true;
      var personSelect = buildPersonSelect(task ? task.ownerPersonId : lifeState.activePersonId);
      row.appendChild(titleInput);
      row.appendChild(personSelect);
      form.appendChild(row);

      var checklistInput = document.createElement('textarea');
      checklistInput.className = 'life-textarea';
      checklistInput.placeholder = 'Checklist items (one per line)';
      checklistInput.value = task && task.checklist.length
        ? task.checklist.map(function(item) { return item.text; }).join('\n')
        : '';
      form.appendChild(checklistInput);

      var clarification = document.createElement('div');
      clarification.className = 'life-task-clarification';
      clarification.style.display = 'none';
      form.appendChild(clarification);

      var actions = document.createElement('div');
      actions.className = 'life-domain-actions';
      var suggestBtn = document.createElement('button');
      suggestBtn.type = 'button';
      suggestBtn.className = 'life-btn secondary';
      suggestBtn.textContent = 'Suggest breakdown';
      suggestBtn.addEventListener('click', function() {
        var suggestion = buildTaskBreakdown(titleInput.value.trim());
        if (suggestion.question) {
          clarification.textContent = suggestion.question;
          clarification.style.display = 'block';
          return;
        }
        clarification.style.display = 'none';
        checklistInput.value = suggestion.steps.join('\n');
      });
      var saveBtn = document.createElement('button');
      saveBtn.type = 'submit';
      saveBtn.className = 'life-btn';
      saveBtn.textContent = 'Save';
      var cancelBtn = document.createElement('button');
      cancelBtn.type = 'button';
      cancelBtn.className = 'life-btn secondary';
      cancelBtn.textContent = 'Cancel';
      cancelBtn.addEventListener('click', function() {
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });
      actions.appendChild(suggestBtn);
      actions.appendChild(saveBtn);
      actions.appendChild(cancelBtn);
      form.appendChild(actions);

      form.addEventListener('submit', function(event) {
        event.preventDefault();
        var title = titleInput.value.trim();
        if (!title) {
          clarification.textContent = 'Task title is required.';
          clarification.style.display = 'block';
          titleInput.focus();
          return;
        }
        var personId = personSelect.value || '';
        var checklistItems = checklistInput.value
          .split('\n')
          .map(function(line) { return line.trim(); })
          .filter(Boolean)
          .map(function(text) {
            return { id: generateLifeTaskId(), text: text, done: false };
          });
        if (isEditing) {
          lifeTasks = lifeTasks.map(function(item) {
            if (item.id !== task.id) return item;
            return Object.assign({}, item, {
              title: title,
              ownerPersonId: personId,
              checklist: checklistItems,
              updatedAt: Date.now()
            });
          });
        } else {
          lifeTasks.push(normalizeLifeTask({
            id: generateLifeTaskId(),
            title: title,
            ownerPersonId: personId,
            checklist: checklistItems,
            createdAt: Date.now(),
            updatedAt: Date.now()
          }));
        }
        persistLifeData();
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        renderLifeView();
      });

      lifeDomainPanel.appendChild(form);
    }

    function buildPersonSelect(selectedId) {
      var select = document.createElement('select');
      select.className = 'life-select';
      var empty = document.createElement('option');
      empty.value = '';
      empty.textContent = 'Unassigned';
      select.appendChild(empty);
      getFamilyPeople().forEach(function(person) {
        var option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name || 'Unnamed';
        select.appendChild(option);
      });
      if (selectedId) {
        select.value = selectedId;
      }
      return select;
    }

    function updateTaskChecklistItem(taskId, itemId, isDone) {
      lifeTasks = lifeTasks.map(function(task) {
        if (task.id !== taskId) return task;
        var updatedChecklist = task.checklist.map(function(item) {
          if (item.id !== itemId) return item;
          return Object.assign({}, item, { done: isDone });
        });
        return Object.assign({}, task, {
          checklist: updatedChecklist,
          updatedAt: Date.now()
        });
      });
      persistLifeData();
      renderLifeView();
    }

    function buildTaskBreakdown(text) {
      var lower = (text || '').toLowerCase();
      var ambiguousTerms = ['pad', 'bank', 'charge'];
      var ambiguous = ambiguousTerms.find(function(term) {
        return lower.includes(term);
      });
      if (ambiguous) {
        return {
          question: 'Quick clarification: what does "' + ambiguous + '" mean in this task?'
        };
      }
      if (!text) {
        return {
          steps: ['Clarify the task details', 'List needed materials', 'Complete the task', 'Confirm it is done']
        };
      }
      var parts = text.split(/,| and | then /i).map(function(part) { return part.trim(); }).filter(Boolean);
      var steps = parts.length > 1
        ? parts.map(function(part) { return 'Handle: ' + part; })
        : ['Prep for "' + text + '"', 'Complete "' + text + '"', 'Review the result'];
      return { steps: steps };
    }

    function createTaskFromAsset(asset, type) {
      if (!asset) return;
      var label = asset.label || 'Asset';
      var titles = {
        rego: 'Rego reminder for ' + label,
        service: 'Service reminder for ' + label,
        insurance: 'Insurance renewal for ' + label
      };
      lifeTasks.push(normalizeLifeTask({
        id: generateLifeTaskId(),
        title: titles[type] || ('Reminder for ' + label),
        ownerPersonId: asset.ownerPersonId || lifeState.activePersonId || '',
        assetId: asset.id,
        checklist: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      }));
      persistLifeData();
      renderLifeView();
    }

    function renderLifeView() {
      renderLifeDomainStrip();
      renderLifeNodeStrip();
      renderLifeDomainPanel();
      if (typeof renderCalendarPeopleOptions === 'function') {
        renderCalendarPeopleOptions();
      }
    }

    function openPeopleForm() {
      resetPeopleForm();
      setPeopleModalVisible(true);
      if (lifePersonNameInput) lifePersonNameInput.focus();
    }

    function openPersonView(person) {
      if (!person) return;
      setActivePersonId(person.id);
      renderLifeView();
    }

    function setEditMode(isEditing) {
      isEditingActivePerson = isEditing;
      if (!lifeActiveEdit) return;
      lifeActiveEdit.hidden = !isEditing;
      if (isEditing) {
        setActiveEditError('');
      }
      if (isEditing) {
        var person = getPersonById(activePersonId);
        if (!person) return;
        syncActiveEditForm(person);
      }
    }

    function syncActiveEditForm(person) {
      if (!person) return;
      if (lifeEditName) lifeEditName.value = person.name || '';
      if (lifeEditRole) {
        var roleValue = LIFE_ROLE_OPTIONS.indexOf(person.role) >= 0 ? person.role : 'other';
        lifeEditRole.value = roleValue;
      }
      if (lifeEditRoleCustom) {
        if (LIFE_ROLE_OPTIONS.indexOf(person.role) === -1 && person.role) {
          lifeEditRoleCustom.value = person.role;
        } else {
          lifeEditRoleCustom.value = '';
        }
      }
      updateRoleCustomVisibility(lifeEditRole, lifeEditRoleCustom);
      if (lifeEditDob) lifeEditDob.value = person.dob || '';
      if (lifeEditNotes) lifeEditNotes.value = person.notes || '';
    }

    function setActiveEditError(message) {
      if (!lifeEditError) return;
      lifeEditError.textContent = message || '';
      lifeEditError.style.display = message ? 'block' : 'none';
    }

    function updateGroupSelection(personId) {
      var list = lifeUiPrefs.selectedPeopleIds || [];
      var index = list.indexOf(personId);
      if (index >= 0) {
        list.splice(index, 1);
      } else {
        list.push(personId);
      }
      lifeUiPrefs.selectedPeopleIds = list;
      saveLifeUiPrefs();
      renderLifeView();
    }

    function getRoleValue(selectEl, customEl) {
      if (!selectEl) return '';
      if (selectEl.value === 'other') {
        return customEl && customEl.value.trim() ? customEl.value.trim() : 'other';
      }
      return selectEl.value || '';
    }

    function setPhotoPreview(dataUrl, name) {
      if (!lifePersonPhotoPreview) return;
      lifePersonPhotoPreview.src = dataUrl || buildAvatarSvg('new', name || 'New');
    }

    function compressImageFile(file, callback) {
      var reader = new FileReader();
      reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
          var maxSize = 256;
          var width = img.width;
          var height = img.height;
          var scale = Math.min(maxSize / width, maxSize / height, 1);
          var canvas = document.createElement('canvas');
          canvas.width = Math.round(width * scale);
          canvas.height = Math.round(height * scale);
          var ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          var dataUrl = canvas.toDataURL('image/jpeg', 0.78);
          callback(dataUrl);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function saveNewPerson() {
      var name = lifePersonNameInput ? lifePersonNameInput.value.trim() : '';
      logLifeDebug('addPerson submit start', name);
      if (!name) {
        if (lifePersonNameInput) lifePersonNameInput.focus();
        return;
      }
      if (lifePersonError) {
        lifePersonError.textContent = '';
        lifePersonError.style.display = 'none';
      }
      var role = getRoleValue(lifePersonRoleInput, lifePersonRoleCustomInput) || 'other';
      var now = Date.now();
      var person = {
        id: generatePersonId(),
        name: name,
        role: role,
        roleType: deriveRoleType(role),
        dob: lifePersonDobInput ? lifePersonDobInput.value || null : null,
        avatarType: pendingAvatarDataUrl ? 'photo' : 'generated',
        avatarDataUrl: pendingAvatarDataUrl || null,
        notes: lifePersonNotesInput ? lifePersonNotesInput.value.trim() || null : null,
        createdAt: now,
        updatedAt: now
      };
      people.push(person);
      if (!savePeople()) {
        if (lifePersonError) {
          lifePersonError.textContent = 'Could not save. Please try again.';
          lifePersonError.style.display = 'block';
        }
        return;
      }
      setActivePersonId(person.id);
      setPeopleModalVisible(false);
      resetPeopleForm();
      lifeState.editMode = false;
      lifeState.expandedNodeId = null;
      persistLifeData();
      renderLifeView();
      logLifeDebug('addPerson submit end', person.id);
      logLifeDebug('people length', people.length);
    }

    function saveActivePersonEdits() {
      setActiveEditError('');
      try {
        var person = getPersonById(activePersonId);
        if (!person) return;
        var name = lifeEditName ? lifeEditName.value.trim() : '';
        if (!name) {
          setActiveEditError('Name is required.');
          if (lifeEditName) lifeEditName.focus();
          return;
        }
        var role = getRoleValue(lifeEditRole, lifeEditRoleCustom);
        if (!role) {
          setActiveEditError('Role is required.');
          if (lifeEditRole) lifeEditRole.focus();
          return;
        }
        var updatedAt = Date.now();
        var dob = lifeEditDob ? lifeEditDob.value || null : null;
        var notes = lifeEditNotes ? lifeEditNotes.value.trim() || null : null;
        setFamilyMembers(people.map(function(entry) {
          if (entry.id !== activePersonId) return entry;
          return Object.assign({}, entry, {
            name: name,
            role: role,
            roleType: deriveRoleType(role, entry.roleType),
            dob: dob,
            notes: notes,
            updatedAt: updatedAt
          });
        }));
        savePeople();
        setEditMode(false);
        lifeState.editMode = false;
        lifeState.expandedNodeId = null;
        persistLifeData();
        renderLifeView();
      } catch (err) {
        console.error('saveProfile:error', err);
        setActiveEditError('Could not save. Please try again.');
      }
    }

    function openRemoveModal() {
      var person = getPersonById(activePersonId);
      if (!person) return;
      if (person.id === 'me') return;
      pendingRemovePersonId = person.id;
      if (lifeRemoveModalText) {
        lifeRemoveModalText.textContent = 'Remove ' + (person.name || 'this person') + '?';
      }
      setRemoveModalVisible(true);
    }

    function confirmRemovePerson() {
      if (!pendingRemovePersonId) return;
      setFamilyMembers(people.filter(function(person) { return person.id !== pendingRemovePersonId; }));
      if (lifePersonPrefs && lifePersonPrefs[pendingRemovePersonId]) {
        delete lifePersonPrefs[pendingRemovePersonId];
        saveLifePersonPrefs();
      }
      savePeople();
      if (!people.length) {
        activePersonId = null;
        lifeState.activePersonId = null;
        localStorage.setItem(LIFE_ACTIVE_PERSON_KEY, '');
      } else if (pendingRemovePersonId === activePersonId) {
        var fallback = people.find(function(person) { return person.id === 'me'; }) || people[0];
        setActivePersonId(fallback.id);
      }
      lifeUiPrefs.selectedPeopleIds = (lifeUiPrefs.selectedPeopleIds || []).filter(function(id) {
        return id !== pendingRemovePersonId;
      });
      saveLifeUiPrefs();
      pendingRemovePersonId = null;
      setRemoveModalVisible(false);
      lifeState.editMode = false;
      lifeState.expandedNodeId = null;
      persistLifeData();
      renderLifeView();
    }

    function closeLifeModals() {
      setPeopleModalVisible(false);
      setRemoveModalVisible(false);
      setLifePrefsModalVisible(false);
      closeMemberPanel();
    }

    function renderPersonRightNow(personId) {
      if (!lifePersonNowList) return;
      lifePersonNowList.innerHTML = '';
      var items = [];
      goalsShort.forEach(function(goal) {
        if (goal.personId === personId && !goal.done) {
          items.push({ type: 'goal', text: goal.text, meta: 'Short-term goal', createdAt: goal.createdAt || 0 });
        }
      });
      tasks.forEach(function(task) {
        if (task.personId === personId && !task.done) {
          items.push({ type: 'task', text: task.text, meta: formatTaskMeta(task), createdAt: task.createdAt || 0 });
        }
      });
      items.sort(function(a, b) { return b.createdAt - a.createdAt; });
      var topItems = items.slice(0, 5);
      if (!topItems.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No active goals or tasks yet.';
        lifePersonNowList.appendChild(empty);
        return;
      }
      topItems.forEach(function(item) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = item.text || 'Untitled';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = item.meta || (item.type === 'goal' ? 'Short-term goal' : 'Task');
        row.appendChild(title);
        row.appendChild(meta);
        lifePersonNowList.appendChild(row);
      });
    }

    function renderPersonComingUp(personId) {
      if (!lifePersonComingList) return;
      lifePersonComingList.innerHTML = '';
      var now = Date.now();
      var upcoming = [];
      appointments.forEach(function(appt) {
        if (appt.personId !== personId || !appt.dateTimeStart) return;
        var time = new Date(appt.dateTimeStart).getTime();
        if (!Number.isNaN(time) && time < now) return;
        upcoming.push({
          type: 'appointment',
          title: appt.title || 'Untitled appointment',
          dateTime: new Date(appt.dateTimeStart),
          location: appt.location || ''
        });
      });
      calendarEvents.forEach(function(event) {
        if (event.personId !== personId || !event.date) return;
        var timeValue = event.startTime || '00:00';
        var dateTime = new Date(event.date + 'T' + timeValue);
        if (Number.isNaN(dateTime.getTime())) return;
        if (dateTime.getTime() < now) return;
        upcoming.push({
          type: 'calendar',
          title: event.title || 'Untitled event',
          dateTime: dateTime,
          location: event.location || '',
          allDay: !!event.allDay
        });
      });
      upcoming.sort(function(a, b) {
        return a.dateTime - b.dateTime;
      });
      if (!upcoming.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No upcoming appointments yet.';
        lifePersonComingList.appendChild(empty);
        return;
      }
      upcoming.slice(0, 5).forEach(function(appt) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = appt.title || 'Untitled appointment';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var timeLabel = appt.dateTime ? appt.dateTime.toLocaleString() : '';
        if (appt.allDay) {
          timeLabel = appt.dateTime ? appt.dateTime.toLocaleDateString() + ' (All day)' : 'All day';
        }
        meta.textContent = [timeLabel, appt.location].filter(Boolean).join(' Â· ');
        row.appendChild(title);
        if (meta.textContent) row.appendChild(meta);
        lifePersonComingList.appendChild(row);
      });
    }

    function renderPersonParked(personId) {
      if (!lifePersonParkedList) return;
      lifePersonParkedList.innerHTML = '';
      var parkedGoals = goalsLong.filter(function(goal) {
        return goal.personId === personId;
      });
      if (!parkedGoals.length) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No parked long-term goals yet.';
        lifePersonParkedList.appendChild(empty);
        return;
      }
      parkedGoals.forEach(function(goal) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = goal.title || 'Untitled goal';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = goal.targetDate ? 'Target ' + goal.targetDate : 'Long-term goal';
        row.appendChild(title);
        row.appendChild(meta);
        if (goal.note) {
          var note = document.createElement('div');
          note.className = 'life-meta';
          note.textContent = goal.note;
          row.appendChild(note);
        }
        lifePersonParkedList.appendChild(row);
      });
    }

    var lifeAgendaRangeDays = 7;

    function formatAgendaDayHeader(date) {
      var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var label = weekdays[date.getDay()] + ' ' + padNumber(date.getDate()) + ' ' + months[date.getMonth()];
      return label.toUpperCase();
    }

    function formatAgendaTimeLabel(value) {
      if (!value) return '';
      var parts = value.split(':');
      if (parts.length < 2) return value;
      var hour = parseInt(parts[0], 10);
      var minute = parts[1];
      if (Number.isNaN(hour)) return value;
      var meridiem = hour >= 12 ? 'PM' : 'AM';
      var hour12 = hour % 12;
      if (hour12 === 0) hour12 = 12;
      return hour12 + ':' + minute + meridiem;
    }

    function buildAgendaTimeRange(event) {
      if (!event) return '';
      if (event.allDay) return 'all-day';
      if (!event.startTime) return '';
      var startLabel = formatAgendaTimeLabel(event.startTime);
      if (event.endTime) {
        return startLabel + 'â€“' + formatAgendaTimeLabel(event.endTime);
      }
      return startLabel;
    }

    function buildAgendaOccurrences(personId, startDate, days) {
      var occurrences = {};
      for (var i = 0; i < days; i++) {
        var date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        occurrences[toYmd(date)] = [];
      }
      calendarEvents.forEach(function(event) {
        if (!event || event.personId !== personId || !event.date) return;
        var eventStart = parseYmd(event.date);
        if (!eventStart) return;
        var recurrence = event.recurrence || { type: 'none' };
        if (recurrence.type === 'none') {
          var ymd = toYmd(eventStart);
          if (occurrences[ymd]) {
            occurrences[ymd].push(event);
          }
          return;
        }
        for (var i = 0; i < days; i++) {
          var date = new Date(startDate);
          date.setDate(startDate.getDate() + i);
          if (date.getTime() < eventStart.getTime()) continue;
          if (!isWithinUntil(date, recurrence.until)) continue;
          var diffDays = Math.floor((date.getTime() - eventStart.getTime()) / 86400000);
          var ymdKey = toYmd(date);
          if (!occurrences[ymdKey]) continue;
          if (recurrence.type === 'weekly' && diffDays % 7 === 0) {
            occurrences[ymdKey].push(event);
          }
          if (recurrence.type === 'fortnightly' && diffDays % 14 === 0) {
            occurrences[ymdKey].push(event);
          }
          if (recurrence.type === 'custom_weekdays') {
            var weekdays = Array.isArray(recurrence.weekdays) ? recurrence.weekdays : [];
            if (weekdays.includes(date.getDay())) {
              occurrences[ymdKey].push(event);
            }
          }
        }
      });
      Object.keys(occurrences).forEach(function(key) {
        occurrences[key].sort(function(a, b) {
          if (!!a.allDay !== !!b.allDay) {
            return a.allDay ? -1 : 1;
          }
          return String(a.startTime || '').localeCompare(String(b.startTime || ''));
        });
      });
      return occurrences;
    }

    function setAgendaRange(days) {
      lifeAgendaRangeDays = days;
      if (lifeAgendaRange) {
        lifeAgendaRange.querySelectorAll('.life-agenda-segment').forEach(function(button) {
          button.classList.toggle('active', parseInt(button.dataset.range, 10) === days || (days === 1 && button.dataset.range === 'today'));
        });
      }
      if (activePersonId) {
        renderPersonAgenda(activePersonId);
      }
    }

    function renderPersonAgenda(personId) {
      if (!lifeAgendaList) return;
      lifeAgendaList.innerHTML = '';
      if (!personId) return;
      var startDate = new Date();
      startDate.setHours(0, 0, 0, 0);
      var rangeDays = lifeAgendaRangeDays;
      var occurrences = buildAgendaOccurrences(personId, startDate, rangeDays);
      var todayKey = toYmd(startDate);
      var todayEvents = occurrences[todayKey] || [];

      function appendDay(date, events, isToday) {
        var dayWrapper = document.createElement('div');
        dayWrapper.className = 'life-agenda-day';
        var header = document.createElement('div');
        header.className = 'life-agenda-day-header';
        header.textContent = formatAgendaDayHeader(date);
        dayWrapper.appendChild(header);
        if (!events.length && isToday) {
          var empty = document.createElement('div');
          empty.className = 'life-agenda-empty';
          empty.textContent = 'No Events Today';
          dayWrapper.appendChild(empty);
        } else {
          events.forEach(function(event) {
            var row = document.createElement('div');
            row.className = 'life-agenda-item';
            var accent = document.createElement('div');
            accent.className = 'life-agenda-accent';
            var details = document.createElement('div');
            var title = document.createElement('div');
            title.className = 'life-agenda-title';
            title.textContent = event.title || 'Untitled event';
            details.appendChild(title);
            if (event.location) {
              var location = document.createElement('div');
              location.className = 'life-agenda-location';
              location.textContent = event.location;
              details.appendChild(location);
              var actions = document.createElement('div');
              actions.className = 'life-agenda-actions';
              var directionsBtn = document.createElement('button');
              directionsBtn.type = 'button';
              directionsBtn.className = 'life-agenda-direction';
              directionsBtn.textContent = 'Directions';
              directionsBtn.addEventListener('click', function(ev) {
                ev.stopPropagation();
                window.open(buildDirectionsUrl(event.location), '_blank');
              });
              actions.appendChild(directionsBtn);
              details.appendChild(actions);
            }
            var time = document.createElement('div');
            time.className = 'life-agenda-time';
            time.textContent = buildAgendaTimeRange(event);
            row.appendChild(accent);
            row.appendChild(details);
            row.appendChild(time);
            row.addEventListener('click', function() {
              openEventModal(event, toYmd(date), { lockPersonId: personId });
            });
            dayWrapper.appendChild(row);
          });
        }
        lifeAgendaList.appendChild(dayWrapper);
      }

      if (!todayEvents.length) {
        appendDay(new Date(startDate), [], true);
      }

      for (var i = 0; i < rangeDays; i++) {
        var date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        var key = toYmd(date);
        var events = occurrences[key] || [];
        if (!events.length) {
          continue;
        }
        appendDay(date, events, key === todayKey);
      }
    }

    function openPersonView(person) {
      if (!person) return;
      activePersonId = person.id;
      if (lifePersonNameDisplay) lifePersonNameDisplay.textContent = person.name || 'Unnamed';
      if (lifePersonRoleDisplay) lifePersonRoleDisplay.textContent = getPersonRoleLabel(person) || 'Other';
      if (lifePersonOrgDisplay) {
        lifePersonOrgDisplay.textContent = person.org || '';
        lifePersonOrgDisplay.style.display = person.org ? '' : 'none';
      }
      if (lifePersonAvatar) {
        lifePersonAvatar.src = getAvatarDataUrl(person);
        lifePersonAvatar.alt = person.name || 'Person';
      }
      setPersonViewActive(true);
      closePersonTaskForm();
      lifeAppointmentsPastExpanded = false;
      if (lifeAppointmentsBody) {
        lifeAppointmentsBody.classList.remove('is-collapsed');
      }
      if (lifeAppointmentsToggle) {
        lifeAppointmentsToggle.setAttribute('aria-expanded', 'true');
      }
      if (lifeTasksBody) {
        lifeTasksBody.classList.remove('is-collapsed');
      }
      if (lifeTasksToggle) {
        lifeTasksToggle.setAttribute('aria-expanded', 'true');
      }
      personTasksCompletedExpanded = false;
      renderPersonAppointments(person.id);
      renderPersonTasks(person.id);
    }

    function createImageThumbnail(file) {
      return new Promise(function(resolve, reject) {
        if (!file) {
          reject(new Error('No file'));
          return;
        }
        if (file.size > 4 * 1024 * 1024) {
          reject(new Error('File too large'));
          return;
        }
        var reader = new FileReader();
        reader.onload = function(e) {
          var img = new Image();
          img.onload = function() {
            var maxSize = 256;
            var width = img.width;
            var height = img.height;
            if (width > height && width > maxSize) {
              height = Math.round(height * (maxSize / width));
              width = maxSize;
            } else if (height > maxSize) {
              width = Math.round(width * (maxSize / height));
              height = maxSize;
            }
            var canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
            resolve(dataUrl);
          };
          img.onerror = function() {
            reject(new Error('Image load failed'));
          };
          img.src = e.target.result;
        };
        reader.onerror = function() {
          reject(new Error('File read failed'));
        };
        reader.readAsDataURL(file);
      });
    }

    // FAMILY CALENDAR (PHASE 1)
    var CALENDAR_EVENTS_KEY = 'friction_calendar_events_v1';
    var calendarEvents = [];
    var calendarCursor = new Date();
    var calendarSelectedDate = null;
    var calendarEditingEventId = null;
    var calendarOccurrences = {};
    var calendarReturnToDay = false;
    var calendarLockedPersonId = null;

    function padNumber(value) {
      return value < 10 ? '0' + value : String(value);
    }

    function toYmd(date) {
      if (!(date instanceof Date)) return '';
      return [date.getFullYear(), padNumber(date.getMonth() + 1), padNumber(date.getDate())].join('-');
    }

    function parseYmd(value) {
      if (!value) return null;
      var parts = value.split('-').map(function(part) { return parseInt(part, 10); });
      if (parts.length !== 3 || parts.some(function(part) { return Number.isNaN(part); })) return null;
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    function getMonthLabel(date) {
      if (!date) return '';
      return date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
    }

    function formatTimeRange(event) {
      if (!event) return '';
      if (event.allDay) return 'All day';
      if (!event.startTime) return '';
      if (event.endTime) {
        return event.startTime + 'â€“' + event.endTime;
      }
      return event.startTime;
    }

    function buildDirectionsUrl(location) {
      if (!location) return '';
      var encoded = encodeURIComponent(location);
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      return isIOS
        ? 'https://maps.apple.com/?q=' + encoded
        : 'https://www.google.com/maps/search/?api=1&query=' + encoded;
    }

    function normalizeCalendarEvent(event) {
      if (!event || typeof event !== 'object') return null;
      var recurrence = event.recurrence || {};
      var type = recurrence.type || 'none';
      if (!['none', 'weekly', 'fortnightly', 'custom_weekdays'].includes(type)) {
        type = 'none';
      }
      var normalized = {
        id: event.id || 'event_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36),
        personId: event.personId || '',
        title: event.title || '',
        date: event.date || '',
        startTime: event.startTime || '',
        endTime: event.endTime || '',
        location: event.location || '',
        notes: event.notes || '',
        allDay: !!event.allDay,
        recurrence: {
          type: type,
          weekdays: Array.isArray(recurrence.weekdays) ? recurrence.weekdays.slice() : [],
          until: recurrence.until || ''
        },
        createdAt: event.createdAt || Date.now(),
        updatedAt: event.updatedAt || event.createdAt || Date.now()
      };
      if (type !== 'custom_weekdays') {
        delete normalized.recurrence.weekdays;
        delete normalized.recurrence.until;
      }
      return normalized;
    }

    function loadCalendarEvents() {
      var saved = localStorage.getItem(CALENDAR_EVENTS_KEY);
      if (!saved) {
        calendarEvents = [];
        return;
      }
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) {
          calendarEvents = [];
          return;
        }
        calendarEvents = parsed.map(normalizeCalendarEvent).filter(Boolean);
      } catch (e) {
        calendarEvents = [];
      }
    }

    function saveCalendarEvents() {
      localStorage.setItem(CALENDAR_EVENTS_KEY, JSON.stringify(calendarEvents));
    }

    function getMonthDays(year, month) {
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var days = [];
      for (var day = 1; day <= daysInMonth; day++) {
        var date = new Date(year, month, day);
        days.push({
          date: date,
          ymd: toYmd(date),
          weekday: date.getDay()
        });
      }
      return days;
    }

    function isWithinUntil(date, until) {
      if (!until) return true;
      var untilDate = parseYmd(until);
      if (!untilDate) return true;
      return date.getTime() <= untilDate.getTime();
    }

    function buildOccurrencesForMonth(year, month) {
      var days = getMonthDays(year, month);
      var occurrences = {};
      days.forEach(function(day) {
        occurrences[day.ymd] = [];
      });
      calendarEvents.forEach(function(event) {
        if (!event.date || !event.startTime) return;
        var startDate = parseYmd(event.date);
        if (!startDate) return;
        var recurrence = event.recurrence || { type: 'none' };
        if (recurrence.type === 'none') {
          if (startDate.getFullYear() === year && startDate.getMonth() === month) {
            occurrences[event.date].push(event);
          }
          return;
        }
        days.forEach(function(day) {
          if (day.date.getTime() < startDate.getTime()) return;
          if (!isWithinUntil(day.date, recurrence.until)) return;
          var diffDays = Math.floor((day.date.getTime() - startDate.getTime()) / 86400000);
          if (recurrence.type === 'weekly' && diffDays % 7 === 0) {
            occurrences[day.ymd].push(event);
          }
          if (recurrence.type === 'fortnightly' && diffDays % 14 === 0) {
            occurrences[day.ymd].push(event);
          }
          if (recurrence.type === 'custom_weekdays') {
            var weekdays = Array.isArray(recurrence.weekdays) ? recurrence.weekdays : [];
            if (weekdays.includes(day.weekday)) {
              occurrences[day.ymd].push(event);
            }
          }
        });
      });
      Object.keys(occurrences).forEach(function(key) {
        occurrences[key].sort(function(a, b) {
          return String(a.startTime || '').localeCompare(String(b.startTime || ''));
        });
        if (!occurrences[key].length) {
          delete occurrences[key];
        }
      });
      return occurrences;
    }

    function getOccurrencesForDate(ymd) {
      var date = parseYmd(ymd);
      if (!date) return [];
      if (date.getFullYear() === calendarCursor.getFullYear() && date.getMonth() === calendarCursor.getMonth()) {
        return calendarOccurrences[ymd] || [];
      }
      var temp = buildOccurrencesForMonth(date.getFullYear(), date.getMonth());
      return temp[ymd] || [];
    }

    function getPersonById(personId) {
      if (!personId) return null;
      return people.find(function(person) { return person.id === personId; }) || null;
    }

    function showCalendarModal(modal) {
      if (!modal) return;
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function hideCalendarModal(modal) {
      if (!modal) return;
      modal.classList.remove('active');
      modal.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
    }

    function renderCalendarMonth() {
      if (!calendarGrid || !calendarMonthLabel) return;
      var year = calendarCursor.getFullYear();
      var month = calendarCursor.getMonth();
      calendarMonthLabel.textContent = getMonthLabel(calendarCursor);
      calendarOccurrences = buildOccurrencesForMonth(year, month);
      calendarGrid.innerHTML = '';
      ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(function(label) {
        var header = document.createElement('div');
        header.className = 'calendar-weekday';
        header.textContent = label;
        calendarGrid.appendChild(header);
      });
      var firstDay = new Date(year, month, 1);
      var startOffset = firstDay.getDay();
      for (var i = 0; i < 42; i++) {
        var cellDate = new Date(year, month, 1 - startOffset + i);
        var ymd = toYmd(cellDate);
        var dayButton = document.createElement('button');
        dayButton.type = 'button';
        dayButton.className = 'calendar-day';
        if (cellDate.getMonth() !== month) {
          dayButton.classList.add('outside');
        }
        dayButton.dataset.date = ymd;
        var dayNumber = document.createElement('div');
        dayNumber.className = 'calendar-day-number';
        dayNumber.textContent = cellDate.getDate();
        dayButton.appendChild(dayNumber);
        var dayEvents = calendarOccurrences[ymd] || [];
        dayEvents.slice(0, 3).forEach(function(event) {
          var chip = document.createElement('div');
          chip.className = 'calendar-chip';
          var person = getPersonById(event.personId);
          var avatar = document.createElement('img');
          avatar.alt = person && person.name ? person.name : 'Family';
          avatar.src = person ? getAvatarDataUrl(person) : buildAvatarSvg(event.id, event.title);
          var title = document.createElement('span');
          title.textContent = event.title || 'Event';
          chip.appendChild(avatar);
          chip.appendChild(title);
          dayButton.appendChild(chip);
        });
        if (dayEvents.length > 3) {
          var more = document.createElement('div');
          more.className = 'calendar-chip calendar-chip-more';
          more.textContent = '+' + (dayEvents.length - 3) + ' more';
          dayButton.appendChild(more);
        }
        dayButton.addEventListener('click', function(e) {
          var dateValue = e.currentTarget.dataset.date;
          openDayModal(dateValue);
        });
        calendarGrid.appendChild(dayButton);
      }
    }

    function renderCalendarPeopleOptions() {
      if (!calendarEventPerson) return;
      var familyPeople = getFamilyPeople();
      var currentValue = calendarEventPerson.value;
      calendarEventPerson.innerHTML = '';
      if (!familyPeople.length) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Add a family member in Life first';
        option.disabled = true;
        option.selected = true;
        calendarEventPerson.appendChild(option);
        calendarEventPerson.disabled = true;
        updateCalendarPersonPreview();
        return;
      }
      calendarEventPerson.disabled = false;
      familyPeople.forEach(function(person) {
        var option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name + (person.role ? ' Â· ' + getPersonRoleLabel(person) : '');
        calendarEventPerson.appendChild(option);
      });
      if (currentValue && familyPeople.some(function(person) { return person.id === currentValue; })) {
        calendarEventPerson.value = currentValue;
      }
      updateCalendarPersonPreview();
    }

    function updateCalendarPersonPreview() {
      if (!calendarEventPersonAvatar || !calendarEventPerson) return;
      var person = getPersonById(calendarEventPerson.value);
      if (!person) {
        calendarEventPersonAvatar.src = buildAvatarSvg('family', 'Family');
        calendarEventPersonAvatar.alt = 'Family avatar';
        return;
      }
      calendarEventPersonAvatar.src = getAvatarDataUrl(person);
      calendarEventPersonAvatar.alt = person.name || 'Person';
    }

    function updateCalendarDirectionsButton() {
      if (!calendarEventDirections || !calendarEventLocation) return;
      var location = calendarEventLocation.value.trim();
      if (!location) {
        calendarEventDirections.style.display = 'none';
        return;
      }
      calendarEventDirections.style.display = 'inline-flex';
    }

    function updateCalendarEventTimeVisibility() {
      if (!calendarEventAllDay || !calendarEventTimeRow || !calendarEventStart) return;
      var isAllDay = calendarEventAllDay.checked;
      calendarEventTimeRow.style.display = isAllDay ? 'none' : '';
      calendarEventStart.required = !isAllDay;
    }

    function updateCustomRepeatVisibility() {
      if (!calendarEventRepeat || !calendarCustomWeekdays || !calendarCustomUntil) return;
      var isCustom = calendarEventRepeat.value === 'custom_weekdays';
      calendarCustomWeekdays.style.display = isCustom ? 'grid' : 'none';
      calendarCustomUntil.style.display = isCustom ? 'block' : 'none';
      if (isCustom) {
        updateRepeatDayButtons();
      }
    }

    function updateRepeatDayButtons() {
      if (!calendarCustomWeekdays) return;
      var labels = calendarCustomWeekdays.querySelectorAll('.calendar-repeat-day');
      labels.forEach(function(label) {
        var input = label.querySelector('input');
        label.classList.toggle('active', input && input.checked);
      });
    }

    function openDayModal(ymd) {
      calendarSelectedDate = ymd;
      renderDayModal();
      showCalendarModal(calendarDayModal);
    }

    function renderDayModal() {
      if (!calendarDayList || !calendarDayTitle || !calendarDaySubtitle) return;
      var date = parseYmd(calendarSelectedDate);
      calendarDayTitle.textContent = 'Day details';
      calendarDaySubtitle.textContent = date ? date.toLocaleDateString() : '';
      calendarDayList.innerHTML = '';
      var eventsForDay = getOccurrencesForDate(calendarSelectedDate);
      if (!eventsForDay.length) {
        var empty = document.createElement('div');
        empty.className = 'calendar-empty';
        empty.textContent = 'No events yet.';
        calendarDayList.appendChild(empty);
        return;
      }
      eventsForDay.forEach(function(event) {
        var card = document.createElement('div');
        card.className = 'calendar-event-card';
        var header = document.createElement('div');
        header.className = 'calendar-event-header';
        var avatarWrap = document.createElement('div');
        avatarWrap.className = 'calendar-event-avatar';
        var person = getPersonById(event.personId);
        var avatarImg = document.createElement('img');
        avatarImg.alt = person && person.name ? person.name : 'Family';
        avatarImg.src = person ? getAvatarDataUrl(person) : buildAvatarSvg(event.id, event.title);
        avatarWrap.appendChild(avatarImg);
        var headerText = document.createElement('div');
        var title = document.createElement('div');
        title.className = 'calendar-event-title';
        title.textContent = event.title || 'Event';
        var meta = document.createElement('div');
        meta.className = 'calendar-event-meta';
        meta.textContent = [person ? person.name : 'Family', formatTimeRange(event)].filter(Boolean).join(' Â· ');
        headerText.appendChild(title);
        headerText.appendChild(meta);
        header.appendChild(avatarWrap);
        header.appendChild(headerText);
        card.appendChild(header);
        if (event.location) {
          var location = document.createElement('div');
          location.className = 'calendar-event-meta';
          location.textContent = 'Location: ' + event.location;
          card.appendChild(location);
        }
        if (event.notes) {
          var notes = document.createElement('div');
          notes.className = 'calendar-event-meta';
          notes.textContent = event.notes;
          card.appendChild(notes);
        }
        var actions = document.createElement('div');
        actions.className = 'calendar-event-actions';
        if (event.location) {
          var directionsBtn = document.createElement('button');
          directionsBtn.type = 'button';
          directionsBtn.className = 'calendar-btn secondary';
          directionsBtn.textContent = 'Directions';
          directionsBtn.addEventListener('click', function() {
            window.open(buildDirectionsUrl(event.location), '_blank');
          });
          actions.appendChild(directionsBtn);
        }
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'calendar-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          openEventModal(event);
        });
        actions.appendChild(editBtn);
        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'calendar-btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          var confirmRemove = window.confirm('Delete this event?');
          if (!confirmRemove) return;
          calendarEvents = calendarEvents.filter(function(item) { return item.id !== event.id; });
          saveCalendarEvents();
          renderCalendarMonth();
          renderDayModal();
          if (activePersonId === event.personId) {
            renderPersonAgenda(event.personId);
          }
        });
        actions.appendChild(deleteBtn);
        card.appendChild(actions);
        calendarDayList.appendChild(card);
      });
    }

    function openEventModal(event, targetDate, options) {
      if (!calendarEventModal) return;
      options = options || {};
      calendarLockedPersonId = options.lockPersonId || null;
      calendarEventModal.classList.toggle('person-locked', Boolean(calendarLockedPersonId));
      calendarReturnToDay = calendarDayModal && calendarDayModal.classList.contains('active');
      if (calendarReturnToDay) {
        hideCalendarModal(calendarDayModal);
      }
      calendarEditingEventId = event ? event.id : null;
      if (calendarEventTitle) {
        calendarEventTitle.textContent = event ? 'Edit event' : 'Add event';
      }
      if (calendarEventDelete) {
        calendarEventDelete.style.display = event ? 'inline-flex' : 'none';
      }
      renderCalendarPeopleOptions();
      if (calendarEventPerson) {
        if (calendarLockedPersonId) {
          calendarEventPerson.value = calendarLockedPersonId;
        } else if (event) {
          calendarEventPerson.value = event.personId || calendarEventPerson.value || '';
        } else if (!calendarEventPerson.value && calendarEventPerson.options.length) {
          calendarEventPerson.value = calendarEventPerson.options[0].value;
        }
        calendarEventPerson.disabled = Boolean(calendarLockedPersonId);
      }
      if (calendarEventTitleInput) calendarEventTitleInput.value = event ? event.title : '';
      if (calendarEventDate) {
        calendarEventDate.value = event ? event.date : (targetDate || toYmd(new Date()));
      }
      if (calendarEventAllDay) {
        calendarEventAllDay.checked = event ? !!event.allDay : false;
      }
      if (calendarEventStart) calendarEventStart.value = event ? event.startTime : '09:00';
      if (calendarEventEnd) calendarEventEnd.value = event ? (event.endTime || '') : '';
      if (calendarEventLocation) calendarEventLocation.value = event ? (event.location || '') : '';
      if (calendarEventNotes) calendarEventNotes.value = event ? (event.notes || '') : '';
      if (calendarEventRepeat) {
        calendarEventRepeat.value = event && event.recurrence ? event.recurrence.type : 'none';
      }
      updateCalendarEventTimeVisibility();
      updateCustomRepeatVisibility();
      if (calendarCustomWeekdays) {
        var checkboxes = calendarCustomWeekdays.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(function(input) {
          input.checked = false;
          if (event && event.recurrence && event.recurrence.type === 'custom_weekdays') {
            if (event.recurrence.weekdays && event.recurrence.weekdays.includes(parseInt(input.value, 10))) {
              input.checked = true;
            }
          }
        });
        updateRepeatDayButtons();
      }
      if (calendarCustomUntil) {
        calendarCustomUntil.value = event && event.recurrence ? (event.recurrence.until || '') : '';
      }
      updateCalendarPersonPreview();
      updateCalendarDirectionsButton();
      showCalendarModal(calendarEventModal);
    }

    function closeEventModal() {
      calendarEditingEventId = null;
      calendarLockedPersonId = null;
      if (calendarEventModal) {
        calendarEventModal.classList.remove('person-locked');
      }
      if (calendarEventPerson) {
        calendarEventPerson.disabled = false;
      }
      hideCalendarModal(calendarEventModal);
      if (calendarReturnToDay && calendarSelectedDate) {
        calendarReturnToDay = false;
        renderDayModal();
        showCalendarModal(calendarDayModal);
      }
    }

    function closeDayModal() {
      calendarSelectedDate = null;
      hideCalendarModal(calendarDayModal);
    }

    function closeCalendarModals() {
      calendarReturnToDay = false;
      closeEventModal();
      closeDayModal();
    }

    function handleCalendarSave(event) {
      event.preventDefault();
      if (!calendarEventPerson || !calendarEventTitleInput || !calendarEventDate || !calendarEventStart) return;
      var personId = calendarEventPerson.value;
      if (!personId) {
        alert('Please select a person.');
        return;
      }
      var title = calendarEventTitleInput.value.trim();
      if (!title) {
        alert('Please enter a title.');
        calendarEventTitleInput.focus();
        return;
      }
      var date = calendarEventDate.value;
      if (!date) {
        alert('Please select a date.');
        calendarEventDate.focus();
        return;
      }
      var isAllDay = calendarEventAllDay && calendarEventAllDay.checked;
      var startTime = isAllDay ? '00:00' : calendarEventStart.value;
      if (!isAllDay && !startTime) {
        alert('Please select a start time.');
        calendarEventStart.focus();
        return;
      }
      var recurrence = { type: calendarEventRepeat ? calendarEventRepeat.value : 'none' };
      if (recurrence.type === 'custom_weekdays') {
        var selected = [];
        if (calendarCustomWeekdays) {
          calendarCustomWeekdays.querySelectorAll('input[type="checkbox"]').forEach(function(input) {
            if (input.checked) {
              selected.push(parseInt(input.value, 10));
            }
          });
        }
        if (!selected.length) {
          var fallbackDate = parseYmd(date);
          if (fallbackDate) {
            selected.push(fallbackDate.getDay());
          }
        }
        recurrence.weekdays = selected;
        if (calendarCustomUntil && calendarCustomUntil.value) {
          recurrence.until = calendarCustomUntil.value;
        }
      }
      var payload = {
        id: calendarEditingEventId || null,
        personId: personId,
        title: title,
        date: date,
        startTime: startTime,
        endTime: isAllDay ? '' : (calendarEventEnd ? calendarEventEnd.value : ''),
        location: calendarEventLocation ? calendarEventLocation.value.trim() : '',
        notes: calendarEventNotes ? calendarEventNotes.value.trim() : '',
        allDay: isAllDay,
        recurrence: recurrence,
        updatedAt: Date.now()
      };
      if (calendarEditingEventId) {
        calendarEvents = calendarEvents.map(function(item) {
          if (item.id !== calendarEditingEventId) return item;
          return normalizeCalendarEvent(Object.assign({}, item, payload));
        });
      } else {
        payload.createdAt = Date.now();
        calendarEvents.unshift(normalizeCalendarEvent(payload));
      }
      saveCalendarEvents();
      renderCalendarMonth();
      if (calendarSelectedDate) {
        renderDayModal();
      }
      if (activePersonId === personId) {
        renderPersonAgenda(personId);
      }
      closeEventModal();
    }

    function isCalendarImportRoute() {
      return window.location.pathname === '/calendar/import' && !!document.getElementById('calendar-import-view');
    }

    function buildValidYmd(year, month, day) {
      var date = new Date(year, month - 1, day);
      if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
        return '';
      }
      return [year, padNumber(month), padNumber(day)].join('-');
    }

    function parseDateFromText(text) {
      if (!text) return '';
      var match = text.match(/(\d{4})-(\d{2})-(\d{2})/);
      if (match) {
        var ymd = buildValidYmd(parseInt(match[1], 10), parseInt(match[2], 10), parseInt(match[3], 10));
        if (ymd) return ymd;
      }
      match = text.match(/(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
      if (match) {
        var month = parseInt(match[1], 10);
        var day = parseInt(match[2], 10);
        var year = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
        if (year < 100) {
          year = 2000 + year;
        }
        var mdYmd = buildValidYmd(year, month, day);
        if (mdYmd) return mdYmd;
      }
      match = text.match(/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:,?\s*(\d{4}))?/i);
      if (match) {
        var months = {
          jan: 1, january: 1, feb: 2, february: 2, mar: 3, march: 3, apr: 4, april: 4, may: 5,
          jun: 6, june: 6, jul: 7, july: 7, aug: 8, august: 8, sep: 9, sept: 9, september: 9,
          oct: 10, october: 10, nov: 11, november: 11, dec: 12, december: 12
        };
        var key = match[1].toLowerCase();
        var monthValue = months[key];
        var dayValue = parseInt(match[2], 10);
        var yearValue = match[3] ? parseInt(match[3], 10) : new Date().getFullYear();
        var monthYmd = buildValidYmd(yearValue, monthValue, dayValue);
        if (monthYmd) return monthYmd;
      }
      return '';
    }

    function normalizeTimeValue(hour, minute, meridiem) {
      var h = parseInt(hour, 10);
      var m = minute ? parseInt(minute, 10) : 0;
      if (Number.isNaN(h) || Number.isNaN(m)) return '';
      if (meridiem) {
        var lower = meridiem.toLowerCase();
        if (lower === 'pm' && h < 12) h += 12;
        if (lower === 'am' && h === 12) h = 0;
      }
      if (h < 0 || h > 23 || m < 0 || m > 59) return '';
      return padNumber(h) + ':' + padNumber(m);
    }

    function parseTimesFromText(text) {
      if (!text) return [];
      var matches = [];
      var regex12 = /(\d{1,2})(?::(\d{2}))?\s*(am|pm)\b/gi;
      var match12;
      while ((match12 = regex12.exec(text)) !== null) {
        var time12 = normalizeTimeValue(match12[1], match12[2], match12[3]);
        if (time12) {
          matches.push({ index: match12.index, time: time12 });
        }
      }
      var regex24 = /\b([01]?\d|2[0-3]):([0-5]\d)\b/g;
      var match24;
      while ((match24 = regex24.exec(text)) !== null) {
        var time24 = normalizeTimeValue(match24[1], match24[2], null);
        if (time24) {
          matches.push({ index: match24.index, time: time24 });
        }
      }
      matches.sort(function(a, b) { return a.index - b.index; });
      var times = [];
      matches.forEach(function(item) {
        if (!times.includes(item.time)) {
          times.push(item.time);
        }
      });
      return times;
    }

    function parseLocationFromText(text) {
      if (!text) return '';
      var match = text.match(/\b(?:location|loc|address)\s*[:\-]\s*([^\n,]+)\b/i);
      if (match && match[1]) return match[1].trim();
      match = text.match(/\b(?:at|@)\s+([^,\n]+)\b/i);
      if (match && match[1]) return match[1].trim();
      return '';
    }

    function parseTitleFromText(text) {
      if (!text) return '';
      var cleaned = text.replace(/\s+/g, ' ').trim();
      var split = cleaned.split(/\b(?:at|@|on)\b/i);
      var candidate = split[0] ? split[0].trim() : '';
      candidate = candidate.replace(/\b(\d{1,2})(?::(\d{2}))?\s*(am|pm)\b/gi, '').trim();
      candidate = candidate.replace(/\b([01]?\d|2[0-3]):([0-5]\d)\b/g, '').trim();
      candidate = candidate.replace(/\b\d{4}-\d{2}-\d{2}\b/g, '').trim();
      if (candidate.length >= 3 && candidate.length <= 80) return candidate;
      return '';
    }

    function parseCalendarImportText(text) {
      var date = parseDateFromText(text);
      var times = parseTimesFromText(text);
      var location = parseLocationFromText(text);
      var title = parseTitleFromText(text);
      var hasStructured = Boolean(date || times.length || location || title);
      var startTime = times[0] || '';
      var endTime = times[1] || '';
      var allDay = !startTime;
      if (!hasStructured) {
        return {
          title: '',
          date: '',
          startTime: '',
          endTime: '',
          location: '',
          allDay: false
        };
      }
      return {
        title: title,
        date: date,
        startTime: startTime,
        endTime: endTime,
        location: location,
        allDay: allDay
      };
    }

    function renderCalendarImportPeopleOptions(selectedId) {
      if (!calendarImportPerson) return;
      var familyPeople = getFamilyPeople();
      calendarImportPerson.innerHTML = '';
      if (!familyPeople.length) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Add a family member in Life first';
        option.disabled = true;
        option.selected = true;
        calendarImportPerson.appendChild(option);
        calendarImportPerson.disabled = true;
        return;
      }
      calendarImportPerson.disabled = false;
      familyPeople.forEach(function(person) {
        var option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name + (person.role ? ' Â· ' + getPersonRoleLabel(person) : '');
        calendarImportPerson.appendChild(option);
      });
      if (selectedId && familyPeople.some(function(person) { return person.id === selectedId; })) {
        calendarImportPerson.value = selectedId;
      } else {
        calendarImportPerson.value = familyPeople[0].id;
      }
    }

    function updateCalendarImportDirections() {
      if (!calendarImportDirections || !calendarImportLocation) return;
      var location = calendarImportLocation.value.trim();
      if (!location) {
        calendarImportDirections.style.display = 'none';
        return;
      }
      calendarImportDirections.style.display = 'inline-flex';
    }

    function updateCalendarImportTimeVisibility() {
      if (!calendarImportAllDay || !calendarImportTimeRow || !calendarImportStart) return;
      var isAllDay = calendarImportAllDay.checked;
      calendarImportTimeRow.style.display = isAllDay ? 'none' : '';
      calendarImportStart.required = !isAllDay;
    }

    function resetCalendarImportForm() {
      if (!calendarImportForm) return;
      calendarImportForm.reset();
      if (calendarImportNotesDetails) {
        calendarImportNotesDetails.open = false;
      }
      if (calendarImportOriginalDetails) {
        calendarImportOriginalDetails.open = false;
      }
      updateCalendarImportTimeVisibility();
      updateCalendarImportDirections();
    }

    function populateCalendarImportForm() {
      if (!calendarImportOriginal) return;
      var params = new URLSearchParams(window.location.search);
      var rawText = params.get('text') || '';
      var personId = params.get('personId') || '';
      var decodedText = rawText.replace(/\+/g, ' ').trim();
      var parsed = parseCalendarImportText(decodedText);
      renderCalendarImportPeopleOptions(personId);
      if (calendarImportBackPerson) {
        calendarImportBackPerson.style.display = calendarImportPerson ? 'inline-flex' : 'none';
      }
      calendarImportOriginal.textContent = decodedText || 'No message text received.';
      if (calendarImportNotes) calendarImportNotes.value = decodedText;
      if (calendarImportTitle) calendarImportTitle.value = parsed.title || '';
      if (calendarImportDate) calendarImportDate.value = parsed.date || '';
      if (calendarImportStart) calendarImportStart.value = parsed.startTime || '';
      if (calendarImportEnd) calendarImportEnd.value = parsed.endTime || '';
      if (calendarImportLocation) calendarImportLocation.value = parsed.location || '';
      if (calendarImportAllDay) calendarImportAllDay.checked = parsed.allDay;
      updateCalendarImportTimeVisibility();
      updateCalendarImportDirections();
    }

    function showCalendarImportSuccess() {
      if (!calendarImportSuccess || !calendarImportForm) return;
      calendarImportForm.style.display = 'none';
      calendarImportSuccess.classList.add('active');
    }

    function showCalendarImportForm() {
      if (!calendarImportSuccess || !calendarImportForm) return;
      calendarImportSuccess.classList.remove('active');
      calendarImportForm.style.display = 'grid';
    }

    function handleCalendarImportSave(event) {
      event.preventDefault();
      if (!calendarImportPerson || !calendarImportTitle || !calendarImportDate) return;
      var personId = calendarImportPerson.value;
      if (!personId) {
        alert('Please select a person.');
        return;
      }
      var title = calendarImportTitle.value.trim();
      if (!title) {
        alert('Please enter a title.');
        calendarImportTitle.focus();
        return;
      }
      var date = calendarImportDate.value;
      if (!date) {
        alert('Please select a date.');
        calendarImportDate.focus();
        return;
      }
      var isAllDay = calendarImportAllDay && calendarImportAllDay.checked;
      var startTime = isAllDay ? '00:00' : (calendarImportStart ? calendarImportStart.value : '');
      if (!isAllDay && !startTime) {
        alert('Please select a start time.');
        calendarImportStart.focus();
        return;
      }
      var payload = {
        personId: personId,
        title: title,
        date: date,
        startTime: startTime,
        endTime: isAllDay ? '' : (calendarImportEnd ? calendarImportEnd.value : ''),
        location: calendarImportLocation ? calendarImportLocation.value.trim() : '',
        notes: calendarImportNotes ? calendarImportNotes.value.trim() : '',
        allDay: isAllDay,
        recurrence: { type: 'none' },
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      calendarEvents.unshift(normalizeCalendarEvent(payload));
      saveCalendarEvents();
      renderCalendarMonth();
      if (activePersonId === personId) {
        renderPersonAgenda(personId);
      }
      showCalendarImportSuccess();
    }

    // GOALS VIEW DATA
    var GOALS_SHORT_KEY = 'friction_goals_short_v1';
    var GOALS_LONG_KEY = 'friction_goals_long_v1';
    var goalsShort = [];
    var goalsLong = [];
    var editingLongGoalId = null;
    var goalsAreaFilterValue = 'all';

    function loadGoalsViewShort() {
      var saved = localStorage.getItem(GOALS_SHORT_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        var updated = parsed.map(function(goal) {
          if (!goal || typeof goal !== 'object') return null;
          var areaId = goal.areaId || getDefaultAreaId();
          return {
            id: goal.id || generateGoalId('short'),
            text: goal.text || '',
            done: typeof goal.done === 'boolean' ? goal.done : !!goal.completed,
            areaId: areaId,
            ownerName: goal.ownerName || getAreaOwnerName(areaId) || null,
            personId: goal.personId || null,
            createdAt: goal.createdAt || Date.now(),
            completedAt: goal.completedAt || null
          };
        }).filter(Boolean);
        return updated;
      } catch (e) {
        return [];
      }
    }

    function loadGoalsViewLong() {
      var saved = localStorage.getItem(GOALS_LONG_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(function(goal) {
          if (!goal || typeof goal !== 'object') return null;
          var areaId = goal.areaId || getDefaultAreaId();
          return {
            id: goal.id || generateGoalId('long'),
            title: goal.title || '',
            note: goal.note || '',
            targetDate: goal.targetDate || null,
            areaId: areaId,
            ownerName: goal.ownerName || getAreaOwnerName(areaId) || null,
            personId: goal.personId || null,
            createdAt: goal.createdAt || Date.now(),
            updatedAt: goal.updatedAt || goal.createdAt || Date.now()
          };
        }).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    function saveGoalsViewShort() {
      localStorage.setItem(GOALS_SHORT_KEY, JSON.stringify(goalsShort));
    }

    function saveGoalsViewLong() {
      localStorage.setItem(GOALS_LONG_KEY, JSON.stringify(goalsLong));
    }

    function generateGoalId(prefix) {
      return prefix + '_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function shouldIncludeGoalForArea(areaId, filterValue) {
      if (!filterValue || filterValue === 'all') return true;
      return areaId === filterValue;
    }

    function renderShortGoals() {
      if (!shortGoalList) return;
      shortGoalList.innerHTML = '';
      var filtered = goalsShort.filter(function(goal) {
        return shouldIncludeGoalForArea(goal.areaId, goalsAreaFilterValue);
      });
      if (filtered.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'goals-meta';
        empty.textContent = goalsShort.length === 0
          ? 'No short-term goals yet.'
          : 'No short-term goals in this area.';
        shortGoalList.appendChild(empty);
        return;
      }
      filtered.forEach(function(goal) {
        var item = document.createElement('div');
        item.className = 'goals-item' + (goal.done ? ' completed' : '');

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!goal.done;
        checkbox.addEventListener('change', function() {
          goal.done = this.checked;
          goal.completedAt = this.checked ? Date.now() : null;
          item.classList.toggle('completed', this.checked);
          saveGoalsViewShort();
          renderLifeToday();
        });

        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'goals-item-input';
        input.value = goal.text || '';
        input.readOnly = true;
        input.addEventListener('keydown', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            editBtn.click();
          }
        });

        var actions = document.createElement('div');
        actions.className = 'goals-item-actions';

        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'goals-btn goals-btn-secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          if (input.readOnly) {
            input.readOnly = false;
            input.focus();
            editBtn.textContent = 'Save';
            return;
          }
          var nextText = input.value.trim();
          if (!nextText) {
            input.value = goal.text || '';
          } else {
            goal.text = nextText;
            saveGoalsViewShort();
          }
          input.readOnly = true;
          editBtn.textContent = 'Edit';
        });

        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'goals-btn goals-btn-secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          goalsShort = goalsShort.filter(function(item) { return item.id !== goal.id; });
          saveGoalsViewShort();
          renderShortGoals();
          renderLifeToday();
        });

        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        var meta = document.createElement('div');
        meta.className = 'goals-meta';
        var areaPill = document.createElement('span');
        areaPill.className = 'goals-area-pill';
        areaPill.textContent = getAreaLabel(goal.areaId);
        meta.appendChild(areaPill);

        item.appendChild(checkbox);
        item.appendChild(input);
        item.appendChild(meta);
        item.appendChild(actions);
        shortGoalList.appendChild(item);
      });
    }

    function renderLongGoals() {
      if (!longGoalList) return;
      longGoalList.innerHTML = '';
      var filtered = goalsLong.filter(function(goal) {
        return shouldIncludeGoalForArea(goal.areaId, goalsAreaFilterValue);
      });
      if (filtered.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'goals-meta';
        empty.textContent = goalsLong.length === 0
          ? 'No long-term goals yet.'
          : 'No long-term goals in this area.';
        longGoalList.appendChild(empty);
        return;
      }
      filtered.forEach(function(goal) {
        var item = document.createElement('div');
        item.className = 'goals-item';

        var content = document.createElement('div');
        content.className = 'goals-item-content';

        var title = document.createElement('div');
        title.textContent = goal.title || 'Untitled goal';

        var note = document.createElement('div');
        note.className = 'goals-meta';
        note.textContent = goal.note ? goal.note : '';

        var areaMeta = document.createElement('div');
        areaMeta.className = 'goals-meta';
        var areaPill = document.createElement('span');
        areaPill.className = 'goals-area-pill';
        areaPill.textContent = getAreaLabel(goal.areaId);
        areaMeta.appendChild(areaPill);

        var meta = document.createElement('div');
        meta.className = 'goals-meta';
        meta.textContent = goal.targetDate ? 'Target date: ' + goal.targetDate : '';

        content.appendChild(title);
        if (goal.note) content.appendChild(note);
        content.appendChild(areaMeta);
        if (goal.targetDate) content.appendChild(meta);

        var actions = document.createElement('div');
        actions.className = 'goals-item-actions';

        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'goals-btn goals-btn-secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          editingLongGoalId = goal.id;
          longGoalTitle.value = goal.title || '';
          longGoalNote.value = goal.note || '';
          longGoalDate.value = goal.targetDate || '';
          if (longGoalArea) {
            longGoalArea.value = goal.areaId || getDefaultAreaId();
          }
          longGoalAdd.textContent = 'Save';
          longGoalCancel.style.display = 'inline-flex';
          if (activeView !== 'goals') {
            setActiveView('goals', true);
          }
          longGoalTitle.focus();
        });

        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'goals-btn goals-btn-secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          goalsLong = goalsLong.filter(function(item) { return item.id !== goal.id; });
          saveGoalsViewLong();
          renderLongGoals();
          renderGoalsNudge();
          renderLifeGoals();
        });

        var breakBtn = document.createElement('button');
        breakBtn.type = 'button';
        breakBtn.className = 'goals-btn goals-btn-secondary';
        breakBtn.textContent = 'Break into steps';
        breakBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'goal',
            mode: 'break',
            item: goal
          });
        });

        var helpBtn = document.createElement('button');
        helpBtn.type = 'button';
        helpBtn.className = 'goals-btn goals-btn-secondary';
        helpBtn.textContent = 'Help me start';
        helpBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'goal',
            mode: 'start',
            item: goal
          });
        });

        actions.appendChild(editBtn);
        actions.appendChild(breakBtn);
        actions.appendChild(helpBtn);
        actions.appendChild(deleteBtn);

        item.appendChild(content);
        item.appendChild(actions);
        longGoalList.appendChild(item);
      });
      renderGoalsNudge();
    }

    function resetLongGoalForm() {
      editingLongGoalId = null;
      longGoalTitle.value = '';
      longGoalNote.value = '';
      longGoalDate.value = '';
      if (longGoalArea) {
        longGoalArea.value = getDefaultAreaId();
      }
      longGoalAdd.textContent = 'Add';
      longGoalCancel.style.display = 'none';
    }

    // LIFE TASKS + APPOINTMENTS
    var TASKS_KEY = 'friction_tasks_v1';
    var APPOINTMENTS_KEY = 'friction_appointments_v1';
    var tasks = [];
    var appointments = [];
    var appointmentModalContexts = {};
    var editingTaskId = null;
    var appointmentEditingId = null;
    var editingApptId = null;
    var appointmentModalLockPersonId = null;
    var appointmentModalSource = 'life';
    var appointmentsFilterPersonId = 'all';
    var lifeAppointmentsPastExpanded = false;
    var appointmentsPastExpanded = false;
    var lifeAreaFilterValue = 'all';
    var lifeActiveTab = 'people';
    var personTaskEditingId = null;
    var personTasksCompletedExpanded = false;
    var personTaskErrors = {};
    var personTaskLoading = {};

    var TASK_BARRIERS = [
      'dont_know_start',
      'too_big',
      'not_sure_good_enough',
      'low_energy',
      'fear_wrong',
      'missing_info',
      'distraction'
    ];
    var TASK_BARRIER_LABELS = {
      dont_know_start: 'Donâ€™t know start',
      too_big: 'Too big',
      not_sure_good_enough: 'Not sure enough',
      low_energy: 'Low energy',
      fear_wrong: 'Fear of wrong',
      missing_info: 'Missing info',
      distraction: 'Distraction'
    };

    function loadTasks() {
      var saved = localStorage.getItem(TASKS_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(normalizeTask).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    function normalizeTaskSteps(steps) {
      if (!Array.isArray(steps)) return [];
      return steps.map(function(step) {
        if (!step) return null;
        var text = typeof step === 'string' ? step : (step.text || '');
        if (!text) return null;
        return {
          id: step.id || generateGoalId('step'),
          text: text,
          done: !!step.done
        };
      }).filter(Boolean);
    }

    function normalizeTask(task) {
      if (!task || typeof task !== 'object') return null;
      var isLegacyText = typeof task.text === 'string' && task.text.trim().length > 0;
      var areaId = task.areaId || getDefaultAreaId();
      var scope = task.scope || (isLegacyText ? 'life' : 'person');
      var title = (task.title || task.text || '').trim();
      var status = task.status === 'done' || task.done ? 'done' : 'open';
      var barrier = TASK_BARRIERS.indexOf(task.barrier) >= 0 ? task.barrier : '';
      var createdAt = task.createdAt || Date.now();
      var steps = normalizeTaskSteps(task.steps);
      if (steps.length === 0 && task.aiPlan && Array.isArray(task.aiPlan.steps)) {
        steps = normalizeTaskSteps(task.aiPlan.steps.map(function(step) {
          return { text: step };
        }));
      }
      var ui = task.ui && typeof task.ui === 'object' ? task.ui : {};
      return {
        id: task.id || generateGoalId('task'),
        title: title,
        text: task.text || title,
        notes: task.notes || task.note || '',
        barrier: barrier,
        personId: task.personId || 'me',
        status: status,
        aiPlan: normalizeTaskPlan(task.aiPlan),
        createdAt: createdAt,
        updatedAt: task.updatedAt || createdAt,
        scope: scope,
        areaId: areaId,
        ownerName: task.ownerName || getAreaOwnerName(areaId) || null,
        tags: Array.isArray(task.tags) ? task.tags : (task.tags ? String(task.tags).split(',').map(function(t) { return t.trim(); }).filter(Boolean) : []),
        needsOtherPeople: !!task.needsOtherPeople,
        needsAppointment: !!task.needsAppointment,
        energyType: task.energyType || '',
        done: status === 'done',
        dueDate: task.dueDate || null,
        steps: steps,
        ui: {
          collapsed: !!ui.collapsed,
          hideCompleted: !!ui.hideCompleted,
          clarification: ui.clarification || null
        }
      };
    }

    function normalizeTaskPlan(plan) {
      if (!plan || typeof plan !== 'object') return null;
      var steps = Array.isArray(plan.steps) ? plan.steps.filter(Boolean) : [];
      var ifStuck = Array.isArray(plan.if_stuck) ? plan.if_stuck.filter(Boolean) : [];
      if (!plan.summary || !plan.first_step_2min || steps.length < 1) return null;
      return {
        generatedAt: plan.generatedAt || Date.now(),
        summary: plan.summary,
        first_step_2min: plan.first_step_2min,
        steps: steps,
        if_stuck: ifStuck,
        timebox_minutes: plan.timebox_minutes
      };
    }

    function generateAppointmentId() {
      return 'appt_' + Date.now().toString(36) + '_' + Math.floor(Math.random() * 100000).toString(36);
    }

    function formatTimeValue(date) {
      if (!(date instanceof Date)) return '';
      return padNumber(date.getHours()) + ':' + padNumber(date.getMinutes());
    }

    function normalizeAppointment(appt) {
      if (!appt || typeof appt !== 'object') return null;
      var date = appt.date || '';
      var time = appt.time || '';
      var legacyStart = appt.dateTimeStart || '';
      if ((!date || !time) && legacyStart) {
        var legacyDate = new Date(legacyStart);
        if (!Number.isNaN(legacyDate.getTime())) {
          date = date || toYmd(legacyDate);
          time = time || formatTimeValue(legacyDate);
        }
      }
      if ((!date || !time) && appt.date && appt.startTime) {
        date = date || appt.date;
        time = time || appt.startTime;
      }
      return {
        id: appt.id || generateAppointmentId(),
        personId: appt.personId || 'me',
        title: appt.title || 'Untitled appointment',
        date: date || '',
        time: time || '',
        clinicName: appt.clinicName || appt.clinic || '',
        doctorName: appt.doctorName || appt.doctor || '',
        address: appt.address || appt.location || '',
        phone: appt.phone || '',
        notes: appt.notes || '',
        createdAt: appt.createdAt || Date.now(),
        updatedAt: appt.updatedAt || appt.createdAt || Date.now()
      };
    }

    function loadAppointments() {
      var saved = localStorage.getItem(APPOINTMENTS_KEY);
      if (!saved) return [];
      try {
        var parsed = JSON.parse(saved);
        if (!Array.isArray(parsed)) return [];
        return parsed.map(normalizeAppointment).filter(Boolean);
      } catch (e) {
        return [];
      }
    }

    function saveTasks() {
      localStorage.setItem(TASKS_KEY, JSON.stringify(tasks));
    }

    function saveAppointments() {
      localStorage.setItem(APPOINTMENTS_KEY, JSON.stringify(appointments));
    }

    function getDefaultPersonId() {
      var mePerson = people.find(function(person) { return person && (person.id === 'me' || person.type === 'me'); });
      if (mePerson) return mePerson.id;
      return people.length ? people[0].id : 'me';
    }

    function getAppointmentDateTime(appt) {
      if (!appt || !appt.date || !appt.time) return null;
      var dateTime = new Date(appt.date + 'T' + appt.time);
      if (Number.isNaN(dateTime.getTime())) return null;
      return dateTime;
    }

    function getAppointmentTimestamp(appt) {
      var dateTime = getAppointmentDateTime(appt);
      return dateTime ? dateTime.getTime() : null;
    }

    function formatAppointmentDateTime(appt) {
      var dateTime = getAppointmentDateTime(appt);
      if (!dateTime) return '';
      return dateTime.toLocaleString(undefined, { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    function buildAppleMapsUrl(address) {
      if (!address) return '';
      return 'https://maps.apple.com/?q=' + encodeURIComponent(address);
    }

    function splitAppointmentsByTime(list) {
      var now = Date.now();
      var upcoming = [];
      var past = [];
      list.forEach(function(appt) {
        var timestamp = getAppointmentTimestamp(appt);
        if (timestamp === null) return;
        if (timestamp >= now) {
          upcoming.push(appt);
        } else {
          past.push(appt);
        }
      });
      upcoming.sort(function(a, b) {
        return getAppointmentTimestamp(a) - getAppointmentTimestamp(b);
      });
      past.sort(function(a, b) {
        return getAppointmentTimestamp(b) - getAppointmentTimestamp(a);
      });
      return { upcoming: upcoming, past: past };
    }

    function getPersonDisplayName(personId) {
      var person = getPersonById(personId);
      if (person) return person.name || 'Unknown';
      if (personId === 'me') return 'Me';
      return 'Unknown';
    }

    function renderAppointmentCard(appt, options) {
      var card = document.createElement('div');
      card.className = 'appointment-card';
      var headerBtn = document.createElement('button');
      headerBtn.type = 'button';
      headerBtn.className = 'appointment-header';
      headerBtn.setAttribute('aria-expanded', 'false');
      var headerContent = document.createElement('div');
      headerContent.className = 'appointment-header-content';
      var title = document.createElement('div');
      title.className = 'appointment-title';
      title.textContent = appt.title || 'Untitled appointment';
      var meta = document.createElement('div');
      meta.className = 'appointment-meta';
      var metaParts = [formatAppointmentDateTime(appt)];
      if (appt.clinicName) metaParts.push(appt.clinicName);
      if (options && options.showPerson) {
        metaParts.push(getPersonDisplayName(appt.personId));
      }
      meta.textContent = metaParts.filter(Boolean).join(' Â· ');
      headerContent.appendChild(title);
      if (meta.textContent) headerContent.appendChild(meta);
      var chevron = document.createElement('span');
      chevron.className = 'appointment-chevron';
      chevron.textContent = 'â–¾';
      headerBtn.appendChild(headerContent);
      headerBtn.appendChild(chevron);
      card.appendChild(headerBtn);

      var body = document.createElement('div');
      body.className = 'appointment-body';
      var detailFields = [
        { label: 'Doctor', value: appt.doctorName },
        { label: 'Address', value: appt.address },
        { label: 'Phone', value: appt.phone },
        { label: 'Notes', value: appt.notes }
      ];
      detailFields.forEach(function(field) {
        if (!field.value) return;
        var detail = document.createElement('div');
        detail.className = 'appointment-detail';
        var label = document.createElement('span');
        label.textContent = field.label;
        var value = document.createElement('div');
        value.textContent = field.value;
        detail.appendChild(label);
        detail.appendChild(value);
        body.appendChild(detail);
      });

      var actions = document.createElement('div');
      actions.className = 'appointment-actions';
      if (appt.address) {
        var directions = document.createElement('a');
        directions.className = 'appointment-action';
        directions.href = buildAppleMapsUrl(appt.address);
        directions.target = '_blank';
        directions.rel = 'noopener';
        directions.textContent = 'Directions';
        actions.appendChild(directions);
      }
      if (appt.phone) {
        var call = document.createElement('a');
        call.className = 'appointment-action';
        call.href = 'tel:' + appt.phone;
        call.textContent = 'Call';
        actions.appendChild(call);
      }
      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'appointment-action';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', function(event) {
        event.stopPropagation();
        if (options && typeof options.onEdit === 'function') {
          options.onEdit(appt);
        }
      });
      actions.appendChild(editBtn);

      var deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'appointment-action';
      deleteBtn.textContent = 'Delete';
      deleteBtn.addEventListener('click', function(event) {
        event.stopPropagation();
        if (options && typeof options.onDelete === 'function') {
          options.onDelete(appt);
        }
      });
      actions.appendChild(deleteBtn);

      if (actions.children.length) {
        body.appendChild(actions);
      }
      card.appendChild(body);

      headerBtn.addEventListener('click', function() {
        var isExpanded = card.classList.contains('expanded');
        card.classList.toggle('expanded', !isExpanded);
        headerBtn.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
      });

      return card;
    }

    function renderGoalsNudge() {
      if (!goalsNudge) return;
      var cutoff = Date.now() - (14 * 24 * 60 * 60 * 1000);
      var stale = goalsLong.filter(function(goal) {
        return !goal.completedAt && goal.createdAt && goal.createdAt <= cutoff;
      });
      if (stale.length > 0) {
        goalsNudge.style.display = 'flex';
        goalsNudge.dataset.goalId = stale[0].id;
      } else {
        goalsNudge.style.display = 'none';
        goalsNudge.dataset.goalId = '';
      }
    }

    function formatTaskMeta(task) {
      var parts = [];
      if (task.dueDate) parts.push('Due ' + task.dueDate);
      if (task.tags && task.tags.length) parts.push('Tags: ' + task.tags.join(', '));
      if (task.energyType) parts.push('Energy: ' + task.energyType);
      if (task.needsOtherPeople) parts.push('Needs people');
      if (task.needsAppointment) parts.push('Needs appt');
      return parts.join(' â€¢ ');
    }

    function getLifeFiltered(items) {
      return (items || []).filter(function(item) {
        return shouldIncludeGoalForArea(item.areaId, lifeAreaFilterValue);
      });
    }

    function getLifeTasksList() {
      return (tasks || []).filter(function(task) {
        return task.scope !== 'person';
      });
    }

    function renderLifeToday() {
      if (!lifeTodayList) return;
      lifeTodayList.innerHTML = '';
      var actionableGoals = getLifeFiltered(goalsShort).filter(function(goal) { return !goal.done; });
      var actionableTasks = getLifeFiltered(getLifeTasksList()).filter(function(task) { return !task.done; });
      var combined = actionableGoals.map(function(goal) {
        return { type: 'goal', text: goal.text, areaId: goal.areaId };
      }).concat(actionableTasks.map(function(task) {
        return { type: 'task', text: task.text, areaId: task.areaId };
      }));
      var topFive = combined.slice(0, 5);
      if (topFive.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No actionable items yet.';
        lifeTodayList.appendChild(empty);
        return;
      }
      topFive.forEach(function(item) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = item.text;
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(item.areaId);
        meta.appendChild(pill);
        meta.appendChild(document.createTextNode(' Â· ' + (item.type === 'goal' ? 'Short-term goal' : 'Task')));
        row.appendChild(title);
        row.appendChild(meta);
        lifeTodayList.appendChild(row);
      });
    }

    function renderLifeGoals() {
      if (!lifeGoalsList) return;
      lifeGoalsList.innerHTML = '';
      var filteredLong = getLifeFiltered(goalsLong);
      if (filteredLong.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No long-term goals in this area.';
        lifeGoalsList.appendChild(empty);
        return;
      }
      filteredLong.forEach(function(goal) {
        var card = document.createElement('div');
        card.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = goal.title || 'Untitled goal';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(goal.areaId);
        meta.appendChild(pill);
        if (goal.targetDate) {
          meta.appendChild(document.createTextNode(' Â· Target ' + goal.targetDate));
        }
        card.appendChild(title);
        card.appendChild(meta);
        if (goal.note) {
          var note = document.createElement('div');
          note.className = 'life-meta';
          note.textContent = goal.note;
          card.appendChild(note);
        }
        var linked = goalsShort.filter(function(shortGoal) {
          return shortGoal.areaId === goal.areaId;
        });
        if (linked.length) {
          var linkedWrap = document.createElement('div');
          linkedWrap.className = 'life-meta';
          linkedWrap.textContent = 'Linked short-term: ' + linked.map(function(item) { return item.text; }).join(', ');
          card.appendChild(linkedWrap);
        }
        lifeGoalsList.appendChild(card);
      });
    }

    function renderLifeTasks() {
      if (!lifeTaskList) return;
      lifeTaskList.innerHTML = '';
      var filteredTasks = getLifeFiltered(getLifeTasksList());
      if (filteredTasks.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = getLifeTasksList().length === 0 ? 'No tasks yet.' : 'No tasks in this area.';
        lifeTaskList.appendChild(empty);
        return;
      }
      filteredTasks.forEach(function(task) {
        var item = document.createElement('div');
        item.className = 'life-item' + (task.done ? ' completed' : '');

        var header = document.createElement('div');
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!task.done;
        checkbox.addEventListener('change', function() {
          task.done = this.checked;
          task.status = task.done ? 'done' : 'open';
          task.updatedAt = Date.now();
          saveTasks();
          renderLifeTasks();
          renderLifeToday();
        });
        var text = document.createElement('span');
        text.textContent = task.text || '';
        header.appendChild(checkbox);
        header.appendChild(text);

        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = formatTaskMeta(task);
        var areaMeta = document.createElement('div');
        areaMeta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(task.areaId);
        areaMeta.appendChild(pill);

        var actions = document.createElement('div');
        actions.className = 'life-item-actions';
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'life-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          editingTaskId = task.id;
          lifeTaskText.value = task.text || '';
          lifeTaskArea.value = task.areaId || getDefaultAreaId();
          lifeTaskTags.value = (task.tags || []).join(', ');
          lifeTaskDue.value = task.dueDate || '';
          lifeTaskNeedsPeople.checked = !!task.needsOtherPeople;
          lifeTaskNeedsAppt.checked = !!task.needsAppointment;
          lifeTaskEnergy.value = task.energyType || '';
          lifeTaskAdd.textContent = 'Save task';
          lifeTaskCancel.style.display = 'inline-flex';
          if (activeView !== 'life') {
            setActiveView('life', true);
          }
          lifeTaskText.focus();
        });

        var breakBtn = document.createElement('button');
        breakBtn.type = 'button';
        breakBtn.className = 'life-btn secondary';
        breakBtn.textContent = 'Break into steps';
        breakBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'task',
            mode: 'break',
            item: task
          });
        });

        var helpBtn = document.createElement('button');
        helpBtn.type = 'button';
        helpBtn.className = 'life-btn secondary';
        helpBtn.textContent = 'Help me start';
        helpBtn.addEventListener('click', function() {
          openUnstuckPanel({
            source: 'task',
            mode: 'start',
            item: task
          });
        });

        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'life-btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          tasks = tasks.filter(function(item) { return item.id !== task.id; });
          saveTasks();
          renderLifeTasks();
          renderLifeToday();
          renderLinkedTaskOptions();
        });

        actions.appendChild(editBtn);
        actions.appendChild(breakBtn);
        actions.appendChild(helpBtn);
        actions.appendChild(deleteBtn);

        item.appendChild(header);
        if (meta.textContent) item.appendChild(meta);
        item.appendChild(areaMeta);
        item.appendChild(actions);
        lifeTaskList.appendChild(item);
      });
    }

    function clampText(value, maxLength) {
      if (!value) return '';
      var trimmed = String(value).trim();
      if (trimmed.length <= maxLength) return trimmed;
      return trimmed.slice(0, maxLength).trim();
    }

    function buildFallbackTaskSteps() {
      return [
        'Open the workspace or files you need.',
        'List the key materials to gather.',
        'Define the immediate goal for this task.',
        'Complete the smallest first action.'
      ];
    }

    function sanitizeTaskBreakdown(raw) {
      if (!raw || typeof raw !== 'object') return null;
      if (raw.clarification && typeof raw.clarification === 'object') {
        var question = clampText(raw.clarification.question, 140);
        var options = Array.isArray(raw.clarification.options) ? raw.clarification.options : [];
        var cleanedOptions = options.map(function(option) {
          return clampText(option, 60);
        }).filter(Boolean).slice(0, 4);
        if (question && cleanedOptions.length >= 2) {
          return { clarification: { question: question, options: cleanedOptions } };
        }
      }
      var steps = Array.isArray(raw.steps) ? raw.steps : [];
      var cleanedSteps = steps.map(function(step) {
        if (typeof step === 'string') return clampText(step, 120);
        if (step && typeof step.text === 'string') return clampText(step.text, 120);
        return '';
      }).filter(Boolean);
      if (cleanedSteps.length < 1) return null;
      if (cleanedSteps.length > 10) cleanedSteps = cleanedSteps.slice(0, 10);
      return { steps: cleanedSteps };
    }

    function getBarrierLabel(value) {
      return TASK_BARRIER_LABELS[value] || '';
    }

    function getPersonTasks(personId) {
      return (tasks || []).filter(function(task) {
        return task.scope === 'person' && task.personId === personId;
      });
    }

    function buildTaskPrompt(task, person, clarificationAnswer) {
      var personName = person && person.name ? person.name : '';
      var role = person && getPersonRoleLabel(person) ? getPersonRoleLabel(person) : '';
      return [
        'Output JSON only. No markdown. No extra text.',
        'Schema:',
        '{"clarification":{"question":"string","options":["string"]}} OR {"steps":["string <=120 chars"]}',
        'Rules:',
        '- If a task contains ambiguous terms (example: pad, charge, bank, box, pick up, drop off), ask ONE short clarification multiple-choice question before generating steps. Do not generate the checklist until clarified. If context already makes meaning clear, proceed without asking.',
        '- Return concise checklist steps only. Max 8â€“10 steps. Each step short and actionable.',
        '- No motivational speech or extra commentary.',
        'Task:',
        'Title: ' + (task.title || ''),
        'Notes: ' + (task.notes || ''),
        'Barrier: ' + (getBarrierLabel(task.barrier) || ''),
        'Person: ' + (personName || ''),
        'Role: ' + (role || ''),
        clarificationAnswer ? ('Clarification answer: ' + clarificationAnswer) : ''
      ].join('\n');
    }

    async function requestTaskPlan(task, clarificationAnswer) {
      var response = await callUnstuckAssistant(buildTaskPrompt(task, getPersonById(task.personId), clarificationAnswer));
      var parsed = JSON.parse(stripJsonFences(response));
      return sanitizeTaskBreakdown(parsed);
    }

    function renderPersonTasks(personId) {
      if (!lifeTasksList || !lifeTasksCompleted || !lifeTasksCompletedToggle || !personId) return;
      lifeTasksList.innerHTML = '';
      lifeTasksCompleted.innerHTML = '';

      var personTasks = getPersonTasks(personId);
      var openTasks = personTasks.filter(function(task) { return task.status !== 'done'; });
      var doneTasks = personTasks.filter(function(task) { return task.status === 'done'; });
      openTasks.sort(function(a, b) { return b.createdAt - a.createdAt; });
      doneTasks.sort(function(a, b) { return b.updatedAt - a.updatedAt; });

      if (openTasks.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = 'No open tasks yet.';
        lifeTasksList.appendChild(empty);
      } else {
        openTasks.forEach(function(task) {
          lifeTasksList.appendChild(buildPersonTaskCard(task));
        });
      }

      if (doneTasks.length === 0) {
        lifeTasksCompletedToggle.style.display = 'none';
        lifeTasksCompleted.style.display = 'none';
      } else {
        lifeTasksCompletedToggle.style.display = '';
        lifeTasksCompletedToggle.textContent = personTasksCompletedExpanded ? 'Hide completed' : 'Completed (' + doneTasks.length + ')';
        lifeTasksCompletedToggle.setAttribute('aria-expanded', personTasksCompletedExpanded ? 'true' : 'false');
        if (personTasksCompletedExpanded) {
          lifeTasksCompleted.style.display = '';
          doneTasks.forEach(function(task) {
            lifeTasksCompleted.appendChild(buildPersonTaskCard(task));
          });
        } else {
          lifeTasksCompleted.style.display = 'none';
        }
      }
    }

    function buildPersonTaskCard(task) {
      var card = document.createElement('div');
      var isCollapsed = task.ui && task.ui.collapsed;
      card.className = 'life-task-card' + (isCollapsed ? '' : ' expanded');

      function toggleCollapse() {
        if (!task.ui) task.ui = { collapsed: false, hideCompleted: false };
        task.ui.collapsed = !task.ui.collapsed;
        saveTasks();
        renderPersonTasks(activePersonId);
      }

      var header = document.createElement('div');
      header.className = 'life-task-header';

      var headerTop = document.createElement('div');
      headerTop.className = 'life-task-header-top';

      var titleBtn = document.createElement('button');
      titleBtn.type = 'button';
      titleBtn.className = 'life-task-title';
      titleBtn.textContent = task.title || 'Untitled task';
      titleBtn.addEventListener('click', function() {
        toggleCollapse();
      });
      headerTop.appendChild(titleBtn);

      if (task.barrier) {
        var chip = document.createElement('span');
        chip.className = 'life-task-chip';
        chip.textContent = getBarrierLabel(task.barrier);
        headerTop.appendChild(chip);
      }

      var progress = document.createElement('div');
      progress.className = 'life-task-progress';
      var totalSteps = Array.isArray(task.steps) ? task.steps.length : 0;
      var doneSteps = Array.isArray(task.steps) ? task.steps.filter(function(step) { return step.done; }).length : 0;
      progress.textContent = doneSteps + ' / ' + totalSteps + ' done';
      headerTop.appendChild(progress);

      var chevron = document.createElement('button');
      chevron.type = 'button';
      chevron.className = 'life-task-icon life-task-chevron';
      chevron.textContent = 'â–¾';
      chevron.setAttribute('aria-label', 'Toggle task details');
      chevron.addEventListener('click', function(event) {
        event.stopPropagation();
        toggleCollapse();
      });
      headerTop.appendChild(chevron);

      header.appendChild(headerTop);

      var actions = document.createElement('div');
      actions.className = 'life-task-actions';

      var helpBtn = document.createElement('button');
      helpBtn.type = 'button';
      helpBtn.className = 'life-btn secondary';
      helpBtn.textContent = personTaskLoading[task.id] ? 'Working...' : 'AI breakdown';
      helpBtn.disabled = !!personTaskLoading[task.id];
      helpBtn.addEventListener('click', function() {
        generateTaskPlan(task);
      });

      var doneBtn = document.createElement('button');
      doneBtn.type = 'button';
      doneBtn.className = 'life-btn' + (task.status === 'done' ? ' secondary' : '');
      doneBtn.textContent = task.status === 'done' ? 'Reopen' : 'Done';
      doneBtn.addEventListener('click', function() {
        task.status = task.status === 'done' ? 'open' : 'done';
        task.done = task.status === 'done';
        task.updatedAt = Date.now();
        saveTasks();
        renderPersonTasks(activePersonId);
        renderLifeTasks();
        renderLifeToday();
      });

      var editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'life-task-icon';
      editBtn.textContent = 'âœŽ';
      editBtn.setAttribute('aria-label', 'Edit task');
      editBtn.addEventListener('click', function() {
        openPersonTaskForm(task);
      });

      actions.appendChild(helpBtn);
      actions.appendChild(doneBtn);
      actions.appendChild(editBtn);
      header.appendChild(actions);
      card.appendChild(header);

      header.addEventListener('click', function(event) {
        if (event.target.closest('button') || event.target.closest('input')) return;
        toggleCollapse();
      });

      [helpBtn, doneBtn, editBtn].forEach(function(button) {
        button.addEventListener('click', function(event) {
          event.stopPropagation();
        });
      });

      var body = document.createElement('div');
      body.className = 'life-task-body';

      if (task.notes) {
        var notes = document.createElement('div');
        notes.className = 'life-task-notes';
        notes.textContent = task.notes;
        body.appendChild(notes);
      }

      if (task.ui && task.ui.clarification) {
        var clarification = document.createElement('div');
        clarification.className = 'life-task-clarification';
        var question = document.createElement('div');
        question.textContent = task.ui.clarification.question;
        clarification.appendChild(question);
        task.ui.clarification.options.forEach(function(option) {
          var optionBtn = document.createElement('button');
          optionBtn.type = 'button';
          optionBtn.className = 'life-btn secondary';
          optionBtn.textContent = option;
          optionBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            task.ui.clarification = null;
            saveTasks();
            generateTaskPlan(task, true, option);
          });
          clarification.appendChild(optionBtn);
        });
        body.appendChild(clarification);
      }

      if (personTaskErrors[task.id]) {
        var status = document.createElement('div');
        status.className = 'life-task-status';
        status.textContent = personTaskErrors[task.id];
        body.appendChild(status);
      }

      var controls = document.createElement('div');
      controls.className = 'life-task-controls';

      var toggleCompleted = document.createElement('button');
      toggleCompleted.type = 'button';
      toggleCompleted.className = 'life-btn secondary';
      toggleCompleted.textContent = task.ui && task.ui.hideCompleted ? 'Show completed' : 'Hide completed';
      toggleCompleted.addEventListener('click', function(event) {
        event.stopPropagation();
        if (!task.ui) task.ui = { collapsed: false, hideCompleted: false };
        task.ui.hideCompleted = !task.ui.hideCompleted;
        saveTasks();
        renderPersonTasks(activePersonId);
      });
      controls.appendChild(toggleCompleted);

      var markAllDone = document.createElement('button');
      markAllDone.type = 'button';
      markAllDone.className = 'life-btn secondary';
      markAllDone.textContent = 'Mark all done';
      markAllDone.addEventListener('click', function(event) {
        event.stopPropagation();
        (task.steps || []).forEach(function(step) { step.done = true; });
        saveTasks();
        renderPersonTasks(activePersonId);
      });
      controls.appendChild(markAllDone);

      var resetSteps = document.createElement('button');
      resetSteps.type = 'button';
      resetSteps.className = 'life-btn secondary';
      resetSteps.textContent = 'Reset';
      resetSteps.addEventListener('click', function(event) {
        event.stopPropagation();
        (task.steps || []).forEach(function(step) { step.done = false; });
        saveTasks();
        renderPersonTasks(activePersonId);
      });
      controls.appendChild(resetSteps);

      if (!task.ui || !task.ui.clarification) {
        var checklist = document.createElement('ul');
        checklist.className = 'life-task-checklist';
        var visibleSteps = (task.steps || []).filter(function(step) {
          return !(task.ui && task.ui.hideCompleted && step.done);
        });
        if (visibleSteps.length === 0) {
          var empty = document.createElement('div');
          empty.className = 'life-meta';
          empty.textContent = task.steps && task.steps.length ? 'No steps to show.' : 'No checklist yet.';
          body.appendChild(empty);
        } else {
          visibleSteps.forEach(function(step) {
            var item = document.createElement('li');
            item.className = 'life-task-step' + (step.done ? ' completed' : '');
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!step.done;
            checkbox.addEventListener('click', function(event) {
              event.stopPropagation();
            });
            checkbox.addEventListener('change', function() {
              step.done = this.checked;
              saveTasks();
              renderPersonTasks(activePersonId);
            });
            var label = document.createElement('span');
            label.textContent = step.text;
            item.appendChild(checkbox);
            item.appendChild(label);
            checklist.appendChild(item);
          });
          body.appendChild(checklist);
        }
        body.appendChild(controls);
      }

      card.appendChild(body);
      return card;
    }

    function openPersonTaskForm(task) {
      if (!lifeTasksForm) return;
      lifeTasksForm.style.display = '';
      personTaskEditingId = task ? task.id : null;
      if (lifeTasksTitle) lifeTasksTitle.value = task ? task.title : '';
      if (lifeTasksNotes) lifeTasksNotes.value = task ? task.notes : '';
      if (lifeTasksBarrier) lifeTasksBarrier.value = task ? task.barrier || '' : '';
      if (lifeTasksSave) lifeTasksSave.textContent = task ? 'Save task' : 'Add task';
      if (lifeTasksTitle) lifeTasksTitle.focus();
    }

    function closePersonTaskForm() {
      if (!lifeTasksForm) return;
      lifeTasksForm.style.display = 'none';
      personTaskEditingId = null;
      if (lifeTasksTitle) lifeTasksTitle.value = '';
      if (lifeTasksNotes) lifeTasksNotes.value = '';
      if (lifeTasksBarrier) lifeTasksBarrier.value = '';
      if (lifeTasksSave) lifeTasksSave.textContent = 'Save task';
    }

    async function generateTaskPlan(task, isRegenerate, clarificationAnswer) {
      if (!task) return;
      personTaskLoading[task.id] = true;
      personTaskErrors[task.id] = '';
      if (!task.ui) task.ui = { collapsed: false, hideCompleted: false };
      renderPersonTasks(activePersonId);
      var plan = null;
      try {
        plan = await requestTaskPlan(task, clarificationAnswer);
        if (!plan) {
          throw new Error('AI response was too long or incomplete.');
        }
        if (plan.clarification) {
          task.ui.clarification = plan.clarification;
        } else if (plan.steps) {
          task.ui.clarification = null;
          task.steps = plan.steps.map(function(step) {
            return { id: generateGoalId('step'), text: step, done: false };
          });
          task.ui.collapsed = false;
        }
      } catch (err) {
        task.ui.clarification = null;
        task.steps = buildFallbackTaskSteps().map(function(step) {
          return { id: generateGoalId('step'), text: step, done: false };
        });
        var message = err && err.message ? err.message : 'AI request failed.';
        personTaskErrors[task.id] = message + ' Using a fallback plan.';
      } finally {
        task.updatedAt = Date.now();
        personTaskLoading[task.id] = false;
        saveTasks();
        renderPersonTasks(activePersonId);
      }
    }

    function renderLinkedTaskOptions() {
      if (!lifeApptLinkedTasks) return;
      lifeApptLinkedTasks.innerHTML = '';
      getLifeTasksList().forEach(function(task) {
        var opt = document.createElement('option');
        opt.value = task.id;
        opt.textContent = task.text || 'Untitled task';
        lifeApptLinkedTasks.appendChild(opt);
      });
    }

    function renderLifeCalendar() {
      if (!lifeCalendarList) return;
      lifeCalendarList.innerHTML = '';
      var filtered = getLifeFiltered(appointments).filter(function(appt) {
        return appt.dateTimeStart;
      });
      filtered.sort(function(a, b) {
        return new Date(a.dateTimeStart) - new Date(b.dateTimeStart);
      });
      if (filtered.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'life-meta';
        empty.textContent = appointments.length === 0 ? 'No appointments yet.' : 'No appointments in this area.';
        lifeCalendarList.appendChild(empty);
        return;
      }
      var lastDate = '';
      filtered.forEach(function(appt) {
        var start = new Date(appt.dateTimeStart);
        var dateLabel = isNaN(start.getTime()) ? 'Upcoming' : start.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        if (dateLabel !== lastDate) {
          var dateHeader = document.createElement('div');
          dateHeader.className = 'life-meta';
          dateHeader.textContent = dateLabel;
          lifeCalendarList.appendChild(dateHeader);
          lastDate = dateLabel;
        }
        var card = document.createElement('div');
        card.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = appt.title || 'Untitled appointment';
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        var timeLabel = appt.dateTimeStart ? new Date(appt.dateTimeStart).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) : '';
        if (appt.dateTimeEnd) {
          var endLabel = new Date(appt.dateTimeEnd).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
          timeLabel = timeLabel + ' - ' + endLabel;
        }
        meta.textContent = [timeLabel, appt.location].filter(Boolean).join(' Â· ');
        var linked = appt.linkedTaskIds && appt.linkedTaskIds.length
          ? appt.linkedTaskIds.map(function(id) {
            var task = tasks.find(function(t) { return t.id === id; });
            return task ? task.text : '';
          }).filter(Boolean).join(', ')
          : '';
        if (linked) {
          var linkedMeta = document.createElement('div');
          linkedMeta.className = 'life-meta';
          linkedMeta.textContent = 'Linked tasks: ' + linked;
          card.appendChild(linkedMeta);
        }
        var areaMeta = document.createElement('div');
        areaMeta.className = 'life-meta';
        var pill = document.createElement('span');
        pill.className = 'life-pill';
        pill.textContent = getAreaLabel(appt.areaId);
        areaMeta.appendChild(pill);

        var actions = document.createElement('div');
        actions.className = 'life-item-actions';
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'life-btn secondary';
        editBtn.textContent = 'Edit';
        editBtn.addEventListener('click', function() {
          editingApptId = appt.id;
          lifeApptTitle.value = appt.title || '';
          lifeApptArea.value = appt.areaId || getDefaultAreaId();
          lifeApptStart.value = appt.dateTimeStart || '';
          lifeApptEnd.value = appt.dateTimeEnd || '';
          lifeApptLocation.value = appt.location || '';
          lifeApptNotes.value = appt.notes || '';
          Array.from(lifeApptLinkedTasks.options).forEach(function(option) {
            option.selected = appt.linkedTaskIds.indexOf(option.value) >= 0;
          });
          lifeApptAdd.textContent = 'Save appointment';
          lifeApptCancel.style.display = 'inline-flex';
          if (activeView !== 'life') {
            setActiveView('life', true);
          }
          lifeApptTitle.focus();
        });
        var deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'life-btn secondary';
        deleteBtn.textContent = 'Delete';
        deleteBtn.addEventListener('click', function() {
          appointments = appointments.filter(function(item) { return item.id !== appt.id; });
          saveAppointments();
          renderLifeCalendar();
        });
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);

        card.appendChild(title);
        if (meta.textContent) card.appendChild(meta);
        card.appendChild(areaMeta);
        card.appendChild(actions);
        lifeCalendarList.appendChild(card);
      });
    }

    function renderAppointmentList(container, list, options) {
      if (!container) return;
      container.innerHTML = '';
      if (!list.length) {
        var empty = document.createElement('div');
        empty.className = 'appointment-empty';
        empty.textContent = options && options.emptyMessage ? options.emptyMessage : 'No appointments found.';
        container.appendChild(empty);
        return;
      }
      list.forEach(function(appt) {
        var card = renderAppointmentCard(appt, {
          showPerson: options && options.showPerson,
          onEdit: function(item) {
            var context = getAppointmentModalContext(options && options.source ? options.source : 'life');
            openAppointmentModal(context, item, { lockPersonId: options && options.lockPersonId ? options.lockPersonId : null });
          },
          onDelete: function(item) {
            deleteAppointment(item);
          }
        });
        container.appendChild(card);
      });
    }

    function getAppointmentModalContext(source) {
      return appointmentModalContexts[source] || null;
    }

    function updatePastToggle(toggleEl, expanded, count, label) {
      if (!toggleEl) return;
      if (!count) {
        toggleEl.style.display = 'none';
        return;
      }
      toggleEl.style.display = '';
      toggleEl.setAttribute('aria-expanded', expanded ? 'true' : 'false');
      toggleEl.textContent = (expanded ? 'Hide' : 'Show') + ' ' + label + ' (' + count + ')';
    }

    function renderPersonAppointments(personId) {
      if (!lifeAppointmentsList || !lifeAppointmentsPast) return;
      if (!personId) return;
      var personAppointments = appointments.filter(function(appt) {
        return appt.personId === personId;
      });
      var split = splitAppointmentsByTime(personAppointments);
      renderAppointmentList(lifeAppointmentsList, split.upcoming, {
        showPerson: false,
        source: 'life',
        lockPersonId: personId,
        emptyMessage: 'No upcoming appointments yet.'
      });
      renderAppointmentList(lifeAppointmentsPast, split.past, {
        showPerson: false,
        source: 'life',
        lockPersonId: personId,
        emptyMessage: 'No past appointments yet.'
      });
      updatePastToggle(lifeAppointmentsPastToggle, lifeAppointmentsPastExpanded, split.past.length, 'past');
      if (lifeAppointmentsPast) {
        lifeAppointmentsPast.style.display = lifeAppointmentsPastExpanded ? '' : 'none';
      }
    }

    function renderAppointmentsFilters() {
      if (!appointmentsFilters) return;
      appointmentsFilters.innerHTML = '';
      var family = getFamilyPeople();
      if (appointmentsFilterPersonId !== 'all' && !family.some(function(person) { return person.id === appointmentsFilterPersonId; })) {
        appointmentsFilterPersonId = 'all';
      }
      var filterOptions = [{ id: 'all', label: 'All' }].concat(family.map(function(person) {
        return { id: person.id, label: person.name || 'Person' };
      }));
      filterOptions.forEach(function(option) {
        var chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'appointments-chip' + (appointmentsFilterPersonId === option.id ? ' active' : '');
        chip.textContent = option.label;
        chip.addEventListener('click', function() {
          appointmentsFilterPersonId = option.id;
          renderAppointmentsView();
        });
        appointmentsFilters.appendChild(chip);
      });
    }

    function renderAppointmentsView() {
      if (!appointmentsFeed || !appointmentsPastFeed) return;
      renderAppointmentsFilters();
      var list = appointments.slice();
      if (appointmentsFilterPersonId !== 'all') {
        list = list.filter(function(appt) { return appt.personId === appointmentsFilterPersonId; });
      }
      var split = splitAppointmentsByTime(list);
      renderAppointmentList(appointmentsFeed, split.upcoming, {
        showPerson: appointmentsFilterPersonId === 'all',
        source: 'calendar',
        emptyMessage: 'No upcoming appointments scheduled.'
      });
      renderAppointmentList(appointmentsPastFeed, split.past, {
        showPerson: appointmentsFilterPersonId === 'all',
        source: 'calendar',
        emptyMessage: 'No past appointments yet.'
      });
      updatePastToggle(appointmentsPastToggle, appointmentsPastExpanded, split.past.length, 'past');
      appointmentsPastFeed.style.display = appointmentsPastExpanded ? '' : 'none';
    }

    function deleteAppointment(appt) {
      if (!appt) return;
      var confirmRemove = window.confirm('Delete "' + (appt.title || 'this appointment') + '"?');
      if (!confirmRemove) return;
      appointments = appointments.filter(function(item) { return item.id !== appt.id; });
      saveAppointments();
      if (activePersonId) {
        renderPersonAppointments(activePersonId);
      }
      renderAppointmentsView();
    }

    function renderAppointmentPersonOptions(selectEl, selectedId) {
      if (!selectEl) return;
      var family = getFamilyPeople();
      selectEl.innerHTML = '';
      if (!family.length) {
        var option = document.createElement('option');
        option.value = '';
        option.textContent = 'Add a person in Life first';
        option.disabled = true;
        option.selected = true;
        selectEl.appendChild(option);
        selectEl.disabled = true;
        return;
      }
      selectEl.disabled = false;
      family.forEach(function(person) {
        var opt = document.createElement('option');
        opt.value = person.id;
        opt.textContent = person.name || 'Person';
        selectEl.appendChild(opt);
      });
      if (selectedId) {
        selectEl.value = selectedId;
      }
    }

    function normalizeAuPhone(value) {
      if (!value) return '';
      var raw = String(value).trim();
      if (!raw) return '';
      var hasPlus = raw.startsWith('+');
      var digits = raw.replace(/[^\d+]/g, '');
      if (hasPlus) {
        digits = '+' + digits.replace(/[^\d]/g, '');
      }
      var cleaned = digits.replace(/\D/g, '');
      if (cleaned.startsWith('61')) {
        cleaned = '0' + cleaned.slice(2);
      }
      if (cleaned.length === 10 && cleaned.startsWith('04')) {
        return cleaned.replace(/(\d{4})(\d{3})(\d{3})/, '$1 $2 $3');
      }
      if (cleaned.length === 10 && /^0[2378]/.test(cleaned)) {
        return cleaned.replace(/(\d{2})(\d{4})(\d{4})/, '$1 $2 $3');
      }
      return value.trim();
    }

    function parseDateFromText(text) {
      if (!text) return '';
      var normalized = text.replace(/[\n,]/g, ' ');
      var isoMatch = normalized.match(/\b(\d{4})-(\d{1,2})-(\d{1,2})\b/);
      if (isoMatch) {
        var isoDate = new Date(isoMatch[1], isoMatch[2] - 1, isoMatch[3]);
        return Number.isNaN(isoDate.getTime()) ? '' : toYmd(isoDate);
      }
      var numericMatch = normalized.match(/\b(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?\b/);
      if (numericMatch) {
        if (!numericMatch[3]) return '';
        var year = Number(numericMatch[3]);
        if (year < 100) year += 2000;
        var numericDate = new Date(year, Number(numericMatch[2]) - 1, Number(numericMatch[1]));
        return Number.isNaN(numericDate.getTime()) ? '' : toYmd(numericDate);
      }
      var monthNames = {
        jan: 0, january: 0,
        feb: 1, february: 1,
        mar: 2, march: 2,
        apr: 3, april: 3,
        may: 4,
        jun: 5, june: 5,
        jul: 6, july: 6,
        aug: 7, august: 7,
        sep: 8, sept: 8, september: 8,
        oct: 9, october: 9,
        nov: 10, november: 10,
        dec: 11, december: 11
      };
      var nameMatch = normalized.match(/\b(\d{1,2})\s*(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\.?,?\s*(\d{2,4})?\b/i);
      if (nameMatch) {
        if (!nameMatch[3]) return '';
        var monthKey = nameMatch[2].toLowerCase();
        var monthIndex = monthNames[monthKey] !== undefined ? monthNames[monthKey] : monthNames[monthKey.slice(0, 3)];
        var yearValue = Number(nameMatch[3]);
        if (yearValue < 100) yearValue += 2000;
        var namedDate = new Date(yearValue, monthIndex, Number(nameMatch[1]));
        return Number.isNaN(namedDate.getTime()) ? '' : toYmd(namedDate);
      }
      var reverseMatch = normalized.match(/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|jun(?:e)?|jul(?:y)?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\.?\s*(\d{1,2})(?:\D+(\d{2,4}))?\b/i);
      if (reverseMatch) {
        if (!reverseMatch[3]) return '';
        var monthKeyAlt = reverseMatch[1].toLowerCase();
        var monthIndexAlt = monthNames[monthKeyAlt] !== undefined ? monthNames[monthKeyAlt] : monthNames[monthKeyAlt.slice(0, 3)];
        var yearAlt = Number(reverseMatch[3]);
        if (yearAlt < 100) yearAlt += 2000;
        var altDate = new Date(yearAlt, monthIndexAlt, Number(reverseMatch[2]));
        return Number.isNaN(altDate.getTime()) ? '' : toYmd(altDate);
      }
      return '';
    }

    function parseTimeFromText(text) {
      if (!text) return '';
      var match = text.match(/\b(\d{1,2})[:.](\d{2})\s*(am|pm)?\b/i);
      var hour = match ? Number(match[1]) : null;
      var minutes = match ? Number(match[2]) : null;
      var meridiem = match && match[3] ? match[3].toLowerCase() : '';
      if (!match) {
        var shortMatch = text.match(/\b(\d{1,2})\s*(am|pm)\b/i);
        if (!shortMatch) return '';
        hour = Number(shortMatch[1]);
        minutes = 0;
        meridiem = shortMatch[2].toLowerCase();
      }
      if (meridiem) {
        if (meridiem === 'pm' && hour < 12) hour += 12;
        if (meridiem === 'am' && hour === 12) hour = 0;
      }
      if (hour > 23 || minutes > 59) return '';
      return padNumber(hour) + ':' + padNumber(minutes);
    }

    function parsePhoneFromText(text) {
      if (!text) return '';
      var match = text.match(/(\+?61\s?\d{1}\s?\d{4}\s?\d{4})|(0[2378]\s?\d{4}\s?\d{4})|(04\d{2}\s?\d{3}\s?\d{3})/);
      return match ? normalizeAuPhone(match[0]) : '';
    }

    function titleCase(text) {
      if (!text) return '';
      return text.replace(/\w\S*/g, function(word) {
        return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
      });
    }

    function inferAppointmentTitle(text) {
      if (!text) return 'Appointment';
      var lower = text.toLowerCase();
      var activityMatch = lower.match(/\b([a-z]+)\s+training\b/);
      if (activityMatch && activityMatch[1]) {
        return titleCase(activityMatch[1] + ' training');
      }
      var lessonMatch = lower.match(/\b([a-z]+)\s+lesson\b/);
      if (lessonMatch && lessonMatch[1]) {
        return titleCase(lessonMatch[1] + ' lesson');
      }
      if (lower.includes('swimming')) {
        return 'Swimming';
      }
      if (lower.includes('training')) {
        return 'Training';
      }
      if (lower.includes('lesson')) {
        return 'Lesson';
      }
      var medicalIndicators = ['dr', 'doctor', 'gp', 'clinic', 'hospital', 'medical', 'specialist', 'paediatric', 'appointment'];
      var hasMedical = medicalIndicators.some(function(term) {
        return new RegExp('\\b' + term + '\\b', 'i').test(text);
      });
      return hasMedical ? 'Doctor appointment' : 'Appointment';
    }

    function extractVenueName(lines) {
      if (!lines || !lines.length) return '';
      var venueKeywords = /(clinic|hospital|medical centre|medical center|practice|surgery|pool|school|centre|center)/i;
      var line = lines.find(function(item) { return venueKeywords.test(item); });
      if (!line) return '';
      var cleaned = line.replace(/^(at|location|venue|clinic)\s*[:\-]\s*/i, '').trim();
      cleaned = cleaned.replace(/\s{2,}/g, ' ').trim();
      if (!cleaned || cleaned.length > 60) return '';
      if (/[.!?]/.test(cleaned) || cleaned.split(',').length > 2) return '';
      return cleaned;
    }

    function parseAppointmentText(text) {
      var cleanText = (text || '').trim();
      if (!cleanText) return {};
      var lines = cleanText.split(/\n/).map(function(line) { return line.trim(); }).filter(Boolean);
      var doctorMatch = cleanText.match(/\b(?:dr\.?|doctor|with)\s+([A-Z][a-zA-Z]+(?:\s+[A-Z][a-zA-Z]+)*)/);
      var addressMatch = cleanText.match(/\b(\d{1,5}\s+[^\n,]+(?:\s+(?:NSW|VIC|QLD|SA|WA|TAS|ACT|NT)\s*\d{4})?)\b/i);
      return {
        title: inferAppointmentTitle(cleanText),
        date: parseDateFromText(cleanText),
        time: parseTimeFromText(cleanText),
        venueName: extractVenueName(lines),
        address: addressMatch ? addressMatch[1].trim() : '',
        contactName: doctorMatch ? doctorMatch[1].trim() : '',
        phone: parsePhoneFromText(cleanText),
        notes: cleanText
      };
    }

    function buildAppointmentDraft(appt, personId) {
      return {
        personId: appt ? appt.personId : (personId || ''),
        title: appt ? (appt.title || '') : '',
        date: appt ? (appt.date || '') : '',
        time: appt ? (appt.time || '') : '',
        clinicName: appt ? (appt.clinicName || '') : '',
        doctorName: appt ? (appt.doctorName || '') : '',
        address: appt ? (appt.address || '') : '',
        phone: appt ? (appt.phone || '') : '',
        notes: appt ? (appt.notes || '') : ''
      };
    }

    function syncAppointmentFormInputs(context) {
      if (!context || !context.draft) return;
      if (context.personSelect && context.draft.personId) {
        context.personSelect.value = context.draft.personId;
      }
      if (context.titleInput) context.titleInput.value = context.draft.title || '';
      if (context.dateInput) context.dateInput.value = context.draft.date || '';
      if (context.timeInput) context.timeInput.value = context.draft.time || '';
      if (context.clinicInput) context.clinicInput.value = context.draft.clinicName || '';
      if (context.doctorInput) context.doctorInput.value = context.draft.doctorName || '';
      if (context.addressInput) context.addressInput.value = context.draft.address || '';
      if (context.phoneInput) context.phoneInput.value = context.draft.phone || '';
      if (context.notesInput) context.notesInput.value = context.draft.notes || '';
    }

    function setAppointmentSummaryVisible(context, isVisible) {
      if (!context || !context.summary) return;
      context.summary.style.display = isVisible ? '' : 'none';
      if (context.formFields) {
        context.formFields.classList.toggle('is-hidden', isVisible);
      }
    }

    function formatSummaryValue(value) {
      return value && String(value).trim() ? String(value).trim() : '';
    }

    function buildDirectionsLink(address, clinicName) {
      var query = (address || '').trim() || (clinicName || '').trim();
      if (!query) return '';
      return 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(query);
    }

    function renderAppointmentSummary(context) {
      if (!context || !context.summaryRows || !context.draft) return;
      context.summaryRows.innerHTML = '';
      var fields = [
        { key: 'title', label: 'Title', type: 'text', placeholder: 'Appointment title' },
        { key: 'date', label: 'Date', type: 'date' },
        { key: 'time', label: 'Time', type: 'time' },
        { key: 'doctorName', label: 'Doctor', type: 'text', placeholder: 'Doctor or provider' },
        { key: 'clinicName', label: 'Clinic/Venue', type: 'text', placeholder: 'Clinic or facility' },
        { key: 'address', label: 'Address', type: 'text', placeholder: 'Street address, Suburb NSW 2000' },
        { key: 'phone', label: 'Phone', type: 'tel', placeholder: '04xx xxx xxx or 02 xxxx xxxx' },
        { key: 'notes', label: 'Notes', type: 'textarea', placeholder: 'Notes (optional)' }
      ];
      fields.forEach(function(field) {
        var row = document.createElement('div');
        row.className = 'appointments-summary-row';
        row.dataset.field = field.key;
        var label = document.createElement('div');
        label.className = 'appointments-summary-label';
        label.textContent = field.label;
        var value = document.createElement('div');
        value.className = 'appointments-summary-value';
        var rawValue = formatSummaryValue(context.draft[field.key]);
        if (field.key === 'notes' && rawValue) {
          value.classList.add('appointments-summary-notes');
          var details = document.createElement('details');
          var summary = document.createElement('summary');
          summary.textContent = 'Show more';
          var notesText = document.createElement('div');
          notesText.className = 'appointments-summary-notes-text';
          notesText.textContent = rawValue;
          details.appendChild(summary);
          details.appendChild(notesText);
          value.appendChild(details);
        } else if (field.key === 'address') {
          var directionsLink = buildDirectionsLink(rawValue, context.draft.clinicName);
          var hasDirections = !!directionsLink;
          value.classList.add('has-actions');
          var addressLine = document.createElement('div');
          if (rawValue) {
            addressLine.textContent = rawValue;
          } else {
            addressLine.textContent = 'â€”';
            if (!hasDirections) {
              value.classList.add('is-empty');
            }
          }
          value.appendChild(addressLine);
          if (hasDirections) {
            var actionsRow = document.createElement('div');
            actionsRow.className = 'appointments-summary-inline-actions';
            var directionsBtn = document.createElement('a');
            directionsBtn.className = 'appointments-summary-link-btn';
            directionsBtn.href = directionsLink;
            directionsBtn.target = '_blank';
            directionsBtn.rel = 'noopener';
            directionsBtn.textContent = 'Directions';
            actionsRow.appendChild(directionsBtn);
            value.appendChild(actionsRow);
          }
        } else if (field.key === 'phone') {
          if (rawValue) {
            var phoneLink = document.createElement('a');
            phoneLink.className = 'appointments-summary-link';
            phoneLink.href = 'tel:' + rawValue.replace(/\s+/g, '');
            phoneLink.textContent = rawValue;
            value.appendChild(phoneLink);
          } else {
            value.textContent = 'â€”';
            value.classList.add('is-empty');
          }
        } else if (rawValue) {
          value.textContent = rawValue;
        } else {
          value.textContent = 'â€”';
          value.classList.add('is-empty');
        }

        var actions = document.createElement('div');
        actions.className = 'appointments-summary-row-actions';
        var editBtn = document.createElement('button');
        editBtn.type = 'button';
        editBtn.className = 'appointments-icon-btn';
        editBtn.textContent = 'âœï¸';
        editBtn.setAttribute('aria-label', 'Edit ' + field.label);
        var saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.className = 'appointments-icon-btn';
        saveBtn.textContent = 'âœ“';
        saveBtn.setAttribute('aria-label', 'Save ' + field.label);
        saveBtn.style.display = 'none';
        var cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'appointments-icon-btn';
        cancelBtn.textContent = 'âœ•';
        cancelBtn.setAttribute('aria-label', 'Cancel ' + field.label);
        cancelBtn.style.display = 'none';

        actions.appendChild(editBtn);
        actions.appendChild(saveBtn);
        actions.appendChild(cancelBtn);

        var editWrap = document.createElement('div');
        editWrap.className = 'appointments-summary-edit';
        editWrap.style.display = 'none';
        var input;
        if (field.type === 'textarea') {
          input = document.createElement('textarea');
          input.rows = 3;
        } else {
          input = document.createElement('input');
          input.type = field.type;
        }
        if (field.placeholder) input.placeholder = field.placeholder;
        input.value = context.draft[field.key] || '';
        if (field.key === 'phone') {
          input.addEventListener('blur', function() {
            input.value = normalizeAuPhone(input.value);
          });
        }
        editWrap.appendChild(input);

        function closeEdit() {
          editWrap.style.display = 'none';
          value.style.display = '';
          editBtn.style.display = '';
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
        }

        editBtn.addEventListener('click', function() {
          input.value = context.draft[field.key] || '';
          editWrap.style.display = '';
          value.style.display = 'none';
          editBtn.style.display = 'none';
          saveBtn.style.display = '';
          cancelBtn.style.display = '';
          input.focus();
        });

        saveBtn.addEventListener('click', function() {
          var newValue = input.value.trim();
          if (field.key === 'phone') {
            newValue = normalizeAuPhone(newValue);
          }
          if (!context.draft) context.draft = {};
          context.draft[field.key] = newValue;
          syncAppointmentFormInputs(context);
          renderAppointmentSummary(context);
        });

        cancelBtn.addEventListener('click', function() {
          closeEdit();
        });

        row.appendChild(label);
        row.appendChild(value);
        row.appendChild(actions);
        row.appendChild(editWrap);
        context.summaryRows.appendChild(row);
      });
    }

    function applyAppointmentFields(context, fields) {
      if (!context || !fields) return;
      if (!context.draft) context.draft = {};
      if (fields.title) context.draft.title = fields.title;
      if (fields.date) context.draft.date = fields.date;
      if (fields.time) context.draft.time = fields.time;
      if (fields.venueName) context.draft.clinicName = fields.venueName;
      if (fields.contactName) context.draft.doctorName = fields.contactName;
      if (fields.address) context.draft.address = fields.address;
      if (fields.phone) context.draft.phone = normalizeAuPhone(fields.phone);
      if (fields.notes) context.draft.notes = fields.notes;
      syncAppointmentFormInputs(context);
      renderAppointmentSummary(context);
    }

    function setAppointmentOriginalText(context, text) {
      if (!context || !context.originalDetails || !context.originalText) return;
      if (!text) {
        context.originalDetails.style.display = 'none';
        context.originalText.textContent = '';
        return;
      }
      context.originalText.textContent = text;
      context.originalDetails.style.display = '';
      context.originalDetails.open = false;
    }

    function setAppointmentScanButtonState(context, enabled) {
      if (!context || !context.scanImageBtn) return;
      context.scanImageBtn.disabled = !enabled;
    }

    function setAppointmentScanStatus(context, message) {
      if (!context || !context.scanStatus) return;
      context.scanStatus.textContent = message || '';
      context.scanStatus.style.display = message ? '' : 'none';
    }

    function readFileAsBase64(file) {
      return new Promise(function(resolve, reject) {
        var reader = new FileReader();
        reader.onload = function() {
          var result = typeof reader.result === 'string' ? reader.result : '';
          var splitIndex = result.indexOf(',');
          resolve(splitIndex >= 0 ? result.slice(splitIndex + 1) : result);
        };
        reader.onerror = function() {
          reject(new Error('Unable to read image.'));
        };
        reader.readAsDataURL(file);
      });
    }

    async function callAppointmentScan(file) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      var formData = new FormData();
      formData.append('image', file, file.name || 'appointment.jpg');
      var res = await fetch('/api/appointments/scan', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + idToken
        },
        body: formData
      });
      if (!res.ok) {
        var errorMsg = 'Backend API error';
        try {
          var error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (e) {}
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        throw new Error(errorMsg);
      }
      return await res.json();
    }

    async function callAppointmentImageExtract(payload) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      var res = await fetch('/api/appointments/extract', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        var errorMsg = 'Backend API error';
        try {
          var error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (e) {}
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        throw new Error(errorMsg);
      }
      return await res.json();
    }

    function applyAppointmentExtract(context, appointment) {
      if (!context || !appointment) return;
      if (!context.draft) {
        context.draft = buildAppointmentDraft(null, context.personSelect ? context.personSelect.value : '');
      }
      context.draft.title = appointment.title || context.draft.title || '';
      context.draft.date = appointment.date || context.draft.date || '';
      context.draft.time = appointment.time || context.draft.time || '';
      context.draft.doctorName = appointment.doctorName || context.draft.doctorName || '';
      context.draft.clinicName = appointment.clinicName || context.draft.clinicName || '';
      context.draft.address = appointment.address || context.draft.address || '';
      if (appointment.phone) {
        context.draft.phone = normalizeAuPhone(appointment.phone);
      }
      context.draft.notes = appointment.notes || context.draft.notes || '';
      syncAppointmentFormInputs(context);
      renderAppointmentSummary(context);
    }

    function applyAppointmentScanFields(context, appointment) {
      if (!context || !appointment) return;
      if (!context.draft) {
        context.draft = buildAppointmentDraft(null, context.personSelect ? context.personSelect.value : '');
      }
      context.draft.title = appointment.title || context.draft.title || '';
      context.draft.date = appointment.date || context.draft.date || '';
      context.draft.time = appointment.time || context.draft.time || '';
      context.draft.clinicName = appointment.provider || context.draft.clinicName || '';
      context.draft.address = appointment.location || context.draft.address || '';
      if (appointment.phone) {
        context.draft.phone = normalizeAuPhone(appointment.phone);
      }
      context.draft.notes = appointment.notes || context.draft.notes || '';
      syncAppointmentFormInputs(context);
      renderAppointmentSummary(context);
    }

    function updateAppointmentScanPreview(context, file) {
      if (!context || !context.scanPreview || !context.scanImage) return;
      if (!file) return;
      if (context.captureUrl) {
        URL.revokeObjectURL(context.captureUrl);
      }
      context.captureFile = file;
      context.captureUrl = URL.createObjectURL(file);
      context.scanImage.src = context.captureUrl;
      context.scanPreview.style.display = '';
      setAppointmentScanButtonState(context, true);
      setAppointmentScanStatus(context, '');
    }

    function resetAppointmentCapture(context, options) {
      if (!context) return;
      if (context.scanTakeInput) context.scanTakeInput.value = '';
      if (context.scanUploadInput) context.scanUploadInput.value = '';
      if (context.scanPreview) context.scanPreview.style.display = 'none';
      if (context.scanImage) context.scanImage.removeAttribute('src');
      if (context.captureUrl) {
        URL.revokeObjectURL(context.captureUrl);
        context.captureUrl = null;
      }
      context.captureFile = null;
      setAppointmentScanButtonState(context, false);
      setAppointmentScanStatus(context, '');
      if (context.textInput) context.textInput.value = '';
      setAppointmentOriginalText(context, '');
      if (context.aiBtn) {
        context.aiBtn.classList.remove('is-loading');
        context.aiBtn.disabled = false;
      }
      if (!options || !options.preserveDraft) {
        if (context.summaryRows) context.summaryRows.innerHTML = '';
        if (context.summary) context.summary.style.display = 'none';
        if (context.formFields) context.formFields.classList.remove('is-hidden');
        context.draft = null;
      }
    }

    async function callAppointmentStructure(text) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      var res = await fetch('/api/appointments/structure', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({ text: text })
      });
      if (!res.ok) {
        var errorMsg = 'Backend API error';
        try {
          var error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (e) {}
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        throw new Error(errorMsg);
      }
      var data = await res.json();
      return (data && data.fields) ? data.fields : {};
    }

    function openAppointmentModal(context, appt, options) {
      if (!context || !context.modal) return;
      appointmentEditingId = appt ? appt.id : null;
      appointmentModalSource = context.source || 'life';
      appointmentModalLockPersonId = options && options.lockPersonId ? options.lockPersonId : null;
      context.title.textContent = appt ? 'Edit appointment' : 'Add appointment';
      var personId = appt ? appt.personId : (appointmentModalLockPersonId || getDefaultPersonId());
      renderAppointmentPersonOptions(context.personSelect, personId);
      if (context.personRow) {
        var isLocked = !!appointmentModalLockPersonId;
        context.personRow.style.display = isLocked ? 'none' : '';
        context.personSelect.disabled = isLocked;
      }
      if (appointmentModalLockPersonId) {
        context.personSelect.value = appointmentModalLockPersonId;
      }
      context.titleInput.value = appt ? appt.title || '' : '';
      context.dateInput.value = appt ? appt.date || '' : '';
      context.timeInput.value = appt ? appt.time || '' : '';
      context.clinicInput.value = appt ? appt.clinicName || '' : '';
      context.doctorInput.value = appt ? appt.doctorName || '' : '';
      context.addressInput.value = appt ? appt.address || '' : '';
      context.phoneInput.value = appt ? appt.phone || '' : '';
      context.notesInput.value = appt ? appt.notes || '' : '';
      context.deleteBtn.style.display = appt ? 'inline-flex' : 'none';
      resetAppointmentCapture(context, { preserveDraft: true });
      context.draft = buildAppointmentDraft(appt, personId);
      syncAppointmentFormInputs(context);
      if (context.summary) {
        var showSummary = !!(options && options.showSummary);
        setAppointmentSummaryVisible(context, showSummary);
        if (showSummary) {
          renderAppointmentSummary(context);
        }
      }
      context.modal.classList.add('active');
      context.modal.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function closeAppointmentModal(context) {
      if (!context || !context.modal) return;
      context.modal.classList.remove('active');
      context.modal.setAttribute('aria-hidden', 'true');
      appointmentEditingId = null;
      appointmentModalLockPersonId = null;
      resetAppointmentCapture(context);
      unlockBodyScroll();
    }

    function handleAppointmentSubmit(event, context) {
      event.preventDefault();
      if (!context) return;
      var useDraft = !!context.summary;
      var draft = useDraft && context.draft ? context.draft : null;
      var personId = useDraft
        ? (draft.personId || (context.personSelect ? context.personSelect.value : ''))
        : (context.personSelect ? context.personSelect.value : '');
      if (appointmentModalLockPersonId) {
        personId = appointmentModalLockPersonId;
      }
      if (!personId) {
        alert('Please select a person.');
        return;
      }
      var title = useDraft ? (draft.title || '').trim() : context.titleInput.value.trim();
      if (!title) {
        alert('Please enter a title.');
        if (context.titleInput) context.titleInput.focus();
        return;
      }
      var date = useDraft ? (draft.date || '') : context.dateInput.value;
      var time = useDraft ? (draft.time || '') : context.timeInput.value;
      if (!date || !time) {
        alert('Please select a date and time.');
        return;
      }
      var dateTime = new Date(date + 'T' + time);
      if (!Number.isNaN(dateTime.getTime()) && dateTime.getTime() < Date.now()) {
        var proceed = window.confirm('This appointment is in the past. Save anyway?');
        if (!proceed) {
          return;
        }
      }
      var existing = appointmentEditingId
        ? appointments.find(function(item) { return item.id === appointmentEditingId; })
        : null;
      var record = {
        id: appointmentEditingId || generateAppointmentId(),
        personId: personId,
        title: title,
        date: date,
        time: time,
        clinicName: useDraft ? (draft.clinicName || '').trim() : context.clinicInput.value.trim(),
        doctorName: useDraft ? (draft.doctorName || '').trim() : context.doctorInput.value.trim(),
        address: useDraft ? (draft.address || '').trim() : context.addressInput.value.trim(),
        phone: useDraft ? normalizeAuPhone(draft.phone || '') : normalizeAuPhone(context.phoneInput.value.trim()),
        notes: useDraft ? (draft.notes || '').trim() : context.notesInput.value.trim(),
        createdAt: existing && existing.createdAt ? existing.createdAt : Date.now(),
        updatedAt: Date.now()
      };
      if (existing) {
        appointments = appointments.map(function(item) {
          return item.id === appointmentEditingId ? record : item;
        });
      } else {
        appointments.unshift(record);
      }
      saveAppointments();
      if (activePersonId) {
        renderPersonAppointments(activePersonId);
      }
      renderAppointmentsView();
      closeAppointmentModal(context);
    }

    function setupAppointmentModal(context) {
      if (!context || !context.modal) return;
      if (context.scanTakeInput) {
        context.scanTakeInput.accept = 'image/*';
      }
      if (context.scanUploadInput) {
        context.scanUploadInput.accept = 'image/*';
      }
      if (context.scanImageBtn) {
        context.scanImageBtn.textContent = 'Scan image';
      }
      if (!context.scanStatus && context.scanImageBtn) {
        var scanWrap = context.scanImageBtn.closest('.appointments-scan') || context.scanImageBtn.parentElement;
        if (scanWrap) {
          var status = scanWrap.querySelector('.appointments-scan-note[data-role="scan-status"]');
          if (!status) {
            status = document.createElement('div');
            status.className = 'appointments-scan-note';
            status.dataset.role = 'scan-status';
            status.style.display = 'none';
            scanWrap.appendChild(status);
          }
          context.scanStatus = status;
        }
      }
      context.modal.addEventListener('click', function(event) {
        if (event.target.dataset.close !== undefined) {
          closeAppointmentModal(context);
        }
      });
      if (context.closeBtn) {
        context.closeBtn.addEventListener('click', function() {
          closeAppointmentModal(context);
        });
      }
      context.form.addEventListener('submit', function(event) {
        handleAppointmentSubmit(event, context);
      });
      if (context.phoneInput) {
        context.phoneInput.addEventListener('blur', function() {
          this.value = normalizeAuPhone(this.value);
        });
      }
      if (context.personSelect) {
        context.personSelect.addEventListener('change', function() {
          if (!context.draft) context.draft = buildAppointmentDraft(null, '');
          context.draft.personId = this.value;
          syncAppointmentFormInputs(context);
        });
      }
      if (context.deleteBtn) {
        context.deleteBtn.addEventListener('click', function() {
          if (!appointmentEditingId) return;
          var appt = appointments.find(function(item) { return item.id === appointmentEditingId; });
          deleteAppointment(appt);
          closeAppointmentModal(context);
        });
      }
      if (context.scanTakeBtn && context.scanTakeInput) {
        context.scanTakeBtn.addEventListener('click', function() {
          context.scanTakeInput.click();
        });
        context.scanTakeInput.addEventListener('change', function(event) {
          var file = event.target.files && event.target.files[0];
          if (file) {
            updateAppointmentScanPreview(context, file);
          }
        });
      }
      if (context.scanUploadBtn && context.scanUploadInput) {
        context.scanUploadBtn.addEventListener('click', function() {
          context.scanUploadInput.click();
        });
        context.scanUploadInput.addEventListener('change', function(event) {
          var file = event.target.files && event.target.files[0];
          if (file) {
            updateAppointmentScanPreview(context, file);
          }
        });
      }
      if (context.scanImageBtn) {
        context.scanImageBtn.addEventListener('click', async function() {
          if (!context.captureFile) {
            alert('Select an image to scan.');
            return;
          }
          var originalLabel = context.scanImageBtn.textContent;
          context.scanImageBtn.textContent = 'Scanning...';
          setAppointmentScanStatus(context, 'Scanning...');
          context.scanImageBtn.disabled = true;
          try {
            var appointment = await callAppointmentScan(context.captureFile);
            applyAppointmentScanFields(context, appointment);
            if (context.summary) {
              setAppointmentSummaryVisible(context, true);
              renderAppointmentSummary(context);
            }
            setAppointmentScanStatus(context, 'Filled âœ“');
          } catch (err) {
            setAppointmentScanStatus(
              context,
              err && err.message ? err.message : 'Unable to scan the appointment image.'
            );
          } finally {
            context.scanImageBtn.textContent = originalLabel || 'Scan image';
            context.scanImageBtn.disabled = !context.captureFile;
          }
        });
      }
      if (context.parseBtn && context.textInput) {
        context.parseBtn.addEventListener('click', function() {
          var text = context.textInput.value.trim();
          if (!text) {
            alert('Paste appointment text to parse.');
            context.textInput.focus();
            return;
          }
          var parsed = parseAppointmentText(text);
          applyAppointmentFields(context, parsed);
          setAppointmentOriginalText(context, text);
          if (context.summary) {
            setAppointmentSummaryVisible(context, true);
            renderAppointmentSummary(context);
          }
        });
      }
      if (context.textInput) {
        context.textInput.addEventListener('blur', function() {
          var text = context.textInput.value.trim();
          if (!text) return;
          if (!context.draft) context.draft = buildAppointmentDraft(null, context.personSelect ? context.personSelect.value : '');
          applyAppointmentFields(context, parseAppointmentText(text));
          setAppointmentOriginalText(context, text);
          if (context.summary) {
            setAppointmentSummaryVisible(context, true);
            renderAppointmentSummary(context);
          }
        });
      }
      if (context.aiBtn && context.textInput) {
        context.aiBtn.addEventListener('click', async function() {
          var text = context.textInput.value.trim();
          if (!text) {
            alert('Paste appointment text to use AI.');
            context.textInput.focus();
            return;
          }
          context.aiBtn.classList.add('is-loading');
          context.aiBtn.disabled = true;
          try {
            var fields = await callAppointmentStructure(text);
            applyAppointmentFields(context, fields);
            setAppointmentOriginalText(context, text);
          } catch (err) {
            alert(err && err.message ? err.message : 'Unable to structure the appointment text.');
          } finally {
            context.aiBtn.classList.remove('is-loading');
            context.aiBtn.disabled = false;
          }
        });
      }
      if (context.summarySaveBtn) {
        context.summarySaveBtn.addEventListener('click', function() {
          handleAppointmentSubmit({ preventDefault: function() {} }, context);
        });
      }
      if (context.summaryDiscardBtn) {
        context.summaryDiscardBtn.addEventListener('click', function() {
          closeAppointmentModal(context);
        });
      }
    }

    function renderLifeAreasList() {
      if (!lifeAreasList) return;
      lifeAreasList.innerHTML = '';
      lifeAreas.forEach(function(area) {
        var row = document.createElement('div');
        row.className = 'life-item';
        var title = document.createElement('div');
        title.textContent = area.name;
        var meta = document.createElement('div');
        meta.className = 'life-meta';
        meta.textContent = 'Type: ' + area.type;
        row.appendChild(title);
        row.appendChild(meta);
        if (area.type === 'child') {
          var actions = document.createElement('div');
          actions.className = 'life-item-actions';
          var removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'life-btn secondary';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', function() {
            lifeAreas = lifeAreas.filter(function(item) { return item.id !== area.id; });
            saveLifeAreas();
            renderAreaSelects();
            renderLifeAreasList();
          });
          actions.appendChild(removeBtn);
          row.appendChild(actions);
        }
        lifeAreasList.appendChild(row);
      });
    }

    function renderAreaSelects() {
      if (goalsAreaFilterValue !== 'all' && !lifeAreas.some(function(area) { return area.id === goalsAreaFilterValue; })) {
        goalsAreaFilterValue = 'all';
      }
      if (lifeAreaFilterValue !== 'all' && !lifeAreas.some(function(area) { return area.id === lifeAreaFilterValue; })) {
        lifeAreaFilterValue = 'all';
      }
      renderAreaSelect(goalsAreaFilter, true, goalsAreaFilterValue);
      renderAreaSelect(shortGoalArea, false, goalsAreaFilterValue !== 'all' ? goalsAreaFilterValue : getDefaultAreaId());
      renderAreaSelect(longGoalArea, false, goalsAreaFilterValue !== 'all' ? goalsAreaFilterValue : getDefaultAreaId());
      renderAreaSelect(lifeAreaFilter, true, lifeAreaFilterValue);
      renderAreaSelect(lifeTaskArea, false, lifeAreaFilterValue !== 'all' ? lifeAreaFilterValue : getDefaultAreaId());
      renderAreaSelect(lifeApptArea, false, lifeAreaFilterValue !== 'all' ? lifeAreaFilterValue : getDefaultAreaId());
    }

    function setLifeTab(nextTab) {
      lifeActiveTab = nextTab;
      if (lifeView && lifeView.classList.contains('person-view-active')) {
        setPersonViewActive(false);
      }
      var tabs = document.querySelectorAll('#lifeTabs .life-tab');
      tabs.forEach(function(tab) {
        tab.classList.toggle('active', tab.dataset.tab === nextTab);
      });
      var panels = document.querySelectorAll('#life-view [data-tab-panel]');
      panels.forEach(function(panel) {
        panel.style.display = panel.dataset.tabPanel === nextTab ? '' : 'none';
      });
      if (lifeView) {
        lifeView.classList.toggle('people-active', nextTab === 'people');
      }
      if (lifeAreaFilter) {
        lifeAreaFilter.classList.toggle('life-area-hidden', nextTab === 'people');
      }
    }

    async function callUnstuckAssistant(prompt) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      var res = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({
          model: modelSelect.value,
          messages: [{ role: 'user', content: prompt }]
        })
      });
      if (!res.ok) {
        var errorMsg = 'Backend API error';
        try {
          var error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (e) {}
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        throw new Error(errorMsg);
      }
      var data = await res.json();
      return data.response;
    }

    function stripJsonFences(text) {
      if (!text) return '';
      var trimmed = text.trim();
      if (trimmed.startsWith('```')) {
        trimmed = trimmed.replace(/^```[a-zA-Z]*\n?/, '').replace(/```$/, '').trim();
      }
      return trimmed;
    }

    function openUnstuckPanel(config) {
      var panel = config.source === 'goal' ? goalsUnstuckPanel : lifeUnstuckPanel;
      if (!panel) return;
      panel.innerHTML = '';
      panel.classList.add('active');

      var title = document.createElement('div');
      title.className = config.source === 'goal' ? 'goals-meta' : 'life-meta';
      title.textContent = (config.mode === 'break' ? 'Break into steps' : 'Help me start') + ' Â· ' + getAreaLabel(config.item.areaId);

      var doneInput = document.createElement('input');
      doneInput.type = 'text';
      doneInput.placeholder = 'Done definition (optional)';
      doneInput.className = config.source === 'goal' ? 'goals-input' : 'life-input';

      var roadblockSelect = document.createElement('select');
      roadblockSelect.className = config.source === 'goal' ? 'goals-input' : 'life-select';
      ['No roadblock', 'Overwhelmed', 'Too many steps', 'Low energy', 'Waiting on others', 'No time', 'Other'].forEach(function(label) {
        var opt = document.createElement('option');
        opt.value = label;
        opt.textContent = label;
        roadblockSelect.appendChild(opt);
      });

      var roadblockInput = document.createElement('input');
      roadblockInput.type = 'text';
      roadblockInput.placeholder = 'Roadblock details (optional)';
      roadblockInput.className = config.source === 'goal' ? 'goals-input' : 'life-input';

      var sizeSelect = document.createElement('select');
      sizeSelect.className = config.source === 'goal' ? 'goals-input' : 'life-select';
      ['Tiny', 'Small', 'Medium'].forEach(function(label) {
        var opt = document.createElement('option');
        opt.value = label;
        opt.textContent = 'First-step size: ' + label;
        sizeSelect.appendChild(opt);
      });

      var actionRow = document.createElement('div');
      actionRow.className = config.source === 'goal' ? 'goals-row' : 'life-row';
      var submitBtn = document.createElement('button');
      submitBtn.type = 'button';
      submitBtn.className = config.source === 'goal' ? 'goals-btn' : 'life-btn';
      submitBtn.textContent = 'Run AI';
      var closeBtn = document.createElement('button');
      closeBtn.type = 'button';
      closeBtn.className = config.source === 'goal' ? 'goals-btn goals-btn-secondary' : 'life-btn secondary';
      closeBtn.textContent = 'Close';
      closeBtn.addEventListener('click', function() {
        panel.classList.remove('active');
        panel.innerHTML = '';
      });
      actionRow.appendChild(submitBtn);
      actionRow.appendChild(closeBtn);

      var status = document.createElement('div');
      status.className = config.source === 'goal' ? 'goals-meta' : 'life-meta';

      var results = document.createElement('div');
      results.className = config.source === 'goal' ? 'unstuck-steps' : 'unstuck-steps';

      panel.appendChild(title);
      panel.appendChild(doneInput);
      panel.appendChild(roadblockSelect);
      panel.appendChild(roadblockInput);
      panel.appendChild(sizeSelect);
      panel.appendChild(actionRow);
      panel.appendChild(status);
      panel.appendChild(results);

      submitBtn.addEventListener('click', async function() {
        status.textContent = 'Thinking...';
        results.innerHTML = '';
        var maxSteps = config.mode === 'break' ? 5 : 3;
        var prompt = [
          'Return JSON only with schema:',
          '{"stuck_reason":"string (optional, max 120 chars)","steps":[{"text":"string","minutes":number,"done_when":"string"}],"if_stuck_try":["string"]}',
          'Rules: max ' + maxSteps + ' steps, step 1 must be <= 5 minutes, no extra prose.',
          'Context:',
          'Area: ' + getAreaLabel(config.item.areaId),
          'Item: ' + (config.item.title || config.item.text || 'Untitled'),
          'Notes: ' + (config.item.note || config.item.notes || ''),
          'Target/Due: ' + (config.item.targetDate || config.item.dueDate || ''),
          'Tags: ' + ((config.item.tags || []).join(', ')),
          'Done definition: ' + doneInput.value.trim(),
          'Roadblock: ' + roadblockSelect.value + (roadblockInput.value.trim() ? ' - ' + roadblockInput.value.trim() : ''),
          'First-step size: ' + sizeSelect.value
        ].join('\n');
        try {
          var response = await callUnstuckAssistant(prompt);
          var parsed = JSON.parse(stripJsonFences(response));
          renderUnstuckResults(panel, parsed, config.item.areaId);
          status.textContent = '';
        } catch (err) {
          status.textContent = err && err.message ? err.message : 'Unable to get AI steps.';
        }
      });
    }

    function renderUnstuckResults(panel, data, areaId) {
      var results = panel.querySelector('.unstuck-steps');
      if (!results) return;
      results.innerHTML = '';
      var steps = Array.isArray(data.steps) ? data.steps : [];
      var tips = Array.isArray(data.if_stuck_try) ? data.if_stuck_try : [];
      if (data.stuck_reason) {
        var reason = document.createElement('div');
        reason.className = panel.closest('#goals-view') ? 'goals-meta' : 'life-meta';
        reason.textContent = 'Stuck reason: ' + data.stuck_reason;
        results.appendChild(reason);
      }

      var stepsLabel = document.createElement('div');
      stepsLabel.className = panel.closest('#goals-view') ? 'goals-meta' : 'life-meta';
      stepsLabel.textContent = 'Review steps';
      results.appendChild(stepsLabel);

      steps.forEach(function(step) {
        var row = document.createElement('div');
        row.className = 'unstuck-step-row';
        var textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.value = step.text || '';
        var minutesInput = document.createElement('input');
        minutesInput.type = 'number';
        minutesInput.min = '1';
        minutesInput.max = '180';
        minutesInput.value = step.minutes || 5;
        row.appendChild(textInput);
        row.appendChild(minutesInput);
        results.appendChild(row);

        var doneWhen = document.createElement('input');
        doneWhen.type = 'text';
        doneWhen.value = step.done_when || '';
        doneWhen.placeholder = 'Done when...';
        doneWhen.className = panel.closest('#goals-view') ? 'goals-input' : 'life-input';
        results.appendChild(doneWhen);
      });

      if (tips.length) {
        var tipsLabel = document.createElement('div');
        tipsLabel.className = panel.closest('#goals-view') ? 'goals-meta' : 'life-meta';
        tipsLabel.textContent = 'If stuck, try';
        results.appendChild(tipsLabel);
        tips.forEach(function(tip) {
          var tipInput = document.createElement('input');
          tipInput.type = 'text';
          tipInput.value = tip || '';
          tipInput.className = panel.closest('#goals-view') ? 'goals-input' : 'life-input';
          results.appendChild(tipInput);
        });
      }

      var addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.className = panel.closest('#goals-view') ? 'goals-btn' : 'life-btn';
      addBtn.textContent = 'Add to short-term checklist';
      addBtn.addEventListener('click', function() {
        var stepRows = results.querySelectorAll('.unstuck-step-row');
        var newGoals = [];
        stepRows.forEach(function(row) {
          var textInput = row.querySelector('input[type="text"]');
          if (!textInput || !textInput.value.trim()) return;
          newGoals.push({
            id: generateGoalId('short'),
            text: textInput.value.trim(),
            done: false,
            areaId: areaId || getDefaultAreaId(),
            ownerName: getAreaOwnerName(areaId),
            personId: activePersonId || null,
            createdAt: Date.now(),
            completedAt: null
          });
        });
        if (!newGoals.length) return;
        goalsShort = newGoals.concat(goalsShort);
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
      });
      results.appendChild(addBtn);
    }

    // SETTINGS MANAGEMENT
    let settings = {
      frictionMode: 'full', // 'off', 'light', 'full'
      messageDelay: 0, // 0, 5, 15, 30, 45 seconds
      allowCancelDelay: true,
      showShortTermGoal: true,
      showLongTermGoal: true,
      lockUntil: null
    };

    function loadSettings() {
      var saved = localStorage.getItem('friction_settings');
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          settings = Object.assign(settings, parsed);
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function saveSettings() {
      localStorage.setItem('friction_settings', JSON.stringify(settings));
      // Sync to server (debounced)
      saveUserDataToServer();
    }

    function isSettingsLocked() {
      if (!settings.lockUntil) return false;
      return Date.now() < settings.lockUntil;
    }

    function getRemainingLockTime() {
      if (!settings.lockUntil) return 0;
      return Math.max(0, settings.lockUntil - Date.now());
    }

    function formatLockTime(ms) {
      var totalSeconds = Math.floor(ms / 1000);
      var hours = Math.floor(totalSeconds / 3600);
      var minutes = Math.floor((totalSeconds % 3600) / 60);
      var seconds = totalSeconds % 60;
      return String(hours).padStart(2, '0') + ':' + 
             String(minutes).padStart(2, '0') + ':' + 
             String(seconds).padStart(2, '0');
    }

    function showSettings() {
      loadSettings();
      
      var overlay = document.getElementById('settingsOverlay');
      var content = document.getElementById('settingsContent');
      var lockBanner = document.getElementById('settingsLockBanner');
      
      // Set current values in form
      document.querySelector('input[name="frictionMode"][value="' + settings.frictionMode + '"]').checked = true;
      document.querySelector('input[name="messageDelay"][value="' + settings.messageDelay + '"]').checked = true;
      document.getElementById('allowCancelDelay').checked = settings.allowCancelDelay;
      document.getElementById('showShortTermGoal').checked = settings.showShortTermGoal;
      document.getElementById('showLongTermGoal').checked = settings.showLongTermGoal;
      
      // Update delay section based on friction mode
      updateDelayAvailability();
      
      // Check if locked
      if (isSettingsLocked()) {
        content.classList.add('locked');
        lockBanner.style.display = 'flex';
        updateLockTimer();
      } else {
        content.classList.remove('locked');
        lockBanner.style.display = 'none';
      }
      
      overlay.classList.add('active');
    }

    function updateDelayAvailability() {
      var frictionMode = document.querySelector('input[name="frictionMode"]:checked').value;
      var delayOptions = document.getElementById('delayOptions');
      var delayNote = document.getElementById('delayDisabledNote');
      
      if (frictionMode === 'full' || frictionMode === 'strict') {
        delayOptions.classList.add('disabled');
        delayNote.style.display = 'block';
        // Reset delay to off when using code friction
        settings.messageDelay = 0;
        document.querySelector('input[name="messageDelay"][value="0"]').checked = true;
        saveSettings();
      } else {
        delayOptions.classList.remove('disabled');
        delayNote.style.display = 'none';
      }
    }

    function hideSettings() {
      document.getElementById('settingsOverlay').classList.remove('active');
    }

    var lockTimerInterval = null;

    function updateLockTimer() {
      var remaining = getRemainingLockTime();
      var timeEl = document.getElementById('lockTimeRemaining');
      
      if (remaining <= 0) {
        settings.lockUntil = null;
        saveSettings();
        document.getElementById('settingsContent').classList.remove('locked');
        document.getElementById('settingsLockBanner').style.display = 'none';
        if (lockTimerInterval) {
          clearInterval(lockTimerInterval);
          lockTimerInterval = null;
        }
        return;
      }
      
      timeEl.textContent = formatLockTime(remaining);
      
      if (!lockTimerInterval) {
        lockTimerInterval = setInterval(updateLockTimer, 1000);
      }
    }

    function lockSettings() {
      var days = parseInt(document.getElementById('lockDays').value, 10) || 0;
      var hours = parseInt(document.getElementById('lockHours').value, 10) || 0;
      var minutes = parseInt(document.getElementById('lockMinutes').value, 10) || 0;
      
      var duration = (days * 24 * 60 * 60 * 1000) + (hours * 60 * 60 * 1000) + (minutes * 60 * 1000);
      
      if (duration < 60000) {
        alert('Please set a lock duration of at least 1 minute.');
        return;
      }
      
      settings.lockUntil = Date.now() + duration;
      saveSettings();
      
      document.getElementById('settingsContent').classList.add('locked');
      document.getElementById('settingsLockBanner').style.display = 'flex';
      updateLockTimer();
    }

    // MESSAGE DELAY OVERLAY
    var delayInterval = null;
    var delayMessage = null;

    function showDelayOverlay(message) {
      delayMessage = message;
      var overlay = document.getElementById('delayOverlay');
      var timeEl = document.getElementById('delayTime');
      var progressEl = document.getElementById('delayRingProgress');
      var hintEl = document.getElementById('delayHint');
      var cancelBtn = document.getElementById('delayCancelBtn');
      
      var totalSeconds = settings.messageDelay;
      var remaining = totalSeconds;
      
      // Set hint based on goal
      var activeGoal = getActiveShortTermGoal();
      if (activeGoal) {
        hintEl.textContent = 'While you wait... "' + activeGoal.text + '"';
      } else {
        hintEl.textContent = 'Take a breath. Is this message necessary?';
      }
      
      // Show/hide cancel button
      if (settings.allowCancelDelay) {
        cancelBtn.classList.remove('hidden');
      } else {
        cancelBtn.classList.add('hidden');
      }
      
      // Set initial state
      timeEl.textContent = remaining;
      progressEl.style.strokeDashoffset = '0';
      
      overlay.classList.add('active');
      
      delayInterval = setInterval(function() {
        remaining--;
        timeEl.textContent = remaining;
        
        // Update progress ring (283 is circumference of circle with r=45)
        var progress = ((totalSeconds - remaining) / totalSeconds) * 283;
        progressEl.style.strokeDashoffset = progress;
        
        if (remaining <= 0) {
          clearInterval(delayInterval);
          delayInterval = null;
          hideDelayOverlay();
          sendMessage(delayMessage);
          delayMessage = null;
        }
      }, 1000);
    }

    function hideDelayOverlay() {
      document.getElementById('delayOverlay').classList.remove('active');
      if (delayInterval) {
        clearInterval(delayInterval);
        delayInterval = null;
      }
    }

    function cancelDelay() {
      hideDelayOverlay();
      delayMessage = null;
    }

    // AUTH STATE
    const GOOGLE_CLIENT_ID = '37442638167-t8m3fql61v05h01qmvall1bki9k88tim.apps.googleusercontent.com';
    const ADMIN_EMAIL = 'fatboydimsim@gmail.com';
    
    let currentUser = null;
    let isAdmin = false;

    // Free models available to everyone, paid models only for admin
    const FREE_MODELS = ['gemini'];
    const PAID_MODELS = ['claude', 'gpt', 'grok', 'perplexity'];

    function loadUserFromStorage() {
      const saved = localStorage.getItem('friction_user');
      if (saved) {
        currentUser = JSON.parse(saved);
        isAdmin = currentUser.email === ADMIN_EMAIL;
        return true;
      }
      return false;
    }

    function saveUserToStorage() {
      if (currentUser) {
        localStorage.setItem('friction_user', JSON.stringify(currentUser));
      } else {
        localStorage.removeItem('friction_user');
      }
    }

    async function handleGoogleSignIn(response) {
      // Decode the JWT token
      const base64Url = response.credential.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const padded = base64 + '==='.slice((base64.length + 3) % 4);
      const payload = JSON.parse(atob(padded));

      currentUser = {
        email: payload.email,
        name: payload.name,
        picture: payload.picture
      };

      // Store the ID token for API authentication
      localStorage.setItem('google_id_token', response.credential);

      isAdmin = currentUser.email === ADMIN_EMAIL;
      saveUserToStorage();

      // Register user with backend (for analytics)
      registerUser(response.credential);

      // Now update UI with restored data
      updateModelAccess();
      updateProfileDisplay();
      updateMenuForAdmin();

      showChat();
    }

    function registerUser(idToken) {
      fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        }
      }).catch(function(err) {
        console.log('User registration skipped:', err);
      });
    }

    // SERVER DATA SYNC
    async function loadUserDataFromServer() {
      return false;
    }

    function saveUserDataToServer() {
      return;
    }

    function signOut() {
      currentUser = null;
      isAdmin = false;
      localStorage.removeItem('friction_user');
      localStorage.removeItem('google_id_token');
      google.accounts.id.disableAutoSelect();
      updateModelAccess();
      showHomepage();
    }

    function updateMenuForAdmin() {
      var adminBtn = document.getElementById('btnAdmin');
      if (adminBtn) {
        adminBtn.style.display = isAdmin ? 'flex' : 'none';
      }
    }

    function updateModelAccess() {
      const options = modelSelect.querySelectorAll('option');
      options.forEach(function(option) {
        const model = option.value;
        if (PAID_MODELS.includes(model) && !isAdmin) {
          option.disabled = true;
          option.textContent = option.textContent.replace(' ðŸ”’', '') + ' ðŸ”’';
        } else {
          option.disabled = false;
          option.textContent = option.textContent.replace(' ðŸ”’', '');
        }
      });

      // If current selection is a paid model and user is not admin, switch to Gemini
      if (PAID_MODELS.includes(modelSelect.value) && !isAdmin) {
        modelSelect.value = 'gemini';
      }
    }

    function getLegalViewFromLocation() {
      var path = window.location.pathname;
      if (path === '/privacy') return 'privacy';
      if (path === '/terms') return 'terms';
      if (path === '/disclaimer') return 'disclaimer';
      return '';
    }

    function handleLegalRoute() {
      var legalView = getLegalViewFromLocation();
      if (!legalView) return false;

      var homepageEl = document.getElementById('homepage');
      var chatAppEl = document.getElementById('chatApp');
      var privacyView = document.getElementById('privacy-view');
      var termsView = document.getElementById('terms-view');
      var disclaimerView = document.getElementById('disclaimer-view');

      if (homepageEl) homepageEl.classList.add('hidden');
      if (chatAppEl) chatAppEl.classList.remove('active');

      if (privacyView) {
        privacyView.classList.toggle('active', legalView === 'privacy');
        privacyView.setAttribute('aria-hidden', legalView === 'privacy' ? 'false' : 'true');
      }
      if (termsView) {
        termsView.classList.toggle('active', legalView === 'terms');
        termsView.setAttribute('aria-hidden', legalView === 'terms' ? 'false' : 'true');
      }
      if (disclaimerView) {
        disclaimerView.classList.toggle('active', legalView === 'disclaimer');
        disclaimerView.setAttribute('aria-hidden', legalView === 'disclaimer' ? 'false' : 'true');
      }

      document.body.classList.add('ready');
      return true;
    }

    function initGoogleSignIn() {
      if (legalRouteActive) return;
      if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: handleGoogleSignIn,
          auto_select: false
        });

        // Render a hidden Google button that we'll click programmatically
        google.accounts.id.renderButton(
          document.getElementById('googleButtonHidden'),
          { theme: 'outline', size: 'large', width: 280 }
        );

        // Check if user already signed in - auto go to chat
        if (loadUserFromStorage()) {
          updateModelAccess();
          updateProfileDisplay();
          showChat();
        } else if (isCalendarImportRoute()) {
          showChat();
        }
        
        // Reveal UI after state is known
        document.body.classList.add('ready');
      } else {
        // Retry if Google script not loaded yet
        setTimeout(initGoogleSignIn, 100);
      }
    }

    var legalRouteActive = handleLegalRoute();

    // Fallback: reveal UI after timeout in case Google script fails
    setTimeout(function() {
      if (!legalRouteActive) {
        document.body.classList.add('ready');
        if (isCalendarImportRoute() && chatApp && !chatApp.classList.contains('active')) {
          showChat();
        }
      }
    }, 1000);

    if (!legalRouteActive) {
      initGoogleSignIn();
    }

    // DOM ELEMENTS
    const homepage = document.getElementById('homepage');
    const chatApp = document.getElementById('chatApp');
    const btnApple = document.getElementById('btnApple');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnEmail = document.getElementById('btnEmail');

    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const btnSend = document.getElementById('btnSend');
    const modelSelect = document.getElementById('modelSelect');
    const btnMenu = document.getElementById('btnMenu');
    const typingIndicator = document.getElementById('typingIndicator');

    // Side menu elements
    const sideMenu = document.getElementById('sideMenu');
    const menuOverlay = document.getElementById('menuOverlay');
    const btnCloseMenu = document.getElementById('btnCloseMenu');
    const btnNewChat = document.getElementById('btnNewChat');
    const btnSignOut = document.getElementById('btnSignOut');
    const btnSettings = document.getElementById('btnSettings');
    const btnAbout = document.getElementById('btnAbout');
    const btnGoals = document.getElementById('btnGoals');
    const btnLife = document.getElementById('btnLife');
    const btnCalendar = document.getElementById('btnCalendar');
    const btnFrictionSocial = document.getElementById('btnFrictionSocial');
    const chatInputArea = document.querySelector('.chat-input-area');

    // Friction Social elements
    const frictionSocialView = document.getElementById('friction-social-view');
    const frictionSocialShelves = document.getElementById('fsShelves');
    const frictionSocialSearch = document.getElementById('fsSearchInput');
    const frictionSocialAdd = document.getElementById('fsAddVideo');
    const frictionSocialAddChannel = document.getElementById('fsAddChannel');
    const frictionSocialRefresh = document.getElementById('fsRefreshChannels');
    const frictionSocialEmpty = document.getElementById('fsEmpty');
    const frictionSocialModal = document.getElementById('fsModal');
    const frictionSocialModalClose = document.getElementById('fsModalClose');
    const frictionSocialModalTitle = document.getElementById('fsModalTitle');
    const frictionSocialModalChannel = document.getElementById('fsModalChannel');
    const frictionSocialModalLink = document.getElementById('fsModalLink');
    const frictionSocialModalFrame = document.getElementById('fsModalFrame');
    const frictionSocialIntroOverlay = document.getElementById('fsIntroOverlay');
    const frictionSocialIntroDismiss = document.getElementById('fsIntroDismiss');
    const frictionSocialIntroContinue = document.getElementById('fsIntroContinue');
    const frictionSocialPauseOverlay = document.getElementById('fsPauseOverlay');
    const frictionSocialPauseTitle = document.getElementById('fsPauseTitle');
    const frictionSocialPausePrompt = document.getElementById('fsPausePrompt');
    const frictionSocialPauseTimer = document.getElementById('fsPauseTimer');
    const frictionSocialPauseWatch = document.getElementById('fsPauseWatch');
    const frictionSocialPauseTake = document.getElementById('fsPauseTake');
    const frictionSocialPauseUpNext = document.getElementById('fsPauseUpNext');
    const frictionSocialPauseSkip = document.getElementById('fsPauseSkip');
    const frictionSocialPauseDone = document.getElementById('fsPauseDone');
    const frictionSocialPauseUpNextPanel = document.getElementById('fsPauseUpNextPanel');
    const frictionSocialPauseGoalText = document.getElementById('fsPauseGoalText');
    const frictionSocialPauseGoalDone = document.getElementById('fsPauseGoalDone');
    const frictionSocialPauseContinue = document.getElementById('fsPauseContinue');
    const frictionSocialFrictionEnabled = document.getElementById('fsFrictionEnabled');
    const frictionSocialFrequencyInputs = document.querySelectorAll('input[name="fsFrictionFrequency"]');
    const frictionSocialPauseInputs = document.querySelectorAll('input[name="fsPauseSeconds"]');
    const goalsView = document.getElementById('goals-view');
    const lifeView = document.getElementById('life-view');
    const lifeProfilePic = document.getElementById('lifeProfilePic');
    const lifeProfileEmail = document.getElementById('lifeProfileEmail');
    const lifeDomainStrip = document.getElementById('lifeDomainStrip');
    const lifeNodeStrip = document.getElementById('lifeNodeStrip');
    const lifeDomainPanel = document.getElementById('lifeDomainPanel');
    const calendarView = document.getElementById('calendar-view');
    const calendarImportView = document.getElementById('calendar-import-view');
    const goalsAreaFilter = document.getElementById('goalsAreaFilter');
    const shortGoalInput = document.getElementById('shortGoalInput');
    const shortGoalAdd = document.getElementById('shortGoalAdd');
    const shortGoalList = document.getElementById('shortGoalList');
    const shortGoalClear = document.getElementById('shortGoalClear');
    const shortGoalArea = document.getElementById('shortGoalArea');
    const longGoalForm = document.getElementById('longGoalForm');
    const longGoalTitle = document.getElementById('longGoalTitle');
    const longGoalDate = document.getElementById('longGoalDate');
    const longGoalNote = document.getElementById('longGoalNote');
    const longGoalAdd = document.getElementById('longGoalAdd');
    const longGoalCancel = document.getElementById('longGoalCancel');
    const longGoalList = document.getElementById('longGoalList');
    const longGoalArea = document.getElementById('longGoalArea');
    const goalsUnstuckPanel = document.getElementById('goalsUnstuckPanel');
    const goalsNudge = document.getElementById('goalsNudge');
    const goalsNudgeBtn = document.getElementById('goalsNudgeBtn');

    const lifeAreaFilter = document.getElementById('lifeAreaFilter');
    const lifeTabs = document.getElementById('lifeTabs');
    const lifeAddPersonPrimary = document.getElementById('lifeAddPersonPrimary');
    const lifePeopleForm = document.getElementById('lifePeopleForm');
    const lifePeopleFormTitle = document.getElementById('lifePeopleFormTitle');
    const lifePeopleFormCancel = document.getElementById('lifePeopleFormCancel');
    const lifePeopleSave = document.getElementById('lifePeopleSave');
    const lifePeopleList = document.getElementById('lifePeopleList');
    const lifePersonName = document.getElementById('lifePersonName');
    const lifePersonRole = document.getElementById('lifePersonRole');
    const lifePersonCustomRole = document.getElementById('lifePersonCustomRole');
    const lifePersonOrg = document.getElementById('lifePersonOrg');
    const lifePersonDob = document.getElementById('lifePersonDob');
    const lifePersonNotes = document.getElementById('lifePersonNotes');
    const lifeAvatarUpload = document.getElementById('lifeAvatarUpload');
    const lifeAvatarRandom = document.getElementById('lifeAvatarRandom');
    const lifeAvatarPreview = document.getElementById('lifeAvatarPreview');
    const lifeAvatarHint = document.getElementById('lifeAvatarHint');
    const lifePersonView = document.getElementById('lifePersonView');
    const lifePersonBack = document.getElementById('lifePersonBack');
    const lifePersonAvatar = document.getElementById('lifePersonAvatar');
    const lifePersonNameDisplay = document.getElementById('lifePersonNameDisplay');
    const lifePersonRoleDisplay = document.getElementById('lifePersonRoleDisplay');
    const lifePersonOrgDisplay = document.getElementById('lifePersonOrgDisplay');
    const lifeAppointmentsToggle = document.getElementById('lifeAppointmentsToggle');
    const lifeAppointmentsBody = document.getElementById('lifeAppointmentsBody');
    const lifeAppointmentsAdd = document.getElementById('lifeAppointmentsAdd');
    const lifeAppointmentsScan = document.getElementById('lifeAppointmentsScan');
    const lifeAppointmentsList = document.getElementById('lifeAppointmentsList');
    const lifeAppointmentsPastToggle = document.getElementById('lifeAppointmentsPastToggle');
    const lifeAppointmentsPast = document.getElementById('lifeAppointmentsPast');
    const lifeTasksToggle = document.getElementById('lifeTasksToggle');
    const lifeTasksBody = document.getElementById('lifeTasksBody');
    const lifeTasksAddTrigger = document.getElementById('lifeTasksAddTrigger');
    const lifeTasksForm = document.getElementById('lifeTasksForm');
    const lifeTasksTitle = document.getElementById('lifeTasksTitle');
    const lifeTasksNotes = document.getElementById('lifeTasksNotes');
    const lifeTasksBarrier = document.getElementById('lifeTasksBarrier');
    const lifeTasksSave = document.getElementById('lifeTasksSave');
    const lifeTasksCancel = document.getElementById('lifeTasksCancel');
    const lifeTasksList = document.getElementById('lifeTasksList');
    const lifeTasksCompletedToggle = document.getElementById('lifeTasksCompletedToggle');
    const lifeTasksCompleted = document.getElementById('lifeTasksCompleted');
    const lifeAppointmentModal = document.getElementById('lifeAppointmentModal');
    const lifeAppointmentForm = document.getElementById('lifeAppointmentForm');
    const lifeAppointmentPersonRow = document.getElementById('lifeAppointmentPersonRow');
    const lifeAppointmentPerson = document.getElementById('lifeAppointmentPerson');
    const lifeAppointmentTitle = document.getElementById('lifeAppointmentModalTitle');
    const lifeAppointmentScanTake = document.getElementById('lifeAppointmentScanTake');
    const lifeAppointmentScanUpload = document.getElementById('lifeAppointmentScanUpload');
    const lifeAppointmentScanTakeInput = document.getElementById('lifeAppointmentScanTakeInput');
    const lifeAppointmentScanUploadInput = document.getElementById('lifeAppointmentScanUploadInput');
    const lifeAppointmentScanImageBtn = document.getElementById('lifeAppointmentScanImageBtn');
    const lifeAppointmentScanPreview = document.getElementById('lifeAppointmentScanPreview');
    const lifeAppointmentScanImage = document.getElementById('lifeAppointmentScanImage');
    const lifeAppointmentTextInput = document.getElementById('lifeAppointmentTextInput');
    const lifeAppointmentParseBtn = document.getElementById('lifeAppointmentParseBtn');
    const lifeAppointmentOriginalDetails = document.getElementById('lifeAppointmentOriginalDetails');
    const lifeAppointmentOriginalText = document.getElementById('lifeAppointmentOriginalText');
    const lifeAppointmentSummary = document.getElementById('lifeAppointmentSummary');
    const lifeAppointmentSummaryRows = document.getElementById('lifeAppointmentSummaryRows');
    const lifeAppointmentSummarySave = document.getElementById('lifeAppointmentSummarySave');
    const lifeAppointmentSummaryDiscard = document.getElementById('lifeAppointmentSummaryDiscard');
    const lifeAppointmentFormFields = document.getElementById('lifeAppointmentFormFields');
    const lifeAppointmentTitleInput = document.getElementById('lifeAppointmentTitleInput');
    const lifeAppointmentDate = document.getElementById('lifeAppointmentDate');
    const lifeAppointmentTime = document.getElementById('lifeAppointmentTime');
    const lifeAppointmentClinic = document.getElementById('lifeAppointmentClinic');
    const lifeAppointmentDoctor = document.getElementById('lifeAppointmentDoctor');
    const lifeAppointmentAddress = document.getElementById('lifeAppointmentAddress');
    const lifeAppointmentPhone = document.getElementById('lifeAppointmentPhone');
    const lifeAppointmentNotes = document.getElementById('lifeAppointmentNotes');
    const lifeAppointmentSave = document.getElementById('lifeAppointmentSave');
    const lifeAppointmentDelete = document.getElementById('lifeAppointmentDelete');
    const lifeAppointmentClose = document.getElementById('lifeAppointmentClose');
    const lifeBubbleStrip = document.getElementById('lifeBubbleStrip');
    const lifeGroupToggle = document.getElementById('lifeGroupToggle');
    const lifeGroupPanel = document.getElementById('lifeGroupPanel');
    const lifeActiveAvatar = document.getElementById('lifeActiveAvatar');
    const lifeActiveName = document.getElementById('lifeActiveName');
    const lifeActiveRole = document.getElementById('lifeActiveRole');
    const lifeActiveDob = document.getElementById('lifeActiveDob');
    const lifeActiveNotes = document.getElementById('lifeActiveNotes');
    const lifeEditToggle = document.getElementById('lifeEditToggle');
    const lifeEditButton = document.getElementById('lifeEditButton');
    const lifeCustomizeButton = document.getElementById('lifeCustomizeButton');
    const lifeRemoveButton = document.getElementById('lifeRemoveButton');
    const lifeActiveEdit = document.getElementById('lifeActiveEdit');
    const lifeEditForm = document.getElementById('lifeEditForm');
    const lifeEditName = document.getElementById('lifeEditName');
    const lifeEditRole = document.getElementById('lifeEditRole');
    const lifeEditRoleCustom = document.getElementById('lifeEditRoleCustom');
    const lifeEditDob = document.getElementById('lifeEditDob');
    const lifeEditNotes = document.getElementById('lifeEditNotes');
    const lifeEditError = document.getElementById('lifeEditError');
    const lifeEditSave = document.getElementById('lifeEditSave');
    const lifeEditCancel = document.getElementById('lifeEditCancel');
    const lifePersonModal = document.getElementById('lifePersonModal');
    const lifePersonModalClose = document.getElementById('lifePersonModalClose');
    const lifePersonForm = document.getElementById('lifePersonForm');
    const lifePersonNameInput = document.getElementById('lifePersonNameInput');
    const lifePersonRoleInput = document.getElementById('lifePersonRoleInput');
    const lifePersonRoleCustomInput = document.getElementById('lifePersonRoleCustomInput');
    const lifePersonDobInput = document.getElementById('lifePersonDobInput');
    const lifePersonNotesInput = document.getElementById('lifePersonNotesInput');
    const lifePersonPhotoInput = document.getElementById('lifePersonPhotoInput');
    const lifePersonPhotoPreview = document.getElementById('lifePersonPhotoPreview');
    const lifePersonError = document.getElementById('lifePersonError');
    const lifePersonCancel = document.getElementById('lifePersonCancel');
    const lifeRemoveModal = document.getElementById('lifeRemoveModal');
    const lifeRemoveModalClose = document.getElementById('lifeRemoveModalClose');
    const lifeRemoveModalText = document.getElementById('lifeRemoveModalText');
    const lifeRemoveConfirm = document.getElementById('lifeRemoveConfirm');
    const lifeRemoveCancel = document.getElementById('lifeRemoveCancel');
    const lifePrefsModal = document.getElementById('lifePrefsModal');
    const lifePrefsModalClose = document.getElementById('lifePrefsModalClose');
    const lifePrefsForm = document.getElementById('lifePrefsForm');
    const lifePrefsCancel = document.getElementById('lifePrefsCancel');
    const lifeMemberPanel = document.getElementById('lifeMemberPanel');
    const lifeMemberPanelClose = document.getElementById('lifeMemberPanelClose');
    const lifeMemberName = document.getElementById('lifeMemberName');
    const lifeMemberRoleType = document.getElementById('lifeMemberRoleType');
    const lifeBubbleMenuOverlay = document.getElementById('lifeBubbleMenuOverlay');
    const lifeBubbleMenu = document.getElementById('lifeBubbleMenu');
    const lifeAgendaRange = document.getElementById('lifeAgendaRange');
    const lifeAgendaList = document.getElementById('lifeAgendaList');
    const lifePersonNowList = document.getElementById('lifePersonNowList');
    const lifePersonComingList = document.getElementById('lifePersonComingList');
    const lifePersonParkedList = document.getElementById('lifePersonParkedList');
    const lifePersonParkedToggle = document.getElementById('lifePersonParkedToggle');
    const lifePersonTaskText = document.getElementById('lifePersonTaskText');
    const lifePersonTaskAdd = document.getElementById('lifePersonTaskAdd');
    const lifePersonApptTitle = document.getElementById('lifePersonApptTitle');
    const lifePersonApptStart = document.getElementById('lifePersonApptStart');
    const lifePersonApptAdd = document.getElementById('lifePersonApptAdd');
    const lifePersonGoalText = document.getElementById('lifePersonGoalText');
    const lifePersonGoalAdd = document.getElementById('lifePersonGoalAdd');
    const lifeTodayList = document.getElementById('lifeTodayList');
    const lifeGoalsList = document.getElementById('lifeGoalsList');
    const lifeTaskText = document.getElementById('lifeTaskText');
    const lifeTaskArea = document.getElementById('lifeTaskArea');
    const lifeTaskTags = document.getElementById('lifeTaskTags');
    const lifeTaskDue = document.getElementById('lifeTaskDue');
    const lifeTaskNeedsPeople = document.getElementById('lifeTaskNeedsPeople');
    const lifeTaskNeedsAppt = document.getElementById('lifeTaskNeedsAppt');
    const lifeTaskEnergy = document.getElementById('lifeTaskEnergy');
    const lifeTaskAdd = document.getElementById('lifeTaskAdd');
    const lifeTaskCancel = document.getElementById('lifeTaskCancel');
    const lifeTaskList = document.getElementById('lifeTaskList');
    const lifeUnstuckPanel = document.getElementById('lifeUnstuckPanel');
    const lifeApptTitle = document.getElementById('lifeApptTitle');
    const lifeApptArea = document.getElementById('lifeApptArea');
    const lifeApptStart = document.getElementById('lifeApptStart');
    const lifeApptEnd = document.getElementById('lifeApptEnd');
    const lifeApptLocation = document.getElementById('lifeApptLocation');
    const lifeApptNotes = document.getElementById('lifeApptNotes');
    const lifeApptLinkedTasks = document.getElementById('lifeApptLinkedTasks');
    const lifeApptAdd = document.getElementById('lifeApptAdd');
    const lifeApptCancel = document.getElementById('lifeApptCancel');
    const lifeCalendarList = document.getElementById('lifeCalendarList');
    const lifeFrictionEnabled = document.getElementById('lifeFrictionEnabled');
    const lifeChildName = document.getElementById('lifeChildName');
    const lifeAddChild = document.getElementById('lifeAddChild');
    const lifeAreasList = document.getElementById('lifeAreasList');
    const lifeFrictionFrequencyInputs = document.querySelectorAll('input[name="lifeFrictionFrequency"]');
    const lifePauseInputs = document.querySelectorAll('input[name="lifePauseSeconds"]');

    const appointmentsView = document.getElementById('appointments-view');
    const appointmentsAddGlobal = document.getElementById('appointmentsAddGlobal');
    const appointmentsFilters = document.getElementById('appointmentsFilters');
    const appointmentsFeed = document.getElementById('appointmentsFeed');
    const appointmentsPastToggle = document.getElementById('appointmentsPastToggle');
    const appointmentsPastFeed = document.getElementById('appointmentsPastFeed');
    const appointmentsModal = document.getElementById('appointmentsModal');
    const appointmentsModalTitle = document.getElementById('appointmentsModalTitle');
    const appointmentsModalForm = document.getElementById('appointmentsModalForm');
    const appointmentsModalPerson = document.getElementById('appointmentsModalPerson');
    const appointmentsModalTitleInput = document.getElementById('appointmentsModalTitleInput');
    const appointmentsModalDate = document.getElementById('appointmentsModalDate');
    const appointmentsModalTime = document.getElementById('appointmentsModalTime');
    const appointmentsModalClinic = document.getElementById('appointmentsModalClinic');
    const appointmentsModalDoctor = document.getElementById('appointmentsModalDoctor');
    const appointmentsModalAddress = document.getElementById('appointmentsModalAddress');
    const appointmentsModalPhone = document.getElementById('appointmentsModalPhone');
    const appointmentsModalNotes = document.getElementById('appointmentsModalNotes');
    const appointmentsModalSave = document.getElementById('appointmentsModalSave');
    const appointmentsModalDelete = document.getElementById('appointmentsModalDelete');
    const appointmentsModalClose = document.getElementById('appointmentsModalClose');
    const appointmentsScanTake = document.getElementById('appointmentsScanTake');
    const appointmentsScanUpload = document.getElementById('appointmentsScanUpload');
    const appointmentsScanTakeInput = document.getElementById('appointmentsScanTakeInput');
    const appointmentsScanUploadInput = document.getElementById('appointmentsScanUploadInput');
    const appointmentsScanPreview = document.getElementById('appointmentsScanPreview');
    const appointmentsScanImage = document.getElementById('appointmentsScanImage');
    const appointmentsTextInput = document.getElementById('appointmentsTextInput');
    const appointmentsParseBtn = document.getElementById('appointmentsParseBtn');
    const appointmentsAiBtn = document.getElementById('appointmentsAiBtn');
    const appointmentsOriginalDetails = document.getElementById('appointmentsOriginalDetails');
    const appointmentsOriginalText = document.getElementById('appointmentsOriginalText');
    const appointmentsSummary = document.getElementById('appointmentsSummary');
    const appointmentsSummaryRows = document.getElementById('appointmentsSummaryRows');
    const appointmentsSummarySave = document.getElementById('appointmentsSummarySave');
    const appointmentsSummaryDiscard = document.getElementById('appointmentsSummaryDiscard');
    const appointmentsFormFields = document.getElementById('appointmentsFormFields');

    if (lifeAppointmentModal) {
      appointmentModalContexts.life = {
        source: 'life',
        modal: lifeAppointmentModal,
        form: lifeAppointmentForm,
        personRow: lifeAppointmentPersonRow,
        personSelect: lifeAppointmentPerson,
        title: lifeAppointmentTitle,
        scanTakeBtn: lifeAppointmentScanTake,
        scanUploadBtn: lifeAppointmentScanUpload,
        scanTakeInput: lifeAppointmentScanTakeInput,
        scanUploadInput: lifeAppointmentScanUploadInput,
        scanImageBtn: lifeAppointmentScanImageBtn,
        scanPreview: lifeAppointmentScanPreview,
        scanImage: lifeAppointmentScanImage,
        textInput: lifeAppointmentTextInput,
        parseBtn: lifeAppointmentParseBtn,
        originalDetails: lifeAppointmentOriginalDetails,
        originalText: lifeAppointmentOriginalText,
        summary: lifeAppointmentSummary,
        summaryRows: lifeAppointmentSummaryRows,
        summarySaveBtn: lifeAppointmentSummarySave,
        summaryDiscardBtn: lifeAppointmentSummaryDiscard,
        formFields: lifeAppointmentFormFields,
        titleInput: lifeAppointmentTitleInput,
        dateInput: lifeAppointmentDate,
        timeInput: lifeAppointmentTime,
        clinicInput: lifeAppointmentClinic,
        doctorInput: lifeAppointmentDoctor,
        addressInput: lifeAppointmentAddress,
        phoneInput: lifeAppointmentPhone,
        notesInput: lifeAppointmentNotes,
        saveBtn: lifeAppointmentSave,
        deleteBtn: lifeAppointmentDelete,
        closeBtn: lifeAppointmentClose
      };
    }

    if (appointmentsModal) {
      appointmentModalContexts.calendar = {
        source: 'calendar',
        modal: appointmentsModal,
        form: appointmentsModalForm,
        personRow: null,
        personSelect: appointmentsModalPerson,
        title: appointmentsModalTitle,
        titleInput: appointmentsModalTitleInput,
        dateInput: appointmentsModalDate,
        timeInput: appointmentsModalTime,
        clinicInput: appointmentsModalClinic,
        doctorInput: appointmentsModalDoctor,
        addressInput: appointmentsModalAddress,
        phoneInput: appointmentsModalPhone,
        notesInput: appointmentsModalNotes,
        saveBtn: appointmentsModalSave,
        deleteBtn: appointmentsModalDelete,
        closeBtn: appointmentsModalClose,
        scanTakeBtn: appointmentsScanTake,
        scanUploadBtn: appointmentsScanUpload,
        scanTakeInput: appointmentsScanTakeInput,
        scanUploadInput: appointmentsScanUploadInput,
        scanPreview: appointmentsScanPreview,
        scanImage: appointmentsScanImage,
        textInput: appointmentsTextInput,
        parseBtn: appointmentsParseBtn,
        aiBtn: appointmentsAiBtn,
        originalDetails: appointmentsOriginalDetails,
        originalText: appointmentsOriginalText,
        summary: appointmentsSummary,
        summaryRows: appointmentsSummaryRows,
        summarySaveBtn: appointmentsSummarySave,
        summaryDiscardBtn: appointmentsSummaryDiscard,
        formFields: appointmentsFormFields
      };
    }

    const calendarMonthLabel = document.getElementById('calendarMonthLabel');
    const calendarGrid = document.getElementById('calendarGrid');
    const calendarPrevMonth = document.getElementById('calendarPrevMonth');
    const calendarNextMonth = document.getElementById('calendarNextMonth');
    const calendarAddEvent = document.getElementById('calendarAddEvent');
    const calendarDayModal = document.getElementById('calendarDayModal');
    const calendarDayTitle = document.getElementById('calendarDayTitle');
    const calendarDaySubtitle = document.getElementById('calendarDaySubtitle');
    const calendarDayList = document.getElementById('calendarDayList');
    const calendarDayAdd = document.getElementById('calendarDayAdd');
    const calendarDayClose = document.getElementById('calendarDayClose');
    const calendarEventModal = document.getElementById('calendarEventModal');
    const calendarEventTitle = document.getElementById('calendarEventTitle');
    const calendarEventForm = document.getElementById('calendarEventForm');
    const calendarEventPerson = document.getElementById('calendarEventPerson');
    const calendarEventPersonAvatar = document.getElementById('calendarEventPersonAvatar');
    const calendarEventTitleInput = document.getElementById('calendarEventTitleInput');
    const calendarEventDate = document.getElementById('calendarEventDate');
    const calendarEventAllDay = document.getElementById('calendarEventAllDay');
    const calendarEventTimeRow = document.getElementById('calendarEventTimeRow');
    const calendarEventStart = document.getElementById('calendarEventStart');
    const calendarEventEnd = document.getElementById('calendarEventEnd');
    const calendarEventLocation = document.getElementById('calendarEventLocation');
    const calendarEventNotes = document.getElementById('calendarEventNotes');
    const calendarEventRepeat = document.getElementById('calendarEventRepeat');
    const calendarCustomWeekdays = document.getElementById('calendarCustomWeekdays');
    const calendarCustomUntil = document.getElementById('calendarCustomUntil');
    const calendarEventSave = document.getElementById('calendarEventSave');
    const calendarEventDelete = document.getElementById('calendarEventDelete');
    const calendarEventClose = document.getElementById('calendarEventClose');
    const calendarEventDirections = document.getElementById('calendarEventDirections');
    const calendarImportForm = document.getElementById('calendarImportForm');
    const calendarImportPerson = document.getElementById('calendarImportPerson');
    const calendarImportTitle = document.getElementById('calendarImportTitle');
    const calendarImportDate = document.getElementById('calendarImportDate');
    const calendarImportAllDay = document.getElementById('calendarImportAllDay');
    const calendarImportTimeRow = document.getElementById('calendarImportTimeRow');
    const calendarImportStart = document.getElementById('calendarImportStart');
    const calendarImportEnd = document.getElementById('calendarImportEnd');
    const calendarImportLocation = document.getElementById('calendarImportLocation');
    const calendarImportDirections = document.getElementById('calendarImportDirections');
    const calendarImportNotes = document.getElementById('calendarImportNotes');
    const calendarImportNotesDetails = document.getElementById('calendarImportNotesDetails');
    const calendarImportOriginalDetails = document.getElementById('calendarImportOriginalDetails');
    const calendarImportOriginal = document.getElementById('calendarImportOriginal');
    const calendarImportSave = document.getElementById('calendarImportSave');
    const calendarImportCancel = document.getElementById('calendarImportCancel');
    const calendarImportSuccess = document.getElementById('calendarImportSuccess');
    const calendarImportBack = document.getElementById('calendarImportBack');
    const calendarImportBackPerson = document.getElementById('calendarImportBackPerson');
    const calendarImportAddAnother = document.getElementById('calendarImportAddAnother');
    
    // Profile elements
    const profilePic = document.getElementById('profilePic');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');

    // Onboarding elements
    const onboardingOverlay = document.getElementById('onboardingOverlay');
    const goalCheckinOverlay = document.getElementById('goalCheckinOverlay');

    // ONBOARDING EVENT LISTENERS
    document.getElementById('onboardingNext1').addEventListener('click', function() {
      document.getElementById('onboardingStep1').classList.remove('active');
      document.getElementById('onboardingStep2').classList.add('active');
    });

    document.getElementById('onboardingBack2').addEventListener('click', function() {
      document.getElementById('onboardingStep2').classList.remove('active');
      document.getElementById('onboardingStep1').classList.add('active');
    });

    document.getElementById('onboardingNext2').addEventListener('click', function() {
      goals.longterm = document.getElementById('inputLongtermGoal').value.trim();
      document.getElementById('onboardingStep2').classList.remove('active');
      document.getElementById('onboardingStep3').classList.add('active');
    });

    document.getElementById('onboardingBack3').addEventListener('click', function() {
      document.getElementById('onboardingStep3').classList.remove('active');
      document.getElementById('onboardingStep2').classList.add('active');
    });

    document.getElementById('addShorttermGoal').addEventListener('click', function() {
      var list = document.getElementById('shorttermGoalsList');
      var input = document.createElement('input');
      input.type = 'text';
      input.className = 'shortterm-goal-input';
      input.placeholder = 'Another goal...';
      input.maxLength = 60;
      list.appendChild(input);
      input.focus();
    });

    document.getElementById('onboardingNext3').addEventListener('click', function() {
      var inputs = document.querySelectorAll('#shorttermGoalsList .shortterm-goal-input');
      goals.shortterm = [];
      inputs.forEach(function(input) {
        var text = input.value.trim();
        if (text) {
          goals.shortterm.push({ text: text, completed: false, createdAt: Date.now() });
        }
      });
      
      // Show summary
      var summary = document.getElementById('onboardingSummary');
      var html = '';
      if (goals.longterm) {
        html += '<div class="onboarding-summary-item">';
        html += '<div class="onboarding-summary-label">Long-term goal</div>';
        html += '<div class="onboarding-summary-text">"' + goals.longterm + '"</div>';
        html += '</div>';
      }
      if (goals.shortterm.length > 0) {
        html += '<div class="onboarding-summary-item">';
        html += '<div class="onboarding-summary-label">Short-term goals</div>';
        goals.shortterm.forEach(function(g) {
          html += '<div class="onboarding-summary-text">â€¢ ' + g.text + '</div>';
        });
        html += '</div>';
      }
      summary.innerHTML = html || '<p>No goals set - you can add them later from the menu.</p>';
      
      document.getElementById('onboardingStep3').classList.remove('active');
      document.getElementById('onboardingStep4').classList.add('active');
    });

    document.getElementById('onboardingFinish').addEventListener('click', function() {
      goals.onboardingComplete = true;
      goals.lastGoalCheck = Date.now();
      goals.lastGoalTick = Date.now();
      saveGoals();
      hideOnboarding();
      updateBackgroundGoal();
    });

    // Goal check-in listeners
    document.getElementById('checkinSkip').addEventListener('click', function() {
      goals.lastGoalCheck = Date.now();
      saveGoals();
      hideGoalCheckin();
    });

    document.getElementById('checkinSave').addEventListener('click', function() {
      // Remove completed goals and prompt for new ones if all done
      var hasIncomplete = goals.shortterm.some(function(g) { return !g.completed; });
      
      goals.lastGoalCheck = Date.now();
      goals.lastGoalTick = Date.now();
      saveGoals();
      hideGoalCheckin();
      
      if (!hasIncomplete) {
        // All goals completed - could prompt for new ones
        // For now just clear completed and let them add via menu
        goals.shortterm = goals.shortterm.filter(function(g) { return !g.completed; });
        saveGoals();
      }
    });

    function updateProfileDisplay() {
      if (currentUser) {
        profilePic.src = currentUser.picture || '';
        profilePic.style.display = currentUser.picture ? 'block' : 'none';
        profileName.textContent = currentUser.name || 'User';
        profileEmail.textContent = currentUser.email || '';
        if (lifeProfilePic) {
          lifeProfilePic.src = currentUser.picture || '';
          lifeProfilePic.style.display = currentUser.picture ? 'block' : 'none';
        }
        if (lifeProfileEmail) {
          lifeProfileEmail.textContent = currentUser.email || '';
        }
        renderPeopleOverview();
        if (typeof renderCalendarPeopleOptions === 'function') {
          renderCalendarPeopleOptions();
        }
      }
    }

    const frictionOverlay = document.getElementById('frictionOverlay');
    const frictionPairs1 = document.getElementById('frictionPairs1');
    const frictionPairs2 = document.getElementById('frictionPairs2');
    const frictionCancel = document.getElementById('frictionCancel');
    const frictionUnlock = document.getElementById('frictionUnlock');
    const frictionError = document.getElementById('frictionError');

    // SCROLL LOCK
    let _scrollYBeforeLock = 0;

    function lockBodyScroll() {
      if (document.body.classList.contains('scroll-locked')) return;
      _scrollYBeforeLock = window.scrollY || 0;
      document.body.classList.add('scroll-locked');
      document.body.style.top = '-' + _scrollYBeforeLock + 'px';
    }

    function unlockBodyScroll() {
      if (!document.body.classList.contains('scroll-locked')) return;
      document.body.classList.remove('scroll-locked');
      document.body.style.top = '';
      window.scrollTo(0, _scrollYBeforeLock || 0);
    }

    function preventTouchMove(e) {
      const box = document.querySelector('.friction-box');
      if (box && box.contains(e.target)) return;
      e.preventDefault();
    }

    // CODE GENERATION
    function generateChallenge(length) {
      const lower = 'abcdefghjkmnpqrstuvwxyz';
      const upper = 'ABCDEFGHJKMNPQRSTUVWXYZ';
      const numbers = '23456789';
      const symbols = '!@#$%&*^~+-=<>?';

      let result = '';
      for (let i = 0; i < length; i++) {
        const pattern = i % 4;
        let charSet;
        if (pattern === 0) charSet = lower;
        else if (pattern === 1) charSet = symbols;
        else if (pattern === 2) charSet = upper;
        else charSet = numbers;
        result += charSet.charAt(Math.floor(Math.random() * charSet.length));
      }
      return result;
    }

    // NAVIGATION
    function restoreChatUI() {
      if (state.messages.length > 0) {
        // Remove welcome message
        const welcome = chatMessages.querySelector('.welcome-message');
        if (welcome) welcome.remove();
        
        // Clear existing messages (except typing indicator)
        const existingMessages = chatMessages.querySelectorAll('.message');
        existingMessages.forEach(function(msg) { msg.remove(); });
        
        // Render all saved messages
        state.messages.forEach(function(msg) {
          const type = msg.role === 'assistant' ? 'ai' : 'user';
          addMessage(msg.content, type);
        });
      }
      
      // Restore model selection
      if (state.currentModel && modelSelect) {
        modelSelect.value = state.currentModel;
      }
    }

    function showChat() {
      // Load saved chat before showing
      loadChatState();
      loadGoals();
      loadSettings();
      
      // Check if session has expired (2 hours = same as friction reset)
      const SESSION_TIMEOUT = 2 * 60 * 60 * 1000; // 2 hours
      const lastActivity = localStorage.getItem('friction_last_activity');
      
      if (lastActivity) {
        const elapsed = Date.now() - parseInt(lastActivity, 10);
        if (elapsed > SESSION_TIMEOUT && state.messages.length > 0) {
          // Save current chat to history before clearing
          saveCurrentChatToHistory();
          // Start fresh
          state.messages = [];
          state.currentChatId = generateChatId();
          localStorage.removeItem('friction_chat');
        }
      }
      
      // Update last activity
      localStorage.setItem('friction_last_activity', Date.now().toString());
      
      homepage.classList.add('hidden');
      chatApp.classList.add('active');

      setActiveView(getViewFromLocation(), false);
      
      // Restore chat messages (or show welcome if empty)
      if (state.messages.length > 0) {
        restoreChatUI();
      }
      
      // Check if onboarding needed
      if (shouldShowOnboarding()) {
        showOnboarding();
      } else if (shouldShowGoalCheckin()) {
        showGoalCheckin();
      }
      
      // Update background goal
      updateBackgroundGoal();
      
      if (lastMessageTime && frictionLevel > 0) startHeaderTimer();
      updateKeyboardOffset();
      scrollChatToBottom();
    }

    function showHomepage() {
      chatApp.classList.remove('active');
      homepage.classList.remove('hidden');
      clearChatState();
      chatMessages.innerHTML = '<div class="chat-background-goal" id="chatBackgroundGoal"></div><div class="welcome-message"><div class="welcome-icon">âœ¦</div><h2>How can I help you today?</h2><p>Remember: slow is intentional.</p></div>';
      document.documentElement.style.setProperty('--kb', '0px');
    }

    // VIEW NAVIGATION
    var activeView = 'chat';

    function getViewFromLocation() {
      if (isCalendarImportRoute()) return 'life';
      if (window.location.hash === '#friction-social') return 'social';
      if (window.location.hash === '#goals') return 'goals';
      if (window.location.hash === '#life') return 'life';
      if (window.location.hash === '#calendar') return 'life';
      return 'chat';
    }

    function updateMenuActive(view) {
      if (!btnFrictionSocial) return;
      if (view === 'social') {
        btnFrictionSocial.style.background = 'var(--teal-lighter)';
        btnFrictionSocial.style.color = 'var(--text-primary)';
      } else {
        btnFrictionSocial.style.background = '';
        btnFrictionSocial.style.color = '';
      }
      if (btnGoals) {
        if (view === 'goals') {
          btnGoals.style.background = 'var(--teal-lighter)';
          btnGoals.style.color = 'var(--text-primary)';
        } else {
          btnGoals.style.background = '';
          btnGoals.style.color = '';
        }
      }
      if (btnLife) {
        if (view === 'life') {
          btnLife.style.background = 'var(--teal-lighter)';
          btnLife.style.color = 'var(--text-primary)';
        } else {
          btnLife.style.background = '';
          btnLife.style.color = '';
        }
      }
      if (btnCalendar) {
        if (view === 'calendar') {
          btnCalendar.style.background = 'var(--teal-lighter)';
          btnCalendar.style.color = 'var(--text-primary)';
        } else {
          btnCalendar.style.background = '';
          btnCalendar.style.color = '';
        }
      }
    }

    function openPendingPersonFromStorage() {
      var pendingId = localStorage.getItem('life_focus_person_id');
      if (!pendingId) return;
      var person = getPersonById(pendingId);
      if (person) {
        openPersonView(person);
      }
      localStorage.removeItem('life_focus_person_id');
    }

    function setActiveView(view, pushState) {
      if (view === 'calendar' || view === 'calendar-import') {
        view = 'life';
      }
      activeView = view;
      var showSocial = view === 'social';
      var showGoals = view === 'goals';
      var showLife = view === 'life';
      var showCalendar = view === 'calendar';
      var showCalendarImport = view === 'calendar-import';
      frictionSocialView.classList.toggle('active', showSocial);
      frictionSocialView.setAttribute('aria-hidden', showSocial ? 'false' : 'true');
      goalsView.classList.toggle('active', showGoals);
      goalsView.setAttribute('aria-hidden', showGoals ? 'false' : 'true');
      if (lifeView) {
        lifeView.classList.toggle('active', showLife);
        lifeView.setAttribute('aria-hidden', showLife ? 'false' : 'true');
      }
      if (calendarView) {
        calendarView.classList.toggle('active', showCalendar);
        calendarView.setAttribute('aria-hidden', showCalendar ? 'false' : 'true');
      }
      if (calendarImportView) {
        calendarImportView.classList.toggle('active', showCalendarImport);
        calendarImportView.setAttribute('aria-hidden', showCalendarImport ? 'false' : 'true');
      }
      var showChat = view === 'chat';
      chatMessages.style.display = showChat ? '' : 'none';
      typingIndicator.style.display = showChat ? '' : 'none';
      chatInputArea.style.display = showChat ? '' : 'none';
      updateMenuActive(view);
      if (pushState) {
        var nextHash = '#chat';
        if (view === 'social') nextHash = '#friction-social';
        if (view === 'goals') nextHash = '#goals';
        if (view === 'life') nextHash = '#life';
        history.pushState({ view: view }, '', nextHash);
      }
      if (showSocial) {
        showFrictionSocialIntroIfNeeded();
      } else {
        hideFrictionSocialIntro();
        hideFrictionSocialPauseOverlay();
        if (showCalendar) {
          renderAppointmentsView();
        }
        if (showCalendarImport) {
          populateCalendarImportForm();
        }
        if (showLife) {
          openPendingPersonFromStorage();
        }
      }
    }

    window.addEventListener('popstate', function() {
      setActiveView(getViewFromLocation(), false);
    });

    btnApple.addEventListener('click', function() {
      // TODO: Apple Sign-In
      alert('Apple Sign-In coming soon!');
    });
    
    btnGoogle.addEventListener('click', function() {
      if (!window.google || !google.accounts || !google.accounts.id) {
        initGoogleSignIn();
        return;
      }
      // Click the hidden Google button to trigger sign-in
      const hiddenBtn = document.querySelector('#googleButtonHidden div[role="button"]');
      if (hiddenBtn) {
        hiddenBtn.click();
      } else {
        // Fallback: try One Tap
        google.accounts.id.prompt();
      }
    });
    
    btnEmail.addEventListener('click', function() {
      // TODO: Email Sign-In
      alert('Email Sign-In coming soon!');
    });
    
    // SIDE MENU FUNCTIONS
    function openMenu() {
      renderChatHistoryList();
      sideMenu.classList.add('active');
      menuOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMenu() {
      sideMenu.classList.remove('active');
      menuOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    btnMenu.addEventListener('click', openMenu);
    btnCloseMenu.addEventListener('click', closeMenu);
    menuOverlay.addEventListener('click', closeMenu);

    btnNewChat.addEventListener('click', function() {
      // Save current chat first if it has messages
      if (state.messages.length > 0) {
        saveCurrentChatToHistory();
      }
      
      // Clear current chat and start fresh
      clearChatState();
      state.currentChatId = generateChatId();
      chatMessages.innerHTML = '<div class="welcome-message"><div class="welcome-icon">âœ¦</div><h2>How can I help you today?</h2><p>Remember: slow is intentional.</p></div>';
      setActiveView('chat', true);
      closeMenu();
    });

    btnSignOut.addEventListener('click', function() {
      closeMenu();
      signOut();
    });

    btnSettings.addEventListener('click', function() {
      closeMenu();
      showSettings();
    });

    btnAbout.addEventListener('click', function() {
      // TODO: Show about page
      closeMenu();
    });

    if (btnGoals) {
      btnGoals.addEventListener('click', function() {
        closeMenu();
        setActiveView('goals', true);
      });
    }

    if (btnLife) {
      btnLife.addEventListener('click', function() {
        closeMenu();
        window.location.href = '/life.html';
      });
    }

    if (btnCalendar) {
      btnCalendar.addEventListener('click', function() {
        closeMenu();
        setActiveView('calendar', true);
      });
    }

    if (btnFrictionSocial) {
      btnFrictionSocial.addEventListener('click', function() {
        closeMenu();
        setActiveView('social', true);
      });
    }

    // Admin button
    var btnAdmin = document.getElementById('btnAdmin');
    if (btnAdmin) {
      btnAdmin.addEventListener('click', function() {
        closeMenu();
        window.location.href = '/admin.html';
      });
    }

    // FRICTION SOCIAL
    var FRICTION_SOCIAL_CHANNELS_KEY = 'friction_social_channels_v1';
    var FRICTION_SOCIAL_SEEN_KEY = 'friction_social_seen_v1';
    var FRICTION_SOCIAL_INTRO_KEY = 'friction_social_intro_dismissed_v1';
    var FRICTION_SOCIAL_FRICTION_ENABLED_KEY = 'friction_social_friction_enabled_v1';
    var FRICTION_SOCIAL_FRICTION_FREQUENCY_KEY = 'friction_social_friction_frequency_v1';
    var FRICTION_SOCIAL_PAUSE_SECONDS_KEY = 'friction_social_pause_seconds_v1';
    var FRICTION_SOCIAL_SESSION_WATCHED_KEY = 'friction_social_session_watched_count_v1';
    var FRICTION_SOCIAL_MIX_INDEX_KEY = 'friction_social_mix_index_v1';
    var FRICTION_SOCIAL_CHANNEL_LIMIT = 12;
    var FRICTION_SOCIAL_POOL_LIMIT = 50;
    var frictionSocialState = {
      shelves: [],
      query: ''
    };
    var frictionSocialPrefs = {
      frictionEnabled: true,
      frictionFrequency: '1',
      pauseSeconds: '60'
    };
    var frictionSocialScrollTop = 0;
    var frictionSocialMetadataCache = {};
    var frictionSocialChannels = [];
    var frictionSocialSeenMap = {};
    var frictionSocialSessionWatchedCount = 0;
    var frictionSocialActiveVideoId = null;
    var frictionSocialActiveMixIndex = null;
    var frictionSocialMixIndex = -1;
    var frictionSocialPauseTimerId = null;
    var frictionSocialPauseRemaining = 0;
    var frictionSocialUpNextTimerId = null;
    var frictionSocialUpNextRemaining = 0;
    var frictionSocialUpNextGoalIndex = null;
    var frictionSocialUpNextReady = false;
    var frictionSocialPauseTitleDefault = frictionSocialPauseTitle ? frictionSocialPauseTitle.textContent : 'Tiny pause?';
    var frictionSocialPausePrompts = [
      'What do you want from the next video?',
      'If you stop after one more, whatâ€™s next?',
      'Short-term you: what do you need right now?',
      'Long-term you: what would future-you thank you for?'
    ];

    function getFrictionSocialDefaults() {
      return [
        {
          title: 'Focus',
          videos: [
            { id: 'jfKfPfyJRdk', title: 'lofi hip hop radio - beats to relax/study to', channel: 'Lofi Girl' },
            { id: '5qap5aO4i9A', title: 'lofi hip hop radio - beats to sleep/chill to', channel: 'ChilledCow' }
          ]
        },
        {
          title: 'Perspective',
          videos: [
            { id: 'dQw4w9WgXcQ', title: 'Never Gonna Give You Up', channel: 'Rick Astley' },
            { id: 'kxopViU98Xo', title: 'Keyboard Cat', channel: 'Keyboard Cat' }
          ]
        }
      ];
    }

    function normalizeFrictionSocialChannel(channel) {
      if (!channel || !channel.channelId) return null;
      var latestVideo = channel.latestVideo || null;
      var rotationVideos = Array.isArray(channel.rotationVideos) ? channel.rotationVideos : [];
      if (!latestVideo && Array.isArray(channel.videos)) {
        latestVideo = channel.videos[0] || null;
        rotationVideos = channel.videos.slice(1);
      }
      return {
        channelId: channel.channelId,
        channelTitle: channel.channelTitle || 'Unknown channel',
        channelUrl: channel.channelUrl || '',
        addedAt: channel.addedAt || Date.now(),
        latestVideo: latestVideo,
        rotationVideos: rotationVideos,
        lastRotationAt: channel.lastRotationAt || null
      };
    }

    function loadFrictionSocialShelves() {
      var saved = localStorage.getItem('friction_social_shelves');
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            return parsed;
          }
        } catch (e) {
          return getFrictionSocialDefaults();
        }
      }
      return getFrictionSocialDefaults();
    }

    function loadFrictionSocialChannels() {
      var saved = localStorage.getItem(FRICTION_SOCIAL_CHANNELS_KEY);
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            return parsed.map(function(channel) {
              return normalizeFrictionSocialChannel(channel);
            }).filter(Boolean);
          }
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    function loadFrictionSocialSeenMap() {
      var saved = localStorage.getItem(FRICTION_SOCIAL_SEEN_KEY);
      if (saved) {
        try {
          var parsed = JSON.parse(saved);
          if (parsed && typeof parsed === 'object') {
            return parsed;
          }
        } catch (e) {
          return {};
        }
      }
      return {};
    }

    function loadFrictionSocialPrefs() {
      var enabled = localStorage.getItem(FRICTION_SOCIAL_FRICTION_ENABLED_KEY);
      var frequency = localStorage.getItem(FRICTION_SOCIAL_FRICTION_FREQUENCY_KEY);
      var pauseSeconds = localStorage.getItem(FRICTION_SOCIAL_PAUSE_SECONDS_KEY);
      frictionSocialPrefs.frictionEnabled = enabled !== 'false';
      frictionSocialPrefs.frictionFrequency = frequency === '2' ? '2' : '1';
      frictionSocialPrefs.pauseSeconds = pauseSeconds === '30' || pauseSeconds === '120' ? pauseSeconds : '60';
    }

    function saveFrictionSocialPrefs() {
      localStorage.setItem(FRICTION_SOCIAL_FRICTION_ENABLED_KEY, frictionSocialPrefs.frictionEnabled ? 'true' : 'false');
      localStorage.setItem(FRICTION_SOCIAL_FRICTION_FREQUENCY_KEY, frictionSocialPrefs.frictionFrequency);
      localStorage.setItem(FRICTION_SOCIAL_PAUSE_SECONDS_KEY, frictionSocialPrefs.pauseSeconds);
    }

    function applyFrictionSocialPrefsToUI() {
      if (frictionSocialFrictionEnabled) {
        frictionSocialFrictionEnabled.checked = frictionSocialPrefs.frictionEnabled;
      }
      frictionSocialFrequencyInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.frictionFrequency;
      });
      frictionSocialPauseInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.pauseSeconds;
      });
      if (lifeFrictionEnabled) {
        lifeFrictionEnabled.checked = frictionSocialPrefs.frictionEnabled;
      }
      lifeFrictionFrequencyInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.frictionFrequency;
      });
      lifePauseInputs.forEach(function(input) {
        input.checked = input.value === frictionSocialPrefs.pauseSeconds;
      });
    }

    function showFrictionSocialIntroIfNeeded() {
      if (!frictionSocialIntroOverlay) return;
      var dismissed = localStorage.getItem(FRICTION_SOCIAL_INTRO_KEY) === 'true';
      if (dismissed || frictionSocialIntroOverlay.classList.contains('active')) return;
      frictionSocialIntroOverlay.classList.add('active');
      frictionSocialIntroOverlay.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function hideFrictionSocialIntro() {
      if (!frictionSocialIntroOverlay) return;
      frictionSocialIntroOverlay.classList.remove('active');
      frictionSocialIntroOverlay.setAttribute('aria-hidden', 'true');
      unlockBodyScroll();
    }

    function getFrictionSocialPauseSeconds() {
      return parseInt(frictionSocialPrefs.pauseSeconds, 10) || 60;
    }

    function getFrictionSocialFrequency() {
      return parseInt(frictionSocialPrefs.frictionFrequency, 10) || 1;
    }

    function loadFrictionSocialMixIndex() {
      var saved = localStorage.getItem(FRICTION_SOCIAL_MIX_INDEX_KEY);
      var parsed = parseInt(saved, 10);
      return isNaN(parsed) ? -1 : parsed;
    }

    function saveFrictionSocialMixIndex(index) {
      if (typeof index !== 'number' || index < 0) return;
      frictionSocialMixIndex = index;
      localStorage.setItem(FRICTION_SOCIAL_MIX_INDEX_KEY, String(index));
    }

    function getFrictionSocialMixQueue() {
      if (!frictionSocialShelves) return [];
      var shelves = frictionSocialShelves.querySelectorAll('.fs-shelf');
      var mixShelf = null;
      shelves.forEach(function(shelf) {
        var titleEl = shelf.querySelector('.fs-shelf-title');
        var title = titleEl ? titleEl.textContent : '';
        if (title && /mix|up next/i.test(title)) {
          mixShelf = shelf;
        }
      });
      if (!mixShelf) return [];
      var cards = mixShelf.querySelectorAll('.fs-row .fs-card');
      var queue = [];
      cards.forEach(function(card) {
        var id = card.dataset.videoId;
        if (!id) return;
        queue.push({
          id: id,
          title: card.dataset.videoTitle || 'Untitled video',
          channel: card.dataset.videoChannel || '',
          publishedAt: card.dataset.videoPublishedAt || ''
        });
      });
      return queue;
    }

    function findFrictionSocialMixIndex(videoId) {
      if (!videoId) return null;
      var queue = getFrictionSocialMixQueue();
      for (var i = 0; i < queue.length; i += 1) {
        if (queue[i].id === videoId) return i;
      }
      return null;
    }

    function setFrictionSocialActiveMixIndex(videoId, preferredIndex) {
      if (typeof preferredIndex === 'number') {
        frictionSocialActiveMixIndex = preferredIndex;
        return;
      }
      var index = findFrictionSocialMixIndex(videoId);
      frictionSocialActiveMixIndex = index !== null ? index : null;
    }

    function clearFrictionSocialUpNextTimer() {
      if (frictionSocialUpNextTimerId) {
        clearInterval(frictionSocialUpNextTimerId);
        frictionSocialUpNextTimerId = null;
      }
    }

    function setFrictionSocialPauseMode(mode) {
      var isUpNext = mode === 'upnext';
      if (frictionSocialPauseUpNextPanel) {
        frictionSocialPauseUpNextPanel.classList.toggle('active', isUpNext);
      }
      if (frictionSocialPausePrompt) {
        frictionSocialPausePrompt.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseWatch) {
        frictionSocialPauseWatch.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseTake) {
        frictionSocialPauseTake.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.style.display = isUpNext ? 'none' : '';
      }
      if (frictionSocialPauseSkip) {
        frictionSocialPauseSkip.style.display = 'none';
      }
    }

    function getFrictionSocialUpNextGoal() {
      var goals = loadGoalsViewShort();
      var index = goals.findIndex(function(goal) {
        return goal && !goal.done;
      });
      if (index < 0) {
        return { goal: null, index: null, goals: goals };
      }
      return { goal: goals[index], index: index, goals: goals };
    }

    function renderFrictionSocialUpNextGoal() {
      if (!frictionSocialPauseGoalText) return;
      var result = getFrictionSocialUpNextGoal();
      frictionSocialUpNextGoalIndex = result.index;
      if (!result.goal) {
        frictionSocialPauseGoalText.textContent = 'No short-term goals set â€” add one anytime in Goals.';
        if (frictionSocialPauseGoalDone) {
          frictionSocialPauseGoalDone.style.display = 'none';
        }
        return;
      }
      frictionSocialPauseGoalText.textContent = 'Short-term goal: ' + result.goal.text;
      if (frictionSocialPauseGoalDone) {
        frictionSocialPauseGoalDone.style.display = 'inline-flex';
        frictionSocialPauseGoalDone.disabled = false;
      }
    }

    function markFrictionSocialUpNextGoalDone() {
      if (frictionSocialUpNextGoalIndex === null) return;
      var goals = loadGoalsViewShort();
      var goal = goals[frictionSocialUpNextGoalIndex];
      if (!goal) return;
      goal.done = true;
      goal.completedAt = Date.now();
      localStorage.setItem(GOALS_SHORT_KEY, JSON.stringify(goals));
      goalsShort = goals;
      renderShortGoals();
      renderFrictionSocialUpNextGoal();
    }

    function resetFrictionSocialUpNextState() {
      clearFrictionSocialUpNextTimer();
      frictionSocialUpNextRemaining = 0;
      frictionSocialUpNextReady = false;
      if (frictionSocialPauseContinue) {
        frictionSocialPauseContinue.disabled = true;
      }
      if (frictionSocialPauseTimer) {
        frictionSocialPauseTimer.textContent = '';
      }
      setFrictionSocialPauseMode('default');
      if (frictionSocialPauseTitle) {
        frictionSocialPauseTitle.textContent = frictionSocialPauseTitleDefault;
      }
    }

    function startFrictionSocialUpNextCountdown() {
      frictionSocialUpNextRemaining = 30;
      frictionSocialUpNextReady = false;
      if (frictionSocialPauseContinue) {
        frictionSocialPauseContinue.disabled = true;
      }
      if (frictionSocialPauseTimer) {
        frictionSocialPauseTimer.textContent = 'Up Next in ' + frictionSocialUpNextRemaining + ' seconds';
      }
      clearFrictionSocialUpNextTimer();
      frictionSocialUpNextTimerId = setInterval(function() {
        frictionSocialUpNextRemaining -= 1;
        if (frictionSocialPauseTimer) {
          frictionSocialPauseTimer.textContent = 'Up Next in ' + frictionSocialUpNextRemaining + ' seconds';
        }
        if (frictionSocialUpNextRemaining <= 0) {
          clearFrictionSocialUpNextTimer();
          frictionSocialUpNextReady = true;
          if (frictionSocialPauseTimer) {
            frictionSocialPauseTimer.textContent = 'Ready when you are.';
          }
          if (frictionSocialPauseContinue) {
            frictionSocialPauseContinue.disabled = false;
          }
        }
      }, 1000);
    }

    function startFrictionSocialUpNextFlow() {
      clearFrictionSocialPauseTimer();
      setFrictionSocialPauseMode('upnext');
      if (frictionSocialPauseTitle) {
        frictionSocialPauseTitle.textContent = 'Up Next';
      }
      renderFrictionSocialUpNextGoal();
      startFrictionSocialUpNextCountdown();
    }

    function openNextFrictionSocialMixVideo() {
      if (!frictionSocialUpNextReady) return;
      var queue = getFrictionSocialMixQueue();
      if (!queue.length) return;
      var nextIndex = (typeof frictionSocialMixIndex === 'number' ? frictionSocialMixIndex : -1) + 1;
      if (nextIndex < 0 || nextIndex >= queue.length) return;
      var nextVideo = queue[nextIndex];
      setFrictionSocialActiveMixIndex(nextVideo.id, nextIndex);
      hideFrictionSocialPauseOverlay();
      openFrictionSocialModal({
        id: nextVideo.id,
        title: nextVideo.title,
        channel: nextVideo.channel,
        publishedAt: nextVideo.publishedAt
      });
    }

    function clearFrictionSocialPauseTimer() {
      if (frictionSocialPauseTimerId) {
        clearInterval(frictionSocialPauseTimerId);
        frictionSocialPauseTimerId = null;
      }
    }

    function hideFrictionSocialPauseOverlay() {
      if (!frictionSocialPauseOverlay) return;
      frictionSocialPauseOverlay.classList.remove('active');
      frictionSocialPauseOverlay.setAttribute('aria-hidden', 'true');
      resetFrictionSocialUpNextState();
      frictionSocialPauseTake.disabled = false;
      frictionSocialPauseWatch.disabled = false;
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.disabled = false;
      }
      clearFrictionSocialPauseTimer();
      unlockBodyScroll();
    }

    function startFrictionSocialPauseCountdown() {
      frictionSocialPauseRemaining = getFrictionSocialPauseSeconds();
      frictionSocialPauseSkip.style.display = 'inline-flex';
      frictionSocialPauseTake.disabled = true;
      frictionSocialPauseWatch.disabled = true;
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.disabled = true;
      }
      frictionSocialPauseTimer.textContent = 'Remaining: ' + frictionSocialPauseRemaining + ' seconds';
      clearFrictionSocialPauseTimer();
      frictionSocialPauseTimerId = setInterval(function() {
        frictionSocialPauseRemaining -= 1;
        frictionSocialPauseTimer.textContent = 'Remaining: ' + frictionSocialPauseRemaining + ' seconds';
        if (frictionSocialPauseRemaining <= 0) {
          hideFrictionSocialPauseOverlay();
        }
      }, 1000);
    }

    function showFrictionSocialPauseOverlay() {
      if (!frictionSocialPauseOverlay || frictionSocialPauseOverlay.classList.contains('active')) return;
      resetFrictionSocialUpNextState();
      var prompt = frictionSocialPausePrompts[Math.floor(Math.random() * frictionSocialPausePrompts.length)];
      frictionSocialPausePrompt.textContent = prompt;
      frictionSocialPauseTake.textContent = 'Take ' + getFrictionSocialPauseSeconds() + ' seconds';
      frictionSocialPauseTimer.textContent = '';
      frictionSocialPauseSkip.style.display = 'none';
      frictionSocialPauseTake.disabled = false;
      frictionSocialPauseWatch.disabled = false;
      if (frictionSocialPauseUpNext) {
        frictionSocialPauseUpNext.disabled = false;
      }
      frictionSocialPauseOverlay.classList.add('active');
      frictionSocialPauseOverlay.setAttribute('aria-hidden', 'false');
      lockBodyScroll();
    }

    function recordFrictionSocialWatch() {
      frictionSocialSessionWatchedCount += 1;
      localStorage.setItem(FRICTION_SOCIAL_SESSION_WATCHED_KEY, String(frictionSocialSessionWatchedCount));
      if (!frictionSocialPrefs.frictionEnabled) return;
      var frequency = getFrictionSocialFrequency();
      if (frictionSocialSessionWatchedCount % frequency !== 0) return;
      if (frictionSocialIntroOverlay && frictionSocialIntroOverlay.classList.contains('active')) return;
      showFrictionSocialPauseOverlay();
    }

    function saveFrictionSocialShelves() {
      localStorage.setItem('friction_social_shelves', JSON.stringify(frictionSocialState.shelves));
    }

    function saveFrictionSocialChannels() {
      localStorage.setItem(FRICTION_SOCIAL_CHANNELS_KEY, JSON.stringify(frictionSocialChannels));
    }

    function saveFrictionSocialSeenMap() {
      localStorage.setItem(FRICTION_SOCIAL_SEEN_KEY, JSON.stringify(frictionSocialSeenMap));
    }

    function removeFrictionSocialChannel(channelId, channelTitle) {
      if (!channelId) return;
      var label = channelTitle ? '"' + channelTitle + '"' : 'this channel';
      if (!confirm('Remove ' + label + ' from Friction Social?')) return;
      frictionSocialChannels = frictionSocialChannels.filter(function(channel) {
        return channel.channelId !== channelId;
      });
      saveFrictionSocialChannels();
      renderFrictionSocialShelves();
    }

    function extractYouTubeId(value) {
      if (!value) return '';
      var trimmed = value.trim();
      var urlMatch = trimmed.match(/(?:v=|\/embed\/|\/shorts\/|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      if (urlMatch && urlMatch[1]) {
        return urlMatch[1];
      }
      if (/^[a-zA-Z0-9_-]{11}$/.test(trimmed)) {
        return trimmed;
      }
      return '';
    }

    function markFrictionSocialSeen(videoId) {
      if (!videoId) return;
      if (!frictionSocialSeenMap[videoId]) {
        frictionSocialSeenMap[videoId] = Date.now();
        saveFrictionSocialSeenMap();
      }
    }

    function isFrictionSocialSeen(videoId) {
      return !!(videoId && frictionSocialSeenMap[videoId]);
    }

    function addFrictionSocialSeenBadge(card) {
      if (!card || card.querySelector('.fs-card-badge--seen')) return;
      var seenBadge = document.createElement('span');
      seenBadge.className = 'fs-card-badge fs-card-badge--seen';
      seenBadge.textContent = 'Seen';
      card.appendChild(seenBadge);
    }

    function shuffleFrictionSocialList(items) {
      var array = items.slice();
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
      }
      return array;
    }

    function buildFrictionSocialRotation(poolVideos, latestVideoId, count) {
      var candidates = (poolVideos || []).filter(function(video) {
        return video && video.videoId && video.videoId !== latestVideoId;
      });
      var unseen = candidates.filter(function(video) {
        return !isFrictionSocialSeen(video.videoId);
      });
      var seen = candidates.filter(function(video) {
        return isFrictionSocialSeen(video.videoId);
      });
      var selection = shuffleFrictionSocialList(unseen).slice(0, count);
      if (selection.length < count) {
        var remaining = count - selection.length;
        selection = selection.concat(shuffleFrictionSocialList(seen).slice(0, remaining));
      }
      return selection;
    }

    function getOrCreateShelf(title) {
      var shelf = frictionSocialState.shelves.find(function(item) {
        return item.title === title;
      });
      if (!shelf) {
        shelf = { title: title, videos: [] };
        frictionSocialState.shelves.unshift(shelf);
      }
      return shelf;
    }

    function addFrictionSocialVideo() {
      var input = prompt('Paste a YouTube link or video ID:');
      if (!input) return;
      var videoId = extractYouTubeId(input);
      if (!videoId) {
        alert('Please provide a valid YouTube link or 11-character video ID.');
        return;
      }
      var exists = frictionSocialState.shelves.some(function(shelf) {
        return (shelf.videos || []).some(function(video) {
          return video.id === videoId;
        });
      });
      if (exists) {
        alert('That video is already saved.');
        return;
      }

      var title = prompt('Video title (optional):') || 'Untitled video';
      var channel = prompt('Channel name (optional):') || 'Unknown channel';
      var shelf = getOrCreateShelf('Saved');
      shelf.videos.unshift({
        id: videoId,
        title: title.trim() || 'Untitled video',
        channel: channel.trim() || 'Unknown channel'
      });
      saveFrictionSocialShelves();
      renderFrictionSocialShelves();
      refreshFrictionSocialMetadata([videoId]);
    }

    function upsertFrictionSocialChannel(channelData) {
      var existingIndex = frictionSocialChannels.findIndex(function(channel) {
        return channel.channelId === channelData.channelId;
      });
      if (existingIndex >= 0) {
        var existing = frictionSocialChannels[existingIndex];
        frictionSocialChannels[existingIndex] = {
          channelId: channelData.channelId,
          channelTitle: channelData.channelTitle || existing.channelTitle,
          channelUrl: channelData.channelUrl || existing.channelUrl,
          addedAt: existing.addedAt,
          latestVideo: channelData.latestVideo || existing.latestVideo || null,
          rotationVideos: channelData.rotationVideos || existing.rotationVideos || [],
          lastRotationAt: channelData.lastRotationAt || existing.lastRotationAt || null
        };
      } else {
        frictionSocialChannels.unshift({
          channelId: channelData.channelId,
          channelTitle: channelData.channelTitle || 'Unknown channel',
          channelUrl: channelData.channelUrl || '',
          addedAt: Date.now(),
          latestVideo: channelData.latestVideo || null,
          rotationVideos: channelData.rotationVideos || [],
          lastRotationAt: channelData.lastRotationAt || null
        });
      }
      saveFrictionSocialChannels();
    }

    async function fetchFrictionSocialChannelLatest(channelId, limit) {
      var response = await fetch('/api/youtube/channel-latest?channelId=' + encodeURIComponent(channelId) + '&limit=' + limit);
      if (!response.ok) {
        var errorText = await response.text().catch(function() { return ''; });
        throw new Error(errorText || 'Failed to fetch channel videos.');
      }
      return response.json();
    }

    async function fetchFrictionSocialChannelSample(channelId, pool) {
      var response = await fetch('/api/youtube/channel-sample?channelId=' + encodeURIComponent(channelId) + '&pool=' + pool);
      if (!response.ok) {
        var errorText = await response.text().catch(function() { return ''; });
        throw new Error(errorText || 'Failed to fetch channel sample.');
      }
      return response.json();
    }

    async function addFrictionSocialChannel() {
      var input = prompt('Paste a YouTube channel link or @handle:');
      if (!input) return;
      try {
        var resolveResponse = await fetch('/api/youtube/resolve-channel?q=' + encodeURIComponent(input.trim()));
        if (!resolveResponse.ok) {
          var resolveText = await resolveResponse.text().catch(function() { return ''; });
          throw new Error(resolveText || 'Unable to resolve channel.');
        }
        var resolved = await resolveResponse.json();
        if (!resolved || !resolved.channelId) {
          throw new Error('Channel not found.');
        }
        var latest = await fetchFrictionSocialChannelLatest(resolved.channelId, 1);
        var channelInfo = latest.channel || resolved;
        var latestVideo = Array.isArray(latest.videos) ? latest.videos[0] : null;
        var sample = await fetchFrictionSocialChannelSample(resolved.channelId, FRICTION_SOCIAL_POOL_LIMIT);
        var poolVideos = Array.isArray(sample.videos) ? sample.videos : [];
        var rotationVideos = buildFrictionSocialRotation(
          poolVideos,
          latestVideo ? latestVideo.videoId : '',
          Math.max(FRICTION_SOCIAL_CHANNEL_LIMIT - 1, 0)
        );
        upsertFrictionSocialChannel({
          channelId: channelInfo.channelId || resolved.channelId,
          channelTitle: channelInfo.channelTitle || resolved.channelTitle,
          channelUrl: channelInfo.channelUrl || resolved.channelUrl,
          latestVideo: latestVideo,
          rotationVideos: rotationVideos,
          lastRotationAt: Date.now()
        });
        renderFrictionSocialShelves();
      } catch (err) {
        alert(err && err.message ? err.message : 'Unable to add channel.');
      }
    }

    async function refreshFrictionSocialChannelRotation(channelId, buttonEl) {
      var index = frictionSocialChannels.findIndex(function(channel) {
        return channel.channelId === channelId;
      });
      if (index < 0) return;
      var channel = frictionSocialChannels[index];
      var originalLabel = buttonEl ? buttonEl.textContent : '';
      if (buttonEl) {
        buttonEl.disabled = true;
        buttonEl.textContent = 'Refreshing...';
      }
      try {
        var sample = await fetchFrictionSocialChannelSample(channelId, FRICTION_SOCIAL_POOL_LIMIT);
        var poolVideos = Array.isArray(sample.videos) ? sample.videos : [];
        var latestId = channel.latestVideo ? channel.latestVideo.videoId : '';
        var rotationVideos = buildFrictionSocialRotation(
          poolVideos,
          latestId,
          Math.max(FRICTION_SOCIAL_CHANNEL_LIMIT - 1, 0)
        );
        frictionSocialChannels[index] = {
          channelId: channel.channelId,
          channelTitle: channel.channelTitle,
          channelUrl: channel.channelUrl,
          addedAt: channel.addedAt,
          latestVideo: channel.latestVideo || null,
          rotationVideos: rotationVideos,
          lastRotationAt: Date.now()
        };
        saveFrictionSocialChannels();
        renderFrictionSocialShelves();
      } catch (err) {
        alert(err && err.message ? err.message : 'Unable to refresh channel rotation.');
      } finally {
        if (buttonEl) {
          buttonEl.disabled = false;
          buttonEl.textContent = originalLabel;
        }
      }
    }

    async function refreshFrictionSocialChannels() {
      if (!frictionSocialChannels.length) {
        alert('No channels saved yet.');
        return;
      }
      frictionSocialRefresh.disabled = true;
      var originalLabel = frictionSocialRefresh.textContent;
      frictionSocialRefresh.textContent = 'Refreshing...';
      try {
        for (var i = 0; i < frictionSocialChannels.length; i++) {
          var channel = frictionSocialChannels[i];
          if (!channel || !channel.channelId) continue;
          try {
            var latest = await fetchFrictionSocialChannelLatest(channel.channelId, 1);
            var channelInfo = latest.channel || {};
            var latestVideo = Array.isArray(latest.videos) ? latest.videos[0] : channel.latestVideo;
            var sample = await fetchFrictionSocialChannelSample(channel.channelId, FRICTION_SOCIAL_POOL_LIMIT);
            var poolVideos = Array.isArray(sample.videos) ? sample.videos : [];
            var rotationVideos = buildFrictionSocialRotation(
              poolVideos,
              latestVideo ? latestVideo.videoId : '',
              Math.max(FRICTION_SOCIAL_CHANNEL_LIMIT - 1, 0)
            );
            frictionSocialChannels[i] = {
              channelId: channel.channelId,
              channelTitle: channelInfo.channelTitle || channel.channelTitle,
              channelUrl: channelInfo.channelUrl || channel.channelUrl,
              addedAt: channel.addedAt,
              latestVideo: latestVideo || null,
              rotationVideos: rotationVideos,
              lastRotationAt: Date.now()
            };
          } catch (err) {
            continue;
          }
        }
        saveFrictionSocialChannels();
        renderFrictionSocialShelves();
      } finally {
        frictionSocialRefresh.disabled = false;
        frictionSocialRefresh.textContent = originalLabel;
      }
    }

    function formatPublishedDate(value) {
      if (!value) return '';
      var date = new Date(value);
      if (isNaN(date.getTime())) return '';
      return date.toLocaleDateString(undefined, {
        day: '2-digit',
        month: 'short',
        year: 'numeric'
      });
    }

    function getVideoMetaLine(video, fallbackChannel) {
      var channel = video.channel || fallbackChannel || 'Unknown channel';
      var published = formatPublishedDate(video.publishedAt);
      return published ? channel + ' â€¢ ' + published : channel;
    }

    function collectFrictionSocialIds() {
      var ids = [];
      frictionSocialState.shelves.forEach(function(shelf) {
        var videos = Array.isArray(shelf.videos) ? shelf.videos : [];
        videos.forEach(function(video) {
          if (video && video.id) ids.push(video.id);
        });
      });
      return ids;
    }

    function mergeFrictionSocialMetadata(metadata) {
      if (!metadata) return;
      var hasUpdates = false;
      frictionSocialState.shelves.forEach(function(shelf) {
        var videos = Array.isArray(shelf.videos) ? shelf.videos : [];
        videos.forEach(function(video) {
          var info = metadata[video.id];
          if (!info) return;
          frictionSocialMetadataCache[video.id] = info;
          if (info.title) {
            video.title = info.title;
            hasUpdates = true;
          }
          if (info.channelTitle) {
            video.channel = info.channelTitle;
            hasUpdates = true;
          }
          if (info.publishedAt) {
            video.publishedAt = info.publishedAt;
            hasUpdates = true;
          }
          if (info.thumbnail) {
            video.thumbnail = info.thumbnail;
            hasUpdates = true;
          }
        });
      });
      if (hasUpdates) {
        saveFrictionSocialShelves();
        renderFrictionSocialShelves();
      }
    }

    function fetchFrictionSocialMetadata(ids) {
      var idList = (ids || []).filter(Boolean);
      if (idList.length === 0) return Promise.resolve(null);
      return fetch('/api/youtube/metadata?ids=' + encodeURIComponent(idList.join(',')))
        .then(function(res) {
          if (!res.ok) throw new Error('Metadata fetch failed');
          return res.json();
        })
        .catch(function() {
          return null;
        });
    }

    function refreshFrictionSocialMetadata(ids) {
      var allIds = ids && ids.length ? ids : collectFrictionSocialIds();
      var uniqueIds = [];
      var seen = {};
      allIds.forEach(function(id) {
        if (!id || seen[id]) return;
        seen[id] = true;
        if (!frictionSocialMetadataCache[id]) {
          uniqueIds.push(id);
        }
      });
      if (uniqueIds.length === 0) return;
      for (var i = 0; i < uniqueIds.length; i += 50) {
        fetchFrictionSocialMetadata(uniqueIds.slice(i, i + 50)).then(function(metadata) {
          mergeFrictionSocialMetadata(metadata);
        });
      }
    }

    function renderFrictionSocialShelves() {
      var query = (frictionSocialState.query || '').trim().toLowerCase();
      frictionSocialShelves.innerHTML = '';
      var totalMatches = 0;

      frictionSocialChannels.forEach(function(channel) {
        var latestVideo = channel.latestVideo || null;
        var rotationVideos = Array.isArray(channel.rotationVideos) ? channel.rotationVideos : [];
        var latestVideoId = latestVideo ? latestVideo.videoId : '';
        var channelTitle = channel.channelTitle || 'Unknown channel';
        var channelMatch = query && channelTitle.toLowerCase().indexOf(query) >= 0;
        var allVideos = [];
        if (latestVideo) allVideos.push(latestVideo);
        allVideos = allVideos.concat(rotationVideos);
        var filtered = allVideos.filter(function(video) {
          if (!query) return true;
          if (channelMatch) return true;
          var title = (video.title || '').toLowerCase();
          var id = (video.videoId || '').toLowerCase();
          return title.indexOf(query) >= 0 || id.indexOf(query) >= 0;
        });

        if (filtered.length === 0) return;
        totalMatches += filtered.length;

        var shelfEl = document.createElement('div');
        shelfEl.className = 'fs-shelf';

        var header = document.createElement('div');
        header.className = 'fs-shelf-header';

        var titleEl = document.createElement('div');
        titleEl.className = 'fs-shelf-title';
        titleEl.textContent = channelTitle;

        var actions = document.createElement('div');
        actions.className = 'fs-shelf-actions';

        var countEl = document.createElement('div');
        countEl.className = 'fs-shelf-count';
        countEl.textContent = filtered.length + (filtered.length === 1 ? ' video' : ' videos');

        var refreshBtn = document.createElement('button');
        refreshBtn.type = 'button';
        refreshBtn.className = 'fs-add-btn fs-secondary-btn fs-refresh-btn';
        refreshBtn.textContent = 'ðŸŽ² Refresh';
        refreshBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          refreshFrictionSocialChannelRotation(channel.channelId, refreshBtn);
        });

        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'fs-add-btn fs-secondary-btn fs-remove-btn';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', function(event) {
          event.stopPropagation();
          removeFrictionSocialChannel(channel.channelId, channelTitle);
        });

        actions.appendChild(countEl);
        actions.appendChild(refreshBtn);
        actions.appendChild(removeBtn);

        header.appendChild(titleEl);
        header.appendChild(actions);

        var row = document.createElement('div');
        row.className = 'fs-row';

        filtered.forEach(function(video) {
          var card = document.createElement('button');
          card.type = 'button';
          card.className = 'fs-card';
          card.dataset.videoId = video.videoId;
          card.dataset.videoTitle = video.title || 'Untitled video';
          card.dataset.videoChannel = channelTitle;
          card.dataset.videoPublishedAt = video.publishedAt || '';

          if (latestVideoId && video.videoId === latestVideoId) {
            var latestBadge = document.createElement('span');
            latestBadge.className = 'fs-card-badge fs-card-badge--latest';
            latestBadge.textContent = 'Latest';
            card.appendChild(latestBadge);
          }

          if (isFrictionSocialSeen(video.videoId)) {
            var seenBadge = document.createElement('span');
            seenBadge.className = 'fs-card-badge fs-card-badge--seen';
            seenBadge.textContent = 'Seen';
            card.appendChild(seenBadge);
          }

          var img = document.createElement('img');
          img.src = video.thumbnail || ('https://i.ytimg.com/vi/' + video.videoId + '/hqdefault.jpg');
          img.alt = video.title || 'YouTube thumbnail';
          img.loading = 'lazy';

          var body = document.createElement('div');
          body.className = 'fs-card-body';

          var cardTitle = document.createElement('div');
          cardTitle.className = 'fs-card-title';
          cardTitle.textContent = video.title || 'Untitled video';

          var cardChannel = document.createElement('div');
          cardChannel.className = 'fs-card-channel';
          cardChannel.textContent = getVideoMetaLine(video, channelTitle);

          body.appendChild(cardTitle);
          body.appendChild(cardChannel);

          card.appendChild(img);
          card.appendChild(body);
          row.appendChild(card);
        });

        shelfEl.appendChild(header);
        shelfEl.appendChild(row);
        frictionSocialShelves.appendChild(shelfEl);
      });

      frictionSocialState.shelves.forEach(function(shelf) {
        var videos = Array.isArray(shelf.videos) ? shelf.videos : [];
        var filtered = videos.filter(function(video) {
          if (!query) return true;
          var title = (video.title || '').toLowerCase();
          var channel = (video.channel || '').toLowerCase();
          var id = (video.id || '').toLowerCase();
          return title.indexOf(query) >= 0 || channel.indexOf(query) >= 0 || id.indexOf(query) >= 0;
        });

        if (filtered.length === 0) return;
        totalMatches += filtered.length;

        var shelfEl = document.createElement('div');
        shelfEl.className = 'fs-shelf';

        var header = document.createElement('div');
        header.className = 'fs-shelf-header';

        var titleEl = document.createElement('div');
        titleEl.className = 'fs-shelf-title';
        titleEl.textContent = shelf.title || 'Untitled shelf';

        var countEl = document.createElement('div');
        countEl.className = 'fs-shelf-count';
        countEl.textContent = filtered.length + (filtered.length === 1 ? ' video' : ' videos');

        header.appendChild(titleEl);
        header.appendChild(countEl);

        var row = document.createElement('div');
        row.className = 'fs-row';

        filtered.forEach(function(video) {
          var card = document.createElement('button');
          card.type = 'button';
          card.className = 'fs-card';
          card.dataset.videoId = video.id;
          card.dataset.videoTitle = video.title || 'Untitled video';
          card.dataset.videoChannel = video.channel || '';
          card.dataset.videoPublishedAt = video.publishedAt || '';

          if (isFrictionSocialSeen(video.id)) {
            var seenBadge = document.createElement('span');
            seenBadge.className = 'fs-card-badge fs-card-badge--seen';
            seenBadge.textContent = 'Seen';
            card.appendChild(seenBadge);
          }

          var img = document.createElement('img');
          img.src = video.thumbnail || ('https://i.ytimg.com/vi/' + video.id + '/hqdefault.jpg');
          img.alt = video.title || 'YouTube thumbnail';
          img.loading = 'lazy';

          var body = document.createElement('div');
          body.className = 'fs-card-body';

          var cardTitle = document.createElement('div');
          cardTitle.className = 'fs-card-title';
          cardTitle.textContent = video.title || 'Untitled video';

          var cardChannel = document.createElement('div');
          cardChannel.className = 'fs-card-channel';
          cardChannel.textContent = getVideoMetaLine(video);

          body.appendChild(cardTitle);
          body.appendChild(cardChannel);

          card.appendChild(img);
          card.appendChild(body);
          row.appendChild(card);
        });

        shelfEl.appendChild(header);
        shelfEl.appendChild(row);
        frictionSocialShelves.appendChild(shelfEl);
      });

      if (totalMatches === 0) {
        frictionSocialEmpty.style.display = 'block';
        frictionSocialEmpty.textContent = query
          ? 'No videos match your search.'
          : 'No videos saved yet. Add a YouTube link or channel to start your library.';
      } else {
        frictionSocialEmpty.style.display = 'none';
      }
    }

    function openFrictionSocialModal(video) {
      if (!video || !video.id) return;
      markFrictionSocialSeen(video.id);
      frictionSocialActiveVideoId = video.id;
      setFrictionSocialActiveMixIndex(video.id);
      frictionSocialScrollTop = frictionSocialView.scrollTop;
      frictionSocialView.classList.add('modal-open');
      frictionSocialModal.classList.add('active');
      frictionSocialModal.setAttribute('aria-hidden', 'false');
      frictionSocialModalFrame.src = 'https://www.youtube.com/embed/' + video.id + '?autoplay=1&rel=0&modestbranding=1';
      frictionSocialModalTitle.textContent = video.title || 'Untitled video';
      frictionSocialModalChannel.textContent = getVideoMetaLine(video);
      frictionSocialModalLink.href = 'https://www.youtube.com/watch?v=' + video.id;
    }

    function closeFrictionSocialModal() {
      if (!frictionSocialModal.classList.contains('active')) return;
      frictionSocialModal.classList.remove('active');
      frictionSocialModal.setAttribute('aria-hidden', 'true');
      frictionSocialView.classList.remove('modal-open');
      frictionSocialModalFrame.src = '';
      if (frictionSocialActiveVideoId) {
        frictionSocialActiveVideoId = null;
        recordFrictionSocialWatch();
      }
      if (frictionSocialActiveMixIndex !== null) {
        saveFrictionSocialMixIndex(frictionSocialActiveMixIndex);
        frictionSocialActiveMixIndex = null;
      }
      setTimeout(function() {
        frictionSocialView.scrollTop = frictionSocialScrollTop;
      }, 0);
    }

    frictionSocialState.shelves = loadFrictionSocialShelves();
    frictionSocialChannels = loadFrictionSocialChannels();
    frictionSocialSeenMap = loadFrictionSocialSeenMap();
    loadFrictionSocialPrefs();
    applyFrictionSocialPrefsToUI();
    frictionSocialMixIndex = loadFrictionSocialMixIndex();
    frictionSocialSessionWatchedCount = 0;
    localStorage.setItem(FRICTION_SOCIAL_SESSION_WATCHED_KEY, '0');
    renderFrictionSocialShelves();
    refreshFrictionSocialMetadata();

    frictionSocialSearch.addEventListener('input', function() {
      frictionSocialState.query = this.value || '';
      renderFrictionSocialShelves();
    });

    if (frictionSocialFrictionEnabled) {
      frictionSocialFrictionEnabled.addEventListener('change', function() {
        frictionSocialPrefs.frictionEnabled = this.checked;
        saveFrictionSocialPrefs();
      });
    }

    frictionSocialFrequencyInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.frictionFrequency = this.value;
        saveFrictionSocialPrefs();
      });
    });

    frictionSocialPauseInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.pauseSeconds = this.value;
        saveFrictionSocialPrefs();
      });
    });

    if (lifeFrictionEnabled) {
      lifeFrictionEnabled.addEventListener('change', function() {
        frictionSocialPrefs.frictionEnabled = this.checked;
        saveFrictionSocialPrefs();
        applyFrictionSocialPrefsToUI();
      });
    }

    lifeFrictionFrequencyInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.frictionFrequency = this.value;
        saveFrictionSocialPrefs();
        applyFrictionSocialPrefsToUI();
      });
    });

    lifePauseInputs.forEach(function(input) {
      input.addEventListener('change', function() {
        if (!this.checked) return;
        frictionSocialPrefs.pauseSeconds = this.value;
        saveFrictionSocialPrefs();
        applyFrictionSocialPrefsToUI();
      });
    });

    frictionSocialAdd.addEventListener('click', addFrictionSocialVideo);
    if (frictionSocialAddChannel) {
      frictionSocialAddChannel.addEventListener('click', addFrictionSocialChannel);
    }
    if (frictionSocialRefresh) {
      frictionSocialRefresh.addEventListener('click', refreshFrictionSocialChannels);
    }

    frictionSocialShelves.addEventListener('click', function(event) {
      var card = event.target.closest('.fs-card');
      if (!card) return;
      var videoId = card.dataset.videoId;
      markFrictionSocialSeen(videoId);
      addFrictionSocialSeenBadge(card);
      openFrictionSocialModal({
        id: videoId,
        title: card.dataset.videoTitle,
        channel: card.dataset.videoChannel,
        publishedAt: card.dataset.videoPublishedAt
      });
    });

    frictionSocialModal.addEventListener('click', function(event) {
      if (event.target.dataset.close !== undefined) {
        closeFrictionSocialModal();
      }
    });

    frictionSocialModalClose.addEventListener('click', closeFrictionSocialModal);

    if (frictionSocialIntroContinue) {
      frictionSocialIntroContinue.addEventListener('click', function() {
        if (frictionSocialIntroDismiss && frictionSocialIntroDismiss.checked) {
          localStorage.setItem(FRICTION_SOCIAL_INTRO_KEY, 'true');
        }
        hideFrictionSocialIntro();
      });
    }

    if (frictionSocialPauseWatch) {
      frictionSocialPauseWatch.addEventListener('click', function() {
        hideFrictionSocialPauseOverlay();
      });
    }

    if (frictionSocialPauseTake) {
      frictionSocialPauseTake.addEventListener('click', function() {
        if (frictionSocialPauseTimerId) return;
        startFrictionSocialPauseCountdown();
      });
    }

    if (frictionSocialPauseUpNext) {
      frictionSocialPauseUpNext.addEventListener('click', function() {
        startFrictionSocialUpNextFlow();
      });
    }

    if (frictionSocialPauseGoalDone) {
      frictionSocialPauseGoalDone.addEventListener('click', function() {
        markFrictionSocialUpNextGoalDone();
      });
    }

    if (frictionSocialPauseContinue) {
      frictionSocialPauseContinue.addEventListener('click', function() {
        openNextFrictionSocialMixVideo();
      });
    }

    if (frictionSocialPauseSkip) {
      frictionSocialPauseSkip.addEventListener('click', function() {
        hideFrictionSocialPauseOverlay();
      });
    }

    if (frictionSocialPauseDone) {
      frictionSocialPauseDone.addEventListener('click', function() {
        hideFrictionSocialPauseOverlay();
      });
    }

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeFrictionSocialModal();
        hideFrictionSocialPauseOverlay();
        hideFrictionSocialIntro();
        closeCalendarModals();
        closeAppointmentModal(appointmentModalContexts.life);
        closeAppointmentModal(appointmentModalContexts.calendar);
        closeLifeModals();
        closeBubbleMenu();
      }
    });

    loadLifeAreas();
    loadLifeUiPrefs();
    loadLifeData();
    setGroupMode(lifeUiPrefs.groupMode);
    loadCalendarEvents();
    renderAreaSelects();
    resetPeopleForm();

    goalsShort = loadGoalsViewShort();
    goalsLong = loadGoalsViewLong();
    tasks = loadTasks();
    appointments = loadAppointments();
    saveGoalsViewShort();
    saveGoalsViewLong();
    saveTasks();
    saveAppointments();
    renderShortGoals();
    renderLongGoals();
    renderGoalsNudge();
    renderLinkedTaskOptions();
    renderLifeToday();
    renderLifeGoals();
    renderLifeTasks();
    renderLifeCalendar();
    renderLifeAreasList();
    renderPeopleOverview();
    renderAppointmentsView();
    renderCalendarMonth();
    setLifeTab('people');
    setupAppointmentModal(appointmentModalContexts.life);
    setupAppointmentModal(appointmentModalContexts.calendar);
    if (isCalendarImportRoute()) {
      showCalendarImportForm();
      populateCalendarImportForm();
    }

    if (lifeGroupToggle) {
      lifeGroupToggle.addEventListener('click', function() {
        setGroupMode(!lifeUiPrefs.groupMode);
      });
    }

    if (lifeDomainStrip) {
      lifeDomainStrip.addEventListener('click', function(event) {
        var button = event.target.closest('[data-domain-id]');
        if (!button) return;
        var domainId = button.dataset.domainId;
        if (!domainId) return;
        setLifeActiveDomain(domainId);
      });
    }

    if (lifeNodeStrip) {
      lifeNodeStrip.addEventListener('click', function(event) {
        var button = event.target.closest('.life-node-btn');
        if (!button) return;
        var action = button.dataset.nodeAction;
        if (action === 'add-person') {
          openPeopleForm();
          return;
        }
        if (action === 'add-asset') {
          openLifeEditorFor('asset:new');
          return;
        }
        if (action === 'add-appointment') {
          openLifeEditorFor('appointment:new');
          return;
        }
        if (action === 'add-task') {
          openLifeEditorFor('task:new');
          return;
        }
        var nodeId = button.dataset.nodeId;
        var nodeType = button.dataset.nodeType;
        if (nodeType === 'person') {
          setActivePersonId(nodeId);
          setLifeExpandedNode(nodeId);
          return;
        }
        if (nodeId) {
          setLifeExpandedNode(nodeId);
        }
      });
    }

    if (lifeBubbleStrip) {
      lifeBubbleStrip.addEventListener('touchstart', function(event) {
        var button = event.target.closest('.life-bubble-btn');
        if (!button) return;
        event.preventDefault();
        startBubbleLongPress(button, event);
      }, { passive: false });

      lifeBubbleStrip.addEventListener('touchmove', function(event) {
        if (bubbleMenuState.longPressTimer) {
          event.preventDefault();
        }
        handleBubbleMove(event);
      }, { passive: false });

      lifeBubbleStrip.addEventListener('touchend', function() {
        cancelBubbleLongPress();
      });

      lifeBubbleStrip.addEventListener('touchcancel', function() {
        cancelBubbleLongPress();
      });

      lifeBubbleStrip.addEventListener('mousedown', function(event) {
        if (event.button !== 0) return;
        var button = event.target.closest('.life-bubble-btn');
        if (!button) return;
        startBubbleLongPress(button, event);
      });

      lifeBubbleStrip.addEventListener('mousemove', function(event) {
        handleBubbleMove(event);
      });

      lifeBubbleStrip.addEventListener('mouseup', function() {
        cancelBubbleLongPress();
      });

      lifeBubbleStrip.addEventListener('mouseleave', function() {
        cancelBubbleLongPress();
      });

      lifeBubbleStrip.addEventListener('contextmenu', function(event) {
        var button = event.target.closest('.life-bubble-btn');
        if (!button) return;
        event.preventDefault();
      });

      lifeBubbleStrip.addEventListener('click', function(event) {
        if (bubbleMenuState.longPressTriggered) {
          bubbleMenuState.longPressTriggered = false;
          return;
        }
        var button = event.target.closest('.life-bubble-btn');
        if (!button) return;
        if (button.id === 'lifeAddPersonBubble') {
          openPeopleForm();
          return;
        }
        var personId = button.dataset.personId;
        if (!personId) return;
        if (lifeUiPrefs.groupMode) {
          setActivePersonId(personId);
          updateGroupSelection(personId);
          openMemberPanel(personId);
        } else {
          setActivePersonId(personId);
          renderLifeView();
          openMemberPanel(personId);
        }
      });
    }

    if (lifeBubbleMenuOverlay) {
      lifeBubbleMenuOverlay.addEventListener('click', function(event) {
        if (event.target === lifeBubbleMenuOverlay) {
          closeBubbleMenu();
        }
      });
    }

    if (lifeBubbleMenu) {
      lifeBubbleMenu.addEventListener('click', function(event) {
        var actionButton = event.target.closest('[data-action]');
        if (!actionButton) return;
        var personId = bubbleMenuState.personId;
        if (!personId) return;
        var action = actionButton.dataset.action;
        closeBubbleMenu();
        if (action === 'details') {
          setActivePersonId(personId);
          openMemberPanel(personId);
        }
        if (action === 'remove') {
          setActivePersonId(personId);
          openRemoveModal();
        }
      });
    }

    window.addEventListener('resize', function() {
      if (bubbleMenuState.isOpen) {
        positionBubbleMenu(bubbleMenuState.anchorEl);
      }
    });

    if (lifePersonRoleInput) {
      lifePersonRoleInput.addEventListener('change', function() {
        updateRoleCustomVisibility(lifePersonRoleInput, lifePersonRoleCustomInput);
      });
    }

    if (lifePersonNameInput) {
      lifePersonNameInput.addEventListener('input', function() {
        if (!pendingAvatarDataUrl) {
          setPhotoPreview('', this.value);
        }
      });
    }

    if (lifePersonPhotoInput) {
      lifePersonPhotoInput.addEventListener('change', function(event) {
        var file = event.target.files && event.target.files[0];
        if (!file) return;
        compressImageFile(file, function(dataUrl) {
          pendingAvatarDataUrl = dataUrl;
          pendingAvatarType = 'photo';
          setPhotoPreview(dataUrl, '');
        });
      });
    }

    if (lifePersonForm) {
      lifePersonForm.addEventListener('submit', function(event) {
        event.preventDefault();
        saveNewPerson();
      });
    }

    if (lifePersonModal) {
      lifePersonModal.addEventListener('click', function(event) {
        if (event.target.dataset.close !== undefined) {
          setPeopleModalVisible(false);
        }
      });
    }

    if (lifePersonModalClose) {
      lifePersonModalClose.addEventListener('click', function() {
        setPeopleModalVisible(false);
      });
    }

    if (lifeMemberPanel) {
      lifeMemberPanel.addEventListener('click', function(event) {
        if (event.target.dataset.close !== undefined) {
          closeMemberPanel();
        }
      });
    }

    if (lifeMemberPanelClose) {
      lifeMemberPanelClose.addEventListener('click', function() {
        closeMemberPanel();
      });
    }

    if (lifePersonCancel) {
      lifePersonCancel.addEventListener('click', function() {
        setPeopleModalVisible(false);
      });
    }

    if (lifeEditToggle) {
      lifeEditToggle.addEventListener('click', function() {
        setEditMode(true);
      });
    }

    if (lifeEditButton) {
      lifeEditButton.addEventListener('click', function() {
        setEditMode(true);
      });
    }

    if (lifeEditRole) {
      lifeEditRole.addEventListener('change', function() {
        updateRoleCustomVisibility(lifeEditRole, lifeEditRoleCustom);
      });
    }

    if (lifeEditForm) {
      lifeEditForm.addEventListener('submit', function(event) {
        event.preventDefault();
        saveActivePersonEdits();
      });
    }

    if (lifeEditSave) {
      lifeEditSave.addEventListener('click', function(event) {
        event.preventDefault();
        saveActivePersonEdits();
      });
    }

    if (lifeEditCancel) {
      lifeEditCancel.addEventListener('click', function() {
        setEditMode(false);
        renderActivePanel();
      });
    }

    if (lifeCustomizeButton) {
      lifeCustomizeButton.addEventListener('click', function() {
        openLifePrefsModal();
      });
    }

    if (lifeRemoveButton) {
      lifeRemoveButton.addEventListener('click', openRemoveModal);
    }

    if (lifeRemoveModal) {
      lifeRemoveModal.addEventListener('click', function(event) {
        if (event.target.dataset.close !== undefined) {
          setRemoveModalVisible(false);
        }
      });
    }

    if (lifeRemoveModalClose) {
      lifeRemoveModalClose.addEventListener('click', function() {
        setRemoveModalVisible(false);
      });
    }

    if (lifeRemoveCancel) {
      lifeRemoveCancel.addEventListener('click', function() {
        setRemoveModalVisible(false);
      });
    }

    if (lifeRemoveConfirm) {
      lifeRemoveConfirm.addEventListener('click', confirmRemovePerson);
    }

    if (lifePrefsModal) {
      lifePrefsModal.addEventListener('click', function(event) {
        if (event.target.dataset.close !== undefined) {
          setLifePrefsModalVisible(false);
        }
      });
    }

    if (lifePrefsModalClose) {
      lifePrefsModalClose.addEventListener('click', function() {
        setLifePrefsModalVisible(false);
      });
    }

    if (lifePrefsCancel) {
      lifePrefsCancel.addEventListener('click', function() {
        setLifePrefsModalVisible(false);
      });
    }

    if (lifePrefsForm) {
      lifePrefsForm.addEventListener('submit', function(event) {
        event.preventDefault();
        saveLifePrefsFromForm();
      });
    }

    if (shortGoalAdd) {
      shortGoalAdd.addEventListener('click', function() {
        var text = shortGoalInput.value.trim();
        if (!text) return;
        var areaId = shortGoalArea ? shortGoalArea.value : getDefaultAreaId();
        goalsShort.unshift({
          id: generateGoalId('short'),
          text: text,
          done: false,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          createdAt: Date.now(),
          completedAt: null
        });
        shortGoalInput.value = '';
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
      });
    }

    if (shortGoalInput) {
      shortGoalInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
          event.preventDefault();
          shortGoalAdd.click();
        }
      });
    }

    if (shortGoalClear) {
      shortGoalClear.addEventListener('click', function() {
        goalsShort = goalsShort.filter(function(goal) { return !goal.done; });
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
      });
    }

    if (longGoalForm) {
      longGoalForm.addEventListener('submit', function(event) {
        event.preventDefault();
        var title = longGoalTitle.value.trim();
        if (!title) return;
        var note = longGoalNote.value.trim();
        var date = longGoalDate.value;
        var areaId = longGoalArea ? longGoalArea.value : getDefaultAreaId();
        if (editingLongGoalId) {
          goalsLong = goalsLong.map(function(goal) {
            if (goal.id !== editingLongGoalId) return goal;
          return {
            id: goal.id,
            title: title,
            note: note,
            targetDate: date || null,
            areaId: areaId,
            ownerName: getAreaOwnerName(areaId),
            personId: goal.personId || null,
            createdAt: goal.createdAt,
            updatedAt: Date.now()
          };
        });
      } else {
        goalsLong.unshift({
          id: generateGoalId('long'),
          title: title,
          note: note,
          targetDate: date || null,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          createdAt: Date.now(),
          updatedAt: Date.now()
        });
        }
        saveGoalsViewLong();
        renderLongGoals();
        renderGoalsNudge();
        renderLifeGoals();
        resetLongGoalForm();
      });
    }

    if (longGoalCancel) {
      longGoalCancel.addEventListener('click', function() {
        resetLongGoalForm();
      });
    }

    if (goalsAreaFilter) {
      goalsAreaFilter.addEventListener('change', function() {
        goalsAreaFilterValue = this.value;
        renderAreaSelects();
        renderShortGoals();
        renderLongGoals();
      });
    }

    if (lifeAreaFilter) {
      lifeAreaFilter.addEventListener('change', function() {
        lifeAreaFilterValue = this.value;
        renderAreaSelects();
        renderLifeToday();
        renderLifeGoals();
        renderLifeTasks();
        renderLifeCalendar();
      });
    }

    if (lifeTabs) {
      lifeTabs.addEventListener('click', function(event) {
        var button = event.target.closest('.life-tab');
        if (!button) return;
        setLifeTab(button.dataset.tab || 'today');
      });
    }

    if (lifeAddPersonPrimary) {
      lifeAddPersonPrimary.addEventListener('click', function() {
        setLifeTab('people');
        setPersonViewActive(false);
        openPeopleForm();
      });
    }

    if (lifePeopleFormCancel) {
      lifePeopleFormCancel.addEventListener('click', function() {
        setPeopleFormVisible(false);
        resetPeopleForm();
      });
    }

    if (lifePersonBack) {
      lifePersonBack.addEventListener('click', function() {
        setPersonViewActive(false);
        setLifeTab('people');
      });
    }

    if (lifeAppointmentsToggle && lifeAppointmentsBody) {
      lifeAppointmentsToggle.addEventListener('click', function() {
        var isExpanded = lifeAppointmentsToggle.getAttribute('aria-expanded') === 'true';
        lifeAppointmentsToggle.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
        lifeAppointmentsBody.classList.toggle('is-collapsed', isExpanded);
      });
    }

    if (lifeAppointmentsAdd) {
      lifeAppointmentsAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        openAppointmentModal(appointmentModalContexts.life, null, { lockPersonId: activePersonId });
      });
    }

    if (lifeAppointmentsScan) {
      lifeAppointmentsScan.addEventListener('click', function() {
        if (!activePersonId) return;
        openAppointmentModal(appointmentModalContexts.life, null, { lockPersonId: activePersonId, showSummary: false });
        if (appointmentModalContexts.life && appointmentModalContexts.life.textInput) {
          appointmentModalContexts.life.textInput.focus();
        }
      });
    }

    if (lifeAppointmentsPastToggle) {
      lifeAppointmentsPastToggle.addEventListener('click', function() {
        lifeAppointmentsPastExpanded = !lifeAppointmentsPastExpanded;
        renderPersonAppointments(activePersonId);
      });
    }

    if (lifeTasksToggle && lifeTasksBody) {
      lifeTasksToggle.addEventListener('click', function() {
        var isExpanded = lifeTasksToggle.getAttribute('aria-expanded') === 'true';
        lifeTasksToggle.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
        lifeTasksBody.classList.toggle('is-collapsed', isExpanded);
      });
    }

    if (lifeTasksAddTrigger) {
      lifeTasksAddTrigger.addEventListener('click', function() {
        openPersonTaskForm();
      });
    }

    if (lifeTasksCancel) {
      lifeTasksCancel.addEventListener('click', function() {
        closePersonTaskForm();
      });
    }

    if (lifeTasksSave) {
      lifeTasksSave.addEventListener('click', function() {
        if (!activePersonId) return;
        var title = lifeTasksTitle ? lifeTasksTitle.value.trim() : '';
        if (!title) {
          if (lifeTasksTitle) lifeTasksTitle.focus();
          return;
        }
        var notes = lifeTasksNotes ? lifeTasksNotes.value.trim() : '';
        var barrier = lifeTasksBarrier ? lifeTasksBarrier.value : '';
        if (TASK_BARRIERS.indexOf(barrier) === -1) {
          barrier = '';
        }
        if (personTaskEditingId) {
          tasks = tasks.map(function(task) {
            if (task.id !== personTaskEditingId) return task;
            task.title = title;
            task.text = title;
            task.notes = notes;
            task.barrier = barrier;
            task.updatedAt = Date.now();
            task.personId = activePersonId;
            task.scope = 'person';
            if (!task.status) task.status = task.done ? 'done' : 'open';
            return task;
          });
        } else {
          tasks.unshift({
            id: generateGoalId('task'),
            personId: activePersonId,
            title: title,
            text: title,
            notes: notes,
            barrier: barrier,
            createdAt: Date.now(),
            updatedAt: Date.now(),
            status: 'open',
            done: false,
            aiPlan: null,
            scope: 'person',
            steps: [],
            ui: { collapsed: false, hideCompleted: false, clarification: null }
          });
        }
        saveTasks();
        closePersonTaskForm();
        renderPersonTasks(activePersonId);
      });
    }

    if (lifeTasksCompletedToggle) {
      lifeTasksCompletedToggle.addEventListener('click', function() {
        personTasksCompletedExpanded = !personTasksCompletedExpanded;
        renderPersonTasks(activePersonId);
      });
    }

    if (lifeAgendaRange) {
      lifeAgendaRange.addEventListener('click', function(event) {
        var button = event.target.closest('.life-agenda-segment');
        if (!button) return;
        if (button.dataset.range === 'today') {
          setAgendaRange(1);
          return;
        }
        var days = parseInt(button.dataset.range, 10);
        if (!Number.isNaN(days)) {
          setAgendaRange(days);
        }
      });
    }

    if (lifePersonParkedToggle) {
      lifePersonParkedToggle.addEventListener('click', function() {
        var isExpanded = lifePersonParkedToggle.getAttribute('aria-expanded') === 'true';
        lifePersonParkedToggle.setAttribute('aria-expanded', isExpanded ? 'false' : 'true');
        lifePersonParkedToggle.lastElementChild.textContent = isExpanded ? '+' : 'âˆ’';
        if (lifePersonParkedList) {
          lifePersonParkedList.style.display = isExpanded ? 'none' : 'block';
        }
      });
    }

    if (lifePeopleSave) {
      lifePeopleSave.addEventListener('click', function() {
        var name = lifePersonName ? lifePersonName.value.trim() : '';
        if (!name) {
          alert('Please enter a name.');
          if (lifePersonName) lifePersonName.focus();
          return;
        }
        var role = lifePersonRole ? lifePersonRole.value.trim() : '';
        if (!role) {
          alert('Please select a role.');
          if (lifePersonRole) lifePersonRole.focus();
          return;
        }
        var customRole = lifePersonCustomRole ? lifePersonCustomRole.value.trim() : '';
        if (role === 'Other' && !customRole) {
          alert('Please enter a custom role.');
          if (lifePersonCustomRole) lifePersonCustomRole.focus();
          return;
        }
        var org = lifePersonOrg ? lifePersonOrg.value.trim() : '';
        var dob = lifePersonDob ? lifePersonDob.value : '';
        var notes = lifePersonNotes ? lifePersonNotes.value.trim() : '';
        var avatarType = pendingAvatarType === 'photo' && pendingAvatarDataUrl ? 'photo' : 'generated';
        var avatarSeed = pendingAvatarSeed || name || generatePersonId();
        var existingPerson = editingPersonId
          ? people.find(function(person) { return person.id === editingPersonId; })
          : null;
        var accountHolderKey = getAccountHolderKey();
        var isAccountHolder = existingPerson ? existingPerson.isAccountHolder : false;
        if (!isAccountHolder && accountHolderKey && normalizeName(name) === accountHolderKey) {
          isAccountHolder = true;
        }
        var type = existingPerson ? existingPerson.type : '';
        if (isAccountHolder && !type) {
          type = 'me';
        }
        var personRecord = {
          id: editingPersonId || generatePersonId(),
          name: name,
          role: role,
          roleType: deriveRoleType(role, existingPerson ? existingPerson.roleType : null),
          customRole: role === 'Other' ? customRole : '',
          org: org,
          dob: dob,
          notes: notes,
          isAccountHolder: Boolean(isAccountHolder),
          type: type,
          avatarType: avatarType,
          avatarDataUrl: avatarType === 'photo' ? pendingAvatarDataUrl : '',
          avatarSeed: avatarSeed,
          createdAt: existingPerson && existingPerson.createdAt ? existingPerson.createdAt : Date.now(),
          updatedAt: Date.now()
        };
        if (editingPersonId) {
          setFamilyMembers(people.map(function(person) {
            if (person.id !== editingPersonId) return person;
            return personRecord;
          }));
        } else {
          people.unshift(personRecord);
        }
        savePeople();
        renderPeopleOverview();
        setPeopleFormVisible(false);
        resetPeopleForm();
      });
    }

    if (lifePersonName) {
      lifePersonName.addEventListener('input', function() {
        if (pendingAvatarType !== 'photo') {
          updateAvatarPreview();
        }
      });
    }

    if (lifePersonRole) {
      lifePersonRole.addEventListener('change', function() {
        updateCustomRoleVisibility();
      });
    }

    if (lifeAvatarRandom) {
      lifeAvatarRandom.addEventListener('click', function() {
        pendingAvatarType = 'generated';
        pendingAvatarDataUrl = '';
        pendingAvatarSeed = generatePersonId();
        if (lifeAvatarHint) {
          lifeAvatarHint.textContent = 'New generated avatar selected.';
        }
        updateAvatarPreview();
      });
    }

    if (lifeAvatarUpload) {
      lifeAvatarUpload.addEventListener('change', function(event) {
        var file = event.target.files && event.target.files[0];
        if (!file) return;
        if (lifeAvatarHint) {
          lifeAvatarHint.textContent = 'Creating thumbnail...';
        }
        createImageThumbnail(file)
          .then(function(dataUrl) {
            pendingAvatarType = 'photo';
            pendingAvatarDataUrl = dataUrl;
            if (lifeAvatarHint) {
              lifeAvatarHint.textContent = 'Photo ready. Saved on this device.';
            }
            updateAvatarPreview();
          })
          .catch(function() {
            pendingAvatarType = 'generated';
            pendingAvatarDataUrl = '';
            pendingAvatarSeed = generatePersonId();
            if (lifeAvatarHint) {
              lifeAvatarHint.textContent = 'Photo upload failed. Using a generated avatar instead.';
            }
            updateAvatarPreview();
          });
      });
    }

    if (lifePersonTaskAdd) {
      lifePersonTaskAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        var text = lifePersonTaskText ? lifePersonTaskText.value.trim() : '';
        if (!text) return;
        var areaId = getDefaultAreaId();
        tasks.unshift({
          id: generateGoalId('task'),
          title: text,
          text: text,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId,
          tags: [],
          needsOtherPeople: false,
          needsAppointment: false,
          energyType: '',
          status: 'open',
          done: false,
          createdAt: Date.now(),
          updatedAt: Date.now(),
          dueDate: null,
          scope: 'person',
          steps: [],
          ui: { collapsed: false, hideCompleted: false, clarification: null }
        });
        saveTasks();
        renderLifeTasks();
        renderLifeToday();
        renderLinkedTaskOptions();
        if (lifePersonTaskText) lifePersonTaskText.value = '';
        renderPersonRightNow(activePersonId);
        renderPersonTasks(activePersonId);
      });
    }

    if (lifePersonApptAdd) {
      lifePersonApptAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        var title = lifePersonApptTitle ? lifePersonApptTitle.value.trim() : '';
        var start = lifePersonApptStart ? lifePersonApptStart.value : '';
        if (!title || !start) return;
        var areaId = getDefaultAreaId();
        appointments.unshift({
          id: generateGoalId('appt'),
          title: title,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId,
          dateTimeStart: start,
          dateTimeEnd: null,
          location: '',
          notes: '',
          linkedTaskIds: [],
          createdAt: Date.now()
        });
        saveAppointments();
        renderLifeCalendar();
        if (lifePersonApptTitle) lifePersonApptTitle.value = '';
        if (lifePersonApptStart) lifePersonApptStart.value = '';
        renderPersonComingUp(activePersonId);
      });
    }

    if (lifePersonGoalAdd) {
      lifePersonGoalAdd.addEventListener('click', function() {
        if (!activePersonId) return;
        var text = lifePersonGoalText ? lifePersonGoalText.value.trim() : '';
        if (!text) return;
        var areaId = getDefaultAreaId();
        goalsShort.unshift({
          id: generateGoalId('short'),
          text: text,
          done: false,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId,
          createdAt: Date.now(),
          completedAt: null
        });
        saveGoalsViewShort();
        renderShortGoals();
        renderLifeToday();
        if (lifePersonGoalText) lifePersonGoalText.value = '';
        renderPersonRightNow(activePersonId);
      });
    }

    if (lifeTaskAdd) {
      lifeTaskAdd.addEventListener('click', function() {
        var text = lifeTaskText.value.trim();
        if (!text) return;
        var areaId = lifeTaskArea ? lifeTaskArea.value : getDefaultAreaId();
        var tags = lifeTaskTags.value.split(',').map(function(t) { return t.trim(); }).filter(Boolean);
        if (editingTaskId) {
          tasks = tasks.map(function(task) {
            if (task.id !== editingTaskId) return task;
            task.text = text;
            task.title = text;
            task.areaId = areaId;
            task.ownerName = getAreaOwnerName(areaId);
            task.personId = task.personId || null;
            task.tags = tags;
            task.needsOtherPeople = lifeTaskNeedsPeople.checked;
            task.needsAppointment = lifeTaskNeedsAppt.checked;
            task.energyType = lifeTaskEnergy.value || '';
            task.updatedAt = Date.now();
            task.dueDate = lifeTaskDue.value || null;
            task.scope = 'life';
            task.status = task.done ? 'done' : 'open';
            return task;
          });
        } else {
          tasks.unshift({
            id: generateGoalId('task'),
            title: text,
            text: text,
            areaId: areaId,
            ownerName: getAreaOwnerName(areaId),
            personId: activePersonId || null,
            tags: tags,
            needsOtherPeople: lifeTaskNeedsPeople.checked,
            needsAppointment: lifeTaskNeedsAppt.checked,
            energyType: lifeTaskEnergy.value || '',
            status: 'open',
            done: false,
            createdAt: Date.now(),
            updatedAt: Date.now(),
            dueDate: lifeTaskDue.value || null,
            scope: 'life',
            steps: [],
            ui: { collapsed: false, hideCompleted: false, clarification: null }
          });
        }
        saveTasks();
        renderLifeTasks();
        renderLifeToday();
        renderLinkedTaskOptions();
        editingTaskId = null;
        lifeTaskText.value = '';
        lifeTaskTags.value = '';
        lifeTaskDue.value = '';
        lifeTaskNeedsPeople.checked = false;
        lifeTaskNeedsAppt.checked = false;
        lifeTaskEnergy.value = '';
        lifeTaskAdd.textContent = 'Add task';
        lifeTaskCancel.style.display = 'none';
      });
    }

    if (lifeTaskCancel) {
      lifeTaskCancel.addEventListener('click', function() {
        editingTaskId = null;
        lifeTaskText.value = '';
        lifeTaskTags.value = '';
        lifeTaskDue.value = '';
        lifeTaskNeedsPeople.checked = false;
        lifeTaskNeedsAppt.checked = false;
        lifeTaskEnergy.value = '';
        lifeTaskAdd.textContent = 'Add task';
        lifeTaskCancel.style.display = 'none';
      });
    }

    if (lifeApptAdd) {
      lifeApptAdd.addEventListener('click', function() {
        var title = lifeApptTitle.value.trim();
        if (!title) return;
        var areaId = lifeApptArea ? lifeApptArea.value : getDefaultAreaId();
        var selectedTasks = Array.from(lifeApptLinkedTasks.options).filter(function(opt) { return opt.selected; }).map(function(opt) { return opt.value; });
        if (editingApptId) {
          appointments = appointments.map(function(appt) {
            if (appt.id !== editingApptId) return appt;
          return {
            id: appt.id,
            title: title,
            areaId: areaId,
            ownerName: getAreaOwnerName(areaId),
            personId: appt.personId || null,
            dateTimeStart: lifeApptStart.value,
            dateTimeEnd: lifeApptEnd.value || null,
            location: lifeApptLocation.value.trim(),
            notes: lifeApptNotes.value.trim(),
            linkedTaskIds: selectedTasks,
            createdAt: appt.createdAt
          };
        });
      } else {
        appointments.unshift({
          id: generateGoalId('appt'),
          title: title,
          areaId: areaId,
          ownerName: getAreaOwnerName(areaId),
          personId: activePersonId || null,
          dateTimeStart: lifeApptStart.value,
          dateTimeEnd: lifeApptEnd.value || null,
          location: lifeApptLocation.value.trim(),
          notes: lifeApptNotes.value.trim(),
          linkedTaskIds: selectedTasks,
          createdAt: Date.now()
        });
        }
        saveAppointments();
        renderLifeCalendar();
        editingApptId = null;
        lifeApptTitle.value = '';
        lifeApptStart.value = '';
        lifeApptEnd.value = '';
        lifeApptLocation.value = '';
        lifeApptNotes.value = '';
        Array.from(lifeApptLinkedTasks.options).forEach(function(option) { option.selected = false; });
        lifeApptAdd.textContent = 'Add appointment';
        lifeApptCancel.style.display = 'none';
      });
    }

    if (lifeApptCancel) {
      lifeApptCancel.addEventListener('click', function() {
        editingApptId = null;
        lifeApptTitle.value = '';
        lifeApptStart.value = '';
        lifeApptEnd.value = '';
        lifeApptLocation.value = '';
        lifeApptNotes.value = '';
        Array.from(lifeApptLinkedTasks.options).forEach(function(option) { option.selected = false; });
        lifeApptAdd.textContent = 'Add appointment';
        lifeApptCancel.style.display = 'none';
      });
    }

    if (lifeAddChild) {
      lifeAddChild.addEventListener('click', function() {
        var name = lifeChildName.value.trim();
        if (!name) return;
        var childName = name.startsWith('Child:') ? name : 'Child: ' + name;
        lifeAreas.push({
          id: generateLifeAreaId(),
          name: childName,
          type: 'child',
          createdAt: Date.now()
        });
        lifeChildName.value = '';
        saveLifeAreas();
        renderAreaSelects();
        renderLifeAreasList();
      });
    }

    if (appointmentsAddGlobal) {
      appointmentsAddGlobal.addEventListener('click', function() {
        openAppointmentModal(appointmentModalContexts.calendar, null, { lockPersonId: null });
      });
    }

    if (appointmentsPastToggle) {
      appointmentsPastToggle.addEventListener('click', function() {
        appointmentsPastExpanded = !appointmentsPastExpanded;
        renderAppointmentsView();
      });
    }

    if (calendarPrevMonth) {
      calendarPrevMonth.addEventListener('click', function() {
        calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth() - 1, 1);
        renderCalendarMonth();
      });
    }

    if (calendarNextMonth) {
      calendarNextMonth.addEventListener('click', function() {
        calendarCursor = new Date(calendarCursor.getFullYear(), calendarCursor.getMonth() + 1, 1);
        renderCalendarMonth();
      });
    }

    if (calendarAddEvent) {
      calendarAddEvent.addEventListener('click', function() {
        openEventModal(null, toYmd(new Date()));
      });
    }

    if (calendarDayAdd) {
      calendarDayAdd.addEventListener('click', function() {
        openEventModal(null, calendarSelectedDate || toYmd(new Date()));
      });
    }

    if (calendarDayClose) {
      calendarDayClose.addEventListener('click', function() {
        closeDayModal();
      });
    }

    if (calendarEventClose) {
      calendarEventClose.addEventListener('click', function() {
        closeEventModal();
      });
    }

    if (calendarEventForm) {
      calendarEventForm.addEventListener('submit', handleCalendarSave);
    }

    if (calendarEventDelete) {
      calendarEventDelete.addEventListener('click', function() {
        if (!calendarEditingEventId) return;
        var confirmRemove = window.confirm('Delete this event?');
        if (!confirmRemove) return;
        calendarEvents = calendarEvents.filter(function(item) { return item.id !== calendarEditingEventId; });
        saveCalendarEvents();
        renderCalendarMonth();
        if (calendarSelectedDate) {
          renderDayModal();
        }
        if (activePersonId) {
          renderPersonAgenda(activePersonId);
        }
        closeEventModal();
      });
    }

    if (calendarEventPerson) {
      calendarEventPerson.addEventListener('change', function() {
        updateCalendarPersonPreview();
      });
    }

    if (calendarEventLocation) {
      calendarEventLocation.addEventListener('input', function() {
        updateCalendarDirectionsButton();
      });
    }

    if (calendarEventAllDay) {
      calendarEventAllDay.addEventListener('change', function() {
        updateCalendarEventTimeVisibility();
      });
    }

    if (calendarEventDirections) {
      calendarEventDirections.addEventListener('click', function() {
        if (!calendarEventLocation) return;
        var location = calendarEventLocation.value.trim();
        if (!location) return;
        window.open(buildDirectionsUrl(location), '_blank');
      });
    }

    if (calendarEventRepeat) {
      calendarEventRepeat.addEventListener('change', function() {
        updateCustomRepeatVisibility();
      });
    }

    if (calendarCustomWeekdays) {
      calendarCustomWeekdays.addEventListener('change', function() {
        updateRepeatDayButtons();
      });
    }

    if (calendarDayModal) {
      calendarDayModal.querySelectorAll('[data-close]').forEach(function(el) {
        el.addEventListener('click', function() {
          closeDayModal();
        });
      });
    }

    if (calendarEventModal) {
      calendarEventModal.querySelectorAll('[data-close]').forEach(function(el) {
        el.addEventListener('click', function() {
          closeEventModal();
        });
      });
    }

    if (calendarImportForm) {
      calendarImportForm.addEventListener('submit', handleCalendarImportSave);
    }

    if (calendarImportAllDay) {
      calendarImportAllDay.addEventListener('change', function() {
        updateCalendarImportTimeVisibility();
      });
    }

    if (calendarImportLocation) {
      calendarImportLocation.addEventListener('input', function() {
        updateCalendarImportDirections();
      });
    }

    if (calendarImportDirections) {
      calendarImportDirections.addEventListener('click', function() {
        if (!calendarImportLocation) return;
        var location = calendarImportLocation.value.trim();
        if (!location) return;
        window.open(buildDirectionsUrl(location), '_blank');
      });
    }

    if (calendarImportCancel) {
      calendarImportCancel.addEventListener('click', function() {
        window.location.assign('/#calendar');
      });
    }

    if (calendarImportBack) {
      calendarImportBack.addEventListener('click', function() {
        window.location.assign('/#calendar');
      });
    }

    if (calendarImportBackPerson) {
      calendarImportBackPerson.addEventListener('click', function() {
        var personId = calendarImportPerson ? calendarImportPerson.value : '';
        if (personId) {
          localStorage.setItem('life_focus_person_id', personId);
        }
        window.location.assign('/#life');
      });
    }

    if (calendarImportAddAnother) {
      calendarImportAddAnother.addEventListener('click', function() {
        showCalendarImportForm();
        populateCalendarImportForm();
      });
    }

    if (goalsNudgeBtn) {
      goalsNudgeBtn.addEventListener('click', function() {
        var goalId = goalsNudge.dataset.goalId;
        var target = goalsLong.find(function(goal) { return goal.id === goalId; }) || goalsLong[0];
        if (target) {
          openUnstuckPanel({ source: 'goal', mode: 'break', item: target });
        }
      });
    }

    // Settings event listeners
    document.getElementById('settingsClose').addEventListener('click', hideSettings);

    document.querySelectorAll('input[name="frictionMode"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (isSettingsLocked()) return;
        settings.frictionMode = this.value;
        saveSettings();
        updateDelayAvailability();
      });
    });

    document.querySelectorAll('input[name="messageDelay"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        if (isSettingsLocked()) return;
        settings.messageDelay = parseInt(this.value, 10);
        saveSettings();
      });
    });

    document.getElementById('allowCancelDelay').addEventListener('change', function() {
      if (isSettingsLocked()) return;
      settings.allowCancelDelay = this.checked;
      saveSettings();
    });

    document.getElementById('showShortTermGoal').addEventListener('change', function() {
      if (isSettingsLocked()) return;
      settings.showShortTermGoal = this.checked;
      saveSettings();
    });

    document.getElementById('showLongTermGoal').addEventListener('change', function() {
      if (isSettingsLocked()) return;
      settings.showLongTermGoal = this.checked;
      saveSettings();
      updateBackgroundGoal();
    });

    document.getElementById('btnLockSettings').addEventListener('click', function() {
      if (isSettingsLocked()) return;
      if (confirm('Are you sure? Once locked, you cannot change settings until the timer expires.')) {
        lockSettings();
      }
    });

    var resetFamilyDataBtn = document.getElementById('resetFamilyDataBtn');
    if (resetFamilyDataBtn) {
      resetFamilyDataBtn.addEventListener('click', function() {
        if (isSettingsLocked()) return;
        resetFamilyData();
      });
    }

    // Delay cancel button
    document.getElementById('delayCancelBtn').addEventListener('click', cancelDelay);

    // Lock preset buttons
    document.querySelectorAll('.lock-preset-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var hours = this.dataset.hours;
        var days = this.dataset.days;
        
        document.getElementById('lockDays').value = days || 0;
        document.getElementById('lockHours').value = hours || 0;
        document.getElementById('lockMinutes').value = 0;
      });
    });

    // CHAT HISTORY MANAGEMENT
    function generateChatId() {
      return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function getChatTitle(messages) {
      if (!messages || messages.length === 0) return 'New Chat';
      const firstUserMsg = messages.find(function(m) { return m.role === 'user'; });
      if (firstUserMsg) {
        const title = firstUserMsg.content.substring(0, 40);
        return title.length < firstUserMsg.content.length ? title + '...' : title;
      }
      return 'New Chat';
    }

    function loadChatHistory() {
      const saved = localStorage.getItem('friction_history');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    function saveChatHistory(history) {
      localStorage.setItem('friction_history', JSON.stringify(history));
    }

    function saveCurrentChatToHistory() {
      if (state.messages.length === 0) return;
      
      let history = loadChatHistory();
      const chatData = {
        id: state.currentChatId || generateChatId(),
        messages: state.messages,
        model: state.currentModel,
        updatedAt: Date.now()
      };
      
      // Update existing or add new
      const existingIndex = history.findIndex(function(c) { return c.id === chatData.id; });
      if (existingIndex >= 0) {
        history[existingIndex] = chatData;
      } else {
        history.unshift(chatData);
      }
      
      // Keep only last 50 chats
      history = history.slice(0, 50);
      
      saveChatHistory(history);
      state.currentChatId = chatData.id;
    }

    function loadChatFromHistory(chatId) {
      const history = loadChatHistory();
      const chat = history.find(function(c) { return c.id === chatId; });
      if (chat) {
        state.messages = chat.messages;
        state.currentModel = chat.model;
        state.currentChatId = chat.id;
        modelSelect.value = chat.model;
        saveChatState();
        restoreChatUI();
        closeMenu();
      }
    }

    function deleteChatFromHistory(chatId) {
      let history = loadChatHistory();
      history = history.filter(function(c) { return c.id !== chatId; });
      saveChatHistory(history);
      renderChatHistoryList();
    }

    function renderChatHistoryList() {
      const container = document.getElementById('chatHistoryList');
      const history = loadChatHistory();
      
      if (history.length === 0) {
        container.innerHTML = '<div class="menu-empty">No chats yet</div>';
        return;
      }
      
      container.innerHTML = '';
      history.forEach(function(chat) {
        const item = document.createElement('div');
        item.className = 'menu-history-item';
        if (chat.id === state.currentChatId) {
          item.classList.add('active');
        }
        
        const title = document.createElement('button');
        title.className = 'menu-history-title';
        title.textContent = getChatTitle(chat.messages);
        title.addEventListener('click', function() {
          loadChatFromHistory(chat.id);
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'menu-history-delete';
        deleteBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        deleteBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteChatFromHistory(chat.id);
        });
        
        item.appendChild(title);
        item.appendChild(deleteBtn);
        container.appendChild(item);
      });
    }

    // FRICTION SYSTEM
    let challenge1 = '';
    let challenge2 = '';
    let frictionLevel = 0;
    let lastMessageTime = null;
    let timerInterval = null;
    const RESET_TIME = 2 * 60 * 60 * 1000;

    function loadFrictionState() {
      const saved = localStorage.getItem('friction_state');
      if (saved) {
        const s = JSON.parse(saved);
        lastMessageTime = s.lastMessageTime;
        frictionLevel = s.frictionLevel || 0;
        if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
          frictionLevel = 0;
          lastMessageTime = null;
          saveFrictionState();
        }
      }
    }

    function saveFrictionState() {
      localStorage.setItem('friction_state', JSON.stringify({ frictionLevel, lastMessageTime }));
    }

    function formatTimeRemaining(ms) {
      if (ms <= 0) return '0:00:00';
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      return hours + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
    }

    function updateTimer() {
      const timerEl = document.getElementById('frictionTimer');
      const headerTimerEl = document.getElementById('headerTimer');

      if (!lastMessageTime || frictionLevel === 0) {
        timerEl.textContent = '';
        headerTimerEl.classList.remove('active');
        headerTimerEl.textContent = '';
        return;
      }

      const elapsed = Date.now() - lastMessageTime;
      const remaining = RESET_TIME - elapsed;

      if (remaining <= 0) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
        timerEl.textContent = 'ðŸŽ‰ Reset! Back to Level 1.';
        headerTimerEl.textContent = 'ðŸŽ‰ Level 1';
        if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
        setTimeout(function() { headerTimerEl.classList.remove('active'); }, 5000);
      } else {
        const timeStr = formatTimeRemaining(remaining);
        timerEl.textContent = 'â± Resets in ' + timeStr;
        var maxLevel = settings.frictionMode === 'strict' ? 15 : 7;
        headerTimerEl.textContent = 'L' + Math.min(frictionLevel + 1, maxLevel) + ' Â· ' + timeStr;
        headerTimerEl.classList.add('active');
      }
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    let headerTimerInterval = null;
    function startHeaderTimer() {
      if (headerTimerInterval) clearInterval(headerTimerInterval);
      updateTimer();
      headerTimerInterval = setInterval(updateTimer, 1000);
    }

    function getFrictionConfig() {
      // Strict mode - original hardcore 15 levels
      if (settings.frictionMode === 'strict') {
        const strictConfigs = [
          { rows: 1, length: 6 },   // Level 1
          { rows: 1, length: 8 },   // Level 2
          { rows: 1, length: 10 },  // Level 3
          { rows: 1, length: 12 },  // Level 4
          { rows: 1, length: 14 },  // Level 5
          { rows: 1, length: 16 },  // Level 6
          { rows: 1, length: 18 },  // Level 7
          { rows: 1, length: 20 },  // Level 8
          { rows: 2, length: 12 },  // Level 9
          { rows: 2, length: 14 },  // Level 10
          { rows: 2, length: 16 },  // Level 11
          { rows: 2, length: 18 },  // Level 12
          { rows: 2, length: 20 },  // Level 13
          { rows: 2, length: 20 },  // Level 14
          { rows: 2, length: 20 },  // Level 15
        ];
        return strictConfigs[Math.min(frictionLevel, 14)];
      }
      
      // Full mode - gentle 7 levels, max 10 chars
      const configs = [
        { rows: 1, length: 4 },   // Level 1
        { rows: 1, length: 5 },   // Level 2
        { rows: 1, length: 6 },   // Level 3
        { rows: 1, length: 7 },   // Level 4
        { rows: 1, length: 8 },   // Level 5
        { rows: 1, length: 9 },   // Level 6
        { rows: 1, length: 10 },  // Level 7+
      ];
      return configs[Math.min(frictionLevel, 6)];
    }

    function handlePaste(e) {
      e.preventDefault();
      frictionError.textContent = 'No pasting â€” type it out!';
    }

    function createCharPairs(code, container) {
      container.innerHTML = '';
      
      for (let i = 0; i < code.length; i++) {
        // Create pair container (code on top, input below)
        const pair = document.createElement('div');
        pair.className = 'friction-pair';
        
        // Create display character block
        const charBlock = document.createElement('div');
        charBlock.className = 'friction-char';
        charBlock.textContent = code[i];
        pair.appendChild(charBlock);
        
        // Create input block
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'friction-char-input';
        input.maxLength = 1;
        input.autocomplete = 'off';
        input.autocorrect = 'off';
        input.autocapitalize = 'off';
        input.spellcheck = false;
        input.dataset.index = i;
        input.dataset.expected = code[i];
        
        input.addEventListener('input', handleCharInput);
        input.addEventListener('keydown', handleCharKeydown);
        input.addEventListener('paste', handlePaste);
        input.addEventListener('drop', function(e) { e.preventDefault(); });
        
        pair.appendChild(input);
        container.appendChild(pair);
      }
    }

    function handleCharInput(e) {
      const input = e.target;
      const value = input.value;
      const expected = input.dataset.expected;
      
      if (value) {
        if (value === expected) {
          input.classList.add('success');
          input.classList.remove('error');
          // Move to next input
          const pair = input.closest('.friction-pair');
          const nextPair = pair.nextElementSibling;
          if (nextPair) {
            const nextInput = nextPair.querySelector('.friction-char-input');
            if (nextInput) nextInput.focus();
          }
        } else {
          input.classList.add('error');
          input.classList.remove('success');
        }
      } else {
        input.classList.remove('success', 'error');
      }
      
      checkAllInputs();
    }

    function handleCharKeydown(e) {
      const input = e.target;
      const pair = input.closest('.friction-pair');
      
      if (e.key === 'Backspace' && !input.value) {
        const prevPair = pair.previousElementSibling;
        if (prevPair) {
          const prevInput = prevPair.querySelector('.friction-char-input');
          if (prevInput) {
            prevInput.focus();
            prevInput.select();
          }
        }
      } else if (e.key === 'ArrowLeft') {
        const prevPair = pair.previousElementSibling;
        if (prevPair) {
          const prevInput = prevPair.querySelector('.friction-char-input');
          if (prevInput) prevInput.focus();
        }
      } else if (e.key === 'ArrowRight') {
        const nextPair = pair.nextElementSibling;
        if (nextPair) {
          const nextInput = nextPair.querySelector('.friction-char-input');
          if (nextInput) nextInput.focus();
        }
      }
    }

    function checkAllInputs() {
      const config = getFrictionConfig();
      
      // Check row 1
      const inputs1 = frictionPairs1.querySelectorAll('.friction-char-input');
      let match1 = true;
      inputs1.forEach(function(input) {
        if (input.value !== input.dataset.expected) match1 = false;
      });
      
      // Check row 2 if needed
      let match2 = true;
      if (config.rows === 2) {
        const inputs2 = frictionPairs2.querySelectorAll('.friction-char-input');
        inputs2.forEach(function(input) {
          if (input.value !== input.dataset.expected) match2 = false;
        });
      }
      
      if (match1 && match2) {
        frictionUnlock.disabled = false;
        frictionUnlock.classList.add('ready');
      } else {
        frictionUnlock.disabled = true;
        frictionUnlock.classList.remove('ready');
      }
      
      frictionError.textContent = '';
    }

    function showFriction(message) {
      if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
      }

      state.pendingMessage = message;
      const config = getFrictionConfig();

      // Show short-term goal reminder
      var goalReminder = document.getElementById('frictionGoalReminder');
      var activeGoal = getActiveShortTermGoal();
      if (activeGoal && settings.showShortTermGoal) {
        goalReminder.innerHTML = '<div class="friction-goal-label">Your focus</div><div class="friction-goal-text">"' + activeGoal.text + '"</div>';
      } else {
        goalReminder.innerHTML = '';
      }

      // Show code input row
      document.getElementById('frictionRow1').style.display = 'block';
      
      challenge1 = generateChallenge(config.length);
      createCharPairs(challenge1, frictionPairs1);

      const row2 = document.getElementById('frictionRow2');
      if (config.rows === 2) {
        challenge2 = generateChallenge(config.length);
        createCharPairs(challenge2, frictionPairs2);
        row2.style.display = 'block';
      } else {
        challenge2 = '';
        row2.style.display = 'none';
      }

      frictionUnlock.disabled = true;
      frictionUnlock.classList.remove('ready');
      frictionError.textContent = '';

      const subtitle = document.querySelector('.friction-subtitle');
      if (settings.frictionMode === 'strict') {
        // Strict mode - 15 levels
        if (frictionLevel < 14) {
          subtitle.textContent = 'â˜ ï¸ STRICT Level ' + (frictionLevel + 1) + ' of 15 â€” No mercy.';
        } else {
          subtitle.textContent = 'â˜ ï¸ STRICT Level 15 â€” Maximum punishment. 2hr reset.';
        }
      } else {
        // Full mode - 7 levels
        if (frictionLevel < 6) {
          subtitle.textContent = 'Level ' + (frictionLevel + 1) + ' of 7 â€” Type the code to send.';
        } else {
          subtitle.textContent = 'Level 7 of 7 â€” Maximum friction. Take a 2-hour break to reset.';
        }
      }

      startTimer();
      frictionOverlay.classList.add('active');
      lockBodyScroll();
      document.addEventListener('touchmove', preventTouchMove, { passive: false });
      document.documentElement.style.setProperty('--kb', '0px');
      
      // Focus first input
      setTimeout(function() {
        const firstInput = frictionPairs1.querySelector('.friction-char-input');
        if (firstInput) firstInput.focus();
      }, 10);
    }

    function hideFriction() {
      frictionOverlay.classList.remove('active');
      state.pendingMessage = null;
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      document.removeEventListener('touchmove', preventTouchMove);
      unlockBodyScroll();
      startHeaderTimer();
      setTimeout(updateKeyboardOffset, 80);
      setTimeout(scrollChatToBottom, 100);
    }

    frictionCancel.addEventListener('click', hideFriction);

    frictionUnlock.addEventListener('click', function() {
      // Only increase level for full or strict friction modes
      if (settings.frictionMode === 'full' || settings.frictionMode === 'strict') {
        var maxLevel = settings.frictionMode === 'strict' ? 14 : 6;
        if (frictionLevel < maxLevel) frictionLevel++;
        lastMessageTime = Date.now();
        saveFrictionState();
      }

      const timerEl = document.getElementById('frictionTimer');

      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }

      // Save the message BEFORE hiding (hideFriction clears pendingMessage)
      const messageToSend = state.pendingMessage;
      
      hideFriction();
      
      // Check if message delay is enabled
      if (settings.messageDelay > 0) {
        showDelayOverlay(messageToSend);
      } else {
        sendMessage(messageToSend);
      }
    });

    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().catch(function() {});
    }

    loadFrictionState();

    // CHAT FUNCTIONS
    function formatMessageContent(content) {
      // Handle code blocks first (before escaping)
      var codeBlockId = 0;
      var codeBlocks = [];

      // Extract fenced code blocks (```lang\ncode```)
      content = content.replace(/```(\w*)\n?([\s\S]*?)```/g, function(match, lang, code) {
        var id = 'code-block-' + (codeBlockId++);
        codeBlocks.push({ id: id, lang: lang || 'text', code: code.trim() });
        return '{{CODE_BLOCK_' + id + '}}';
      });

      // Extract inline code (`code`)
      content = content.replace(/`([^`]+)`/g, function(match, code) {
        return '<span class="inline-code">' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</span>';
      });

      // Convert URLs to clickable links
      var urlRegex = /(https?:\/\/[^\s\]]+)/g;
      var escaped = content
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');

      // Restore inline code (it was escaped)
      escaped = escaped.replace(/&lt;span class="inline-code"&gt;/g, '<span class="inline-code">');
      escaped = escaped.replace(/&lt;\/span&gt;/g, '</span>');

      // Replace URLs with anchor tags
      var withLinks = escaped.replace(urlRegex, function(url) {
        var cleanUrl = url.replace(/[.,;:!?)]+$/, '');
        var trailing = url.substring(cleanUrl.length);
        return '<a href="' + cleanUrl + '" target="_blank" rel="noopener noreferrer">' + cleanUrl + '</a>' + trailing;
      });

      // Convert **text** to bold
      withLinks = withLinks.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

      // Convert line breaks
      withLinks = withLinks.replace(/\n/g, '<br>');

      // Restore code blocks with styled containers
      codeBlocks.forEach(function(block) {
        var codeHtml = '<div class="code-block-container">' +
          '<div class="code-block-header">' +
            '<span class="code-block-lang">' + block.lang + '</span>' +
            '<div style="display:flex;gap:6px;">' +
              '<button class="btn-open-canvas" onclick="openCodeCanvas(this)" data-code="' + encodeURIComponent(block.code) + '" data-lang="' + block.lang + '">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>' +
                'Canvas' +
              '</button>' +
              '<button class="code-copy-btn" onclick="copyCodeBlock(this)" data-code="' + encodeURIComponent(block.code) + '">' +
                '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
                '<span>Copy</span>' +
              '</button>' +
            '</div>' +
          '</div>' +
          '<div class="code-block-content"><pre><code>' + block.code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre></div>' +
        '</div>';
        withLinks = withLinks.replace('{{CODE_BLOCK_' + block.id + '}}', codeHtml);
      });

      return withLinks;
    }

    function copyCodeBlock(button) {
      var code = decodeURIComponent(button.getAttribute('data-code'));
      navigator.clipboard.writeText(code).then(function() {
        button.classList.add('copied');
        button.querySelector('span').textContent = 'Copied!';
        setTimeout(function() {
          button.classList.remove('copied');
          button.querySelector('span').textContent = 'Copy';
        }, 2000);
      });
    }

    function addMessage(content, type, attachments) {
      const div = document.createElement('div');
      div.className = 'message message-' + type;

      if (type === 'ai') {
        div.innerHTML = formatMessageContent(content);
      } else {
        div.textContent = content;
      }

      // Add attachments if any
      if (attachments && attachments.length > 0) {
        attachments.forEach(function(att) {
          if (att.type && att.type.startsWith('image/')) {
            var img = document.createElement('img');
            img.src = att.data;
            img.alt = att.name;
            img.className = 'message-image';
            img.onclick = function() { window.open(att.data, '_blank'); };
            div.appendChild(img);
          } else {
            var fileDiv = document.createElement('div');
            fileDiv.className = 'message-file';
            fileDiv.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span>' + att.name + '</span>';
            div.appendChild(fileDiv);
          }
        });
      }

      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage(content, attachments) {
      // Prevent duplicate sends
      if (state.isProcessing) return;

      // Get attachments from state if not provided directly
      attachments = attachments || state.pendingAttachments || [];
      state.pendingAttachments = [];

      const model = modelSelect.value;
      state.currentModel = model;

      const welcome = chatMessages.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      // Build message content with file contents for AI
      var fullContent = content;
      attachments.forEach(function(att) {
        if (att.type && !att.type.startsWith('image/') && att.data) {
          fullContent += '\n\n[File: ' + att.name + ']\n' + att.data;
        } else if (att.type && att.type.startsWith('image/')) {
          fullContent += '\n\n[Image attached: ' + att.name + ']';
        }
      });

      addMessage(content || 'Sent attachment(s)', 'user', attachments);
      state.messages.push({ role: 'user', content: fullContent });
      saveChatState();
      
      // Update background goal opacity
      updateBackgroundGoal();

      state.isProcessing = true;
      btnSend.disabled = true;

      typingIndicator.classList.add('active');
      chatMessages.appendChild(typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const response = await callBackend(model);
        state.messages.push({ role: 'assistant', content: response });
        saveChatState();
        addMessage(response, 'ai');
      } catch (error) {
        addMessage('Error: ' + error.message, 'error');
      } finally {
        state.isProcessing = false;
        btnSend.disabled = false;
        typingIndicator.classList.remove('active');
        requestAnimationFrame(scrollChatToBottom);
      }
    }

    async function callBackend(model) {
      var idToken = localStorage.getItem('google_id_token');
      if (!idToken) {
        throw new Error('Please sign in again to continue.');
      }
      
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + idToken
        },
        body: JSON.stringify({ model: model, messages: state.messages })
      });

      if (!res.ok) {
        let errorMsg = 'Backend API error';
        try { const error = await res.json(); errorMsg = error.error || errorMsg; } catch (e) {}
        
        // Handle auth errors
        if (res.status === 401) {
          signOut();
          throw new Error('Session expired. Please sign in again.');
        }
        
        throw new Error(errorMsg);
      }

      const data = await res.json();
      return data.response;
    }

    // INPUT HANDLING
    messageInput.addEventListener('input', function() {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
      requestAnimationFrame(scrollChatToBottom);
    });

    function handleSend() {
      const content = messageInput.value.trim();
      const attachments = getAttachmentsForMessage();
      if ((!content && attachments.length === 0) || state.isProcessing) return;
      messageInput.value = '';
      messageInput.style.height = 'auto';

      // Store attachments for later use
      state.pendingAttachments = attachments;

      // Check friction mode
      if (settings.frictionMode === 'off') {
        // No friction - send directly (but check delay)
        if (settings.messageDelay > 0) {
          showDelayOverlay(content);
        } else {
          sendMessage(content, attachments);
        }
      } else if (settings.frictionMode === 'light') {
        // Light mode - show goal only, no typing
        showLightFriction(content);
      } else {
        // Full or Strict mode - show goal + typing code
        showFriction(content);
      }
    }

    function showLightFriction(message) {
      state.pendingMessage = message;
      
      // Show a simplified overlay with just the goal
      var goalReminder = document.getElementById('frictionGoalReminder');
      var activeGoal = getActiveShortTermGoal();
      if (activeGoal && settings.showShortTermGoal) {
        goalReminder.innerHTML = '<div class="friction-goal-label">Your focus</div><div class="friction-goal-text">"' + activeGoal.text + '"</div>';
      } else {
        goalReminder.innerHTML = '<div class="friction-goal-label">Pause & reflect</div><div class="friction-goal-text">Do you really need this right now?</div>';
      }
      
      // Hide code input rows
      document.getElementById('frictionRow1').style.display = 'none';
      document.getElementById('frictionRow2').style.display = 'none';
      
      // Update subtitle
      document.querySelector('.friction-subtitle').textContent = 'Take a moment before sending.';
      
      // Enable send button immediately
      frictionUnlock.disabled = false;
      frictionUnlock.classList.add('ready');
      frictionError.textContent = '';
      
      frictionOverlay.classList.add('active');
      lockBodyScroll();
    }

    btnSend.addEventListener('click', handleSend);

    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // FILE UPLOAD HANDLING
    var pendingAttachments = [];
    var fileUploadInput = document.getElementById('fileUpload');
    var btnAttach = document.getElementById('btnAttach');
    var attachmentPreview = document.getElementById('attachmentPreview');

    btnAttach.addEventListener('click', function() {
      fileUploadInput.click();
    });

    fileUploadInput.addEventListener('change', function(e) {
      var files = Array.from(e.target.files);
      files.forEach(function(file) {
        if (file.size > 10 * 1024 * 1024) {
          alert('File too large: ' + file.name + ' (max 10MB)');
          return;
        }

        var reader = new FileReader();
        reader.onload = function(event) {
          var attachment = {
            id: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
            name: file.name,
            size: file.size,
            type: file.type,
            data: event.target.result
          };
          pendingAttachments.push(attachment);
          renderAttachmentPreview();
        };

        if (file.type.startsWith('image/')) {
          reader.readAsDataURL(file);
        } else {
          reader.readAsText(file);
        }
      });
      e.target.value = '';
    });

    function renderAttachmentPreview() {
      if (pendingAttachments.length === 0) {
        attachmentPreview.style.display = 'none';
        attachmentPreview.innerHTML = '';
        return;
      }

      attachmentPreview.style.display = 'flex';
      attachmentPreview.innerHTML = pendingAttachments.map(function(att) {
        var preview = '';
        if (att.type.startsWith('image/')) {
          preview = '<img src="' + att.data + '" alt="' + att.name + '">';
        } else {
          preview = '<div class="file-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>';
        }
        return '<div class="attachment-item">' +
          preview +
          '<div class="attachment-info">' +
            '<div class="attachment-name">' + att.name + '</div>' +
            '<div class="attachment-size">' + formatFileSize(att.size) + '</div>' +
          '</div>' +
          '<button class="attachment-remove" onclick="removeAttachment(\'' + att.id + '\')">&times;</button>' +
        '</div>';
      }).join('');
    }

    function removeAttachment(id) {
      pendingAttachments = pendingAttachments.filter(function(a) { return a.id !== id; });
      renderAttachmentPreview();
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function getAttachmentsForMessage() {
      var atts = pendingAttachments.slice();
      pendingAttachments = [];
      renderAttachmentPreview();
      return atts;
    }

    // iOS KEYBOARD
    function scrollChatToBottom() {
      if (!chatApp.classList.contains('active')) return;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateKeyboardOffset() {
      if (!window.visualViewport) return;
      const vv = window.visualViewport;
      const keyboardHeight = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);
      const overlayOpen = frictionOverlay.classList.contains('active');
      document.documentElement.style.setProperty('--kb', overlayOpen ? '0px' : (keyboardHeight + 'px'));

      if (!overlayOpen && keyboardHeight > 0 && document.activeElement === messageInput) {
        requestAnimationFrame(function() {
          scrollChatToBottom();
          messageInput.scrollIntoView({ block: 'end', behavior: 'auto' });
        });
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateKeyboardOffset);
      window.visualViewport.addEventListener('scroll', updateKeyboardOffset);
    }

    document.addEventListener('focusin', function(e) {
      if (e.target === messageInput) {
        setTimeout(updateKeyboardOffset, 50);
        setTimeout(scrollChatToBottom, 80);
      }
    });

    document.addEventListener('focusout', function(e) {
      if (e.target === messageInput) {
        setTimeout(function() {
          document.documentElement.style.setProperty('--kb', '0px');
          scrollChatToBottom();
        }, 80);
      }
    });

    updateKeyboardOffset();

    // =================== //
    // CODE CANVAS SYSTEM  //
    // =================== //

    var canvasState = {
      currentLang: 'code',
      isOpen: false
    };

    function openCodeCanvas(button) {
      var code = decodeURIComponent(button.getAttribute('data-code'));
      var lang = button.getAttribute('data-lang') || 'code';

      canvasState.currentLang = lang;
      canvasState.isOpen = true;

      document.getElementById('canvasLang').textContent = lang;
      document.getElementById('canvasEditor').value = code;
      document.getElementById('codeCanvas').classList.add('active');
      document.getElementById('codeCanvasOverlay').classList.add('active');
      document.body.classList.add('scroll-locked');

      updateCanvasInfo();
    }

    function closeCodeCanvas() {
      canvasState.isOpen = false;
      document.getElementById('codeCanvas').classList.remove('active');
      document.getElementById('codeCanvasOverlay').classList.remove('active');
      document.body.classList.remove('scroll-locked');
    }

    function updateCanvasInfo() {
      var editor = document.getElementById('canvasEditor');
      var lines = editor.value.split('\n').length;
      var chars = editor.value.length;
      document.getElementById('canvasInfo').textContent = lines + ' line' + (lines !== 1 ? 's' : '') + ' | ' + chars + ' characters';
    }

    function copyCanvasCode() {
      var code = document.getElementById('canvasEditor').value;
      var btn = document.getElementById('btnCanvasCopy');

      navigator.clipboard.writeText(code).then(function() {
        var originalText = btn.innerHTML;
        btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
        btn.classList.add('primary');
        setTimeout(function() {
          btn.innerHTML = originalText;
          btn.classList.remove('primary');
        }, 2000);
      });
    }

    function downloadCanvasCode() {
      var code = document.getElementById('canvasEditor').value;
      var lang = canvasState.currentLang;

      var extensions = {
        javascript: 'js', js: 'js', python: 'py', py: 'py',
        html: 'html', css: 'css', json: 'json', typescript: 'ts',
        ts: 'ts', java: 'java', cpp: 'cpp', c: 'c', go: 'go',
        rust: 'rs', ruby: 'rb', php: 'php', swift: 'swift',
        kotlin: 'kt', sql: 'sql', bash: 'sh', shell: 'sh',
        yaml: 'yaml', yml: 'yml', xml: 'xml', markdown: 'md', md: 'md'
      };

      var ext = extensions[lang.toLowerCase()] || 'txt';
      var filename = 'code.' + ext;

      var blob = new Blob([code], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Canvas event listeners (wait for DOM to be ready)
    window.addEventListener('load', function() {
      document.getElementById('btnCanvasClose').addEventListener('click', closeCodeCanvas);
      document.getElementById('codeCanvasOverlay').addEventListener('click', closeCodeCanvas);
      document.getElementById('btnCanvasCopy').addEventListener('click', copyCanvasCode);
      document.getElementById('btnCanvasDownload').addEventListener('click', downloadCanvasCode);
      document.getElementById('canvasEditor').addEventListener('input', updateCanvasInfo);

      // Handle tab key in canvas editor
      document.getElementById('canvasEditor').addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
          e.preventDefault();
          var start = this.selectionStart;
          var end = this.selectionEnd;
          this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
          this.selectionStart = this.selectionEnd = start + 2;
          updateCanvasInfo();
        }
        if (e.key === 'Escape') {
          closeCodeCanvas();
        }
      });
    });

  </script>

  <!-- CODE CANVAS -->
  <div class="code-canvas-overlay" id="codeCanvasOverlay"></div>
  <div class="code-canvas" id="codeCanvas">
    <div class="code-canvas-header">
      <div class="code-canvas-title">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="16 18 22 12 16 6"></polyline>
          <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        <span>Code Canvas</span>
        <span class="code-canvas-lang" id="canvasLang">code</span>
      </div>
      <div class="code-canvas-actions">
        <button class="btn-canvas-action" id="btnCanvasCopy" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
          </svg>
          Copy
        </button>
        <button class="btn-canvas-action" id="btnCanvasDownload" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Download
        </button>
        <button class="btn-canvas-close" id="btnCanvasClose" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    </div>
    <div class="code-canvas-body">
      <textarea class="code-canvas-editor" id="canvasEditor" placeholder="Code will appear here..." spellcheck="false"></textarea>
    </div>
    <div class="code-canvas-footer">
      <span class="code-canvas-info" id="canvasInfo">0 lines</span>
    </div>
  </div>

</body>
</html>
