<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Friction AI - Reduce the Noise</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
    /* -----------------------------------------------------------
       CORE VARIABLES & RESET
    ----------------------------------------------------------- */
    :root {
      --primary: #0f172a;
      --secondary: #334155;
      --accent: #4f9d9a; /* Teal accent */
      --bg-light: #f8fafc;
      --white: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: var(--bg-light);
      color: var(--text-main);
      line-height: 1.6;
    }

    a { text-decoration: none; color: inherit; transition: opacity 0.2s; }
    ul { list-style: none; }
    button { cursor: pointer; font-family: inherit; }

    /* -----------------------------------------------------------
       HEADER & NAVIGATION
    ----------------------------------------------------------- */
    header {
      background: var(--white);
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo { font-size: 1.5rem; font-weight: 700; color: var(--primary); letter-spacing: -0.5px; }
    .logo span { color: var(--accent); }

    .nav-links { display: flex; gap: 2rem; align-items: center; }
    .nav-links a { font-weight: 500; color: var(--text-muted); font-size: 0.95rem; }
    .nav-links a:hover { color: var(--primary); }

    /* Google Sign-In container */
    #g_id_onload { display: none; } /* Hidden, auto-handled by Google library */
    .g_id_signin { height: 40px; } 

    /* User Profile (hidden by default) */
    .user-profile {
      display: none; /* Flex when active */
      align-items: center;
      gap: 12px;
    }
    .user-avatar {
      width: 36px; height: 36px; border-radius: 50%;
      background: #e2e8f0; object-fit: cover;
    }
    .btn-signout {
      font-size: 0.85rem; color: var(--text-muted);
      background: none; border: none; text-decoration: underline;
    }

    /* -----------------------------------------------------------
       HERO SECTION
    ----------------------------------------------------------- */
    .hero {
      padding: 5rem 2rem;
      text-align: center;
      background: linear-gradient(180deg, #ffffff 0%, #f1f5f9 100%);
    }
    .hero h1 {
      font-size: 3rem;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 1.5rem;
      letter-spacing: -1px;
      line-height: 1.2;
    }
    .hero p {
      font-size: 1.125rem;
      color: var(--text-muted);
      max-width: 600px;
      margin: 0 auto 3rem auto;
    }

    /* -----------------------------------------------------------
       CHAT INTERFACE
    ----------------------------------------------------------- */
    .chat-interface {
      max-width: 800px;
      margin: 0 auto;
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      border: 1px solid #e2e8f0;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 600px; /* Fixed height for the widget */
    }

    .chat-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8fafc;
    }
    .model-selector {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      color: var(--text-main);
      background: white;
    }

    .chat-history {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Messages */
    .message {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 0.95rem;
      line-height: 1.5;
      position: relative;
    }
    .message.user {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 2px;
    }
    .message.assistant {
      align-self: flex-start;
      background: #f1f5f9;
      color: var(--text-main);
      border-bottom-left-radius: 2px;
    }
    .message p { margin-bottom: 0.5rem; }
    .message p:last-child { margin-bottom: 0; }
    
    /* Code blocks in chat */
    .message pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.85rem;
      margin-top: 8px;
    }
    .message code { font-family: monospace; }

    /* Sources/Citations */
    .sources-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(0,0,0,0.1);
      font-size: 0.8rem;
    }
    .source-link {
      display: block;
      color: var(--accent);
      text-decoration: underline;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat Input Area */
    .chat-input-area {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      background: #f8fafc;
      display: flex;
      gap: 10px;
    }
    .chat-input-area textarea {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      resize: none;
      height: 50px;
      font-family: inherit;
      font-size: 0.95rem;
    }
    .chat-input-area textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79, 157, 154, 0.1);
    }
    .btn-send {
      padding: 0 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s;
    }
    .btn-send:hover { background: var(--secondary); }
    .btn-send:disabled { background: #94a3b8; cursor: not-allowed; }

    /* -----------------------------------------------------------
       FEATURES SECTION
    ----------------------------------------------------------- */
    .features {
      padding: 5rem 2rem;
      max-width: 1200px;
      margin: 0 auto;
    }
    .section-title {
      text-align: center;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 3rem;
      color: var(--primary);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }
    .card {
      background: var(--white);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      border: 1px solid #e2e8f0;
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-5px); }
    .icon { font-size: 2rem; margin-bottom: 1rem; display: block; }
    .card h3 { font-size: 1.25rem; margin-bottom: 0.5rem; }
    .card p { color: var(--text-muted); font-size: 0.95rem; }

    /* -----------------------------------------------------------
       FOOTER
    ----------------------------------------------------------- */
    footer {
      background: var(--primary);
      color: white;
      text-align: center;
      padding: 3rem 2rem;
      margin-top: 4rem;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
      opacity: 0.8;
    }
    .copyright { font-size: 0.85rem; opacity: 0.6; }

    /* -----------------------------------------------------------
       UTILITIES & RESPONSIVE
    ----------------------------------------------------------- */
    .hidden { display: none !important; }

    @media (max-width: 768px) {
      .hero h1 { font-size: 2.25rem; }
      .nav-links { display: none; } /* Mobile menu simplified for now */
      .chat-interface { height: 500px; }
    }
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <header>
    <div class="nav-container">
      <a href="#" class="logo">Friction <span>AI</span></a>
      <nav>
        <ul class="nav-links">
          <li><a href="#">Home</a></li>
          <li><a href="#features">Features</a></li>
          <li><a href="life.html" style="color: var(--accent); font-weight: 600;">Life OS</a></li> 
        </ul>
      </nav>
      
      <div id="authContainer">
        <div id="g_id_onload"
             data-client_id="37442638167-t8m3fql61v05h01qmvall1bki9k88tim.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_select="true"
             data-itp_support="true">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="pill"
             data-theme="outline"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>
      </div>

      <div id="userProfile" class="user-profile">
        <img id="userAvatar" class="user-avatar" src="" alt="Profile" />
        <button onclick="handleSignOut()" class="btn-signout">Sign Out</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <h1>Smart Assistants<br>Without the Friction.</h1>
    <p>A unified interface for family logistics, research, and creative projects. Powered by Gemini, GPT-4, and Claude.</p>
    
    <div class="chat-interface">
      <div class="chat-header">
        <span style="font-weight: 600; color: var(--secondary);">Chat Session</span>
        <select id="modelSelect" class="model-selector">
          <option value="gemini">Gemini 2.0 Flash (Fast)</option>
          <option value="claude">Claude 3.5 Sonnet</option>
          <option value="gpt">GPT-4o</option>
          <option value="grok">Grok 3 (Beta)</option>
          <option value="perplexity">Perplexity (Search)</option>
        </select>
      </div>
      
      <div id="chatHistory" class="chat-history">
        <div class="message assistant">
          <p>Hello! I'm ready to help. Select a model above to get started.</p>
        </div>
      </div>
      
      <div class="chat-input-area">
        <textarea id="chatInput" placeholder="Type your message here..." onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
        <button id="sendBtn" class="btn-send" onclick="sendMessage()">Send</button>
      </div>
    </div>
  </section>

  <section id="features" class="features">
    <h2 class="section-title">Capabilities</h2>
    <div class="grid">
      <div class="card">
        <span class="icon">üîç</span>
        <h3>Deep Research</h3>
        <p>Uses Perplexity and Google Search to find real-time answers with citations.</p>
      </div>
      <div class="card">
        <span class="icon">ü´ß</span>
        <h3>Family OS</h3>
        <p>Manage rosters, appointments, and logistics with our new Bubble interface.</p>
      </div>
      <div class="card">
        <span class="icon">‚ö°</span>
        <h3>Multi-Model</h3>
        <p>Switch between Gemini, GPT-4, and Claude instantly to get the best answer.</p>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-links">
      <a href="#">Privacy</a>
      <a href="#">Terms</a>
      <a href="/admin.html">Admin</a>
    </div>
    <p class="copyright">&copy; 2026 Friction AI. All rights reserved.</p>
  </footer>

  <a href="life.html" style="
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: white;
    padding: 14px 24px;
    border-radius: 50px;
    text-decoration: none;
    font-family: 'Inter', -apple-system, sans-serif;
    font-weight: 600;
    box-shadow: 0 4px 20px rgba(15, 23, 42, 0.4);
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: transform 0.2s;
    border: 2px solid rgba(255,255,255,0.1);
  " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
    <span>Family OS</span>
    <span style="font-size: 1.2rem;">ü´ß</span>
  </a>

  <script>
    // --- GLOBAL AUTH STATE ---
    let currentUser = null;
    let googleIdToken = null;

    // --- GOOGLE AUTH CALLBACK ---
    function handleCredentialResponse(response) {
      console.log("Encoded JWT ID token: " + response.credential);
      googleIdToken = response.credential;
      
      // Decode JWT to get user info (simple decode, verification happens on server)
      const payload = JSON.parse(atob(response.credential.split('.')[1]));
      
      currentUser = {
        name: payload.name,
        email: payload.email,
        picture: payload.picture
      };

      // Save to LocalStorage for persistence across pages
      localStorage.setItem('friction_user', JSON.stringify(currentUser));
      localStorage.setItem('google_id_token', googleIdToken);

      updateUIState(true);
      
      // Optional: Register user in backend
      registerUser(googleIdToken);
    }

    // --- SIGN OUT ---
    function handleSignOut() {
      currentUser = null;
      googleIdToken = null;
      localStorage.removeItem('friction_user');
      localStorage.removeItem('google_id_token');
      google.accounts.id.disableAutoSelect();
      updateUIState(false);
      location.reload();
    }

    // --- UI UPDATES ---
    function updateUIState(isLoggedIn) {
      const authContainer = document.getElementById('authContainer');
      const userProfile = document.getElementById('userProfile');
      
      if (isLoggedIn && currentUser) {
        authContainer.classList.add('hidden');
        userProfile.style.display = 'flex'; // Show profile
        document.getElementById('userAvatar').src = currentUser.picture;
      } else {
        authContainer.classList.remove('hidden');
        userProfile.style.display = 'none';
      }
    }

    // --- CHECK LOGIN ON LOAD ---
    window.onload = function() {
      const savedUser = localStorage.getItem('friction_user');
      const savedToken = localStorage.getItem('google_id_token');
      
      if (savedUser && savedToken) {
        currentUser = JSON.parse(savedUser);
        googleIdToken = savedToken;
        updateUIState(true);
      }
    };

    // --- BACKEND REGISTRATION ---
    async function registerUser(token) {
      try {
        await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
      } catch(e) { console.error("Registration silent fail", e); }
    }

    // --- CHAT LOGIC ---
    const chatHistory = document.getElementById('chatHistory');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const modelSelect = document.getElementById('modelSelect');

    let messageLog = []; // Stores conversation history for context

    async function sendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;

      if (!googleIdToken) {
        alert("Please sign in with Google to use the chat.");
        return;
      }

      // 1. Add User Message to UI
      addMessageToUI('user', text);
      chatInput.value = '';
      sendBtn.disabled = true;
      
      // Update internal log
      messageLog.push({ role: 'user', content: text });

      // 2. Add Loading Indicator
      const loadingId = addLoadingIndicator();

      try {
        const model = modelSelect.value;
        
        // 3. Send to API
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${googleIdToken}`
          },
          body: JSON.stringify({
            model: model,
            messages: messageLog
          })
        });

        const data = await response.json();
        
        // Remove loading
        removeLoadingIndicator(loadingId);

        if (data.error) {
          addMessageToUI('assistant', `‚ö†Ô∏è Error: ${data.error}`);
        } else {
          // 4. Add Assistant Response
          addMessageToUI('assistant', data.response);
          messageLog.push({ role: 'assistant', content: data.response });
        }

      } catch (err) {
        removeLoadingIndicator(loadingId);
        addMessageToUI('assistant', "‚ö†Ô∏è Network error. Please try again.");
        console.error(err);
      }

      sendBtn.disabled = false;
      chatInput.focus();
    }

    // --- HELPER FUNCTIONS ---
    function addMessageToUI(role, text) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      // Use marked to parse markdown
      div.innerHTML = marked.parse(text); 
      chatHistory.appendChild(div);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function addLoadingIndicator() {
      const id = 'loading-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = 'message assistant';
      div.innerHTML = '<p>Thinking...</p>';
      chatHistory.appendChild(div);
      chatHistory.scrollTop = chatHistory.scrollHeight;
      return id;
    }

    function removeLoadingIndicator(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
  </script>

</body>
</html>
