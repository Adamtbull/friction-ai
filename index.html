<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Friction AI - Slow down your AI, on purpose</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet" />

  <style>
    /* =================== */
    /* SAFARI-FRIENDLY BASE */
    /* =================== */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(180deg, #d4e8e6 0%, #e8ecef 100%);
      color: #1f2937;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    button, input, textarea, select {
      font: inherit;
      color: inherit;
      letter-spacing: inherit;
    }

    button,
    input[type="text"],
    textarea,
    select {
      -webkit-appearance: none;
      appearance: none;
    }

    button {
      background: none;
    }

    button, a, input, textarea, select {
      -webkit-tap-highlight-color: transparent;
    }

    /* Lock background scroll when overlay is open */
    body.scroll-locked {
      position: fixed;
      width: 100%;
      overflow: hidden;
    }

    /* iOS safe areas + dynamic viewport */
    :root {
      --teal-light: #d4e8e6;
      --teal-lighter: #e8f4f3;
      --teal: #5a9a94;
      --teal-dark: #4a8a84;
      --grey-light: #e8ecef;
      --grey: #6b7280;
      --grey-dark: #374151;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --white: #ffffff;
      --border: #d1d5db;
      --shadow: rgba(0, 0, 0, 0.05);

      --app-height: 100vh;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      /* Dynamic keyboard offset for iOS Safari */
      --kb: 0px;
    }

    @supports (height: 100dvh) {
      :root { --app-height: 100dvh; }
    }

    /* =================== */
    /* HOMEPAGE STYLES     */
    /* =================== */
    .homepage {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 60px 24px;
      max-width: 600px;
      margin: 0 auto;
    }

    .homepage.hidden {
      display: none;
    }

    .brand {
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 2px;
      color: var(--teal);
      margin-bottom: 24px;
    }

    .headline {
      font-size: 2rem;
      font-weight: 600;
      text-align: center;
      color: var(--text-primary);
      margin-bottom: 16px;
      line-height: 1.3;
    }

    .subheadline {
      font-size: 1rem;
      color: var(--text-secondary);
      text-align: center;
      margin-bottom: 40px;
      max-width: 400px;
    }

    .section {
      width: 100%;
      margin-bottom: 32px;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .section-subtitle {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .section-text {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .section-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .section-list li {
      font-size: 0.95rem;
      color: var(--text-secondary);
      padding-left: 20px;
      position: relative;
      margin-bottom: 8px;
    }

    .section-list li::before {
      content: "â€¢";
      color: var(--teal);
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .philosophy-line {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .divider {
      width: 100%;
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    .cta-section {
      width: 100%;
      text-align: center;
      margin-top: 16px;
    }

    .cta-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .auth-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .btn-oauth {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--white);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-oauth:hover {
      border-color: var(--teal);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .btn-oauth svg {
      width: 18px;
      height: 18px;
      flex: 0 0 auto;
    }

    .btn-primary {
      width: 100%;
      max-width: 320px;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      background: var(--teal);
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      background: var(--teal-dark);
    }

    .footer-note {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 16px;
    }

    /* =================== */
    /* CHAT APP STYLES     */
    /* =================== */
    .chat-app {
      display: none;
      flex-direction: column;
      height: var(--app-height);
      background: linear-gradient(180deg, var(--teal-light) 0%, var(--grey-light) 100%);
    }

    .chat-app.active {
      display: flex;
    }

    .chat-header {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: calc(16px + var(--safe-top)) 20px 16px;
      background: rgba(255, 255, 255, 0.6);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
    }

    .chat-logo {
      font-size: 0.85rem;
      font-weight: 500;
      letter-spacing: 1px;
      color: var(--teal);
    }

    .model-display {
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .header-timer {
      font-size: 0.8rem;
      color: var(--teal);
      background: var(--teal-light);
      padding: 6px 12px;
      border-radius: 20px;
      display: none;
      white-space: nowrap;
    }

    .header-timer.active {
      display: block;
    }

    .chat-controls {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 0;
    }

    .model-select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--white);
      font-size: 0.85rem;
      color: var(--text-primary);
      cursor: pointer;
      outline: none;
    }

    .model-select:focus {
      border-color: var(--teal);
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-icon:hover {
      border-color: var(--teal);
    }

    .btn-icon svg {
      width: 18px;
      height: 18px;
      stroke: var(--grey);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px calc(24px + 50px + 24px + var(--safe-bottom) + var(--kb));
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 0;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      min-width: 0;
    }

    .message-user {
      align-self: flex-end;
      background: var(--teal);
      color: var(--white);
      border-bottom-right-radius: 4px;
    }

    .message-ai {
      align-self: flex-start;
      background: var(--white);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-error {
      align-self: center;
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      font-size: 0.85rem;
    }

    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .welcome-message h2 {
      font-size: 1.3rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .welcome-message p {
      font-size: 0.95rem;
      margin: 0;
    }

    .typing-indicator {
      display: none;
      align-self: flex-start;
      padding: 16px 20px;
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
    }

    .typing-indicator.active {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--teal);
      border-radius: 50%;
      opacity: 0.4;
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { opacity: 0.4; transform: translateY(0); }
      30% { opacity: 1; transform: translateY(-4px); }
    }

    .chat-input-area {
      padding: 16px 20px calc(24px + var(--safe-bottom));
      background: rgba(255, 255, 255, 0.8);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      border-top: 1px solid var(--border);

      /* Keep input above the iOS keyboard */
      transform: translateY(calc(-1 * var(--kb)));
      will-change: transform;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      max-width: 800px;
      margin: 0 auto;
      min-width: 0;
    }

    .chat-input {
      flex: 1;
      min-width: 0;
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--white);
      font-size: 16px; /* prevents iOS Safari zoom */
      color: var(--text-primary);
      resize: none;
      min-height: 50px;
      max-height: 150px;
      outline: none;
      line-height: 1.5;
      overflow: hidden;
    }

    .chat-input:focus {
      border-color: var(--teal);
    }

    .chat-input::placeholder {
      color: var(--grey);
    }

    .btn-send {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: 12px;
      background: var(--teal);
      cursor: pointer;
      transition: all 0.2s ease;
      flex: 0 0 auto;
    }

    .btn-send:hover {
      background: var(--teal-dark);
    }

    .btn-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-send svg {
      width: 20px;
      height: 20px;
      stroke: var(--white);
    }

    /* =================== */
    /* FRICTION OVERLAY    */
    /* =================== */
    .friction-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      overscroll-behavior: contain;
    }

    .friction-overlay.active {
      display: flex;
    }

    .friction-box {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 4px 24px var(--shadow);
    }

    .friction-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .friction-subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0 0 24px;
    }

    .friction-row {
      margin-bottom: 20px;
    }

    .friction-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--grey);
      margin-bottom: 8px;
      display: block;
    }

    .friction-code {
      display: block;
      background: var(--grey-light);
      padding: 12px 16px;
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.95rem;
      letter-spacing: 1px;
      color: var(--text-primary);
      margin-bottom: 10px;
      word-break: break-all;
      user-select: none;
      -webkit-user-select: none;
    }

    .friction-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 16px; /* prevents iOS Safari zoom */
      text-align: center;
      letter-spacing: 1px;
      color: var(--text-primary);
      outline: none;
      transition: border-color 0.2s ease;
      background: var(--white);
    }

    .friction-input:focus {
      border-color: var(--teal);
    }

    .friction-input.success {
      border-color: #22c55e;
    }

    .friction-input.error {
      border-color: #ef4444;
      animation: shake 0.4s ease;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }

    .friction-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .friction-buttons button {
      flex: 1;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-cancel {
      background: var(--grey-light);
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .btn-unlock {
      background: var(--teal);
      border: none;
      color: var(--white);
      opacity: 0.5;
    }

    .btn-unlock:disabled {
      cursor: not-allowed;
    }

    .btn-unlock.ready {
      opacity: 1;
    }

    .friction-error {
      color: #ef4444;
      font-size: 0.85rem;
      margin-top: 8px;
      min-height: 20px;
    }

    .friction-timer {
      color: var(--teal);
      font-size: 0.85rem;
      margin-top: 16px;
      min-height: 20px;
    }

    /* =================== */
    /* MOBILE RESPONSIVE   */
    /* =================== */
    @media (max-width: 600px) {
      .homepage { padding: 40px 20px; }
      .headline { font-size: 1.7rem; }

      .auth-buttons {
        flex-direction: column;
        align-items: center;
      }

      .btn-oauth {
        width: 100%;
        max-width: 280px;
        justify-content: center;
      }

      .friction-code { font-size: 0.8rem; }
      .message { max-width: 90%; }

      .model-display {
        font-size: 0.7rem;
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }
  </style>
</head>

<body>
  <!-- =================== -->
  <!-- HOMEPAGE            -->
  <!-- =================== -->
  <div class="homepage" id="homepage">
    <div class="brand">FRICTION AI</div>

    <h1 class="headline">Slow down your AI â€” on purpose.</h1>

    <p class="subheadline">Friction AI adds intentional pauses before messages are sent, helping reduce impulsive use and increase presence.</p>

    <div class="section">
      <h2 class="section-title">How it works</h2>
      <ul class="section-list">
        <li>You may be asked to type a short code before sending</li>
        <li>Continued use gradually increases the effort</li>
        <li>It caps at two lines and resets after 2 hours</li>
      </ul>
    </div>

    <div class="section">
      <h2 class="section-title">Why</h2>
      <p class="section-subtitle">Tough love, not punishment.</p>
      <p class="section-text">We slow things down because we care about attention, presence, and real-world goals.</p>
    </div>

    <div class="section">
      <h2 class="section-title">Our philosophy</h2>
      <p class="philosophy-line">Ease creates dependency.</p>
      <p class="philosophy-line">Thoughtful friction creates awareness.</p>
      <p class="philosophy-line">We optimise for presence, not engagement.</p>
    </div>

    <div class="divider"></div>

    <div class="cta-section">
      <h2 class="section-title">Try it</h2>
      <p class="cta-text">By continuing, you're choosing a slower AI experience.</p>

      <div class="auth-buttons">
        <button class="btn-oauth" id="btnApple" type="button">
          <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
          </svg>
          Continue with Apple
        </button>

        <button class="btn-oauth" id="btnGoogle" type="button">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Continue with Google
        </button>
      </div>

      <button class="btn-primary" id="btnEmail" type="button">Sign in with email</button>

      <p class="footer-note">Works best in your browser. Home-screen optional.</p>
    </div>
  </div>

  <!-- =================== -->
  <!-- CHAT APPLICATION    -->
  <!-- =================== -->
  <div class="chat-app" id="chatApp">
    <header class="chat-header">
      <div>
        <div class="chat-logo">FRICTION AI</div>
        <div class="model-display" id="modelDisplay">Claude Sonnet 4.5</div>
      </div>
      <div class="header-timer" id="headerTimer"></div>
      <div class="chat-controls">
        <select class="model-select" id="modelSelect">
          <option value="claude">Claude</option>
          <option value="gpt">GPT-4o</option>
          <option value="gemini">Gemini</option>
          <option value="perplexity">Perplexity</option>
          <option value="bing">Bing Search</option>
        </select>

        <button class="btn-icon" id="btnLogout" title="Sign out" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
        </button>
      </div>
    </header>

    <div class="chat-messages" id="chatMessages">
      <div class="welcome-message">
        <h2>Welcome to Friction AI</h2>
        <p>Choose a model and start chatting. Remember: slow is intentional.</p>
      </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>

    <div class="chat-input-area">
      <div class="chat-input-wrapper">
        <textarea class="chat-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>
        <button class="btn-send" id="btnSend" type="button" aria-label="Send message">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- =================== -->
  <!-- FRICTION OVERLAY    -->
  <!-- =================== -->
  <div class="friction-overlay" id="frictionOverlay">
    <div class="friction-box">
      <h2 class="friction-title">Pause & reflect</h2>
      <p class="friction-subtitle">Type both codes exactly to send your message.</p>

      <div class="friction-row">
        <span class="friction-label">Code 1</span>
        <code class="friction-code" id="frictionCode1"></code>
        <input type="text" class="friction-input" id="frictionInput1"
               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      </div>

      <div class="friction-row" id="frictionRow2">
        <span class="friction-label">Code 2</span>
        <code class="friction-code" id="frictionCode2"></code>
        <input type="text" class="friction-input" id="frictionInput2"
               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
      </div>

      <div class="friction-buttons">
        <button class="btn-cancel" id="frictionCancel" type="button">Cancel</button>
        <button class="btn-unlock" id="frictionUnlock" type="button" disabled>Send message</button>
      </div>

      <p class="friction-timer" id="frictionTimer"></p>
      <p class="friction-error" id="frictionError"></p>
    </div>
  </div>

  <script>
    // ===================
    // STATE
    // ===================
    let state = {
      messages: [],
      pendingMessage: null,
      isProcessing: false
    };

    // ===================
    // DOM ELEMENTS
    // ===================
    const homepage = document.getElementById('homepage');
    const chatApp = document.getElementById('chatApp');
    const btnApple = document.getElementById('btnApple');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnEmail = document.getElementById('btnEmail');

    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const btnSend = document.getElementById('btnSend');
    const modelSelect = document.getElementById('modelSelect');
    const modelDisplay = document.getElementById('modelDisplay');
    const btnLogout = document.getElementById('btnLogout');
    const typingIndicator = document.getElementById('typingIndicator');

    const frictionOverlay = document.getElementById('frictionOverlay');
    const frictionCode1 = document.getElementById('frictionCode1');
    const frictionCode2 = document.getElementById('frictionCode2');
    const frictionInput1 = document.getElementById('frictionInput1');
    const frictionInput2 = document.getElementById('frictionInput2');
    const frictionCancel = document.getElementById('frictionCancel');
    const frictionUnlock = document.getElementById('frictionUnlock');
    const frictionError = document.getElementById('frictionError');

    // ===================
    // MODEL DISPLAY
    // ===================
    const modelNames = {
      claude: 'Claude Sonnet 4.5',
      gpt: 'GPT-4o',
      gemini: 'Gemini 2.0 Flash',
      perplexity: 'Perplexity Sonar',
      bing: 'Bing Search'
    };

    function updateModelDisplay() {
      const model = modelSelect.value;
      modelDisplay.textContent = modelNames[model] || model;
    }

    modelSelect.addEventListener('change', updateModelDisplay);

    // ===================
    // BACKGROUND SCROLL LOCK (for overlay)
    // ===================
    let _scrollYBeforeLock = 0;

    function lockBodyScroll() {
      if (document.body.classList.contains('scroll-locked')) return;
      _scrollYBeforeLock = window.scrollY || 0;
      document.body.classList.add('scroll-locked');
      document.body.style.top = `-${_scrollYBeforeLock}px`;
      document.body.style.left = '0';
      document.body.style.right = '0';
    }

    function unlockBodyScroll() {
      if (!document.body.classList.contains('scroll-locked')) return;
      document.body.classList.remove('scroll-locked');
      const top = document.body.style.top;
      document.body.style.top = '';
      document.body.style.left = '';
      document.body.style.right = '';
      const y = top ? parseInt(top, 10) * -1 : _scrollYBeforeLock;
      window.scrollTo(0, y || 0);
    }

    function preventTouchMove(e) {
      const box = document.querySelector('.friction-box');
      if (box && box.contains(e.target)) return;
      e.preventDefault();
    }

    // ===================
    // CODE GENERATION
    // ===================
    function generateChallenge(length) {
      const lower = 'abcdefghjkmnpqrstuvwxyz';
      const upper = 'ABCDEFGHJKMNPQRSTUVWXYZ';
      const numbers = '23456789';
      const symbols = '!@#$%&*^~+-=<>?';

      let result = '';
      for (let i = 0; i < length; i++) {
        const pattern = i % 4;
        let charSet;
        if (pattern === 0) charSet = lower;
        else if (pattern === 1) charSet = symbols;
        else if (pattern === 2) charSet = upper;
        else charSet = numbers;

        result += charSet.charAt(Math.floor(Math.random() * charSet.length));
      }
      return result;
    }

    // ===================
    // NAVIGATION
    // ===================
    function showChat() {
      homepage.classList.add('hidden');
      chatApp.classList.add('active');
      if (lastMessageTime && frictionLevel > 0) startHeaderTimer();
      updateKeyboardOffset();
      scrollChatToBottom();
    }

    function showHomepage() {
      chatApp.classList.remove('active');
      homepage.classList.remove('hidden');
      state.messages = [];
      chatMessages.innerHTML = `
        <div class="welcome-message">
          <h2>Welcome to Friction AI</h2>
          <p>Choose a model and start chatting. Remember: slow is intentional.</p>
        </div>
      `;
      document.documentElement.style.setProperty('--kb', '0px');
    }

    btnApple.addEventListener('click', showChat);
    btnGoogle.addEventListener('click', showChat);
    btnEmail.addEventListener('click', showChat);
    btnLogout.addEventListener('click', showHomepage);

    // ===================
    // FRICTION SYSTEM
    // ===================
    let challenge1 = '';
    let challenge2 = '';
    let frictionLevel = 0; // 0-4
    let lastMessageTime = null;
    let timerInterval = null;
    const RESET_TIME = 2 * 60 * 60 * 1000; // 2 hours

    function loadFrictionState() {
      const saved = localStorage.getItem('friction_state');
      if (saved) {
        const s = JSON.parse(saved);
        lastMessageTime = s.lastMessageTime;
        frictionLevel = s.frictionLevel || 0;

        if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
          frictionLevel = 0;
          lastMessageTime = null;
          saveFrictionState();
        }
      }
    }

    function saveFrictionState() {
      localStorage.setItem('friction_state', JSON.stringify({
        frictionLevel,
        lastMessageTime
      }));
    }

    function formatTimeRemaining(ms) {
      if (ms <= 0) return '0:00:00';
      const hours = Math.floor(ms / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);
      return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function updateTimer() {
      const timerEl = document.getElementById('frictionTimer');
      const headerTimerEl = document.getElementById('headerTimer');

      if (!lastMessageTime || frictionLevel === 0) {
        timerEl.textContent = '';
        headerTimerEl.classList.remove('active');
        headerTimerEl.textContent = '';
        return;
      }

      const elapsed = Date.now() - lastMessageTime;
      const remaining = RESET_TIME - elapsed;

      if (remaining <= 0) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
        timerEl.textContent = 'ðŸŽ‰ Reset! You\'re back to Level 1.';
        headerTimerEl.textContent = 'ðŸŽ‰ Back to Level 1!';

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }

        setTimeout(() => headerTimerEl.classList.remove('active'), 5000);
      } else {
        const timeStr = formatTimeRemaining(remaining);
        timerEl.textContent = `â± Resets to Level 1 in ${timeStr}`;
        headerTimerEl.textContent = `â± Level ${Math.min(frictionLevel + 1, 5)} Â· Resets in ${timeStr}`;
        headerTimerEl.classList.add('active');
      }
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }

    let headerTimerInterval = null;
    function startHeaderTimer() {
      if (headerTimerInterval) clearInterval(headerTimerInterval);
      updateTimer();
      headerTimerInterval = setInterval(updateTimer, 1000);
    }

    function getFrictionConfig() {
      const configs = [
        { rows: 1, length: 6 },
        { rows: 1, length: 10 },
        { rows: 1, length: 14 },
        { rows: 1, length: 18 },
        { rows: 2, length: 20 }
      ];
      return configs[Math.min(frictionLevel, 4)];
    }

    function showFriction(message) {
      if (lastMessageTime && (Date.now() - lastMessageTime > RESET_TIME)) {
        frictionLevel = 0;
        lastMessageTime = null;
        saveFrictionState();
      }

      state.pendingMessage = message;
      const config = getFrictionConfig();

      challenge1 = generateChallenge(config.length);
      frictionCode1.textContent = challenge1;
      frictionInput1.value = '';
      frictionInput1.classList.remove('success', 'error');

      const row2 = document.getElementById('frictionRow2');
      if (config.rows === 2) {
        challenge2 = generateChallenge(config.length);
        frictionCode2.textContent = challenge2;
        frictionInput2.value = '';
        frictionInput2.classList.remove('success', 'error');
        row2.style.display = 'block';
      } else {
        challenge2 = '';
        row2.style.display = 'none';
      }

      frictionUnlock.disabled = true;
      frictionUnlock.classList.remove('ready');
      frictionError.textContent = '';

      const subtitle = document.querySelector('.friction-subtitle');
      if (frictionLevel < 4) {
        subtitle.textContent = `Level ${frictionLevel + 1} of 5 â€” Type the code to send.`;
      } else {
        subtitle.textContent = `Level 5 of 5 â€” Maximum friction. Take a 2-hour break to reset.`;
      }

      startTimer();

      frictionOverlay.classList.add('active');
      lockBodyScroll();
      document.addEventListener('touchmove', preventTouchMove, { passive: false });

      // Overlay open: keep kb offset off, then focus
      document.documentElement.style.setProperty('--kb', '0px');
      setTimeout(() => frictionInput1.focus(), 10);
    }

    function hideFriction() {
      frictionOverlay.classList.remove('active');
      state.pendingMessage = null;

      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }

      document.removeEventListener('touchmove', preventTouchMove);
      unlockBodyScroll();

      startHeaderTimer();

      // Let iOS settle before recalculating viewport/keyboard
      setTimeout(updateKeyboardOffset, 80);
      setTimeout(scrollChatToBottom, 100);
    }

    function checkFrictionInputs() {
      const config = getFrictionConfig();
      const match1 = frictionInput1.value === challenge1;
      const match2 = config.rows === 1 || frictionInput2.value === challenge2;

      frictionInput1.classList.toggle('success', frictionInput1.value && match1);
      frictionInput1.classList.toggle('error', frictionInput1.value && !match1);

      if (config.rows === 2) {
        frictionInput2.classList.toggle('success', frictionInput2.value && match2);
        frictionInput2.classList.toggle('error', frictionInput2.value && !match2);
      }

      if (match1 && match2) {
        frictionUnlock.disabled = false;
        frictionUnlock.classList.add('ready');
      } else {
        frictionUnlock.disabled = true;
        frictionUnlock.classList.remove('ready');
      }

      frictionError.textContent = '';
    }

    function handlePaste(e) {
      e.preventDefault();
      frictionError.textContent = 'No pasting â€” type it out!';
    }

    frictionInput1.addEventListener('input', checkFrictionInputs);
    frictionInput2.addEventListener('input', checkFrictionInputs);
    frictionInput1.addEventListener('paste', handlePaste);
    frictionInput2.addEventListener('paste', handlePaste);
    frictionInput1.addEventListener('drop', e => e.preventDefault());
    frictionInput2.addEventListener('drop', e => e.preventDefault());

    frictionCancel.addEventListener('click', hideFriction);

    frictionUnlock.addEventListener('click', () => {
      const wasMaxLevel = frictionLevel >= 4;

      if (frictionLevel < 4) frictionLevel++;
      lastMessageTime = Date.now();
      saveFrictionState();

      const timerEl = document.getElementById('frictionTimer');

      // IMPORTANT: kill focus BEFORE closing overlay (prevents iOS zoom/pan glitch)
      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }
      frictionInput1.blur();
      frictionInput2.blur();

      if (wasMaxLevel) {
        timerEl.textContent = 'ðŸ”„ Level 5 remains. Timer resets to 2 hours with each message.';
        setTimeout(() => {
          hideFriction();
          sendMessage(state.pendingMessage);
        }, 2000);
      } else {
        hideFriction();
        sendMessage(state.pendingMessage);
      }
    });

    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().catch(() => {});
    }

    loadFrictionState();

    // ===================
    // CHAT FUNCTIONS
    // ===================
    function addMessage(content, type) {
      const div = document.createElement('div');
      div.className = `message message-${type}`;
      div.textContent = content;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    async function sendMessage(content) {
      const model = modelSelect.value;

      const welcome = chatMessages.querySelector('.welcome-message');
      if (welcome) welcome.remove();

      addMessage(content, 'user');
      state.messages.push({ role: 'user', content });

      state.isProcessing = true;
      btnSend.disabled = true;

      typingIndicator.classList.add('active');
      chatMessages.appendChild(typingIndicator);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      try {
        const response = await callBackend(model);
        state.messages.push({ role: 'assistant', content: response });
        addMessage(response, 'ai');
      } catch (error) {
        addMessage(`Error: ${error.message}`, 'error');
      } finally {
        state.isProcessing = false;
        btnSend.disabled = false;
        typingIndicator.classList.remove('active');
        requestAnimationFrame(scrollChatToBottom);
      }
    }

    // ===================
    // BACKEND API CALL
    // ===================
    async function callBackend(model) {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model,
          messages: state.messages
        })
      });

      if (!res.ok) {
        let errorMsg = 'Backend API error';
        try {
          const error = await res.json();
          errorMsg = error.error || errorMsg;
        } catch (_) {}
        throw new Error(errorMsg);
      }

      const data = await res.json();
      return data.response;
    }

    // ===================
    // INPUT HANDLING
    // ===================
    messageInput.addEventListener('input', () => {
      messageInput.style.height = 'auto';
      messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
      requestAnimationFrame(scrollChatToBottom);
    });

    function handleSend() {
      const content = messageInput.value.trim();
      if (!content || state.isProcessing) return;

      messageInput.value = '';
      messageInput.style.height = 'auto';

      showFriction(content);
    }

    btnSend.addEventListener('click', handleSend);

    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSend();
      }
    });

    // ===================
    // iOS KEYBOARD POLISH
    // Fix: only scrollIntoView when chat input is focused,
    // and disable kb offset while overlay is open.
    // ===================
    function scrollChatToBottom() {
      if (!chatApp.classList.contains('active')) return;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateKeyboardOffset() {
      if (!window.visualViewport) return;

      const vv = window.visualViewport;
      const keyboardHeight = Math.max(0, window.innerHeight - vv.height - vv.offsetTop);

      const overlayOpen = frictionOverlay.classList.contains('active');

      // While overlay is open, don't apply kb offset to chat UI
      document.documentElement.style.setProperty('--kb', overlayOpen ? '0px' : (keyboardHeight + 'px'));

      const chatInputFocused = (document.activeElement === messageInput);

      // Only nudge/scroll the chat input when it is actually focused
      if (!overlayOpen && keyboardHeight > 0 && chatInputFocused) {
        requestAnimationFrame(() => {
          scrollChatToBottom();
          messageInput.scrollIntoView({ block: 'end', behavior: 'auto' });
        });
      }
    }

    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', updateKeyboardOffset);
      window.visualViewport.addEventListener('scroll', updateKeyboardOffset);
    }

    document.addEventListener('focusin', (e) => {
      if (e.target === messageInput) {
        setTimeout(updateKeyboardOffset, 50);
        setTimeout(scrollChatToBottom, 80);
      }
    });

    document.addEventListener('focusout', (e) => {
      if (e.target === messageInput) {
        setTimeout(() => {
          document.documentElement.style.setProperty('--kb', '0px');
          scrollChatToBottom();
        }, 80);
      }
    });

    updateKeyboardOffset();
  </script>
</body>
</html>