<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Life Assistant - Family Operations Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* ========================================
       LIFE PAGE - COMPLETE STYLES
       ======================================== */

    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --bg: #f1f5f9;
      --card-bg: #ffffff;
      --household: #0d9488;
      --adult: #3b82f6;
      --child: #f59e0b;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #eab308;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: #334155;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
    }

    [data-theme="dark"] .bubble.type-adult {
      background: #1e3a5f;
    }

    [data-theme="dark"] .bubble.type-child {
      background: #422006;
    }

    [data-theme="dark"] .bubble.type-household {
      background: #134e4a;
    }

    [data-theme="dark"] .profile-avatar.type-adult { background: #1e3a5f; }
    [data-theme="dark"] .profile-avatar.type-child { background: #422006; }
    [data-theme="dark"] .profile-avatar.type-household { background: #134e4a; }

    [data-theme="dark"] .build-tag {
      background: #334155;
    }

    [data-theme="dark"] .screenshot-import-placeholder {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
      border-color: var(--adult);
    }

    [data-theme="dark"] .open-questions {
      background: #422006;
    }

    [data-theme="dark"] .micro-steps {
      background: #334155;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
    }

    /* Main Scrollable Area - contains bubbles and feed */
    .main-scroll-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* BUILD TAG OVERLAY */
    .build-tag {
      position: fixed;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: white;
      font-size: 0.65rem;
      padding: 4px 8px;
      border-radius: 4px;
      z-index: 9999;
      font-weight: 600;
      letter-spacing: 0.5px;
      opacity: 0.7;
    }

    /* ========================================
       HEADER
       ======================================== */
    .app-header {
      background: var(--card-bg);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .app-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .back-btn,
    .settings-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .back-btn:hover,
    .settings-btn:hover {
      background: var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .header-btn:hover {
      background: var(--border);
    }

    .header-btn.active {
      background: var(--adult);
      color: white;
    }

    /* ========================================
       CALENDAR VIEW
       ======================================== */
    .calendar-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .calendar-view.visible {
      display: flex;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0 16px;
    }

    .calendar-nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--card-bg);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .calendar-nav-btn:hover {
      background: var(--border);
    }

    .calendar-month-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekdays span {
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      position: relative;
      transition: all 0.15s;
      min-height: 44px;
    }

    .calendar-day:hover {
      background: var(--border);
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: var(--adult);
      color: white;
    }

    .calendar-day.selected {
      ring: 2px solid var(--adult);
      box-shadow: 0 0 0 2px var(--adult);
    }

    .calendar-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--danger);
    }

    .calendar-day.today.has-events::after {
      background: white;
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .calendar-day-detail {
      margin-top: 16px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      min-height: 100px;
      box-shadow: var(--shadow-sm);
    }

    .calendar-day-detail-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .calendar-day-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .calendar-day-item:last-child {
      margin-bottom: 0;
    }

    .calendar-day-item-time {
      font-weight: 600;
      color: var(--adult);
      min-width: 50px;
    }

    .calendar-day-item-title {
      flex: 1;
    }

    .calendar-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
    }

    .calendar-detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .calendar-detail-header h4 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .calendar-event-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .calendar-no-events {
      text-align: center;
      color: var(--text-muted);
      padding: 24px;
      font-size: 0.9rem;
    }

    .calendar-events-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .calendar-event-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--text-muted);
    }

    .calendar-event-item.appointment {
      border-left-color: var(--adult);
    }

    .calendar-event-item.task {
      border-left-color: var(--success);
    }

    .calendar-event-item.prep {
      border-left-color: var(--warning);
    }

    .calendar-event-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
      width: 28px;
      text-align: center;
    }

    .calendar-event-content {
      flex: 1;
      min-width: 0;
    }

    .calendar-event-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .calendar-event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .calendar-event-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ========================================
       SHOPPING LIST VIEW
       ======================================== */
    .shopping-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .shopping-view.visible {
      display: flex;
    }

    .shopping-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .shopping-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .shopping-actions {
      display: flex;
      gap: 8px;
    }

    .shopping-action-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--card-bg);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .shopping-action-btn:hover {
      background: var(--border);
    }

    .shopping-add {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .shopping-add input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .shopping-add select {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      background: var(--card-bg);
      color: var(--text-primary);
      cursor: pointer;
    }

    .shopping-add-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--adult);
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
    }

    .shopping-add-btn:hover {
      opacity: 0.9;
    }

    .shopping-categories {
      flex: 1;
      overflow: auto;
    }

    .shopping-category {
      margin-bottom: 16px;
    }

    .shopping-category-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .shopping-category-icon {
      font-size: 1.1rem;
    }

    .shopping-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      box-shadow: var(--shadow-sm);
    }

    .shopping-item.completed {
      opacity: 0.5;
    }

    .shopping-item.completed .shopping-item-name {
      text-decoration: line-through;
    }

    .shopping-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .shopping-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .shopping-item-name {
      flex: 1;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .shopping-item-delete {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .shopping-item:hover .shopping-item-delete {
      opacity: 1;
    }

    .shopping-item-delete:hover {
      color: var(--danger);
    }

    .shopping-summary {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      margin-top: 16px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .shopping-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .shopping-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* Price Compare & Export */
    .price-compare-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .price-compare-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--success);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .price-compare-btn.secondary {
      background: var(--primary);
    }

    .price-results {
      margin-top: 16px;
    }

    .price-store-card {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 12px;
    }

    .price-store-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .price-store-total {
      margin-left: auto;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success);
    }

    .price-store-badge {
      background: var(--success);
      color: white;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .price-item-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
    }

    .price-item-row:last-child {
      border-bottom: none;
    }

    .price-item-name {
      color: var(--text-secondary);
    }

    .price-item-price {
      font-weight: 600;
    }

    .price-item-price.on-special {
      color: var(--danger);
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .export-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
    }

    .export-option:hover {
      border-color: var(--adult);
    }

    .export-logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .export-preview textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.85rem;
      resize: none;
      margin-bottom: 12px;
    }

    .export-preview h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
    }

    /* ========================================
       MEAL PLANNER VIEW
       ======================================== */
    .meal-planner-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .meal-planner-view.visible {
      display: flex;
    }

    .meal-planner-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0 16px;
    }

    .meal-week-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .meal-days {
      flex: 1;
      overflow: auto;
    }

    .meal-day {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .meal-day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--primary);
      color: white;
    }

    .meal-day-header.today {
      background: var(--adult);
    }

    .meal-day-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .meal-day-date {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .meal-slots {
      padding: 12px;
    }

    .meal-slot {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      background: var(--bg);
    }

    .meal-slot:last-child {
      margin-bottom: 0;
    }

    .meal-slot-type {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      width: 60px;
      flex-shrink: 0;
    }

    .meal-slot-content {
      flex: 1;
      min-width: 0;
    }

    .meal-slot-empty {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .meal-slot-empty:hover {
      color: var(--adult);
    }

    .meal-slot-filled {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .meal-slot-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .meal-slot-notes {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .meal-slot-actions {
      display: flex;
      gap: 4px;
    }

    .meal-slot-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .meal-slot-btn:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .meal-actions {
      padding-top: 16px;
    }

    .meal-generate-btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--success);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .meal-generate-btn:hover {
      opacity: 0.9;
    }

    /* Smart Meal Actions */
    .smart-meal-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .smart-meal-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .smart-meal-btn.primary {
      background: var(--adult);
      color: white;
      border: none;
    }

    /* Meal Tabs */
    .meal-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg);
      padding: 4px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }

    .meal-tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .meal-tab.active {
      background: var(--card-bg);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }

    .meal-tab-content {
      display: none;
    }

    .meal-tab-content.active {
      display: block;
    }

    /* Meal Ideas Header */
    .meal-ideas-header {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    /* Meal Ideas Grid */
    .meal-ideas-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .meal-ideas-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .meal-ideas-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* Meal Idea Card */
    .meal-idea-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }

    .meal-idea-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .meal-idea-card.selected {
      ring: 2px solid var(--adult);
      box-shadow: 0 0 0 2px var(--adult);
    }

    .meal-idea-image {
      height: 100px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--adult) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
    }

    .meal-idea-content {
      padding: 12px;
    }

    .meal-idea-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .meal-idea-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .meal-idea-checkbox {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .meal-idea-card.selected .meal-idea-checkbox {
      background: var(--adult);
      border-color: var(--adult);
      color: white;
    }

    /* Meal Selection Bar */
    .meal-selection-bar {
      position: sticky;
      bottom: 0;
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0 -16px -16px;
    }

    .add-to-list-btn {
      padding: 12px 20px;
      background: var(--success);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
    }

    /* Expanded Meal Content */
    .expanded-meal-image {
      height: 150px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--adult) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      margin: -20px -20px 20px;
    }

    .expanded-meal-section {
      margin-bottom: 20px;
    }

    .expanded-meal-section h4 {
      font-size: 0.9rem;
      font-weight: 700;
      margin: 0 0 12px;
      color: var(--text-primary);
    }

    .expanded-ingredient-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .expanded-ingredient {
      padding: 6px 12px;
      background: var(--bg);
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .expanded-steps-list {
      counter-reset: step;
    }

    .expanded-step {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .expanded-step:last-child {
      border-bottom: none;
    }

    .expanded-step-number {
      width: 28px;
      height: 28px;
      background: var(--adult);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .expanded-step-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .expanded-meal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .expanded-meal-actions button {
      flex: 1;
    }

    /* Ingredient Review */
    .ingredient-review-list {
      margin-bottom: 20px;
    }

    .ingredient-review-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .ingredient-review-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .ingredient-review-name {
      flex: 1;
      font-size: 0.9rem;
    }

    .ingredient-review-price {
      font-weight: 600;
      color: var(--success);
    }

    /* Quality Preference */
    .quality-preference {
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius-md);
    }

    .quality-preference h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
    }

    .quality-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quality-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .quality-option:hover {
      background: var(--card-bg);
    }

    .quality-label {
      font-size: 0.9rem;
    }

    /* Meal Preferences Modal Styles */
    .pref-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .pref-tab {
      flex: 1;
      padding: 8px 4px;
      border: none;
      background: transparent;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .pref-tab.active {
      background: var(--adult);
      color: white;
    }

    .pref-panel {
      display: none;
    }

    .pref-panel.active {
      display: block;
    }

    .pref-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .pref-category {
      margin-bottom: 16px;
    }

    .pref-category h4 {
      font-size: 0.85rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--text-primary);
    }

    .pref-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pref-chip {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .pref-chip.selected {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    .pref-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pref-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
    }

    .pref-option.selected {
      border-color: var(--adult);
      background: #eff6ff;
    }

    .pref-option-icon {
      font-size: 1.5rem;
    }

    .pref-option-text {
      flex: 1;
    }

    .pref-option-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .pref-option-desc {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .pref-setting {
      margin-bottom: 20px;
    }

    .pref-setting label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .budget-input {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }

    .budget-input input {
      width: 80px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      text-align: center;
    }

    .stepper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stepper button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card-bg);
      font-size: 1.25rem;
      cursor: pointer;
    }

    .stepper span {
      font-size: 1.25rem;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    .store-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .store-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
    }

    .store-option.selected {
      border-color: var(--success);
      background: #f0fdf4;
    }

    .store-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .store-logo.woolworths { background: #0d9e1d; color: white; }
    .store-logo.coles { background: #e01a22; color: white; }
    .store-logo.aldi { background: #00447c; color: white; }
    .store-logo.costco { background: #e31837; color: white; }

    .store-name {
      flex: 1;
      font-weight: 600;
    }

    .store-check {
      font-size: 1.25rem;
      color: var(--success);
    }

    /* AI Loading Overlay */
    .ai-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .ai-loading-card {
      background: var(--card-bg);
      padding: 32px 48px;
      border-radius: var(--radius-lg);
      text-align: center;
    }

    .ai-loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--adult);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }

    .ai-loading-card h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }

    .ai-loading-card p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* ========================================
       ADHD TASK BREAKDOWN VIEW
       ======================================== */
    .adhd-task-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .adhd-task-view.visible {
      display: flex;
    }

    .adhd-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .adhd-header h3 {
      margin: 0 0 4px;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .adhd-subtitle {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .adhd-input-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      margin-bottom: 16px;
    }

    .adhd-label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .adhd-textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      background: var(--bg);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    .adhd-textarea:focus {
      outline: none;
      border-color: var(--adult);
    }

    .adhd-breakdown-btn {
      width: 100%;
      margin-top: 14px;
      padding: 16px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .adhd-breakdown-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }

    .adhd-breakdown-btn:active {
      transform: translateY(0);
    }

    .adhd-tips {
      margin-bottom: 24px;
    }

    .adhd-tip {
      background: var(--card-bg);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-left: 3px solid var(--warning);
    }

    .adhd-existing-tasks h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0 0 12px;
    }

    .adhd-task-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .adhd-task-item {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .adhd-task-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .adhd-task-item.completed {
      opacity: 0.6;
    }

    .adhd-task-progress-ring {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: conic-gradient(var(--success) var(--progress, 0%), var(--border) 0%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .adhd-task-progress-inner {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .adhd-task-info {
      flex: 1;
      min-width: 0;
    }

    .adhd-task-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .adhd-task-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .adhd-task-actions {
      display: flex;
      gap: 8px;
    }

    .adhd-task-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--bg);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .adhd-task-action-btn:hover {
      background: var(--border);
    }

    /* Clarification Section */
    .adhd-clarify-section {
      padding: 16px;
    }

    .adhd-clarify-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .adhd-clarify-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .adhd-back-btn {
      padding: 8px 14px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
    }

    .adhd-clarify-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
    }

    .adhd-clarify-question {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 20px;
      text-align: center;
    }

    .adhd-clarify-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .adhd-clarify-option {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border);
      background: var(--bg);
      cursor: pointer;
      text-align: left;
      font-size: 1rem;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .adhd-clarify-option:hover {
      border-color: var(--adult);
      background: rgba(59, 130, 246, 0.1);
    }

    .adhd-clarify-option.selected {
      border-color: var(--adult);
      background: var(--adult);
      color: white;
    }

    .adhd-clarify-custom {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .adhd-clarify-custom input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--bg);
      color: var(--text-primary);
    }

    .adhd-clarify-custom button {
      width: 48px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--adult);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .adhd-clarify-progress {
      text-align: center;
      margin-top: 16px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Focus Mode */
    .adhd-focus-section {
      padding: 16px;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    .adhd-focus-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .adhd-focus-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    .adhd-focus-card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 32px 24px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      margin-bottom: 20px;
    }

    .adhd-focus-step-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .adhd-focus-current-step {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.4;
      margin-bottom: 24px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .adhd-focus-progress {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .adhd-focus-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #34d399);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .adhd-focus-progress-text {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .adhd-focus-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .adhd-done-btn {
      padding: 18px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .adhd-done-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .adhd-skip-btn {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
    }

    .adhd-skip-btn:hover {
      background: var(--border);
    }

    .adhd-focus-timer {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .adhd-timer-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .adhd-timer-display {
      font-size: 3rem;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
      margin-bottom: 12px;
    }

    .adhd-timer-btn {
      padding: 10px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--adult);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .adhd-focus-all-steps {
      margin-top: auto;
    }

    .adhd-show-steps-btn {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .adhd-steps-list {
      margin-top: 12px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .adhd-step-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.95rem;
    }

    .adhd-step-item:last-child {
      border-bottom: none;
    }

    .adhd-step-item.completed {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .adhd-step-item.current {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 600;
    }

    .adhd-step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .adhd-step-item.completed .adhd-step-number {
      background: var(--success);
      color: white;
    }

    .adhd-step-item.current .adhd-step-number {
      background: var(--adult);
      color: white;
    }

    /* Celebration */
    .adhd-celebration {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .celebration-content {
      text-align: center;
      animation: celebratePop 0.5s ease;
    }

    .celebration-emoji {
      font-size: 6rem;
      margin-bottom: 20px;
      animation: celebrateBounce 0.6s ease infinite;
    }

    .celebration-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    @keyframes celebratePop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes celebrateBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    /* Loading */
    .adhd-loading {
      text-align: center;
      padding: 40px 20px;
    }

    .adhd-loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--adult);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .adhd-loading p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Breakdown Result */
    .adhd-breakdown-summary {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
    }

    .adhd-breakdown-summary h4 {
      margin: 0 0 8px;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .adhd-breakdown-summary p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .adhd-breakdown-steps {
      margin-bottom: 20px;
    }

    .adhd-breakdown-step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .adhd-breakdown-step-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--adult);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .adhd-breakdown-step-text {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
      padding-top: 3px;
    }

    .adhd-breakdown-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .adhd-save-btn {
      padding: 16px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .adhd-regenerate-btn {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
    }

    .adhd-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .adhd-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* ========================================
       BUBBLE NAVIGATION
       ======================================== */
    .bubble-container {
      background: var(--card-bg);
      padding: 16px 0;
      box-shadow: var(--shadow-sm);
      position: relative;
    }

    .bubble-row {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 8px 20px 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .bubble-row::-webkit-scrollbar { display: none; }

    .bubble-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
    }

    .bubble {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      border: 3px solid transparent;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      overflow: hidden;
    }

    .bubble.pressing {
      transform: scale(0.9);
    }

    .bubble.selected {
      transform: scale(1.08);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .bubble.type-adult {
      border-color: var(--adult);
      background: #eff6ff;
    }

    .bubble.type-child {
      border-color: var(--child);
      background: #fffbeb;
    }

    .bubble.type-household {
      border-color: var(--household);
      background: #f0fdfa;
    }

    .bubble-label {
      margin-top: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      max-width: 70px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bubble-add {
      border: 2px dashed var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 1.5rem;
    }

    .bubble-add:hover {
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }

    /* ========================================
       LONG-PRESS ACTION MENU
       ======================================== */
    .action-menu {
      position: fixed;
      top: auto;
      left: 50%;
      transform: translateX(-50%) scale(0.9);
      background: var(--card-bg);
      border-radius: var(--radius-md);
      min-width: 180px;
      box-shadow: var(--shadow-lg);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      z-index: 9000;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .action-menu::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-bottom-color: var(--card-bg);
      border-top: 0;
    }

    .action-menu.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1);
    }

    .menu-item {
      padding: 12px 14px;
      font-size: 0.875rem;
      color: var(--text-primary);
      background: none;
      border: none;
      text-align: left;
      border-radius: var(--radius-sm);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-family: inherit;
    }

    .menu-item:hover, .menu-item:active {
      background: var(--bg);
    }

    .menu-icon {
      font-size: 1rem;
      width: 24px;
      text-align: center;
    }

    /* ========================================
       FEED LAYER
       ======================================== */
    .feed-layer {
      padding: 20px;
      padding-bottom: 100px;
    }

    .feed-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 12px;
      margin-top: 8px;
    }

    .feed-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      animation: slideUp 0.4s ease-out;
    }

    .feed-empty-icon {
      font-size: 3.5rem;
      margin-bottom: 16px;
      animation: bounce 2s ease-in-out infinite;
    }

    .feed-empty-text {
      font-size: 0.95rem;
      line-height: 1.7;
      max-width: 280px;
      margin: 0 auto;
    }

    .feed-empty-hint {
      margin-top: 20px;
      padding: 12px 16px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      display: inline-block;
      font-size: 0.85rem;
      box-shadow: var(--shadow-sm);
    }

    /* Today View Card */
    .today-view-card {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-md);
    }

    .today-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .today-icon {
      font-size: 1.25rem;
    }

    .today-title {
      font-weight: 700;
      font-size: 1.1rem;
      flex: 1;
    }

    .today-date {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .today-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .today-item {
      font-size: 0.9rem;
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
    }

    .today-item strong {
      color: #93c5fd;
    }

    /* Undo Toast */
    .undo-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-lg);
      z-index: 1500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .undo-toast.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    .undo-toast-text {
      font-size: 0.9rem;
    }

    .undo-toast-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      font-family: inherit;
    }

    .undo-toast-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ========================================
       FEED CARDS
       ======================================== */
    .feed-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--border);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    .feed-card.pinned {
      border-left-color: var(--primary);
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
    }

    .feed-card.type-appointment { border-left-color: #8b5cf6; }
    .feed-card.type-roster { border-left-color: var(--adult); }
    .feed-card.type-milestone { border-left-color: var(--child); }
    .feed-card.type-event { border-left-color: #ec4899; }
    .feed-card.type-goal { border-left-color: var(--success); }
    .feed-card.type-note { border-left-color: var(--text-muted); }
    .feed-card.type-prep { border-left-color: var(--warning); }
    .feed-card.type-conflict { border-left-color: var(--danger); }
    .feed-card.type-handoff { border-left-color: #f97316; }
    .feed-card.type-birthday { border-left-color: #ec4899; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); }

    [data-theme="dark"] .feed-card.type-birthday { background: linear-gradient(135deg, #500724 0%, #831843 100%); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .card-type-badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      background: var(--bg);
      color: var(--text-secondary);
    }

    .card-recurrence-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: #dbeafe;
      color: #1e40af;
      text-transform: capitalize;
    }

    [data-theme="dark"] .card-recurrence-badge {
      background: #1e3a5f;
      color: #93c5fd;
    }

    .card-member-badge {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .pin-icon {
      color: var(--primary);
    }

    .card-body {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .card-meta {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .card-action-btn {
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      transition: all 0.15s;
    }

    .card-action-btn.primary {
      background: var(--primary);
      color: white;
    }

    .card-action-btn.primary:hover {
      background: var(--primary-light);
    }

    .card-action-btn.secondary {
      background: var(--bg);
      color: var(--text-primary);
    }

    .card-action-btn.secondary:hover {
      background: var(--border);
    }

    .card-action-btn.success {
      background: #dcfce7;
      color: #166534;
    }

    .card-action-btn.timer {
      background: #fef3c7;
      color: #92400e;
    }

    /* ========================================
       MICRO-STEPS (ADHD Engine)
       ======================================== */
    .micro-steps {
      margin-top: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 12px;
    }

    .micro-steps-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .micro-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .micro-step:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .micro-step-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .micro-step-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .micro-step-content {
      flex: 1;
    }

    .micro-step-text {
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .micro-step.completed .micro-step-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .micro-step-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .micro-step-timer {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      background: #fef3c7;
      color: #92400e;
      font-size: 0.7rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      font-family: inherit;
    }

    .micro-step-timer:hover {
      background: #fde68a;
    }

    /* Open Questions Section */
    .open-questions {
      margin-top: 12px;
      padding: 12px;
      background: #fef3c7;
      border-radius: var(--radius-sm);
    }

    .open-questions-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 8px;
    }

    .open-question-item {
      font-size: 0.85rem;
      color: #78350f;
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ========================================
       WEEKLY SUMMARY CARD
       ======================================== */
    .weekly-summary-section {
      margin-top: 8px;
    }

    .weekly-summary-section h4 {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 12px 0 6px;
    }

    .weekly-summary-section ul {
      margin: 0;
      padding-left: 20px;
    }

    .weekly-summary-section li {
      font-size: 0.85rem;
      color: var(--text-secondary);
      padding: 3px 0;
    }

    /* ========================================
       FLOATING ACTION BUTTON
       ======================================== */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      z-index: 200;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .fab:hover {
      transform: scale(1.05);
    }

    .fab:active {
      transform: scale(0.95);
    }

    .fab-menu {
      position: fixed;
      bottom: 90px;
      right: 24px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      padding: 8px;
      z-index: 199;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.2s;
    }

    .fab-menu.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .fab-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .fab-menu-item:hover {
      background: var(--bg);
    }

    .fab-menu-item .icon {
      font-size: 1.1rem;
    }

    /* ========================================
       MODALS & BOTTOM SHEETS
       ======================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 900;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: 20px;
      z-index: 1001;
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .modal-sheet.open {
      transform: translateY(0);
    }

    .modal-sheet .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-sheet .modal-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .modal-sheet .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: 0;
      z-index: 1000;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .bottom-sheet.open {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto;
      flex-shrink: 0;
    }

    .sheet-header {
      padding: 0 20px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .sheet-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .sheet-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .sheet-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }

    .sheet-actions {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      background: var(--card-bg);
    }

    /* ========================================
       FORMS
       ======================================== */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px; /* Prevents iOS zoom */
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--adult);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .screenshot-import-placeholder {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 2px dashed var(--adult);
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .screenshot-import-placeholder:hover {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    }

    .screenshot-icon {
      font-size: 1.5rem;
    }

    .screenshot-text {
      flex: 1;
      font-weight: 500;
      color: var(--text-primary);
    }

    .screenshot-badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      padding: 4px 8px;
      background: var(--adult);
      color: white;
      border-radius: 4px;
      font-weight: 600;
    }

    .form-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .form-divider::before,
    .form-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .profile-pic-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border: 2px dashed var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-pic-upload:hover {
      border-color: var(--adult);
      background: var(--bg);
    }

    .profile-pic-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      overflow: hidden;
      border: 3px solid var(--border);
    }

    .profile-pic-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-pic-upload-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
    }

    .profile-pic-upload-text strong {
      color: var(--adult);
    }

    .profile-pic-input {
      display: none;
    }

    .appointment-photo-preview {
      margin-bottom: 12px;
      border-radius: var(--radius-md);
      overflow: hidden;
      display: none;
    }

    .appointment-photo-preview.has-image {
      display: block;
    }

    .appointment-photo-preview img {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: var(--radius-md);
    }

    .appointment-photo-preview .ai-status {
      padding: 10px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.8rem;
      text-align: center;
      animation: pulse 1.5s infinite;
    }

    .location-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .location-input-wrapper .form-input {
      flex: 1;
    }

    .location-search-btn {
      width: 48px;
      height: 48px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .location-search-btn:hover {
      background: var(--border);
    }

    .btn {
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
      flex: 1;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-danger {
      background: #fef2f2;
      color: var(--danger);
    }

    .btn-danger:hover {
      background: #fee2e2;
    }

    /* ========================================
       PROFILE PANEL
       ======================================== */
    .profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.25rem;
      overflow: hidden;
    }

    .profile-avatar.type-adult { background: #eff6ff; }
    .profile-avatar.type-child { background: #fffbeb; }
    .profile-avatar.type-household { background: #f0fdfa; }

    .profile-info h2 {
      margin: 0;
      font-size: 1.25rem;
    }

    .profile-role {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .profile-section {
      margin-top: 20px;
    }

    .profile-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .profile-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .profile-item:last-child {
      border-bottom: none;
    }

    .profile-item-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .profile-item-value {
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* ========================================
       SETTINGS PANEL
       ======================================== */
    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .settings-item-info {
      flex: 1;
    }

    .settings-item-label {
      font-weight: 500;
      font-size: 0.95rem;
    }

    .settings-item-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--adult);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* ========================================
       TIMER MODAL
       ======================================== */
    .timer-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.95);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .timer-modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .timer-content {
      text-align: center;
      color: white;
    }

    .timer-display {
      font-size: 5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: -2px;
      margin-bottom: 8px;
    }

    .timer-label {
      font-size: 1.1rem;
      opacity: 0.7;
      margin-bottom: 32px;
    }

    .timer-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .timer-btn {
      padding: 14px 32px;
      border-radius: var(--radius-md);
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: transform 0.15s, opacity 0.15s;
    }

    .timer-btn:active {
      transform: scale(0.95);
    }

    .timer-btn.pause {
      background: white;
      color: var(--primary);
    }

    .timer-btn.stop {
      background: var(--success);
      color: white;
    }

    .timer-ios-hint {
      margin-top: 32px;
      font-size: 0.85rem;
      opacity: 0.5;
    }

    .timer-ios-hint a {
      color: var(--adult);
      text-decoration: underline;
    }

    /* ========================================
       UTILITIES
       ======================================== */
    .text-danger { color: var(--danger); }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--text-muted); }
    .font-bold { font-weight: 600; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .hidden { display: none !important; }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (min-width: 768px) {
      .feed-layer {
        max-width: 600px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <!-- BUILD TAG -->
  <div class="build-tag">BUILD v1.2</div>

  <!-- HEADER -->
  <header class="app-header">
    <div class="header-left">
      <button class="back-btn" onclick="window.location.href='/'" title="Back to Home"></button>
      <div class="app-title">Life Assistant</div>
    </div>
    <div class="header-right">
      <button class="header-btn" id="adhdTaskToggleBtn" onclick="toggleAdhdTaskView()" title="ADHD Task Breakdown"></button>
      <button class="header-btn" id="shoppingToggleBtn" onclick="toggleShoppingView()" title="Shopping List"></button>
      <button class="header-btn" id="mealToggleBtn" onclick="toggleMealPlannerView()" title="Meal Planner"></button>
      <button class="header-btn" id="calendarToggleBtn" onclick="toggleCalendarView()" title="Calendar View"></button>
      <button class="header-btn" onclick="openSettings()" title="Settings"></button>
    </div>
  </header>

  <!-- MAIN SCROLLABLE AREA -->
  <main class="main-scroll-area" id="mainScrollArea">
    <!-- BUBBLE NAVIGATION -->
    <div class="bubble-container">
      <div class="bubble-row" id="bubbleRow"></div>
    </div>

    <!-- FEED LAYER -->
    <div class="feed-layer" id="feedLayer">
      <div id="feedContent"></div>
    </div>
  </main>

  <!-- CALENDAR VIEW -->
  <div class="calendar-view" id="calendarView">
    <div class="calendar-header">
      <button class="calendar-nav-btn" onclick="changeMonth(-1)"></button>
      <h3 class="calendar-month-title" id="calendarMonthTitle">January 2024</h3>
      <button class="calendar-nav-btn" onclick="changeMonth(1)"></button>
    </div>
    <div class="calendar-weekdays">
      <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
    <div class="calendar-day-detail" id="calendarDayDetail"></div>
  </div>

  <!-- SHOPPING LIST VIEW -->
  <div class="shopping-view" id="shoppingView">
    <div class="shopping-header">
      <h3>Shopping List</h3>
      <div class="shopping-actions">
        <button class="shopping-action-btn" onclick="clearCompletedItems()" title="Clear completed"></button>
        <button class="shopping-action-btn" onclick="generateListFromMeals()" title="Generate from meals"></button>
      </div>
    </div>

    <div class="shopping-add">
      <input type="text" id="shoppingInput" placeholder="Add item..." onkeypress="handleShoppingKeypress(event)">
      <select id="shoppingCategory">
        <option value="produce"> Produce</option>
        <option value="dairy"> Dairy</option>
        <option value="meat"> Meat</option>
        <option value="bakery"> Bakery</option>
        <option value="pantry"> Pantry</option>
        <option value="frozen"> Frozen</option>
        <option value="drinks"> Drinks</option>
        <option value="household"> Household</option>
        <option value="other"> Other</option>
      </select>
      <button class="shopping-add-btn" onclick="addShoppingItem()">+</button>
    </div>

    <div class="shopping-categories" id="shoppingCategories">
      <!-- Categories will be rendered here -->
    </div>

    <div class="shopping-summary" id="shoppingSummary">
      <span class="shopping-count">0 items</span>
      <span class="shopping-completed">0 completed</span>
    </div>

    <!-- Price Comparison Actions -->
    <div class="price-compare-actions">
      <button class="price-compare-btn" onclick="comparePrices()">
         Compare Prices
      </button>
      <button class="price-compare-btn secondary" onclick="openExportOptions()">
         Export List
      </button>
    </div>
  </div>

  <!-- PRICE COMPARISON MODAL -->
  <div class="modal-sheet" id="priceCompareSheet">
    <div class="modal-header">
      <h3>Price Comparison</h3>
      <button class="modal-close" onclick="closePriceCompare()"></button>
    </div>
    <div class="modal-content">
      <div class="price-loading" id="priceLoading">
        <div class="ai-loading-spinner"></div>
        <p>Finding the best prices...</p>
      </div>
      <div class="price-results" id="priceResults" style="display: none;">
        <!-- Results will be rendered here -->
      </div>
    </div>
  </div>

  <!-- EXPORT OPTIONS MODAL -->
  <div class="modal-sheet" id="exportSheet">
    <div class="modal-header">
      <h3>Export Shopping List</h3>
      <button class="modal-close" onclick="closeExportSheet()"></button>
    </div>
    <div class="modal-content">
      <p class="pref-description">Copy your list for delivery apps or store websites:</p>

      <div class="export-options">
        <div class="export-option" onclick="exportForStore('woolworths')">
          <div class="store-logo woolworths">W</div>
          <span>Woolworths Online</span>
        </div>
        <div class="export-option" onclick="exportForStore('coles')">
          <div class="store-logo coles">C</div>
          <span>Coles Online</span>
        </div>
        <div class="export-option" onclick="exportForApp('doordash')">
          <div class="export-logo"></div>
          <span>DoorDash</span>
        </div>
        <div class="export-option" onclick="exportForApp('ubereats')">
          <div class="export-logo"></div>
          <span>Uber Eats</span>
        </div>
        <div class="export-option" onclick="exportPlainText()">
          <div class="export-logo"></div>
          <span>Plain Text</span>
        </div>
      </div>

      <div class="export-preview" id="exportPreview" style="display: none;">
        <h4>Your List (tap to copy):</h4>
        <textarea id="exportText" readonly rows="8"></textarea>
        <button class="form-submit" onclick="copyExportText()"> Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- MEAL PLANNER VIEW -->
  <div class="meal-planner-view" id="mealPlannerView">
    <!-- Tabs for switching between Ideas and Weekly Plan -->
    <div class="meal-tabs">
      <button class="meal-tab active" onclick="switchMealTab('ideas')"> Meal Ideas</button>
      <button class="meal-tab" onclick="switchMealTab('weekly')"> Weekly Plan</button>
    </div>

    <!-- MEAL IDEAS TAB -->
    <div class="meal-tab-content active" id="mealIdeasTab">
      <div class="meal-ideas-header">
        <button class="smart-meal-btn" onclick="openMealPreferences()"> Preferences</button>
        <button class="smart-meal-btn primary" onclick="generateMealIdeas()"> Generate Ideas</button>
      </div>

      <!-- Meal Ideas Grid -->
      <div class="meal-ideas-grid" id="mealIdeasGrid">
        <div class="meal-ideas-empty">
          <div class="meal-ideas-empty-icon"></div>
          <p>Tap "Generate Ideas" to get personalized meal suggestions based on your preferences!</p>
        </div>
      </div>

      <!-- Selected Meals Actions -->
      <div class="meal-selection-bar" id="mealSelectionBar" style="display: none;">
        <span id="selectedMealCount">0 meals selected</span>
        <button class="add-to-list-btn" onclick="openIngredientReview()">
           Add Ingredients to List
        </button>
      </div>
    </div>

    <!-- WEEKLY PLAN TAB -->
    <div class="meal-tab-content" id="mealWeeklyTab">
      <div class="meal-planner-header">
        <button class="calendar-nav-btn" onclick="changeMealWeek(-1)"></button>
        <h3 class="meal-week-title" id="mealWeekTitle">This Week</h3>
        <button class="calendar-nav-btn" onclick="changeMealWeek(1)"></button>
      </div>

      <div class="meal-days" id="mealDays">
        <!-- Days will be rendered here -->
      </div>

      <div class="meal-actions">
        <button class="meal-generate-btn" onclick="generateShoppingFromMeals()">
           Generate Shopping List
        </button>
      </div>
    </div>
  </div>

  <!-- EXPANDED MEAL CARD MODAL -->
  <div class="modal-sheet" id="expandedMealSheet">
    <div class="modal-header">
      <h3 id="expandedMealTitle">Meal Name</h3>
      <button class="modal-close" onclick="closeExpandedMeal()"></button>
    </div>
    <div class="modal-content" id="expandedMealContent">
      <!-- Will be populated dynamically -->
    </div>
  </div>

  <!-- INGREDIENT REVIEW MODAL -->
  <div class="modal-sheet" id="ingredientReviewSheet">
    <div class="modal-header">
      <h3>Review Ingredients</h3>
      <button class="modal-close" onclick="closeIngredientReview()"></button>
    </div>
    <div class="modal-content">
      <p class="pref-description">Uncheck ingredients you already have:</p>
      <div class="ingredient-review-list" id="ingredientReviewList">
        <!-- Ingredients will be listed here -->
      </div>

      <div class="quality-preference">
        <h4>Ingredient Quality</h4>
        <div class="quality-options">
          <label class="quality-option">
            <input type="radio" name="quality" value="budget" checked>
            <span class="quality-label"> Budget (Home Brand)</span>
          </label>
          <label class="quality-option">
            <input type="radio" name="quality" value="standard">
            <span class="quality-label"> Standard (Store Brand)</span>
          </label>
          <label class="quality-option">
            <input type="radio" name="quality" value="premium">
            <span class="quality-label"> Premium Quality</span>
          </label>
        </div>
      </div>

      <button class="form-submit" onclick="addIngredientsWithPricing()">
         Find Best Prices & Add to List
      </button>
    </div>
  </div>

  <!-- ADHD TASK BREAKDOWN VIEW -->
  <div class="adhd-task-view" id="adhdTaskView">
    <!-- Input Mode -->
    <div class="adhd-input-section" id="adhdInputSection">
      <div class="adhd-header">
        <h3> Task Breakdown</h3>
        <p class="adhd-subtitle">Let's make this manageable</p>
      </div>

      <div class="adhd-input-card">
        <label class="adhd-label">What do you need to do?</label>
        <textarea id="adhdTaskInput" class="adhd-textarea" placeholder="e.g., Clean the house, Do my taxes, Organise the garage..." rows="3"></textarea>
        <button class="adhd-breakdown-btn" onclick="startTaskBreakdown()">
          <span class="btn-icon"></span>
          Break it down for me
        </button>
      </div>

      <div class="adhd-tips">
        <div class="adhd-tip"> Tip: Be as vague or specific as you like - I'll ask questions if I need more info</div>
      </div>

      <!-- Existing Tasks -->
      <div class="adhd-existing-tasks" id="adhdExistingTasks">
        <h4>Your Tasks</h4>
        <div class="adhd-task-list" id="adhdTaskList"></div>
      </div>
    </div>

    <!-- Clarification Mode -->
    <div class="adhd-clarify-section" id="adhdClarifySection" style="display: none;">
      <div class="adhd-clarify-header">
        <button class="adhd-back-btn" onclick="cancelClarification()"> Back</button>
        <h3>Quick Question</h3>
      </div>

      <div class="adhd-clarify-card">
        <p class="adhd-clarify-question" id="clarifyQuestion">What do you mean by "clean"?</p>
        <div class="adhd-clarify-options" id="clarifyOptions">
          <!-- Options will be rendered here -->
        </div>
        <div class="adhd-clarify-custom">
          <input type="text" id="clarifyCustomInput" placeholder="Or type your own answer...">
          <button onclick="submitCustomClarification()"></button>
        </div>
      </div>

      <div class="adhd-clarify-progress">
        <span id="clarifyProgress">Question 1 of 2</span>
      </div>
    </div>

    <!-- Focus Mode -->
    <div class="adhd-focus-section" id="adhdFocusSection" style="display: none;">
      <div class="adhd-focus-header">
        <button class="adhd-back-btn" onclick="exitFocusMode()"> All Tasks</button>
        <h3 id="focusTaskTitle">Task Name</h3>
      </div>

      <div class="adhd-focus-card">
        <div class="adhd-focus-step-label">Just do this one thing:</div>
        <div class="adhd-focus-current-step" id="focusCurrentStep">
          Step text here
        </div>
        <div class="adhd-focus-progress">
          <div class="adhd-focus-progress-bar" id="focusProgressBar"></div>
        </div>
        <div class="adhd-focus-progress-text" id="focusProgressText">Step 1 of 5</div>
      </div>

      <div class="adhd-focus-actions">
        <button class="adhd-done-btn" onclick="completeCurrentStep()">
           Done! Next step
        </button>
        <button class="adhd-skip-btn" onclick="skipCurrentStep()">
          Skip for now
        </button>
      </div>

      <div class="adhd-focus-timer" id="focusTimer" style="display: none;">
        <div class="adhd-timer-text">Just 5 minutes - you can do this!</div>
        <div class="adhd-timer-display" id="timerDisplay">5:00</div>
        <button class="adhd-timer-btn" id="timerBtn" onclick="toggleFocusTimer()">Start Timer</button>
      </div>

      <div class="adhd-focus-all-steps">
        <button class="adhd-show-steps-btn" onclick="toggleAllSteps()">
          <span id="showStepsIcon"></span> Show all steps
        </button>
        <div class="adhd-steps-list" id="focusStepsList" style="display: none;"></div>
      </div>
    </div>

    <!-- Celebration Overlay -->
    <div class="adhd-celebration" id="adhdCelebration" style="display: none;">
      <div class="celebration-content">
        <div class="celebration-emoji" id="celebrationEmoji"></div>
        <div class="celebration-text" id="celebrationText">Amazing! You did it!</div>
      </div>
    </div>
  </div>

  <!-- ADHD Task Clarification Modal -->
  <div class="modal-sheet" id="adhdBreakdownSheet">
    <div class="modal-header">
      <h3>Breaking Down Your Task</h3>
      <button class="modal-close" onclick="closeAdhdBreakdownSheet()"></button>
    </div>
    <div class="modal-content">
      <div class="adhd-loading" id="adhdLoading">
        <div class="adhd-loading-spinner"></div>
        <p>Thinking about the best way to break this down...</p>
      </div>
      <div class="adhd-breakdown-result" id="adhdBreakdownResult" style="display: none;">
        <div class="adhd-breakdown-summary" id="breakdownSummary"></div>
        <div class="adhd-breakdown-steps" id="breakdownSteps"></div>
        <div class="adhd-breakdown-actions">
          <button class="adhd-save-btn" onclick="saveTaskBreakdown()">Save & Start</button>
          <button class="adhd-regenerate-btn" onclick="regenerateBreakdown()">Try Different Approach</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD MEAL MODAL -->
  <div class="modal-sheet" id="addMealSheet">
    <div class="modal-header">
      <h3>Add Meal</h3>
      <button class="modal-close" onclick="closeAddMealSheet()"></button>
    </div>
    <div class="modal-content">
      <input type="hidden" id="mealDayIndex">
      <input type="hidden" id="mealType">

      <div class="form-field">
        <label>Meal Name</label>
        <input type="text" id="mealName" placeholder="e.g., Spaghetti Bolognese">
      </div>

      <div class="form-field">
        <label>Ingredients (one per line)</label>
        <textarea id="mealIngredients" rows="4" placeholder="500g mince&#10;1 onion&#10;2 cans tomatoes&#10;Pasta"></textarea>
      </div>

      <div class="form-field">
        <label>Notes</label>
        <input type="text" id="mealNotes" placeholder="e.g., Kid-friendly, 30 mins">
      </div>

      <button class="form-submit" onclick="saveMeal()">Save Meal</button>
    </div>
  </div>

  <!-- MEAL PREFERENCES MODAL -->
  <div class="modal-sheet" id="mealPreferencesSheet">
    <div class="modal-header">
      <h3>Meal Preferences</h3>
      <button class="modal-close" onclick="closeMealPreferences()"></button>
    </div>
    <div class="modal-content">
      <!-- Tabs -->
      <div class="pref-tabs">
        <button class="pref-tab active" onclick="switchPrefTab('dislikes')"> Dislikes</button>
        <button class="pref-tab" onclick="switchPrefTab('diet')"> Diet</button>
        <button class="pref-tab" onclick="switchPrefTab('settings')"> Settings</button>
        <button class="pref-tab" onclick="switchPrefTab('stores')"> Stores</button>
      </div>

      <!-- Dislikes Tab -->
      <div class="pref-panel active" id="prefDislikes">
        <p class="pref-description">Select ingredients your family doesn't like:</p>

        <div class="pref-category">
          <h4> Vegetables</h4>
          <div class="pref-chips" id="dislikesVeggies"></div>
        </div>

        <div class="pref-category">
          <h4> Spices & Herbs</h4>
          <div class="pref-chips" id="dislikesSpices"></div>
        </div>

        <div class="pref-category">
          <h4> Proteins</h4>
          <div class="pref-chips" id="dislikesProteins"></div>
        </div>

        <div class="pref-category">
          <h4> Dairy & Other</h4>
          <div class="pref-chips" id="dislikesDairy"></div>
        </div>
      </div>

      <!-- Diet Tab -->
      <div class="pref-panel" id="prefDiet">
        <p class="pref-description">Select your dietary preferences:</p>
        <div class="pref-options" id="dietOptions"></div>
      </div>

      <!-- Settings Tab -->
      <div class="pref-panel" id="prefSettings">
        <div class="pref-setting">
          <label>Weekly Budget</label>
          <div class="budget-input">
            <span>$</span>
            <input type="number" id="mealBudget" value="150" min="50" max="500">
            <span>/week</span>
          </div>
        </div>

        <div class="pref-setting">
          <label>Servings per Meal</label>
          <div class="stepper">
            <button onclick="adjustSetting('servings', -1)"></button>
            <span id="servingsValue">4</span>
            <button onclick="adjustSetting('servings', 1)">+</button>
          </div>
        </div>

        <div class="pref-setting">
          <label>Max Ingredients per Meal</label>
          <div class="stepper">
            <button onclick="adjustSetting('maxIngredients', -1)"></button>
            <span id="maxIngredientsValue">7</span>
            <button onclick="adjustSetting('maxIngredients', 1)">+</button>
          </div>
        </div>

        <div class="pref-setting">
          <label>Meals per Day</label>
          <div class="stepper">
            <button onclick="adjustSetting('mealsPerDay', -1)"></button>
            <span id="mealsPerDayValue">3</span>
            <button onclick="adjustSetting('mealsPerDay', 1)">+</button>
          </div>
        </div>
      </div>

      <!-- Stores Tab -->
      <div class="pref-panel" id="prefStores">
        <p class="pref-description">Select stores to compare prices:</p>
        <div class="store-options" id="storeOptions"></div>
      </div>

      <button class="form-submit" onclick="saveMealPreferences()">Save Preferences</button>
    </div>
  </div>

  <!-- FLOATING ACTION BUTTON -->
  <!-- UNDO TOAST -->
  <div class="undo-toast" id="undoToast">
    <span class="undo-toast-text">Item removed</span>
    <button class="undo-toast-btn" onclick="undoDelete()">Undo</button>
  </div>

  <!-- FLOATING ACTION BUTTON -->
  <button class="fab" id="fabBtn" onclick="toggleFabMenu()">+</button>

  <div class="fab-menu" id="fabMenu">
    <div class="fab-menu-item" onclick="openAddMemberModal()">
      <span class="icon"></span>
      <span>Add Family Member</span>
    </div>
    <div class="fab-menu-item" onclick="openFormModal('household', 'note')">
      <span class="icon"></span>
      <span>Household Item</span>
    </div>
    <div class="fab-menu-item" onclick="generateWeeklyPlan()">
      <span class="icon"></span>
      <span>Generate Weekly Plan</span>
    </div>
  </div>

  <!-- MODAL OVERLAY -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeAllModals()"></div>

  <!-- PROFILE SHEET -->
  <div class="bottom-sheet" id="profileSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title" id="profileSheetTitle">Profile</h3>
    </div>
    <div class="sheet-content" id="profileSheetContent"></div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeProfileSheet()">Close</button>
    </div>
  </div>

  <!-- FORM SHEET -->
  <div class="bottom-sheet" id="formSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title" id="formSheetTitle">Add Item</h3>
      <p class="sheet-subtitle" id="formSheetSubtitle"></p>
    </div>
    <div class="sheet-content" id="formSheetContent"></div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeFormSheet()">Cancel</button>
      <button class="btn btn-primary" onclick="submitForm()">Save</button>
    </div>
  </div>

  <!-- ADD MEMBER SHEET -->
  <div class="bottom-sheet" id="addMemberSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title">Add Family Member</h3>
    </div>
    <div class="sheet-content">
      <div class="form-group">
        <label class="form-label">Profile Picture</label>
        <div class="profile-pic-upload" onclick="document.getElementById('memberPhoto').click()">
          <div class="profile-pic-preview" id="memberPhotoPreview"></div>
          <div class="profile-pic-upload-text">
            <strong>Tap to upload</strong><br>or use emoji below
          </div>
          <input type="file" class="profile-pic-input" id="memberPhoto" accept="image/*" onchange="handlePhotoUpload(event)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" class="form-input" id="memberName" placeholder="Enter name">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-select" id="memberRole">
          <option value="adult">Adult</option>
          <option value="child">Child</option>
          <option value="household">Household</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Fallback Icon (emoji)</label>
        <input type="text" class="form-input" id="memberIcon" placeholder="" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Birthday (optional)</label>
        <input type="date" class="form-input" id="memberBirthday">
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeAddMemberSheet()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMember()">Add Member</button>
    </div>
  </div>

  <!-- SETTINGS SHEET -->
  <div class="bottom-sheet" id="settingsSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title">Settings</h3>
    </div>
    <div class="sheet-content">
      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Dark Mode</div>
            <div class="settings-item-desc">Easier on the eyes at night</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Notifications</div>
            <div class="settings-item-desc" id="notificationStatus">Remind me before appointments</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Data Management</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Reset Family Data</div>
            <div class="settings-item-desc">Clear all data and start fresh</div>
          </div>
          <button class="btn btn-danger" onclick="confirmResetData()" style="flex:0;">Reset</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">About</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Version</div>
          </div>
          <span class="text-muted">1.0.0</span>
        </div>
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
    </div>
  </div>

  <!-- TIMER MODAL -->
  <div class="timer-modal" id="timerModal">
    <div class="timer-content">
      <div class="timer-display" id="timerDisplay">5:00</div>
      <div class="timer-label" id="timerLabel">Focus Time</div>
      <div class="timer-actions">
        <button class="timer-btn pause" id="timerPauseBtn" onclick="toggleTimer()">Pause</button>
        <button class="timer-btn stop" onclick="stopTimer()">Done</button>
      </div>
      <div class="timer-ios-hint">
        On iPhone? <a href="#" id="timerIOSLink">Open in Shortcuts</a>
      </div>
    </div>
  </div>

  <!-- SHARE TASK SHEET -->
  <div class="bottom-sheet" id="shareTaskSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title">Share Task</h3>
      <p class="sheet-subtitle" id="shareTaskSubtitle">Assign to another adult</p>
    </div>
    <div class="sheet-content">
      <div class="form-group">
        <label class="form-label">Task Description *</label>
        <input type="text" class="form-input" id="shareTaskTitle" placeholder="e.g., Pick up kids at 3pm">
      </div>
      <div class="form-group">
        <label class="form-label">Assign To *</label>
        <select class="form-select" id="shareTaskAssignee"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="shareTaskPriority">
          <option value="normal">Normal</option>
          <option value="urgent">Urgent - Needs action today</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="shareTaskNotes" placeholder="Any extra details..."></textarea>
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeShareTaskSheet()">Cancel</button>
      <button class="btn btn-primary" onclick="submitShareTask()">Share</button>
    </div>
  </div>

  <script>
    // ========================================
    // LIFE PAGE - COMPLETE APPLICATION
    // ========================================

    // --- STORAGE KEYS ---
    const STORAGE_KEYS = {
      MEMBERS: 'FAMILY_MEMBERS_V1',
      FEED: 'FEED_ITEMS_V1',
      WEEKLY: 'WEEKLY_SUMMARY_V1',
      SETTINGS: 'SETTINGS_V1'
    };

    // --- DEFAULT DATA ---
    // Start empty - user adds their own family members
    const DEFAULT_MEMBERS = [];

    // --- MENU OPTIONS BY ROLE ---
    const MENU_OPTIONS = {
      adult: [
        { action: 'profile', label: 'View Profile', icon: '' },
        { action: 'appointment', label: 'Add Appointment', icon: '' },
        { action: 'roster', label: 'Add Roster', icon: '' },
        { action: 'event', label: 'Add Event', icon: '' },
        { action: 'goal', label: 'Add Goal', icon: '' },
        { action: 'note', label: 'Add Note', icon: '' },
        { action: 'share', label: 'Share Task', icon: '' }
      ],
      child: [
        { action: 'profile', label: 'View Profile', icon: '' },
        { action: 'appointment', label: 'Add Appointment', icon: '' },
        { action: 'milestone', label: 'Add Milestone', icon: '' },
        { action: 'event', label: 'Add Event', icon: '' },
        { action: 'goal', label: 'Add Goal', icon: '' },
        { action: 'note', label: 'Add Photo/Note', icon: '' }
      ],
      household: [
        { action: 'profile', label: 'View Details', icon: '' },
        { action: 'note', label: 'Shared Task', icon: '' },
        { action: 'event', label: 'Shared Event', icon: '' },
        { action: 'weekly', label: 'Weekly Plan', icon: '' }
      ]
    };

    // --- PREP MICRO-STEPS TEMPLATE ---
    const PREP_STEPS = [
      { text: 'Confirm appointment time & location', time: 2 },
      { text: 'Check if any fasting/prep required', time: 1 },
      { text: 'Gather required documents/referrals', time: 3 },
      { text: 'Pack essentials (wallet, phone, snacks)', time: 3 },
      { text: 'Plan travel route & parking', time: 2 },
      { text: 'Set leave-time reminder', time: 1 }
    ];

    const PREP_QUESTIONS = [
      'Any fasting required?',
      'Any forms/referrals needed?',
      'Any special items to bring?'
    ];

    // --- STATE ---
    let familyMembers = [];
    let feedItems = [];
    let currentFormMember = null;
    let currentFormType = null;

    // ========================================
    // PERSISTENCE
    // ========================================
    function loadData() {
      try {
        const membersData = localStorage.getItem(STORAGE_KEYS.MEMBERS);
        const feedData = localStorage.getItem(STORAGE_KEYS.FEED);

        familyMembers = membersData ? JSON.parse(membersData) : [];
        feedItems = feedData ? JSON.parse(feedData) : [];
      } catch (e) {
        console.error('Error loading data:', e);
        familyMembers = [];
        feedItems = [];
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEYS.MEMBERS, JSON.stringify(familyMembers));
        localStorage.setItem(STORAGE_KEYS.FEED, JSON.stringify(feedItems));
      } catch (e) {
        console.error('Error saving data:', e);
      }
    }

    function resetAllData() {
      Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
      familyMembers = [...DEFAULT_MEMBERS];
      feedItems = [];
      saveData();
      renderBubbles();
      renderFeed();
      closeSettings();
    }

    // ========================================
    // UTILITIES
    // ========================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function formatTime(timeStr) {
      const [h, m] = timeStr.split(':');
      const hour = parseInt(h);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${m} ${ampm}`;
    }

    function isWithinDays(dateStr, days) {
      const target = new Date(dateStr);
      const now = new Date();
      const diff = (target - now) / (1000 * 60 * 60 * 24);
      return diff >= 0 && diff <= days;
    }

    function getMemberById(id) {
      return familyMembers.find(m => m.id === id);
    }

    // Timer state
    let timerInterval = null;
    let timerSeconds = 0;
    let timerPaused = false;
    let timerMinutes = 5;

    function startTimer(minutes) {
      timerMinutes = minutes;
      const iosUrl = `shortcuts://run-shortcut?name=Start%20Focus%20Timer&input=${minutes}`;

      // Check if likely iOS (for the hint link)
      document.getElementById('timerIOSLink').href = iosUrl;

      // Start web-based timer
      timerSeconds = minutes * 60;
      timerPaused = false;
      updateTimerDisplay();
      document.getElementById('timerPauseBtn').textContent = 'Pause';
      document.getElementById('timerModal').classList.add('active');

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(tickTimer, 1000);
    }

    function tickTimer() {
      if (timerPaused) return;

      timerSeconds--;
      updateTimerDisplay();

      if (timerSeconds <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        document.getElementById('timerDisplay').textContent = "Done!";
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      }
    }

    function updateTimerDisplay() {
      const mins = Math.floor(timerSeconds / 60);
      const secs = timerSeconds % 60;
      document.getElementById('timerDisplay').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function toggleTimer() {
      timerPaused = !timerPaused;
      document.getElementById('timerPauseBtn').textContent = timerPaused ? 'Resume' : 'Pause';
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('timerModal').classList.remove('active');
    }

    function showScreenshotHint() {
      alert('Screenshot import is coming soon! For now, please enter your roster details manually below.');
    }

    // Appointment photo handling with AI parsing
    let appointmentPhotoData = null;

    async function handleAppointmentPhoto(event) {
      const file = event.target.files[0];
      if (!file) return;

      const preview = document.getElementById('appointmentPhotoPreview');
      preview.classList.add('has-image');
      preview.innerHTML = `
        <img src="${URL.createObjectURL(file)}" alt="Appointment">
        <div class="ai-status"> Analyzing image...</div>
      `;

      // Convert to base64 for API
      const reader = new FileReader();
      reader.onload = async function(e) {
        appointmentPhotoData = e.target.result;

        // Call AI to parse the image
        try {
          const parsed = await parseAppointmentImage(appointmentPhotoData);
          if (parsed) {
            // Auto-fill the form
            if (parsed.title) document.getElementById('formTitle').value = parsed.title;
            if (parsed.date) document.getElementById('formDate').value = parsed.date;
            if (parsed.time) document.getElementById('formTime').value = parsed.time;
            if (parsed.location) document.getElementById('formLocation').value = parsed.location;
            if (parsed.notes) document.getElementById('formNotes').value = parsed.notes;

            preview.innerHTML = `
              <img src="${appointmentPhotoData}" alt="Appointment">
              <div class="ai-status" style="background:#dcfce7;color:#166534;"> Details extracted!</div>
            `;
          }
        } catch (err) {
          console.error('AI parsing failed:', err);
          preview.innerHTML = `
            <img src="${appointmentPhotoData}" alt="Appointment">
            <div class="ai-status" style="background:#fee2e2;color:#991b1b;">Could not extract details. Please fill manually.</div>
          `;
        }
      };
      reader.readAsDataURL(file);
    }

    // AI parsing function - calls the backend API
    async function parseAppointmentImage(imageBase64) {
      const idToken = localStorage.getItem('google_id_token');

      if (!idToken) {
        console.warn('No auth token - user needs to sign in');
        return null;
      }

      try {
        // Remove data URL prefix if present
        const base64Data = imageBase64.replace(/^data:image\/\w+;base64,/, '');

        const response = await fetch('/api/appointments/extract', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({
            imageBase64: base64Data,
            locale: 'en-AU',
            tz: 'Australia/Sydney'
          })
        });

        if (!response.ok) {
          console.error('API error:', response.status);
          return null;
        }

        const data = await response.json();

        if (data.appointment) {
          // Map API response to our form fields
          return {
            title: data.appointment.title || '',
            date: data.appointment.date || '',
            time: data.appointment.time || '',
            location: data.appointment.venueName || data.appointment.address || '',
            notes: data.appointment.notes || ''
          };
        }

        return null;
      } catch (err) {
        console.error('Failed to parse appointment image:', err);
        return null;
      }
    }

    // Location search - opens maps
    function searchLocation() {
      const locationInput = document.getElementById('formLocation');
      const query = locationInput.value.trim();

      if (query) {
        // Open in Google Maps
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        window.open(mapsUrl, '_blank');
      } else {
        // Prompt for location
        const search = prompt('Enter location to search:');
        if (search) {
          locationInput.value = search;
          const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(search)}`;
          window.open(mapsUrl, '_blank');
        }
      }
    }

    // Share appointment via SMS or native share
    function shareAppointment(itemId) {
      const item = feedItems.find(i => i.id === itemId);
      if (!item) return;

      const member = getMemberById(item.memberId);
      const memberName = member?.name || 'Someone';

      // Build share text
      let shareText = ` Appointment: ${item.title}\n`;
      shareText += ` For: ${memberName}\n`;
      shareText += ` Date: ${formatDate(item.date)}\n`;
      shareText += ` Time: ${formatTime(item.time)}\n`;

      if (item.location) {
        shareText += ` Location: ${item.location}\n`;
        shareText += ` Map: https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}\n`;
      }

      if (item.notes) {
        shareText += ` Notes: ${item.notes}\n`;
      }

      // Try native share first (works on mobile)
      if (navigator.share) {
        navigator.share({
          title: `Appointment: ${item.title}`,
          text: shareText
        }).catch(err => {
          // Fallback to SMS if share fails
          openSmsShare(shareText);
        });
      } else {
        // Fallback to SMS on desktop or older browsers
        openSmsShare(shareText);
      }
    }

    function openSmsShare(text) {
      // sms: link works on iOS and Android
      const smsUrl = `sms:?body=${encodeURIComponent(text)}`;
      window.location.href = smsUrl;
    }

    // ========================================
    // BUBBLE RENDERING
    // ========================================
    function renderBubbles() {
      const row = document.getElementById('bubbleRow');
      row.innerHTML = '';

      familyMembers.forEach(member => {
        const wrapper = document.createElement('div');
        wrapper.className = 'bubble-wrapper';

        const bubble = document.createElement('div');
        bubble.className = `bubble type-${member.role}`;
        bubble.dataset.id = member.id;

        // Show photo if available, otherwise show emoji
        if (member.photo) {
          bubble.innerHTML = `<img src="${member.photo}" alt="${member.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
        } else {
          bubble.innerHTML = member.icon;
        }

        const label = document.createElement('div');
        label.className = 'bubble-label';
        label.textContent = member.name;

        const menu = createActionMenu(member);

        wrapper.appendChild(bubble);
        wrapper.appendChild(label);
        wrapper.appendChild(menu);
        row.appendChild(wrapper);

        attachBubbleInteraction(bubble, member);
      });

      // Add "+" bubble for adding members
      const addWrapper = document.createElement('div');
      addWrapper.className = 'bubble-wrapper';
      const addBubble = document.createElement('div');
      addBubble.className = 'bubble bubble-add';
      addBubble.innerHTML = '+';
      addBubble.onclick = openAddMemberModal;
      const addLabel = document.createElement('div');
      addLabel.className = 'bubble-label';
      addLabel.textContent = 'Add';
      addWrapper.appendChild(addBubble);
      addWrapper.appendChild(addLabel);
      row.appendChild(addWrapper);
    }

    function createActionMenu(member) {
      const menu = document.createElement('div');
      menu.className = 'action-menu';
      menu.id = `menu-${member.id}`;

      const options = MENU_OPTIONS[member.role] || MENU_OPTIONS.adult;
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'menu-item';
        btn.innerHTML = `<span class="menu-icon">${opt.icon}</span>${opt.label}`;
        btn.onclick = (e) => {
          e.stopPropagation();
          closeAllMenus();
          if (opt.action === 'profile') {
            openProfileSheet(member);
          } else if (opt.action === 'weekly') {
            generateWeeklyPlan();
          } else if (opt.action === 'share') {
            openShareTaskSheet(member.id);
          } else {
            openFormModal(member.id, opt.action);
          }
        };
        menu.appendChild(btn);
      });

      return menu;
    }

    function attachBubbleInteraction(element, member) {
      // Simple tap to open menu
      element.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = document.getElementById(`menu-${member.id}`);
        const isOpen = menu && menu.classList.contains('visible');

        closeAllMenus();

        if (!isOpen) {
          openMenu(member.id);
        }
      });
    }

    function openMenu(memberId) {
      closeAllMenus();
      const menu = document.getElementById(`menu-${memberId}`);
      const bubble = menu?.parentElement?.querySelector('.bubble');
      if (menu && bubble) {
        const rect = bubble.getBoundingClientRect();
        menu.style.top = (rect.bottom + 10) + 'px';
        menu.style.left = (rect.left + rect.width / 2) + 'px';
        menu.classList.add('visible');
      }
    }

    function closeAllMenus() {
      document.querySelectorAll('.action-menu').forEach(m => m.classList.remove('visible'));
    }

    // ========================================
    // FEED RENDERING
    // ========================================
    function renderFeed() {
      const content = document.getElementById('feedContent');

      if (feedItems.length === 0) {
        const hasMembers = familyMembers.length > 0;
        content.innerHTML = `
          <div class="feed-empty">
            <div class="feed-empty-icon">${hasMembers ? '' : ''}</div>
            <div class="feed-empty-text">
              ${hasMembers
                ? '<strong>All clear!</strong><br>Nothing needs your attention right now.'
                : '<strong>Welcome to Life!</strong><br>Your family command center starts here.'}
            </div>
            <div class="feed-empty-hint">
              ${hasMembers
                ? ' Tap a bubble to quickly add items'
                : ' Tap + to add your first family member'}
            </div>
          </div>
        `;
        return;
      }

      // Sort: pinned first, then by urgency (due within 48h), then by date
      const sorted = [...feedItems].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;

        const aUrgent = a.date && isWithinDays(a.date, 2);
        const bUrgent = b.date && isWithinDays(b.date, 2);
        if (aUrgent && !bUrgent) return -1;
        if (!aUrgent && bUrgent) return 1;

        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      // Separate pinned and regular
      const pinned = sorted.filter(item => item.pinned);
      const regular = sorted.filter(item => !item.pinned);

      let html = '';

      // Today View - show what's happening today
      const todayCard = renderTodayView();
      if (todayCard) {
        html += todayCard;
      }

      if (pinned.length > 0) {
        html += '<div class="feed-section-title">Pinned</div>';
        pinned.forEach(item => html += renderFeedCard(item));
      }

      if (regular.length > 0) {
        html += '<div class="feed-section-title">Current Focus</div>';
        regular.forEach(item => html += renderFeedCard(item));
      }

      content.innerHTML = html;
    }

    function renderTodayView() {
      const today = new Date().toISOString().split('T')[0];
      const todayItems = feedItems.filter(item => item.date === today && item.type !== 'weekly');

      if (todayItems.length === 0) return '';

      const appointments = todayItems.filter(i => i.type === 'appointment');
      const rosters = todayItems.filter(i => i.type === 'roster');
      const events = todayItems.filter(i => i.type === 'event');

      let itemsHtml = '';

      appointments.forEach(a => {
        const member = getMemberById(a.memberId);
        itemsHtml += `<div class="today-item"> <strong>${formatTime(a.time)}</strong> - ${a.title} (${member?.name || 'Unknown'})</div>`;
      });

      rosters.forEach(r => {
        const member = getMemberById(r.memberId);
        itemsHtml += `<div class="today-item"> <strong>${formatTime(r.startTime)}</strong> - ${member?.name || 'Adult'} working</div>`;
      });

      events.forEach(e => {
        const member = getMemberById(e.memberId);
        itemsHtml += `<div class="today-item"> ${e.time ? `<strong>${formatTime(e.time)}</strong> - ` : ''}${e.title}</div>`;
      });

      return `
        <div class="today-view-card">
          <div class="today-header">
            <span class="today-icon"></span>
            <span class="today-title">Today</span>
            <span class="today-date">${new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'short' })}</span>
          </div>
          <div class="today-items">
            ${itemsHtml}
          </div>
        </div>
      `;
    }

    function renderFeedCard(item) {
      const member = getMemberById(item.memberId);
      const memberName = member ? member.name : 'Unknown';
      const memberIcon = member ? member.icon : '';

      let cardClass = `feed-card type-${item.type}`;
      if (item.pinned) cardClass += ' pinned';

      let body = '';
      let meta = '';
      let actions = '';
      let microSteps = '';

      switch (item.type) {
        case 'appointment':
          body = item.notes || 'No additional details';
          if (item.location) body = ` <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}" target="_blank" style="color:inherit;text-decoration:underline;">${item.location}</a><br>${body}`;
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
              <span class="card-meta-item"> ${formatTime(item.time)}</span>
            </div>
          `;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn" onclick="shareAppointment('${item.id}')"> Share</button>
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Done</button>
            </div>
          `;
          break;

        case 'prep':
          body = `Prepare for: <strong>${item.relatedTitle}</strong>`;
          microSteps = renderMicroSteps(item);
          break;

        case 'roster':
          body = `${formatTime(item.startTime)} - ${formatTime(item.endTime)}`;
          if (item.location) body += `<br> ${item.location}`;
          if (item.notes) body += `<br>${item.notes}`;
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
            </div>
          `;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Done</button>
            </div>
          `;
          break;

        case 'milestone':
          body = item.notes || 'A special moment!';
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
            </div>
          `;
          break;

        case 'event':
          body = item.notes || '';
          if (item.location) body = ` ${item.location}${body ? '<br>' + body : ''}`;
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
              ${item.time ? `<span class="card-meta-item"> ${formatTime(item.time)}</span>` : ''}
            </div>
          `;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Done</button>
            </div>
          `;
          break;

        case 'goal':
          body = item.notes || '';
          if (item.timeframe) body = ` ${item.timeframe}${body ? '<br>' + body : ''}`;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Achieved</button>
            </div>
          `;
          break;

        case 'note':
          body = item.notes || item.content || '';
          actions = `
            <div class="card-actions">
              <button class="card-action-btn secondary" onclick="markDone('${item.id}')"> Dismiss</button>
            </div>
          `;
          break;

        case 'conflict':
          body = item.description;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn secondary" onclick="markDone('${item.id}')">Resolved</button>
            </div>
          `;
          break;

        case 'weekly':
          body = renderWeeklySummaryContent(item);
          break;

        case 'birthday':
          body = item.notes || '';
          meta = item.date ? `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
            </div>
          ` : '';
          actions = `
            <div class="card-actions">
              <button class="card-action-btn secondary" onclick="markDone('${item.id}')"> Noted</button>
            </div>
          `;
          break;

        default:
          body = item.notes || item.content || '';
      }

      const typeLabels = {
        appointment: ' Appointment',
        prep: ' Prep Needed',
        roster: ' Roster',
        milestone: ' Milestone',
        event: ' Event',
        goal: ' Goal',
        note: ' Note',
        conflict: ' Conflict',
        weekly: ' Weekly Plan',
        birthday: ' Birthday'
      };

      return `
        <div class="${cardClass}" data-id="${item.id}">
          <div class="card-header">
            <span class="card-type-badge">${typeLabels[item.type] || item.type}</span>
            ${item.recurrence ? `<span class="card-recurrence-badge"> ${item.recurrence}</span>` : ''}
            <span class="card-member-badge">${memberIcon} ${memberName}</span>
          </div>
          <div class="card-title">
            ${item.pinned ? '<span class="pin-icon"></span>' : ''}
            ${item.title}
          </div>
          <div class="card-body">${body}</div>
          ${meta}
          ${microSteps}
          ${actions}
        </div>
      `;
    }

    function renderMicroSteps(item) {
      if (!item.steps || item.steps.length === 0) return '';

      const stepsHtml = item.steps.map((step, idx) => {
        const checked = step.done ? 'checked' : '';
        const completed = step.done ? 'completed' : '';
        return `
          <div class="micro-step ${completed}">
            <div class="micro-step-checkbox ${checked}" onclick="toggleStep('${item.id}', ${idx})">
              ${step.done ? '' : ''}
            </div>
            <div class="micro-step-content">
              <div class="micro-step-text">${step.text}</div>
              <div class="micro-step-time">~${step.time} min</div>
            </div>
            <button class="micro-step-timer" onclick="startTimer(${step.time <= 2 ? 3 : step.time})">
              Start ${step.time <= 2 ? 3 : step.time}m
            </button>
          </div>
        `;
      }).join('');

      let questionsHtml = '';
      if (item.questions && item.questions.length > 0) {
        questionsHtml = `
          <div class="open-questions">
            <div class="open-questions-title"> Open Questions</div>
            ${item.questions.map(q => `<div class="open-question-item"> ${q}</div>`).join('')}
          </div>
        `;
      }

      return `
        <div class="micro-steps">
          <div class="micro-steps-title">Micro-Steps</div>
          ${stepsHtml}
        </div>
        ${questionsHtml}
      `;
    }

    function renderWeeklySummaryContent(item) {
      const data = item.summaryData || {};

      return `
        <div class="weekly-summary-section">
          <h4> Week at a Glance</h4>
          <ul>
            ${(data.weekOverview || ['No items scheduled']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Roster Overview</h4>
          <ul>
            ${(data.rosterOverview || ['No roster entries']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Appointments & Events</h4>
          <ul>
            ${(data.appointments || ['None this week']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Prep Tasks Needed</h4>
          <ul>
            ${(data.prepTasks || ['None']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Top 5 Priority Actions</h4>
          <ul>
            ${(data.priorities || ['Review upcoming appointments']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Handoffs & Coordination</h4>
          <ul>
            ${(data.handoffs || ['Check roster for overlaps']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Open Questions</h4>
          <ul>
            ${(data.openQuestions || ['Any appointments need confirming?']).map(i => `<li>${i}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    // ========================================
    // FEED ACTIONS
    // ========================================
    let lastDeletedItem = null;
    let undoTimeout = null;

    function markDone(itemId) {
      const item = feedItems.find(i => i.id === itemId);
      if (!item) return;

      // Store for undo
      lastDeletedItem = { ...item };

      // Remove item
      feedItems = feedItems.filter(i => i.id !== itemId);
      saveData();
      renderFeed();

      // Show undo toast
      showUndoToast();
    }

    function showUndoToast() {
      const toast = document.getElementById('undoToast');
      toast.classList.add('visible');

      // Clear any existing timeout
      if (undoTimeout) clearTimeout(undoTimeout);

      // Auto-hide after 5 seconds
      undoTimeout = setTimeout(() => {
        toast.classList.remove('visible');
        lastDeletedItem = null;
      }, 5000);
    }

    function undoDelete() {
      if (lastDeletedItem) {
        feedItems.push(lastDeletedItem);
        saveData();
        renderFeed();
        lastDeletedItem = null;
      }

      // Hide toast
      const toast = document.getElementById('undoToast');
      toast.classList.remove('visible');
      if (undoTimeout) clearTimeout(undoTimeout);
    }

    function toggleStep(itemId, stepIdx) {
      const item = feedItems.find(i => i.id === itemId);
      if (item && item.steps && item.steps[stepIdx]) {
        item.steps[stepIdx].done = !item.steps[stepIdx].done;
        saveData();
        renderFeed();
      }
    }

    // ========================================
    // FORM HANDLING
    // ========================================
    function openFormModal(memberId, formType) {
      currentFormMember = memberId;
      currentFormType = formType;

      const member = getMemberById(memberId);
      const memberName = member ? member.name : 'Unknown';

      const titles = {
        appointment: 'Add Appointment',
        roster: 'Add Roster Entry',
        milestone: 'Add Milestone',
        event: 'Add Event',
        goal: 'Add Goal',
        note: 'Add Note'
      };

      document.getElementById('formSheetTitle').textContent = titles[formType] || 'Add Item';
      document.getElementById('formSheetSubtitle').textContent = `For ${memberName}`;
      document.getElementById('formSheetContent').innerHTML = getFormHtml(formType);

      openModal('formSheet');
    }

    function getFormHtml(type) {
      switch (type) {
        case 'appointment':
          return `
            <div class="screenshot-import-placeholder" onclick="document.getElementById('appointmentPhoto').click()">
              <span class="screenshot-icon"></span>
              <span class="screenshot-text">Scan appointment letter/SMS</span>
              <span class="screenshot-badge">AI Fill</span>
              <input type="file" id="appointmentPhoto" accept="image/*" capture="environment" style="display:none" onchange="handleAppointmentPhoto(event)">
            </div>
            <div id="appointmentPhotoPreview" class="appointment-photo-preview"></div>
            <div class="form-divider">
              <span>or enter manually</span>
            </div>
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., Doctor checkup">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="formDate">
              </div>
              <div class="form-group">
                <label class="form-label">Time *</label>
                <input type="time" class="form-input" id="formTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Location</label>
              <div class="location-input-wrapper">
                <input type="text" class="form-input" id="formLocation" placeholder="e.g., Medical Centre">
                <button type="button" class="location-search-btn" onclick="searchLocation()"></button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Any additional details..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Repeat</label>
              <select class="form-select" id="formRecurrence">
                <option value="none">Does not repeat</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="fortnightly">Fortnightly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          `;

        case 'roster':
          return `
            <div class="screenshot-import-placeholder" onclick="showScreenshotHint()">
              <span class="screenshot-icon"></span>
              <span class="screenshot-text">Import from Screenshot</span>
              <span class="screenshot-badge">Coming Soon</span>
            </div>
            <div class="form-divider">
              <span>or enter manually</span>
            </div>
            <div class="form-group">
              <label class="form-label">Date *</label>
              <input type="date" class="form-input" id="formDate">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Start Time *</label>
                <input type="time" class="form-input" id="formStartTime">
              </div>
              <div class="form-group">
                <label class="form-label">End Time *</label>
                <input type="time" class="form-input" id="formEndTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Location / Ward</label>
              <input type="text" class="form-input" id="formLocation" placeholder="e.g., Ward 2B">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Any notes..."></textarea>
            </div>
          `;

        case 'milestone':
          return `
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., First steps!">
            </div>
            <div class="form-group">
              <label class="form-label">Date *</label>
              <input type="date" class="form-input" id="formDate">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Describe this special moment..."></textarea>
            </div>
          `;

        case 'event':
          return `
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., Birthday party">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="formDate">
              </div>
              <div class="form-group">
                <label class="form-label">Time</label>
                <input type="time" class="form-input" id="formTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" class="form-input" id="formLocation" placeholder="e.g., Park">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Details..."></textarea>
            </div>
          `;

        case 'goal':
          return `
            <div class="form-group">
              <label class="form-label">Goal Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., Learn to ride a bike">
            </div>
            <div class="form-group">
              <label class="form-label">Timeframe</label>
              <input type="text" class="form-input" id="formTimeframe" placeholder="e.g., By end of summer">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Details about this goal..."></textarea>
            </div>
          `;

        case 'note':
          return `
            <div class="form-group">
              <label class="form-label">Title</label>
              <input type="text" class="form-input" id="formTitle" placeholder="Quick title (optional)">
            </div>
            <div class="form-group">
              <label class="form-label">Note *</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Write your note..." style="min-height: 120px;"></textarea>
            </div>
          `;

        default:
          return '<p>Form not available</p>';
      }
    }

    function submitForm() {
      const titleEl = document.getElementById('formTitle');
      const dateEl = document.getElementById('formDate');
      const timeEl = document.getElementById('formTime');
      const startTimeEl = document.getElementById('formStartTime');
      const endTimeEl = document.getElementById('formEndTime');
      const locationEl = document.getElementById('formLocation');
      const notesEl = document.getElementById('formNotes');
      const timeframeEl = document.getElementById('formTimeframe');
      const recurrenceEl = document.getElementById('formRecurrence');

      const title = titleEl?.value?.trim();
      const date = dateEl?.value;
      const time = timeEl?.value;
      const startTime = startTimeEl?.value;
      const endTime = endTimeEl?.value;
      const location = locationEl?.value?.trim();
      const notes = notesEl?.value?.trim();
      const timeframe = timeframeEl?.value?.trim();
      const recurrence = recurrenceEl?.value || 'none';

      // Validation
      if (currentFormType === 'appointment' && (!title || !date || !time)) {
        alert('Please fill in Title, Date, and Time');
        return;
      }
      if (currentFormType === 'roster' && (!date || !startTime || !endTime)) {
        alert('Please fill in Date, Start Time, and End Time');
        return;
      }
      if (currentFormType === 'milestone' && (!title || !date)) {
        alert('Please fill in Title and Date');
        return;
      }
      if (currentFormType === 'event' && (!title || !date)) {
        alert('Please fill in Title and Date');
        return;
      }
      if (currentFormType === 'goal' && !title) {
        alert('Please fill in Goal Title');
        return;
      }
      if (currentFormType === 'note' && !notes) {
        alert('Please write a note');
        return;
      }

      // Create feed item
      const newItem = {
        id: generateId(),
        memberId: currentFormMember,
        type: currentFormType,
        title: title || (currentFormType === 'roster' ? 'Shift' : 'Note'),
        createdAt: new Date().toISOString(),
        date,
        time,
        startTime,
        endTime,
        location,
        notes,
        timeframe,
        recurrence: recurrence !== 'none' ? recurrence : null
      };

      feedItems.push(newItem);

      // Generate recurring items if recurrence is set
      if (recurrence !== 'none' && date) {
        generateRecurringItems(newItem, recurrence);
      }

      // Auto-create prep card for appointments within 7 days
      if (currentFormType === 'appointment' && date && isWithinDays(date, 7)) {
        const prepItem = {
          id: generateId(),
          memberId: currentFormMember,
          type: 'prep',
          title: `Prep: ${title}`,
          relatedTitle: title,
          relatedId: newItem.id,
          createdAt: new Date().toISOString(),
          date: date,
          steps: PREP_STEPS.map(s => ({ ...s, done: false })),
          questions: [...PREP_QUESTIONS]
        };
        feedItems.push(prepItem);
      }

      // Check for roster conflicts
      if (currentFormType === 'roster') {
        checkRosterConflicts(newItem);
      }

      saveData();
      closeFormSheet();
      renderFeed();
    }

    function generateRecurringItems(baseItem, recurrence) {
      const baseDate = new Date(baseItem.date);
      const maxItems = 12; // Generate up to 12 future occurrences

      for (let i = 1; i <= maxItems; i++) {
        const nextDate = new Date(baseDate);

        switch (recurrence) {
          case 'daily':
            nextDate.setDate(baseDate.getDate() + i);
            break;
          case 'weekly':
            nextDate.setDate(baseDate.getDate() + (i * 7));
            break;
          case 'fortnightly':
            nextDate.setDate(baseDate.getDate() + (i * 14));
            break;
          case 'monthly':
            nextDate.setMonth(baseDate.getMonth() + i);
            break;
          case 'yearly':
            nextDate.setFullYear(baseDate.getFullYear() + i);
            break;
        }

        // Only create items up to 90 days in the future (except yearly)
        const now = new Date();
        const daysAhead = (nextDate - now) / (1000 * 60 * 60 * 24);
        if (recurrence !== 'yearly' && daysAhead > 90) break;
        if (recurrence === 'yearly' && daysAhead > 400) break;

        const recurringItem = {
          id: generateId(),
          memberId: baseItem.memberId,
          type: baseItem.type,
          title: baseItem.title,
          createdAt: new Date().toISOString(),
          date: nextDate.toISOString().split('T')[0],
          time: baseItem.time,
          startTime: baseItem.startTime,
          endTime: baseItem.endTime,
          location: baseItem.location,
          notes: baseItem.notes,
          recurrence: recurrence,
          parentId: baseItem.id,
          isRecurring: true
        };

        feedItems.push(recurringItem);

        // Also create prep items for recurring appointments
        if (baseItem.type === 'appointment' && isWithinDays(recurringItem.date, 7)) {
          const prepItem = {
            id: generateId(),
            memberId: baseItem.memberId,
            type: 'prep',
            title: `Prep: ${baseItem.title}`,
            relatedTitle: baseItem.title,
            relatedId: recurringItem.id,
            createdAt: new Date().toISOString(),
            date: recurringItem.date,
            steps: PREP_STEPS.map(s => ({ ...s, done: false })),
            questions: [...PREP_QUESTIONS]
          };
          feedItems.push(prepItem);
        }
      }
    }

    function checkRosterConflicts(newRoster) {
      const sameDayRosters = feedItems.filter(item =>
        item.type === 'roster' &&
        item.date === newRoster.date &&
        item.id !== newRoster.id &&
        item.memberId !== newRoster.memberId
      );

      sameDayRosters.forEach(otherRoster => {
        // Check time overlap
        const newStart = newRoster.startTime;
        const newEnd = newRoster.endTime;
        const otherStart = otherRoster.startTime;
        const otherEnd = otherRoster.endTime;

        const overlap = (newStart < otherEnd && newEnd > otherStart);

        if (overlap) {
          const member1 = getMemberById(newRoster.memberId)?.name || 'Adult 1';
          const member2 = getMemberById(otherRoster.memberId)?.name || 'Adult 2';

          const conflictItem = {
            id: generateId(),
            memberId: 'household',
            type: 'conflict',
            title: ' Roster Overlap Detected',
            description: `${member1} and ${member2} both have shifts on ${formatDate(newRoster.date)}. Handoff coordination needed!`,
            createdAt: new Date().toISOString(),
            date: newRoster.date
          };

          feedItems.push(conflictItem);
        }
      });
    }

    // ========================================
    // WEEKLY PLAN GENERATION
    // ========================================
    function generateWeeklyPlan() {
      closeFabMenu();

      // Remove existing weekly summary
      feedItems = feedItems.filter(item => item.type !== 'weekly');

      // Gather data for the week
      const now = new Date();
      const weekEnd = new Date(now);
      weekEnd.setDate(weekEnd.getDate() + 7);

      const thisWeekItems = feedItems.filter(item => {
        if (!item.date) return false;
        const d = new Date(item.date);
        return d >= now && d <= weekEnd;
      });

      const appointments = thisWeekItems.filter(i => i.type === 'appointment');
      const rosters = thisWeekItems.filter(i => i.type === 'roster');
      const events = thisWeekItems.filter(i => i.type === 'event');
      const preps = feedItems.filter(i => i.type === 'prep');

      // Build summary data
      const summaryData = {
        weekOverview: [],
        rosterOverview: [],
        appointments: [],
        prepTasks: [],
        priorities: [],
        handoffs: [],
        openQuestions: []
      };

      // Week overview
      summaryData.weekOverview.push(`${appointments.length} appointment(s) scheduled`);
      summaryData.weekOverview.push(`${rosters.length} roster shift(s)`);
      summaryData.weekOverview.push(`${events.length} event(s)`);

      // Roster overview
      rosters.forEach(r => {
        const member = getMemberById(r.memberId);
        summaryData.rosterOverview.push(
          `${member?.name || 'Adult'}: ${formatDate(r.date)} ${formatTime(r.startTime)}-${formatTime(r.endTime)}`
        );
      });
      if (summaryData.rosterOverview.length === 0) {
        summaryData.rosterOverview.push('No roster entries this week');
      }

      // Appointments
      appointments.forEach(a => {
        const member = getMemberById(a.memberId);
        summaryData.appointments.push(
          `${member?.name || 'Member'}: ${a.title} on ${formatDate(a.date)}`
        );
      });
      events.forEach(e => {
        summaryData.appointments.push(`Event: ${e.title} on ${formatDate(e.date)}`);
      });
      if (summaryData.appointments.length === 0) {
        summaryData.appointments.push('None scheduled');
      }

      // Prep tasks
      preps.forEach(p => {
        const incomplete = p.steps?.filter(s => !s.done).length || 0;
        if (incomplete > 0) {
          summaryData.prepTasks.push(`${p.title}: ${incomplete} steps remaining`);
        }
      });
      if (summaryData.prepTasks.length === 0) {
        summaryData.prepTasks.push('All prep complete!');
      }

      // Priorities
      if (appointments.length > 0) {
        summaryData.priorities.push('Confirm all appointment times');
      }
      if (preps.length > 0) {
        summaryData.priorities.push('Complete prep checklists');
      }
      summaryData.priorities.push('Check roster for handoff needs');
      summaryData.priorities.push('Plan meals for the week');
      summaryData.priorities.push('Review family calendar together');

      // Handoffs
      const rosterDates = [...new Set(rosters.map(r => r.date))];
      rosterDates.forEach(date => {
        const dayRosters = rosters.filter(r => r.date === date);
        if (dayRosters.length > 1) {
          summaryData.handoffs.push(`${formatDate(date)}: Multiple adults working - coordinate handoff`);
        }
      });
      if (summaryData.handoffs.length === 0) {
        summaryData.handoffs.push('No handoff conflicts detected');
      }

      // Open Questions (max 5)
      if (appointments.length > 0) {
        summaryData.openQuestions.push('Any appointments need confirming or rescheduling?');
      }
      if (rosters.length > 0) {
        summaryData.openQuestions.push('Are all roster shifts finalized?');
      }
      const children = familyMembers.filter(m => m.role === 'child');
      if (children.length > 0) {
        summaryData.openQuestions.push('Any childcare arrangements needed?');
      }
      if (events.length > 0) {
        summaryData.openQuestions.push('Any event prep or RSVPs outstanding?');
      }
      summaryData.openQuestions.push('What could derail this week?');
      // Limit to 5
      summaryData.openQuestions = summaryData.openQuestions.slice(0, 5);

      // Create weekly summary item
      const weeklyItem = {
        id: generateId(),
        memberId: 'household',
        type: 'weekly',
        title: "This Week's Family Plan",
        pinned: true,
        createdAt: new Date().toISOString(),
        summaryData
      };

      feedItems.unshift(weeklyItem);
      saveData();
      renderFeed();

      // Scroll to top
      document.getElementById('feedLayer').scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========================================
    // MEMBER MANAGEMENT
    // ========================================
    let memberPhotoData = null;

    function openAddMemberModal() {
      closeFabMenu();
      closeAllMenus();
      document.getElementById('memberName').value = '';
      document.getElementById('memberRole').value = 'adult';
      document.getElementById('memberIcon').value = '';
      document.getElementById('memberBirthday').value = '';
      document.getElementById('memberPhoto').value = '';
      document.getElementById('memberPhotoPreview').innerHTML = '';
      memberPhotoData = null;
      openModal('addMemberSheet');
    }

    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (max 500KB to keep localStorage reasonable)
      if (file.size > 500000) {
        alert('Image too large. Please use an image under 500KB.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        memberPhotoData = e.target.result;
        document.getElementById('memberPhotoPreview').innerHTML =
          `<img src="${memberPhotoData}" alt="Profile">`;
      };
      reader.readAsDataURL(file);
    }

    function saveMember() {
      const name = document.getElementById('memberName').value.trim();
      const role = document.getElementById('memberRole').value;
      let icon = document.getElementById('memberIcon').value.trim();
      const birthday = document.getElementById('memberBirthday').value;

      if (!name) {
        alert('Please enter a name');
        return;
      }

      if (!icon) {
        icon = role === 'child' ? '' : role === 'household' ? '' : '';
      }

      const newMember = {
        id: generateId(),
        name,
        role,
        icon,
        photo: memberPhotoData || null,
        birthday: birthday || null
      };

      // Insert before household
      const householdIdx = familyMembers.findIndex(m => m.role === 'household');
      if (householdIdx >= 0) {
        familyMembers.splice(householdIdx, 0, newMember);
      } else {
        familyMembers.push(newMember);
      }

      saveData();
      closeAddMemberSheet();
      renderBubbles();
    }

    // ========================================
    // PROFILE SHEET
    // ========================================
    function openProfileSheet(member) {
      closeAllMenus();

      document.getElementById('profileSheetTitle').textContent = `${member.name}'s Profile`;

      const memberItems = feedItems.filter(item => item.memberId === member.id);
      const appointments = memberItems.filter(i => i.type === 'appointment').length;
      const rosters = memberItems.filter(i => i.type === 'roster').length;
      const milestones = memberItems.filter(i => i.type === 'milestone').length;
      const goals = memberItems.filter(i => i.type === 'goal').length;

      const avatarContent = member.photo
        ? `<img src="${member.photo}" alt="${member.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
        : member.icon;

      let statsHtml = `
        <div class="profile-header">
          <div class="profile-avatar type-${member.role}">${avatarContent}</div>
          <div class="profile-info">
            <h2>${member.name}</h2>
            <div class="profile-role">${member.role}</div>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Stats</div>
          <div class="profile-item">
            <span class="profile-item-label">Appointments</span>
            <span class="profile-item-value">${appointments}</span>
          </div>
      `;

      if (member.role === 'adult') {
        statsHtml += `
          <div class="profile-item">
            <span class="profile-item-label">Roster Entries</span>
            <span class="profile-item-value">${rosters}</span>
          </div>
        `;
      }

      if (member.role === 'child') {
        statsHtml += `
          <div class="profile-item">
            <span class="profile-item-label">Milestones</span>
            <span class="profile-item-value">${milestones}</span>
          </div>
        `;
      }

      statsHtml += `
          <div class="profile-item">
            <span class="profile-item-label">Goals</span>
            <span class="profile-item-value">${goals}</span>
          </div>
        </div>
      `;

      // Show recent items
      if (memberItems.length > 0) {
        const recent = memberItems.slice(0, 3);
        statsHtml += `
          <div class="profile-section">
            <div class="profile-section-title">Recent Items</div>
            ${recent.map(item => `
              <div class="profile-item">
                <span class="profile-item-label">${item.title}</span>
                <span class="profile-item-value text-muted">${item.type}</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      document.getElementById('profileSheetContent').innerHTML = statsHtml;
      openModal('profileSheet');
    }

    // ========================================
    // MODAL MANAGEMENT
    // ========================================
    function openModal(sheetId) {
      // Close all other modals first
      document.querySelectorAll('.modal-sheet, .bottom-sheet').forEach(sheet => {
        sheet.classList.remove('open');
      });
      document.getElementById('modalOverlay').classList.add('open');
      document.getElementById(sheetId).classList.add('open');
    }

    function closeAllModals() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.querySelectorAll('.modal-sheet, .bottom-sheet').forEach(sheet => {
        sheet.classList.remove('open');
      });
      closeFabMenu();
    }

    function closeProfileSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('profileSheet').classList.remove('open');
    }

    function closeFormSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('formSheet').classList.remove('open');
      currentFormMember = null;
      currentFormType = null;
    }

    function closeAddMemberSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('addMemberSheet').classList.remove('open');
    }

    function openSettings() {
      openModal('settingsSheet');
    }

    function closeSettings() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('settingsSheet').classList.remove('open');
    }

    // Dark Mode Functions
    function toggleDarkMode() {
      const isDark = document.getElementById('darkModeToggle').checked;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      localStorage.setItem('LIFE_DARK_MODE', isDark ? 'true' : 'false');
    }

    function initDarkMode() {
      const savedPref = localStorage.getItem('LIFE_DARK_MODE');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedPref === 'true' || (savedPref === null && prefersDark);

      if (isDark) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('darkModeToggle').checked = true;
      }
    }

    // Notification Functions
    let notificationTimers = [];

    async function toggleNotifications() {
      const toggle = document.getElementById('notificationToggle');
      const status = document.getElementById('notificationStatus');

      if (toggle.checked) {
        // Request permission
        if (!('Notification' in window)) {
          status.textContent = 'Not supported in this browser';
          toggle.checked = false;
          return;
        }

        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
          localStorage.setItem('LIFE_NOTIFICATIONS', 'true');
          status.textContent = 'Notifications enabled ';
          scheduleNotifications();
        } else {
          toggle.checked = false;
          status.textContent = 'Permission denied';
        }
      } else {
        localStorage.setItem('LIFE_NOTIFICATIONS', 'false');
        status.textContent = 'Remind me before appointments';
        clearScheduledNotifications();
      }
    }

    function initNotifications() {
      const enabled = localStorage.getItem('LIFE_NOTIFICATIONS') === 'true';
      const toggle = document.getElementById('notificationToggle');
      const status = document.getElementById('notificationStatus');

      if (enabled && Notification.permission === 'granted') {
        toggle.checked = true;
        status.textContent = 'Notifications enabled ';
        scheduleNotifications();
      } else if (enabled && Notification.permission !== 'granted') {
        localStorage.setItem('LIFE_NOTIFICATIONS', 'false');
      }
    }

    function scheduleNotifications() {
      clearScheduledNotifications();

      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];

      // Find appointments for today and tomorrow
      const upcomingItems = feedItems.filter(item => {
        if (item.type !== 'appointment' || !item.date || !item.time) return false;
        const itemDate = new Date(item.date + 'T' + item.time);
        const diffMs = itemDate - now;
        // Within next 24 hours
        return diffMs > 0 && diffMs < 24 * 60 * 60 * 1000;
      });

      upcomingItems.forEach(item => {
        const itemDate = new Date(item.date + 'T' + item.time);
        const member = getMemberById(item.memberId);

        // Schedule 1 hour before
        const oneHourBefore = itemDate.getTime() - (60 * 60 * 1000);
        const msUntilOneHour = oneHourBefore - now.getTime();

        if (msUntilOneHour > 0) {
          const timer = setTimeout(() => {
            showNotification(
              `${item.title} in 1 hour`,
              `${member?.name || 'Appointment'} at ${formatTime(item.time)}${item.location ? ' - ' + item.location : ''}`
            );
          }, msUntilOneHour);
          notificationTimers.push(timer);
        }

        // Schedule 15 minutes before
        const fifteenMinBefore = itemDate.getTime() - (15 * 60 * 1000);
        const msUntilFifteen = fifteenMinBefore - now.getTime();

        if (msUntilFifteen > 0) {
          const timer = setTimeout(() => {
            showNotification(
              `${item.title} in 15 minutes!`,
              `Time to go! ${item.location ? ' ' + item.location : ''}`
            );
          }, msUntilFifteen);
          notificationTimers.push(timer);
        }
      });
    }

    function clearScheduledNotifications() {
      notificationTimers.forEach(timer => clearTimeout(timer));
      notificationTimers = [];
    }

    function showNotification(title, body) {
      if (Notification.permission === 'granted') {
        const notification = new Notification(title, {
          body: body,
          icon: '',
          badge: '',
          tag: 'life-reminder',
          requireInteraction: true
        });

        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    // ========================================
    // CALENDAR VIEW FUNCTIONS
    // ========================================
    let currentCalendarYear = new Date().getFullYear();
    let currentCalendarMonth = new Date().getMonth();
    let selectedCalendarDate = null;
    let calendarVisible = false;

    function toggleCalendarView() {
      // Close other views first
      if (shoppingVisible) toggleShoppingView();
      if (mealPlannerVisible) toggleMealPlannerView();
      if (adhdTaskViewVisible) toggleAdhdTaskView();

      calendarVisible = !calendarVisible;
      const calendarView = document.getElementById('calendarView');
      const calendarBtn = document.getElementById('calendarToggleBtn');

      if (calendarVisible) {
        calendarView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        calendarBtn.innerHTML = '';
        calendarBtn.title = 'Show Feed';
        calendarBtn.style.background = 'var(--adult)';
        calendarBtn.style.color = 'white';
        renderCalendar();
      } else {
        calendarView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        calendarBtn.innerHTML = '';
        calendarBtn.title = 'Calendar View';
        calendarBtn.style.background = '';
        calendarBtn.style.color = '';
      }
    }

    function renderCalendar() {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      // Update title
      document.getElementById('calendarMonthTitle').textContent =
        `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // Get first day of month and total days
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
      const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
      const totalDays = lastDay.getDate();

      // Get day of week for first day (0=Sun, adjust for Mon start)
      let startDayOfWeek = firstDay.getDay();
      startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1; // Convert to Mon=0

      // Today's date for highlighting
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      // Add empty cells for days before first of month
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        grid.appendChild(emptyDay);
      }

      // Add days of month
      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;

        // Check if today
        if (dateStr === todayStr) {
          dayEl.classList.add('today');
        }

        // Check if selected
        if (dateStr === selectedCalendarDate) {
          dayEl.classList.add('selected');
        }

        // Check if has events
        const events = getEventsForDate(dateStr);
        if (events.length > 0) {
          dayEl.classList.add('has-events');
          // Add event type indicator
          const hasAppointment = events.some(e => e.type === 'appointment');
          const hasTask = events.some(e => e.type === 'task' || e.type === 'prep');
          if (hasAppointment) dayEl.classList.add('has-appointment');
          if (hasTask) dayEl.classList.add('has-task');
        }

        dayEl.onclick = () => selectDay(dateStr);
        grid.appendChild(dayEl);
      }

      // Clear day detail if no date selected
      if (!selectedCalendarDate) {
        document.getElementById('calendarDayDetail').innerHTML = '';
      }
    }

    function changeMonth(delta) {
      currentCalendarMonth += delta;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      selectedCalendarDate = null;
      renderCalendar();
    }

    function selectDay(dateStr) {
      selectedCalendarDate = dateStr;
      renderCalendar();

      const events = getEventsForDate(dateStr);
      const detailEl = document.getElementById('calendarDayDetail');

      // Format date for display
      const dateObj = new Date(dateStr + 'T00:00:00');
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      const formattedDate = dateObj.toLocaleDateString('en-AU', options);

      if (events.length === 0) {
        detailEl.innerHTML = `
          <div class="calendar-detail-header">
            <h4>${formattedDate}</h4>
          </div>
          <div class="calendar-no-events">No events scheduled</div>
        `;
      } else {
        detailEl.innerHTML = `
          <div class="calendar-detail-header">
            <h4>${formattedDate}</h4>
            <span class="calendar-event-count">${events.length} event${events.length > 1 ? 's' : ''}</span>
          </div>
          <div class="calendar-events-list">
            ${events.map(event => {
              const member = getMemberById(event.memberId);
              const timeStr = event.time ? formatTime(event.time) : '';
              const typeIcon = event.type === 'appointment' ? '' : event.type === 'prep' ? '' : '';
              return `
                <div class="calendar-event-item ${event.type}">
                  <div class="calendar-event-icon">${typeIcon}</div>
                  <div class="calendar-event-content">
                    <div class="calendar-event-title">${event.title}</div>
                    <div class="calendar-event-meta">
                      ${timeStr ? `<span>${timeStr}</span>` : ''}
                      ${member ? `<span>${member.icon} ${member.name}</span>` : ''}
                      ${event.location ? `<span> ${event.location}</span>` : ''}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
    }

    function getEventsForDate(dateStr) {
      return feedItems.filter(item => {
        if (!item.date) return false;
        return item.date === dateStr;
      }).sort((a, b) => {
        // Sort by time
        if (a.time && b.time) return a.time.localeCompare(b.time);
        if (a.time) return -1;
        if (b.time) return 1;
        return 0;
      });
    }

    // ========================================
    // SHOPPING LIST FUNCTIONS
    // ========================================
    let shoppingItems = JSON.parse(localStorage.getItem('life_shopping') || '[]');
    let shoppingVisible = false;

    const categoryInfo = {
      produce: { icon: '', name: 'Produce' },
      dairy: { icon: '', name: 'Dairy' },
      meat: { icon: '', name: 'Meat' },
      bakery: { icon: '', name: 'Bakery' },
      pantry: { icon: '', name: 'Pantry' },
      frozen: { icon: '', name: 'Frozen' },
      drinks: { icon: '', name: 'Drinks' },
      household: { icon: '', name: 'Household' },
      other: { icon: '', name: 'Other' }
    };

    function toggleShoppingView() {
      // Close other views first
      if (calendarVisible) toggleCalendarView();
      if (mealPlannerVisible) toggleMealPlannerView();
      if (adhdTaskViewVisible) toggleAdhdTaskView();

      shoppingVisible = !shoppingVisible;
      const shoppingView = document.getElementById('shoppingView');
      const shoppingBtn = document.getElementById('shoppingToggleBtn');

      if (shoppingVisible) {
        shoppingView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        shoppingBtn.style.background = 'var(--adult)';
        shoppingBtn.style.color = 'white';
        renderShoppingList();
      } else {
        shoppingView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        shoppingBtn.style.background = '';
        shoppingBtn.style.color = '';
      }
    }

    function renderShoppingList() {
      const container = document.getElementById('shoppingCategories');

      if (shoppingItems.length === 0) {
        container.innerHTML = `
          <div class="shopping-empty">
            <div class="shopping-empty-icon"></div>
            <div>Your shopping list is empty</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">Add items above or generate from meal plans</div>
          </div>
        `;
        updateShoppingSummary();
        return;
      }

      // Group items by category
      const grouped = {};
      shoppingItems.forEach(item => {
        if (!grouped[item.category]) grouped[item.category] = [];
        grouped[item.category].push(item);
      });

      // Render categories in order
      const categoryOrder = ['produce', 'dairy', 'meat', 'bakery', 'pantry', 'frozen', 'drinks', 'household', 'other'];
      let html = '';

      categoryOrder.forEach(cat => {
        if (!grouped[cat] || grouped[cat].length === 0) return;

        const info = categoryInfo[cat];
        const items = grouped[cat];

        html += `
          <div class="shopping-category">
            <div class="shopping-category-header">
              <span class="shopping-category-icon">${info.icon}</span>
              <span>${info.name}</span>
              <span style="color: var(--text-muted); font-weight: normal;">(${items.length})</span>
            </div>
            ${items.map(item => `
              <div class="shopping-item ${item.completed ? 'completed' : ''}" data-id="${item.id}">
                <div class="shopping-checkbox ${item.completed ? 'checked' : ''}" onclick="toggleShoppingItem('${item.id}')">
                  ${item.completed ? '' : ''}
                </div>
                <span class="shopping-item-name">${item.name}</span>
                <button class="shopping-item-delete" onclick="deleteShoppingItem('${item.id}')"></button>
              </div>
            `).join('')}
          </div>
        `;
      });

      container.innerHTML = html;
      updateShoppingSummary();
    }

    function updateShoppingSummary() {
      const total = shoppingItems.length;
      const completed = shoppingItems.filter(i => i.completed).length;
      document.querySelector('.shopping-count').textContent = `${total} item${total !== 1 ? 's' : ''}`;
      document.querySelector('.shopping-completed').textContent = `${completed} completed`;
    }

    function addShoppingItem() {
      const input = document.getElementById('shoppingInput');
      const category = document.getElementById('shoppingCategory').value;
      const name = input.value.trim();

      if (!name) return;

      const newItem = {
        id: 'shop_' + Date.now(),
        name: name,
        category: category,
        completed: false,
        createdAt: new Date().toISOString()
      };

      shoppingItems.push(newItem);
      saveShoppingList();
      renderShoppingList();
      input.value = '';
      input.focus();
    }

    function handleShoppingKeypress(event) {
      if (event.key === 'Enter') {
        addShoppingItem();
      }
    }

    function toggleShoppingItem(id) {
      const item = shoppingItems.find(i => i.id === id);
      if (item) {
        item.completed = !item.completed;
        saveShoppingList();
        renderShoppingList();
      }
    }

    function deleteShoppingItem(id) {
      shoppingItems = shoppingItems.filter(i => i.id !== id);
      saveShoppingList();
      renderShoppingList();
    }

    function clearCompletedItems() {
      const completed = shoppingItems.filter(i => i.completed).length;
      if (completed === 0) {
        alert('No completed items to clear');
        return;
      }
      if (confirm(`Clear ${completed} completed item${completed !== 1 ? 's' : ''}?`)) {
        shoppingItems = shoppingItems.filter(i => !i.completed);
        saveShoppingList();
        renderShoppingList();
      }
    }

    function saveShoppingList() {
      localStorage.setItem('life_shopping', JSON.stringify(shoppingItems));
    }

    // ========================================
    // PRICE COMPARISON & EXPORT
    // ========================================
    async function comparePrices() {
      if (shoppingItems.length === 0) {
        alert('Add items to your shopping list first!');
        return;
      }

      openModal('priceCompareSheet');
      document.getElementById('priceLoading').style.display = 'block';
      document.getElementById('priceResults').style.display = 'none';

      try {
        // Try API call first (Perplexity integration)
        const response = await fetch('/api/prices/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: shoppingItems.filter(i => !i.completed).map(i => i.name),
            stores: mealPreferences?.stores || ['woolworths', 'coles']
          })
        });

        if (response.ok) {
          const data = await response.json();
          renderPriceResults(data);
        } else {
          renderMockPriceResults();
        }
      } catch (error) {
        console.error('Price comparison failed:', error);
        renderMockPriceResults();
      }
    }

    function renderMockPriceResults() {
      // Generate mock price data for demo
      const items = shoppingItems.filter(i => !i.completed);
      const stores = [
        { id: 'woolworths', name: 'Woolworths', letter: 'W' },
        { id: 'coles', name: 'Coles', letter: 'C' },
        { id: 'aldi', name: 'Aldi', letter: 'A' },
        { id: 'costco', name: 'Costco', letter: 'Co' }
      ].filter(s => (mealPreferences?.stores || ['woolworths', 'coles']).includes(s.id));

      const results = stores.map(store => {
        const storeItems = items.map(item => ({
          name: item.name,
          price: (Math.random() * 8 + 2).toFixed(2),
          onSpecial: Math.random() > 0.7
        }));
        const total = storeItems.reduce((sum, i) => sum + parseFloat(i.price), 0);
        return { ...store, items: storeItems, total: total.toFixed(2) };
      });

      // Sort by total price
      results.sort((a, b) => parseFloat(a.total) - parseFloat(b.total));
      results[0].cheapest = true;

      renderPriceResults({ stores: results });
    }

    function renderPriceResults(data) {
      document.getElementById('priceLoading').style.display = 'none';
      const container = document.getElementById('priceResults');
      container.style.display = 'block';

      container.innerHTML = data.stores.map(store => `
        <div class="price-store-card">
          <div class="price-store-header">
            <div class="store-logo ${store.id}">${store.letter}</div>
            <div class="store-name">${store.name}</div>
            ${store.cheapest ? '<span class="price-store-badge">CHEAPEST</span>' : ''}
            <div class="price-store-total">$${store.total}</div>
          </div>
          ${store.items.map(item => `
            <div class="price-item-row">
              <span class="price-item-name">${item.name}</span>
              <span class="price-item-price ${item.onSpecial ? 'on-special' : ''}">
                $${item.price} ${item.onSpecial ? '' : ''}
              </span>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    function closePriceCompare() {
      document.getElementById('priceCompareSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function openExportOptions() {
      if (shoppingItems.length === 0) {
        alert('Add items to your shopping list first!');
        return;
      }
      openModal('exportSheet');
      document.getElementById('exportPreview').style.display = 'none';
    }

    function closeExportSheet() {
      document.getElementById('exportSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function exportForStore(storeName) {
      const items = shoppingItems.filter(i => !i.completed);
      let text = `Shopping List for ${storeName.charAt(0).toUpperCase() + storeName.slice(1)}:\n\n`;
      items.forEach(item => {
        text += ` ${item.name}\n`;
      });
      text += `\n---\nGenerated by Life Assistant`;
      showExportPreview(text);
    }

    function exportForApp(appName) {
      const items = shoppingItems.filter(i => !i.completed);
      let text = '';

      if (appName === 'doordash' || appName === 'ubereats') {
        text = items.map(i => i.name).join('\n');
        text += '\n\n(Copy each item to search in the app)';
      }

      showExportPreview(text);
    }

    function exportPlainText() {
      const items = shoppingItems.filter(i => !i.completed);
      const grouped = {};

      items.forEach(item => {
        if (!grouped[item.category]) grouped[item.category] = [];
        grouped[item.category].push(item.name);
      });

      let text = 'SHOPPING LIST\n';
      text += '='.repeat(20) + '\n\n';

      Object.keys(grouped).forEach(cat => {
        const info = categoryInfo[cat] || { icon: '', name: cat };
        text += `${info.icon} ${info.name.toUpperCase()}\n`;
        grouped[cat].forEach(item => {
          text += `   ${item}\n`;
        });
        text += '\n';
      });

      showExportPreview(text);
    }

    function showExportPreview(text) {
      document.getElementById('exportPreview').style.display = 'block';
      document.getElementById('exportText').value = text;
    }

    function copyExportText() {
      const text = document.getElementById('exportText').value;
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        document.getElementById('exportText').select();
        document.execCommand('copy');
        alert('Copied to clipboard!');
      });
    }

    // ========================================
    // MEAL PLANNER FUNCTIONS
    // ========================================
    let mealPlan = JSON.parse(localStorage.getItem('life_meals') || '{}');
    let mealPlannerVisible = false;
    let mealWeekOffset = 0;

    // Meal Preferences Data
    let mealPreferences = JSON.parse(localStorage.getItem('life_meal_prefs') || JSON.stringify({
      dislikes: [],
      diet: 'none',
      budget: 150,
      servings: 4,
      maxIngredients: 7,
      mealsPerDay: 3,
      stores: ['woolworths', 'coles']
    }));

    const INGREDIENT_OPTIONS = {
      veggies: ['Onion', 'Garlic', 'Capsicum', 'Mushrooms', 'Tomato', 'Spinach', 'Broccoli', 'Carrot', 'Zucchini', 'Eggplant', 'Celery', 'Peas', 'Corn', 'Beans', 'Cabbage', 'Cauliflower', 'Asparagus', 'Kale'],
      spices: ['Coriander', 'Cumin', 'Chilli', 'Ginger', 'Turmeric', 'Paprika', 'Oregano', 'Basil', 'Thyme', 'Rosemary', 'Cinnamon', 'Nutmeg', 'Curry', 'Fennel'],
      proteins: ['Beef', 'Pork', 'Lamb', 'Chicken', 'Fish', 'Prawns', 'Tofu', 'Eggs', 'Bacon', 'Sausages'],
      dairy: ['Milk', 'Cheese', 'Cream', 'Yoghurt', 'Butter', 'Sour Cream']
    };

    const DIET_OPTIONS = [
      { id: 'none', icon: '', title: 'No Restrictions', desc: 'All foods welcome' },
      { id: 'vegetarian', icon: '', title: 'Vegetarian', desc: 'No meat or fish' },
      { id: 'vegan', icon: '', title: 'Vegan', desc: 'No animal products' },
      { id: 'keto', icon: '', title: 'Keto', desc: 'Low carb, high fat' },
      { id: 'glutenfree', icon: '', title: 'Gluten-Free', desc: 'No wheat, barley, rye' },
      { id: 'dairyfree', icon: '', title: 'Dairy-Free', desc: 'No milk products' },
      { id: 'halal', icon: '', title: 'Halal', desc: 'Islamic dietary laws' },
      { id: 'kosher', icon: '', title: 'Kosher', desc: 'Jewish dietary laws' }
    ];

    const STORE_OPTIONS = [
      { id: 'woolworths', name: 'Woolworths', letter: 'W' },
      { id: 'coles', name: 'Coles', letter: 'C' },
      { id: 'aldi', name: 'Aldi', letter: 'A' },
      { id: 'costco', name: 'Costco', letter: 'Co' }
    ];

    function openMealPreferences() {
      openModal('mealPreferencesSheet');
      renderMealPreferences();
    }

    function closeMealPreferences() {
      document.getElementById('mealPreferencesSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function renderMealPreferences() {
      // Render dislikes chips
      ['veggies', 'spices', 'proteins', 'dairy'].forEach(category => {
        const container = document.getElementById(`dislikes${category.charAt(0).toUpperCase() + category.slice(1)}`);
        container.innerHTML = INGREDIENT_OPTIONS[category].map(item => `
          <div class="pref-chip ${mealPreferences.dislikes.includes(item) ? 'selected' : ''}"
               onclick="toggleDislike('${item}')">
            ${item}
          </div>
        `).join('');
      });

      // Render diet options
      const dietContainer = document.getElementById('dietOptions');
      dietContainer.innerHTML = DIET_OPTIONS.map(opt => `
        <div class="pref-option ${mealPreferences.diet === opt.id ? 'selected' : ''}"
             onclick="selectDiet('${opt.id}')">
          <div class="pref-option-icon">${opt.icon}</div>
          <div class="pref-option-text">
            <div class="pref-option-title">${opt.title}</div>
            <div class="pref-option-desc">${opt.desc}</div>
          </div>
          ${mealPreferences.diet === opt.id ? '<span class="store-check"></span>' : ''}
        </div>
      `).join('');

      // Render store options
      const storeContainer = document.getElementById('storeOptions');
      storeContainer.innerHTML = STORE_OPTIONS.map(store => `
        <div class="store-option ${mealPreferences.stores.includes(store.id) ? 'selected' : ''}"
             onclick="toggleStore('${store.id}')">
          <div class="store-logo ${store.id}">${store.letter}</div>
          <div class="store-name">${store.name}</div>
          ${mealPreferences.stores.includes(store.id) ? '<span class="store-check"></span>' : ''}
        </div>
      `).join('');

      // Update settings values
      document.getElementById('mealBudget').value = mealPreferences.budget;
      document.getElementById('servingsValue').textContent = mealPreferences.servings;
      document.getElementById('maxIngredientsValue').textContent = mealPreferences.maxIngredients;
      document.getElementById('mealsPerDayValue').textContent = mealPreferences.mealsPerDay;
    }

    function switchPrefTab(tabName) {
      document.querySelectorAll('.pref-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.pref-panel').forEach(p => p.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`pref${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    }

    function toggleDislike(item) {
      const idx = mealPreferences.dislikes.indexOf(item);
      if (idx > -1) {
        mealPreferences.dislikes.splice(idx, 1);
      } else {
        mealPreferences.dislikes.push(item);
      }
      renderMealPreferences();
    }

    function selectDiet(dietId) {
      mealPreferences.diet = dietId;
      renderMealPreferences();
    }

    function toggleStore(storeId) {
      const idx = mealPreferences.stores.indexOf(storeId);
      if (idx > -1) {
        mealPreferences.stores.splice(idx, 1);
      } else {
        mealPreferences.stores.push(storeId);
      }
      renderMealPreferences();
    }

    function adjustSetting(setting, delta) {
      const limits = {
        servings: { min: 1, max: 10 },
        maxIngredients: { min: 3, max: 15 },
        mealsPerDay: { min: 1, max: 5 }
      };

      mealPreferences[setting] = Math.min(limits[setting].max,
        Math.max(limits[setting].min, mealPreferences[setting] + delta));

      document.getElementById(`${setting}Value`).textContent = mealPreferences[setting];
    }

    function saveMealPreferences() {
      mealPreferences.budget = parseInt(document.getElementById('mealBudget').value) || 150;
      localStorage.setItem('life_meal_prefs', JSON.stringify(mealPreferences));
      closeMealPreferences();
      alert('Preferences saved!');
    }

    // AI Meal Generation
    async function generateAIMeals() {
      const loadingHTML = `
        <div class="ai-loading-overlay" id="aiLoadingOverlay">
          <div class="ai-loading-card">
            <div class="ai-loading-spinner"></div>
            <h3>Creating Your Meal Plan</h3>
            <p>Considering your preferences...</p>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', loadingHTML);

      try {
        const prompt = buildMealPrompt();
        const response = await fetch('/api/meals/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, preferences: mealPreferences })
        });

        if (response.ok) {
          const data = await response.json();
          applyGeneratedMeals(data.meals);
        } else {
          // Fallback to local generation
          const meals = generateLocalMeals();
          applyGeneratedMeals(meals);
        }
      } catch (error) {
        console.error('AI meal generation failed:', error);
        const meals = generateLocalMeals();
        applyGeneratedMeals(meals);
      }

      document.getElementById('aiLoadingOverlay')?.remove();
    }

    function buildMealPrompt() {
      const prefs = mealPreferences;
      let prompt = `Generate a week of meals for a family with these requirements:\n`;
      prompt += `- Budget: $${prefs.budget}/week\n`;
      prompt += `- Servings per meal: ${prefs.servings}\n`;
      prompt += `- Max ingredients per meal: ${prefs.maxIngredients}\n`;
      if (prefs.diet !== 'none') prompt += `- Diet: ${prefs.diet}\n`;
      if (prefs.dislikes.length > 0) prompt += `- Avoid these ingredients: ${prefs.dislikes.join(', ')}\n`;
      return prompt;
    }

    function generateLocalMeals() {
      const mealDatabase = [
        { name: 'Spaghetti Bolognese', ingredients: ['Mince', 'Pasta', 'Tomatoes', 'Onion', 'Garlic'], tags: ['glutenfree-no'] },
        { name: 'Chicken Stir Fry', ingredients: ['Chicken', 'Rice', 'Capsicum', 'Broccoli', 'Soy Sauce'], tags: ['glutenfree-no', 'dairyfree'] },
        { name: 'Fish Tacos', ingredients: ['Fish', 'Tortillas', 'Cabbage', 'Lime', 'Avocado'], tags: ['dairyfree'] },
        { name: 'Veggie Curry', ingredients: ['Chickpeas', 'Coconut Milk', 'Spinach', 'Tomatoes', 'Curry'], tags: ['vegan', 'vegetarian', 'glutenfree', 'dairyfree'] },
        { name: 'Grilled Lamb Chops', ingredients: ['Lamb', 'Rosemary', 'Garlic', 'Potatoes', 'Beans'], tags: ['glutenfree', 'dairyfree', 'keto'] },
        { name: 'Salmon & Veggies', ingredients: ['Salmon', 'Asparagus', 'Lemon', 'Olive Oil'], tags: ['glutenfree', 'dairyfree', 'keto'] },
        { name: 'Beef Burgers', ingredients: ['Beef Mince', 'Buns', 'Lettuce', 'Tomato', 'Cheese'], tags: [] },
        { name: 'Chicken Schnitzel', ingredients: ['Chicken', 'Breadcrumbs', 'Eggs', 'Salad'], tags: [] },
        { name: 'Vegetable Soup', ingredients: ['Carrot', 'Celery', 'Potato', 'Onion', 'Stock'], tags: ['vegan', 'vegetarian', 'glutenfree', 'dairyfree'] },
        { name: 'Prawn Pasta', ingredients: ['Prawns', 'Pasta', 'Garlic', 'Chilli', 'Parsley'], tags: ['dairyfree'] },
        { name: 'Tofu Buddha Bowl', ingredients: ['Tofu', 'Rice', 'Edamame', 'Carrot', 'Avocado'], tags: ['vegan', 'vegetarian', 'glutenfree', 'dairyfree'] },
        { name: 'Roast Chicken', ingredients: ['Chicken', 'Potato', 'Carrot', 'Onion', 'Gravy'], tags: ['glutenfree', 'dairyfree'] },
        { name: 'Mushroom Risotto', ingredients: ['Rice', 'Mushrooms', 'Onion', 'Parmesan', 'Stock'], tags: ['vegetarian', 'glutenfree'] },
        { name: 'BBQ Pork Ribs', ingredients: ['Pork Ribs', 'BBQ Sauce', 'Coleslaw'], tags: ['glutenfree', 'dairyfree'] }
      ];

      // Filter based on preferences
      let filtered = mealDatabase.filter(meal => {
        // Check dislikes
        const hasDisliked = meal.ingredients.some(ing =>
          mealPreferences.dislikes.some(dis => ing.toLowerCase().includes(dis.toLowerCase()))
        );
        if (hasDisliked) return false;

        // Check diet
        if (mealPreferences.diet !== 'none') {
          if (mealPreferences.diet === 'vegetarian' && !meal.tags.includes('vegetarian')) return false;
          if (mealPreferences.diet === 'vegan' && !meal.tags.includes('vegan')) return false;
          if (mealPreferences.diet === 'keto' && !meal.tags.includes('keto')) return false;
          if (mealPreferences.diet === 'glutenfree' && !meal.tags.includes('glutenfree')) return false;
          if (mealPreferences.diet === 'dairyfree' && !meal.tags.includes('dairyfree')) return false;
        }

        return true;
      });

      if (filtered.length < 7) filtered = mealDatabase; // Fallback if too restrictive

      // Shuffle and pick 7 dinners
      const shuffled = filtered.sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 7).map((meal, i) => ({
        day: i,
        type: 'dinner',
        name: meal.name,
        ingredients: meal.ingredients
      }));
    }

    function applyGeneratedMeals(meals) {
      const weekDates = getWeekDates(mealWeekOffset);

      meals.forEach(meal => {
        const dateStr = weekDates[meal.day]?.dateStr;
        if (dateStr) {
          if (!mealPlan[dateStr]) mealPlan[dateStr] = {};
          mealPlan[dateStr][meal.type || 'dinner'] = {
            name: meal.name,
            ingredients: meal.ingredients || [],
            notes: ''
          };
        }
      });

      localStorage.setItem('life_meals', JSON.stringify(mealPlan));
      renderMealPlanner();
      alert('Meals generated! Check your weekly plan.');
    }

    function toggleMealPlannerView() {
      // Close other views first
      if (calendarVisible) toggleCalendarView();
      if (shoppingVisible) toggleShoppingView();
      if (adhdTaskViewVisible) toggleAdhdTaskView();

      mealPlannerVisible = !mealPlannerVisible;
      const mealView = document.getElementById('mealPlannerView');
      const mealBtn = document.getElementById('mealToggleBtn');

      if (mealPlannerVisible) {
        mealView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        mealBtn.style.background = 'var(--adult)';
        mealBtn.style.color = 'white';
        renderMealPlanner();
      } else {
        mealView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        mealBtn.style.background = '';
        mealBtn.style.color = '';
      }
    }

    // ========================================
    // MEAL IDEAS FUNCTIONALITY
    // ========================================
    let mealIdeas = [];
    let selectedMealIds = new Set();

    // Extended meal database with steps
    const MEAL_IDEAS_DATABASE = [
      {
        id: 1, name: 'Spaghetti Bolognese', emoji: '', time: '30 min', servings: 4,
        ingredients: ['500g beef mince', '400g spaghetti', '2 cans diced tomatoes', '1 onion', '3 garlic cloves', 'Italian herbs', 'Parmesan cheese'],
        steps: ['Dice onion and garlic, saut in olive oil until soft', 'Add mince and cook until browned', 'Add tomatoes and herbs, simmer 20 mins', 'Cook pasta according to packet', 'Serve with parmesan on top']
      },
      {
        id: 2, name: 'Chicken Stir Fry', emoji: '', time: '20 min', servings: 4,
        ingredients: ['500g chicken breast', '2 cups rice', '1 capsicum', '1 broccoli head', '3 tbsp soy sauce', '1 tbsp sesame oil', 'Ginger'],
        steps: ['Cook rice according to packet', 'Slice chicken into strips', 'Stir fry chicken until golden', 'Add vegetables and stir fry 3-4 mins', 'Add soy sauce and sesame oil, toss to coat']
      },
      {
        id: 3, name: 'Fish Tacos', emoji: '', time: '25 min', servings: 4,
        ingredients: ['400g white fish fillets', '8 small tortillas', '1/4 cabbage', '1 lime', '1 avocado', 'Sour cream', 'Coriander'],
        steps: ['Season fish with lime and spices', 'Pan fry fish until flaky', 'Shred cabbage finely', 'Warm tortillas', 'Assemble tacos with fish, cabbage, avocado, sour cream']
      },
      {
        id: 4, name: 'Veggie Curry', emoji: '', time: '35 min', servings: 4,
        ingredients: ['400g chickpeas', '400ml coconut milk', '2 cups spinach', '2 cans diced tomatoes', '2 tbsp curry paste', '1 onion', 'Rice'],
        steps: ['Saut onion until soft', 'Add curry paste and cook 1 min', 'Add chickpeas, tomatoes, coconut milk', 'Simmer 20 mins', 'Stir in spinach, serve with rice']
      },
      {
        id: 5, name: 'Grilled Lamb Chops', emoji: '', time: '25 min', servings: 4,
        ingredients: ['8 lamb chops', '500g baby potatoes', '200g green beans', 'Fresh rosemary', '4 garlic cloves', 'Olive oil', 'Lemon'],
        steps: ['Marinate lamb with rosemary, garlic, oil', 'Boil potatoes until tender', 'Grill lamb 4 mins each side', 'Steam beans until crisp-tender', 'Serve with lemon wedges']
      },
      {
        id: 6, name: 'Salmon & Veggies', emoji: '', time: '20 min', servings: 4,
        ingredients: ['4 salmon fillets', '1 bunch asparagus', '2 lemons', '4 tbsp olive oil', 'Fresh dill', 'Salt & pepper'],
        steps: ['Preheat oven to 200C', 'Place salmon and asparagus on tray', 'Drizzle with oil and lemon', 'Season and add dill', 'Bake 15 mins until salmon flakes']
      },
      {
        id: 7, name: 'Beef Burgers', emoji: '', time: '25 min', servings: 4,
        ingredients: ['500g beef mince', '4 burger buns', 'Lettuce', '2 tomatoes', '4 cheese slices', 'Pickles', 'Sauce of choice'],
        steps: ['Form mince into 4 patties', 'Season with salt and pepper', 'Grill or pan fry 4-5 mins each side', 'Toast buns lightly', 'Assemble with cheese, lettuce, tomato, pickles']
      },
      {
        id: 8, name: 'Mushroom Risotto', emoji: '', time: '40 min', servings: 4,
        ingredients: ['300g arborio rice', '400g mushrooms', '1L chicken stock', '1 onion', '100g parmesan', 'White wine', 'Butter'],
        steps: ['Saut onion in butter', 'Add mushrooms and cook until soft', 'Add rice and toast 2 mins', 'Add wine, then stock gradually', 'Stir constantly until creamy, fold in parmesan']
      }
    ];

    function switchMealTab(tab) {
      document.querySelectorAll('.meal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.meal-tab-content').forEach(c => c.classList.remove('active'));

      if (tab === 'ideas') {
        document.querySelector('.meal-tab:first-child').classList.add('active');
        document.getElementById('mealIdeasTab').classList.add('active');
      } else {
        document.querySelector('.meal-tab:last-child').classList.add('active');
        document.getElementById('mealWeeklyTab').classList.add('active');
      }
    }

    function generateMealIdeas() {
      // Show loading
      const grid = document.getElementById('mealIdeasGrid');
      grid.innerHTML = '<div class="meal-ideas-empty"><div class="ai-loading-spinner"></div><p>Generating meal ideas...</p></div>';

      // Simulate AI generation with timeout
      setTimeout(() => {
        // Filter based on preferences
        mealIdeas = MEAL_IDEAS_DATABASE.filter(meal => {
          const hasDisliked = meal.ingredients.some(ing =>
            mealPreferences.dislikes.some(dis => ing.toLowerCase().includes(dis.toLowerCase()))
          );
          return !hasDisliked;
        });

        // Shuffle and take 6
        mealIdeas = mealIdeas.sort(() => Math.random() - 0.5).slice(0, 6);
        selectedMealIds.clear();
        renderMealIdeasGrid();
      }, 1000);
    }

    function renderMealIdeasGrid() {
      const grid = document.getElementById('mealIdeasGrid');

      if (mealIdeas.length === 0) {
        grid.innerHTML = `
          <div class="meal-ideas-empty">
            <div class="meal-ideas-empty-icon"></div>
            <p>Tap "Generate Ideas" to get personalized meal suggestions!</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = mealIdeas.map(meal => `
        <div class="meal-idea-card ${selectedMealIds.has(meal.id) ? 'selected' : ''}"
             onclick="toggleMealSelection(${meal.id})"
             ondblclick="expandMealCard(${meal.id})">
          <div class="meal-idea-checkbox">${selectedMealIds.has(meal.id) ? '' : ''}</div>
          <div class="meal-idea-image">${meal.emoji}</div>
          <div class="meal-idea-content">
            <div class="meal-idea-name">${meal.name}</div>
            <div class="meal-idea-meta">${meal.time}  ${meal.servings} servings</div>
          </div>
        </div>
      `).join('');

      updateSelectionBar();
    }

    function toggleMealSelection(mealId) {
      if (selectedMealIds.has(mealId)) {
        selectedMealIds.delete(mealId);
      } else {
        selectedMealIds.add(mealId);
      }
      renderMealIdeasGrid();
    }

    function updateSelectionBar() {
      const bar = document.getElementById('mealSelectionBar');
      const count = selectedMealIds.size;

      if (count > 0) {
        bar.style.display = 'flex';
        document.getElementById('selectedMealCount').textContent = `${count} meal${count > 1 ? 's' : ''} selected`;
      } else {
        bar.style.display = 'none';
      }
    }

    function expandMealCard(mealId) {
      const meal = mealIdeas.find(m => m.id === mealId);
      if (!meal) return;

      document.getElementById('expandedMealTitle').textContent = meal.name;
      document.getElementById('expandedMealContent').innerHTML = `
        <div class="expanded-meal-image">${meal.emoji}</div>

        <div class="expanded-meal-section">
          <h4> Ingredients (${meal.ingredients.length})</h4>
          <div class="expanded-ingredient-list">
            ${meal.ingredients.map(ing => `<span class="expanded-ingredient">${ing}</span>`).join('')}
          </div>
        </div>

        <div class="expanded-meal-section">
          <h4> Steps</h4>
          <div class="expanded-steps-list">
            ${meal.steps.map((step, i) => `
              <div class="expanded-step">
                <div class="expanded-step-number">${i + 1}</div>
                <div class="expanded-step-text">${step}</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="expanded-meal-actions">
          <button class="smart-meal-btn ${selectedMealIds.has(mealId) ? '' : 'primary'}"
                  onclick="toggleMealSelection(${mealId}); closeExpandedMeal(); renderMealIdeasGrid();">
            ${selectedMealIds.has(mealId) ? ' Selected' : '+ Select This Meal'}
          </button>
        </div>
      `;

      openModal('expandedMealSheet');
    }

    function closeExpandedMeal() {
      document.getElementById('expandedMealSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function openIngredientReview() {
      const selectedMeals = mealIdeas.filter(m => selectedMealIds.has(m.id));
      const allIngredients = [];

      selectedMeals.forEach(meal => {
        meal.ingredients.forEach(ing => {
          if (!allIngredients.some(i => i.name === ing)) {
            allIngredients.push({ name: ing, checked: true, price: null });
          }
        });
      });

      const container = document.getElementById('ingredientReviewList');
      container.innerHTML = allIngredients.map((ing, i) => `
        <div class="ingredient-review-item">
          <input type="checkbox" id="ing_${i}" checked data-name="${ing.name}">
          <label class="ingredient-review-name" for="ing_${i}">${ing.name}</label>
          <span class="ingredient-review-price" id="price_${i}">--</span>
        </div>
      `).join('');

      openModal('ingredientReviewSheet');
    }

    function closeIngredientReview() {
      document.getElementById('ingredientReviewSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    async function addIngredientsWithPricing() {
      const checkboxes = document.querySelectorAll('#ingredientReviewList input[type="checkbox"]:checked');
      const quality = document.querySelector('input[name="quality"]:checked')?.value || 'standard';

      const ingredients = Array.from(checkboxes).map(cb => cb.dataset.name);

      // Show loading
      const btn = document.querySelector('#ingredientReviewSheet .form-submit');
      btn.textContent = ' Finding prices...';
      btn.disabled = true;

      // Simulate price lookup
      setTimeout(() => {
        const priceMultiplier = quality === 'budget' ? 0.7 : quality === 'premium' ? 1.4 : 1;
        let totalCost = 0;

        checkboxes.forEach((cb, i) => {
          const basePrice = (Math.random() * 6 + 2);
          const price = (basePrice * priceMultiplier).toFixed(2);
          totalCost += parseFloat(price);
          document.getElementById(`price_${i}`).textContent = `$${price}`;
        });

        // Add to shopping list
        ingredients.forEach(ing => {
          const newItem = {
            id: 'shop_' + Date.now() + Math.random(),
            name: ing,
            category: guessCategory(ing),
            completed: false,
            createdAt: new Date().toISOString()
          };
          shoppingItems.push(newItem);
        });

        saveShoppingList();

        btn.textContent = ` Added! Est. Total: $${totalCost.toFixed(2)}`;

        setTimeout(() => {
          closeIngredientReview();
          selectedMealIds.clear();
          renderMealIdeasGrid();
          btn.textContent = ' Find Best Prices & Add to List';
          btn.disabled = false;
          alert(`${ingredients.length} ingredients added to shopping list!\nEstimated total: $${totalCost.toFixed(2)}`);
        }, 1500);
      }, 1500);
    }

    function guessCategory(ingredient) {
      const lower = ingredient.toLowerCase();
      if (lower.includes('chicken') || lower.includes('beef') || lower.includes('pork') || lower.includes('lamb') || lower.includes('fish') || lower.includes('salmon') || lower.includes('prawn')) return 'meat';
      if (lower.includes('milk') || lower.includes('cheese') || lower.includes('cream') || lower.includes('butter') || lower.includes('parmesan')) return 'dairy';
      if (lower.includes('bread') || lower.includes('bun') || lower.includes('tortilla')) return 'bakery';
      if (lower.includes('rice') || lower.includes('pasta') || lower.includes('oil') || lower.includes('sauce') || lower.includes('stock')) return 'pantry';
      if (lower.includes('onion') || lower.includes('garlic') || lower.includes('tomato') || lower.includes('lettuce') || lower.includes('cabbage') || lower.includes('broccoli') || lower.includes('spinach') || lower.includes('mushroom') || lower.includes('potato') || lower.includes('capsicum') || lower.includes('avocado') || lower.includes('lime') || lower.includes('lemon') || lower.includes('asparagus') || lower.includes('bean') || lower.includes('herb') || lower.includes('coriander') || lower.includes('dill') || lower.includes('rosemary')) return 'produce';
      return 'other';
    }

    function getWeekDates(offset = 0) {
      const today = new Date();
      const currentDay = today.getDay();
      const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;

      const monday = new Date(today);
      monday.setDate(today.getDate() + mondayOffset + (offset * 7));

      const days = [];
      const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        days.push({
          name: dayNames[i],
          date: date,
          dateStr: date.toISOString().split('T')[0],
          isToday: date.toDateString() === today.toDateString()
        });
      }

      return days;
    }

    function renderMealPlanner() {
      const days = getWeekDates(mealWeekOffset);

      // Update week title
      const firstDay = days[0].date;
      const lastDay = days[6].date;
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      let title = '';
      if (mealWeekOffset === 0) {
        title = 'This Week';
      } else if (mealWeekOffset === 1) {
        title = 'Next Week';
      } else if (mealWeekOffset === -1) {
        title = 'Last Week';
      } else {
        title = `${monthNames[firstDay.getMonth()]} ${firstDay.getDate()} - ${monthNames[lastDay.getMonth()]} ${lastDay.getDate()}`;
      }
      document.getElementById('mealWeekTitle').textContent = title;

      // Render days
      const container = document.getElementById('mealDays');
      container.innerHTML = days.map((day, index) => {
        const meals = mealPlan[day.dateStr] || {};

        return `
          <div class="meal-day">
            <div class="meal-day-header ${day.isToday ? 'today' : ''}">
              <span class="meal-day-name">${day.name}</span>
              <span class="meal-day-date">${day.date.getDate()} ${monthNames[day.date.getMonth()]}</span>
            </div>
            <div class="meal-slots">
              ${renderMealSlot(day.dateStr, 'breakfast', meals.breakfast)}
              ${renderMealSlot(day.dateStr, 'lunch', meals.lunch)}
              ${renderMealSlot(day.dateStr, 'dinner', meals.dinner)}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderMealSlot(dateStr, type, meal) {
      const typeLabels = { breakfast: 'Brekky', lunch: 'Lunch', dinner: 'Dinner' };

      if (!meal) {
        return `
          <div class="meal-slot">
            <span class="meal-slot-type">${typeLabels[type]}</span>
            <div class="meal-slot-content">
              <span class="meal-slot-empty" onclick="openAddMealSheet('${dateStr}', '${type}')">+ Add meal</span>
            </div>
          </div>
        `;
      }

      return `
        <div class="meal-slot">
          <span class="meal-slot-type">${typeLabels[type]}</span>
          <div class="meal-slot-content">
            <div class="meal-slot-filled">
              <div>
                <div class="meal-slot-name">${meal.name}</div>
                ${meal.notes ? `<div class="meal-slot-notes">${meal.notes}</div>` : ''}
              </div>
              <div class="meal-slot-actions">
                <button class="meal-slot-btn" onclick="openAddMealSheet('${dateStr}', '${type}')" title="Edit"></button>
                <button class="meal-slot-btn" onclick="deleteMeal('${dateStr}', '${type}')" title="Remove"></button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function changeMealWeek(delta) {
      mealWeekOffset += delta;
      renderMealPlanner();
    }

    function openAddMealSheet(dateStr, type) {
      document.getElementById('mealDayIndex').value = dateStr;
      document.getElementById('mealType').value = type;

      const existingMeal = mealPlan[dateStr]?.[type];
      if (existingMeal) {
        document.getElementById('mealName').value = existingMeal.name || '';
        document.getElementById('mealIngredients').value = (existingMeal.ingredients || []).join('\n');
        document.getElementById('mealNotes').value = existingMeal.notes || '';
      } else {
        document.getElementById('mealName').value = '';
        document.getElementById('mealIngredients').value = '';
        document.getElementById('mealNotes').value = '';
      }

      openModal('addMealSheet');
    }

    function closeAddMealSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('addMealSheet').classList.remove('open');
    }

    function saveMeal() {
      const dateStr = document.getElementById('mealDayIndex').value;
      const type = document.getElementById('mealType').value;
      const name = document.getElementById('mealName').value.trim();
      const ingredientsText = document.getElementById('mealIngredients').value.trim();
      const notes = document.getElementById('mealNotes').value.trim();

      if (!name) {
        alert('Please enter a meal name');
        return;
      }

      const ingredients = ingredientsText
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

      if (!mealPlan[dateStr]) {
        mealPlan[dateStr] = {};
      }

      mealPlan[dateStr][type] = {
        name,
        ingredients,
        notes
      };

      saveMealPlan();
      closeAddMealSheet();
      renderMealPlanner();
    }

    function deleteMeal(dateStr, type) {
      if (mealPlan[dateStr] && mealPlan[dateStr][type]) {
        delete mealPlan[dateStr][type];
        if (Object.keys(mealPlan[dateStr]).length === 0) {
          delete mealPlan[dateStr];
        }
        saveMealPlan();
        renderMealPlanner();
      }
    }

    function saveMealPlan() {
      localStorage.setItem('life_meals', JSON.stringify(mealPlan));
    }

    function generateShoppingFromMeals() {
      const days = getWeekDates(mealWeekOffset);
      const ingredients = [];

      days.forEach(day => {
        const meals = mealPlan[day.dateStr] || {};
        ['breakfast', 'lunch', 'dinner'].forEach(type => {
          if (meals[type] && meals[type].ingredients) {
            meals[type].ingredients.forEach(ing => {
              if (!ingredients.includes(ing.toLowerCase())) {
                ingredients.push(ing);
              }
            });
          }
        });
      });

      if (ingredients.length === 0) {
        alert('No ingredients found in meal plan for this week');
        return;
      }

      // Add to shopping list (avoid duplicates)
      const existingNames = shoppingItems.map(i => i.name.toLowerCase());
      let added = 0;

      ingredients.forEach(ing => {
        if (!existingNames.includes(ing.toLowerCase())) {
          shoppingItems.push({
            id: 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            name: ing,
            category: 'other',
            completed: false,
            createdAt: new Date().toISOString()
          });
          added++;
        }
      });

      saveShoppingList();

      if (added > 0) {
        alert(`Added ${added} ingredient${added !== 1 ? 's' : ''} to shopping list`);
        toggleMealPlannerView();
        toggleShoppingView();
      } else {
        alert('All ingredients are already in your shopping list');
      }
    }

    function generateListFromMeals() {
      // Switch to meal planner to generate from there
      toggleShoppingView();
      toggleMealPlannerView();
    }

    // ========================================
    // ADHD TASK BREAKDOWN FUNCTIONS
    // ========================================
    let adhdTasks = JSON.parse(localStorage.getItem('life_adhd_tasks') || '[]');
    let adhdTaskViewVisible = false;
    let currentBreakdownTask = null;
    let clarificationQuestions = [];
    let clarificationAnswers = {};
    let currentQuestionIndex = 0;
    let currentFocusTask = null;
    let currentStepIndex = 0;
    let focusTimerInterval = null;
    let focusTimerSeconds = 300; // 5 minutes

    // Common ambiguous words and their clarification options
    const ambiguousTerms = {
      'clean': {
        question: 'What kind of cleaning do you mean?',
        options: [
          { value: 'tidy', label: ' Quick tidy up - put things away' },
          { value: 'deep', label: ' Deep clean - scrub and sanitize' },
          { value: 'declutter', label: ' Declutter - sort and remove items' },
          { value: 'organize', label: ' Organize - create systems' }
        ]
      },
      'organize': {
        question: 'What does organizing mean for this task?',
        options: [
          { value: 'sort', label: ' Sort into categories' },
          { value: 'label', label: ' Label and store properly' },
          { value: 'digital', label: ' Digital organization (files/apps)' },
          { value: 'schedule', label: ' Plan and schedule things' }
        ]
      },
      'fix': {
        question: 'What kind of fixing is needed?',
        options: [
          { value: 'repair', label: ' Physical repair' },
          { value: 'resolve', label: ' Resolve an issue/conflict' },
          { value: 'update', label: ' Update or improve' },
          { value: 'troubleshoot', label: ' Find and fix a problem' }
        ]
      },
      'sort': {
        question: 'How would you like to sort things?',
        options: [
          { value: 'keep_donate', label: ' Keep vs donate/trash' },
          { value: 'categorize', label: ' By category or type' },
          { value: 'priority', label: ' By priority/importance' },
          { value: 'alphabetical', label: ' Alphabetically or by date' }
        ]
      },
      'prepare': {
        question: 'What kind of preparation?',
        options: [
          { value: 'gather', label: ' Gather items/materials' },
          { value: 'plan', label: ' Create a plan' },
          { value: 'practice', label: ' Practice or rehearse' },
          { value: 'research', label: ' Research and learn' }
        ]
      },
      'do': {
        question: 'Can you be more specific about what you need to do?',
        options: [
          { value: 'complete', label: ' Complete a specific task' },
          { value: 'start', label: ' Start something new' },
          { value: 'continue', label: ' Continue something in progress' },
          { value: 'finish', label: ' Finish something almost done' }
        ]
      }
    };

    function toggleAdhdTaskView() {
      // Close other views first
      if (calendarVisible) toggleCalendarView();
      if (shoppingVisible) toggleShoppingView();
      if (mealPlannerVisible) toggleMealPlannerView();

      adhdTaskViewVisible = !adhdTaskViewVisible;
      const adhdView = document.getElementById('adhdTaskView');
      const adhdBtn = document.getElementById('adhdTaskToggleBtn');

      if (adhdTaskViewVisible) {
        adhdView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        adhdBtn.style.background = 'var(--adult)';
        adhdBtn.style.color = 'white';
        showAdhdInputSection();
        renderAdhdTaskList();
      } else {
        adhdView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        adhdBtn.style.background = '';
        adhdBtn.style.color = '';
      }
    }

    function showAdhdInputSection() {
      document.getElementById('adhdInputSection').style.display = 'block';
      document.getElementById('adhdClarifySection').style.display = 'none';
      document.getElementById('adhdFocusSection').style.display = 'none';
    }

    function renderAdhdTaskList() {
      const container = document.getElementById('adhdTaskList');
      const section = document.getElementById('adhdExistingTasks');

      if (adhdTasks.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';

      container.innerHTML = adhdTasks.map(task => {
        const completedSteps = task.steps.filter(s => s.completed).length;
        const totalSteps = task.steps.length;
        const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;
        const isCompleted = progress === 100;

        return `
          <div class="adhd-task-item ${isCompleted ? 'completed' : ''}" onclick="enterFocusMode('${task.id}')">
            <div class="adhd-task-progress-ring" style="--progress: ${progress}%">
              <div class="adhd-task-progress-inner">${progress}%</div>
            </div>
            <div class="adhd-task-info">
              <div class="adhd-task-name">${task.name}</div>
              <div class="adhd-task-meta">${completedSteps} of ${totalSteps} steps done</div>
            </div>
            <div class="adhd-task-actions" onclick="event.stopPropagation()">
              <button class="adhd-task-action-btn" onclick="deleteAdhdTask('${task.id}')" title="Delete"></button>
            </div>
          </div>
        `;
      }).join('');
    }

    function startTaskBreakdown() {
      const input = document.getElementById('adhdTaskInput');
      const taskText = input.value.trim();

      if (!taskText) {
        alert('Please enter a task first');
        return;
      }

      currentBreakdownTask = taskText;
      clarificationAnswers = {};
      clarificationQuestions = [];
      currentQuestionIndex = 0;

      // Check for ambiguous terms
      const lowerTask = taskText.toLowerCase();
      for (const [term, data] of Object.entries(ambiguousTerms)) {
        if (lowerTask.includes(term)) {
          clarificationQuestions.push({
            term,
            question: data.question,
            options: data.options
          });
        }
      }

      // If we have clarification questions, show them
      if (clarificationQuestions.length > 0) {
        showClarificationQuestion();
      } else {
        // No clarification needed, go straight to breakdown
        generateTaskBreakdown();
      }
    }

    function showClarificationQuestion() {
      document.getElementById('adhdInputSection').style.display = 'none';
      document.getElementById('adhdClarifySection').style.display = 'block';

      const q = clarificationQuestions[currentQuestionIndex];
      document.getElementById('clarifyQuestion').textContent = q.question;
      document.getElementById('clarifyProgress').textContent =
        `Question ${currentQuestionIndex + 1} of ${clarificationQuestions.length}`;

      const optionsContainer = document.getElementById('clarifyOptions');
      optionsContainer.innerHTML = q.options.map(opt => `
        <button class="adhd-clarify-option" onclick="selectClarificationOption('${q.term}', '${opt.value}', this)">
          ${opt.label}
        </button>
      `).join('');

      document.getElementById('clarifyCustomInput').value = '';
    }

    function selectClarificationOption(term, value, btn) {
      // Remove selected from siblings
      document.querySelectorAll('.adhd-clarify-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

      clarificationAnswers[term] = value;

      // Auto-advance after short delay
      setTimeout(() => {
        nextClarificationQuestion();
      }, 300);
    }

    function submitCustomClarification() {
      const input = document.getElementById('clarifyCustomInput');
      const value = input.value.trim();
      if (!value) return;

      const q = clarificationQuestions[currentQuestionIndex];
      clarificationAnswers[q.term] = value;
      nextClarificationQuestion();
    }

    function nextClarificationQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < clarificationQuestions.length) {
        showClarificationQuestion();
      } else {
        // All questions answered, generate breakdown
        generateTaskBreakdown();
      }
    }

    function cancelClarification() {
      showAdhdInputSection();
    }

    async function generateTaskBreakdown() {
      // Show loading modal
      openModal('adhdBreakdownSheet');
      document.getElementById('adhdLoading').style.display = 'block';
      document.getElementById('adhdBreakdownResult').style.display = 'none';

      // Build context from clarifications
      let context = currentBreakdownTask;
      if (Object.keys(clarificationAnswers).length > 0) {
        context += '\n\nClarifications:';
        for (const [term, value] of Object.entries(clarificationAnswers)) {
          context += `\n- "${term}" means: ${value}`;
        }
      }

      try {
        // Try AI-powered breakdown first
        const idToken = localStorage.getItem('google_id_token');
        let steps = [];

        if (idToken) {
          try {
            const response = await fetch('/api/tasks/breakdown', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}`
              },
              body: JSON.stringify({ task: context })
            });

            if (response.ok) {
              const data = await response.json();
              steps = data.steps || [];
            }
          } catch (e) {
            console.log('AI breakdown not available, using local fallback');
          }
        }

        // Fallback to local breakdown if AI didn't work
        if (steps.length === 0) {
          steps = generateLocalBreakdown(currentBreakdownTask, clarificationAnswers);
        }

        showBreakdownResult(steps);
      } catch (error) {
        console.error('Breakdown error:', error);
        const steps = generateLocalBreakdown(currentBreakdownTask, clarificationAnswers);
        showBreakdownResult(steps);
      }
    }

    function generateLocalBreakdown(task, clarifications) {
      // Smart context-aware breakdown
      const lowerTask = task.toLowerCase();
      let steps = [];

      // Extract potential person name from task
      const personMatch = task.match(/(?:get |help |prepare |ready |for )?(\b[A-Z][a-z]+\b)(?:'s| ready| prepared| for| to)/i);
      const personName = personMatch ? personMatch[1] : null;

      // Get clarification context
      const cleanType = clarifications['clean'] || 'tidy';
      const organizeType = clarifications['organize'] || 'sort';

      // ===== TRAVEL / TRIP PREPARATION =====
      if (lowerTask.includes('trip') || lowerTask.includes('travel') || lowerTask.includes('holiday') ||
          lowerTask.includes('vacation') || lowerTask.includes('ready for') &&
          (lowerTask.includes('china') || lowerTask.includes('overseas') || lowerTask.includes('flight') ||
           lowerTask.includes('airport') || lowerTask.includes('japan') || lowerTask.includes('europe') ||
           lowerTask.includes('usa') || lowerTask.includes('america') || lowerTask.includes('bali') ||
           lowerTask.includes('thailand') || lowerTask.includes('vietnam') || lowerTask.includes('uk') ||
           lowerTask.includes('new zealand') || lowerTask.includes('fiji'))) {

        const destination = task.match(/(?:to |for |going to )([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/)?.[1] || 'the trip';
        const traveler = personName || 'everyone';

        steps = [
          `Check passport validity for ${traveler} (must be valid 6+ months)`,
          `Research visa requirements for ${destination}`,
          `Book flights and save confirmation details`,
          `Arrange accommodation and save booking refs`,
          `Check vaccination requirements and book appointments if needed`,
          `Arrange travel insurance`,
          `Notify bank of travel dates to avoid card blocks`,
          `Create packing list based on ${destination} weather and activities`,
          `Arrange pet/house sitter if needed`,
          `Download offline maps and translation apps`,
          `Copy important documents (passport, insurance, bookings)`,
          `Check phone/data roaming or get local SIM plan`,
          `Pack bags (start 2-3 days before)`,
          `Confirm all bookings 24 hours before departure`
        ];
      }
      // ===== SCHOOL / KIDS PREPARATION =====
      else if (lowerTask.includes('school') || lowerTask.includes('back to school') ||
               lowerTask.includes('term') || lowerTask.includes('semester')) {
        const child = personName || 'the kids';
        steps = [
          `Check school supply list for ${child}`,
          `Go through existing supplies - what can be reused?`,
          `Make shopping list for items needed`,
          `Buy school supplies (do one store trip)`,
          `Check uniform - does it still fit?`,
          `Order/buy new uniform items if needed`,
          `Label all items with name`,
          `Set up homework station at home`,
          `Check school calendar for important dates`,
          `Update emergency contact info with school`,
          `Prepare school bag the night before`,
          `Reset bedtime routine 1 week before school starts`
        ];
      }
      // ===== EVENT / PARTY PLANNING =====
      else if (lowerTask.includes('party') || lowerTask.includes('birthday') ||
               lowerTask.includes('event') || lowerTask.includes('celebration')) {
        const celebrant = personName || 'the guest of honor';
        steps = [
          `Set a date and time for the event`,
          `Decide on budget`,
          `Create guest list`,
          `Choose venue (home or external)`,
          `Send invitations (give 2-3 weeks notice)`,
          `Plan menu/catering - order or make?`,
          `Order cake or plan to bake`,
          `Plan decorations and theme`,
          `Organize activities or entertainment`,
          `Buy/organize gift for ${celebrant}`,
          `Prep food that can be made ahead`,
          `Set up decorations day before`,
          `Confirm RSVPs and final numbers`,
          `Enjoy the celebration!`
        ];
      }
      // ===== MOVING HOUSE =====
      else if (lowerTask.includes('move') || lowerTask.includes('moving') ||
               lowerTask.includes('relocat') || lowerTask.includes('new house') || lowerTask.includes('new home')) {
        steps = [
          `Set moving date and book removalists (or truck)`,
          `Start decluttering - donate/sell what you don't need`,
          `Gather packing supplies (boxes, tape, markers)`,
          `Pack one room at a time, label boxes clearly`,
          `Redirect mail to new address`,
          `Transfer utilities (electricity, gas, internet)`,
          `Update address with bank, Medicare, license`,
          `Pack essentials box (toiletries, chargers, snacks, tools)`,
          `Deep clean old place or book cleaners`,
          `Do final walkthrough of old place`,
          `Supervise loading/unloading`,
          `Unpack essentials first (beds, kitchen, bathroom)`,
          `Gradually unpack other rooms over coming weeks`
        ];
      }
      // ===== APPOINTMENT PREPARATION =====
      else if (lowerTask.includes('appointment') || lowerTask.includes('doctor') ||
               lowerTask.includes('dentist') || lowerTask.includes('meeting')) {
        const who = personName || 'yourself';
        steps = [
          `Confirm appointment date, time, and location`,
          `Check what documents/ID you need to bring`,
          `Write down questions you want to ask`,
          `Check if fasting or other prep required`,
          `Set reminder for day before`,
          `Prepare ${who}'s Medicare/insurance details`,
          `Plan travel time (add buffer for parking/traffic)`,
          `Pack bag with everything needed`,
          `Set alarm to leave on time`,
          `After: Note down any follow-up actions`
        ];
      }
      // ===== CLEANING (with clarifications) =====
      else if (lowerTask.includes('clean')) {
        if (cleanType === 'deep') {
          steps = [
            'Gather all cleaning supplies (spray, cloths, mop)',
            'Clear surfaces of clutter first',
            'Start high - dust ceiling fans and light fixtures',
            'Wipe down walls and doors',
            'Clean windows and mirrors',
            'Deep clean kitchen (inside oven, fridge)',
            'Scrub bathroom thoroughly',
            'Vacuum all floors including under furniture',
            'Mop hard floors',
            'Wash all bedding and curtains',
            'Take out all rubbish and recycling'
          ];
        } else if (cleanType === 'declutter') {
          steps = [
            'Get 3 bags/boxes: Keep, Donate, Trash',
            'Pick ONE room or area to start',
            'Empty one drawer/shelf completely',
            'Sort items quickly - 5 second decisions',
            'Only keep things you use or truly love',
            'Put "Keep" items back neatly',
            'Bag up donations - put in car NOW',
            'Take trash out immediately',
            'Move to next area, repeat'
          ];
        } else {
          steps = [
            'Set a 15-minute timer',
            'Quick tidy - put things back where they belong',
            'Wipe down kitchen benches',
            'Wipe bathroom sink and toilet',
            'Spot clean any marks or spills',
            'Quick vacuum/sweep main areas',
            'Take out any full bins',
            'Fluff cushions and fold throws',
            'Done! Good enough is good enough!'
          ];
        }
      }
      // ===== TAX / FINANCIAL =====
      else if (lowerTask.includes('tax') || lowerTask.includes('finances') || lowerTask.includes('budget')) {
        steps = [
          'Gather all income statements (payslips, payment summaries)',
          'Collect receipts for deductions (work expenses, donations)',
          'Download statements from bank and super',
          'Log into myGov/ATO or open tax software',
          'Enter income details first (the easy part)',
          'Enter deductions one category at a time',
          'Double-check all numbers',
          'Review and submit (or save for accountant)',
          'Save/print confirmation for records',
          'Note any estimated tax refund/bill'
        ];
      }
      // ===== EMAIL / INBOX =====
      else if (lowerTask.includes('email') || lowerTask.includes('inbox')) {
        steps = [
          'Open inbox and sort by sender or date',
          'Delete/archive obvious junk and old newsletters',
          'Unsubscribe from 3 lists you never read',
          'Star/flag anything that needs action',
          'Reply to quick emails first (under 2 mins each)',
          'Schedule time for emails needing longer replies',
          'File emails you need to keep into folders',
          'Archive everything else older than 1 month',
          'Aim for inbox under 50 items'
        ];
      }
      // ===== COOKING / MEAL PREP =====
      else if (lowerTask.includes('cook') || lowerTask.includes('dinner') ||
               lowerTask.includes('meal prep') || lowerTask.includes('lunch')) {
        steps = [
          'Decide on recipe (keep it simple!)',
          'Check pantry - make list of missing ingredients',
          'Quick grocery shop if needed',
          'Read recipe fully before starting',
          'Get all ingredients and tools out first',
          'Preheat oven/boil water if needed',
          'Prep all vegetables and ingredients',
          'Follow recipe steps in order',
          'Set timers so nothing burns',
          'Clean as you go where possible',
          'Serve and enjoy your creation!'
        ];
      }
      // ===== EXERCISE / FITNESS =====
      else if (lowerTask.includes('exercise') || lowerTask.includes('workout') ||
               lowerTask.includes('gym') || lowerTask.includes('fitness')) {
        steps = [
          'Put on workout clothes (do it now!)',
          'Fill water bottle',
          'Choose workout: cardio, strength, or both?',
          'Set timer/start tracking app',
          'Warm up: 5 mins light movement',
          'Do main workout (start with 20-30 mins)',
          'Cool down: stretching for 5 mins',
          'Log your workout (builds motivation!)',
          'Hydrate and have protein snack',
          'Shower and feel accomplished!'
        ];
      }
      // ===== SHOPPING =====
      else if (lowerTask.includes('shopping') || lowerTask.includes('groceries') ||
               lowerTask.includes('buy') || lowerTask.includes('shop')) {
        steps = [
          'Check what you already have at home',
          'Write list organized by store section',
          'Check for coupons or sales',
          'Set a budget if needed',
          'Go to store at a quieter time',
          'Stick to the list (avoid impulse buys)',
          'Check items off as you get them',
          'Use self-checkout if faster',
          'Put cold items away first when home',
          'Done! Reward yourself with a cuppa'
        ];
      }
      // ===== WORK PROJECT =====
      else if (lowerTask.includes('project') || lowerTask.includes('presentation') ||
               lowerTask.includes('report') || lowerTask.includes('work')) {
        steps = [
          'Define the exact outcome/deliverable needed',
          'Break into smaller milestones',
          'List all information/resources needed',
          'Block focused time in calendar',
          'Start with easiest section to build momentum',
          'Draft rough version first (don\'t perfect yet)',
          'Review and improve key sections',
          'Get feedback if possible',
          'Final polish and formatting',
          'Submit/deliver and celebrate!'
        ];
      }
      // ===== STUDY / LEARNING =====
      else if (lowerTask.includes('study') || lowerTask.includes('exam') ||
               lowerTask.includes('learn') || lowerTask.includes('course')) {
        steps = [
          'Gather all study materials needed',
          'Clear study space of distractions',
          'Review syllabus/exam topics',
          'Break material into chunks',
          'Study one chunk at a time (25-min sessions)',
          'Take short breaks between sessions',
          'Test yourself with practice questions',
          'Review areas you got wrong',
          'Get enough sleep before exam',
          'Trust your preparation!'
        ];
      }
      // ===== GENERIC FALLBACK (but better) =====
      else {
        // Try to extract action and object from task
        const taskWords = task.split(' ');
        steps = [
          `Write down exactly what "done" looks like for: ${task}`,
          'List everything this task might involve',
          'Identify what you need to get started',
          'Pick the smallest first step you can do in 2 minutes',
          'Do that first step right now',
          'What naturally comes next? Do that.',
          'If stuck, ask: what would make this easier?',
          'Set a timer for 25 minutes of focused work',
          'Review progress and adjust approach if needed',
          'Keep going until complete or take a planned break'
        ];
      }

      return steps;
    }

    function showBreakdownResult(steps) {
      document.getElementById('adhdLoading').style.display = 'none';
      document.getElementById('adhdBreakdownResult').style.display = 'block';

      document.getElementById('breakdownSummary').innerHTML = `
        <h4> ${currentBreakdownTask}</h4>
        <p>I've broken this into ${steps.length} manageable steps. You've got this!</p>
      `;

      document.getElementById('breakdownSteps').innerHTML = steps.map((step, i) => `
        <div class="adhd-breakdown-step">
          <div class="adhd-breakdown-step-num">${i + 1}</div>
          <div class="adhd-breakdown-step-text">${step}</div>
        </div>
      `).join('');

      // Store for saving
      currentBreakdownTask = {
        name: currentBreakdownTask,
        steps: steps
      };
    }

    function saveTaskBreakdown() {
      const newTask = {
        id: 'adhd_' + Date.now(),
        name: typeof currentBreakdownTask === 'string' ? currentBreakdownTask : currentBreakdownTask.name,
        steps: (typeof currentBreakdownTask === 'object' ? currentBreakdownTask.steps : []).map((text, i) => ({
          id: i,
          text: text,
          completed: false
        })),
        createdAt: new Date().toISOString(),
        clarifications: { ...clarificationAnswers }
      };

      adhdTasks.unshift(newTask);
      saveAdhdTasks();

      // Close modal and reset
      closeAdhdBreakdownSheet();
      document.getElementById('adhdTaskInput').value = '';
      showAdhdInputSection();
      renderAdhdTaskList();

      // Enter focus mode for new task
      setTimeout(() => {
        enterFocusMode(newTask.id);
      }, 300);
    }

    function regenerateBreakdown() {
      if (typeof currentBreakdownTask === 'object') {
        currentBreakdownTask = currentBreakdownTask.name;
      }
      generateTaskBreakdown();
    }

    function closeAdhdBreakdownSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('adhdBreakdownSheet').classList.remove('open');
    }

    function deleteAdhdTask(taskId) {
      if (confirm('Delete this task and all its steps?')) {
        adhdTasks = adhdTasks.filter(t => t.id !== taskId);
        saveAdhdTasks();
        renderAdhdTaskList();
      }
    }

    function saveAdhdTasks() {
      localStorage.setItem('life_adhd_tasks', JSON.stringify(adhdTasks));
    }

    // ========================================
    // FOCUS MODE FUNCTIONS
    // ========================================
    function enterFocusMode(taskId) {
      currentFocusTask = adhdTasks.find(t => t.id === taskId);
      if (!currentFocusTask) return;

      // Find first incomplete step
      currentStepIndex = currentFocusTask.steps.findIndex(s => !s.completed);
      if (currentStepIndex === -1) currentStepIndex = 0;

      document.getElementById('adhdInputSection').style.display = 'none';
      document.getElementById('adhdClarifySection').style.display = 'none';
      document.getElementById('adhdFocusSection').style.display = 'flex';

      renderFocusMode();
    }

    function renderFocusMode() {
      if (!currentFocusTask) return;

      document.getElementById('focusTaskTitle').textContent = currentFocusTask.name;

      const currentStep = currentFocusTask.steps[currentStepIndex];
      document.getElementById('focusCurrentStep').textContent = currentStep ? currentStep.text : 'All done!';

      // Progress
      const completed = currentFocusTask.steps.filter(s => s.completed).length;
      const total = currentFocusTask.steps.length;
      const percent = Math.round((completed / total) * 100);

      document.getElementById('focusProgressBar').style.width = percent + '%';
      document.getElementById('focusProgressText').textContent = `Step ${currentStepIndex + 1} of ${total}`;

      // Show/hide timer based on step
      document.getElementById('focusTimer').style.display = 'block';

      // Render all steps list
      renderFocusStepsList();
    }

    function renderFocusStepsList() {
      const container = document.getElementById('focusStepsList');
      container.innerHTML = currentFocusTask.steps.map((step, i) => {
        let className = 'adhd-step-item';
        if (step.completed) className += ' completed';
        if (i === currentStepIndex && !step.completed) className += ' current';

        return `
          <div class="${className}">
            <div class="adhd-step-number">${step.completed ? '' : i + 1}</div>
            <span>${step.text}</span>
          </div>
        `;
      }).join('');
    }

    function completeCurrentStep() {
      if (!currentFocusTask) return;

      const step = currentFocusTask.steps[currentStepIndex];
      if (step) {
        step.completed = true;
        saveAdhdTasks();

        // Check if all done
        const allDone = currentFocusTask.steps.every(s => s.completed);
        if (allDone) {
          showCelebration('', 'Amazing! You completed the whole task!');
          setTimeout(() => {
            exitFocusMode();
          }, 2500);
        } else {
          // Mini celebration
          showCelebration('', getRandomPraise());

          // Move to next step
          currentStepIndex++;
          if (currentStepIndex >= currentFocusTask.steps.length) {
            currentStepIndex = currentFocusTask.steps.findIndex(s => !s.completed);
          }

          setTimeout(() => {
            hideCelebration();
            renderFocusMode();
          }, 1200);
        }
      }
    }

    function skipCurrentStep() {
      if (!currentFocusTask) return;

      // Find next incomplete step
      for (let i = currentStepIndex + 1; i < currentFocusTask.steps.length; i++) {
        if (!currentFocusTask.steps[i].completed) {
          currentStepIndex = i;
          renderFocusMode();
          return;
        }
      }

      // Wrap around to start
      for (let i = 0; i < currentStepIndex; i++) {
        if (!currentFocusTask.steps[i].completed) {
          currentStepIndex = i;
          renderFocusMode();
          return;
        }
      }
    }

    function exitFocusMode() {
      document.getElementById('adhdFocusSection').style.display = 'none';
      showAdhdInputSection();
      renderAdhdTaskList();
      stopFocusTimer();
    }

    function toggleAllSteps() {
      const list = document.getElementById('focusStepsList');
      const icon = document.getElementById('showStepsIcon');
      const btn = document.querySelector('.adhd-show-steps-btn');

      if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.textContent = '';
        btn.innerHTML = '<span id="showStepsIcon"></span> Hide all steps';
      } else {
        list.style.display = 'none';
        icon.textContent = '';
        btn.innerHTML = '<span id="showStepsIcon"></span> Show all steps';
      }
    }

    // Timer functions
    function toggleFocusTimer() {
      const btn = document.getElementById('timerBtn');
      if (focusTimerInterval) {
        stopFocusTimer();
        btn.textContent = 'Start Timer';
      } else {
        startFocusTimer();
        btn.textContent = 'Pause';
      }
    }

    function startFocusTimer() {
      focusTimerInterval = setInterval(() => {
        focusTimerSeconds--;
        updateTimerDisplay();

        if (focusTimerSeconds <= 0) {
          stopFocusTimer();
          showCelebration('', '5 minutes done! Keep going or take a break!');
          setTimeout(hideCelebration, 2000);
          focusTimerSeconds = 300; // Reset
          updateTimerDisplay();
        }
      }, 1000);
    }

    function stopFocusTimer() {
      if (focusTimerInterval) {
        clearInterval(focusTimerInterval);
        focusTimerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const mins = Math.floor(focusTimerSeconds / 60);
      const secs = focusTimerSeconds % 60;
      document.getElementById('timerDisplay').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Celebration functions
    function showCelebration(emoji, text) {
      document.getElementById('celebrationEmoji').textContent = emoji;
      document.getElementById('celebrationText').textContent = text;
      document.getElementById('adhdCelebration').style.display = 'flex';
    }

    function hideCelebration() {
      document.getElementById('adhdCelebration').style.display = 'none';
    }

    function getRandomPraise() {
      const praises = [
        'Yes! One step down!',
        'You\'re doing great!',
        'Keep that momentum!',
        'Look at you go!',
        'Crushing it!',
        'One less thing to worry about!',
        'Progress feels good!',
        'You\'re on fire!',
        'That\'s the way!',
        'Boom! Done!'
      ];
      return praises[Math.floor(Math.random() * praises.length)];
    }

    // Share Task Functions
    let shareTaskFromMember = null;

    function openShareTaskSheet(fromMemberId) {
      shareTaskFromMember = fromMemberId;
      const fromMember = getMemberById(fromMemberId);

      // Populate assignee dropdown with other adults
      const assigneeSelect = document.getElementById('shareTaskAssignee');
      const otherAdults = familyMembers.filter(m => m.role === 'adult' && m.id !== fromMemberId);

      assigneeSelect.innerHTML = otherAdults.length > 0
        ? otherAdults.map(m => `<option value="${m.id}">${m.icon} ${m.name}</option>`).join('')
        : '<option value="">No other adults available</option>';

      document.getElementById('shareTaskSubtitle').textContent = `From ${fromMember?.name || 'Unknown'}`;
      document.getElementById('shareTaskTitle').value = '';
      document.getElementById('shareTaskPriority').value = 'normal';
      document.getElementById('shareTaskNotes').value = '';

      openModal('shareTaskSheet');
    }

    function closeShareTaskSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('shareTaskSheet').classList.remove('open');
      shareTaskFromMember = null;
    }

    function submitShareTask() {
      const title = document.getElementById('shareTaskTitle').value.trim();
      const assigneeId = document.getElementById('shareTaskAssignee').value;
      const priority = document.getElementById('shareTaskPriority').value;
      const notes = document.getElementById('shareTaskNotes').value.trim();

      if (!title) {
        alert('Please enter a task description');
        return;
      }
      if (!assigneeId) {
        alert('Please select someone to assign this task to');
        return;
      }

      const fromMember = getMemberById(shareTaskFromMember);
      const toMember = getMemberById(assigneeId);

      const sharedTask = {
        id: generateId(),
        memberId: assigneeId,
        type: 'handoff',
        title: title,
        notes: notes ? `From ${fromMember?.name || 'Unknown'}: ${notes}` : `Shared by ${fromMember?.name || 'Unknown'}`,
        createdAt: new Date().toISOString(),
        priority: priority,
        fromMemberId: shareTaskFromMember
      };

      feedItems.push(sharedTask);
      saveData();
      closeShareTaskSheet();
      renderFeed();
    }

    function confirmResetData() {
      if (confirm('Are you sure you want to reset all family data? This cannot be undone.')) {
        resetAllData();
      }
    }

    // FAB Menu
    function toggleFabMenu() {
      document.getElementById('fabMenu').classList.toggle('visible');
    }

    function closeFabMenu() {
      document.getElementById('fabMenu').classList.remove('visible');
    }

    // Close menus on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.bubble-wrapper')) {
        closeAllMenus();
      }
      if (!e.target.closest('.fab') && !e.target.closest('.fab-menu')) {
        closeFabMenu();
      }
    });

    // ========================================
    // INITIALIZATION
    // ========================================
    function init() {
      initDarkMode();
      initNotifications();
      loadData();
      checkBirthdays();
      renderBubbles();
      renderFeed();
    }

    // Check for upcoming birthdays and create reminder cards
    function checkBirthdays() {
      const today = new Date();
      const todayMonth = today.getMonth();
      const todayDay = today.getDate();

      familyMembers.forEach(member => {
        if (!member.birthday) return;

        const bday = new Date(member.birthday);
        const bdayMonth = bday.getMonth();
        const bdayDay = bday.getDate();

        // Check if birthday is within next 7 days
        for (let i = 0; i <= 7; i++) {
          const checkDate = new Date(today);
          checkDate.setDate(today.getDate() + i);

          if (checkDate.getMonth() === bdayMonth && checkDate.getDate() === bdayDay) {
            // Check if we already have a birthday card for this member this year
            const existingCard = feedItems.find(item =>
              item.type === 'birthday' &&
              item.memberId === member.id &&
              item.year === today.getFullYear()
            );

            if (!existingCard) {
              const age = today.getFullYear() - bday.getFullYear();
              const isToday = i === 0;

              feedItems.push({
                id: generateId(),
                memberId: member.id,
                type: 'birthday',
                title: isToday ? ` Happy Birthday ${member.name}!` : ` ${member.name}'s Birthday Coming Up!`,
                notes: isToday
                  ? `${member.name} turns ${age} today!`
                  : `${member.name} turns ${age} in ${i} day${i > 1 ? 's' : ''}`,
                date: `${today.getFullYear()}-${String(bdayMonth + 1).padStart(2, '0')}-${String(bdayDay).padStart(2, '0')}`,
                year: today.getFullYear(),
                createdAt: new Date().toISOString(),
                pinned: isToday
              });
              saveData();
            }
            break;
          }
        }
      });
    }

    // Start the app
    init();
  </script>
</body>
</html>
