<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Life Assistant - Family Operations Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* ========================================
       LIFE PAGE - COMPLETE STYLES
       ======================================== */

    :root {
      --primary: #0f172a;
      --primary-light: #1e293b;
      --bg: #f1f5f9;
      --card-bg: #ffffff;
      --household: #0d9488;
      --adult: #3b82f6;
      --child: #f59e0b;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #eab308;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    /* Dark Mode */
    [data-theme="dark"] {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: #334155;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 10px 40px rgba(0,0,0,0.5);
    }

    [data-theme="dark"] .bubble.type-adult {
      background: #1e3a5f;
    }

    [data-theme="dark"] .bubble.type-child {
      background: #422006;
    }

    [data-theme="dark"] .bubble.type-household {
      background: #134e4a;
    }

    [data-theme="dark"] .profile-avatar.type-adult { background: #1e3a5f; }
    [data-theme="dark"] .profile-avatar.type-child { background: #422006; }
    [data-theme="dark"] .profile-avatar.type-household { background: #134e4a; }

    [data-theme="dark"] .build-tag {
      background: #334155;
    }

    [data-theme="dark"] .screenshot-import-placeholder {
      background: linear-gradient(135deg, #1e3a5f 0%, #1e293b 100%);
      border-color: var(--adult);
    }

    [data-theme="dark"] .open-questions {
      background: #422006;
    }

    [data-theme="dark"] .micro-steps {
      background: #334155;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      font-size: 16px;
      line-height: 1.5;
    }

    /* Main Scrollable Area - contains bubbles and feed */
    .main-scroll-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* BUILD TAG OVERLAY */
    .build-tag {
      position: fixed;
      top: 8px;
      right: 8px;
      background: var(--primary);
      color: white;
      font-size: 0.65rem;
      padding: 4px 8px;
      border-radius: 4px;
      z-index: 9999;
      font-weight: 600;
      letter-spacing: 0.5px;
      opacity: 0.7;
    }

    /* ========================================
       HEADER
       ======================================== */
    .app-header {
      background: var(--card-bg);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .app-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .back-btn,
    .settings-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .back-btn:hover,
    .settings-btn:hover {
      background: var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      cursor: pointer;
      transition: background 0.15s;
    }

    .header-btn:hover {
      background: var(--border);
    }

    .header-btn.active {
      background: var(--adult);
      color: white;
    }

    /* ========================================
       CALENDAR VIEW
       ======================================== */
    .calendar-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .calendar-view.visible {
      display: flex;
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0 16px;
    }

    .calendar-nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--card-bg);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .calendar-nav-btn:hover {
      background: var(--border);
    }

    .calendar-month-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .calendar-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
      margin-bottom: 8px;
    }

    .calendar-weekdays span {
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      padding: 8px 0;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      position: relative;
      transition: all 0.15s;
      min-height: 44px;
    }

    .calendar-day:hover {
      background: var(--border);
    }

    .calendar-day.other-month {
      opacity: 0.3;
    }

    .calendar-day.today {
      background: var(--adult);
      color: white;
    }

    .calendar-day.selected {
      ring: 2px solid var(--adult);
      box-shadow: 0 0 0 2px var(--adult);
    }

    .calendar-day.has-events::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--danger);
    }

    .calendar-day.today.has-events::after {
      background: white;
    }

    .calendar-day-number {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .calendar-day-detail {
      margin-top: 16px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      min-height: 100px;
      box-shadow: var(--shadow-sm);
    }

    .calendar-day-detail-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .calendar-day-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .calendar-day-item:last-child {
      margin-bottom: 0;
    }

    .calendar-day-item-time {
      font-weight: 600;
      color: var(--adult);
      min-width: 50px;
    }

    .calendar-day-item-title {
      flex: 1;
    }

    .calendar-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
    }

    .calendar-detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .calendar-detail-header h4 {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .calendar-event-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 4px 10px;
      border-radius: 12px;
    }

    .calendar-no-events {
      text-align: center;
      color: var(--text-muted);
      padding: 24px;
      font-size: 0.9rem;
    }

    .calendar-events-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .calendar-event-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--text-muted);
    }

    .calendar-event-item.appointment {
      border-left-color: var(--adult);
    }

    .calendar-event-item.task {
      border-left-color: var(--success);
    }

    .calendar-event-item.prep {
      border-left-color: var(--warning);
    }

    .calendar-event-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
      width: 28px;
      text-align: center;
    }

    .calendar-event-content {
      flex: 1;
      min-width: 0;
    }

    .calendar-event-title {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .calendar-event-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .calendar-event-meta span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* ========================================
       SHOPPING LIST VIEW
       ======================================== */
    .shopping-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .shopping-view.visible {
      display: flex;
    }

    .shopping-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .shopping-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .shopping-actions {
      display: flex;
      gap: 8px;
    }

    .shopping-action-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: none;
      background: var(--card-bg);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-sm);
    }

    .shopping-action-btn:hover {
      background: var(--border);
    }

    .shopping-action-btn.specials-btn {
      background: linear-gradient(135deg, #e65100, #ff9800);
      color: white;
      box-shadow: 0 2px 8px rgba(230, 81, 0, 0.3);
    }

    .shopping-action-btn.specials-btn:hover {
      background: linear-gradient(135deg, #bf360c, #e65100);
    }

    /* Store Specials Styles */
    .store-specials-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .store-special-card {
      background: var(--bg);
      border-radius: var(--radius-lg);
      padding: 14px;
      border: 1px solid var(--border);
    }

    .store-special-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .store-special-logo {
      width: 48px;
      height: 48px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .store-special-name {
      font-weight: 600;
      font-size: 1rem;
    }

    .store-special-category {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .store-special-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .special-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 10px 12px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      gap: 12px;
    }

    .special-item-info {
      flex: 1;
    }

    .special-item-name {
      font-weight: 500;
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .special-item-detail {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .special-item-prices {
      text-align: right;
      flex-shrink: 0;
    }

    .special-item-was {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-decoration: line-through;
    }

    .special-item-now {
      font-weight: 700;
      color: #e65100;
      font-size: 1rem;
    }

    .special-item-save {
      font-size: 0.7rem;
      color: #2e7d32;
      background: #e8f5e9;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 2px;
      display: inline-block;
    }

    .shopping-add {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .shopping-add input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .shopping-add select {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      background: var(--card-bg);
      color: var(--text-primary);
      cursor: pointer;
    }

    .shopping-add-btn {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--adult);
      color: white;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
    }

    .shopping-add-btn:hover {
      opacity: 0.9;
    }

    .shopping-categories {
      flex: 1;
      overflow: auto;
    }

    .shopping-category {
      margin-bottom: 16px;
    }

    .shopping-category-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
    }

    .shopping-category-icon {
      font-size: 1.1rem;
    }

    .shopping-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--card-bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      box-shadow: var(--shadow-sm);
    }

    .shopping-item.completed {
      opacity: 0.5;
    }

    .shopping-item.completed .shopping-item-name {
      text-decoration: line-through;
    }

    .shopping-checkbox {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid var(--border);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .shopping-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .shopping-item-name {
      flex: 1;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .shopping-item-delete {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 1.2rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .shopping-item:hover .shopping-item-delete {
      opacity: 1;
    }

    .shopping-item-delete:hover {
      color: var(--danger);
    }

    .shopping-summary {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      margin-top: 16px;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .shopping-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .shopping-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* Price Compare & Export */
    .price-compare-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .price-compare-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--success);
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .price-compare-btn.secondary {
      background: var(--primary);
    }

    .price-results {
      margin-top: 16px;
    }

    .price-store-card {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 12px;
    }

    .price-store-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .price-store-total {
      margin-left: auto;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--success);
    }

    .price-store-badge {
      background: var(--success);
      color: white;
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .price-item-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
    }

    .price-item-row:last-child {
      border-bottom: none;
    }

    .price-item-name {
      color: var(--text-secondary);
    }

    .price-item-price {
      font-weight: 600;
    }

    .price-item-price.on-special {
      color: var(--danger);
    }

    .export-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .export-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
    }

    .export-option:hover {
      border-color: var(--adult);
    }

    .export-option.share-native {
      background: var(--adult);
      color: white;
      border-color: var(--adult);
      margin-bottom: 16px;
    }

    .export-option.share-native:hover {
      background: #2563eb;
    }

    .export-option.preferred {
      border: 2px solid var(--adult);
      background: rgba(37, 99, 235, 0.1);
    }

    .export-option.preferred:hover {
      background: rgba(37, 99, 235, 0.2);
    }

    a.export-option {
      text-decoration: none;
      color: inherit;
    }

    .export-logo {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .export-preview textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.85rem;
      resize: none;
      margin-bottom: 12px;
    }

    .export-preview h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
    }

    /* ========================================
       MEAL PLANNER VIEW
       ======================================== */
    .meal-planner-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .meal-planner-view.visible {
      display: flex;
    }

    .meal-planner-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0 16px;
    }

    .meal-week-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .meal-days {
      flex: 1;
      overflow: auto;
    }

    .meal-day {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }

    .meal-day-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--primary);
      color: white;
    }

    .meal-day-header.today {
      background: var(--adult);
    }

    .meal-day-name {
      font-weight: 700;
      font-size: 1rem;
    }

    .meal-day-date {
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .meal-slots {
      padding: 12px;
    }

    .meal-slot {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      background: var(--bg);
    }

    .meal-slot:last-child {
      margin-bottom: 0;
    }

    .meal-slot-type {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      width: 60px;
      flex-shrink: 0;
    }

    .meal-slot-content {
      flex: 1;
      min-width: 0;
    }

    .meal-slot-empty {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .meal-slot-empty:hover {
      color: var(--adult);
    }

    .meal-slot-filled {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .meal-slot-emoji {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    .meal-slot-info {
      flex: 1;
      min-width: 0;
    }

    .meal-slot-name {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.95rem;
    }

    .meal-slot-notes {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }

    .meal-slot-actions {
      display: flex;
      gap: 4px;
    }

    .meal-slot-btn {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .meal-slot-btn:hover {
      background: var(--border);
      color: var(--text-primary);
    }

    .meal-actions {
      padding-top: 16px;
    }

    .meal-generate-btn {
      width: 100%;
      padding: 14px 20px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--success);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .meal-generate-btn:hover {
      opacity: 0.9;
    }

    /* Smart Meal Actions */
    .smart-meal-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .smart-meal-btn {
      flex: 1;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .smart-meal-btn.primary {
      background: var(--adult);
      color: white;
      border: none;
    }

    .smart-meal-btn.takeaway-btn {
      background: #ff6b35;
      color: white;
      border: none;
    }

    /* Meal Tabs */
    .meal-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg);
      padding: 4px;
      border-radius: var(--radius-md);
      margin-bottom: 16px;
    }

    .meal-tab {
      flex: 1;
      padding: 10px 16px;
      border: none;
      background: transparent;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .meal-tab.active {
      background: var(--card-bg);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }

    .meal-tab-content {
      display: none;
    }

    .meal-tab-content.active {
      display: block;
    }

    /* Meal Type Tabs (Breakfast/Lunch/Dinner) */
    .meal-type-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .meal-type-tab {
      flex: 1;
      padding: 12px 8px;
      border: 2px solid var(--border);
      background: var(--card-bg);
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-md);
      transition: all 0.15s;
    }

    .meal-type-tab:hover {
      border-color: var(--adult);
      color: var(--adult);
    }

    .meal-type-tab.active {
      border-color: var(--adult);
      background: var(--adult);
      color: white;
    }

    /* Meal Ideas Header */
    .meal-ideas-header {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    /* Meal Ideas Grid */
    .meal-ideas-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .meal-ideas-empty {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .meal-ideas-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* Meal Idea Card */
    .meal-idea-card {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }

    .meal-idea-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .meal-idea-card.selected {
      ring: 2px solid var(--adult);
      box-shadow: 0 0 0 2px var(--adult);
    }

    .meal-idea-image {
      height: 100px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--adult) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
    }

    .meal-idea-content {
      padding: 12px;
    }

    .meal-idea-name {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .meal-idea-description {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-style: italic;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .expanded-meal-description {
      font-size: 0.95rem;
      color: var(--text-secondary);
      font-style: italic;
      text-align: center;
      margin-bottom: 16px;
      padding: 0 12px;
      line-height: 1.4;
    }

    .meal-idea-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .meal-idea-checkbox {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: white;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
    }

    .meal-idea-card.selected .meal-idea-checkbox {
      background: var(--adult);
      border-color: var(--adult);
      color: white;
    }

    /* Authenticity Badge */
    .authenticity-badge {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      backdrop-filter: blur(8px);
    }

    .authenticity-badge.score-high {
      background: rgba(46, 125, 50, 0.9);
      color: white;
    }

    .authenticity-badge.score-medium {
      background: rgba(255, 152, 0, 0.9);
      color: white;
    }

    .authenticity-badge.score-low {
      background: rgba(211, 47, 47, 0.9);
      color: white;
    }

    /* Meal Section Headers */
    .meal-section-header {
      grid-column: 1 / -1;
      padding: 16px 0 8px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 8px;
      margin-top: 16px;
    }

    .meal-section-header:first-child {
      margin-top: 0;
    }

    .meal-section-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Category Tags on Cards */
    .meal-category-tag {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .meal-category-tag.entree {
      background: rgba(33, 150, 243, 0.15);
      color: #1976d2;
    }

    .meal-category-tag.snack-sweet {
      background: rgba(233, 30, 99, 0.15);
      color: #c2185b;
    }

    .meal-category-tag.snack-savoury,
    .meal-category-tag.snack {
      background: rgba(255, 152, 0, 0.15);
      color: #f57c00;
    }

    .meal-category-tag.dessert {
      background: rgba(156, 39, 176, 0.15);
      color: #7b1fa2;
    }

    .meal-idea-cuisine {
      font-size: 0.7rem;
      color: var(--primary);
      font-weight: 500;
      margin-bottom: 4px;
    }

    /* Audit Details in expanded view */
    .audit-section {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 12px;
      margin-top: 16px;
    }

    .audit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .audit-score {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .audit-score.high { color: #2e7d32; }
    .audit-score.medium { color: #ff9800; }
    .audit-score.low { color: #d32f2f; }

    .audit-verdict {
      padding: 4px 12px;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .audit-verdict.approved {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .audit-verdict.needs-improvement {
      background: #fff3e0;
      color: #e65100;
    }

    .audit-list {
      font-size: 0.85rem;
      margin: 8px 0;
    }

    .audit-list li {
      margin-bottom: 4px;
    }

    .audit-positives { color: #2e7d32; }
    .audit-concerns { color: #e65100; }

    .audit-suggestion {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--border);
    }

    .ai-attribution {
      display: flex;
      justify-content: center;
      gap: 16px;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }

    .ai-attribution span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Meal Selection Bar */
    .meal-selection-bar {
      position: sticky;
      bottom: 0;
      background: var(--card-bg);
      padding: 16px;
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 0 -16px -16px;
    }

    .meal-selection-buttons {
      display: flex;
      gap: 8px;
    }

    .add-to-plan-btn,
    .add-to-list-btn {
      padding: 10px 14px;
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .add-to-plan-btn {
      background: var(--primary);
    }

    .add-to-list-btn {
      background: var(--success);
    }

    /* Meal Assignment List */
    .meal-assignment-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 20px;
      max-height: 60vh;
      overflow-y: auto;
    }

    .meal-assignment-item {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid var(--border);
    }

    .meal-assignment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .meal-assignment-emoji {
      font-size: 1.5rem;
    }

    .meal-assignment-name {
      font-weight: 600;
      font-size: 0.95rem;
      flex: 1;
    }

    .meal-assignment-selects {
      display: flex;
      gap: 8px;
    }

    .meal-assignment-selects select {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--card-bg);
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    /* Expanded Meal Content */
    .expanded-meal-image {
      height: 150px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--adult) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      margin: -20px -20px 20px;
    }

    .expanded-meal-section {
      margin-bottom: 20px;
    }

    .expanded-meal-section h4 {
      font-size: 0.9rem;
      font-weight: 700;
      margin: 0 0 12px;
      color: var(--text-primary);
    }

    .expanded-ingredient-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .expanded-ingredient {
      padding: 6px 12px;
      background: var(--bg);
      border-radius: 20px;
      font-size: 0.8rem;
    }

    .expanded-steps-list {
      counter-reset: step;
    }

    .expanded-step {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .expanded-step:last-child {
      border-bottom: none;
    }

    .expanded-step-number {
      width: 28px;
      height: 28px;
      background: var(--adult);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .expanded-step-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .expanded-meal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .expanded-meal-actions button {
      flex: 1;
    }

    /* Ingredient Review */
    .ingredient-review-list {
      margin-bottom: 20px;
    }

    .ingredient-review-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .ingredient-review-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .ingredient-review-name {
      flex: 1;
      font-size: 0.9rem;
    }

    .ingredient-review-price {
      font-weight: 600;
      color: var(--success);
    }

    /* Quality Preference */
    .quality-preference {
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg);
      border-radius: var(--radius-md);
    }

    .quality-preference h4 {
      margin: 0 0 12px;
      font-size: 0.9rem;
    }

    .quality-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .quality-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
    }

    .quality-option:hover {
      background: var(--card-bg);
    }

    .quality-label {
      font-size: 0.9rem;
    }

    /* Meal Preferences Modal Styles */
    .pref-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .pref-tab {
      flex: 1;
      padding: 8px 4px;
      border: none;
      background: transparent;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: var(--radius-sm);
    }

    .pref-tab.active {
      background: var(--adult);
      color: white;
    }

    .pref-panel {
      display: none;
    }

    .pref-panel.active {
      display: block;
    }

    .pref-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .pref-category {
      margin-bottom: 16px;
    }

    .pref-category h4 {
      font-size: 0.85rem;
      font-weight: 600;
      margin: 0 0 8px;
      color: var(--text-primary);
    }

    .pref-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .pref-chip {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: var(--bg);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .pref-chip.selected {
      background: var(--danger);
      color: white;
      border-color: var(--danger);
    }

    /* Cuisine chips - positive selection color */
    .cuisine-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .cuisine-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
    }

    .cuisine-chip .cuisine-icon {
      font-size: 1.1rem;
    }

    .cuisine-chip .cuisine-name {
      font-size: 0.85rem;
    }

    .cuisine-chip.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .pref-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .pref-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
    }

    .pref-option.selected {
      border-color: var(--adult);
      background: #eff6ff;
    }

    .pref-option-icon {
      font-size: 1.5rem;
    }

    .pref-option-text {
      flex: 1;
    }

    .pref-option-title {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .pref-option-desc {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .pref-setting {
      margin-bottom: 20px;
    }

    .pref-setting label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    .budget-input {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
    }

    .budget-input input {
      width: 80px;
      padding: 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      text-align: center;
    }

    .stepper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stepper button {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card-bg);
      font-size: 1.25rem;
      cursor: pointer;
    }

    .stepper span {
      font-size: 1.25rem;
      font-weight: 600;
      min-width: 40px;
      text-align: center;
    }

    /* Location Input */
    .location-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .location-input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--bg);
      color: var(--text-primary);
    }

    .location-detect-btn {
      padding: 12px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }

    .location-detect-btn:disabled {
      background: var(--text-muted);
      cursor: not-allowed;
    }

    .location-status {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .location-status.success {
      color: var(--success);
    }

    .location-status.error {
      color: var(--danger);
    }

    .store-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .store-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer;
    }

    .store-option.selected {
      border-color: var(--success);
      background: #f0fdf4;
    }

    .store-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      font-weight: 700;
    }

    .store-logo.woolworths { background: #0d9e1d; color: white; }
    .store-logo.coles { background: #e01a22; color: white; }
    .store-logo.aldi { background: #00447c; color: white; }
    .store-logo.costco { background: #e31837; color: white; }

    .store-name {
      flex: 1;
      font-weight: 600;
    }

    .store-check {
      font-size: 1.25rem;
      color: var(--success);
    }

    /* AI Loading Overlay */
    .ai-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .ai-loading-card {
      background: var(--card-bg);
      padding: 32px 48px;
      border-radius: var(--radius-lg);
      text-align: center;
    }

    .ai-loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--adult);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }

    .ai-loading-card h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }

    .ai-loading-card p {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* ========================================
       ADHD TASK BREAKDOWN VIEW
       ======================================== */
    .adhd-task-view {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: auto;
      background: var(--bg);
      padding: 16px;
    }

    .adhd-task-view.visible {
      display: flex;
    }

    .adhd-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .adhd-header h3 {
      margin: 0 0 4px;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .adhd-subtitle {
      margin: 0;
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .adhd-input-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      box-shadow: var(--shadow-md);
      margin-bottom: 16px;
    }

    .adhd-label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .adhd-textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      background: var(--bg);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    .adhd-textarea:focus {
      outline: none;
      border-color: var(--adult);
    }

    .adhd-breakdown-btn {
      width: 100%;
      margin-top: 14px;
      padding: 16px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .adhd-breakdown-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
    }

    .adhd-breakdown-btn:active {
      transform: translateY(0);
    }

    .adhd-tips {
      margin-bottom: 24px;
    }

    .adhd-tip {
      background: var(--card-bg);
      padding: 12px 16px;
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      color: var(--text-secondary);
      border-left: 3px solid var(--warning);
    }

    .adhd-existing-tasks h4 {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0 0 12px;
    }

    .adhd-task-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .adhd-task-item {
      background: var(--card-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: 14px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .adhd-task-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    .adhd-task-item.completed {
      opacity: 0.6;
    }

    .adhd-task-progress-ring {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: conic-gradient(var(--success) var(--progress, 0%), var(--border) 0%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .adhd-task-progress-inner {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--card-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-primary);
    }

    .adhd-task-info {
      flex: 1;
      min-width: 0;
    }

    .adhd-task-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .adhd-task-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }

    .adhd-task-actions {
      display: flex;
      gap: 8px;
    }

    .adhd-task-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--bg);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .adhd-task-action-btn:hover {
      background: var(--border);
    }

    /* Clarification Section */
    .adhd-clarify-section {
      padding: 16px;
    }

    .adhd-clarify-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .adhd-clarify-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .adhd-back-btn {
      padding: 8px 14px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
      cursor: pointer;
    }

    .adhd-clarify-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-md);
    }

    .adhd-clarify-question {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 20px;
      text-align: center;
    }

    .adhd-clarify-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }

    .adhd-clarify-option {
      padding: 14px 18px;
      border-radius: var(--radius-md);
      border: 2px solid var(--border);
      background: var(--bg);
      cursor: pointer;
      text-align: left;
      font-size: 1rem;
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .adhd-clarify-option:hover {
      border-color: var(--adult);
      background: rgba(59, 130, 246, 0.1);
    }

    .adhd-clarify-option.selected {
      border-color: var(--adult);
      background: var(--adult);
      color: white;
    }

    .adhd-clarify-custom {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .adhd-clarify-custom input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 1rem;
      background: var(--bg);
      color: var(--text-primary);
    }

    .adhd-clarify-custom button {
      width: 48px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--adult);
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    .adhd-clarify-progress {
      text-align: center;
      margin-top: 16px;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Focus Mode */
    .adhd-focus-section {
      padding: 16px;
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    .adhd-focus-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }

    .adhd-focus-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text-secondary);
    }

    .adhd-focus-card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      padding: 32px 24px;
      box-shadow: var(--shadow-lg);
      text-align: center;
      margin-bottom: 20px;
    }

    .adhd-focus-step-label {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .adhd-focus-current-step {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.4;
      margin-bottom: 24px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .adhd-focus-progress {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .adhd-focus-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #34d399);
      border-radius: 4px;
      transition: width 0.5s ease;
      width: 0%;
    }

    .adhd-focus-progress-text {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .adhd-focus-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .adhd-done-btn {
      padding: 18px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .adhd-done-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
    }

    .adhd-skip-btn {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
    }

    .adhd-skip-btn:hover {
      background: var(--border);
    }

    .adhd-focus-timer {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }

    .adhd-timer-text {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .adhd-timer-display {
      font-size: 3rem;
      font-weight: 700;
      color: var(--text-primary);
      font-variant-numeric: tabular-nums;
      margin-bottom: 12px;
    }

    .adhd-timer-btn {
      padding: 10px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--adult);
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .adhd-focus-all-steps {
      margin-top: auto;
    }

    .adhd-show-steps-btn {
      width: 100%;
      padding: 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .adhd-steps-list {
      margin-top: 12px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .adhd-step-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.95rem;
    }

    .adhd-step-item:last-child {
      border-bottom: none;
    }

    .adhd-step-item.completed {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .adhd-step-item.current {
      background: rgba(59, 130, 246, 0.1);
      font-weight: 600;
    }

    .adhd-step-number {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .adhd-step-item.completed .adhd-step-number {
      background: var(--success);
      color: white;
    }

    .adhd-step-item.current .adhd-step-number {
      background: var(--adult);
      color: white;
    }

    /* Celebration */
    .adhd-celebration {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .celebration-content {
      text-align: center;
      animation: celebratePop 0.5s ease;
    }

    .celebration-emoji {
      font-size: 6rem;
      margin-bottom: 20px;
      animation: celebrateBounce 0.6s ease infinite;
    }

    .celebration-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
    }

    @keyframes celebratePop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes celebrateBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    /* Loading */
    .adhd-loading {
      text-align: center;
      padding: 40px 20px;
    }

    .adhd-loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--border);
      border-top-color: var(--adult);
      border-radius: 50%;
      margin: 0 auto 16px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .adhd-loading p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    /* Breakdown Result */
    .adhd-breakdown-summary {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
    }

    .adhd-breakdown-summary h4 {
      margin: 0 0 8px;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .adhd-breakdown-summary p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .adhd-breakdown-steps {
      margin-bottom: 20px;
    }

    .adhd-breakdown-step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }

    .adhd-breakdown-step-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--adult);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .adhd-breakdown-step-text {
      flex: 1;
      font-size: 0.95rem;
      color: var(--text-primary);
      padding-top: 3px;
    }

    .adhd-breakdown-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .adhd-save-btn {
      padding: 16px 24px;
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: white;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .adhd-regenerate-btn {
      padding: 12px 20px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text-secondary);
      font-size: 1rem;
      cursor: pointer;
    }

    .adhd-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .adhd-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
    }

    /* ========================================
       BUBBLE NAVIGATION
       ======================================== */
    .bubble-container {
      background: var(--card-bg);
      padding: 16px 0;
      box-shadow: var(--shadow-sm);
      position: relative;
    }

    .bubble-row {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      padding: 8px 20px 12px;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .bubble-row::-webkit-scrollbar { display: none; }

    .bubble-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      flex-shrink: 0;
    }

    .bubble {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      border: 3px solid transparent;
      transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      overflow: hidden;
    }

    .bubble.pressing {
      transform: scale(0.9);
    }

    .bubble.selected {
      transform: scale(1.08);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }

    .bubble.type-adult {
      border-color: var(--adult);
      background: #eff6ff;
    }

    .bubble.type-child {
      border-color: var(--child);
      background: #fffbeb;
    }

    .bubble.type-household {
      border-color: var(--household);
      background: #f0fdfa;
    }

    .bubble-label {
      margin-top: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-align: center;
      max-width: 70px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bubble-add {
      border: 2px dashed var(--border);
      background: transparent;
      color: var(--text-muted);
      font-size: 1.5rem;
    }

    .bubble-add:hover {
      border-color: var(--text-secondary);
      color: var(--text-secondary);
    }

    /* ========================================
       LONG-PRESS ACTION MENU
       ======================================== */
    .action-menu {
      position: fixed;
      top: auto;
      left: 50%;
      transform: translateX(-50%) scale(0.9);
      background: var(--card-bg);
      border-radius: var(--radius-md);
      min-width: 180px;
      box-shadow: var(--shadow-lg);
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      z-index: 9000;
      opacity: 0;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .action-menu::before {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      border: 8px solid transparent;
      border-bottom-color: var(--card-bg);
      border-top: 0;
    }

    .action-menu.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) scale(1);
    }

    .menu-item {
      padding: 12px 14px;
      font-size: 0.875rem;
      color: var(--text-primary);
      background: none;
      border: none;
      text-align: left;
      border-radius: var(--radius-sm);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-family: inherit;
    }

    .menu-item:hover, .menu-item:active {
      background: var(--bg);
    }

    .menu-icon {
      font-size: 1rem;
      width: 24px;
      text-align: center;
    }

    /* ========================================
       FEED LAYER
       ======================================== */
    .feed-layer {
      padding: 20px;
      padding-bottom: 100px;
    }

    .feed-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 12px;
      margin-top: 8px;
    }

    .feed-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
      animation: slideUp 0.4s ease-out;
    }

    .feed-empty-icon {
      font-size: 3.5rem;
      margin-bottom: 16px;
      animation: bounce 2s ease-in-out infinite;
    }

    .feed-empty-text {
      font-size: 0.95rem;
      line-height: 1.7;
      max-width: 280px;
      margin: 0 auto;
    }

    .feed-empty-hint {
      margin-top: 20px;
      padding: 12px 16px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      display: inline-block;
      font-size: 0.85rem;
      box-shadow: var(--shadow-sm);
    }

    /* Today View Card */
    .today-view-card {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-md);
    }

    .today-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .today-icon {
      font-size: 1.25rem;
    }

    .today-title {
      font-weight: 700;
      font-size: 1.1rem;
      flex: 1;
    }

    .today-date {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .today-items {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .today-item {
      font-size: 0.9rem;
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: var(--radius-sm);
    }

    .today-item strong {
      color: #93c5fd;
    }

    /* Undo Toast */
    .undo-toast {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--primary);
      color: white;
      padding: 12px 20px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: var(--shadow-lg);
      z-index: 1500;
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .undo-toast.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(0);
    }

    .undo-toast-text {
      font-size: 0.9rem;
    }

    .undo-toast-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      cursor: pointer;
      font-family: inherit;
    }

    .undo-toast-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ========================================
       FEED CARDS
       ======================================== */
    .feed-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-sm);
      border-left: 4px solid var(--border);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    .feed-card.pinned {
      border-left-color: var(--primary);
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid var(--border);
      border-left: 4px solid var(--primary);
    }

    .feed-card.type-appointment { border-left-color: #8b5cf6; }
    .feed-card.type-roster { border-left-color: var(--adult); }
    .feed-card.type-milestone { border-left-color: var(--child); }
    .feed-card.type-event { border-left-color: #ec4899; }
    .feed-card.type-goal { border-left-color: var(--success); }
    .feed-card.type-note { border-left-color: var(--text-muted); }
    .feed-card.type-prep { border-left-color: var(--warning); }
    .feed-card.type-conflict { border-left-color: var(--danger); }
    .feed-card.type-handoff { border-left-color: #f97316; }
    .feed-card.type-birthday { border-left-color: #ec4899; background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); }

    [data-theme="dark"] .feed-card.type-birthday { background: linear-gradient(135deg, #500724 0%, #831843 100%); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .card-type-badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
      background: var(--bg);
      color: var(--text-secondary);
    }

    .card-recurrence-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      border-radius: 4px;
      background: #dbeafe;
      color: #1e40af;
      text-transform: capitalize;
    }

    [data-theme="dark"] .card-recurrence-badge {
      background: #1e3a5f;
      color: #93c5fd;
    }

    .card-member-badge {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .pin-icon {
      color: var(--primary);
    }

    .card-body {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .card-meta {
      display: flex;
      gap: 16px;
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .card-meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .card-action-btn {
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: inherit;
      transition: all 0.15s;
    }

    .card-action-btn.primary {
      background: var(--primary);
      color: white;
    }

    .card-action-btn.primary:hover {
      background: var(--primary-light);
    }

    .card-action-btn.secondary {
      background: var(--bg);
      color: var(--text-primary);
    }

    .card-action-btn.secondary:hover {
      background: var(--border);
    }

    .card-action-btn.success {
      background: #dcfce7;
      color: #166534;
    }

    .card-action-btn.timer {
      background: #fef3c7;
      color: #92400e;
    }

    /* ========================================
       MICRO-STEPS (ADHD Engine)
       ======================================== */
    .micro-steps {
      margin-top: 12px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 12px;
    }

    .micro-steps-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .micro-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .micro-step:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    .micro-step-checkbox {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .micro-step-checkbox.checked {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }

    .micro-step-content {
      flex: 1;
    }

    .micro-step-text {
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .micro-step.completed .micro-step-text {
      text-decoration: line-through;
      color: var(--text-muted);
    }

    .micro-step-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .micro-step-timer {
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      background: #fef3c7;
      color: #92400e;
      font-size: 0.7rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      font-family: inherit;
    }

    .micro-step-timer:hover {
      background: #fde68a;
    }

    /* Open Questions Section */
    .open-questions {
      margin-top: 12px;
      padding: 12px;
      background: #fef3c7;
      border-radius: var(--radius-sm);
    }

    .open-questions-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: #92400e;
      margin-bottom: 8px;
    }

    .open-question-item {
      font-size: 0.85rem;
      color: #78350f;
      padding: 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ========================================
       WEEKLY SUMMARY CARD
       ======================================== */
    .weekly-summary-section {
      margin-top: 8px;
    }

    .weekly-summary-section h4 {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 12px 0 6px;
    }

    .weekly-summary-section ul {
      margin: 0;
      padding-left: 20px;
    }

    .weekly-summary-section li {
      font-size: 0.85rem;
      color: var(--text-secondary);
      padding: 3px 0;
    }

    /* ========================================
       FLOATING ACTION BUTTON
       ======================================== */
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      box-shadow: var(--shadow-lg);
      cursor: pointer;
      z-index: 200;
      border: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .fab:hover {
      transform: scale(1.05);
    }

    .fab:active {
      transform: scale(0.95);
    }

    .fab-menu {
      position: fixed;
      bottom: 90px;
      right: 24px;
      background: var(--card-bg);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      padding: 8px;
      z-index: 199;
      opacity: 0;
      pointer-events: none;
      transform: translateY(10px);
      transition: all 0.2s;
    }

    .fab-menu.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    .fab-menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      white-space: nowrap;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .fab-menu-item:hover {
      background: var(--bg);
    }

    .fab-menu-item .icon {
      font-size: 1.1rem;
    }

    /* ========================================
       MODALS & BOTTOM SHEETS
       ======================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 900;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: 20px;
      z-index: 1001;
      max-height: 85vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .modal-sheet.open {
      transform: translateY(0);
    }

    .modal-sheet.large {
      max-height: 90vh;
    }

    /* Takeaway Deals Styles */
    .takeaway-deals-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    /* Takeaway Filter Styles */
    .takeaway-filters {
      background: var(--surface);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
    }

    .filter-row {
      margin-bottom: 12px;
    }

    .filter-row:last-of-type {
      margin-bottom: 0;
    }

    .filter-row label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-chip {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .filter-chip:hover {
      border-color: var(--primary);
    }

    .filter-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .cuisine-chips {
      max-height: 80px;
      overflow-y: auto;
    }

    .takeaway-deals-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .takeaway-deal-card {
      background: var(--bg);
      border-radius: var(--radius-md);
      padding: 16px;
      border: 1px solid var(--border);
    }

    .takeaway-deal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .takeaway-deal-logo {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-sm);
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }

    .takeaway-deal-name {
      font-weight: 600;
      font-size: 1rem;
      color: var(--text-primary);
    }

    .takeaway-deal-type {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .takeaway-deal-address {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .takeaway-deal-card.local-restaurant {
      border-left: 3px solid #4caf50;
    }

    .takeaway-deal-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .takeaway-order-btn,
    .takeaway-phone-btn {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
    }

    .takeaway-order-btn {
      background: var(--primary);
      color: white;
    }

    .takeaway-order-btn:hover {
      background: var(--primary-dark, #1565c0);
    }

    .takeaway-phone-btn {
      background: var(--surface);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .takeaway-phone-btn:hover {
      background: var(--border);
    }

    .takeaway-deal-offers {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 12px;
    }

    .takeaway-offer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff8e6;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border-left: 3px solid #ff9800;
    }

    .takeaway-offer-text {
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .takeaway-offer-price {
      font-weight: 700;
      color: #e65100;
    }

    .takeaway-no-location {
      text-align: center;
      padding: 30px 20px;
    }

    .takeaway-no-location button {
      margin-top: 12px;
    }

    .modal-sheet .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-sheet .modal-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .modal-sheet .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: var(--bg);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .bottom-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-radius: var(--radius-xl) var(--radius-xl) 0 0;
      padding: 0;
      z-index: 1000;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .bottom-sheet.open {
      transform: translateY(0);
    }

    .sheet-handle {
      width: 40px;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto;
      flex-shrink: 0;
    }

    .sheet-header {
      padding: 0 20px 16px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .sheet-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .sheet-subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .sheet-content {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
      -webkit-overflow-scrolling: touch;
    }

    .sheet-actions {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      background: var(--card-bg);
    }

    /* ========================================
       FORMS
       ======================================== */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 16px; /* Prevents iOS zoom */
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text-primary);
      transition: border-color 0.2s;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--adult);
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .screenshot-import-placeholder {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 2px dashed var(--adult);
      border-radius: var(--radius-md);
      cursor: pointer;
      margin-bottom: 16px;
      transition: all 0.2s;
    }

    .screenshot-import-placeholder:hover {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    }

    .screenshot-icon {
      font-size: 1.5rem;
    }

    .screenshot-text {
      flex: 1;
      font-weight: 500;
      color: var(--text-primary);
    }

    .screenshot-badge {
      font-size: 0.65rem;
      text-transform: uppercase;
      padding: 4px 8px;
      background: var(--adult);
      color: white;
      border-radius: 4px;
      font-weight: 600;
    }

    .form-divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .form-divider::before,
    .form-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .profile-pic-upload {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
      border: 2px dashed var(--border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
    }

    .profile-pic-upload:hover {
      border-color: var(--adult);
      background: var(--bg);
    }

    .profile-pic-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      overflow: hidden;
      border: 3px solid var(--border);
    }

    .profile-pic-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-pic-upload-text {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
    }

    .profile-pic-upload-text strong {
      color: var(--adult);
    }

    .profile-pic-input {
      display: none;
    }

    .appointment-photo-preview {
      margin-bottom: 12px;
      border-radius: var(--radius-md);
      overflow: hidden;
      display: none;
    }

    .appointment-photo-preview.has-image {
      display: block;
    }

    .appointment-photo-preview img {
      width: 100%;
      max-height: 150px;
      object-fit: cover;
      border-radius: var(--radius-md);
    }

    .appointment-photo-preview .ai-status {
      padding: 10px;
      background: #fef3c7;
      color: #92400e;
      font-size: 0.8rem;
      text-align: center;
      animation: pulse 1.5s infinite;
    }

    .location-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .location-input-wrapper .form-input {
      flex: 1;
    }

    .location-search-btn {
      width: 48px;
      height: 48px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.15s;
    }

    .location-search-btn:hover {
      background: var(--border);
    }

    .btn {
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
      flex: 1;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: var(--bg);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-danger {
      background: #fef2f2;
      color: var(--danger);
    }

    .btn-danger:hover {
      background: #fee2e2;
    }

    /* ========================================
       PROFILE PANEL
       ======================================== */
    .profile-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.25rem;
      overflow: hidden;
    }

    .profile-avatar.type-adult { background: #eff6ff; }
    .profile-avatar.type-child { background: #fffbeb; }
    .profile-avatar.type-household { background: #f0fdfa; }

    .profile-info h2 {
      margin: 0;
      font-size: 1.25rem;
    }

    .profile-role {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-transform: capitalize;
    }

    .profile-section {
      margin-top: 20px;
    }

    .profile-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .profile-item {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .profile-item:last-child {
      border-bottom: none;
    }

    .profile-item-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .profile-item-value {
      font-weight: 500;
      font-size: 0.9rem;
    }

    /* ========================================
       SETTINGS PANEL
       ======================================== */
    .settings-section {
      margin-bottom: 24px;
    }

    .settings-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .settings-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 0;
      border-bottom: 1px solid var(--border);
    }

    .settings-item-info {
      flex: 1;
    }

    .settings-item-label {
      font-weight: 500;
      font-size: 0.95rem;
    }

    .settings-item-desc {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 52px;
      height: 28px;
      flex-shrink: 0;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: 0.3s;
      border-radius: 28px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--adult);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* ========================================
       TIMER MODAL
       ======================================== */
    .timer-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.95);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }

    .timer-modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .timer-content {
      text-align: center;
      color: white;
    }

    .timer-display {
      font-size: 5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      letter-spacing: -2px;
      margin-bottom: 8px;
    }

    .timer-label {
      font-size: 1.1rem;
      opacity: 0.7;
      margin-bottom: 32px;
    }

    .timer-actions {
      display: flex;
      gap: 16px;
      justify-content: center;
    }

    .timer-btn {
      padding: 14px 32px;
      border-radius: var(--radius-md);
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: transform 0.15s, opacity 0.15s;
    }

    .timer-btn:active {
      transform: scale(0.95);
    }

    .timer-btn.pause {
      background: white;
      color: var(--primary);
    }

    .timer-btn.stop {
      background: var(--success);
      color: white;
    }

    .timer-ios-hint {
      margin-top: 32px;
      font-size: 0.85rem;
      opacity: 0.5;
    }

    .timer-ios-hint a {
      color: var(--adult);
      text-decoration: underline;
    }

    /* ========================================
       UTILITIES
       ======================================== */
    .text-danger { color: var(--danger); }
    .text-success { color: var(--success); }
    .text-warning { color: var(--warning); }
    .text-muted { color: var(--text-muted); }
    .font-bold { font-weight: 600; }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-2 { margin-bottom: 8px; }
    .hidden { display: none !important; }

    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (min-width: 768px) {
      .feed-layer {
        max-width: 600px;
        margin: 0 auto;
      }
    }
  </style>
</head>
<body>
  <!-- BUILD TAG -->
  <div class="build-tag">BUILD v1.2</div>

  <!-- HEADER -->
  <header class="app-header">
    <div class="header-left">
      <button class="back-btn" onclick="window.location.href='/'" title="Back to Home"></button>
      <div class="app-title">Life Assistant</div>
    </div>
    <div class="header-right">
      <button class="header-btn" id="adhdTaskToggleBtn" onclick="toggleAdhdTaskView()" title="ADHD Task Breakdown"></button>
      <button class="header-btn" id="shoppingToggleBtn" onclick="toggleShoppingView()" title="Shopping List"></button>
      <button class="header-btn" id="mealToggleBtn" onclick="toggleMealPlannerView()" title="Meal Planner"></button>
      <button class="header-btn" id="calendarToggleBtn" onclick="toggleCalendarView()" title="Calendar View"></button>
      <button class="header-btn" onclick="openSettings()" title="Settings"></button>
    </div>
  </header>

  <!-- MAIN SCROLLABLE AREA -->
  <main class="main-scroll-area" id="mainScrollArea">
    <!-- BUBBLE NAVIGATION -->
    <div class="bubble-container">
      <div class="bubble-row" id="bubbleRow"></div>
    </div>

    <!-- FEED LAYER -->
    <div class="feed-layer" id="feedLayer">
      <div id="feedContent"></div>
    </div>
  </main>

  <!-- CALENDAR VIEW -->
  <div class="calendar-view" id="calendarView">
    <div class="calendar-header">
      <button class="calendar-nav-btn" onclick="changeMonth(-1)"></button>
      <h3 class="calendar-month-title" id="calendarMonthTitle">January 2024</h3>
      <button class="calendar-nav-btn" onclick="changeMonth(1)"></button>
    </div>
    <div class="calendar-weekdays">
      <span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span><span>Sun</span>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
    <div class="calendar-day-detail" id="calendarDayDetail"></div>
  </div>

  <!-- SHOPPING LIST VIEW -->
  <div class="shopping-view" id="shoppingView">
    <div class="shopping-header">
      <h3>Shopping List</h3>
      <div class="shopping-actions">
        <button class="shopping-action-btn specials-btn" onclick="openStoreSpecials()" title="Store Specials"></button>
        <button class="shopping-action-btn" onclick="clearCompletedItems()" title="Clear completed"></button>
        <button class="shopping-action-btn" onclick="generateListFromMeals()" title="Generate from meals"></button>
      </div>
    </div>

    <div class="shopping-add">
      <input type="text" id="shoppingInput" placeholder="Add item..." onkeypress="handleShoppingKeypress(event)">
      <select id="shoppingCategory">
        <option value="produce"> Produce</option>
        <option value="dairy"> Dairy</option>
        <option value="meat"> Meat</option>
        <option value="bakery"> Bakery</option>
        <option value="pantry"> Pantry</option>
        <option value="frozen"> Frozen</option>
        <option value="drinks"> Drinks</option>
        <option value="household"> Household</option>
        <option value="other"> Other</option>
      </select>
      <button class="shopping-add-btn" onclick="addShoppingItem()">+</button>
    </div>

    <div class="shopping-categories" id="shoppingCategories">
      <!-- Categories will be rendered here -->
    </div>

    <div class="shopping-summary" id="shoppingSummary">
      <span class="shopping-count">0 items</span>
      <span class="shopping-completed">0 completed</span>
    </div>

    <!-- Price Comparison Actions -->
    <div class="price-compare-actions">
      <button class="price-compare-btn" onclick="comparePrices()">
         Compare Prices
      </button>
      <button class="price-compare-btn secondary" onclick="openExportOptions()">
         Export List
      </button>
    </div>
  </div>

  <!-- PRICE COMPARISON MODAL -->
  <div class="modal-sheet" id="priceCompareSheet">
    <div class="modal-header">
      <h3>Price Comparison</h3>
      <button class="modal-close" onclick="closePriceCompare()"></button>
    </div>
    <div class="modal-content">
      <div class="price-loading" id="priceLoading">
        <div class="ai-loading-spinner"></div>
        <p>Finding the best prices...</p>
      </div>
      <div class="price-results" id="priceResults" style="display: none;">
        <!-- Results will be rendered here -->
      </div>
    </div>
  </div>

  <!-- EXPORT OPTIONS MODAL -->
  <div class="modal-sheet" id="exportSheet">
    <div class="modal-header">
      <h3>Export Shopping List</h3>
      <button class="modal-close" onclick="closeExportSheet()"></button>
    </div>
    <div class="modal-content">
      <p class="pref-description">Choose your store to shop:</p>

      <!-- Native Share Button (mobile) -->
      <div class="export-option share-native" id="nativeShareBtn" onclick="shareNative()" style="display: none;">
        <div class="export-logo"></div>
        <span>Share to Any App</span>
      </div>

      <div class="export-options" id="storeExportOptions">
        <!-- Store options will be populated dynamically based on user's preferred store -->
      </div>

      <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
        <p class="pref-description" style="margin-bottom: 8px;">Or copy as text:</p>
        <div class="export-option" onclick="exportPlainText()">
          <div class="export-logo"></div>
          <span>Copy List</span>
        </div>
      </div>

      <div class="export-preview" id="exportPreview" style="display: none;">
        <h4>Your List (tap to copy):</h4>
        <textarea id="exportText" readonly rows="8"></textarea>
        <button class="form-submit" onclick="copyExportText()"> Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- MEAL PLANNER VIEW -->
  <div class="meal-planner-view" id="mealPlannerView">
    <!-- Tabs for switching between Ideas and Weekly Plan -->
    <div class="meal-tabs">
      <button class="meal-tab active" onclick="switchMealTab('ideas')"> Meal Ideas</button>
      <button class="meal-tab" onclick="switchMealTab('weekly')"> Weekly Plan</button>
    </div>

    <!-- MEAL IDEAS TAB -->
    <div class="meal-tab-content active" id="mealIdeasTab">
      <!-- Meal Type Selector -->
      <div class="meal-type-tabs">
        <button class="meal-type-tab active" data-type="breakfast" onclick="selectMealType('breakfast')"> Breakfast</button>
        <button class="meal-type-tab" data-type="lunch" onclick="selectMealType('lunch')"> Lunch</button>
        <button class="meal-type-tab" data-type="dinner" onclick="selectMealType('dinner')"> Dinner</button>
      </div>

      <div class="meal-ideas-header">
        <button class="smart-meal-btn" onclick="openMealPreferences()"> Preferences</button>
        <button class="smart-meal-btn primary" onclick="generateMealIdeas()"> Generate Ideas</button>
        <button class="smart-meal-btn takeaway-btn" onclick="openTakeawayDeals()"> Takeaway Deals</button>
      </div>

      <!-- Meal Ideas Grid -->
      <div class="meal-ideas-grid" id="mealIdeasGrid">
        <div class="meal-ideas-empty">
          <div class="meal-ideas-empty-icon"></div>
          <p>Tap "Generate Ideas" to get personalized meal suggestions based on your preferences!</p>
        </div>
      </div>

      <!-- Selected Meals Actions -->
      <div class="meal-selection-bar" id="mealSelectionBar" style="display: none;">
        <span id="selectedMealCount">0 meals selected</span>
        <div class="meal-selection-buttons">
          <button class="add-to-plan-btn" onclick="openMealPlanAssignment()">
             Add to Plan
          </button>
          <button class="add-to-list-btn" onclick="openIngredientReview()">
             Add to List
          </button>
        </div>
      </div>
    </div>

    <!-- WEEKLY PLAN TAB -->
    <div class="meal-tab-content" id="mealWeeklyTab">
      <div class="meal-planner-header">
        <button class="calendar-nav-btn" onclick="changeMealWeek(-1)"></button>
        <h3 class="meal-week-title" id="mealWeekTitle">This Week</h3>
        <button class="calendar-nav-btn" onclick="changeMealWeek(1)"></button>
      </div>

      <div class="meal-days" id="mealDays">
        <!-- Days will be rendered here -->
      </div>

      <div class="meal-actions">
        <button class="meal-generate-btn" onclick="generateShoppingFromMeals()">
           Generate Shopping List
        </button>
      </div>
    </div>
  </div>

  <!-- EXPANDED MEAL CARD MODAL -->
  <div class="modal-sheet" id="expandedMealSheet">
    <div class="modal-header">
      <h3 id="expandedMealTitle">Meal Name</h3>
      <button class="modal-close" onclick="closeExpandedMeal()"></button>
    </div>
    <div class="modal-content" id="expandedMealContent">
      <!-- Will be populated dynamically -->
    </div>
  </div>

  <!-- INGREDIENT REVIEW MODAL -->
  <div class="modal-sheet" id="ingredientReviewSheet">
    <div class="modal-header">
      <h3>Review Ingredients</h3>
      <button class="modal-close" onclick="closeIngredientReview()"></button>
    </div>
    <div class="modal-content">
      <p class="pref-description">Uncheck ingredients you already have:</p>
      <div class="ingredient-review-list" id="ingredientReviewList">
        <!-- Ingredients will be listed here -->
      </div>

      <div class="quality-preference">
        <h4>Ingredient Quality</h4>
        <div class="quality-options">
          <label class="quality-option">
            <input type="radio" name="quality" value="budget" checked>
            <span class="quality-label"> Budget (Home Brand)</span>
          </label>
          <label class="quality-option">
            <input type="radio" name="quality" value="standard">
            <span class="quality-label"> Standard (Store Brand)</span>
          </label>
          <label class="quality-option">
            <input type="radio" name="quality" value="premium">
            <span class="quality-label"> Premium Quality</span>
          </label>
        </div>
      </div>

      <button class="form-submit" onclick="addIngredientsWithPricing()">
         Find Best Prices & Add to List
      </button>
    </div>
  </div>

  <!-- MEAL PLAN ASSIGNMENT SHEET -->
  <div class="modal-sheet" id="mealPlanAssignmentSheet">
    <div class="modal-header">
      <h3>Add to Meal Plan</h3>
      <button class="modal-close" onclick="closeMealPlanAssignment()"></button>
    </div>
    <div class="modal-content">
      <p class="pref-description">Assign each meal to a day:</p>
      <div class="meal-assignment-list" id="mealAssignmentList">
        <!-- Meals will be listed here with date pickers -->
      </div>

      <button class="form-submit" onclick="confirmMealPlanAssignment()">
         Add to Meal Plan
      </button>
    </div>
  </div>

  <!-- TAKEAWAY DEALS SHEET -->
  <div class="modal-sheet large" id="takeawayDealsSheet">
    <div class="modal-header">
      <h3> Takeaway Deals Near You</h3>
      <button class="modal-close" onclick="closeTakeawayDeals()"></button>
    </div>
    <div class="modal-content">
      <!-- Filter Section -->
      <div id="takeawayFilters" class="takeaway-filters">
        <div class="filter-row">
          <label>Type:</label>
          <div class="filter-chips">
            <button class="filter-chip active" data-filter="dealType" data-value="all" onclick="setTakeawayFilter('dealType', 'all', this)">All</button>
            <button class="filter-chip" data-filter="dealType" data-value="chains" onclick="setTakeawayFilter('dealType', 'chains', this)"> Big Chains</button>
            <button class="filter-chip" data-filter="dealType" data-value="local" onclick="setTakeawayFilter('dealType', 'local', this)"> Local Only</button>
          </div>
        </div>
        <div class="filter-row">
          <label>Budget:</label>
          <div class="filter-chips">
            <button class="filter-chip active" data-filter="budget" data-value="all" onclick="setTakeawayFilter('budget', 'all', this)">All</button>
            <button class="filter-chip" data-filter="budget" data-value="budget" onclick="setTakeawayFilter('budget', 'budget', this)"> Under $15</button>
            <button class="filter-chip" data-filter="budget" data-value="mid" onclick="setTakeawayFilter('budget', 'mid', this)"> $15-30</button>
            <button class="filter-chip" data-filter="budget" data-value="family" onclick="setTakeawayFilter('budget', 'family', this)"> Family $30+</button>
          </div>
        </div>
        <div class="filter-row">
          <label>Cuisine:</label>
          <div class="filter-chips cuisine-chips">
            <button class="filter-chip cuisine active" data-cuisine="all" onclick="toggleCuisineFilter('all', this)">All</button>
            <button class="filter-chip cuisine" data-cuisine="chicken" onclick="toggleCuisineFilter('chicken', this)"> Chicken</button>
            <button class="filter-chip cuisine" data-cuisine="pizza" onclick="toggleCuisineFilter('pizza', this)"> Pizza</button>
            <button class="filter-chip cuisine" data-cuisine="lebanese" onclick="toggleCuisineFilter('lebanese', this)"> Lebanese</button>
            <button class="filter-chip cuisine" data-cuisine="indian" onclick="toggleCuisineFilter('indian', this)"> Indian</button>
            <button class="filter-chip cuisine" data-cuisine="thai" onclick="toggleCuisineFilter('thai', this)"> Thai</button>
            <button class="filter-chip cuisine" data-cuisine="chinese" onclick="toggleCuisineFilter('chinese', this)"> Chinese</button>
            <button class="filter-chip cuisine" data-cuisine="burgers" onclick="toggleCuisineFilter('burgers', this)"> Burgers</button>
          </div>
        </div>
        <button class="smart-meal-btn primary" onclick="searchTakeawayWithFilters()" style="width: 100%; margin-top: 12px;">
           Search Deals
        </button>
      </div>
      <div id="takeawayDealsContent">
        <div class="takeaway-deals-empty">
          <p>Set your filters and tap "Search Deals"</p>
        </div>
      </div>
    </div>
  </div>

  <!-- STORE SPECIALS SHEET -->
  <div class="modal-sheet large" id="storeSpecialsSheet">
    <div class="modal-header">
      <h3> This Week's Specials</h3>
      <button class="modal-close" onclick="closeStoreSpecials()"></button>
    </div>
    <div class="modal-content">
      <div id="storeSpecialsContent">
        <div class="takeaway-deals-empty">
          <p>Finding specials...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ADHD TASK BREAKDOWN VIEW -->
  <div class="adhd-task-view" id="adhdTaskView">
    <!-- Input Mode -->
    <div class="adhd-input-section" id="adhdInputSection">
      <div class="adhd-header">
        <h3> Task Breakdown</h3>
        <p class="adhd-subtitle">Let's make this manageable</p>
      </div>

      <div class="adhd-input-card">
        <label class="adhd-label">What do you need to do?</label>
        <textarea id="adhdTaskInput" class="adhd-textarea" placeholder="e.g., Clean the house, Do my taxes, Organise the garage..." rows="3"></textarea>
        <button class="adhd-breakdown-btn" onclick="startTaskBreakdown()">
          <span class="btn-icon"></span>
          Break it down for me
        </button>
      </div>

      <div class="adhd-tips">
        <div class="adhd-tip"> Tip: Be as vague or specific as you like - I'll ask questions if I need more info</div>
      </div>

      <!-- Existing Tasks -->
      <div class="adhd-existing-tasks" id="adhdExistingTasks">
        <h4>Your Tasks</h4>
        <div class="adhd-task-list" id="adhdTaskList"></div>
      </div>
    </div>

    <!-- Clarification Mode -->
    <div class="adhd-clarify-section" id="adhdClarifySection" style="display: none;">
      <div class="adhd-clarify-header">
        <button class="adhd-back-btn" onclick="cancelClarification()"> Back</button>
        <h3>Quick Question</h3>
      </div>

      <div class="adhd-clarify-card">
        <p class="adhd-clarify-question" id="clarifyQuestion">What do you mean by "clean"?</p>
        <div class="adhd-clarify-options" id="clarifyOptions">
          <!-- Options will be rendered here -->
        </div>
        <div class="adhd-clarify-custom">
          <input type="text" id="clarifyCustomInput" placeholder="Or type your own answer...">
          <button onclick="submitCustomClarification()"></button>
        </div>
      </div>

      <div class="adhd-clarify-progress">
        <span id="clarifyProgress">Question 1 of 2</span>
      </div>
    </div>

    <!-- Focus Mode -->
    <div class="adhd-focus-section" id="adhdFocusSection" style="display: none;">
      <div class="adhd-focus-header">
        <button class="adhd-back-btn" onclick="exitFocusMode()"> All Tasks</button>
        <h3 id="focusTaskTitle">Task Name</h3>
      </div>

      <div class="adhd-focus-card">
        <div class="adhd-focus-step-label">Just do this one thing:</div>
        <div class="adhd-focus-current-step" id="focusCurrentStep">
          Step text here
        </div>
        <div class="adhd-focus-progress">
          <div class="adhd-focus-progress-bar" id="focusProgressBar"></div>
        </div>
        <div class="adhd-focus-progress-text" id="focusProgressText">Step 1 of 5</div>
      </div>

      <div class="adhd-focus-actions">
        <button class="adhd-done-btn" onclick="completeCurrentStep()">
           Done! Next step
        </button>
        <button class="adhd-skip-btn" onclick="skipCurrentStep()">
          Skip for now
        </button>
      </div>

      <div class="adhd-focus-timer" id="focusTimer" style="display: none;">
        <div class="adhd-timer-text">Just 5 minutes - you can do this!</div>
        <div class="adhd-timer-display" id="timerDisplay">5:00</div>
        <button class="adhd-timer-btn" id="timerBtn" onclick="toggleFocusTimer()">Start Timer</button>
      </div>

      <div class="adhd-focus-all-steps">
        <button class="adhd-show-steps-btn" onclick="toggleAllSteps()">
          <span id="showStepsIcon"></span> Show all steps
        </button>
        <div class="adhd-steps-list" id="focusStepsList" style="display: none;"></div>
      </div>
    </div>

    <!-- Celebration Overlay -->
    <div class="adhd-celebration" id="adhdCelebration" style="display: none;">
      <div class="celebration-content">
        <div class="celebration-emoji" id="celebrationEmoji"></div>
        <div class="celebration-text" id="celebrationText">Amazing! You did it!</div>
      </div>
    </div>
  </div>

  <!-- ADHD Task Clarification Modal -->
  <div class="modal-sheet" id="adhdBreakdownSheet">
    <div class="modal-header">
      <h3>Breaking Down Your Task</h3>
      <button class="modal-close" onclick="closeAdhdBreakdownSheet()"></button>
    </div>
    <div class="modal-content">
      <div class="adhd-loading" id="adhdLoading">
        <div class="adhd-loading-spinner"></div>
        <p>Thinking about the best way to break this down...</p>
      </div>
      <div class="adhd-breakdown-result" id="adhdBreakdownResult" style="display: none;">
        <div class="adhd-breakdown-summary" id="breakdownSummary"></div>
        <div class="adhd-breakdown-steps" id="breakdownSteps"></div>
        <div class="adhd-breakdown-actions">
          <button class="adhd-save-btn" onclick="saveTaskBreakdown()">Save & Start</button>
          <button class="adhd-regenerate-btn" onclick="regenerateBreakdown()">Try Different Approach</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADD MEAL MODAL -->
  <div class="modal-sheet" id="addMealSheet">
    <div class="modal-header">
      <h3>Add Meal</h3>
      <button class="modal-close" onclick="closeAddMealSheet()"></button>
    </div>
    <div class="modal-content">
      <input type="hidden" id="mealDayIndex">
      <input type="hidden" id="mealType">

      <div class="form-field">
        <label>Meal Name</label>
        <input type="text" id="mealName" placeholder="e.g., Spaghetti Bolognese">
      </div>

      <div class="form-field">
        <label>Ingredients (one per line)</label>
        <textarea id="mealIngredients" rows="4" placeholder="500g mince&#10;1 onion&#10;2 cans tomatoes&#10;Pasta"></textarea>
      </div>

      <div class="form-field">
        <label>Notes</label>
        <input type="text" id="mealNotes" placeholder="e.g., Kid-friendly, 30 mins">
      </div>

      <button class="form-submit" onclick="saveMeal()">Save Meal</button>
    </div>
  </div>

  <!-- MEAL PREFERENCES MODAL -->
  <div class="modal-sheet" id="mealPreferencesSheet">
    <div class="modal-header">
      <h3>Meal Preferences</h3>
      <button class="modal-close" onclick="closeMealPreferences()"></button>
    </div>
    <div class="modal-content">
      <!-- Tabs -->
      <div class="pref-tabs">
        <button class="pref-tab active" onclick="switchPrefTab('dislikes')"> Dislikes</button>
        <button class="pref-tab" onclick="switchPrefTab('diet')"> Diet</button>
        <button class="pref-tab" onclick="switchPrefTab('cuisine')"> Cuisine</button>
        <button class="pref-tab" onclick="switchPrefTab('cooking')"> Cooking</button>
        <button class="pref-tab" onclick="switchPrefTab('stores')"> Stores</button>
      </div>

      <!-- Dislikes Tab -->
      <div class="pref-panel active" id="prefDislikes">
        <p class="pref-description">Select ingredients your family doesn't like:</p>

        <div class="pref-category">
          <h4> Vegetables</h4>
          <div class="pref-chips" id="dislikesVeggies"></div>
        </div>

        <div class="pref-category">
          <h4> Spices & Herbs</h4>
          <div class="pref-chips" id="dislikesSpices"></div>
        </div>

        <div class="pref-category">
          <h4> Proteins</h4>
          <div class="pref-chips" id="dislikesProteins"></div>
        </div>

        <div class="pref-category">
          <h4> Dairy & Other</h4>
          <div class="pref-chips" id="dislikesDairy"></div>
        </div>
      </div>

      <!-- Diet Tab -->
      <div class="pref-panel" id="prefDiet">
        <p class="pref-description">Select your dietary preferences:</p>
        <div class="pref-options" id="dietOptions"></div>
      </div>

      <!-- Cuisine Tab -->
      <div class="pref-panel" id="prefCuisine">
        <p class="pref-description">Select cuisines you'd like to explore:</p>
        <p class="pref-subdesc" style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 12px;">Tap multiple to mix cuisines, or leave blank for variety</p>
        <div class="pref-chips cuisine-chips" id="cuisineOptions"></div>
      </div>

      <!-- Cooking Tab -->
      <div class="pref-panel" id="prefCooking">
        <p class="pref-description">Recipe Complexity:</p>
        <div class="pref-options" id="complexityOptions"></div>

        <p class="pref-description" style="margin-top: 20px;">Cooking Method:</p>
        <div class="pref-options" id="cookingMethodOptions"></div>

        <div class="pref-settings-group" style="margin-top: 20px;">
          <div class="pref-setting">
            <label>Servings per Meal</label>
            <div class="stepper">
              <button onclick="adjustSetting('servings', -1)"></button>
              <span id="servingsValue">4</span>
              <button onclick="adjustSetting('servings', 1)">+</button>
            </div>
          </div>

          <div class="pref-setting">
            <label>Max Ingredients</label>
            <div class="stepper">
              <button onclick="adjustSetting('maxIngredients', -1)"></button>
              <span id="maxIngredientsValue">7</span>
              <button onclick="adjustSetting('maxIngredients', 1)">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Stores Tab -->
      <div class="pref-panel" id="prefStores">
        <p class="pref-description">Your location (for local deals & prices):</p>
        <div class="location-input-group">
          <input type="text" id="userSuburb" class="location-input" placeholder="Enter suburb or postcode">
          <button class="location-detect-btn" onclick="detectUserLocation()">
             Detect
          </button>
        </div>
        <p id="locationStatus" class="location-status"></p>

        <p class="pref-description" style="margin-top: 20px;">Preferred store:</p>
        <div class="store-options" id="storeOptions"></div>
      </div>

      <button class="form-submit" onclick="saveMealPreferencesAndClose()">Save Preferences</button>
    </div>
  </div>

  <!-- FLOATING ACTION BUTTON -->
  <!-- UNDO TOAST -->
  <div class="undo-toast" id="undoToast">
    <span class="undo-toast-text">Item removed</span>
    <button class="undo-toast-btn" onclick="undoDelete()">Undo</button>
  </div>

  <!-- FLOATING ACTION BUTTON -->
  <button class="fab" id="fabBtn" onclick="toggleFabMenu()">+</button>

  <div class="fab-menu" id="fabMenu">
    <div class="fab-menu-item" onclick="openAddMemberModal()">
      <span class="icon"></span>
      <span>Add Family Member</span>
    </div>
    <div class="fab-menu-item" onclick="openFormModal('household', 'note')">
      <span class="icon"></span>
      <span>Household Item</span>
    </div>
    <div class="fab-menu-item" onclick="generateWeeklyPlan()">
      <span class="icon"></span>
      <span>Generate Weekly Plan</span>
    </div>
  </div>

  <!-- MODAL OVERLAY -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeAllModals()"></div>

  <!-- PROFILE SHEET -->
  <div class="bottom-sheet" id="profileSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title" id="profileSheetTitle">Profile</h3>
    </div>
    <div class="sheet-content" id="profileSheetContent"></div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeProfileSheet()">Close</button>
    </div>
  </div>

  <!-- FORM SHEET -->
  <div class="bottom-sheet" id="formSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title" id="formSheetTitle">Add Item</h3>
      <p class="sheet-subtitle" id="formSheetSubtitle"></p>
    </div>
    <div class="sheet-content" id="formSheetContent"></div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeFormSheet()">Cancel</button>
      <button class="btn btn-primary" onclick="submitForm()">Save</button>
    </div>
  </div>

  <!-- ADD MEMBER SHEET -->
  <div class="bottom-sheet" id="addMemberSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title">Add Family Member</h3>
    </div>
    <div class="sheet-content">
      <div class="form-group">
        <label class="form-label">Profile Picture</label>
        <div class="profile-pic-upload" onclick="document.getElementById('memberPhoto').click()">
          <div class="profile-pic-preview" id="memberPhotoPreview"></div>
          <div class="profile-pic-upload-text">
            <strong>Tap to upload</strong><br>or use emoji below
          </div>
          <input type="file" class="profile-pic-input" id="memberPhoto" accept="image/*" onchange="handlePhotoUpload(event)">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Name</label>
        <input type="text" class="form-input" id="memberName" placeholder="Enter name">
      </div>
      <div class="form-group">
        <label class="form-label">Role</label>
        <select class="form-select" id="memberRole">
          <option value="adult">Adult</option>
          <option value="child">Child</option>
          <option value="household">Household</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Fallback Icon (emoji)</label>
        <input type="text" class="form-input" id="memberIcon" placeholder="" maxlength="2">
      </div>
      <div class="form-group">
        <label class="form-label">Birthday (optional)</label>
        <input type="date" class="form-input" id="memberBirthday">
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeAddMemberSheet()">Cancel</button>
      <button class="btn btn-primary" onclick="saveMember()">Add Member</button>
    </div>
  </div>

  <!-- SETTINGS SHEET -->
  <div class="bottom-sheet" id="settingsSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title">Settings</h3>
    </div>
    <div class="sheet-content">
      <div class="settings-section">
        <div class="settings-section-title">Appearance</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Dark Mode</div>
            <div class="settings-item-desc">Easier on the eyes at night</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Notifications</div>
            <div class="settings-item-desc" id="notificationStatus">Remind me before appointments</div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="notificationToggle" onchange="toggleNotifications()">
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">Data Management</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Reset Family Data</div>
            <div class="settings-item-desc">Clear all data and start fresh</div>
          </div>
          <button class="btn btn-danger" onclick="confirmResetData()" style="flex:0;">Reset</button>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-section-title">About</div>
        <div class="settings-item">
          <div class="settings-item-info">
            <div class="settings-item-label">Version</div>
          </div>
          <span class="text-muted">1.0.0</span>
        </div>
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
    </div>
  </div>

  <!-- TIMER MODAL -->
  <div class="timer-modal" id="timerModal">
    <div class="timer-content">
      <div class="timer-display" id="timerDisplay">5:00</div>
      <div class="timer-label" id="timerLabel">Focus Time</div>
      <div class="timer-actions">
        <button class="timer-btn pause" id="timerPauseBtn" onclick="toggleTimer()">Pause</button>
        <button class="timer-btn stop" onclick="stopTimer()">Done</button>
      </div>
      <div class="timer-ios-hint">
        On iPhone? <a href="#" id="timerIOSLink">Open in Shortcuts</a>
      </div>
    </div>
  </div>

  <!-- SHARE TASK SHEET -->
  <div class="bottom-sheet" id="shareTaskSheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 class="sheet-title">Share Task</h3>
      <p class="sheet-subtitle" id="shareTaskSubtitle">Assign to another adult</p>
    </div>
    <div class="sheet-content">
      <div class="form-group">
        <label class="form-label">Task Description *</label>
        <input type="text" class="form-input" id="shareTaskTitle" placeholder="e.g., Pick up kids at 3pm">
      </div>
      <div class="form-group">
        <label class="form-label">Assign To *</label>
        <select class="form-select" id="shareTaskAssignee"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Priority</label>
        <select class="form-select" id="shareTaskPriority">
          <option value="normal">Normal</option>
          <option value="urgent">Urgent - Needs action today</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="shareTaskNotes" placeholder="Any extra details..."></textarea>
      </div>
    </div>
    <div class="sheet-actions">
      <button class="btn btn-secondary" onclick="closeShareTaskSheet()">Cancel</button>
      <button class="btn btn-primary" onclick="submitShareTask()">Share</button>
    </div>
  </div>

  <script>
    // ========================================
    // LIFE PAGE - COMPLETE APPLICATION
    // ========================================

    // --- USER IDENTIFICATION ---
    function getCurrentUserId() {
      try {
        const userJson = localStorage.getItem('friction_user');
        if (userJson) {
          const user = JSON.parse(userJson);
          // Use email as unique identifier (simple hash for shorter keys)
          if (user.email) {
            return user.email.split('@')[0].replace(/[^a-z0-9]/gi, '').substring(0, 10);
          }
        }
      } catch (e) {
        console.warn('Could not get user ID:', e);
      }
      return 'default';
    }

    // Get user-specific storage key
    function getUserStorageKey(baseKey) {
      return `${baseKey}_${getCurrentUserId()}`;
    }

    // --- GOOGLE SIGN-IN ---
    const GOOGLE_CLIENT_ID = '37442638167-t8m3fql61v05h01qmvall1bki9k88tim.apps.googleusercontent.com';
    let pendingActionAfterSignIn = null;

    function renderGoogleSignInButton(containerId, actionAfterSignIn) {
      pendingActionAfterSignIn = actionAfterSignIn;

      // Wait for Google API to load
      if (typeof google === 'undefined' || !google.accounts) {
        setTimeout(() => renderGoogleSignInButton(containerId, actionAfterSignIn), 100);
        return;
      }

      const container = document.getElementById(containerId);
      if (!container) return;

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleGoogleSignInCallback
      });

      google.accounts.id.renderButton(container, {
        theme: 'outline',
        size: 'large',
        text: 'signin_with',
        width: 250
      });
    }

    function handleGoogleSignInCallback(response) {
      // Decode the JWT token
      const base64Url = response.credential.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const padded = base64 + '==='.slice((base64.length + 3) % 4);
      const payload = JSON.parse(atob(padded));

      // Store user info
      const user = {
        email: payload.email,
        name: payload.name,
        picture: payload.picture
      };
      localStorage.setItem('friction_user', JSON.stringify(user));
      localStorage.setItem('google_id_token', response.credential);

      // Reload user-specific data
      loadShoppingItems();
      loadMealData();
      loadAdhdTasks();

      showToast('Signed in as ' + user.name);

      // Execute pending action
      if (pendingActionAfterSignIn === 'meals') {
        generateMealIdeas();
      }
      pendingActionAfterSignIn = null;
    }

    // --- STORAGE KEYS ---
    const STORAGE_KEYS = {
      MEMBERS: 'FAMILY_MEMBERS_V1',
      FEED: 'FEED_ITEMS_V1',
      WEEKLY: 'WEEKLY_SUMMARY_V1',
      SETTINGS: 'SETTINGS_V1'
    };

    // --- DEFAULT DATA ---
    // Start empty - user adds their own family members
    const DEFAULT_MEMBERS = [];

    // --- MENU OPTIONS BY ROLE ---
    const MENU_OPTIONS = {
      adult: [
        { action: 'profile', label: 'View Profile', icon: '' },
        { action: 'appointment', label: 'Add Appointment', icon: '' },
        { action: 'roster', label: 'Add Roster', icon: '' },
        { action: 'event', label: 'Add Event', icon: '' },
        { action: 'goal', label: 'Add Goal', icon: '' },
        { action: 'note', label: 'Add Note', icon: '' },
        { action: 'share', label: 'Share Task', icon: '' }
      ],
      child: [
        { action: 'profile', label: 'View Profile', icon: '' },
        { action: 'appointment', label: 'Add Appointment', icon: '' },
        { action: 'milestone', label: 'Add Milestone', icon: '' },
        { action: 'event', label: 'Add Event', icon: '' },
        { action: 'goal', label: 'Add Goal', icon: '' },
        { action: 'note', label: 'Add Photo/Note', icon: '' }
      ],
      household: [
        { action: 'profile', label: 'View Details', icon: '' },
        { action: 'note', label: 'Shared Task', icon: '' },
        { action: 'event', label: 'Shared Event', icon: '' },
        { action: 'weekly', label: 'Weekly Plan', icon: '' }
      ]
    };

    // --- PREP MICRO-STEPS TEMPLATE ---
    const PREP_STEPS = [
      { text: 'Confirm appointment time & location', time: 2 },
      { text: 'Check if any fasting/prep required', time: 1 },
      { text: 'Gather required documents/referrals', time: 3 },
      { text: 'Pack essentials (wallet, phone, snacks)', time: 3 },
      { text: 'Plan travel route & parking', time: 2 },
      { text: 'Set leave-time reminder', time: 1 }
    ];

    const PREP_QUESTIONS = [
      'Any fasting required?',
      'Any forms/referrals needed?',
      'Any special items to bring?'
    ];

    // --- STATE ---
    let familyMembers = [];
    let feedItems = [];
    let currentFormMember = null;
    let currentFormType = null;

    // ========================================
    // PERSISTENCE
    // ========================================
    function loadData() {
      try {
        const membersData = localStorage.getItem(STORAGE_KEYS.MEMBERS);
        const feedData = localStorage.getItem(STORAGE_KEYS.FEED);

        familyMembers = membersData ? JSON.parse(membersData) : [];
        feedItems = feedData ? JSON.parse(feedData) : [];
      } catch (e) {
        console.error('Error loading data:', e);
        familyMembers = [];
        feedItems = [];
      }
    }

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEYS.MEMBERS, JSON.stringify(familyMembers));
        localStorage.setItem(STORAGE_KEYS.FEED, JSON.stringify(feedItems));
      } catch (e) {
        console.error('Error saving data:', e);
      }
    }

    function resetAllData() {
      Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
      familyMembers = [...DEFAULT_MEMBERS];
      feedItems = [];
      saveData();
      renderBubbles();
      renderFeed();
      closeSettings();
    }

    // ========================================
    // UTILITIES
    // ========================================
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function formatTime(timeStr) {
      const [h, m] = timeStr.split(':');
      const hour = parseInt(h);
      const ampm = hour >= 12 ? 'PM' : 'AM';
      const hour12 = hour % 12 || 12;
      return `${hour12}:${m} ${ampm}`;
    }

    function isWithinDays(dateStr, days) {
      const target = new Date(dateStr);
      const now = new Date();
      const diff = (target - now) / (1000 * 60 * 60 * 24);
      return diff >= 0 && diff <= days;
    }

    function getMemberById(id) {
      return familyMembers.find(m => m.id === id);
    }

    // Timer state
    let timerInterval = null;
    let timerSeconds = 0;
    let timerPaused = false;
    let timerMinutes = 5;

    function startTimer(minutes) {
      timerMinutes = minutes;
      const iosUrl = `shortcuts://run-shortcut?name=Start%20Focus%20Timer&input=${minutes}`;

      // Check if likely iOS (for the hint link)
      document.getElementById('timerIOSLink').href = iosUrl;

      // Start web-based timer
      timerSeconds = minutes * 60;
      timerPaused = false;
      updateTimerDisplay();
      document.getElementById('timerPauseBtn').textContent = 'Pause';
      document.getElementById('timerModal').classList.add('active');

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(tickTimer, 1000);
    }

    function tickTimer() {
      if (timerPaused) return;

      timerSeconds--;
      updateTimerDisplay();

      if (timerSeconds <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        document.getElementById('timerDisplay').textContent = "Done!";
        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      }
    }

    function updateTimerDisplay() {
      const mins = Math.floor(timerSeconds / 60);
      const secs = timerSeconds % 60;
      document.getElementById('timerDisplay').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function toggleTimer() {
      timerPaused = !timerPaused;
      document.getElementById('timerPauseBtn').textContent = timerPaused ? 'Resume' : 'Pause';
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      document.getElementById('timerModal').classList.remove('active');
    }

    // Roster photo handling with AI parsing for multiple shifts
    let rosterPhotoData = null;
    let extractedShifts = [];

    async function handleRosterPhoto(event) {
      const file = event.target.files[0];
      if (!file) return;

      const preview = document.getElementById('rosterPhotoPreview');
      preview.classList.add('has-image');
      preview.innerHTML = `
        <img src="${URL.createObjectURL(file)}" alt="Roster" style="max-height: 150px; object-fit: contain;">
        <div class="ai-status"> Analyzing roster... This may take a moment for large schedules.</div>
      `;

      // Convert to base64 for API
      const reader = new FileReader();
      reader.onload = async function(e) {
        rosterPhotoData = e.target.result;

        // Call AI to parse the roster
        try {
          const shifts = await parseRosterImage(rosterPhotoData);
          extractedShifts = shifts || [];

          if (extractedShifts.length > 0) {
            // Show preview of all extracted shifts
            let shiftsHtml = extractedShifts.map((shift, idx) => `
              <div class="extracted-shift" style="display:flex; justify-content:space-between; padding:8px; background:var(--surface); border-radius:8px; margin:4px 0;">
                <span><strong>${shift.date}</strong></span>
                <span>${shift.startTime} - ${shift.endTime}</span>
                <span style="color:var(--text-muted);">${shift.location || ''}</span>
              </div>
            `).join('');

            preview.innerHTML = `
              <div style="max-height: 200px; overflow-y: auto;">
                <div class="ai-status" style="background:#dcfce7;color:#166534; margin-bottom:8px;"> Found ${extractedShifts.length} shifts!</div>
                ${shiftsHtml}
              </div>
              <button class="form-submit" style="margin-top:12px; width:100%;" onclick="addAllExtractedShifts()">
                 Add All ${extractedShifts.length} Shifts to Calendar
              </button>
            `;
          } else {
            preview.innerHTML = `
              <img src="${rosterPhotoData}" alt="Roster" style="max-height: 100px;">
              <div class="ai-status" style="background:#fef3c7;color:#92400e;">No shifts found. Try a clearer image or enter manually.</div>
            `;
          }
        } catch (err) {
          console.error('AI parsing failed:', err);
          preview.innerHTML = `
            <img src="${rosterPhotoData}" alt="Roster" style="max-height: 100px;">
            <div class="ai-status" style="background:#fee2e2;color:#991b1b;">Could not extract shifts: ${err.message}</div>
          `;
        }
      };
      reader.readAsDataURL(file);
    }

    async function parseRosterImage(imageBase64) {
      const idToken = localStorage.getItem('google_id_token');

      if (!idToken) {
        throw new Error('Please sign in to use AI features');
      }

      const base64Data = imageBase64.replace(/^data:image\/\w+;base64,/, '');

      const response = await fetch('/api/roster/extract', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${idToken}`
        },
        body: JSON.stringify({
          imageBase64: base64Data,
          locale: 'en-AU',
          tz: 'Australia/Sydney'
        })
      });

      if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error || 'Failed to parse roster');
      }

      const data = await response.json();
      return data.shifts || [];
    }

    function addAllExtractedShifts() {
      if (extractedShifts.length === 0) {
        alert('No shifts to add');
        return;
      }

      const memberId = currentFormMember;
      if (!memberId) {
        alert('No member selected. Please try again.');
        return;
      }

      let added = 0;

      extractedShifts.forEach(shift => {
        const newItem = {
          id: generateId(),
          type: 'roster',
          memberId: memberId,
          date: shift.date,
          startTime: shift.startTime,
          endTime: shift.endTime,
          location: shift.location || '',
          notes: shift.notes || '',
          createdAt: new Date().toISOString()
        };
        feedItems.push(newItem);
        added++;
      });

      saveData();
      closeFormModal();
      renderFeed();
      renderCalendarView();

      alert(`Added ${added} shifts to the calendar!`);
      extractedShifts = [];
    }

    // Appointment photo handling with AI parsing
    let appointmentPhotoData = null;

    async function handleAppointmentPhoto(event) {
      const file = event.target.files[0];
      if (!file) return;

      const preview = document.getElementById('appointmentPhotoPreview');
      preview.classList.add('has-image');
      preview.innerHTML = `
        <img src="${URL.createObjectURL(file)}" alt="Appointment">
        <div class="ai-status"> Analyzing image...</div>
      `;

      // Convert to base64 for API
      const reader = new FileReader();
      reader.onload = async function(e) {
        appointmentPhotoData = e.target.result;

        // Call AI to parse the image
        try {
          const parsed = await parseAppointmentImage(appointmentPhotoData);
          if (parsed) {
            // Auto-fill the form
            if (parsed.title) document.getElementById('formTitle').value = parsed.title;
            if (parsed.date) document.getElementById('formDate').value = parsed.date;
            if (parsed.time) document.getElementById('formTime').value = parsed.time;
            if (parsed.location) document.getElementById('formLocation').value = parsed.location;
            if (parsed.notes) document.getElementById('formNotes').value = parsed.notes;

            preview.innerHTML = `
              <img src="${appointmentPhotoData}" alt="Appointment">
              <div class="ai-status" style="background:#dcfce7;color:#166534;"> Details extracted!</div>
            `;
          }
        } catch (err) {
          console.error('AI parsing failed:', err);
          preview.innerHTML = `
            <img src="${appointmentPhotoData}" alt="Appointment">
            <div class="ai-status" style="background:#fee2e2;color:#991b1b;">Could not extract details. Please fill manually.</div>
          `;
        }
      };
      reader.readAsDataURL(file);
    }

    // AI parsing function - calls the backend API
    async function parseAppointmentImage(imageBase64) {
      const idToken = localStorage.getItem('google_id_token');

      if (!idToken) {
        console.warn('No auth token - user needs to sign in');
        return null;
      }

      try {
        // Remove data URL prefix if present
        const base64Data = imageBase64.replace(/^data:image\/\w+;base64,/, '');

        const response = await fetch('/api/appointments/extract', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${idToken}`
          },
          body: JSON.stringify({
            imageBase64: base64Data,
            locale: 'en-AU',
            tz: 'Australia/Sydney'
          })
        });

        if (!response.ok) {
          console.error('API error:', response.status);
          return null;
        }

        const data = await response.json();

        if (data.appointment) {
          // Map API response to our form fields
          return {
            title: data.appointment.title || '',
            date: data.appointment.date || '',
            time: data.appointment.time || '',
            location: data.appointment.venueName || data.appointment.address || '',
            notes: data.appointment.notes || ''
          };
        }

        return null;
      } catch (err) {
        console.error('Failed to parse appointment image:', err);
        return null;
      }
    }

    // Location search - opens maps
    function searchLocation() {
      const locationInput = document.getElementById('formLocation');
      const query = locationInput.value.trim();

      if (query) {
        // Open in Google Maps
        const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
        window.open(mapsUrl, '_blank');
      } else {
        // Prompt for location
        const search = prompt('Enter location to search:');
        if (search) {
          locationInput.value = search;
          const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(search)}`;
          window.open(mapsUrl, '_blank');
        }
      }
    }

    // Share appointment via SMS or native share
    function shareAppointment(itemId) {
      const item = feedItems.find(i => i.id === itemId);
      if (!item) return;

      const member = getMemberById(item.memberId);
      const memberName = member?.name || 'Someone';

      // Build share text
      let shareText = ` Appointment: ${item.title}\n`;
      shareText += ` For: ${memberName}\n`;
      shareText += ` Date: ${formatDate(item.date)}\n`;
      shareText += ` Time: ${formatTime(item.time)}\n`;

      if (item.location) {
        shareText += ` Location: ${item.location}\n`;
        shareText += ` Map: https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}\n`;
      }

      if (item.notes) {
        shareText += ` Notes: ${item.notes}\n`;
      }

      // Try native share first (works on mobile)
      if (navigator.share) {
        navigator.share({
          title: `Appointment: ${item.title}`,
          text: shareText
        }).catch(err => {
          // Fallback to SMS if share fails
          openSmsShare(shareText);
        });
      } else {
        // Fallback to SMS on desktop or older browsers
        openSmsShare(shareText);
      }
    }

    function openSmsShare(text) {
      // sms: link works on iOS and Android
      const smsUrl = `sms:?body=${encodeURIComponent(text)}`;
      window.location.href = smsUrl;
    }

    // ========================================
    // BUBBLE RENDERING
    // ========================================
    function renderBubbles() {
      const row = document.getElementById('bubbleRow');
      row.innerHTML = '';

      familyMembers.forEach(member => {
        const wrapper = document.createElement('div');
        wrapper.className = 'bubble-wrapper';

        const bubble = document.createElement('div');
        bubble.className = `bubble type-${member.role}`;
        bubble.dataset.id = member.id;

        // Show photo if available, otherwise show emoji
        if (member.photo) {
          bubble.innerHTML = `<img src="${member.photo}" alt="${member.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
        } else {
          bubble.innerHTML = member.icon;
        }

        const label = document.createElement('div');
        label.className = 'bubble-label';
        label.textContent = member.name;

        const menu = createActionMenu(member);

        wrapper.appendChild(bubble);
        wrapper.appendChild(label);
        wrapper.appendChild(menu);
        row.appendChild(wrapper);

        attachBubbleInteraction(bubble, member);
      });

      // Add "+" bubble for adding members
      const addWrapper = document.createElement('div');
      addWrapper.className = 'bubble-wrapper';
      const addBubble = document.createElement('div');
      addBubble.className = 'bubble bubble-add';
      addBubble.innerHTML = '+';
      addBubble.onclick = openAddMemberModal;
      const addLabel = document.createElement('div');
      addLabel.className = 'bubble-label';
      addLabel.textContent = 'Add';
      addWrapper.appendChild(addBubble);
      addWrapper.appendChild(addLabel);
      row.appendChild(addWrapper);
    }

    function createActionMenu(member) {
      const menu = document.createElement('div');
      menu.className = 'action-menu';
      menu.id = `menu-${member.id}`;

      const options = MENU_OPTIONS[member.role] || MENU_OPTIONS.adult;
      options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'menu-item';
        btn.innerHTML = `<span class="menu-icon">${opt.icon}</span>${opt.label}`;
        btn.onclick = (e) => {
          e.stopPropagation();
          closeAllMenus();
          if (opt.action === 'profile') {
            openProfileSheet(member);
          } else if (opt.action === 'weekly') {
            generateWeeklyPlan();
          } else if (opt.action === 'share') {
            openShareTaskSheet(member.id);
          } else {
            openFormModal(member.id, opt.action);
          }
        };
        menu.appendChild(btn);
      });

      return menu;
    }

    function attachBubbleInteraction(element, member) {
      // Simple tap to open menu
      element.addEventListener('click', (e) => {
        e.stopPropagation();
        const menu = document.getElementById(`menu-${member.id}`);
        const isOpen = menu && menu.classList.contains('visible');

        closeAllMenus();

        if (!isOpen) {
          openMenu(member.id);
        }
      });
    }

    function openMenu(memberId) {
      closeAllMenus();
      const menu = document.getElementById(`menu-${memberId}`);
      const bubble = menu?.parentElement?.querySelector('.bubble');
      if (menu && bubble) {
        const rect = bubble.getBoundingClientRect();
        menu.style.top = (rect.bottom + 10) + 'px';
        menu.style.left = (rect.left + rect.width / 2) + 'px';
        menu.classList.add('visible');
      }
    }

    function closeAllMenus() {
      document.querySelectorAll('.action-menu').forEach(m => m.classList.remove('visible'));
    }

    // ========================================
    // FEED RENDERING
    // ========================================
    function renderFeed() {
      const content = document.getElementById('feedContent');

      if (feedItems.length === 0) {
        const hasMembers = familyMembers.length > 0;
        content.innerHTML = `
          <div class="feed-empty">
            <div class="feed-empty-icon">${hasMembers ? '' : ''}</div>
            <div class="feed-empty-text">
              ${hasMembers
                ? '<strong>All clear!</strong><br>Nothing needs your attention right now.'
                : '<strong>Welcome to Life!</strong><br>Your family command center starts here.'}
            </div>
            <div class="feed-empty-hint">
              ${hasMembers
                ? ' Tap a bubble to quickly add items'
                : ' Tap + to add your first family member'}
            </div>
          </div>
        `;
        return;
      }

      // Sort: pinned first, then by urgency (due within 48h), then by date
      const sorted = [...feedItems].sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;

        const aUrgent = a.date && isWithinDays(a.date, 2);
        const bUrgent = b.date && isWithinDays(b.date, 2);
        if (aUrgent && !bUrgent) return -1;
        if (!aUrgent && bUrgent) return 1;

        return new Date(b.createdAt) - new Date(a.createdAt);
      });

      // Separate pinned and regular
      const pinned = sorted.filter(item => item.pinned);
      const regular = sorted.filter(item => !item.pinned);

      let html = '';

      // Today View - show what's happening today
      const todayCard = renderTodayView();
      if (todayCard) {
        html += todayCard;
      }

      if (pinned.length > 0) {
        html += '<div class="feed-section-title">Pinned</div>';
        pinned.forEach(item => html += renderFeedCard(item));
      }

      if (regular.length > 0) {
        html += '<div class="feed-section-title">Current Focus</div>';
        regular.forEach(item => html += renderFeedCard(item));
      }

      content.innerHTML = html;
    }

    function renderTodayView() {
      const today = new Date().toISOString().split('T')[0];
      const todayItems = feedItems.filter(item => item.date === today && item.type !== 'weekly');

      if (todayItems.length === 0) return '';

      const appointments = todayItems.filter(i => i.type === 'appointment');
      const rosters = todayItems.filter(i => i.type === 'roster');
      const events = todayItems.filter(i => i.type === 'event');

      let itemsHtml = '';

      appointments.forEach(a => {
        const member = getMemberById(a.memberId);
        itemsHtml += `<div class="today-item"> <strong>${formatTime(a.time)}</strong> - ${a.title} (${member?.name || 'Unknown'})</div>`;
      });

      rosters.forEach(r => {
        const member = getMemberById(r.memberId);
        itemsHtml += `<div class="today-item"> <strong>${formatTime(r.startTime)}</strong> - ${member?.name || 'Adult'} working</div>`;
      });

      events.forEach(e => {
        const member = getMemberById(e.memberId);
        itemsHtml += `<div class="today-item"> ${e.time ? `<strong>${formatTime(e.time)}</strong> - ` : ''}${e.title}</div>`;
      });

      return `
        <div class="today-view-card">
          <div class="today-header">
            <span class="today-icon"></span>
            <span class="today-title">Today</span>
            <span class="today-date">${new Date().toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'short' })}</span>
          </div>
          <div class="today-items">
            ${itemsHtml}
          </div>
        </div>
      `;
    }

    function renderFeedCard(item) {
      const member = getMemberById(item.memberId);
      const memberName = member ? member.name : 'Unknown';
      const memberIcon = member ? member.icon : '';

      let cardClass = `feed-card type-${item.type}`;
      if (item.pinned) cardClass += ' pinned';

      let body = '';
      let meta = '';
      let actions = '';
      let microSteps = '';

      switch (item.type) {
        case 'appointment':
          body = item.notes || 'No additional details';
          if (item.location) body = ` <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}" target="_blank" style="color:inherit;text-decoration:underline;">${item.location}</a><br>${body}`;
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
              <span class="card-meta-item"> ${formatTime(item.time)}</span>
            </div>
          `;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn" onclick="shareAppointment('${item.id}')"> Share</button>
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Done</button>
            </div>
          `;
          break;

        case 'prep':
          body = `Prepare for: <strong>${item.relatedTitle}</strong>`;
          microSteps = renderMicroSteps(item);
          break;

        case 'roster':
          body = `${formatTime(item.startTime)} - ${formatTime(item.endTime)}`;
          if (item.location) body += `<br> ${item.location}`;
          if (item.notes) body += `<br>${item.notes}`;
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
            </div>
          `;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Done</button>
            </div>
          `;
          break;

        case 'milestone':
          body = item.notes || 'A special moment!';
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
            </div>
          `;
          break;

        case 'event':
          body = item.notes || '';
          if (item.location) body = ` ${item.location}${body ? '<br>' + body : ''}`;
          meta = `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
              ${item.time ? `<span class="card-meta-item"> ${formatTime(item.time)}</span>` : ''}
            </div>
          `;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Done</button>
            </div>
          `;
          break;

        case 'goal':
          body = item.notes || '';
          if (item.timeframe) body = ` ${item.timeframe}${body ? '<br>' + body : ''}`;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn success" onclick="markDone('${item.id}')"> Achieved</button>
            </div>
          `;
          break;

        case 'note':
          body = item.notes || item.content || '';
          actions = `
            <div class="card-actions">
              <button class="card-action-btn secondary" onclick="markDone('${item.id}')"> Dismiss</button>
            </div>
          `;
          break;

        case 'conflict':
          body = item.description;
          actions = `
            <div class="card-actions">
              <button class="card-action-btn secondary" onclick="markDone('${item.id}')">Resolved</button>
            </div>
          `;
          break;

        case 'weekly':
          body = renderWeeklySummaryContent(item);
          break;

        case 'birthday':
          body = item.notes || '';
          meta = item.date ? `
            <div class="card-meta">
              <span class="card-meta-item"> ${formatDate(item.date)}</span>
            </div>
          ` : '';
          actions = `
            <div class="card-actions">
              <button class="card-action-btn secondary" onclick="markDone('${item.id}')"> Noted</button>
            </div>
          `;
          break;

        default:
          body = item.notes || item.content || '';
      }

      const typeLabels = {
        appointment: ' Appointment',
        prep: ' Prep Needed',
        roster: ' Roster',
        milestone: ' Milestone',
        event: ' Event',
        goal: ' Goal',
        note: ' Note',
        conflict: ' Conflict',
        weekly: ' Weekly Plan',
        birthday: ' Birthday'
      };

      return `
        <div class="${cardClass}" data-id="${item.id}">
          <div class="card-header">
            <span class="card-type-badge">${typeLabels[item.type] || item.type}</span>
            ${item.recurrence ? `<span class="card-recurrence-badge"> ${item.recurrence}</span>` : ''}
            <span class="card-member-badge">${memberIcon} ${memberName}</span>
          </div>
          <div class="card-title">
            ${item.pinned ? '<span class="pin-icon"></span>' : ''}
            ${item.title}
          </div>
          <div class="card-body">${body}</div>
          ${meta}
          ${microSteps}
          ${actions}
        </div>
      `;
    }

    function renderMicroSteps(item) {
      if (!item.steps || item.steps.length === 0) return '';

      const stepsHtml = item.steps.map((step, idx) => {
        const checked = step.done ? 'checked' : '';
        const completed = step.done ? 'completed' : '';
        return `
          <div class="micro-step ${completed}">
            <div class="micro-step-checkbox ${checked}" onclick="toggleStep('${item.id}', ${idx})">
              ${step.done ? '' : ''}
            </div>
            <div class="micro-step-content">
              <div class="micro-step-text">${step.text}</div>
              <div class="micro-step-time">~${step.time} min</div>
            </div>
            <button class="micro-step-timer" onclick="startTimer(${step.time <= 2 ? 3 : step.time})">
              Start ${step.time <= 2 ? 3 : step.time}m
            </button>
          </div>
        `;
      }).join('');

      let questionsHtml = '';
      if (item.questions && item.questions.length > 0) {
        questionsHtml = `
          <div class="open-questions">
            <div class="open-questions-title"> Open Questions</div>
            ${item.questions.map(q => `<div class="open-question-item"> ${q}</div>`).join('')}
          </div>
        `;
      }

      return `
        <div class="micro-steps">
          <div class="micro-steps-title">Micro-Steps</div>
          ${stepsHtml}
        </div>
        ${questionsHtml}
      `;
    }

    function renderWeeklySummaryContent(item) {
      const data = item.summaryData || {};

      return `
        <div class="weekly-summary-section">
          <h4> Week at a Glance</h4>
          <ul>
            ${(data.weekOverview || ['No items scheduled']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Roster Overview</h4>
          <ul>
            ${(data.rosterOverview || ['No roster entries']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Appointments & Events</h4>
          <ul>
            ${(data.appointments || ['None this week']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Prep Tasks Needed</h4>
          <ul>
            ${(data.prepTasks || ['None']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Top 5 Priority Actions</h4>
          <ul>
            ${(data.priorities || ['Review upcoming appointments']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Handoffs & Coordination</h4>
          <ul>
            ${(data.handoffs || ['Check roster for overlaps']).map(i => `<li>${i}</li>`).join('')}
          </ul>

          <h4> Open Questions</h4>
          <ul>
            ${(data.openQuestions || ['Any appointments need confirming?']).map(i => `<li>${i}</li>`).join('')}
          </ul>
        </div>
      `;
    }

    // ========================================
    // FEED ACTIONS
    // ========================================
    let lastDeletedItem = null;
    let undoTimeout = null;

    function markDone(itemId) {
      const item = feedItems.find(i => i.id === itemId);
      if (!item) return;

      // Store for undo
      lastDeletedItem = { ...item };

      // Remove item
      feedItems = feedItems.filter(i => i.id !== itemId);
      saveData();
      renderFeed();

      // Show undo toast
      showUndoToast();
    }

    function showUndoToast() {
      const toast = document.getElementById('undoToast');
      toast.classList.add('visible');

      // Clear any existing timeout
      if (undoTimeout) clearTimeout(undoTimeout);

      // Auto-hide after 5 seconds
      undoTimeout = setTimeout(() => {
        toast.classList.remove('visible');
        lastDeletedItem = null;
      }, 5000);
    }

    function undoDelete() {
      if (lastDeletedItem) {
        feedItems.push(lastDeletedItem);
        saveData();
        renderFeed();
        lastDeletedItem = null;
      }

      // Hide toast
      const toast = document.getElementById('undoToast');
      toast.classList.remove('visible');
      if (undoTimeout) clearTimeout(undoTimeout);
    }

    function toggleStep(itemId, stepIdx) {
      const item = feedItems.find(i => i.id === itemId);
      if (item && item.steps && item.steps[stepIdx]) {
        item.steps[stepIdx].done = !item.steps[stepIdx].done;
        saveData();
        renderFeed();
      }
    }

    // ========================================
    // FORM HANDLING
    // ========================================
    function openFormModal(memberId, formType) {
      currentFormMember = memberId;
      currentFormType = formType;

      const member = getMemberById(memberId);
      const memberName = member ? member.name : 'Unknown';

      const titles = {
        appointment: 'Add Appointment',
        roster: 'Add Roster Entry',
        milestone: 'Add Milestone',
        event: 'Add Event',
        goal: 'Add Goal',
        note: 'Add Note'
      };

      document.getElementById('formSheetTitle').textContent = titles[formType] || 'Add Item';
      document.getElementById('formSheetSubtitle').textContent = `For ${memberName}`;
      document.getElementById('formSheetContent').innerHTML = getFormHtml(formType);

      openModal('formSheet');
    }

    function getFormHtml(type) {
      switch (type) {
        case 'appointment':
          return `
            <div class="screenshot-import-placeholder" onclick="document.getElementById('appointmentPhoto').click()">
              <span class="screenshot-icon"></span>
              <span class="screenshot-text">Upload appointment letter/SMS</span>
              <span class="screenshot-badge">AI Fill</span>
              <input type="file" id="appointmentPhoto" accept="image/*" style="display:none" onchange="handleAppointmentPhoto(event)">
            </div>
            <div id="appointmentPhotoPreview" class="appointment-photo-preview"></div>
            <div class="form-divider">
              <span>or enter manually</span>
            </div>
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., Doctor checkup">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="formDate">
              </div>
              <div class="form-group">
                <label class="form-label">Time *</label>
                <input type="time" class="form-input" id="formTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Location</label>
              <div class="location-input-wrapper">
                <input type="text" class="form-input" id="formLocation" placeholder="e.g., Medical Centre">
                <button type="button" class="location-search-btn" onclick="searchLocation()"></button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Any additional details..."></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Repeat</label>
              <select class="form-select" id="formRecurrence">
                <option value="none">Does not repeat</option>
                <option value="daily">Daily</option>
                <option value="weekly">Weekly</option>
                <option value="fortnightly">Fortnightly</option>
                <option value="monthly">Monthly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
          `;

        case 'roster':
          return `
            <div class="screenshot-import-placeholder" onclick="document.getElementById('rosterPhoto').click()">
              <span class="screenshot-icon"></span>
              <span class="screenshot-text">Upload roster photo (whole month OK!)</span>
              <span class="screenshot-badge">AI Fill</span>
              <input type="file" id="rosterPhoto" accept="image/*" style="display:none" onchange="handleRosterPhoto(event)">
            </div>
            <div id="rosterPhotoPreview" class="appointment-photo-preview"></div>
            <div class="form-divider">
              <span>or enter single shift manually</span>
            </div>
            <div class="form-group">
              <label class="form-label">Date *</label>
              <input type="date" class="form-input" id="formDate">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Start Time *</label>
                <input type="time" class="form-input" id="formStartTime">
              </div>
              <div class="form-group">
                <label class="form-label">End Time *</label>
                <input type="time" class="form-input" id="formEndTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Location / Ward</label>
              <input type="text" class="form-input" id="formLocation" placeholder="e.g., Ward 2B">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Any notes..."></textarea>
            </div>
          `;

        case 'milestone':
          return `
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., First steps!">
            </div>
            <div class="form-group">
              <label class="form-label">Date *</label>
              <input type="date" class="form-input" id="formDate">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Describe this special moment..."></textarea>
            </div>
          `;

        case 'event':
          return `
            <div class="form-group">
              <label class="form-label">Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., Birthday party">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Date *</label>
                <input type="date" class="form-input" id="formDate">
              </div>
              <div class="form-group">
                <label class="form-label">Time</label>
                <input type="time" class="form-input" id="formTime">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Location</label>
              <input type="text" class="form-input" id="formLocation" placeholder="e.g., Park">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Details..."></textarea>
            </div>
          `;

        case 'goal':
          return `
            <div class="form-group">
              <label class="form-label">Goal Title *</label>
              <input type="text" class="form-input" id="formTitle" placeholder="e.g., Learn to ride a bike">
            </div>
            <div class="form-group">
              <label class="form-label">Timeframe</label>
              <input type="text" class="form-input" id="formTimeframe" placeholder="e.g., By end of summer">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Details about this goal..."></textarea>
            </div>
          `;

        case 'note':
          return `
            <div class="form-group">
              <label class="form-label">Title</label>
              <input type="text" class="form-input" id="formTitle" placeholder="Quick title (optional)">
            </div>
            <div class="form-group">
              <label class="form-label">Note *</label>
              <textarea class="form-textarea" id="formNotes" placeholder="Write your note..." style="min-height: 120px;"></textarea>
            </div>
          `;

        default:
          return '<p>Form not available</p>';
      }
    }

    function submitForm() {
      const titleEl = document.getElementById('formTitle');
      const dateEl = document.getElementById('formDate');
      const timeEl = document.getElementById('formTime');
      const startTimeEl = document.getElementById('formStartTime');
      const endTimeEl = document.getElementById('formEndTime');
      const locationEl = document.getElementById('formLocation');
      const notesEl = document.getElementById('formNotes');
      const timeframeEl = document.getElementById('formTimeframe');
      const recurrenceEl = document.getElementById('formRecurrence');

      const title = titleEl?.value?.trim();
      const date = dateEl?.value;
      const time = timeEl?.value;
      const startTime = startTimeEl?.value;
      const endTime = endTimeEl?.value;
      const location = locationEl?.value?.trim();
      const notes = notesEl?.value?.trim();
      const timeframe = timeframeEl?.value?.trim();
      const recurrence = recurrenceEl?.value || 'none';

      // Validation
      if (currentFormType === 'appointment' && (!title || !date || !time)) {
        alert('Please fill in Title, Date, and Time');
        return;
      }
      if (currentFormType === 'roster' && (!date || !startTime || !endTime)) {
        alert('Please fill in Date, Start Time, and End Time');
        return;
      }
      if (currentFormType === 'milestone' && (!title || !date)) {
        alert('Please fill in Title and Date');
        return;
      }
      if (currentFormType === 'event' && (!title || !date)) {
        alert('Please fill in Title and Date');
        return;
      }
      if (currentFormType === 'goal' && !title) {
        alert('Please fill in Goal Title');
        return;
      }
      if (currentFormType === 'note' && !notes) {
        alert('Please write a note');
        return;
      }

      // Create feed item
      const newItem = {
        id: generateId(),
        memberId: currentFormMember,
        type: currentFormType,
        title: title || (currentFormType === 'roster' ? 'Shift' : 'Note'),
        createdAt: new Date().toISOString(),
        date,
        time,
        startTime,
        endTime,
        location,
        notes,
        timeframe,
        recurrence: recurrence !== 'none' ? recurrence : null
      };

      feedItems.push(newItem);

      // Generate recurring items if recurrence is set
      if (recurrence !== 'none' && date) {
        generateRecurringItems(newItem, recurrence);
      }

      // Auto-create prep card for appointments within 7 days
      if (currentFormType === 'appointment' && date && isWithinDays(date, 7)) {
        const prepItem = {
          id: generateId(),
          memberId: currentFormMember,
          type: 'prep',
          title: `Prep: ${title}`,
          relatedTitle: title,
          relatedId: newItem.id,
          createdAt: new Date().toISOString(),
          date: date,
          steps: PREP_STEPS.map(s => ({ ...s, done: false })),
          questions: [...PREP_QUESTIONS]
        };
        feedItems.push(prepItem);
      }

      // Check for roster conflicts
      if (currentFormType === 'roster') {
        checkRosterConflicts(newItem);
      }

      saveData();
      closeFormSheet();
      renderFeed();
    }

    function generateRecurringItems(baseItem, recurrence) {
      const baseDate = new Date(baseItem.date);
      const maxItems = 12; // Generate up to 12 future occurrences

      for (let i = 1; i <= maxItems; i++) {
        const nextDate = new Date(baseDate);

        switch (recurrence) {
          case 'daily':
            nextDate.setDate(baseDate.getDate() + i);
            break;
          case 'weekly':
            nextDate.setDate(baseDate.getDate() + (i * 7));
            break;
          case 'fortnightly':
            nextDate.setDate(baseDate.getDate() + (i * 14));
            break;
          case 'monthly':
            nextDate.setMonth(baseDate.getMonth() + i);
            break;
          case 'yearly':
            nextDate.setFullYear(baseDate.getFullYear() + i);
            break;
        }

        // Only create items up to 90 days in the future (except yearly)
        const now = new Date();
        const daysAhead = (nextDate - now) / (1000 * 60 * 60 * 24);
        if (recurrence !== 'yearly' && daysAhead > 90) break;
        if (recurrence === 'yearly' && daysAhead > 400) break;

        const recurringItem = {
          id: generateId(),
          memberId: baseItem.memberId,
          type: baseItem.type,
          title: baseItem.title,
          createdAt: new Date().toISOString(),
          date: nextDate.toISOString().split('T')[0],
          time: baseItem.time,
          startTime: baseItem.startTime,
          endTime: baseItem.endTime,
          location: baseItem.location,
          notes: baseItem.notes,
          recurrence: recurrence,
          parentId: baseItem.id,
          isRecurring: true
        };

        feedItems.push(recurringItem);

        // Also create prep items for recurring appointments
        if (baseItem.type === 'appointment' && isWithinDays(recurringItem.date, 7)) {
          const prepItem = {
            id: generateId(),
            memberId: baseItem.memberId,
            type: 'prep',
            title: `Prep: ${baseItem.title}`,
            relatedTitle: baseItem.title,
            relatedId: recurringItem.id,
            createdAt: new Date().toISOString(),
            date: recurringItem.date,
            steps: PREP_STEPS.map(s => ({ ...s, done: false })),
            questions: [...PREP_QUESTIONS]
          };
          feedItems.push(prepItem);
        }
      }
    }

    function checkRosterConflicts(newRoster) {
      const sameDayRosters = feedItems.filter(item =>
        item.type === 'roster' &&
        item.date === newRoster.date &&
        item.id !== newRoster.id &&
        item.memberId !== newRoster.memberId
      );

      sameDayRosters.forEach(otherRoster => {
        // Check time overlap
        const newStart = newRoster.startTime;
        const newEnd = newRoster.endTime;
        const otherStart = otherRoster.startTime;
        const otherEnd = otherRoster.endTime;

        const overlap = (newStart < otherEnd && newEnd > otherStart);

        if (overlap) {
          const member1 = getMemberById(newRoster.memberId)?.name || 'Adult 1';
          const member2 = getMemberById(otherRoster.memberId)?.name || 'Adult 2';

          const conflictItem = {
            id: generateId(),
            memberId: 'household',
            type: 'conflict',
            title: ' Roster Overlap Detected',
            description: `${member1} and ${member2} both have shifts on ${formatDate(newRoster.date)}. Handoff coordination needed!`,
            createdAt: new Date().toISOString(),
            date: newRoster.date
          };

          feedItems.push(conflictItem);
        }
      });
    }

    // ========================================
    // WEEKLY PLAN GENERATION
    // ========================================
    function generateWeeklyPlan() {
      closeFabMenu();

      // Remove existing weekly summary
      feedItems = feedItems.filter(item => item.type !== 'weekly');

      // Gather data for the week
      const now = new Date();
      const weekEnd = new Date(now);
      weekEnd.setDate(weekEnd.getDate() + 7);

      const thisWeekItems = feedItems.filter(item => {
        if (!item.date) return false;
        const d = new Date(item.date);
        return d >= now && d <= weekEnd;
      });

      const appointments = thisWeekItems.filter(i => i.type === 'appointment');
      const rosters = thisWeekItems.filter(i => i.type === 'roster');
      const events = thisWeekItems.filter(i => i.type === 'event');
      const preps = feedItems.filter(i => i.type === 'prep');

      // Build summary data
      const summaryData = {
        weekOverview: [],
        rosterOverview: [],
        appointments: [],
        prepTasks: [],
        priorities: [],
        handoffs: [],
        openQuestions: []
      };

      // Week overview
      summaryData.weekOverview.push(`${appointments.length} appointment(s) scheduled`);
      summaryData.weekOverview.push(`${rosters.length} roster shift(s)`);
      summaryData.weekOverview.push(`${events.length} event(s)`);

      // Roster overview
      rosters.forEach(r => {
        const member = getMemberById(r.memberId);
        summaryData.rosterOverview.push(
          `${member?.name || 'Adult'}: ${formatDate(r.date)} ${formatTime(r.startTime)}-${formatTime(r.endTime)}`
        );
      });
      if (summaryData.rosterOverview.length === 0) {
        summaryData.rosterOverview.push('No roster entries this week');
      }

      // Appointments
      appointments.forEach(a => {
        const member = getMemberById(a.memberId);
        summaryData.appointments.push(
          `${member?.name || 'Member'}: ${a.title} on ${formatDate(a.date)}`
        );
      });
      events.forEach(e => {
        summaryData.appointments.push(`Event: ${e.title} on ${formatDate(e.date)}`);
      });
      if (summaryData.appointments.length === 0) {
        summaryData.appointments.push('None scheduled');
      }

      // Prep tasks
      preps.forEach(p => {
        const incomplete = p.steps?.filter(s => !s.done).length || 0;
        if (incomplete > 0) {
          summaryData.prepTasks.push(`${p.title}: ${incomplete} steps remaining`);
        }
      });
      if (summaryData.prepTasks.length === 0) {
        summaryData.prepTasks.push('All prep complete!');
      }

      // Priorities
      if (appointments.length > 0) {
        summaryData.priorities.push('Confirm all appointment times');
      }
      if (preps.length > 0) {
        summaryData.priorities.push('Complete prep checklists');
      }
      summaryData.priorities.push('Check roster for handoff needs');
      summaryData.priorities.push('Plan meals for the week');
      summaryData.priorities.push('Review family calendar together');

      // Handoffs
      const rosterDates = [...new Set(rosters.map(r => r.date))];
      rosterDates.forEach(date => {
        const dayRosters = rosters.filter(r => r.date === date);
        if (dayRosters.length > 1) {
          summaryData.handoffs.push(`${formatDate(date)}: Multiple adults working - coordinate handoff`);
        }
      });
      if (summaryData.handoffs.length === 0) {
        summaryData.handoffs.push('No handoff conflicts detected');
      }

      // Open Questions (max 5)
      if (appointments.length > 0) {
        summaryData.openQuestions.push('Any appointments need confirming or rescheduling?');
      }
      if (rosters.length > 0) {
        summaryData.openQuestions.push('Are all roster shifts finalized?');
      }
      const children = familyMembers.filter(m => m.role === 'child');
      if (children.length > 0) {
        summaryData.openQuestions.push('Any childcare arrangements needed?');
      }
      if (events.length > 0) {
        summaryData.openQuestions.push('Any event prep or RSVPs outstanding?');
      }
      summaryData.openQuestions.push('What could derail this week?');
      // Limit to 5
      summaryData.openQuestions = summaryData.openQuestions.slice(0, 5);

      // Create weekly summary item
      const weeklyItem = {
        id: generateId(),
        memberId: 'household',
        type: 'weekly',
        title: "This Week's Family Plan",
        pinned: true,
        createdAt: new Date().toISOString(),
        summaryData
      };

      feedItems.unshift(weeklyItem);
      saveData();
      renderFeed();

      // Scroll to top
      document.getElementById('feedLayer').scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========================================
    // MEMBER MANAGEMENT
    // ========================================
    let memberPhotoData = null;

    function openAddMemberModal() {
      closeFabMenu();
      closeAllMenus();
      document.getElementById('memberName').value = '';
      document.getElementById('memberRole').value = 'adult';
      document.getElementById('memberIcon').value = '';
      document.getElementById('memberBirthday').value = '';
      document.getElementById('memberPhoto').value = '';
      document.getElementById('memberPhotoPreview').innerHTML = '';
      memberPhotoData = null;
      openModal('addMemberSheet');
    }

    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (max 10MB before compression)
      if (file.size > 10000000) {
        alert('Image too large. Please use an image under 10MB.');
        return;
      }

      // Compress and resize the image
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          // Create canvas for compression
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');

          // Resize to max 400x400 for profile pics
          const maxSize = 400;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > maxSize) {
              height = Math.round(height * maxSize / width);
              width = maxSize;
            }
          } else {
            if (height > maxSize) {
              width = Math.round(width * maxSize / height);
              height = maxSize;
            }
          }

          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);

          // Compress to JPEG at 80% quality
          memberPhotoData = canvas.toDataURL('image/jpeg', 0.8);
          document.getElementById('memberPhotoPreview').innerHTML =
            `<img src="${memberPhotoData}" alt="Profile">`;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function saveMember() {
      const name = document.getElementById('memberName').value.trim();
      const role = document.getElementById('memberRole').value;
      let icon = document.getElementById('memberIcon').value.trim();
      const birthday = document.getElementById('memberBirthday').value;

      if (!name) {
        alert('Please enter a name');
        return;
      }

      if (!icon) {
        icon = role === 'child' ? '' : role === 'household' ? '' : '';
      }

      const newMember = {
        id: generateId(),
        name,
        role,
        icon,
        photo: memberPhotoData || null,
        birthday: birthday || null
      };

      // Insert before household
      const householdIdx = familyMembers.findIndex(m => m.role === 'household');
      if (householdIdx >= 0) {
        familyMembers.splice(householdIdx, 0, newMember);
      } else {
        familyMembers.push(newMember);
      }

      saveData();
      closeAddMemberSheet();
      renderBubbles();
    }

    // ========================================
    // PROFILE SHEET
    // ========================================
    function openProfileSheet(member) {
      closeAllMenus();

      document.getElementById('profileSheetTitle').textContent = `${member.name}'s Profile`;

      const memberItems = feedItems.filter(item => item.memberId === member.id);
      const appointments = memberItems.filter(i => i.type === 'appointment').length;
      const rosters = memberItems.filter(i => i.type === 'roster').length;
      const milestones = memberItems.filter(i => i.type === 'milestone').length;
      const goals = memberItems.filter(i => i.type === 'goal').length;

      const avatarContent = member.photo
        ? `<img src="${member.photo}" alt="${member.name}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
        : member.icon;

      let statsHtml = `
        <div class="profile-header">
          <div class="profile-avatar type-${member.role}">${avatarContent}</div>
          <div class="profile-info">
            <h2>${member.name}</h2>
            <div class="profile-role">${member.role}</div>
          </div>
        </div>
        <div class="profile-section">
          <div class="profile-section-title">Stats</div>
          <div class="profile-item">
            <span class="profile-item-label">Appointments</span>
            <span class="profile-item-value">${appointments}</span>
          </div>
      `;

      if (member.role === 'adult') {
        statsHtml += `
          <div class="profile-item">
            <span class="profile-item-label">Roster Entries</span>
            <span class="profile-item-value">${rosters}</span>
          </div>
        `;
      }

      if (member.role === 'child') {
        statsHtml += `
          <div class="profile-item">
            <span class="profile-item-label">Milestones</span>
            <span class="profile-item-value">${milestones}</span>
          </div>
        `;
      }

      statsHtml += `
          <div class="profile-item">
            <span class="profile-item-label">Goals</span>
            <span class="profile-item-value">${goals}</span>
          </div>
        </div>
      `;

      // Show recent items
      if (memberItems.length > 0) {
        const recent = memberItems.slice(0, 3);
        statsHtml += `
          <div class="profile-section">
            <div class="profile-section-title">Recent Items</div>
            ${recent.map(item => `
              <div class="profile-item">
                <span class="profile-item-label">${item.title}</span>
                <span class="profile-item-value text-muted">${item.type}</span>
              </div>
            `).join('')}
          </div>
        `;
      }

      document.getElementById('profileSheetContent').innerHTML = statsHtml;
      openModal('profileSheet');
    }

    // ========================================
    // MODAL MANAGEMENT
    // ========================================
    function openModal(sheetId) {
      // Close all other modals first
      document.querySelectorAll('.modal-sheet, .bottom-sheet').forEach(sheet => {
        sheet.classList.remove('open');
      });
      document.getElementById('modalOverlay').classList.add('open');
      document.getElementById(sheetId).classList.add('open');
    }

    function closeAllModals() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.querySelectorAll('.modal-sheet, .bottom-sheet').forEach(sheet => {
        sheet.classList.remove('open');
      });
      closeFabMenu();
    }

    function closeProfileSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('profileSheet').classList.remove('open');
    }

    function closeFormSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('formSheet').classList.remove('open');
      currentFormMember = null;
      currentFormType = null;
    }

    function closeAddMemberSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('addMemberSheet').classList.remove('open');
    }

    function openSettings() {
      openModal('settingsSheet');
    }

    function closeSettings() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('settingsSheet').classList.remove('open');
    }

    // Dark Mode Functions
    function toggleDarkMode() {
      const isDark = document.getElementById('darkModeToggle').checked;
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      localStorage.setItem('LIFE_DARK_MODE', isDark ? 'true' : 'false');
    }

    function initDarkMode() {
      const savedPref = localStorage.getItem('LIFE_DARK_MODE');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedPref === 'true' || (savedPref === null && prefersDark);

      if (isDark) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('darkModeToggle').checked = true;
      }
    }

    // Notification Functions
    let notificationTimers = [];

    async function toggleNotifications() {
      const toggle = document.getElementById('notificationToggle');
      const status = document.getElementById('notificationStatus');

      if (toggle.checked) {
        // Request permission
        if (!('Notification' in window)) {
          status.textContent = 'Not supported in this browser';
          toggle.checked = false;
          return;
        }

        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
          localStorage.setItem('LIFE_NOTIFICATIONS', 'true');
          status.textContent = 'Notifications enabled ';
          scheduleNotifications();
        } else {
          toggle.checked = false;
          status.textContent = 'Permission denied';
        }
      } else {
        localStorage.setItem('LIFE_NOTIFICATIONS', 'false');
        status.textContent = 'Remind me before appointments';
        clearScheduledNotifications();
      }
    }

    function initNotifications() {
      const enabled = localStorage.getItem('LIFE_NOTIFICATIONS') === 'true';
      const toggle = document.getElementById('notificationToggle');
      const status = document.getElementById('notificationStatus');

      if (enabled && Notification.permission === 'granted') {
        toggle.checked = true;
        status.textContent = 'Notifications enabled ';
        scheduleNotifications();
      } else if (enabled && Notification.permission !== 'granted') {
        localStorage.setItem('LIFE_NOTIFICATIONS', 'false');
      }
    }

    function scheduleNotifications() {
      clearScheduledNotifications();

      const now = new Date();
      const todayStr = now.toISOString().split('T')[0];

      // Find appointments for today and tomorrow
      const upcomingItems = feedItems.filter(item => {
        if (item.type !== 'appointment' || !item.date || !item.time) return false;
        const itemDate = new Date(item.date + 'T' + item.time);
        const diffMs = itemDate - now;
        // Within next 24 hours
        return diffMs > 0 && diffMs < 24 * 60 * 60 * 1000;
      });

      upcomingItems.forEach(item => {
        const itemDate = new Date(item.date + 'T' + item.time);
        const member = getMemberById(item.memberId);

        // Schedule 1 hour before
        const oneHourBefore = itemDate.getTime() - (60 * 60 * 1000);
        const msUntilOneHour = oneHourBefore - now.getTime();

        if (msUntilOneHour > 0) {
          const timer = setTimeout(() => {
            showNotification(
              `${item.title} in 1 hour`,
              `${member?.name || 'Appointment'} at ${formatTime(item.time)}${item.location ? ' - ' + item.location : ''}`
            );
          }, msUntilOneHour);
          notificationTimers.push(timer);
        }

        // Schedule 15 minutes before
        const fifteenMinBefore = itemDate.getTime() - (15 * 60 * 1000);
        const msUntilFifteen = fifteenMinBefore - now.getTime();

        if (msUntilFifteen > 0) {
          const timer = setTimeout(() => {
            showNotification(
              `${item.title} in 15 minutes!`,
              `Time to go! ${item.location ? ' ' + item.location : ''}`
            );
          }, msUntilFifteen);
          notificationTimers.push(timer);
        }
      });
    }

    function clearScheduledNotifications() {
      notificationTimers.forEach(timer => clearTimeout(timer));
      notificationTimers = [];
    }

    function showNotification(title, body) {
      if (Notification.permission === 'granted') {
        const notification = new Notification(title, {
          body: body,
          icon: '',
          badge: '',
          tag: 'life-reminder',
          requireInteraction: true
        });

        notification.onclick = () => {
          window.focus();
          notification.close();
        };
      }
    }

    // ========================================
    // CALENDAR VIEW FUNCTIONS
    // ========================================
    let currentCalendarYear = new Date().getFullYear();
    let currentCalendarMonth = new Date().getMonth();
    let selectedCalendarDate = null;
    let calendarVisible = false;

    function toggleCalendarView() {
      // Close other views first
      if (shoppingVisible) toggleShoppingView();
      if (mealPlannerVisible) toggleMealPlannerView();
      if (adhdTaskViewVisible) toggleAdhdTaskView();

      calendarVisible = !calendarVisible;
      const calendarView = document.getElementById('calendarView');
      const calendarBtn = document.getElementById('calendarToggleBtn');

      if (calendarVisible) {
        calendarView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        calendarBtn.innerHTML = '';
        calendarBtn.title = 'Show Feed';
        calendarBtn.style.background = 'var(--adult)';
        calendarBtn.style.color = 'white';
        renderCalendar();
      } else {
        calendarView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        calendarBtn.innerHTML = '';
        calendarBtn.title = 'Calendar View';
        calendarBtn.style.background = '';
        calendarBtn.style.color = '';
      }
    }

    function renderCalendar() {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

      // Update title
      document.getElementById('calendarMonthTitle').textContent =
        `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';

      // Get first day of month and total days
      const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
      const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
      const totalDays = lastDay.getDate();

      // Get day of week for first day (0=Sun, adjust for Mon start)
      let startDayOfWeek = firstDay.getDay();
      startDayOfWeek = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1; // Convert to Mon=0

      // Today's date for highlighting
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      // Add empty cells for days before first of month
      for (let i = 0; i < startDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        grid.appendChild(emptyDay);
      }

      // Add days of month
      for (let day = 1; day <= totalDays; day++) {
        const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = day;

        // Check if today
        if (dateStr === todayStr) {
          dayEl.classList.add('today');
        }

        // Check if selected
        if (dateStr === selectedCalendarDate) {
          dayEl.classList.add('selected');
        }

        // Check if has events
        const events = getEventsForDate(dateStr);
        if (events.length > 0) {
          dayEl.classList.add('has-events');
          // Add event type indicator
          const hasAppointment = events.some(e => e.type === 'appointment');
          const hasTask = events.some(e => e.type === 'task' || e.type === 'prep');
          if (hasAppointment) dayEl.classList.add('has-appointment');
          if (hasTask) dayEl.classList.add('has-task');
        }

        dayEl.onclick = () => selectDay(dateStr);
        grid.appendChild(dayEl);
      }

      // Clear day detail if no date selected
      if (!selectedCalendarDate) {
        document.getElementById('calendarDayDetail').innerHTML = '';
      }
    }

    function changeMonth(delta) {
      currentCalendarMonth += delta;
      if (currentCalendarMonth > 11) {
        currentCalendarMonth = 0;
        currentCalendarYear++;
      } else if (currentCalendarMonth < 0) {
        currentCalendarMonth = 11;
        currentCalendarYear--;
      }
      selectedCalendarDate = null;
      renderCalendar();
    }

    function selectDay(dateStr) {
      selectedCalendarDate = dateStr;
      renderCalendar();

      const events = getEventsForDate(dateStr);
      const detailEl = document.getElementById('calendarDayDetail');

      // Format date for display
      const dateObj = new Date(dateStr + 'T00:00:00');
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      const formattedDate = dateObj.toLocaleDateString('en-AU', options);

      if (events.length === 0) {
        detailEl.innerHTML = `
          <div class="calendar-detail-header">
            <h4>${formattedDate}</h4>
          </div>
          <div class="calendar-no-events">No events scheduled</div>
        `;
      } else {
        detailEl.innerHTML = `
          <div class="calendar-detail-header">
            <h4>${formattedDate}</h4>
            <span class="calendar-event-count">${events.length} event${events.length > 1 ? 's' : ''}</span>
          </div>
          <div class="calendar-events-list">
            ${events.map(event => {
              const member = getMemberById(event.memberId);
              const timeStr = event.time ? formatTime(event.time) : '';
              const typeIcon = event.type === 'appointment' ? '' : event.type === 'prep' ? '' : '';
              return `
                <div class="calendar-event-item ${event.type}">
                  <div class="calendar-event-icon">${typeIcon}</div>
                  <div class="calendar-event-content">
                    <div class="calendar-event-title">${event.title}</div>
                    <div class="calendar-event-meta">
                      ${timeStr ? `<span>${timeStr}</span>` : ''}
                      ${member ? `<span>${member.icon} ${member.name}</span>` : ''}
                      ${event.location ? `<span> ${event.location}</span>` : ''}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
    }

    function getEventsForDate(dateStr) {
      return feedItems.filter(item => {
        if (!item.date) return false;
        return item.date === dateStr;
      }).sort((a, b) => {
        // Sort by time
        if (a.time && b.time) return a.time.localeCompare(b.time);
        if (a.time) return -1;
        if (b.time) return 1;
        return 0;
      });
    }

    // ========================================
    // SHOPPING LIST FUNCTIONS
    // ========================================
    let shoppingItems = [];
    let shoppingVisible = false;

    function loadShoppingItems() {
      shoppingItems = JSON.parse(localStorage.getItem(getUserStorageKey('life_shopping')) || '[]');
    }

    function saveShoppingItems() {
      localStorage.setItem(getUserStorageKey('life_shopping'), JSON.stringify(shoppingItems));
    }

    const categoryInfo = {
      produce: { icon: '', name: 'Produce' },
      dairy: { icon: '', name: 'Dairy' },
      meat: { icon: '', name: 'Meat' },
      bakery: { icon: '', name: 'Bakery' },
      pantry: { icon: '', name: 'Pantry' },
      frozen: { icon: '', name: 'Frozen' },
      drinks: { icon: '', name: 'Drinks' },
      household: { icon: '', name: 'Household' },
      other: { icon: '', name: 'Other' }
    };

    function toggleShoppingView() {
      // Close other views first
      if (calendarVisible) toggleCalendarView();
      if (mealPlannerVisible) toggleMealPlannerView();
      if (adhdTaskViewVisible) toggleAdhdTaskView();

      shoppingVisible = !shoppingVisible;
      const shoppingView = document.getElementById('shoppingView');
      const shoppingBtn = document.getElementById('shoppingToggleBtn');

      if (shoppingVisible) {
        shoppingView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        shoppingBtn.style.background = 'var(--adult)';
        shoppingBtn.style.color = 'white';
        renderShoppingList();
      } else {
        shoppingView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        shoppingBtn.style.background = '';
        shoppingBtn.style.color = '';
      }
    }

    function renderShoppingList() {
      const container = document.getElementById('shoppingCategories');

      if (shoppingItems.length === 0) {
        container.innerHTML = `
          <div class="shopping-empty">
            <div class="shopping-empty-icon"></div>
            <div>Your shopping list is empty</div>
            <div style="font-size: 0.85rem; margin-top: 8px;">Add items above or generate from meal plans</div>
          </div>
        `;
        updateShoppingSummary();
        return;
      }

      // Group items by category
      const grouped = {};
      shoppingItems.forEach(item => {
        if (!grouped[item.category]) grouped[item.category] = [];
        grouped[item.category].push(item);
      });

      // Render categories in order
      const categoryOrder = ['produce', 'dairy', 'meat', 'bakery', 'pantry', 'frozen', 'drinks', 'household', 'other'];
      let html = '';

      categoryOrder.forEach(cat => {
        if (!grouped[cat] || grouped[cat].length === 0) return;

        const info = categoryInfo[cat];
        const items = grouped[cat];

        html += `
          <div class="shopping-category">
            <div class="shopping-category-header">
              <span class="shopping-category-icon">${info.icon}</span>
              <span>${info.name}</span>
              <span style="color: var(--text-muted); font-weight: normal;">(${items.length})</span>
            </div>
            ${items.map(item => `
              <div class="shopping-item ${item.completed ? 'completed' : ''}" data-id="${item.id}">
                <div class="shopping-checkbox ${item.completed ? 'checked' : ''}" onclick="toggleShoppingItem('${item.id}')">
                  ${item.completed ? '' : ''}
                </div>
                <span class="shopping-item-name">${item.name}</span>
                <button class="shopping-item-delete" onclick="deleteShoppingItem('${item.id}')"></button>
              </div>
            `).join('')}
          </div>
        `;
      });

      container.innerHTML = html;
      updateShoppingSummary();
    }

    function updateShoppingSummary() {
      const total = shoppingItems.length;
      const completed = shoppingItems.filter(i => i.completed).length;
      document.querySelector('.shopping-count').textContent = `${total} item${total !== 1 ? 's' : ''}`;
      document.querySelector('.shopping-completed').textContent = `${completed} completed`;
    }

    function addShoppingItem() {
      const input = document.getElementById('shoppingInput');
      const category = document.getElementById('shoppingCategory').value;
      const name = input.value.trim();

      if (!name) return;

      const newItem = {
        id: 'shop_' + Date.now(),
        name: name,
        category: category,
        completed: false,
        createdAt: new Date().toISOString()
      };

      shoppingItems.push(newItem);
      saveShoppingList();
      renderShoppingList();
      input.value = '';
      input.focus();
    }

    function handleShoppingKeypress(event) {
      if (event.key === 'Enter') {
        addShoppingItem();
      }
    }

    function toggleShoppingItem(id) {
      const item = shoppingItems.find(i => i.id === id);
      if (item) {
        item.completed = !item.completed;
        saveShoppingList();
        renderShoppingList();
      }
    }

    function deleteShoppingItem(id) {
      shoppingItems = shoppingItems.filter(i => i.id !== id);
      saveShoppingList();
      renderShoppingList();
    }

    function clearCompletedItems() {
      const completed = shoppingItems.filter(i => i.completed).length;
      if (completed === 0) {
        alert('No completed items to clear');
        return;
      }
      if (confirm(`Clear ${completed} completed item${completed !== 1 ? 's' : ''}?`)) {
        shoppingItems = shoppingItems.filter(i => !i.completed);
        saveShoppingList();
        renderShoppingList();
      }
    }

    function saveShoppingList() {
      localStorage.setItem(getUserStorageKey('life_shopping'), JSON.stringify(shoppingItems));
    }

    // ========================================
    // PRICE COMPARISON & EXPORT
    // ========================================
    async function comparePrices() {
      if (shoppingItems.length === 0) {
        alert('Add items to your shopping list first!');
        return;
      }

      openModal('priceCompareSheet');
      document.getElementById('priceLoading').style.display = 'block';
      document.getElementById('priceResults').style.display = 'none';

      try {
        // Try API call first (Perplexity integration)
        const response = await fetch('/api/prices/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            items: shoppingItems.filter(i => !i.completed).map(i => i.name),
            stores: mealPreferences?.stores || ['woolworths', 'coles']
          })
        });

        if (response.ok) {
          const data = await response.json();
          renderPriceResults(data);
        } else {
          renderMockPriceResults();
        }
      } catch (error) {
        console.error('Price comparison failed:', error);
        renderMockPriceResults();
      }
    }

    function renderMockPriceResults() {
      // Generate mock price data for demo
      const items = shoppingItems.filter(i => !i.completed);
      const stores = [
        { id: 'woolworths', name: 'Woolworths', letter: 'W' },
        { id: 'coles', name: 'Coles', letter: 'C' },
        { id: 'aldi', name: 'Aldi', letter: 'A' },
        { id: 'costco', name: 'Costco', letter: 'Co' }
      ].filter(s => (mealPreferences?.stores || ['woolworths', 'coles']).includes(s.id));

      const results = stores.map(store => {
        const storeItems = items.map(item => ({
          name: item.name,
          price: (Math.random() * 8 + 2).toFixed(2),
          onSpecial: Math.random() > 0.7
        }));
        const total = storeItems.reduce((sum, i) => sum + parseFloat(i.price), 0);
        return { ...store, items: storeItems, total: total.toFixed(2) };
      });

      // Sort by total price
      results.sort((a, b) => parseFloat(a.total) - parseFloat(b.total));
      results[0].cheapest = true;

      renderPriceResults({ stores: results });
    }

    function renderPriceResults(data) {
      document.getElementById('priceLoading').style.display = 'none';
      const container = document.getElementById('priceResults');
      container.style.display = 'block';

      container.innerHTML = data.stores.map(store => `
        <div class="price-store-card">
          <div class="price-store-header">
            <div class="store-logo ${store.id}">${store.letter}</div>
            <div class="store-name">${store.name}</div>
            ${store.cheapest ? '<span class="price-store-badge">CHEAPEST</span>' : ''}
            <div class="price-store-total">$${store.total}</div>
          </div>
          ${store.items.map(item => `
            <div class="price-item-row">
              <span class="price-item-name">${item.name}</span>
              <span class="price-item-price ${item.onSpecial ? 'on-special' : ''}">
                $${item.price} ${item.onSpecial ? '' : ''}
              </span>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    function closePriceCompare() {
      document.getElementById('priceCompareSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function openExportOptions() {
      if (shoppingItems.length === 0) {
        alert('Add items to your shopping list first!');
        return;
      }
      openModal('exportSheet');
      document.getElementById('exportPreview').style.display = 'none';

      // Show native share button if Web Share API is supported
      const nativeShareBtn = document.getElementById('nativeShareBtn');
      if (navigator.share) {
        nativeShareBtn.style.display = 'flex';
      } else {
        nativeShareBtn.style.display = 'none';
      }

      // Populate store options - show preferred store first with prominent styling
      const storeContainer = document.getElementById('storeExportOptions');
      const preferredStore = mealPreferences.preferredStore || 'woolworths';
      const allStores = [
        { id: 'woolworths', name: 'Woolworths', letter: 'W' },
        { id: 'coles', name: 'Coles', letter: 'C' },
        { id: 'aldi', name: 'Aldi', letter: 'A' },
        { id: 'costco', name: 'Costco', letter: 'Co' }
      ];

      // Put preferred store first
      const sortedStores = allStores.sort((a, b) => {
        if (a.id === preferredStore) return -1;
        if (b.id === preferredStore) return 1;
        return 0;
      });

      storeContainer.innerHTML = sortedStores.map(store => `
        <div class="export-option ${store.id === preferredStore ? 'preferred' : ''}"
           onclick="openStoreAndCopyList('${store.id}')">
          <div class="store-logo ${store.id}">${store.letter}</div>
          <span>${store.name}${store.id === preferredStore ? ' (Your Store)' : ''}</span>
        </div>
      `).join('');
    }

    function openStoreAndCopyList(storeName) {
      const store = STORE_URLS[storeName];
      if (!store) return;

      // Get shopping items
      const items = shoppingItems.filter(i => !i.completed);
      if (items.length === 0) {
        showToast('No items to shop for!');
        return;
      }

      // Format list for easy reading while shopping
      const storeFriendlyName = storeName.charAt(0).toUpperCase() + storeName.slice(1);
      const listText = items.map(i => {
        let name = i.name.replace(/^\d+\s*(g|kg|ml|L|cups?|tbsp|tsp|bunch|head|cloves?)\s+/i, '').trim();
        name = convertToGenericBrand(name, storeName);
        return name;
      }).join('\n');

      // Copy to clipboard
      navigator.clipboard.writeText(listText).then(() => {
        showToast(`${items.length} items copied to clipboard!`);
        closeExportSheet();

        // Open store homepage
        window.open(store.base, '_blank');
      }).catch(() => {
        // Fallback - show the list to manually copy
        showExportPreview(`Shopping List for ${storeFriendlyName}:\n\n${listText}`);
      });
    }

    function convertToGenericBrand(itemName, targetStore) {
      // Brand mappings - convert store brands to generic or target store equivalent
      const brandMappings = {
        // Coles brands
        "coles": { generic: "", alternatives: { woolworths: "woolworths", aldi: "" } },
        "coles finest": { generic: "", alternatives: { woolworths: "woolworths gold", aldi: "" } },

        // Woolworths brands
        "woolworths": { generic: "", alternatives: { coles: "coles", aldi: "" } },
        "woolworths gold": { generic: "", alternatives: { coles: "coles finest", aldi: "" } },
        "macro": { generic: "organic", alternatives: {} },

        // Common brand alternatives that exist everywhere
        "leggo's": { generic: "leggo's", alternatives: {} },
        "dolmio": { generic: "dolmio", alternatives: {} },
        "san remo": { generic: "san remo", alternatives: {} }
      };

      let result = itemName.toLowerCase();

      for (const [brand, mapping] of Object.entries(brandMappings)) {
        if (result.includes(brand)) {
          // Check if there's an alternative for the target store
          const alt = mapping.alternatives[targetStore];
          if (alt !== undefined) {
            result = result.replace(brand, alt).trim();
          } else {
            // Use generic
            result = result.replace(brand, mapping.generic).trim();
          }
        }
      }

      // Clean up double spaces
      result = result.replace(/\s+/g, ' ').trim();

      // Capitalize first letter
      return result.charAt(0).toUpperCase() + result.slice(1);
    }

    // Native share to any app (mobile)
    async function shareNative() {
      const items = shoppingItems.filter(i => !i.completed);
      if (items.length === 0) {
        showToast('No items to share');
        return;
      }

      // Build shopping list text
      const grouped = {};
      items.forEach(item => {
        const cat = item.category || 'other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item.name);
      });

      let text = 'SHOPPING LIST\n';
      text += ''.repeat(20) + '\n\n';

      Object.keys(grouped).forEach(cat => {
        const info = categoryInfo[cat] || { icon: '', name: cat };
        text += `${info.icon} ${info.name.toUpperCase()}\n`;
        grouped[cat].forEach(item => {
          text += `   ${item}\n`;
        });
        text += '\n';
      });

      text += `\nTotal: ${items.length} items`;

      try {
        await navigator.share({
          title: 'Shopping List',
          text: text
        });
        closeExportSheet();
        showToast('Shared successfully!');
      } catch (err) {
        if (err.name !== 'AbortError') {
          showToast('Sharing failed - try copy instead');
        }
      }
    }

    function closeExportSheet() {
      document.getElementById('exportSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function exportForStore(storeName) {
      const items = shoppingItems.filter(i => !i.completed);
      let text = `Shopping List for ${storeName.charAt(0).toUpperCase() + storeName.slice(1)}:\n\n`;
      items.forEach(item => {
        text += ` ${item.name}\n`;
      });
      text += `\n---\nGenerated by Life Assistant`;
      showExportPreview(text);
    }

    // Store website URLs for direct shopping
    const STORE_URLS = {
      woolworths: {
        base: 'https://www.woolworths.com.au',
        search: 'https://www.woolworths.com.au/shop/search/products?searchTerm='
      },
      coles: {
        base: 'https://www.coles.com.au',
        search: 'https://www.coles.com.au/search?q='
      },
      aldi: {
        base: 'https://www.aldi.com.au',
        search: 'https://www.aldi.com.au/en/search/?text='
      },
      costco: {
        base: 'https://www.costco.com.au',
        search: 'https://www.costco.com.au/search?text='
      }
    };

    function openStoreWebsite(storeName) {
      const store = STORE_URLS[storeName];
      if (!store) {
        showToast('Store not supported');
        return;
      }

      // Refresh shopping items from localStorage
      shoppingItems = JSON.parse(localStorage.getItem(getUserStorageKey('life_shopping')) || '[]');
      const items = shoppingItems.filter(i => !i.completed);

      console.log('Opening store with items:', items);

      if (items.length === 0) {
        showToast('Add items to your shopping list first!');
        window.open(store.base, '_blank');
        return;
      }

      // Get product names with brands
      const productNames = items.map(i => {
        // Remove quantity patterns like "500g", "2 cups", etc at the start
        let name = i.name.replace(/^\d+\s*(g|kg|ml|L|cups?|tbsp|tsp|bunch|head|cloves?)\s+/i, '').trim();

        // If we have brand info from pricing, include it
        if (i.brand && !name.toLowerCase().includes(i.brand.toLowerCase())) {
          name = i.brand + ' ' + name;
        }

        return name;
      });

      // Join all items for search (space-separated works for most stores)
      const searchQuery = productNames.join(' ');
      const searchUrl = store.search + encodeURIComponent(searchQuery);

      console.log('Search URL:', searchUrl);
      showToast(`Opening ${storeName.charAt(0).toUpperCase() + storeName.slice(1)} with ${items.length} items...`);

      window.open(searchUrl, '_blank');
      closeExportSheet();
    }

    function exportForApp(appName) {
      const items = shoppingItems.filter(i => !i.completed);
      let text = '';

      if (appName === 'doordash' || appName === 'ubereats') {
        text = items.map(i => i.name).join('\n');
        text += '\n\n(Copy each item to search in the app)';
      }

      showExportPreview(text);
    }

    function exportPlainText() {
      const items = shoppingItems.filter(i => !i.completed);
      const grouped = {};

      items.forEach(item => {
        if (!grouped[item.category]) grouped[item.category] = [];
        grouped[item.category].push(item.name);
      });

      let text = 'SHOPPING LIST\n';
      text += '='.repeat(20) + '\n\n';

      Object.keys(grouped).forEach(cat => {
        const info = categoryInfo[cat] || { icon: '', name: cat };
        text += `${info.icon} ${info.name.toUpperCase()}\n`;
        grouped[cat].forEach(item => {
          text += `   ${item}\n`;
        });
        text += '\n';
      });

      showExportPreview(text);
    }

    function showExportPreview(text) {
      document.getElementById('exportPreview').style.display = 'block';
      document.getElementById('exportText').value = text;
    }

    function copyExportText() {
      const text = document.getElementById('exportText').value;
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
      }).catch(() => {
        // Fallback for older browsers
        document.getElementById('exportText').select();
        document.execCommand('copy');
        alert('Copied to clipboard!');
      });
    }

    // ========================================
    // MEAL PLANNER FUNCTIONS
    // ========================================
    let mealPlan = {};
    let mealPlannerVisible = false;
    let mealWeekOffset = 0;

    // Meal Preferences Data
    const DEFAULT_MEAL_PREFS = {
      dislikes: [],
      diet: 'none',
      cuisines: [],
      location: '',
      locationCoords: null,
      budget: 150,
      servings: 4,
      maxIngredients: 7,
      mealsPerDay: 3,
      preferredStore: 'woolworths',
      complexity: 'any',
      cookingMethod: 'any'
    };
    let mealPreferences = { ...DEFAULT_MEAL_PREFS };

    function loadMealData() {
      mealPlan = JSON.parse(localStorage.getItem(getUserStorageKey('life_meals')) || '{}');
      mealPreferences = JSON.parse(localStorage.getItem(getUserStorageKey('life_meal_prefs')) || JSON.stringify(DEFAULT_MEAL_PREFS));

      // Migration: convert old stores array to preferredStore
      if (mealPreferences.stores && !mealPreferences.preferredStore) {
        mealPreferences.preferredStore = mealPreferences.stores[0] || 'woolworths';
        delete mealPreferences.stores;
        saveMealPreferences();
      }
    }

    function saveMealPlan() {
      localStorage.setItem(getUserStorageKey('life_meals'), JSON.stringify(mealPlan));
    }

    function saveMealPreferences() {
      localStorage.setItem(getUserStorageKey('life_meal_prefs'), JSON.stringify(mealPreferences));
    }

    // Recipe Complexity Options
    const COMPLEXITY_OPTIONS = [
      { id: 'any', icon: '', title: 'Any Complexity', desc: 'Mix of easy and complex' },
      { id: 'quick', icon: '', title: 'Quick & Easy', desc: 'Jar sauces, pre-made mixes, minimal prep' },
      { id: 'intermediate', icon: '', title: 'Intermediate', desc: 'Some from scratch, some shortcuts' },
      { id: 'scratch', icon: '', title: 'From Scratch', desc: 'All homemade, no pre-made sauces' }
    ];

    // Cooking Method Options
    const COOKING_METHOD_OPTIONS = [
      { id: 'any', icon: '', title: 'Any Method', desc: 'All cooking styles' },
      { id: 'stovetop', icon: '', title: 'Stovetop', desc: 'Pan-fried, stir-fry, boiled' },
      { id: 'oven', icon: '', title: 'Oven Baked', desc: 'Roasted, baked, grilled' },
      { id: 'slowcooker', icon: '', title: 'Slow Cooker', desc: 'Set and forget meals' },
      { id: 'airfryer', icon: '', title: 'Air Fryer', desc: 'Quick crispy cooking' },
      { id: 'bbq', icon: '', title: 'BBQ / Grill', desc: 'Outdoor cooking' },
      { id: 'nocook', icon: '', title: 'No Cook', desc: 'Salads, sandwiches, cold meals' }
    ];

    const INGREDIENT_OPTIONS = {
      veggies: ['Onion', 'Garlic', 'Capsicum', 'Mushrooms', 'Tomato', 'Spinach', 'Broccoli', 'Carrot', 'Zucchini', 'Eggplant', 'Celery', 'Peas', 'Corn', 'Beans', 'Cabbage', 'Cauliflower', 'Asparagus', 'Kale'],
      spices: ['Coriander', 'Cumin', 'Chilli', 'Ginger', 'Turmeric', 'Paprika', 'Oregano', 'Basil', 'Thyme', 'Rosemary', 'Cinnamon', 'Nutmeg', 'Curry', 'Fennel'],
      proteins: ['Beef', 'Pork', 'Lamb', 'Chicken', 'Fish', 'Prawns', 'Tofu', 'Eggs', 'Bacon', 'Sausages'],
      dairy: ['Milk', 'Cheese', 'Cream', 'Yoghurt', 'Butter', 'Sour Cream']
    };

    const DIET_OPTIONS = [
      { id: 'none', icon: '', title: 'No Restrictions', desc: 'All foods welcome' },
      { id: 'vegetarian', icon: '', title: 'Vegetarian', desc: 'No meat or fish' },
      { id: 'vegan', icon: '', title: 'Vegan', desc: 'No animal products' },
      { id: 'keto', icon: '', title: 'Keto', desc: 'Low carb, high fat' },
      { id: 'glutenfree', icon: '', title: 'Gluten-Free', desc: 'No wheat, barley, rye' },
      { id: 'dairyfree', icon: '', title: 'Dairy-Free', desc: 'No milk products' },
      { id: 'halal', icon: '', title: 'Halal', desc: 'Islamic dietary laws' },
      { id: 'kosher', icon: '', title: 'Kosher', desc: 'Jewish dietary laws' }
    ];

    // Cuisine Options - Celebrating Australia's multicultural food scene!
    const CUISINE_OPTIONS = [
      { id: 'australian', icon: '', name: 'Aussie Classics' },
      { id: 'italian', icon: '', name: 'Italian' },
      { id: 'chinese', icon: '', name: 'Chinese' },
      { id: 'indian', icon: '', name: 'Indian' },
      { id: 'thai', icon: '', name: 'Thai' },
      { id: 'vietnamese', icon: '', name: 'Vietnamese' },
      { id: 'japanese', icon: '', name: 'Japanese' },
      { id: 'korean', icon: '', name: 'Korean' },
      { id: 'mexican', icon: '', name: 'Mexican' },
      { id: 'greek', icon: '', name: 'Greek' },
      { id: 'lebanese', icon: '', name: 'Lebanese' },
      { id: 'middleeastern', icon: '', name: 'Middle Eastern' },
      { id: 'turkish', icon: '', name: 'Turkish' },
      { id: 'moroccan', icon: '', name: 'Moroccan' },
      { id: 'spanish', icon: '', name: 'Spanish' },
      { id: 'french', icon: '', name: 'French' },
      { id: 'american', icon: '', name: 'American' },
      { id: 'british', icon: '', name: 'British' },
      { id: 'filipino', icon: '', name: 'Filipino' },
      { id: 'indonesian', icon: '', name: 'Indonesian' },
      { id: 'malaysian', icon: '', name: 'Malaysian' },
      { id: 'sri_lankan', icon: '', name: 'Sri Lankan' },
      { id: 'nepalese', icon: '', name: 'Nepalese' },
      { id: 'ethiopian', icon: '', name: 'Ethiopian' },
      { id: 'caribbean', icon: '', name: 'Caribbean' },
      { id: 'brazilian', icon: '', name: 'Brazilian' },
      { id: 'german', icon: '', name: 'German' },
      { id: 'polish', icon: '', name: 'Polish' },
      { id: 'portuguese', icon: '', name: 'Portuguese' }
    ];

    const STORE_OPTIONS = [
      { id: 'woolworths', name: 'Woolworths', letter: 'W' },
      { id: 'coles', name: 'Coles', letter: 'C' },
      { id: 'aldi', name: 'Aldi', letter: 'A' },
      { id: 'costco', name: 'Costco', letter: 'Co' }
    ];

    function openMealPreferences() {
      openModal('mealPreferencesSheet');
      renderMealPreferences();
    }

    function closeMealPreferences() {
      document.getElementById('mealPreferencesSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function renderMealPreferences() {
      // Render dislikes chips
      ['veggies', 'spices', 'proteins', 'dairy'].forEach(category => {
        const container = document.getElementById(`dislikes${category.charAt(0).toUpperCase() + category.slice(1)}`);
        container.innerHTML = INGREDIENT_OPTIONS[category].map(item => `
          <div class="pref-chip ${mealPreferences.dislikes.includes(item) ? 'selected' : ''}"
               onclick="toggleDislike('${item}')">
            ${item}
          </div>
        `).join('');
      });

      // Render diet options
      const dietContainer = document.getElementById('dietOptions');
      dietContainer.innerHTML = DIET_OPTIONS.map(opt => `
        <div class="pref-option ${mealPreferences.diet === opt.id ? 'selected' : ''}"
             onclick="selectDiet('${opt.id}')">
          <div class="pref-option-icon">${opt.icon}</div>
          <div class="pref-option-text">
            <div class="pref-option-title">${opt.title}</div>
            <div class="pref-option-desc">${opt.desc}</div>
          </div>
          ${mealPreferences.diet === opt.id ? '<span class="store-check"></span>' : ''}
        </div>
      `).join('');

      // Render cuisine options (multi-select chips)
      const cuisineContainer = document.getElementById('cuisineOptions');
      if (cuisineContainer) {
        const selectedCuisines = mealPreferences.cuisines || [];
        cuisineContainer.innerHTML = CUISINE_OPTIONS.map(cuisine => `
          <div class="pref-chip cuisine-chip ${selectedCuisines.includes(cuisine.id) ? 'selected' : ''}"
               onclick="toggleCuisine('${cuisine.id}')">
            <span class="cuisine-icon">${cuisine.icon}</span>
            <span class="cuisine-name">${cuisine.name}</span>
          </div>
        `).join('');
      }

      // Render store options (single select - pick your preferred store)
      const storeContainer = document.getElementById('storeOptions');
      storeContainer.innerHTML = STORE_OPTIONS.map(store => `
        <div class="store-option ${mealPreferences.preferredStore === store.id ? 'selected' : ''}"
             onclick="selectStore('${store.id}')">
          <div class="store-logo ${store.id}">${store.letter}</div>
          <div class="store-name">${store.name}</div>
          ${mealPreferences.preferredStore === store.id ? '<span class="store-check"></span>' : ''}
        </div>
      `).join('');

      // Render complexity options
      const complexityContainer = document.getElementById('complexityOptions');
      if (complexityContainer) {
        complexityContainer.innerHTML = COMPLEXITY_OPTIONS.map(opt => `
          <div class="pref-option ${mealPreferences.complexity === opt.id ? 'selected' : ''}"
               onclick="selectComplexity('${opt.id}')">
            <div class="pref-option-icon">${opt.icon}</div>
            <div class="pref-option-text">
              <div class="pref-option-title">${opt.title}</div>
              <div class="pref-option-desc">${opt.desc}</div>
            </div>
            ${mealPreferences.complexity === opt.id ? '<span class="store-check"></span>' : ''}
          </div>
        `).join('');
      }

      // Render cooking method options
      const cookingMethodContainer = document.getElementById('cookingMethodOptions');
      if (cookingMethodContainer) {
        cookingMethodContainer.innerHTML = COOKING_METHOD_OPTIONS.map(opt => `
          <div class="pref-option ${mealPreferences.cookingMethod === opt.id ? 'selected' : ''}"
               onclick="selectCookingMethod('${opt.id}')">
            <div class="pref-option-icon">${opt.icon}</div>
            <div class="pref-option-text">
              <div class="pref-option-title">${opt.title}</div>
              <div class="pref-option-desc">${opt.desc}</div>
            </div>
            ${mealPreferences.cookingMethod === opt.id ? '<span class="store-check"></span>' : ''}
          </div>
        `).join('');
      }

      // Update settings values
      document.getElementById('servingsValue').textContent = mealPreferences.servings;
      document.getElementById('maxIngredientsValue').textContent = mealPreferences.maxIngredients;

      // Update location input
      const locationInput = document.getElementById('userSuburb');
      if (locationInput && mealPreferences.location) {
        locationInput.value = mealPreferences.location;
      }
    }

    function switchPrefTab(tabName) {
      document.querySelectorAll('.pref-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.pref-panel').forEach(p => p.classList.remove('active'));

      event.target.classList.add('active');
      document.getElementById(`pref${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    }

    function toggleDislike(item) {
      const idx = mealPreferences.dislikes.indexOf(item);
      if (idx > -1) {
        mealPreferences.dislikes.splice(idx, 1);
      } else {
        mealPreferences.dislikes.push(item);
      }
      renderMealPreferences();
    }

    function selectDiet(dietId) {
      mealPreferences.diet = dietId;
      renderMealPreferences();
    }

    function toggleCuisine(cuisineId) {
      if (!mealPreferences.cuisines) {
        mealPreferences.cuisines = [];
      }
      const idx = mealPreferences.cuisines.indexOf(cuisineId);
      if (idx > -1) {
        mealPreferences.cuisines.splice(idx, 1);
      } else {
        mealPreferences.cuisines.push(cuisineId);
      }
      renderMealPreferences();
    }

    function selectComplexity(complexityId) {
      mealPreferences.complexity = complexityId;
      renderMealPreferences();
    }

    function selectCookingMethod(methodId) {
      mealPreferences.cookingMethod = methodId;
      renderMealPreferences();
    }

    function selectStore(storeId) {
      mealPreferences.preferredStore = storeId;
      renderMealPreferences();
    }

    function adjustSetting(setting, delta) {
      const limits = {
        servings: { min: 1, max: 10 },
        maxIngredients: { min: 3, max: 15 },
        mealsPerDay: { min: 1, max: 5 }
      };

      mealPreferences[setting] = Math.min(limits[setting].max,
        Math.max(limits[setting].min, mealPreferences[setting] + delta));

      document.getElementById(`${setting}Value`).textContent = mealPreferences[setting];
    }

    async function detectUserLocation() {
      const statusEl = document.getElementById('locationStatus');
      const inputEl = document.getElementById('userSuburb');
      const btnEl = document.querySelector('.location-detect-btn');

      if (!navigator.geolocation) {
        statusEl.textContent = 'Location not supported by your browser';
        statusEl.className = 'location-status error';
        return;
      }

      // Show loading state
      btnEl.disabled = true;
      btnEl.textContent = ' Detecting...';
      statusEl.textContent = 'Getting your location...';
      statusEl.className = 'location-status';

      try {
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: false,
            timeout: 10000,
            maximumAge: 300000 // 5 min cache
          });
        });

        const { latitude, longitude } = position.coords;
        mealPreferences.locationCoords = { lat: latitude, lng: longitude };

        // Reverse geocode using OpenStreetMap Nominatim (free, no API key needed)
        statusEl.textContent = 'Finding your suburb...';

        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&addressdetails=1`,
          { headers: { 'Accept-Language': 'en' } }
        );

        if (!response.ok) throw new Error('Geocoding failed');

        const data = await response.json();
        const address = data.address || {};

        // Try to get suburb, then city, then town
        const suburb = address.suburb || address.city_district || address.city ||
                       address.town || address.municipality || address.county || '';
        const postcode = address.postcode || '';
        const state = address.state || '';

        let locationText = suburb;
        if (postcode) locationText += ` ${postcode}`;
        if (state && !locationText.includes(state)) locationText += `, ${state}`;

        inputEl.value = locationText.trim();
        mealPreferences.location = locationText.trim();

        statusEl.textContent = `Found: ${locationText}`;
        statusEl.className = 'location-status success';

      } catch (error) {
        console.error('Location error:', error);
        let errorMsg = 'Could not detect location';
        if (error.code === 1) errorMsg = 'Location access denied. Please enter manually.';
        else if (error.code === 2) errorMsg = 'Location unavailable. Please enter manually.';
        else if (error.code === 3) errorMsg = 'Location timeout. Please enter manually.';

        statusEl.textContent = errorMsg;
        statusEl.className = 'location-status error';
      } finally {
        btnEl.disabled = false;
        btnEl.textContent = ' Detect';
      }
    }

    function saveMealPreferencesAndClose() {
      mealPreferences.budget = parseInt(document.getElementById('mealBudget').value) || 150;

      // Save location
      const locationInput = document.getElementById('userSuburb');
      if (locationInput) {
        mealPreferences.location = locationInput.value.trim();
      }

      saveMealPreferences();
      closeMealPreferences();
      showToast('Preferences saved!');
    }

    // AI Meal Generation
    async function generateAIMeals() {
      const loadingHTML = `
        <div class="ai-loading-overlay" id="aiLoadingOverlay">
          <div class="ai-loading-card">
            <div class="ai-loading-spinner"></div>
            <h3>Creating Your Meal Plan</h3>
            <p>Considering your preferences...</p>
          </div>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', loadingHTML);

      try {
        const prompt = buildMealPrompt();
        const response = await fetch('/api/meals/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt, preferences: mealPreferences })
        });

        if (response.ok) {
          const data = await response.json();
          applyGeneratedMeals(data.meals);
        } else {
          // Fallback to local generation
          const meals = generateLocalMeals();
          applyGeneratedMeals(meals);
        }
      } catch (error) {
        console.error('AI meal generation failed:', error);
        const meals = generateLocalMeals();
        applyGeneratedMeals(meals);
      }

      document.getElementById('aiLoadingOverlay')?.remove();
    }

    function buildMealPrompt() {
      const prefs = mealPreferences;
      let prompt = `Generate a week of meals for a family with these requirements:\n`;
      prompt += `- Budget: $${prefs.budget}/week\n`;
      prompt += `- Servings per meal: ${prefs.servings}\n`;
      prompt += `- Max ingredients per meal: ${prefs.maxIngredients}\n`;
      if (prefs.diet !== 'none') prompt += `- Diet: ${prefs.diet}\n`;
      if (prefs.dislikes.length > 0) prompt += `- Avoid these ingredients: ${prefs.dislikes.join(', ')}\n`;
      return prompt;
    }

    function generateLocalMeals() {
      const mealDatabase = [
        { name: 'Spaghetti Bolognese', ingredients: ['Mince', 'Pasta', 'Tomatoes', 'Onion', 'Garlic'], tags: ['glutenfree-no'] },
        { name: 'Chicken Stir Fry', ingredients: ['Chicken', 'Rice', 'Capsicum', 'Broccoli', 'Soy Sauce'], tags: ['glutenfree-no', 'dairyfree'] },
        { name: 'Fish Tacos', ingredients: ['Fish', 'Tortillas', 'Cabbage', 'Lime', 'Avocado'], tags: ['dairyfree'] },
        { name: 'Veggie Curry', ingredients: ['Chickpeas', 'Coconut Milk', 'Spinach', 'Tomatoes', 'Curry'], tags: ['vegan', 'vegetarian', 'glutenfree', 'dairyfree'] },
        { name: 'Grilled Lamb Chops', ingredients: ['Lamb', 'Rosemary', 'Garlic', 'Potatoes', 'Beans'], tags: ['glutenfree', 'dairyfree', 'keto'] },
        { name: 'Salmon & Veggies', ingredients: ['Salmon', 'Asparagus', 'Lemon', 'Olive Oil'], tags: ['glutenfree', 'dairyfree', 'keto'] },
        { name: 'Beef Burgers', ingredients: ['Beef Mince', 'Buns', 'Lettuce', 'Tomato', 'Cheese'], tags: [] },
        { name: 'Chicken Schnitzel', ingredients: ['Chicken', 'Breadcrumbs', 'Eggs', 'Salad'], tags: [] },
        { name: 'Vegetable Soup', ingredients: ['Carrot', 'Celery', 'Potato', 'Onion', 'Stock'], tags: ['vegan', 'vegetarian', 'glutenfree', 'dairyfree'] },
        { name: 'Prawn Pasta', ingredients: ['Prawns', 'Pasta', 'Garlic', 'Chilli', 'Parsley'], tags: ['dairyfree'] },
        { name: 'Tofu Buddha Bowl', ingredients: ['Tofu', 'Rice', 'Edamame', 'Carrot', 'Avocado'], tags: ['vegan', 'vegetarian', 'glutenfree', 'dairyfree'] },
        { name: 'Roast Chicken', ingredients: ['Chicken', 'Potato', 'Carrot', 'Onion', 'Gravy'], tags: ['glutenfree', 'dairyfree'] },
        { name: 'Mushroom Risotto', ingredients: ['Rice', 'Mushrooms', 'Onion', 'Parmesan', 'Stock'], tags: ['vegetarian', 'glutenfree'] },
        { name: 'BBQ Pork Ribs', ingredients: ['Pork Ribs', 'BBQ Sauce', 'Coleslaw'], tags: ['glutenfree', 'dairyfree'] }
      ];

      // Filter based on preferences
      let filtered = mealDatabase.filter(meal => {
        // Check dislikes
        const hasDisliked = meal.ingredients.some(ing =>
          mealPreferences.dislikes.some(dis => ing.toLowerCase().includes(dis.toLowerCase()))
        );
        if (hasDisliked) return false;

        // Check diet
        if (mealPreferences.diet !== 'none') {
          if (mealPreferences.diet === 'vegetarian' && !meal.tags.includes('vegetarian')) return false;
          if (mealPreferences.diet === 'vegan' && !meal.tags.includes('vegan')) return false;
          if (mealPreferences.diet === 'keto' && !meal.tags.includes('keto')) return false;
          if (mealPreferences.diet === 'glutenfree' && !meal.tags.includes('glutenfree')) return false;
          if (mealPreferences.diet === 'dairyfree' && !meal.tags.includes('dairyfree')) return false;
        }

        return true;
      });

      if (filtered.length < 7) filtered = mealDatabase; // Fallback if too restrictive

      // Shuffle and pick 7 dinners
      const shuffled = filtered.sort(() => Math.random() - 0.5);
      return shuffled.slice(0, 7).map((meal, i) => ({
        day: i,
        type: 'dinner',
        name: meal.name,
        ingredients: meal.ingredients
      }));
    }

    function applyGeneratedMeals(meals) {
      const weekDates = getWeekDates(mealWeekOffset);

      meals.forEach(meal => {
        const dateStr = weekDates[meal.day]?.dateStr;
        if (dateStr) {
          if (!mealPlan[dateStr]) mealPlan[dateStr] = {};
          mealPlan[dateStr][meal.type || 'dinner'] = {
            name: meal.name,
            ingredients: meal.ingredients || [],
            notes: ''
          };
        }
      });

      saveMealPlan();
      renderMealPlanner();
      alert('Meals generated! Check your weekly plan.');
    }

    function toggleMealPlannerView() {
      // Close other views first
      if (calendarVisible) toggleCalendarView();
      if (shoppingVisible) toggleShoppingView();
      if (adhdTaskViewVisible) toggleAdhdTaskView();

      mealPlannerVisible = !mealPlannerVisible;
      const mealView = document.getElementById('mealPlannerView');
      const mealBtn = document.getElementById('mealToggleBtn');

      if (mealPlannerVisible) {
        mealView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        mealBtn.style.background = 'var(--adult)';
        mealBtn.style.color = 'white';
        renderMealPlanner();
      } else {
        mealView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        mealBtn.style.background = '';
        mealBtn.style.color = '';
      }
    }

    // ========================================
    // MEAL IDEAS FUNCTIONALITY
    // ========================================
    let mealIdeas = [];
    let selectedMealIds = new Set();
    let currentMealType = 'breakfast';

    // Extensive offline meal database
    const FALLBACK_MEALS = {
      breakfast: [
        { id: 1, name: 'Avocado Toast', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Helga\'s sourdough bread', quantity: '4 slices'}, {name: 'Avocado', quantity: '2'}, {name: 'Eggs', quantity: '4'}, {name: 'Cherry tomatoes', quantity: '100g'}], steps: ['Toast bread until golden', 'Mash avocado with salt and pepper', 'Poach or fry eggs', 'Spread avocado on toast, top with eggs and tomatoes'] },
        { id: 2, name: 'Pancakes', emoji: '', time: '20 min', servings: 4, ingredients: [{name: 'White Wings pancake mix', quantity: '200g'}, {name: 'Milk', quantity: '250ml'}, {name: 'Eggs', quantity: '2'}, {name: 'Maple syrup', quantity: '100ml'}], steps: ['Mix pancake batter', 'Heat pan with butter', 'Pour batter and cook until bubbles form', 'Flip and cook other side', 'Serve with maple syrup'] },
        { id: 3, name: 'Eggs Benedict', emoji: '', time: '25 min', servings: 2, ingredients: [{name: 'English muffins', quantity: '2'}, {name: 'Eggs', quantity: '4'}, {name: 'Ham slices', quantity: '4'}, {name: 'Hollandaise sauce', quantity: '100ml'}], steps: ['Toast muffins', 'Poach eggs', 'Layer ham on muffins', 'Top with poached eggs and hollandaise'] },
        { id: 4, name: 'Bacon & Eggs', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Bacon rashers', quantity: '6'}, {name: 'Eggs', quantity: '4'}, {name: 'Bread', quantity: '4 slices'}, {name: 'Butter', quantity: '20g'}], steps: ['Fry bacon until crispy', 'Fry eggs in bacon fat', 'Toast bread', 'Serve together'] },
        { id: 5, name: 'Smoothie Bowl', emoji: '', time: '10 min', servings: 1, ingredients: [{name: 'Frozen berries', quantity: '200g'}, {name: 'Banana', quantity: '1'}, {name: 'Greek yoghurt', quantity: '100g'}, {name: 'Granola', quantity: '50g'}], steps: ['Blend berries, banana and yoghurt', 'Pour into bowl', 'Top with granola and fresh fruit'] },
        { id: 6, name: 'French Toast', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Brioche bread', quantity: '4 slices'}, {name: 'Eggs', quantity: '2'}, {name: 'Milk', quantity: '100ml'}, {name: 'Cinnamon', quantity: '1 tsp'}], steps: ['Whisk eggs, milk and cinnamon', 'Dip bread in mixture', 'Fry until golden on both sides', 'Serve with maple syrup'] },
        { id: 7, name: 'Breakfast Burrito', emoji: '', time: '20 min', servings: 2, ingredients: [{name: 'Tortillas', quantity: '2 large'}, {name: 'Eggs', quantity: '4'}, {name: 'Bacon', quantity: '4 rashers'}, {name: 'Cheese', quantity: '50g'}], steps: ['Scramble eggs', 'Cook bacon', 'Warm tortillas', 'Fill with eggs, bacon and cheese, roll up'] },
        { id: 8, name: 'Porridge', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Uncle Tobys oats', quantity: '1 cup'}, {name: 'Milk', quantity: '2 cups'}, {name: 'Honey', quantity: '2 tbsp'}, {name: 'Banana', quantity: '1'}], steps: ['Cook oats with milk', 'Stir until creamy', 'Top with sliced banana and honey'] },
        { id: 9, name: 'Omelette', emoji: '', time: '15 min', servings: 1, ingredients: [{name: 'Eggs', quantity: '3'}, {name: 'Cheese', quantity: '30g'}, {name: 'Ham', quantity: '50g'}, {name: 'Mushrooms', quantity: '50g'}], steps: ['Beat eggs', 'Cook mushrooms and ham', 'Pour eggs in pan', 'Add fillings and fold'] },
        { id: 10, name: 'Fruit Salad', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Strawberries', quantity: '100g'}, {name: 'Blueberries', quantity: '100g'}, {name: 'Banana', quantity: '1'}, {name: 'Yoghurt', quantity: '200g'}], steps: ['Wash and chop fruit', 'Combine in bowl', 'Serve with yoghurt'] },
        { id: 11, name: 'Muesli Bowl', emoji: '', time: '5 min', servings: 1, ingredients: [{name: 'Carman\'s muesli', quantity: '60g'}, {name: 'Milk', quantity: '200ml'}, {name: 'Honey', quantity: '1 tbsp'}, {name: 'Berries', quantity: '50g'}], steps: ['Pour muesli into bowl', 'Add milk', 'Top with honey and berries'] },
        { id: 12, name: 'Vegemite Toast', emoji: '', time: '5 min', servings: 2, ingredients: [{name: 'Bread', quantity: '4 slices'}, {name: 'Butter', quantity: '20g'}, {name: 'Vegemite', quantity: '2 tsp'}, {name: 'Avocado', quantity: '1'}], steps: ['Toast bread', 'Spread butter then vegemite', 'Top with sliced avocado'] },
        { id: 13, name: 'Chia Pudding', emoji: '', time: '5 min + overnight', servings: 2, ingredients: [{name: 'Chia seeds', quantity: '4 tbsp'}, {name: 'Coconut milk', quantity: '400ml'}, {name: 'Honey', quantity: '2 tbsp'}, {name: 'Mango', quantity: '1'}], steps: ['Mix chia seeds with coconut milk and honey', 'Refrigerate overnight', 'Top with fresh mango'] },
        { id: 14, name: 'Shakshuka', emoji: '', time: '25 min', servings: 2, ingredients: [{name: 'Eggs', quantity: '4'}, {name: 'Canned tomatoes', quantity: '400g'}, {name: 'Capsicum', quantity: '1'}, {name: 'Feta cheese', quantity: '50g'}], steps: ['Saut capsicum', 'Add tomatoes and simmer', 'Create wells and crack in eggs', 'Cover and cook until eggs set'] },
        { id: 15, name: 'Breakfast Wrap', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Wraps', quantity: '2'}, {name: 'Scrambled eggs', quantity: '4'}, {name: 'Avocado', quantity: '1'}, {name: 'Sriracha', quantity: '1 tbsp'}], steps: ['Scramble eggs', 'Warm wraps', 'Add eggs, avocado and sriracha', 'Roll up'] },
        { id: 16, name: 'Acai Bowl', emoji: '', time: '10 min', servings: 1, ingredients: [{name: 'Acai packet', quantity: '100g'}, {name: 'Banana', quantity: '1'}, {name: 'Granola', quantity: '50g'}, {name: 'Coconut flakes', quantity: '20g'}], steps: ['Blend acai with half banana', 'Pour into bowl', 'Top with granola, banana and coconut'] },
        { id: 17, name: 'Hash Browns & Eggs', emoji: '', time: '20 min', servings: 2, ingredients: [{name: 'Hash browns', quantity: '4'}, {name: 'Eggs', quantity: '4'}, {name: 'Baked beans', quantity: '200g'}, {name: 'Toast', quantity: '2 slices'}], steps: ['Cook hash browns', 'Fry eggs', 'Heat beans', 'Serve together with toast'] },
        { id: 18, name: 'Crumpets', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Crumpets', quantity: '4'}, {name: 'Butter', quantity: '40g'}, {name: 'Honey', quantity: '2 tbsp'}, {name: 'Strawberries', quantity: '100g'}], steps: ['Toast crumpets', 'Spread with butter', 'Drizzle honey', 'Serve with strawberries'] },
        { id: 19, name: 'Yoghurt Parfait', emoji: '', time: '5 min', servings: 1, ingredients: [{name: 'Greek yoghurt', quantity: '200g'}, {name: 'Granola', quantity: '50g'}, {name: 'Mixed berries', quantity: '100g'}, {name: 'Honey', quantity: '1 tbsp'}], steps: ['Layer yoghurt in glass', 'Add granola and berries', 'Repeat layers', 'Drizzle with honey'] },
        { id: 20, name: 'Cheese Toastie', emoji: '', time: '10 min', servings: 1, ingredients: [{name: 'Bread', quantity: '2 slices'}, {name: 'Cheese', quantity: '50g'}, {name: 'Butter', quantity: '15g'}, {name: 'Tomato', quantity: '1'}], steps: ['Butter bread', 'Add cheese and tomato', 'Toast in sandwich press until golden'] }
      ],
      lunch: [
        { id: 21, name: 'Chicken Caesar Salad', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Chicken breast', quantity: '300g'}, {name: 'Cos lettuce', quantity: '1 head'}, {name: 'Caesar dressing', quantity: '100ml'}, {name: 'Parmesan', quantity: '50g'}], steps: ['Grill chicken', 'Chop lettuce', 'Slice chicken', 'Combine with dressing and parmesan'] },
        { id: 22, name: 'BLT Sandwich', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Bacon rashers', quantity: '6'}, {name: 'Lettuce', quantity: '4 leaves'}, {name: 'Tomato', quantity: '1'}, {name: 'Bread', quantity: '4 slices'}], steps: ['Cook bacon until crispy', 'Toast bread', 'Assemble with lettuce and tomato'] },
        { id: 23, name: 'Tuna Salad', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Canned tuna', quantity: '185g'}, {name: 'Mixed leaves', quantity: '100g'}, {name: 'Cherry tomatoes', quantity: '100g'}, {name: 'Olive oil', quantity: '2 tbsp'}], steps: ['Drain tuna', 'Combine with salad leaves', 'Add tomatoes', 'Dress with olive oil'] },
        { id: 24, name: 'Chicken Wrap', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Chicken breast', quantity: '300g'}, {name: 'Tortilla wraps', quantity: '2'}, {name: 'Lettuce', quantity: '50g'}, {name: 'Mayo', quantity: '2 tbsp'}], steps: ['Cook and slice chicken', 'Warm tortillas', 'Fill with chicken, lettuce and mayo', 'Roll up'] },
        { id: 25, name: 'Soup & Bread', emoji: '', time: '20 min', servings: 2, ingredients: [{name: 'Campbell\'s soup', quantity: '420g'}, {name: 'Crusty bread', quantity: '4 slices'}, {name: 'Butter', quantity: '30g'}], steps: ['Heat soup', 'Toast bread', 'Spread with butter', 'Serve together'] },
        { id: 26, name: 'Greek Salad', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Cucumber', quantity: '1'}, {name: 'Tomatoes', quantity: '2'}, {name: 'Feta cheese', quantity: '100g'}, {name: 'Olives', quantity: '50g'}], steps: ['Chop vegetables', 'Cube feta', 'Combine all ingredients', 'Dress with olive oil and lemon'] },
        { id: 27, name: 'Ham & Cheese Toastie', emoji: '', time: '10 min', servings: 1, ingredients: [{name: 'Bread', quantity: '2 slices'}, {name: 'Ham', quantity: '50g'}, {name: 'Cheese', quantity: '50g'}, {name: 'Butter', quantity: '15g'}], steps: ['Butter bread', 'Layer ham and cheese', 'Toast until golden'] },
        { id: 28, name: 'Poke Bowl', emoji: '', time: '20 min', servings: 2, ingredients: [{name: 'Salmon', quantity: '200g'}, {name: 'Sushi rice', quantity: '1 cup'}, {name: 'Avocado', quantity: '1'}, {name: 'Edamame', quantity: '100g'}], steps: ['Cook rice', 'Cube salmon', 'Slice avocado', 'Assemble bowl with all ingredients'] },
        { id: 29, name: 'Quesadilla', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Tortillas', quantity: '4'}, {name: 'Cheese', quantity: '150g'}, {name: 'Chicken', quantity: '200g'}, {name: 'Salsa', quantity: '100ml'}], steps: ['Grill chicken and slice', 'Fill tortillas with chicken and cheese', 'Cook until cheese melts', 'Serve with salsa'] },
        { id: 30, name: 'Pasta Salad', emoji: '', time: '20 min', servings: 4, ingredients: [{name: 'Pasta', quantity: '300g'}, {name: 'Cherry tomatoes', quantity: '200g'}, {name: 'Mozzarella', quantity: '125g'}, {name: 'Basil pesto', quantity: '3 tbsp'}], steps: ['Cook pasta and cool', 'Halve tomatoes', 'Cube mozzarella', 'Combine with pesto'] },
        { id: 31, name: 'Fried Rice', emoji: '', time: '20 min', servings: 2, ingredients: [{name: 'Cooked rice', quantity: '2 cups'}, {name: 'Eggs', quantity: '2'}, {name: 'Frozen peas', quantity: '100g'}, {name: 'Soy sauce', quantity: '2 tbsp'}], steps: ['Scramble eggs', 'Add rice and peas', 'Season with soy sauce', 'Stir fry until hot'] },
        { id: 32, name: 'Hummus Wrap', emoji: '', time: '10 min', servings: 1, ingredients: [{name: 'Wrap', quantity: '1'}, {name: 'Hummus', quantity: '3 tbsp'}, {name: 'Cucumber', quantity: '50g'}, {name: 'Falafel', quantity: '3'}], steps: ['Spread hummus on wrap', 'Add falafel and cucumber', 'Roll up'] },
        { id: 33, name: 'Club Sandwich', emoji: '', time: '15 min', servings: 1, ingredients: [{name: 'Bread', quantity: '3 slices'}, {name: 'Chicken', quantity: '100g'}, {name: 'Bacon', quantity: '2 rashers'}, {name: 'Lettuce & tomato', quantity: '50g'}], steps: ['Toast bread', 'Cook bacon', 'Layer ingredients between bread', 'Cut diagonally'] },
        { id: 34, name: 'Noodle Soup', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Instant noodles', quantity: '2 packets'}, {name: 'Chicken stock', quantity: '1L'}, {name: 'Bok choy', quantity: '2'}, {name: 'Boiled egg', quantity: '2'}], steps: ['Boil stock', 'Cook noodles', 'Add bok choy', 'Top with halved eggs'] },
        { id: 35, name: 'Bruschetta', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Baguette', quantity: '1'}, {name: 'Tomatoes', quantity: '4'}, {name: 'Basil', quantity: '10 leaves'}, {name: 'Garlic', quantity: '2 cloves'}], steps: ['Slice and toast baguette', 'Dice tomatoes with basil', 'Rub bread with garlic', 'Top with tomato mixture'] },
        { id: 36, name: 'Jacket Potato', emoji: '', time: '60 min', servings: 2, ingredients: [{name: 'Potatoes', quantity: '2 large'}, {name: 'Butter', quantity: '30g'}, {name: 'Baked beans', quantity: '200g'}, {name: 'Cheese', quantity: '50g'}], steps: ['Bake potatoes until soft', 'Cut open and add butter', 'Top with beans and cheese'] },
        { id: 37, name: 'Sushi Roll', emoji: '', time: '30 min', servings: 2, ingredients: [{name: 'Sushi rice', quantity: '1 cup'}, {name: 'Nori sheets', quantity: '4'}, {name: 'Cucumber', quantity: '1'}, {name: 'Avocado', quantity: '1'}], steps: ['Cook and season rice', 'Lay nori on mat', 'Add rice and fillings', 'Roll tightly and slice'] },
        { id: 38, name: 'Caprese Salad', emoji: '', time: '10 min', servings: 2, ingredients: [{name: 'Tomatoes', quantity: '3'}, {name: 'Fresh mozzarella', quantity: '200g'}, {name: 'Fresh basil', quantity: '1 bunch'}, {name: 'Balsamic glaze', quantity: '2 tbsp'}], steps: ['Slice tomatoes and mozzarella', 'Arrange alternating slices', 'Add basil leaves', 'Drizzle with balsamic'] },
        { id: 39, name: 'Minestrone', emoji: '', time: '30 min', servings: 4, ingredients: [{name: 'Mixed vegetables', quantity: '400g'}, {name: 'Cannellini beans', quantity: '400g'}, {name: 'Pasta', quantity: '100g'}, {name: 'Vegetable stock', quantity: '1L'}], steps: ['Saut vegetables', 'Add stock and beans', 'Cook pasta in soup', 'Season and serve'] },
        { id: 40, name: 'Egg Salad Sandwich', emoji: '', time: '15 min', servings: 2, ingredients: [{name: 'Eggs', quantity: '4'}, {name: 'Mayo', quantity: '3 tbsp'}, {name: 'Bread', quantity: '4 slices'}, {name: 'Chives', quantity: '1 tbsp'}], steps: ['Boil and chop eggs', 'Mix with mayo and chives', 'Spread on bread', 'Make sandwiches'] }
      ],
      dinner: [
        { id: 41, name: 'Creamy Garlic Parmesan Pasta with Crispy Bacon and Caesar Salad', emoji: '', description: 'Rich, creamy pasta loaded with garlic and parmesan, topped with crispy bacon bits and served with fresh caesar salad.', time: '30 min', servings: 4, ingredients: [{name: 'San Remo fettuccine', quantity: '400g'}, {name: 'Bacon rashers', quantity: '200g'}, {name: 'Parmesan', quantity: '100g'}, {name: 'Garlic', quantity: '4 cloves'}, {name: 'Thickened cream', quantity: '300ml'}, {name: 'Cos lettuce', quantity: '1 head'}, {name: 'Caesar dressing', quantity: '100ml'}], steps: ['Cook pasta al dente', 'Fry bacon until crispy, set aside', 'Saute garlic in bacon fat, add cream and parmesan', 'Toss pasta in creamy sauce', 'Top with crispy bacon, serve with caesar salad'] },
        { id: 42, name: 'Sticky Honey Garlic Chicken with Garlic Butter Rice and Steamed Greens', emoji: '', description: 'Caramelised chicken thighs glazed in sweet honey garlic sauce, served with fluffy garlic butter rice and tender Asian greens.', time: '35 min', servings: 4, ingredients: [{name: 'Chicken thighs', quantity: '8'}, {name: 'Honey', quantity: '4 tbsp'}, {name: 'Garlic', quantity: '6 cloves'}, {name: 'Soy sauce', quantity: '3 tbsp'}, {name: 'SunRice jasmine rice', quantity: '2 cups'}, {name: 'Butter', quantity: '30g'}, {name: 'Broccolini', quantity: '2 bunches'}], steps: ['Cook rice, stir through garlic butter when done', 'Pan fry chicken until golden', 'Add honey, garlic and soy, simmer until sticky glaze forms', 'Steam broccolini until bright green', 'Serve chicken over rice with greens on the side'] },
        { id: 43, name: 'Crispy Beer-Battered Fish with Chunky Chips and Mushy Peas', emoji: '', description: 'Golden, crispy battered fish fillets with thick-cut chips and traditional mushy peas - classic fish shop quality at home!', time: '40 min', servings: 4, ingredients: [{name: 'Flathead fillets', quantity: '4'}, {name: 'Beer', quantity: '1 can'}, {name: 'Self-raising flour', quantity: '200g'}, {name: 'Potatoes', quantity: '800g'}, {name: 'Frozen peas', quantity: '300g'}, {name: 'Butter', quantity: '30g'}, {name: 'Lemon', quantity: '2'}], steps: ['Cut potatoes into thick chips, toss in oil, bake at 220C', 'Make batter with beer and flour', 'Dip fish in batter, deep fry until golden', 'Mash peas with butter, salt and mint', 'Serve fish and chips with mushy peas and lemon wedges'] },
        { id: 44, name: 'Loaded Mexican Beef Tacos with Spanish Rice and Refried Beans', emoji: '', description: 'Spicy seasoned beef in crunchy shells topped with all the fixings, alongside flavourful Spanish rice and creamy refried beans.', time: '30 min', servings: 4, ingredients: [{name: 'Beef mince', quantity: '500g'}, {name: 'Old El Paso taco kit', quantity: '1'}, {name: 'Rice', quantity: '1 cup'}, {name: 'Canned tomatoes', quantity: '200g'}, {name: 'Refried beans', quantity: '400g'}, {name: 'Cheese', quantity: '150g'}, {name: 'Sour cream', quantity: '150ml'}, {name: 'Avocado', quantity: '2'}], steps: ['Cook rice with canned tomatoes and cumin for Spanish rice', 'Brown mince with taco seasoning', 'Heat refried beans', 'Warm taco shells', 'Load tacos with beef, cheese, sour cream and guacamole, serve with rice and beans'] },
        { id: 45, name: 'Creamy Butter Chicken with Fragrant Basmati Rice and Garlic Naan', emoji: '', description: 'Tender chicken in rich, velvety tomato-cream sauce with aromatic spices, served with fluffy basmati and warm garlic naan.', time: '40 min', servings: 4, ingredients: [{name: 'Chicken thigh', quantity: '600g'}, {name: 'Patak\'s butter chicken sauce', quantity: '450g'}, {name: 'Thickened cream', quantity: '100ml'}, {name: 'Basmati rice', quantity: '2 cups'}, {name: 'Garlic naan', quantity: '4'}, {name: 'Fresh coriander', quantity: '1 bunch'}, {name: 'Butter', quantity: '30g'}], steps: ['Cook rice with cardamom pod for fragrance', 'Pan fry chicken pieces until golden', 'Add sauce and cream, simmer 15 mins', 'Warm naan in oven with garlic butter', 'Garnish curry with fresh coriander, serve with rice and naan'] },
        { id: 46, name: 'Pan-Seared Pork Chops with Creamy Mash and Honey Glazed Carrots', emoji: '', description: 'Juicy, golden pork chops with a herb crust, served with buttery mashed potatoes and sweet honey-glazed baby carrots.', time: '35 min', servings: 4, ingredients: [{name: 'Pork chops', quantity: '4'}, {name: 'Potatoes', quantity: '800g'}, {name: 'Baby carrots', quantity: '400g'}, {name: 'Butter', quantity: '80g'}, {name: 'Honey', quantity: '3 tbsp'}, {name: 'Fresh thyme', quantity: '1 bunch'}, {name: 'Cream', quantity: '100ml'}], steps: ['Boil potatoes, mash with butter and cream', 'Season pork with thyme, pan fry until golden', 'Roast carrots with honey and butter until glazed', 'Rest pork and make pan gravy', 'Plate with mash, glazed carrots and gravy drizzle'] },
        { id: 47, name: 'Herb-Crusted Salmon with Lemon Butter Potatoes and Roasted Asparagus', emoji: '', description: 'Perfectly cooked salmon with a crispy herb crust, served with zesty lemon butter baby potatoes and tender asparagus spears.', time: '35 min', servings: 4, ingredients: [{name: 'Salmon fillets', quantity: '4'}, {name: 'Baby potatoes', quantity: '600g'}, {name: 'Asparagus', quantity: '2 bunches'}, {name: 'Fresh dill', quantity: '1 bunch'}, {name: 'Lemon', quantity: '2'}, {name: 'Butter', quantity: '60g'}, {name: 'Garlic', quantity: '3 cloves'}], steps: ['Halve potatoes, roast with garlic and butter', 'Press herb breadcrumb mix onto salmon', 'Bake salmon until just cooked through', 'Toss asparagus in oil, roast until tender', 'Squeeze lemon over potatoes, serve with salmon and asparagus'] },
        { id: 48, name: 'Juicy Smash Burgers with Loaded Fries and Coleslaw', emoji: '', description: 'Crispy-edged smash patties with melted cheese, special sauce and all the toppings, served with cheesy loaded fries and creamy slaw.', time: '30 min', servings: 4, ingredients: [{name: 'Beef mince', quantity: '600g'}, {name: 'Brioche buns', quantity: '4'}, {name: 'American cheese', quantity: '8 slices'}, {name: 'Frozen chips', quantity: '500g'}, {name: 'Coleslaw mix', quantity: '250g'}, {name: 'Mayo', quantity: '100ml'}, {name: 'Pickles', quantity: '1 jar'}], steps: ['Cook chips, top with cheese to melt', 'Form mince into balls, smash flat on hot griddle', 'Add cheese slice to melt, toast buns', 'Mix coleslaw with mayo', 'Stack burgers with pickles and sauce, serve with loaded fries and slaw'] },
        { id: 49, name: 'Silky Carbonara with Garlic Bread and Garden Salad', emoji: '', description: 'Authentic creamy carbonara with crispy pancetta and pecorino, served with golden garlic bread and fresh garden salad.', time: '25 min', servings: 4, ingredients: [{name: 'San Remo spaghetti', quantity: '400g'}, {name: 'Pancetta', quantity: '200g'}, {name: 'Eggs', quantity: '4'}, {name: 'Pecorino', quantity: '100g'}, {name: 'Garlic bread', quantity: '1 loaf'}, {name: 'Mixed salad leaves', quantity: '150g'}, {name: 'Cherry tomatoes', quantity: '200g'}], steps: ['Cook pasta, reserve pasta water', 'Fry pancetta until crispy', 'Whisk eggs with pecorino', 'Toss hot pasta with egg mix and pancetta', 'Bake garlic bread, serve with salad dressed in olive oil'] },
        { id: 50, name: 'Golden Roast Chicken with Crispy Potatoes and Honey Roasted Vegetables', emoji: '', description: 'Perfectly golden roast chicken with crispy skin, served with crunchy roast potatoes and sweet honey-glazed root vegetables.', time: '90 min', servings: 4, ingredients: [{name: 'Whole chicken', quantity: '1.8kg'}, {name: 'Potatoes', quantity: '800g'}, {name: 'Carrots', quantity: '400g'}, {name: 'Parsnips', quantity: '300g'}, {name: 'Honey', quantity: '3 tbsp'}, {name: 'Fresh rosemary', quantity: '1 bunch'}, {name: 'Butter', quantity: '50g'}], steps: ['Rub chicken with butter and rosemary, roast at 200C', 'Par-boil potatoes, rough up edges, roast in chicken fat', 'Toss carrots and parsnips in honey, roast alongside', 'Rest chicken 15 mins before carving', 'Serve with crispy potatoes and glazed vegetables'] },
        { id: 51, name: 'Herb-Crusted Lamb Cutlets with Mint Pea Mash and Rosemary Jus', emoji: '', description: 'Tender lamb cutlets with a fragrant herb crust, served with vibrant mint pea mash and rich rosemary gravy.', time: '30 min', servings: 4, ingredients: [{name: 'Lamb cutlets', quantity: '12'}, {name: 'Potatoes', quantity: '600g'}, {name: 'Frozen peas', quantity: '300g'}, {name: 'Fresh mint', quantity: '1 bunch'}, {name: 'Fresh rosemary', quantity: '1 bunch'}, {name: 'Butter', quantity: '60g'}, {name: 'Lamb stock', quantity: '250ml'}], steps: ['Boil potatoes, mash with butter', 'Cook peas, fold into mash with chopped mint', 'Season lamb, pan fry to medium-rare', 'Make jus with pan juices, stock and rosemary', 'Plate mash, top with lamb, drizzle with jus'] },
        { id: 52, name: 'Zesty Prawn Pad Thai with Fresh Lime and Crushed Peanuts', emoji: '', description: 'Authentic street-style pad thai with juicy prawns, tangy tamarind sauce, and topped with lime, peanuts and fresh herbs.', time: '25 min', servings: 4, ingredients: [{name: 'Rice noodles', quantity: '400g'}, {name: 'Prawns', quantity: '400g'}, {name: 'Pad Thai sauce', quantity: '150ml'}, {name: 'Bean sprouts', quantity: '200g'}, {name: 'Peanuts', quantity: '100g'}, {name: 'Lime', quantity: '2'}, {name: 'Fresh coriander', quantity: '1 bunch'}], steps: ['Soak noodles until soft', 'Stir fry prawns until pink, set aside', 'Toss noodles in wok with sauce', 'Add prawns and bean sprouts', 'Serve topped with crushed peanuts, lime wedges and coriander'] },
        { id: 53, name: 'Rich Beef Lasagne with Garlic Bread and Caprese Salad', emoji: '', description: 'Layers of rich beef ragu and creamy bechamel, baked until golden, served with crusty garlic bread and fresh caprese salad.', time: '75 min', servings: 6, ingredients: [{name: 'Beef mince', quantity: '600g'}, {name: 'Lasagne sheets', quantity: '250g'}, {name: 'Leggo\'s pasta sauce', quantity: '500g'}, {name: 'Bechamel sauce', quantity: '500ml'}, {name: 'Mozzarella', quantity: '200g'}, {name: 'Garlic bread', quantity: '1 loaf'}, {name: 'Fresh basil', quantity: '1 bunch'}], steps: ['Brown mince, add sauce, simmer 20 mins', 'Layer meat sauce, pasta sheets and bechamel', 'Top with mozzarella, bake until golden', 'Bake garlic bread', 'Serve with tomato, mozzarella and basil salad'] },
        { id: 54, name: 'Fragrant Thai Green Curry with Jasmine Rice and Prawn Crackers', emoji: '', description: 'Aromatic coconut green curry loaded with tender chicken and vegetables, served with fragrant jasmine rice and crispy prawn crackers.', time: '35 min', servings: 4, ingredients: [{name: 'Chicken thigh', quantity: '600g'}, {name: 'Green curry paste', quantity: '4 tbsp'}, {name: 'Coconut milk', quantity: '400ml'}, {name: 'Thai basil', quantity: '1 bunch'}, {name: 'SunRice jasmine rice', quantity: '2 cups'}, {name: 'Bamboo shoots', quantity: '200g'}, {name: 'Prawn crackers', quantity: '1 packet'}], steps: ['Cook jasmine rice', 'Fry curry paste until fragrant', 'Add chicken, cook through', 'Pour in coconut milk and bamboo shoots, simmer', 'Stir in Thai basil, serve with rice and prawn crackers'] },
        { id: 55, name: 'Special Fried Rice with Honey Sesame Chicken and Asian Greens', emoji: '', description: 'Wok-tossed fried rice loaded with prawns and vegetables, served with crispy honey sesame chicken pieces and stir-fried bok choy.', time: '30 min', servings: 4, ingredients: [{name: 'Cooked rice', quantity: '4 cups'}, {name: 'Chicken breast', quantity: '400g'}, {name: 'Eggs', quantity: '3'}, {name: 'Frozen mixed veg', quantity: '200g'}, {name: 'Honey', quantity: '3 tbsp'}, {name: 'Sesame seeds', quantity: '2 tbsp'}, {name: 'Bok choy', quantity: '4'}], steps: ['Coat chicken pieces in cornflour, fry until crispy', 'Toss in honey and sesame seeds', 'Scramble eggs in wok, add rice and veg', 'Season with soy and sesame oil', 'Stir fry bok choy with garlic, serve all together'] },
        { id: 56, name: 'Comforting Shepherd\'s Pie with Cheesy Mash and Buttered Peas', emoji: '', description: 'Hearty lamb mince filling topped with golden cheesy mash, served with buttery garden peas - ultimate comfort food!', time: '50 min', servings: 4, ingredients: [{name: 'Lamb mince', quantity: '500g'}, {name: 'Potatoes', quantity: '800g'}, {name: 'Frozen peas', quantity: '250g'}, {name: 'Cheese', quantity: '100g'}, {name: 'Butter', quantity: '60g'}, {name: 'Worcestershire sauce', quantity: '2 tbsp'}, {name: 'Beef stock', quantity: '250ml'}], steps: ['Brown lamb with onion and carrots', 'Add stock and Worcestershire, simmer until thick', 'Mash potatoes with butter and cheese', 'Top meat with cheesy mash, bake until golden', 'Serve with buttered peas'] },
        { id: 57, name: 'Crispy Chicken Schnitzel with Creamy Mushroom Sauce and Mash', emoji: '', description: 'Golden crumbed chicken schnitzel smothered in creamy garlic mushroom sauce, served with buttery mashed potatoes.', time: '35 min', servings: 4, ingredients: [{name: 'Chicken breast', quantity: '4'}, {name: 'Breadcrumbs', quantity: '200g'}, {name: 'Mushrooms', quantity: '300g'}, {name: 'Thickened cream', quantity: '200ml'}, {name: 'Potatoes', quantity: '800g'}, {name: 'Butter', quantity: '60g'}, {name: 'Garlic', quantity: '3 cloves'}], steps: ['Flatten chicken, coat in flour, egg and crumbs', 'Pan fry until golden and cooked through', 'Saute mushrooms with garlic, add cream', 'Mash potatoes with butter', 'Serve schnitzel topped with mushroom sauce alongside mash'] },
        { id: 58, name: 'Loaded Beef Nachos with Guacamole and Mexican Rice', emoji: '', description: 'Crispy tortilla chips piled high with spiced beef, melted cheese and all the toppings, served with fresh guac and fluffy Mexican rice.', time: '30 min', servings: 4, ingredients: [{name: 'Beef mince', quantity: '500g'}, {name: 'Corn chips', quantity: '250g'}, {name: 'Cheese', quantity: '200g'}, {name: 'Avocado', quantity: '2'}, {name: 'Rice', quantity: '1 cup'}, {name: 'Salsa', quantity: '250g'}, {name: 'Sour cream', quantity: '150ml'}], steps: ['Cook rice with tomato paste and cumin', 'Brown mince with taco spices', 'Layer chips with beef and cheese, bake until melted', 'Mash avocados with lime for guac', 'Top nachos with salsa, sour cream and guac, serve with rice'] },
        { id: 59, name: 'Sticky Honey Sesame Chicken with Egg Fried Rice and Stir-Fried Vegetables', emoji: '', description: 'Crispy chicken pieces in irresistible sticky honey sesame glaze, served with fluffy egg fried rice and colourful stir-fried veg.', time: '35 min', servings: 4, ingredients: [{name: 'Chicken thighs', quantity: '600g'}, {name: 'Honey', quantity: '4 tbsp'}, {name: 'Sesame seeds', quantity: '3 tbsp'}, {name: 'SunRice jasmine rice', quantity: '2 cups'}, {name: 'Eggs', quantity: '3'}, {name: 'Asian stir-fry veg', quantity: '400g'}, {name: 'Soy sauce', quantity: '4 tbsp'}], steps: ['Cook rice, stir through scrambled eggs', 'Cut and fry chicken until crispy', 'Coat in honey, soy and sesame glaze', 'Stir fry vegetables with garlic', 'Serve glazed chicken over egg fried rice with veg'] },
        { id: 60, name: 'Creamy Beef Stroganoff with Buttered Egg Noodles and Green Beans', emoji: '', description: 'Tender beef strips in rich, creamy paprika sauce with mushrooms, served over buttery egg noodles with garlicky green beans.', time: '35 min', servings: 4, ingredients: [{name: 'Beef strips', quantity: '600g'}, {name: 'Mushrooms', quantity: '300g'}, {name: 'Sour cream', quantity: '250ml'}, {name: 'Egg noodles', quantity: '400g'}, {name: 'Green beans', quantity: '300g'}, {name: 'Butter', quantity: '50g'}, {name: 'Paprika', quantity: '2 tbsp'}], steps: ['Sear beef with paprika until browned, set aside', 'Saute mushrooms until golden', 'Return beef, add sour cream and simmer', 'Cook noodles, toss in butter', 'Saute green beans with garlic, serve all together'] }
      ]
    };

    function selectMealType(type) {
      currentMealType = type;
      document.querySelectorAll('.meal-type-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === type);
      });
      // Clear current ideas when switching type
      mealIdeas = [];
      selectedMealIds.clear();
      renderMealIdeasGrid();
    }

    function switchMealTab(tab) {
      document.querySelectorAll('.meal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.meal-tab-content').forEach(c => c.classList.remove('active'));

      if (tab === 'ideas') {
        document.querySelector('.meal-tab:first-child').classList.add('active');
        document.getElementById('mealIdeasTab').classList.add('active');
      } else {
        document.querySelector('.meal-tab:last-child').classList.add('active');
        document.getElementById('mealWeeklyTab').classList.add('active');
      }
    }

    async function generateMealIdeas() {
      const grid = document.getElementById('mealIdeasGrid');
      grid.innerHTML = '<div class="meal-ideas-empty"><div class="ai-loading-spinner"></div><p>Generating ' + currentMealType + ' ideas with AI...</p></div>';

      try {
        const token = localStorage.getItem('google_id_token');
        if (!token) {
          throw new Error('Please sign in with Google to generate AI meal ideas. Go to the main page to sign in.');
        }

        // Get quality preference from settings
        const quality = document.querySelector('input[name="quality"]:checked')?.value || mealPreferences.budget || 'standard';

        // Build diet preferences array from the diet setting
        const dietPrefs = [];
        if (mealPreferences.diet && mealPreferences.diet !== 'none') {
          dietPrefs.push(mealPreferences.diet);
        }

        console.log('Generating meals with:', {
          mealType: currentMealType,
          dislikes: mealPreferences.dislikes,
          dietPreferences: dietPrefs,
          cuisines: mealPreferences.cuisines,
          servings: mealPreferences.servings,
          maxIngredients: mealPreferences.maxIngredients,
          complexity: mealPreferences.complexity,
          cookingMethod: mealPreferences.cookingMethod
        });

        const response = await fetch('/api/meals/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            mealType: currentMealType,
            dislikes: mealPreferences.dislikes || [],
            dietPreferences: dietPrefs,
            cuisines: mealPreferences.cuisines || [],
            servings: parseInt(mealPreferences.servings) || 4,
            maxIngredients: parseInt(mealPreferences.maxIngredients) || 12,
            budget: quality,
            complexity: mealPreferences.complexity || 'any',
            cookingMethod: mealPreferences.cookingMethod || 'any',
            count: 14,  // 14 authentic recipes with GPT audit
            includeSnacks: true,  // 6 snacks (3 sweet, 3 savoury)
            includeEntrees: true, // 4 entrees/starters
            includeDesserts: true // 4 desserts
          })
        });

        console.log('API response status:', response.status);

        if (!response.ok) {
          const errText = await response.text();
          console.error('API error response:', errText);
          let errObj;
          try {
            errObj = JSON.parse(errText);
          } catch (e) {
            throw new Error('API error: ' + response.status + ' - ' + errText.substring(0, 200));
          }
          throw new Error(errObj.error || 'Failed to generate meals (status ' + response.status + ')');
        }

        const data = await response.json();
        console.log('Received meals:', data);

        if (data.error) {
          throw new Error(data.error);
        }

        mealIdeas = data.meals || [];
        // Store snacks, entrees, and desserts
        window.snackIdeas = data.snacks || [];
        window.entreeIdeas = data.entrees || [];
        window.dessertIdeas = data.desserts || [];
        // Store AI attribution info
        window.mealGeneratedBy = data.generatedBy || 'AI';
        window.mealAuditedBy = data.auditedBy || 'GPT-4';
        window.mealAuthenticityScore = data.authenticityScore || null;

        if (mealIdeas.length === 0) {
          throw new Error('No meals returned from AI');
        }

        selectedMealIds.clear();
        renderMealIdeasGrid();

        // Log the extras we received
        console.log('Snacks received:', window.snackIdeas.length);
        console.log('Entrees received:', window.entreeIdeas.length);
        console.log('Desserts received:', window.dessertIdeas.length);
      } catch (error) {
        console.error('Meal generation error:', error);

        // Check if it's an authentication error
        const isAuthError = error.message.toLowerCase().includes('sign in') ||
                           error.message.toLowerCase().includes('authentication');

        // Show error in the grid
        const grid = document.getElementById('mealIdeasGrid');
        if (isAuthError) {
          grid.innerHTML = `
            <div class="meal-ideas-empty" style="color: #e74c3c;">
              <div class="meal-ideas-empty-icon"></div>
              <p><strong>Session Expired</strong></p>
              <p style="font-size: 0.85rem; margin-top: 8px;">Please sign in again to use AI features.</p>
              <div id="googleSignInButtonMeals" style="margin-top: 16px;"></div>
              <button class="smart-meal-btn" onclick="useOfflineMeals()" style="margin-top: 12px;">Use Offline Meals Instead</button>
            </div>
          `;
          // Render Google Sign-In button
          renderGoogleSignInButton('googleSignInButtonMeals', 'meals');
        } else {
          // API failed - show error details and offer fallback
          console.log('API failed:', error.message);
          grid.innerHTML = `
            <div class="meal-ideas-empty" style="color: #e74c3c;">
              <div class="meal-ideas-empty-icon"></div>
              <p><strong>AI Generation Failed</strong></p>
              <p style="font-size: 0.85rem; margin-top: 8px;">${error.message}</p>
              <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                <button class="smart-meal-btn primary" onclick="generateMealIdeas()">Try Again</button>
                <button class="smart-meal-btn" onclick="useOfflineMeals()">Use Offline Meals</button>
              </div>
            </div>
          `;
        }
      }
    }

    function useOfflineMeals() {
      const fallbackMeals = FALLBACK_MEALS[currentMealType] || FALLBACK_MEALS.dinner;

      // Filter by dislikes
      let filteredMeals = fallbackMeals.filter(meal => {
        const mealText = (meal.name + ' ' + meal.ingredients.map(i => i.name).join(' ')).toLowerCase();
        return !mealPreferences.dislikes.some(dislike =>
          mealText.includes(dislike.toLowerCase())
        );
      });

      // Filter by diet
      if (mealPreferences.diet === 'vegetarian' || mealPreferences.diet === 'vegan') {
        const meatKeywords = ['chicken', 'beef', 'pork', 'lamb', 'fish', 'salmon', 'tuna', 'prawn', 'bacon', 'ham', 'mince', 'steak'];
        filteredMeals = filteredMeals.filter(meal => {
          const mealText = (meal.name + ' ' + meal.ingredients.map(i => i.name).join(' ')).toLowerCase();
          return !meatKeywords.some(meat => mealText.includes(meat));
        });
      }

      // Shuffle and take 20
      filteredMeals = filteredMeals.sort(() => Math.random() - 0.5).slice(0, 20);

      // Add unique IDs
      mealIdeas = filteredMeals.map((meal, index) => ({
        ...meal,
        id: Date.now() + index
      }));

      selectedMealIds.clear();
      renderMealIdeasGrid();

      // Show toast that we're using offline meals
      showToast('Using offline meals (AI unavailable)', 'info');
    }

    function getAuthenticityBadgeClass(score) {
      if (score >= 7) return 'score-high';
      if (score >= 4) return 'score-medium';
      return 'score-low';
    }

    function renderMealIdeasGrid() {
      const grid = document.getElementById('mealIdeasGrid');

      if (mealIdeas.length === 0) {
        grid.innerHTML = `
          <div class="meal-ideas-empty">
            <div class="meal-ideas-empty-icon"></div>
            <p>Tap "Generate Ideas" to get personalized meal suggestions!</p>
          </div>
        `;
        return;
      }

      // Helper function to render a meal card
      const renderMealCard = (meal, category = 'meal') => {
        const auditScore = meal.audit?.score;
        const badgeClass = auditScore ? getAuthenticityBadgeClass(auditScore) : '';

        return `
        <div class="meal-idea-card ${selectedMealIds.has(meal.id) ? 'selected' : ''}"
             onclick="toggleMealSelection(${meal.id})"
             ondblclick="expandMealCard(${meal.id}, '${category}')">
          <div class="meal-idea-checkbox">${selectedMealIds.has(meal.id) ? '' : ''}</div>
          ${auditScore ? `
            <div class="authenticity-badge ${badgeClass}">
               ${auditScore}/10
            </div>
          ` : ''}
          ${category !== 'meal' ? `<div class="meal-category-tag ${category}">${category}</div>` : ''}
          <div class="meal-idea-image">${meal.emoji || ''}</div>
          <div class="meal-idea-content">
            ${meal.cuisine ? `<div class="meal-idea-cuisine">${meal.cuisine}</div>` : ''}
            <div class="meal-idea-name">${meal.name}</div>
            ${meal.description ? `<div class="meal-idea-description">${meal.description}</div>` : ''}
            <div class="meal-idea-meta">${meal.time || '30 min'}  ${meal.servings || 4} servings</div>
          </div>
        </div>
      `};

      // Build the grid with all categories
      let gridHTML = '';

      // Main Meals Section
      gridHTML += `
        <div class="meal-section-header">
          <h3> Main Meals (${mealIdeas.length})</h3>
        </div>
      `;
      gridHTML += mealIdeas.map(meal => renderMealCard(meal, 'meal')).join('');

      // Entrees Section
      const entrees = window.entreeIdeas || [];
      if (entrees.length > 0) {
        gridHTML += `
          <div class="meal-section-header">
            <h3> Entrees & Starters (${entrees.length})</h3>
          </div>
        `;
        gridHTML += entrees.map(e => renderMealCard(e, 'entree')).join('');
      }

      // Snacks Section
      const snacks = window.snackIdeas || [];
      if (snacks.length > 0) {
        const sweetSnacks = snacks.filter(s => s.type === 'sweet');
        const savourySnacks = snacks.filter(s => s.type === 'savoury' || s.type === 'savory');

        if (sweetSnacks.length > 0) {
          gridHTML += `
            <div class="meal-section-header">
              <h3> Sweet Snacks (${sweetSnacks.length})</h3>
            </div>
          `;
          gridHTML += sweetSnacks.map(s => renderMealCard(s, 'snack-sweet')).join('');
        }

        if (savourySnacks.length > 0) {
          gridHTML += `
            <div class="meal-section-header">
              <h3> Savoury Snacks (${savourySnacks.length})</h3>
            </div>
          `;
          gridHTML += savourySnacks.map(s => renderMealCard(s, 'snack-savoury')).join('');
        }

        // If snacks don't have type, show them all together
        const untypedSnacks = snacks.filter(s => !s.type || (s.type !== 'sweet' && s.type !== 'savoury' && s.type !== 'savory'));
        if (untypedSnacks.length > 0 && sweetSnacks.length === 0 && savourySnacks.length === 0) {
          gridHTML += `
            <div class="meal-section-header">
              <h3> Snacks (${untypedSnacks.length})</h3>
            </div>
          `;
          gridHTML += untypedSnacks.map(s => renderMealCard(s, 'snack')).join('');
        }
      }

      // Desserts Section
      const desserts = window.dessertIdeas || [];
      if (desserts.length > 0) {
        gridHTML += `
          <div class="meal-section-header">
            <h3> Desserts (${desserts.length})</h3>
          </div>
        `;
        gridHTML += desserts.map(d => renderMealCard(d, 'dessert')).join('');
      }

      grid.innerHTML = gridHTML;
      updateSelectionBar();
    }

    function toggleMealSelection(mealId) {
      if (selectedMealIds.has(mealId)) {
        selectedMealIds.delete(mealId);
      } else {
        selectedMealIds.add(mealId);
      }
      renderMealIdeasGrid();
    }

    function updateSelectionBar() {
      const bar = document.getElementById('mealSelectionBar');
      const count = selectedMealIds.size;

      if (count > 0) {
        bar.style.display = 'flex';
        document.getElementById('selectedMealCount').textContent = `${count} meal${count > 1 ? 's' : ''} selected`;
      } else {
        bar.style.display = 'none';
      }
    }

    // Helper to get ingredient name (handles both string and object formats)
    function getIngredientName(ing) {
      return typeof ing === 'string' ? ing : (ing.name || '');
    }

    function getIngredientDisplay(ing) {
      if (typeof ing === 'string') return ing;
      const name = ing.name || '';
      const qty = ing.quantity || '';
      const price = ing.estimatedPrice ? ` (~$${ing.estimatedPrice.toFixed(2)})` : '';
      return qty ? `${qty} ${name}${price}` : `${name}${price}`;
    }

    function expandMealCard(mealId, category = 'meal') {
      // Search in the appropriate array based on category
      let meal;
      if (category === 'meal') {
        meal = mealIdeas.find(m => m.id === mealId);
      } else if (category === 'entree') {
        meal = (window.entreeIdeas || []).find(m => m.id === mealId);
      } else if (category === 'snack' || category === 'snack-sweet' || category === 'snack-savoury') {
        meal = (window.snackIdeas || []).find(m => m.id === mealId);
      } else if (category === 'dessert') {
        meal = (window.dessertIdeas || []).find(m => m.id === mealId);
      }

      // Fallback: search all arrays
      if (!meal) {
        meal = mealIdeas.find(m => m.id === mealId) ||
               (window.entreeIdeas || []).find(m => m.id === mealId) ||
               (window.snackIdeas || []).find(m => m.id === mealId) ||
               (window.dessertIdeas || []).find(m => m.id === mealId);
      }

      if (!meal) return;

      // Build audit section if available
      let auditHtml = '';
      if (meal.audit) {
        const scoreClass = meal.audit.score >= 7 ? 'high' : (meal.audit.score >= 4 ? 'medium' : 'low');
        const verdictClass = meal.audit.verdict === 'Approved' ? 'approved' : 'needs-improvement';

        auditHtml = `
          <div class="audit-section">
            <div class="audit-header">
              <div>
                <span style="font-size: 0.85rem; color: var(--text-muted);">Authenticity Score</span>
                <div class="audit-score ${scoreClass}">${meal.audit.score}/10</div>
              </div>
              <span class="audit-verdict ${verdictClass}">${meal.audit.verdict}</span>
            </div>
            ${meal.audit.positives?.length ? `
              <div class="audit-positives">
                <strong> What's authentic:</strong>
                <ul class="audit-list">
                  ${meal.audit.positives.map(p => `<li>${p}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${meal.audit.concerns?.length ? `
              <div class="audit-concerns">
                <strong> Concerns:</strong>
                <ul class="audit-list">
                  ${meal.audit.concerns.map(c => `<li>${c}</li>`).join('')}
                </ul>
              </div>
            ` : ''}
            ${meal.audit.suggestion ? `
              <div class="audit-suggestion">
                 ${meal.audit.suggestion}
              </div>
            ` : ''}
          </div>
        `;
      }

      // Build traditional tip if available
      let traditionalTipHtml = '';
      if (meal.traditionalTip) {
        traditionalTipHtml = `
          <div class="expanded-meal-section" style="background: #fff8e1; padding: 12px; border-radius: var(--radius-md); margin-top: 12px;">
            <h4 style="margin-bottom: 8px;"> Traditional Serving Tip</h4>
            <p style="font-size: 0.9rem; margin: 0; color: #5d4037;">${meal.traditionalTip}</p>
          </div>
        `;
      }

      document.getElementById('expandedMealTitle').textContent = meal.name;
      document.getElementById('expandedMealContent').innerHTML = `
        <div class="expanded-meal-image">${meal.emoji}</div>
        ${meal.cuisine ? `<div style="text-align: center; color: var(--primary); font-weight: 600; margin-bottom: 8px;">${meal.cuisine} Cuisine</div>` : ''}
        ${meal.description ? `<div class="expanded-meal-description">${meal.description}</div>` : ''}
        ${meal.authenticityNote ? `<div style="text-align: center; font-size: 0.8rem; color: var(--text-muted); font-style: italic; margin-bottom: 12px;"> ${meal.authenticityNote}</div>` : ''}

        ${auditHtml}

        <div class="expanded-meal-section">
          <h4> Ingredients (${meal.ingredients.length})</h4>
          <div class="expanded-ingredient-list">
            ${meal.ingredients.map(ing => {
              const display = getIngredientDisplay(ing);
              const note = ing.authenticNote ? ` <span style="font-size: 0.7rem; color: var(--text-muted);">(${ing.authenticNote})</span>` : '';
              return `<span class="expanded-ingredient">${display}${note}</span>`;
            }).join('')}
          </div>
        </div>

        <div class="expanded-meal-section">
          <h4> Steps</h4>
          <div class="expanded-steps-list">
            ${meal.steps.map((step, i) => `
              <div class="expanded-step">
                <div class="expanded-step-number">${i + 1}</div>
                <div class="expanded-step-text">${step}</div>
              </div>
            `).join('')}
          </div>
        </div>

        ${traditionalTipHtml}

        <div class="ai-attribution">
          <span> Generated by ${window.mealGeneratedBy || 'AI'}</span>
          <span> Audited by ${window.mealAuditedBy || 'GPT-4'}</span>
        </div>

        <div class="expanded-meal-actions">
          <button class="smart-meal-btn ${selectedMealIds.has(mealId) ? '' : 'primary'}"
                  onclick="toggleMealSelection(${mealId}); closeExpandedMeal(); renderMealIdeasGrid();">
            ${selectedMealIds.has(mealId) ? ' Selected' : '+ Select This Meal'}
          </button>
        </div>
      `;

      openModal('expandedMealSheet');
    }

    function closeExpandedMeal() {
      document.getElementById('expandedMealSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function openIngredientReview() {
      const selectedMeals = mealIdeas.filter(m => selectedMealIds.has(m.id));
      const allIngredients = [];

      selectedMeals.forEach(meal => {
        meal.ingredients.forEach(ing => {
          const name = getIngredientName(ing);
          const quantity = typeof ing === 'object' ? (ing.quantity || '') : '';
          if (!allIngredients.some(i => i.name === name)) {
            allIngredients.push({ name, quantity, checked: true, price: null });
          }
        });
      });

      const container = document.getElementById('ingredientReviewList');
      container.innerHTML = allIngredients.map((ing, i) => `
        <div class="ingredient-review-item">
          <input type="checkbox" id="ing_${i}" checked data-name="${ing.name}" data-quantity="${ing.quantity}">
          <label class="ingredient-review-name" for="ing_${i}">${ing.quantity ? ing.quantity + ' ' : ''}${ing.name}</label>
          <span class="ingredient-review-price" id="price_${i}">--</span>
        </div>
      `).join('');

      openModal('ingredientReviewSheet');
    }

    function closeIngredientReview() {
      document.getElementById('ingredientReviewSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    // Meal Plan Assignment Functions
    function openMealPlanAssignment() {
      const selectedMeals = mealIdeas.filter(m => selectedMealIds.has(m.id));

      if (selectedMeals.length === 0) {
        alert('Please select at least one meal first');
        return;
      }

      // Get dates for the next 14 days
      const dates = [];
      const today = new Date();
      for (let i = 0; i < 14; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const dateStr = d.toISOString().split('T')[0];
        const dayName = d.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short' });
        dates.push({ value: dateStr, label: dayName });
      }

      const container = document.getElementById('mealAssignmentList');
      container.innerHTML = selectedMeals.map((meal, i) => `
        <div class="meal-assignment-item" data-meal-id="${meal.id}">
          <div class="meal-assignment-header">
            <span class="meal-assignment-emoji">${meal.emoji}</span>
            <span class="meal-assignment-name">${meal.name}</span>
          </div>
          <div class="meal-assignment-selects">
            <select id="assignDate_${i}" class="assign-date">
              ${dates.map((d, idx) => `<option value="${d.value}" ${idx === i % 7 ? 'selected' : ''}>${d.label}</option>`).join('')}
            </select>
            <select id="assignType_${i}" class="assign-type">
              <option value="breakfast">Breakfast</option>
              <option value="lunch">Lunch</option>
              <option value="dinner" selected>Dinner</option>
            </select>
          </div>
        </div>
      `).join('');

      openModal('mealPlanAssignmentSheet');
    }

    function closeMealPlanAssignment() {
      document.getElementById('mealPlanAssignmentSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function confirmMealPlanAssignment() {
      const selectedMeals = mealIdeas.filter(m => selectedMealIds.has(m.id));
      let assignedCount = 0;

      selectedMeals.forEach((meal, i) => {
        const dateStr = document.getElementById(`assignDate_${i}`).value;
        const type = document.getElementById(`assignType_${i}`).value;

        if (!mealPlan[dateStr]) {
          mealPlan[dateStr] = {};
        }

        // Get ingredient names as strings
        const ingredients = meal.ingredients.map(ing => {
          if (typeof ing === 'string') return ing;
          return ing.quantity ? `${ing.quantity} ${ing.name}` : ing.name;
        });

        mealPlan[dateStr][type] = {
          name: meal.name,
          emoji: meal.emoji,
          ingredients: ingredients,
          steps: meal.steps || [],
          notes: meal.description || ''
        };

        assignedCount++;
      });

      saveMealPlan();
      closeMealPlanAssignment();

      // Clear selections and show success
      selectedMealIds.clear();
      renderMealIdeasGrid();

      // Switch to weekly tab to show the added meals
      switchMealTab('weekly');
      renderMealPlanner();

      // Show success message
      showToast(`Added ${assignedCount} meal${assignedCount > 1 ? 's' : ''} to your meal plan!`);
    }

    function showToast(message) {
      // Reuse the undo toast for general messages
      const toast = document.getElementById('undoToast');
      const textEl = toast.querySelector('.undo-toast-text');
      const btnEl = toast.querySelector('.undo-toast-btn');

      textEl.textContent = message;
      btnEl.style.display = 'none';

      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
        btnEl.style.display = '';
      }, 3000);
    }

    // Takeaway Deals Functions
    // Filter state
    let takeawayFilters = {
      dealType: 'all',
      budget: 'all',
      cuisines: []
    };

    function openTakeawayDeals() {
      const location = mealPreferences.location;
      const content = document.getElementById('takeawayDealsContent');
      const filters = document.getElementById('takeawayFilters');

      if (!location) {
        filters.style.display = 'none';
        content.innerHTML = `
          <div class="takeaway-no-location">
            <div style="font-size: 3rem; margin-bottom: 16px;"></div>
            <h4>Set Your Location First</h4>
            <p style="color: var(--text-muted); margin-bottom: 16px;">
              We need your location to find nearby takeaway deals.
            </p>
            <button class="smart-meal-btn primary" onclick="closeTakeawayDeals(); openMealPreferences(); switchPrefTab('stores');">
              Set Location
            </button>
          </div>
        `;
        openModal('takeawayDealsSheet');
        return;
      }

      // Show filters and reset content
      filters.style.display = 'block';
      content.innerHTML = `
        <div class="takeaway-deals-empty">
          <div style="font-size: 3rem; margin-bottom: 16px;"></div>
          <p>Set your filters above and tap "Search Deals"</p>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 8px;">
            Searching in: <strong>${location}</strong>
          </p>
        </div>
      `;

      openModal('takeawayDealsSheet');
    }

    function closeTakeawayDeals() {
      document.getElementById('takeawayDealsSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    function setTakeawayFilter(filterType, value, btn) {
      takeawayFilters[filterType] = value;

      // Update active state for this filter group
      const siblings = btn.parentElement.querySelectorAll('.filter-chip');
      siblings.forEach(chip => chip.classList.remove('active'));
      btn.classList.add('active');
    }

    function toggleCuisineFilter(cuisine, btn) {
      if (cuisine === 'all') {
        // Select "All" - clear other selections
        takeawayFilters.cuisines = [];
        const allChips = document.querySelectorAll('.filter-chip.cuisine');
        allChips.forEach(chip => chip.classList.remove('active'));
        btn.classList.add('active');
      } else {
        // Deselect "All" when selecting specific cuisine
        const allBtn = document.querySelector('.filter-chip.cuisine[data-cuisine="all"]');
        allBtn.classList.remove('active');

        // Toggle this cuisine
        const idx = takeawayFilters.cuisines.indexOf(cuisine);
        if (idx === -1) {
          takeawayFilters.cuisines.push(cuisine);
          btn.classList.add('active');
        } else {
          takeawayFilters.cuisines.splice(idx, 1);
          btn.classList.remove('active');
        }

        // If no cuisines selected, reselect "All"
        if (takeawayFilters.cuisines.length === 0) {
          allBtn.classList.add('active');
        }
      }
    }

    async function searchTakeawayWithFilters() {
      const location = mealPreferences.location;
      const content = document.getElementById('takeawayDealsContent');

      content.innerHTML = `
        <div class="takeaway-deals-empty">
          <div class="ai-loading-spinner"></div>
          <p>Searching for ${takeawayFilters.dealType === 'local' ? 'local' : takeawayFilters.dealType === 'chains' ? 'chain' : ''} deals near ${location}...</p>
          <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 8px;">Powered by Grok AI with real-time search</p>
        </div>
      `;

      try {
        const token = localStorage.getItem('google_id_token');
        if (!token) {
          renderTakeawayDeals(FALLBACK_TAKEAWAY_DEALS, true);
          return;
        }

        const response = await fetch('/api/takeaway/deals', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            location: location,
            dealType: takeawayFilters.dealType,
            cuisines: takeawayFilters.cuisines,
            budget: takeawayFilters.budget
          })
        });

        if (!response.ok) {
          console.log('API returned error, showing fallback');
          renderTakeawayDeals(FALLBACK_TAKEAWAY_DEALS, true);
          return;
        }

        const data = await response.json();
        renderTakeawayDeals(data.deals || FALLBACK_TAKEAWAY_DEALS);

      } catch (error) {
        console.error('Takeaway deals error:', error);
        renderTakeawayDeals(FALLBACK_TAKEAWAY_DEALS, true);
      }
    }

    // Fallback deals to show if API fails
    const FALLBACK_TAKEAWAY_DEALS = [
      {
        name: "McDonald's",
        emoji: "",
        type: "Fast Food",
        offers: [
          { description: " Buy 1 Get 1 Free Big Mac (App Exclusive)", price: "FREE" },
          { description: "25% Off Your Order (App First Order)", price: "25% OFF" },
          { description: "2 Small McChicken Meals for $12", price: "$12.00" },
          { description: "$6 Small McValue Meal", price: "$6.00" },
          { description: "Free Medium Fries with $15+ Order", price: "FREE" },
          { description: "Happy Meal + Extra Cheeseburger", price: "$9.95" }
        ],
        source: "McDonald's App"
      },
      {
        name: "KFC",
        emoji: "",
        type: "Fast Food",
        offers: [
          { description: " 2 for 1 Zinger Burgers (Tuesdays)", price: "2 FOR 1" },
          { description: "Family Feast: 10pc Chicken + 2 Large Sides", price: "$32.95" },
          { description: "$4.95 Lunch Deals (11am-4pm)", price: "$4.95" },
          { description: "Go Bucket + Drink Combo", price: "$7.95" },
          { description: "8 Wicked Wings for $8 (App Only)", price: "$8.00" },
          { description: "Zinger Stacker Box Meal", price: "$14.95" }
        ],
        source: "KFC App"
      },
      {
        name: "Domino's",
        emoji: "",
        type: "Pizza",
        offers: [
          { description: " Buy 1 Traditional Get 1 FREE (Pickup)", price: "2 FOR 1" },
          { description: "3 Traditional Pizzas Delivered", price: "$33.95" },
          { description: "Large Value Pizza Pickup", price: "$5.95" },
          { description: "2 Garlic Breads + 1.25L Drink", price: "$9.95" },
          { description: "50% Off Premium & Traditional (App)", price: "50% OFF" },
          { description: "Family Meal Deal: 3 Pizzas + 2 Sides + Drink", price: "$45.95" }
        ],
        source: "Domino's App"
      },
      {
        name: "Pizza Hut",
        emoji: "",
        type: "Pizza",
        offers: [
          { description: " 2 Large Pizzas for $25 Pickup", price: "$25.00" },
          { description: "All You Can Eat Lunch Buffet", price: "$16.95" },
          { description: "$1 Wings Wednesday (min 10)", price: "$1 each" },
          { description: "My Box: Pizza + Side + Drink", price: "$12.95" }
        ],
        source: "Pizza Hut App"
      },
      {
        name: "Hungry Jack's",
        emoji: "",
        type: "Fast Food",
        offers: [
          { description: " 2 Whopper Jnrs for $7.95", price: "$7.95" },
          { description: "Shake & Win - Free Food Daily (App)", price: "FREE" },
          { description: "$6 Stunner Meals", price: "$6.00" },
          { description: "Family Bundle: 4 Burgers + 4 Chips + Drinks", price: "$29.95" },
          { description: "2 Bacon Deluxe for $14", price: "$14.00" },
          { description: "Free Frozen Coke with Any Burger (App)", price: "FREE" }
        ],
        source: "Hungry Jack's App"
      },
      {
        name: "Subway",
        emoji: "",
        type: "Sandwiches",
        offers: [
          { description: " Buy 1 Footlong Get 1 50% Off", price: "50% OFF" },
          { description: "Sub of the Day", price: "$8.50" },
          { description: "Any Footlong for $10 (App)", price: "$10.00" },
          { description: "2 Footlongs for $18 (App Exclusive)", price: "$18.00" },
          { description: "Free Cookie with Sub Combo", price: "FREE" }
        ],
        source: "Subway App"
      },
      {
        name: "Guzman y Gomez",
        emoji: "",
        type: "Mexican",
        offers: [
          { description: " Free Burrito with 3 Burrito Order", price: "FREE" },
          { description: "Mini Burrito + Chips & Guac Combo", price: "$14.95" },
          { description: "$2 Taco Tuesdays (Pickup)", price: "$2 each" },
          { description: "Family Fiesta Pack: 4 Burritos + Nachos", price: "$49.95" }
        ],
        source: "GYG App"
      },
      {
        name: "Nando's",
        emoji: "",
        type: "Chicken",
        offers: [
          { description: " Buy Any Burger, Get Another FREE (App)", price: "2 FOR 1" },
          { description: "1/4 Chicken & Regular Side", price: "$12.95" },
          { description: "Whole Chicken + 2 Large Sides", price: "$32.95" },
          { description: "Double Your Points Mondays (Rewards)", price: "2X POINTS" }
        ],
        source: "Nando's App"
      },
      {
        name: "Red Rooster",
        emoji: "",
        type: "Chicken",
        offers: [
          { description: " $25 Roast Dinner (Whole Chicken + Sides)", price: "$25.00" },
          { description: "Rippa Roll Combo", price: "$9.95" },
          { description: "Family Reds Box: Whole Chicken + Chips", price: "$29.95" },
          { description: "$1 Pineapple Fritters (with any meal)", price: "$1.00" }
        ],
        source: "Red Rooster App"
      },
      {
        name: "Oporto",
        emoji: "",
        type: "Portuguese Chicken",
        offers: [
          { description: " 2 Bondi Burgers for $15", price: "$15.00" },
          { description: "$10 Lunch Deals (before 4pm)", price: "$10.00" },
          { description: "Whole Chicken + Large Chips", price: "$24.95" }
        ],
        source: "Oporto App"
      },
      {
        name: "Uber Eats",
        emoji: "",
        type: "Delivery",
        offers: [
          { description: " $15 Off First Order (New Users)", price: "$15 OFF" },
          { description: "Free Delivery from Select Restaurants", price: "FREE DELIVERY" },
          { description: "Buy 1 Get 1 Free - Featured Restaurants", price: "2 FOR 1" },
          { description: "Uber One: $0 Delivery Fee + 5% Off", price: "$9.99/month" }
        ],
        source: "Uber Eats App"
      },
      {
        name: "DoorDash",
        emoji: "",
        type: "Delivery",
        offers: [
          { description: " 50% Off First 2 Orders (New Users)", price: "50% OFF" },
          { description: "Free Delivery over $20", price: "FREE DELIVERY" },
          { description: "DashPass: $0 Delivery + Reduced Fees", price: "$13.99/month" },
          { description: "Weekly Restaurant Deals & Discounts", price: "UP TO 30% OFF" }
        ],
        source: "DoorDash App"
      },
      {
        name: "Local Charcoal Chicken",
        emoji: "",
        type: "Charcoal Chicken",
        offers: [
          { description: " Family Pack: Whole chicken + large chips + salad", price: "$34.95" },
          { description: "Student Deal: 1/4 chicken + chips + drink", price: "$12.90" },
          { description: "Tradies Pack: 3 chickens + 2 large chips + sauces", price: "$59.95" },
          { description: "Dinner Box: Chicken + chips + drink + coleslaw", price: "$18.00" }
        ],
        source: "Check local charcoal chicken shops"
      },
      {
        name: "Lebanese/Middle Eastern",
        emoji: "",
        type: "Lebanese",
        offers: [
          { description: " Mixed Plate: Shawarma + falafel + tabouleh + bread", price: "$18.95" },
          { description: "Family Platter: Kebabs + rice + salads (feeds 4)", price: "$49.95" },
          { description: "Lunch Special: Chicken wrap + chips + drink", price: "$14.50" },
          { description: "HSP (Halal Snack Pack) with garlic sauce", price: "$15.00" }
        ],
        source: "Local Lebanese restaurants"
      },
      {
        name: "Indian Restaurant",
        emoji: "",
        type: "Indian",
        offers: [
          { description: " Biryani Combo: Chicken biryani + curry + drink", price: "$22.99" },
          { description: "Family Feast: 2 curries + rice + naan + sides", price: "$45.00" },
          { description: "Lunch Thali: Rice + 2 curries + raita + papadum", price: "$15.95" }
        ],
        source: "Local Indian restaurants"
      },
      {
        name: "Thai Takeaway",
        emoji: "",
        type: "Thai",
        offers: [
          { description: " Pad Thai + Spring Rolls combo", price: "$16.95" },
          { description: "Green Curry + Jasmine Rice + Satay", price: "$18.50" },
          { description: "Tom Yum Soup + Fried Rice combo", price: "$19.95" },
          { description: "Free delivery on orders over $50", price: "FREE DELIVERY" }
        ],
        source: "Local Thai restaurants"
      },
      {
        name: "Chinese Restaurant",
        emoji: "",
        type: "Chinese",
        offers: [
          { description: " Lunch Special: Any main + rice + spring roll", price: "$13.95" },
          { description: "Family Banquet: 5 dishes + rice (feeds 4-5)", price: "$69.95" },
          { description: "Sweet & Sour Pork + Fried Rice combo", price: "$16.50" }
        ],
        source: "Local Chinese restaurants"
      }
    ];

    async function searchTakeawayDeals(location) {
      const content = document.getElementById('takeawayDealsContent');

      try {
        const token = localStorage.getItem('google_id_token');
        if (!token) {
          // No token - show fallback deals with a message
          console.log('No auth token, showing fallback deals');
          renderTakeawayDeals(FALLBACK_TAKEAWAY_DEALS, true);
          return;
        }

        const response = await fetch('/api/takeaway/deals', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ location })
        });

        if (!response.ok) {
          // API error - show fallback deals
          console.log('API returned error, showing fallback deals');
          renderTakeawayDeals(FALLBACK_TAKEAWAY_DEALS, true);
          return;
        }

        const data = await response.json();
        renderTakeawayDeals(data.deals || FALLBACK_TAKEAWAY_DEALS);

      } catch (error) {
        // Network error or other issue - show fallback deals
        console.error('Takeaway deals error:', error);
        renderTakeawayDeals(FALLBACK_TAKEAWAY_DEALS, true);
      }
    }

    function renderTakeawayDeals(deals, isFallback = false) {
      const content = document.getElementById('takeawayDealsContent');

      if (deals.length === 0) {
        content.innerHTML = `
          <div class="takeaway-deals-empty">
            <div style="font-size: 3rem; margin-bottom: 16px;"></div>
            <p>No current deals found with those filters.</p>
            <p style="font-size: 0.85rem; color: var(--text-muted);">Try different filters or search again!</p>
          </div>
        `;
        return;
      }

      const headerText = isFallback
        ? `<p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
            Popular fast food deals in Australia:
           </p>
           <p style="margin-bottom: 16px; padding: 10px; background: var(--warning-bg, rgba(255, 193, 7, 0.1)); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
             Tip: Check the apps below for current deals in your area!
           </p>`
        : `<p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
            Found ${deals.length} places with deals near you:
           </p>`;

      content.innerHTML = `
        ${headerText}
        <div class="takeaway-deals-list">
          ${deals.map(deal => `
            <div class="takeaway-deal-card ${deal.isChain === false ? 'local-restaurant' : ''}">
              <div class="takeaway-deal-header">
                <div class="takeaway-deal-logo">${deal.emoji || ''}</div>
                <div style="flex: 1;">
                  <div class="takeaway-deal-name">${deal.name}</div>
                  <div class="takeaway-deal-type">${deal.type || 'Fast Food'}${deal.isChain === false ? '  Local' : ''}</div>
                  ${deal.address ? `<div class="takeaway-deal-address"> ${deal.address}</div>` : ''}
                </div>
              </div>
              <div class="takeaway-deal-offers">
                ${(deal.offers || []).map(offer => `
                  <div class="takeaway-offer">
                    <span class="takeaway-offer-text">${offer.description}</span>
                    ${offer.price ? `<span class="takeaway-offer-price">${offer.price}</span>` : ''}
                  </div>
                `).join('')}
              </div>
              <div class="takeaway-deal-actions">
                ${deal.orderLink ? `<a href="${deal.orderLink}" target="_blank" class="takeaway-order-btn"> Order Now</a>` : ''}
                ${deal.phone ? `<a href="tel:${deal.phone}" class="takeaway-phone-btn"> ${deal.phone}</a>` : ''}
              </div>
              ${deal.source ? `<p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 8px;">Source: ${deal.source}</p>` : ''}
            </div>
          `).join('')}
        </div>
        <p style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted); text-align: center;">
          Deals may vary. Check with the restaurant for current offers.
        </p>
      `;
    }

    // Store Specials Functions
    function openStoreSpecials() {
      const location = mealPreferences.location;
      const content = document.getElementById('storeSpecialsContent');

      if (!location) {
        content.innerHTML = `
          <div class="takeaway-no-location">
            <div style="font-size: 3rem; margin-bottom: 16px;"></div>
            <h4>Set Your Location First</h4>
            <p style="color: var(--text-muted); margin-bottom: 16px;">
              We need your location to find specials at your local stores.
            </p>
            <button class="smart-meal-btn primary" onclick="closeStoreSpecials(); openMealPreferences(); switchPrefTab('stores');">
              Set Location
            </button>
          </div>
        `;
        openModal('storeSpecialsSheet');
        return;
      }

      content.innerHTML = `
        <div class="takeaway-deals-empty">
          <div class="ai-loading-spinner"></div>
          <p>Searching for specials near ${location}...</p>
        </div>
      `;

      openModal('storeSpecialsSheet');
      searchStoreSpecials(location);
    }

    function closeStoreSpecials() {
      document.getElementById('storeSpecialsSheet').classList.remove('open');
      document.getElementById('modalOverlay').classList.remove('open');
    }

    // Fallback store specials to show if API fails
    const FALLBACK_STORE_SPECIALS = [
      {
        name: "Woolworths",
        emoji: "",
        category: "Supermarket",
        items: [
          { name: "Chicken Breast", detail: "1kg", wasPrice: "12.00", nowPrice: "9.00", save: "3.00" },
          { name: "Strawberries", detail: "250g punnet", wasPrice: "5.00", nowPrice: "2.50", save: "2.50" },
          { name: "Tip Top Bread", detail: "700g", wasPrice: "4.40", nowPrice: "2.95", save: "1.45" }
        ]
      },
      {
        name: "Coles",
        emoji: "",
        category: "Supermarket",
        items: [
          { name: "Beef Mince", detail: "500g", wasPrice: "10.00", nowPrice: "7.50", save: "2.50" },
          { name: "Avocados", detail: "Each", wasPrice: "3.00", nowPrice: "1.50", save: "1.50" },
          { name: "Pork Loin Chops", detail: "Per kg", wasPrice: "16.00", nowPrice: "12.00", save: "4.00" }
        ]
      },
      {
        name: "ALDI",
        emoji: "",
        category: "Discount Supermarket",
        items: [
          { name: "Salmon Fillets", detail: "300g", nowPrice: "8.99" },
          { name: "Mixed Vegetables", detail: "1kg frozen", nowPrice: "3.49" },
          { name: "Free Range Eggs", detail: "12 pack", nowPrice: "5.49" }
        ]
      },
      {
        name: "IGA",
        emoji: "",
        category: "Supermarket",
        items: [
          { name: "Lamb Leg Roast", detail: "Per kg", wasPrice: "18.00", nowPrice: "14.00", save: "4.00" },
          { name: "Bananas", detail: "Per kg", wasPrice: "3.50", nowPrice: "2.50", save: "1.00" }
        ]
      }
    ];

    async function searchStoreSpecials(location) {
      const content = document.getElementById('storeSpecialsContent');

      try {
        const token = localStorage.getItem('google_id_token');
        if (!token) {
          // No token - show fallback specials
          console.log('No auth token, showing fallback store specials');
          renderStoreSpecials(FALLBACK_STORE_SPECIALS, true);
          return;
        }

        const response = await fetch('/api/store/specials', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ location })
        });

        if (!response.ok) {
          // API error - show fallback specials
          console.log('API returned error, showing fallback store specials');
          renderStoreSpecials(FALLBACK_STORE_SPECIALS, true);
          return;
        }

        const data = await response.json();
        renderStoreSpecials(data.specials || FALLBACK_STORE_SPECIALS);

      } catch (error) {
        // Network error or other issue - show fallback specials
        console.error('Store specials error:', error);
        renderStoreSpecials(FALLBACK_STORE_SPECIALS, true);
      }
    }

    function renderStoreSpecials(specials, isFallback = false) {
      const content = document.getElementById('storeSpecialsContent');

      if (specials.length === 0) {
        content.innerHTML = `
          <div class="takeaway-deals-empty">
            <div style="font-size: 3rem; margin-bottom: 16px;"></div>
            <p>No current specials found in your area.</p>
            <p style="font-size: 0.85rem; color: var(--text-muted);">Check back later for new deals!</p>
          </div>
        `;
        return;
      }

      const headerText = isFallback
        ? `<p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
            Popular supermarket specials in Australia:
           </p>
           <p style="margin-bottom: 16px; padding: 10px; background: var(--warning-bg, rgba(255, 193, 7, 0.1)); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
             Tip: Check the Woolworths, Coles or ALDI apps for specials near you!
           </p>`
        : `<p style="margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem;">
            This week's specials at stores near you:
           </p>`;

      content.innerHTML = `
        ${headerText}
        <div class="store-specials-list">
          ${specials.map(store => `
            <div class="store-special-card">
              <div class="store-special-header">
                <div class="store-special-logo">${store.emoji || ''}</div>
                <div>
                  <div class="store-special-name">${store.name}</div>
                  <div class="store-special-category">${store.category || 'Supermarket'}</div>
                </div>
              </div>
              <div class="store-special-items">
                ${store.items.map(item => `
                  <div class="special-item">
                    <div class="special-item-info">
                      <div class="special-item-name">${item.name}</div>
                      ${item.detail ? `<div class="special-item-detail">${item.detail}</div>` : ''}
                    </div>
                    <div class="special-item-prices">
                      ${item.wasPrice ? `<div class="special-item-was">$${item.wasPrice}</div>` : ''}
                      <div class="special-item-now">$${item.nowPrice}</div>
                      ${item.save ? `<div class="special-item-save">Save $${item.save}</div>` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('')}
        </div>
        <p style="margin-top: 16px; font-size: 0.8rem; color: var(--text-muted); text-align: center;">
          Specials valid this week. Prices may vary by store.
        </p>
      `;
    }

    async function addIngredientsWithPricing() {
      const checkboxes = document.querySelectorAll('#ingredientReviewList input[type="checkbox"]:checked');
      const quality = document.querySelector('input[name="quality"]:checked')?.value || 'standard';

      const ingredients = Array.from(checkboxes).map(cb => ({
        name: cb.dataset.name,
        quantity: cb.dataset.quantity || ''
      }));

      // Show loading
      const btn = document.querySelector('#ingredientReviewSheet .form-submit');
      btn.textContent = ' Searching real prices...';
      btn.disabled = true;

      let totalCost = 0;
      let priceData = null;

      try {
        const token = localStorage.getItem('google_id_token');
        if (!token) {
          throw new Error('Please sign in with Google to search prices');
        }

        // Get preferred store from preferences
        const preferredStore = mealPreferences.preferredStore || 'woolworths';

        const response = await fetch('/api/prices/search', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            ingredients: ingredients,
            stores: [preferredStore],  // Use single preferred store
            quality: quality
          })
        });

        if (!response.ok) {
          throw new Error('Price lookup failed');
        }

        priceData = await response.json();

        // Update prices in UI
        if (priceData && priceData.ingredients) {
          priceData.ingredients.forEach((item, i) => {
            if (item.price) {
              const priceEl = document.getElementById(`price_${i}`);
              if (priceEl) {
                priceEl.textContent = `$${item.price.toFixed(2)}`;
                priceEl.title = `${item.brand} @ ${item.store}`;
              }
            }
          });
          totalCost = priceData.totalEstimate || 0;
        }
      } catch (error) {
        console.error('Price lookup error:', error);
        // Fallback to estimated prices
        const priceMultiplier = quality === 'budget' ? 0.7 : quality === 'premium' ? 1.4 : 1;
        checkboxes.forEach((cb, i) => {
          const basePrice = (Math.random() * 6 + 2);
          const price = (basePrice * priceMultiplier).toFixed(2);
          totalCost += parseFloat(price);
          document.getElementById(`price_${i}`).textContent = `~$${price}`;
        });
      }

      // Add to shopping list with price info
      ingredients.forEach((ing, i) => {
        const priceInfo = priceData?.ingredients?.[i];
        const newItem = {
          id: 'shop_' + Date.now() + Math.random(),
          name: ing.quantity ? `${ing.quantity} ${ing.name}` : ing.name,
          category: guessCategory(ing.name),
          completed: false,
          createdAt: new Date().toISOString(),
          price: priceInfo?.price || null,
          store: priceInfo?.store || null,
          brand: priceInfo?.brand || null
        };
        shoppingItems.push(newItem);
      });

      saveShoppingList();

      btn.textContent = ` Added! Est. Total: $${totalCost.toFixed(2)}`;

      setTimeout(() => {
        closeIngredientReview();
        selectedMealIds.clear();
        renderMealIdeasGrid();
        btn.textContent = ' Find Best Prices & Add to List';
        btn.disabled = false;
        showToast(`${ingredients.length} ingredients added!\nEstimated total: $${totalCost.toFixed(2)}`);
      }, 1500);
    }

    function guessCategory(ingredient) {
      const lower = ingredient.toLowerCase();
      if (lower.includes('chicken') || lower.includes('beef') || lower.includes('pork') || lower.includes('lamb') || lower.includes('fish') || lower.includes('salmon') || lower.includes('prawn')) return 'meat';
      if (lower.includes('milk') || lower.includes('cheese') || lower.includes('cream') || lower.includes('butter') || lower.includes('parmesan')) return 'dairy';
      if (lower.includes('bread') || lower.includes('bun') || lower.includes('tortilla')) return 'bakery';
      if (lower.includes('rice') || lower.includes('pasta') || lower.includes('oil') || lower.includes('sauce') || lower.includes('stock')) return 'pantry';
      if (lower.includes('onion') || lower.includes('garlic') || lower.includes('tomato') || lower.includes('lettuce') || lower.includes('cabbage') || lower.includes('broccoli') || lower.includes('spinach') || lower.includes('mushroom') || lower.includes('potato') || lower.includes('capsicum') || lower.includes('avocado') || lower.includes('lime') || lower.includes('lemon') || lower.includes('asparagus') || lower.includes('bean') || lower.includes('herb') || lower.includes('coriander') || lower.includes('dill') || lower.includes('rosemary')) return 'produce';
      return 'other';
    }

    function getWeekDates(offset = 0) {
      const today = new Date();
      const currentDay = today.getDay();
      const mondayOffset = currentDay === 0 ? -6 : 1 - currentDay;

      const monday = new Date(today);
      monday.setDate(today.getDate() + mondayOffset + (offset * 7));

      const days = [];
      const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

      for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        days.push({
          name: dayNames[i],
          date: date,
          dateStr: date.toISOString().split('T')[0],
          isToday: date.toDateString() === today.toDateString()
        });
      }

      return days;
    }

    function renderMealPlanner() {
      const days = getWeekDates(mealWeekOffset);

      // Update week title
      const firstDay = days[0].date;
      const lastDay = days[6].date;
      const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

      let title = '';
      if (mealWeekOffset === 0) {
        title = 'This Week';
      } else if (mealWeekOffset === 1) {
        title = 'Next Week';
      } else if (mealWeekOffset === -1) {
        title = 'Last Week';
      } else {
        title = `${monthNames[firstDay.getMonth()]} ${firstDay.getDate()} - ${monthNames[lastDay.getMonth()]} ${lastDay.getDate()}`;
      }
      document.getElementById('mealWeekTitle').textContent = title;

      // Render days
      const container = document.getElementById('mealDays');
      container.innerHTML = days.map((day, index) => {
        const meals = mealPlan[day.dateStr] || {};

        return `
          <div class="meal-day">
            <div class="meal-day-header ${day.isToday ? 'today' : ''}">
              <span class="meal-day-name">${day.name}</span>
              <span class="meal-day-date">${day.date.getDate()} ${monthNames[day.date.getMonth()]}</span>
            </div>
            <div class="meal-slots">
              ${renderMealSlot(day.dateStr, 'breakfast', meals.breakfast)}
              ${renderMealSlot(day.dateStr, 'lunch', meals.lunch)}
              ${renderMealSlot(day.dateStr, 'dinner', meals.dinner)}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderMealSlot(dateStr, type, meal) {
      const typeLabels = { breakfast: 'Brekky', lunch: 'Lunch', dinner: 'Dinner' };

      if (!meal) {
        return `
          <div class="meal-slot">
            <span class="meal-slot-type">${typeLabels[type]}</span>
            <div class="meal-slot-content">
              <span class="meal-slot-empty" onclick="openAddMealSheet('${dateStr}', '${type}')">+ Add meal</span>
            </div>
          </div>
        `;
      }

      return `
        <div class="meal-slot">
          <span class="meal-slot-type">${typeLabels[type]}</span>
          <div class="meal-slot-content">
            <div class="meal-slot-filled">
              ${meal.emoji ? `<span class="meal-slot-emoji">${meal.emoji}</span>` : ''}
              <div class="meal-slot-info">
                <div class="meal-slot-name">${meal.name}</div>
                ${meal.notes ? `<div class="meal-slot-notes">${meal.notes}</div>` : ''}
              </div>
              <div class="meal-slot-actions">
                <button class="meal-slot-btn" onclick="openAddMealSheet('${dateStr}', '${type}')" title="Edit"></button>
                <button class="meal-slot-btn" onclick="deleteMeal('${dateStr}', '${type}')" title="Remove"></button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function changeMealWeek(delta) {
      mealWeekOffset += delta;
      renderMealPlanner();
    }

    function openAddMealSheet(dateStr, type) {
      document.getElementById('mealDayIndex').value = dateStr;
      document.getElementById('mealType').value = type;

      const existingMeal = mealPlan[dateStr]?.[type];
      if (existingMeal) {
        document.getElementById('mealName').value = existingMeal.name || '';
        document.getElementById('mealIngredients').value = (existingMeal.ingredients || []).join('\n');
        document.getElementById('mealNotes').value = existingMeal.notes || '';
      } else {
        document.getElementById('mealName').value = '';
        document.getElementById('mealIngredients').value = '';
        document.getElementById('mealNotes').value = '';
      }

      openModal('addMealSheet');
    }

    function closeAddMealSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('addMealSheet').classList.remove('open');
    }

    function saveMeal() {
      const dateStr = document.getElementById('mealDayIndex').value;
      const type = document.getElementById('mealType').value;
      const name = document.getElementById('mealName').value.trim();
      const ingredientsText = document.getElementById('mealIngredients').value.trim();
      const notes = document.getElementById('mealNotes').value.trim();

      if (!name) {
        alert('Please enter a meal name');
        return;
      }

      const ingredients = ingredientsText
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.length > 0);

      if (!mealPlan[dateStr]) {
        mealPlan[dateStr] = {};
      }

      mealPlan[dateStr][type] = {
        name,
        ingredients,
        notes
      };

      saveMealPlan();
      closeAddMealSheet();
      renderMealPlanner();
    }

    function deleteMeal(dateStr, type) {
      if (mealPlan[dateStr] && mealPlan[dateStr][type]) {
        delete mealPlan[dateStr][type];
        if (Object.keys(mealPlan[dateStr]).length === 0) {
          delete mealPlan[dateStr];
        }
        saveMealPlan();
        renderMealPlanner();
      }
    }

    function generateShoppingFromMeals() {
      const days = getWeekDates(mealWeekOffset);
      const ingredients = [];

      days.forEach(day => {
        const meals = mealPlan[day.dateStr] || {};
        ['breakfast', 'lunch', 'dinner'].forEach(type => {
          if (meals[type] && meals[type].ingredients) {
            meals[type].ingredients.forEach(ing => {
              if (!ingredients.includes(ing.toLowerCase())) {
                ingredients.push(ing);
              }
            });
          }
        });
      });

      if (ingredients.length === 0) {
        alert('No ingredients found in meal plan for this week');
        return;
      }

      // Add to shopping list (avoid duplicates)
      const existingNames = shoppingItems.map(i => i.name.toLowerCase());
      let added = 0;

      ingredients.forEach(ing => {
        if (!existingNames.includes(ing.toLowerCase())) {
          shoppingItems.push({
            id: 'shop_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
            name: ing,
            category: 'other',
            completed: false,
            createdAt: new Date().toISOString()
          });
          added++;
        }
      });

      saveShoppingList();

      if (added > 0) {
        alert(`Added ${added} ingredient${added !== 1 ? 's' : ''} to shopping list`);
        toggleMealPlannerView();
        toggleShoppingView();
      } else {
        alert('All ingredients are already in your shopping list');
      }
    }

    function generateListFromMeals() {
      // Switch to meal planner to generate from there
      toggleShoppingView();
      toggleMealPlannerView();
    }

    // ========================================
    // ADHD TASK BREAKDOWN FUNCTIONS
    // ========================================
    let adhdTasks = [];
    let adhdTaskViewVisible = false;

    function loadAdhdTasks() {
      adhdTasks = JSON.parse(localStorage.getItem(getUserStorageKey('life_adhd_tasks')) || '[]');
    }

    function saveAdhdTasks() {
      localStorage.setItem(getUserStorageKey('life_adhd_tasks'), JSON.stringify(adhdTasks));
    }
    let currentBreakdownTask = null;
    let clarificationQuestions = [];
    let clarificationAnswers = {};
    let currentQuestionIndex = 0;
    let currentFocusTask = null;
    let currentStepIndex = 0;
    let focusTimerInterval = null;
    let focusTimerSeconds = 300; // 5 minutes

    // Common ambiguous words and their clarification options
    const ambiguousTerms = {
      'clean': {
        question: 'What kind of cleaning do you mean?',
        options: [
          { value: 'tidy', label: ' Quick tidy up - put things away' },
          { value: 'deep', label: ' Deep clean - scrub and sanitize' },
          { value: 'declutter', label: ' Declutter - sort and remove items' },
          { value: 'organize', label: ' Organize - create systems' }
        ]
      },
      'organize': {
        question: 'What does organizing mean for this task?',
        options: [
          { value: 'sort', label: ' Sort into categories' },
          { value: 'label', label: ' Label and store properly' },
          { value: 'digital', label: ' Digital organization (files/apps)' },
          { value: 'schedule', label: ' Plan and schedule things' }
        ]
      },
      'fix': {
        question: 'What kind of fixing is needed?',
        options: [
          { value: 'repair', label: ' Physical repair' },
          { value: 'resolve', label: ' Resolve an issue/conflict' },
          { value: 'update', label: ' Update or improve' },
          { value: 'troubleshoot', label: ' Find and fix a problem' }
        ]
      },
      'sort': {
        question: 'How would you like to sort things?',
        options: [
          { value: 'keep_donate', label: ' Keep vs donate/trash' },
          { value: 'categorize', label: ' By category or type' },
          { value: 'priority', label: ' By priority/importance' },
          { value: 'alphabetical', label: ' Alphabetically or by date' }
        ]
      },
      'prepare': {
        question: 'What kind of preparation?',
        options: [
          { value: 'gather', label: ' Gather items/materials' },
          { value: 'plan', label: ' Create a plan' },
          { value: 'practice', label: ' Practice or rehearse' },
          { value: 'research', label: ' Research and learn' }
        ]
      },
      'do': {
        question: 'Can you be more specific about what you need to do?',
        options: [
          { value: 'complete', label: ' Complete a specific task' },
          { value: 'start', label: ' Start something new' },
          { value: 'continue', label: ' Continue something in progress' },
          { value: 'finish', label: ' Finish something almost done' }
        ]
      }
    };

    function toggleAdhdTaskView() {
      // Close other views first
      if (calendarVisible) toggleCalendarView();
      if (shoppingVisible) toggleShoppingView();
      if (mealPlannerVisible) toggleMealPlannerView();

      adhdTaskViewVisible = !adhdTaskViewVisible;
      const adhdView = document.getElementById('adhdTaskView');
      const adhdBtn = document.getElementById('adhdTaskToggleBtn');

      if (adhdTaskViewVisible) {
        adhdView.classList.add('visible');
        document.getElementById('mainScrollArea').style.display = 'none';
        adhdBtn.style.background = 'var(--adult)';
        adhdBtn.style.color = 'white';
        showAdhdInputSection();
        renderAdhdTaskList();
      } else {
        adhdView.classList.remove('visible');
        document.getElementById('mainScrollArea').style.display = 'block';
        adhdBtn.style.background = '';
        adhdBtn.style.color = '';
      }
    }

    function showAdhdInputSection() {
      document.getElementById('adhdInputSection').style.display = 'block';
      document.getElementById('adhdClarifySection').style.display = 'none';
      document.getElementById('adhdFocusSection').style.display = 'none';
    }

    function renderAdhdTaskList() {
      const container = document.getElementById('adhdTaskList');
      const section = document.getElementById('adhdExistingTasks');

      if (adhdTasks.length === 0) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';

      container.innerHTML = adhdTasks.map(task => {
        const completedSteps = task.steps.filter(s => s.completed).length;
        const totalSteps = task.steps.length;
        const progress = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;
        const isCompleted = progress === 100;

        return `
          <div class="adhd-task-item ${isCompleted ? 'completed' : ''}" onclick="enterFocusMode('${task.id}')">
            <div class="adhd-task-progress-ring" style="--progress: ${progress}%">
              <div class="adhd-task-progress-inner">${progress}%</div>
            </div>
            <div class="adhd-task-info">
              <div class="adhd-task-name">${task.name}</div>
              <div class="adhd-task-meta">${completedSteps} of ${totalSteps} steps done</div>
            </div>
            <div class="adhd-task-actions" onclick="event.stopPropagation()">
              <button class="adhd-task-action-btn" onclick="deleteAdhdTask('${task.id}')" title="Delete"></button>
            </div>
          </div>
        `;
      }).join('');
    }

    function startTaskBreakdown() {
      const input = document.getElementById('adhdTaskInput');
      const taskText = input.value.trim();

      if (!taskText) {
        alert('Please enter a task first');
        return;
      }

      currentBreakdownTask = taskText;
      clarificationAnswers = {};
      clarificationQuestions = [];
      currentQuestionIndex = 0;

      // Check for ambiguous terms
      const lowerTask = taskText.toLowerCase();
      for (const [term, data] of Object.entries(ambiguousTerms)) {
        if (lowerTask.includes(term)) {
          clarificationQuestions.push({
            term,
            question: data.question,
            options: data.options
          });
        }
      }

      // If we have clarification questions, show them
      if (clarificationQuestions.length > 0) {
        showClarificationQuestion();
      } else {
        // No clarification needed, go straight to breakdown
        generateTaskBreakdown();
      }
    }

    function showClarificationQuestion() {
      document.getElementById('adhdInputSection').style.display = 'none';
      document.getElementById('adhdClarifySection').style.display = 'block';

      const q = clarificationQuestions[currentQuestionIndex];
      document.getElementById('clarifyQuestion').textContent = q.question;
      document.getElementById('clarifyProgress').textContent =
        `Question ${currentQuestionIndex + 1} of ${clarificationQuestions.length}`;

      const optionsContainer = document.getElementById('clarifyOptions');
      optionsContainer.innerHTML = q.options.map(opt => `
        <button class="adhd-clarify-option" onclick="selectClarificationOption('${q.term}', '${opt.value}', this)">
          ${opt.label}
        </button>
      `).join('');

      document.getElementById('clarifyCustomInput').value = '';
    }

    function selectClarificationOption(term, value, btn) {
      // Remove selected from siblings
      document.querySelectorAll('.adhd-clarify-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');

      clarificationAnswers[term] = value;

      // Auto-advance after short delay
      setTimeout(() => {
        nextClarificationQuestion();
      }, 300);
    }

    function submitCustomClarification() {
      const input = document.getElementById('clarifyCustomInput');
      const value = input.value.trim();
      if (!value) return;

      const q = clarificationQuestions[currentQuestionIndex];
      clarificationAnswers[q.term] = value;
      nextClarificationQuestion();
    }

    function nextClarificationQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < clarificationQuestions.length) {
        showClarificationQuestion();
      } else {
        // All questions answered, generate breakdown
        generateTaskBreakdown();
      }
    }

    function cancelClarification() {
      showAdhdInputSection();
    }

    async function generateTaskBreakdown() {
      // Show loading modal
      openModal('adhdBreakdownSheet');
      document.getElementById('adhdLoading').style.display = 'block';
      document.getElementById('adhdBreakdownResult').style.display = 'none';

      // Build context from clarifications
      let context = currentBreakdownTask;
      if (Object.keys(clarificationAnswers).length > 0) {
        context += '\n\nClarifications:';
        for (const [term, value] of Object.entries(clarificationAnswers)) {
          context += `\n- "${term}" means: ${value}`;
        }
      }

      try {
        // Try AI-powered breakdown first
        const idToken = localStorage.getItem('google_id_token');
        let steps = [];

        if (idToken) {
          try {
            const response = await fetch('/api/tasks/breakdown', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}`
              },
              body: JSON.stringify({ task: context })
            });

            if (response.ok) {
              const data = await response.json();
              steps = data.steps || [];
            }
          } catch (e) {
            console.log('AI breakdown not available, using local fallback');
          }
        }

        // Fallback to local breakdown if AI didn't work
        if (steps.length === 0) {
          steps = generateLocalBreakdown(currentBreakdownTask, clarificationAnswers);
        }

        showBreakdownResult(steps);
      } catch (error) {
        console.error('Breakdown error:', error);
        const steps = generateLocalBreakdown(currentBreakdownTask, clarificationAnswers);
        showBreakdownResult(steps);
      }
    }

    function generateLocalBreakdown(task, clarifications) {
      // Smart context-aware breakdown
      const lowerTask = task.toLowerCase();
      let steps = [];

      // Extract potential person name from task
      const personMatch = task.match(/(?:get |help |prepare |ready |for )?(\b[A-Z][a-z]+\b)(?:'s| ready| prepared| for| to)/i);
      const personName = personMatch ? personMatch[1] : null;

      // Get clarification context
      const cleanType = clarifications['clean'] || 'tidy';
      const organizeType = clarifications['organize'] || 'sort';

      // ===== TRAVEL / TRIP PREPARATION =====
      if (lowerTask.includes('trip') || lowerTask.includes('travel') || lowerTask.includes('holiday') ||
          lowerTask.includes('vacation') || lowerTask.includes('ready for') &&
          (lowerTask.includes('china') || lowerTask.includes('overseas') || lowerTask.includes('flight') ||
           lowerTask.includes('airport') || lowerTask.includes('japan') || lowerTask.includes('europe') ||
           lowerTask.includes('usa') || lowerTask.includes('america') || lowerTask.includes('bali') ||
           lowerTask.includes('thailand') || lowerTask.includes('vietnam') || lowerTask.includes('uk') ||
           lowerTask.includes('new zealand') || lowerTask.includes('fiji'))) {

        const destination = task.match(/(?:to |for |going to )([A-Z][a-z]+(?:\s[A-Z][a-z]+)?)/)?.[1] || 'the trip';
        const traveler = personName || 'everyone';

        steps = [
          `Check passport validity for ${traveler} (must be valid 6+ months)`,
          `Research visa requirements for ${destination}`,
          `Book flights and save confirmation details`,
          `Arrange accommodation and save booking refs`,
          `Check vaccination requirements and book appointments if needed`,
          `Arrange travel insurance`,
          `Notify bank of travel dates to avoid card blocks`,
          `Create packing list based on ${destination} weather and activities`,
          `Arrange pet/house sitter if needed`,
          `Download offline maps and translation apps`,
          `Copy important documents (passport, insurance, bookings)`,
          `Check phone/data roaming or get local SIM plan`,
          `Pack bags (start 2-3 days before)`,
          `Confirm all bookings 24 hours before departure`
        ];
      }
      // ===== SCHOOL / KIDS PREPARATION =====
      else if (lowerTask.includes('school') || lowerTask.includes('back to school') ||
               lowerTask.includes('term') || lowerTask.includes('semester')) {
        const child = personName || 'the kids';
        steps = [
          `Check school supply list for ${child}`,
          `Go through existing supplies - what can be reused?`,
          `Make shopping list for items needed`,
          `Buy school supplies (do one store trip)`,
          `Check uniform - does it still fit?`,
          `Order/buy new uniform items if needed`,
          `Label all items with name`,
          `Set up homework station at home`,
          `Check school calendar for important dates`,
          `Update emergency contact info with school`,
          `Prepare school bag the night before`,
          `Reset bedtime routine 1 week before school starts`
        ];
      }
      // ===== EVENT / PARTY PLANNING =====
      else if (lowerTask.includes('party') || lowerTask.includes('birthday') ||
               lowerTask.includes('event') || lowerTask.includes('celebration')) {
        const celebrant = personName || 'the guest of honor';
        steps = [
          `Set a date and time for the event`,
          `Decide on budget`,
          `Create guest list`,
          `Choose venue (home or external)`,
          `Send invitations (give 2-3 weeks notice)`,
          `Plan menu/catering - order or make?`,
          `Order cake or plan to bake`,
          `Plan decorations and theme`,
          `Organize activities or entertainment`,
          `Buy/organize gift for ${celebrant}`,
          `Prep food that can be made ahead`,
          `Set up decorations day before`,
          `Confirm RSVPs and final numbers`,
          `Enjoy the celebration!`
        ];
      }
      // ===== MOVING HOUSE =====
      else if (lowerTask.includes('move') || lowerTask.includes('moving') ||
               lowerTask.includes('relocat') || lowerTask.includes('new house') || lowerTask.includes('new home')) {
        steps = [
          `Set moving date and book removalists (or truck)`,
          `Start decluttering - donate/sell what you don't need`,
          `Gather packing supplies (boxes, tape, markers)`,
          `Pack one room at a time, label boxes clearly`,
          `Redirect mail to new address`,
          `Transfer utilities (electricity, gas, internet)`,
          `Update address with bank, Medicare, license`,
          `Pack essentials box (toiletries, chargers, snacks, tools)`,
          `Deep clean old place or book cleaners`,
          `Do final walkthrough of old place`,
          `Supervise loading/unloading`,
          `Unpack essentials first (beds, kitchen, bathroom)`,
          `Gradually unpack other rooms over coming weeks`
        ];
      }
      // ===== APPOINTMENT PREPARATION =====
      else if (lowerTask.includes('appointment') || lowerTask.includes('doctor') ||
               lowerTask.includes('dentist') || lowerTask.includes('meeting')) {
        const who = personName || 'yourself';
        steps = [
          `Confirm appointment date, time, and location`,
          `Check what documents/ID you need to bring`,
          `Write down questions you want to ask`,
          `Check if fasting or other prep required`,
          `Set reminder for day before`,
          `Prepare ${who}'s Medicare/insurance details`,
          `Plan travel time (add buffer for parking/traffic)`,
          `Pack bag with everything needed`,
          `Set alarm to leave on time`,
          `After: Note down any follow-up actions`
        ];
      }
      // ===== CLEANING (with clarifications) =====
      else if (lowerTask.includes('clean')) {
        if (cleanType === 'deep') {
          steps = [
            'Gather all cleaning supplies (spray, cloths, mop)',
            'Clear surfaces of clutter first',
            'Start high - dust ceiling fans and light fixtures',
            'Wipe down walls and doors',
            'Clean windows and mirrors',
            'Deep clean kitchen (inside oven, fridge)',
            'Scrub bathroom thoroughly',
            'Vacuum all floors including under furniture',
            'Mop hard floors',
            'Wash all bedding and curtains',
            'Take out all rubbish and recycling'
          ];
        } else if (cleanType === 'declutter') {
          steps = [
            'Get 3 bags/boxes: Keep, Donate, Trash',
            'Pick ONE room or area to start',
            'Empty one drawer/shelf completely',
            'Sort items quickly - 5 second decisions',
            'Only keep things you use or truly love',
            'Put "Keep" items back neatly',
            'Bag up donations - put in car NOW',
            'Take trash out immediately',
            'Move to next area, repeat'
          ];
        } else {
          steps = [
            'Set a 15-minute timer',
            'Quick tidy - put things back where they belong',
            'Wipe down kitchen benches',
            'Wipe bathroom sink and toilet',
            'Spot clean any marks or spills',
            'Quick vacuum/sweep main areas',
            'Take out any full bins',
            'Fluff cushions and fold throws',
            'Done! Good enough is good enough!'
          ];
        }
      }
      // ===== TAX / FINANCIAL =====
      else if (lowerTask.includes('tax') || lowerTask.includes('finances') || lowerTask.includes('budget')) {
        steps = [
          'Gather all income statements (payslips, payment summaries)',
          'Collect receipts for deductions (work expenses, donations)',
          'Download statements from bank and super',
          'Log into myGov/ATO or open tax software',
          'Enter income details first (the easy part)',
          'Enter deductions one category at a time',
          'Double-check all numbers',
          'Review and submit (or save for accountant)',
          'Save/print confirmation for records',
          'Note any estimated tax refund/bill'
        ];
      }
      // ===== EMAIL / INBOX =====
      else if (lowerTask.includes('email') || lowerTask.includes('inbox')) {
        steps = [
          'Open inbox and sort by sender or date',
          'Delete/archive obvious junk and old newsletters',
          'Unsubscribe from 3 lists you never read',
          'Star/flag anything that needs action',
          'Reply to quick emails first (under 2 mins each)',
          'Schedule time for emails needing longer replies',
          'File emails you need to keep into folders',
          'Archive everything else older than 1 month',
          'Aim for inbox under 50 items'
        ];
      }
      // ===== COOKING / MEAL PREP =====
      else if (lowerTask.includes('cook') || lowerTask.includes('dinner') ||
               lowerTask.includes('meal prep') || lowerTask.includes('lunch')) {
        steps = [
          'Decide on recipe (keep it simple!)',
          'Check pantry - make list of missing ingredients',
          'Quick grocery shop if needed',
          'Read recipe fully before starting',
          'Get all ingredients and tools out first',
          'Preheat oven/boil water if needed',
          'Prep all vegetables and ingredients',
          'Follow recipe steps in order',
          'Set timers so nothing burns',
          'Clean as you go where possible',
          'Serve and enjoy your creation!'
        ];
      }
      // ===== EXERCISE / FITNESS =====
      else if (lowerTask.includes('exercise') || lowerTask.includes('workout') ||
               lowerTask.includes('gym') || lowerTask.includes('fitness')) {
        steps = [
          'Put on workout clothes (do it now!)',
          'Fill water bottle',
          'Choose workout: cardio, strength, or both?',
          'Set timer/start tracking app',
          'Warm up: 5 mins light movement',
          'Do main workout (start with 20-30 mins)',
          'Cool down: stretching for 5 mins',
          'Log your workout (builds motivation!)',
          'Hydrate and have protein snack',
          'Shower and feel accomplished!'
        ];
      }
      // ===== SHOPPING =====
      else if (lowerTask.includes('shopping') || lowerTask.includes('groceries') ||
               lowerTask.includes('buy') || lowerTask.includes('shop')) {
        steps = [
          'Check what you already have at home',
          'Write list organized by store section',
          'Check for coupons or sales',
          'Set a budget if needed',
          'Go to store at a quieter time',
          'Stick to the list (avoid impulse buys)',
          'Check items off as you get them',
          'Use self-checkout if faster',
          'Put cold items away first when home',
          'Done! Reward yourself with a cuppa'
        ];
      }
      // ===== WORK PROJECT =====
      else if (lowerTask.includes('project') || lowerTask.includes('presentation') ||
               lowerTask.includes('report') || lowerTask.includes('work')) {
        steps = [
          'Define the exact outcome/deliverable needed',
          'Break into smaller milestones',
          'List all information/resources needed',
          'Block focused time in calendar',
          'Start with easiest section to build momentum',
          'Draft rough version first (don\'t perfect yet)',
          'Review and improve key sections',
          'Get feedback if possible',
          'Final polish and formatting',
          'Submit/deliver and celebrate!'
        ];
      }
      // ===== STUDY / LEARNING =====
      else if (lowerTask.includes('study') || lowerTask.includes('exam') ||
               lowerTask.includes('learn') || lowerTask.includes('course')) {
        steps = [
          'Gather all study materials needed',
          'Clear study space of distractions',
          'Review syllabus/exam topics',
          'Break material into chunks',
          'Study one chunk at a time (25-min sessions)',
          'Take short breaks between sessions',
          'Test yourself with practice questions',
          'Review areas you got wrong',
          'Get enough sleep before exam',
          'Trust your preparation!'
        ];
      }
      // ===== GENERIC FALLBACK (but better) =====
      else {
        // Try to extract action and object from task
        const taskWords = task.split(' ');
        steps = [
          `Write down exactly what "done" looks like for: ${task}`,
          'List everything this task might involve',
          'Identify what you need to get started',
          'Pick the smallest first step you can do in 2 minutes',
          'Do that first step right now',
          'What naturally comes next? Do that.',
          'If stuck, ask: what would make this easier?',
          'Set a timer for 25 minutes of focused work',
          'Review progress and adjust approach if needed',
          'Keep going until complete or take a planned break'
        ];
      }

      return steps;
    }

    function showBreakdownResult(steps) {
      document.getElementById('adhdLoading').style.display = 'none';
      document.getElementById('adhdBreakdownResult').style.display = 'block';

      document.getElementById('breakdownSummary').innerHTML = `
        <h4> ${currentBreakdownTask}</h4>
        <p>I've broken this into ${steps.length} manageable steps. You've got this!</p>
      `;

      document.getElementById('breakdownSteps').innerHTML = steps.map((step, i) => `
        <div class="adhd-breakdown-step">
          <div class="adhd-breakdown-step-num">${i + 1}</div>
          <div class="adhd-breakdown-step-text">${step}</div>
        </div>
      `).join('');

      // Store for saving
      currentBreakdownTask = {
        name: currentBreakdownTask,
        steps: steps
      };
    }

    function saveTaskBreakdown() {
      const newTask = {
        id: 'adhd_' + Date.now(),
        name: typeof currentBreakdownTask === 'string' ? currentBreakdownTask : currentBreakdownTask.name,
        steps: (typeof currentBreakdownTask === 'object' ? currentBreakdownTask.steps : []).map((text, i) => ({
          id: i,
          text: text,
          completed: false
        })),
        createdAt: new Date().toISOString(),
        clarifications: { ...clarificationAnswers }
      };

      adhdTasks.unshift(newTask);
      saveAdhdTasks();

      // Close modal and reset
      closeAdhdBreakdownSheet();
      document.getElementById('adhdTaskInput').value = '';
      showAdhdInputSection();
      renderAdhdTaskList();

      // Enter focus mode for new task
      setTimeout(() => {
        enterFocusMode(newTask.id);
      }, 300);
    }

    function regenerateBreakdown() {
      if (typeof currentBreakdownTask === 'object') {
        currentBreakdownTask = currentBreakdownTask.name;
      }
      generateTaskBreakdown();
    }

    function closeAdhdBreakdownSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('adhdBreakdownSheet').classList.remove('open');
    }

    function deleteAdhdTask(taskId) {
      if (confirm('Delete this task and all its steps?')) {
        adhdTasks = adhdTasks.filter(t => t.id !== taskId);
        saveAdhdTasks();
        renderAdhdTaskList();
      }
    }

    // ========================================
    // FOCUS MODE FUNCTIONS
    // ========================================
    function enterFocusMode(taskId) {
      currentFocusTask = adhdTasks.find(t => t.id === taskId);
      if (!currentFocusTask) return;

      // Find first incomplete step
      currentStepIndex = currentFocusTask.steps.findIndex(s => !s.completed);
      if (currentStepIndex === -1) currentStepIndex = 0;

      document.getElementById('adhdInputSection').style.display = 'none';
      document.getElementById('adhdClarifySection').style.display = 'none';
      document.getElementById('adhdFocusSection').style.display = 'flex';

      renderFocusMode();
    }

    function renderFocusMode() {
      if (!currentFocusTask) return;

      document.getElementById('focusTaskTitle').textContent = currentFocusTask.name;

      const currentStep = currentFocusTask.steps[currentStepIndex];
      document.getElementById('focusCurrentStep').textContent = currentStep ? currentStep.text : 'All done!';

      // Progress
      const completed = currentFocusTask.steps.filter(s => s.completed).length;
      const total = currentFocusTask.steps.length;
      const percent = Math.round((completed / total) * 100);

      document.getElementById('focusProgressBar').style.width = percent + '%';
      document.getElementById('focusProgressText').textContent = `Step ${currentStepIndex + 1} of ${total}`;

      // Show/hide timer based on step
      document.getElementById('focusTimer').style.display = 'block';

      // Render all steps list
      renderFocusStepsList();
    }

    function renderFocusStepsList() {
      const container = document.getElementById('focusStepsList');
      container.innerHTML = currentFocusTask.steps.map((step, i) => {
        let className = 'adhd-step-item';
        if (step.completed) className += ' completed';
        if (i === currentStepIndex && !step.completed) className += ' current';

        return `
          <div class="${className}">
            <div class="adhd-step-number">${step.completed ? '' : i + 1}</div>
            <span>${step.text}</span>
          </div>
        `;
      }).join('');
    }

    function completeCurrentStep() {
      if (!currentFocusTask) return;

      const step = currentFocusTask.steps[currentStepIndex];
      if (step) {
        step.completed = true;
        saveAdhdTasks();

        // Check if all done
        const allDone = currentFocusTask.steps.every(s => s.completed);
        if (allDone) {
          showCelebration('', 'Amazing! You completed the whole task!');
          setTimeout(() => {
            exitFocusMode();
          }, 2500);
        } else {
          // Mini celebration
          showCelebration('', getRandomPraise());

          // Move to next step
          currentStepIndex++;
          if (currentStepIndex >= currentFocusTask.steps.length) {
            currentStepIndex = currentFocusTask.steps.findIndex(s => !s.completed);
          }

          setTimeout(() => {
            hideCelebration();
            renderFocusMode();
          }, 1200);
        }
      }
    }

    function skipCurrentStep() {
      if (!currentFocusTask) return;

      // Find next incomplete step
      for (let i = currentStepIndex + 1; i < currentFocusTask.steps.length; i++) {
        if (!currentFocusTask.steps[i].completed) {
          currentStepIndex = i;
          renderFocusMode();
          return;
        }
      }

      // Wrap around to start
      for (let i = 0; i < currentStepIndex; i++) {
        if (!currentFocusTask.steps[i].completed) {
          currentStepIndex = i;
          renderFocusMode();
          return;
        }
      }
    }

    function exitFocusMode() {
      document.getElementById('adhdFocusSection').style.display = 'none';
      showAdhdInputSection();
      renderAdhdTaskList();
      stopFocusTimer();
    }

    function toggleAllSteps() {
      const list = document.getElementById('focusStepsList');
      const icon = document.getElementById('showStepsIcon');
      const btn = document.querySelector('.adhd-show-steps-btn');

      if (list.style.display === 'none') {
        list.style.display = 'block';
        icon.textContent = '';
        btn.innerHTML = '<span id="showStepsIcon"></span> Hide all steps';
      } else {
        list.style.display = 'none';
        icon.textContent = '';
        btn.innerHTML = '<span id="showStepsIcon"></span> Show all steps';
      }
    }

    // Timer functions
    function toggleFocusTimer() {
      const btn = document.getElementById('timerBtn');
      if (focusTimerInterval) {
        stopFocusTimer();
        btn.textContent = 'Start Timer';
      } else {
        startFocusTimer();
        btn.textContent = 'Pause';
      }
    }

    function startFocusTimer() {
      focusTimerInterval = setInterval(() => {
        focusTimerSeconds--;
        updateTimerDisplay();

        if (focusTimerSeconds <= 0) {
          stopFocusTimer();
          showCelebration('', '5 minutes done! Keep going or take a break!');
          setTimeout(hideCelebration, 2000);
          focusTimerSeconds = 300; // Reset
          updateTimerDisplay();
        }
      }, 1000);
    }

    function stopFocusTimer() {
      if (focusTimerInterval) {
        clearInterval(focusTimerInterval);
        focusTimerInterval = null;
      }
    }

    function updateTimerDisplay() {
      const mins = Math.floor(focusTimerSeconds / 60);
      const secs = focusTimerSeconds % 60;
      document.getElementById('timerDisplay').textContent =
        `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Celebration functions
    function showCelebration(emoji, text) {
      document.getElementById('celebrationEmoji').textContent = emoji;
      document.getElementById('celebrationText').textContent = text;
      document.getElementById('adhdCelebration').style.display = 'flex';
    }

    function hideCelebration() {
      document.getElementById('adhdCelebration').style.display = 'none';
    }

    function getRandomPraise() {
      const praises = [
        'Yes! One step down!',
        'You\'re doing great!',
        'Keep that momentum!',
        'Look at you go!',
        'Crushing it!',
        'One less thing to worry about!',
        'Progress feels good!',
        'You\'re on fire!',
        'That\'s the way!',
        'Boom! Done!'
      ];
      return praises[Math.floor(Math.random() * praises.length)];
    }

    // Share Task Functions
    let shareTaskFromMember = null;

    function openShareTaskSheet(fromMemberId) {
      shareTaskFromMember = fromMemberId;
      const fromMember = getMemberById(fromMemberId);

      // Populate assignee dropdown with other adults
      const assigneeSelect = document.getElementById('shareTaskAssignee');
      const otherAdults = familyMembers.filter(m => m.role === 'adult' && m.id !== fromMemberId);

      assigneeSelect.innerHTML = otherAdults.length > 0
        ? otherAdults.map(m => `<option value="${m.id}">${m.icon} ${m.name}</option>`).join('')
        : '<option value="">No other adults available</option>';

      document.getElementById('shareTaskSubtitle').textContent = `From ${fromMember?.name || 'Unknown'}`;
      document.getElementById('shareTaskTitle').value = '';
      document.getElementById('shareTaskPriority').value = 'normal';
      document.getElementById('shareTaskNotes').value = '';

      openModal('shareTaskSheet');
    }

    function closeShareTaskSheet() {
      document.getElementById('modalOverlay').classList.remove('open');
      document.getElementById('shareTaskSheet').classList.remove('open');
      shareTaskFromMember = null;
    }

    function submitShareTask() {
      const title = document.getElementById('shareTaskTitle').value.trim();
      const assigneeId = document.getElementById('shareTaskAssignee').value;
      const priority = document.getElementById('shareTaskPriority').value;
      const notes = document.getElementById('shareTaskNotes').value.trim();

      if (!title) {
        alert('Please enter a task description');
        return;
      }
      if (!assigneeId) {
        alert('Please select someone to assign this task to');
        return;
      }

      const fromMember = getMemberById(shareTaskFromMember);
      const toMember = getMemberById(assigneeId);

      const sharedTask = {
        id: generateId(),
        memberId: assigneeId,
        type: 'handoff',
        title: title,
        notes: notes ? `From ${fromMember?.name || 'Unknown'}: ${notes}` : `Shared by ${fromMember?.name || 'Unknown'}`,
        createdAt: new Date().toISOString(),
        priority: priority,
        fromMemberId: shareTaskFromMember
      };

      feedItems.push(sharedTask);
      saveData();
      closeShareTaskSheet();
      renderFeed();
    }

    function confirmResetData() {
      if (confirm('Are you sure you want to reset all family data? This cannot be undone.')) {
        resetAllData();
      }
    }

    // FAB Menu
    function toggleFabMenu() {
      document.getElementById('fabMenu').classList.toggle('visible');
    }

    function closeFabMenu() {
      document.getElementById('fabMenu').classList.remove('visible');
    }

    // Close menus on outside click
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.bubble-wrapper')) {
        closeAllMenus();
      }
      if (!e.target.closest('.fab') && !e.target.closest('.fab-menu')) {
        closeFabMenu();
      }
    });

    // ========================================
    // INITIALIZATION
    // ========================================
    function init() {
      initDarkMode();
      initNotifications();
      loadData();
      // Load user-specific data
      loadShoppingItems();
      loadMealData();
      loadAdhdTasks();
      checkBirthdays();
      renderBubbles();
      renderFeed();
    }

    // Check for upcoming birthdays and create reminder cards
    function checkBirthdays() {
      const today = new Date();
      const todayMonth = today.getMonth();
      const todayDay = today.getDate();

      familyMembers.forEach(member => {
        if (!member.birthday) return;

        const bday = new Date(member.birthday);
        const bdayMonth = bday.getMonth();
        const bdayDay = bday.getDate();

        // Check if birthday is within next 7 days
        for (let i = 0; i <= 7; i++) {
          const checkDate = new Date(today);
          checkDate.setDate(today.getDate() + i);

          if (checkDate.getMonth() === bdayMonth && checkDate.getDate() === bdayDay) {
            // Check if we already have a birthday card for this member this year
            const existingCard = feedItems.find(item =>
              item.type === 'birthday' &&
              item.memberId === member.id &&
              item.year === today.getFullYear()
            );

            if (!existingCard) {
              const age = today.getFullYear() - bday.getFullYear();
              const isToday = i === 0;

              feedItems.push({
                id: generateId(),
                memberId: member.id,
                type: 'birthday',
                title: isToday ? ` Happy Birthday ${member.name}!` : ` ${member.name}'s Birthday Coming Up!`,
                notes: isToday
                  ? `${member.name} turns ${age} today!`
                  : `${member.name} turns ${age} in ${i} day${i > 1 ? 's' : ''}`,
                date: `${today.getFullYear()}-${String(bdayMonth + 1).padStart(2, '0')}-${String(bdayDay).padStart(2, '0')}`,
                year: today.getFullYear(),
                createdAt: new Date().toISOString(),
                pinned: isToday
              });
              saveData();
            }
            break;
          }
        }
      });
    }

    // Start the app
    init();
  </script>
</body>
</html>
